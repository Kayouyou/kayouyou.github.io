<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Observers in Swift - Part 1 | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/favicon.ico?v=1645866598831">
<link rel="stylesheet" href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="é€šå¸¸åœ¨æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°è‡ªå·±å¤„äºéœ€è¦åœ¨å¯¹è±¡ä¹‹é—´å»ºç«‹ä¸€å¯¹å¤šå…³ç³»çš„æƒ…å†µä¸‹ã€‚ å½“å¤šä¸ªå¯¹è±¡å¸Œæœ›å¯¹åŒä¸€çŠ¶æ€çš„æ›´æ”¹ä½œå‡ºååº”æ—¶ï¼Œæˆ–è€…å½“éœ€è¦å°†æŸä¸ªäº‹ä»¶å¹¿æ’­åˆ°ç³»ç»Ÿçš„ä¸åŒéƒ¨åˆ†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæƒ³è¦ä¸ºç‰¹å®šçš„å¯¹è±¡æ·»åŠ æŸç§æ–¹å¼æ˜¯å¾ˆå¸¸è§çš„ã€‚..." />
    <meta name="keywords" content="observers,design pattern" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git">
        <img src="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/images/avatar.png?v=1645866598831" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Observers in Swift - Part 1</h2>
            <div class="post-date">2018-04-15</div>
            
            <div class="post-content" v-pre>
              <p>é€šå¸¸åœ¨æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°è‡ªå·±å¤„äºéœ€è¦åœ¨å¯¹è±¡ä¹‹é—´å»ºç«‹ä¸€å¯¹å¤šå…³ç³»çš„æƒ…å†µä¸‹ã€‚ å½“å¤šä¸ªå¯¹è±¡å¸Œæœ›å¯¹åŒä¸€çŠ¶æ€çš„æ›´æ”¹ä½œå‡ºååº”æ—¶ï¼Œæˆ–è€…å½“éœ€è¦å°†æŸä¸ªäº‹ä»¶å¹¿æ’­åˆ°ç³»ç»Ÿçš„ä¸åŒéƒ¨åˆ†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæƒ³è¦ä¸ºç‰¹å®šçš„å¯¹è±¡æ·»åŠ æŸç§æ–¹å¼æ˜¯å¾ˆå¸¸è§çš„ã€‚ä¸å¤§å¤šæ•°ç¼–ç¨‹æŠ€æœ¯ä¸€æ ·ï¼ŒSwiftä¸­æœ‰å¤šç§æ–¹æ³•å¯ä»¥å‘å¯¹è±¡æ·»åŠ è¿™æ ·çš„è§‚å¯ŸåŠŸèƒ½ -å®ƒä»¬éƒ½æœ‰ä¸åŒçš„ä¼˜åŠ¿å’Œæƒè¡¡ã€‚è¿™å‘¨æˆ‘ä»¬ä¼šå…ˆçœ‹ä¸¤ä¸ªæŠ€å·§ï¼Œç„¶åä¸‹å‘¨æˆ‘ä»¬ä¼šç»§ç»­çœ‹å…¶ä»–ä¸€äº›æŠ€å·§ã€‚</p>
<p>å°±è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿå§!ğŸ˜€</p>
<h2 id="the-use-case">The use case</h2>
<p>äº†èƒ½å¤Ÿåœ¨æˆ‘ä»¬å°†è¦å°è¯•çš„å„ç§è§‚å¯ŸæŠ€æœ¯ä¹‹é—´è¿›è¡Œç›´æ¥æ¯”è¾ƒï¼Œæˆ‘ä»¬å°†å¯¹æ‰€æœ‰è¿™äº›æŠ€æœ¯ä½¿ç”¨ç›¸åŒçš„ç”¨ä¾‹ã€‚æˆ‘ä»¬å°†ä½¿ç”¨çš„ä¾‹å­æ˜¯ä¸€ä¸ªAudioPlayerç±»ï¼Œå®ƒè®©å…¶ä»–å¯¹è±¡è§‚å¯Ÿå®ƒçš„PlaybackStateã€‚å½“ç©å®¶å¼€å§‹æ’­æ”¾ã€æš‚åœæˆ–ç»“æŸå›æ”¾æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›é€šçŸ¥è§‚å¯Ÿè€…çŠ¶æ€çš„å˜åŒ–ã€‚ è¿™å°†å…è®¸å¤šä¸ªå¯¹è±¡å°†ä»–ä»¬çš„é€»è¾‘ç»‘å®šåˆ°åŒä¸€ä¸ªplayer - ä¾‹å¦‚åˆ—è¡¨æ˜¾ç¤ºå¯ç©çš„é¡¹ç›®ï¼Œä¸€ä¸ªplayerUIå’Œä¸€äº›ç±»ä¼¼â€œmini-playerâ€æ˜¾ç¤ºåœ¨å±å¹•åº•éƒ¨ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ä»¬çš„AudioPlayerçš„æ ·å­:</p>
<pre><code class="language-swift">class AudioPlayer {
    private var state = State.idle {
        // We add a property observer on 'state', which lets us
        // run a function on each value change.
        didSet { stateDidChange() }
    }

    func play(_ item: Item) {
        state = .playing(item)
        startPlayback(with: item)
    }

    func pause() {
        switch state {
        case .idle, .paused:
            // Calling pause when we're not in a playing state
            // could be considered a programming error, but since
            // it doesn't do any harm, we simply break here.
            break
        case .playing(let item):
            state = .paused(item)
            pausePlayback()
        }
    }

    func stop() {
        state = .idle
        stopPlayback()
    }
}
</code></pre>
<p>ä¸Šé¢ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†â€œå»ºæ¨¡SwiftçŠ¶æ€â€çš„æŠ€æœ¯æ¥ä½¿ç”¨æšä¸¾æ¥å»ºæ¨¡AudioPlayerçš„å†…éƒ¨çŠ¶æ€ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ‘†è„±é€‰é¡¹å’Œå¤šç§çœŸç›¸æ¥æº-ç›¸ååœ°ï¼Œç»™äº†æˆ‘ä»¬æ¸…æ™°æ˜ç¡®çš„playerçŠ¶æ€ã€‚è¿™æ˜¯æˆ‘ä»¬çš„çŠ¶æ€enumçš„æ ·å­:</p>
<pre><code class="language-swift">private extension AudioPlayer {
    enum State {
        case idle
        case playing(Item)
        case paused(Item)
    }
}
</code></pre>
<p>åœ¨ä¸Šé¢ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡æ’­æ”¾å™¨çš„çŠ¶æ€æ”¹å˜æ—¶æˆ‘ä»¬è°ƒç”¨stateDidChange()æ–¹æ³•ã€‚æˆ‘ä»¬çš„ä¸»è¦ä»»åŠ¡æ˜¯æ ¹æ®å°†è¦å°è¯•çš„ä¸åŒæŠ€æœ¯ï¼Œç”¨ä¸åŒçš„å®ç°å¡«å……è¯¥æ–¹æ³•ã€‚</p>
<h2 id="notificationcenter">NotificationCenter</h2>
<p>æˆ‘ä»¬è¦çœ‹çš„ç¬¬ä¸€ä¸ªæŠ€æœ¯æ˜¯ä½¿ç”¨å†…ç½®çš„NotificationCenter APIåœ¨æ’­æ”¾çŠ¶æ€æ”¹å˜æ—¶å¹¿æ’­é€šçŸ¥ã€‚åƒè®¸å¤šå…¶ä»–ç³»ç»Ÿçº§è‹¹æœapiä¸€æ ·ï¼ŒNotificationCenteræ˜¯åŸºäºå•ä¾‹çš„ï¼Œä½†å› ä¸ºæˆ‘ä»¬æƒ³è¦è®©æˆ‘ä»¬çš„AudioPlayerç±»èƒ½å¤Ÿè¢«æµ‹è¯•(ä¹Ÿè¦æ¸…æ¥šå®ƒä¾èµ–äºNotificationCenter)ï¼Œæˆ‘ä»¬å°†åœ¨AudioPlayerçš„åˆå§‹åŒ–å™¨ä¸­æ³¨å…¥ä¸€ä¸ªé€šçŸ¥ä¸­å¿ƒå®ä¾‹ï¼Œåƒè¿™æ ·:</p>
<pre><code class="language-swift">class AudioPlayer {
    private let notificationCenter: NotificationCenter

    init(notificationCenter: NotificationCenter = .default) {
        self.notificationCenter = notificationCenter
    }
}
</code></pre>
<p>NotificationCenterä½¿ç”¨å‘½åé€šçŸ¥æ¥ç¡®å®šè§‚å¯Ÿæˆ–è§¦å‘çš„äº‹ä»¶ã€‚ ä¸ºäº†é¿å…ä½¿ç”¨å†…è”å­—ç¬¦ä¸²ä½œä¸ºAPIçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åœ¨NotificationCenter.nameä¸Šæ·»åŠ ä¸€ä¸ªæ‰©å±•ã€‚æˆ‘ä»¬çš„é€šçŸ¥namesæœ‰ä¸€ä¸ªå•ä¸€çš„çœŸç›¸æ¥æºã€‚ æˆ‘ä»¬ä¼šæ·»åŠ ä¸€ä¸ªç”¨äºå›æ”¾å¼€å§‹æ—¶ï¼Œä¸€ä¸ªç”¨äºæš‚åœæ—¶ï¼Œä¸€ä¸ªç”¨äºåœæ­¢æ—¶:</p>
<pre><code class="language-swift">extension Notification.Name {
    static var playbackStarted: Notification.Name {
        return .init(rawValue: &quot;AudioPlayer.playbackStarted&quot;)
    }

    static var playbackPaused: Notification.Name {
        return .init(rawValue: &quot;AudioPlayer.playbackPaused&quot;)
    }

    static var playbackStopped: Notification.Name {
        return .init(rawValue: &quot;AudioPlayer.playbackStopped&quot;)
    }
}
</code></pre>
<p>ä¸Šé¢çš„æ‰©å±•ä¹Ÿå°†ä½¿æˆ‘ä»¬çš„APIçš„ç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨ç‚¹è¯­æ³•å¼•ç”¨æˆ‘ä»¬çš„é€šçŸ¥åç§°;æ¯”å¦‚.playbackstartedï¼Œè¿™æ€»æ˜¯å¾ˆå¥½ã€‚</p>
<p>ä¸ä¸Šè¿°æ‰©å±•åˆ°ä½ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å¼€å§‹å¼ è´´é€šçŸ¥ã€‚æˆ‘ä»¬å°†å¡«å†™ä¹‹å‰çš„stateDidChange()æ–¹æ³•ï¼Œå¹¶æ£€æŸ¥å½“å‰çŠ¶æ€ï¼Œä»¥æŸ¥çœ‹åº”è¯¥å‘å¸ƒå“ªç§ç±»å‹çš„é€šçŸ¥ã€‚å¯¹äºæ’­æ”¾å’Œæš‚åœçŠ¶æ€ï¼Œæˆ‘ä»¬ä¹Ÿå°†ä¼ é€’å½“å‰æ­£åœ¨æ’­æ”¾çš„é¡¹ç›®ä½œä¸ºé€šçŸ¥çš„å¯¹è±¡:</p>
<pre><code class="language-swift">class NowPlayingViewController: UIViewController {
    deinit {
        // If your app supports iOS 8 or earlier, you need to manually
        // remove the observer from the center. In later versions
        // this is done automatically.
        notificationCenter.removeObserver(self)
    }

    override func viewDidLoad() {
        super.viewDidLoad()

        notificationCenter.addObserver(self,
            selector: #selector(playbackDidStart),
            name: .playbackStarted,
            object: nil
        )
    }

    @objc private func playbackDidStart(_ notification: Notification) {
        guard let item = notification.object as? AudioPlayer.Item else {
            let object = notification.object as Any
            assertionFailure(&quot;Invalid object: \(object)&quot;)
            return
        }

        titleLabel.text = item.title
        durationLabel.text = &quot;\(item.duration)&quot;
    }
}
</code></pre>
<p>ä½¿ç”¨åŸºäºnotificationcenterçš„é€šçŸ¥çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å®ƒä»¬éå¸¸å®¹æ˜“å®ç°-ä¸è®ºæ˜¯åœ¨è¢«è§‚å¯Ÿå¯¹è±¡çš„å†…éƒ¨ï¼Œä»¥åŠä»»ä½•æƒ³å¼€å§‹è§‚å¯Ÿå®ƒçš„äººã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¤§å¤šæ•°Swiftå¼€å‘è€…éƒ½å¾ˆç†Ÿæ‚‰çš„APIï¼Œå› ä¸ºè‹¹æœè‡ªå·±ä½¿ç”¨å®ƒæ¥ä¼ é€’å¤šç§ç±»å‹çš„ç³»ç»Ÿé€šçŸ¥ï¼Œæ¯”å¦‚é”®ç›˜äº‹ä»¶ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä¹Ÿæœ‰ä¸€äº›æ˜¾è‘—çš„ç¼ºç‚¹ã€‚é¦–å…ˆï¼Œç”±äºNotificationCenteræ˜¯ä¸€ä¸ªObjective-C APIï¼Œå®ƒä¸èƒ½ä½¿ç”¨åƒæ³›å‹è¿™æ ·çš„Swiftç‰¹æ€§æ¥ä¿æŒç±»å‹å®‰å…¨ã€‚è™½ç„¶è¿™æ˜¯æ€»æ˜¯å¯ä»¥åœ¨é¡¶éƒ¨å®ç°çš„ä¸œè¥¿(é€šè¿‡åˆ›å»ºä¸€äº›å½¢å¼çš„åŒ…è£…å™¨)ï¼Œä½¿ç”¨å®ƒçš„é»˜è®¤æ–¹å¼è¦æ±‚æˆ‘ä»¬åšç±»å‹è½¬æ¢ï¼Œå°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢çš„playbackDidStartçš„å‰å‡ è¡Œæ‰€åšçš„ã€‚è¿™ä½¿å¾—æˆ‘ä»¬çš„ä»£ç éå¸¸è„†å¼±ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½åˆ©ç”¨ç¼–è¯‘å™¨æ¥ç¡®ä¿è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿå¯¹è±¡å¯¹å¹¿æ’­çš„å€¼ä½¿ç”¨ç›¸åŒçš„ç±»å‹ã€‚</p>
<p>è¯´åˆ°å¹¿æ’­ï¼Œä½¿ç”¨NotificationCenterçš„å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œé€šçŸ¥åœ¨åº”ç”¨ç¨‹åºèŒƒå›´å†…å¹¿æ’­ï¼Œæ²¡æœ‰å¤ªå¤šçš„é™åˆ¶ã€‚è™½ç„¶è¿™å¾ˆæ–¹ä¾¿(ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è§‚å¯Ÿä»»ä½•å¯¹è±¡)ï¼Œä½†å®ƒä½¿å‚ä¸è§‚å¯Ÿçš„å¯¹è±¡ä¹‹é—´çš„å…³ç³»æ›´åŠ æ¾æ•£ï¼Œè¿™ä½¿å¾—åœ¨åº”ç”¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´ä¿æŒæ¸…æ™°çš„åˆ†ç¦»å˜å¾—æ›´åŠ å›°éš¾â€”â€”å°¤å…¶æ˜¯éšç€ä»£ç åº“çš„å¢é•¿ã€‚</p>
<h2 id="observation-protocols">Observation protocols</h2>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨åè®®æ¥åˆ›å»ºæ›´ä¸¥æ ¼å’Œå®šä¹‰è‰¯å¥½çš„è§‚å¯Ÿapiã€‚å½“ä½¿ç”¨è¿™ç§æŠ€æœ¯æ—¶ï¼Œæˆ‘ä»¬è¦æ±‚æ‰€æœ‰å¯¹è§‚å¯Ÿæˆ‘ä»¬çš„AudioPlayeræ„Ÿå…´è¶£çš„å¯¹è±¡éƒ½éµå®ˆAudioPlayerObserveråè®®ã€‚å°±åƒæˆ‘ä»¬ä¸ºæ¯ä¸ªå›æ”¾çŠ¶æ€å®šä¹‰äº†ä¸‰ä¸ªç‹¬ç«‹çš„é€šçŸ¥ä¸€æ ·ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸‰ä¸ªæ–¹æ³•æ¥è§‚å¯Ÿæ¯ä¸ªäº‹ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">protocol AudioPlayerObserver: class {
    func audioPlayer(_ player: AudioPlayer,
                     didStartPlaying item: AudioPlayer.Item)

    func audioPlayer(_ player: AudioPlayer, 
                     didPausePlaybackOf item: AudioPlayer.Item)

    func audioPlayerDidStop(_ player: AudioPlayer)
}
</code></pre>
<p>ä¸ºäº†è®©åªé€‰æ‹©ä¸€ä¸ªäº‹ä»¶æ¥è§‚å¯Ÿæˆä¸ºå¯èƒ½ï¼Œæˆ‘ä»¬è¿˜å°†ä½¿ç”¨åè®®æ‰©å±•ä¸ºæ¯ä¸ªäº‹ä»¶æ·»åŠ é»˜è®¤(ç©º)å®ç°:</p>
<pre><code class="language-swift">extension AudioPlayerObserver {
    func audioPlayer(_ player: AudioPlayer,
                     didStartPlaying item: AudioPlayer.Item) {}

    func audioPlayer(_ player: AudioPlayer, 
                     didPausePlaybackOf item: AudioPlayer.Item) {}

    func audioPlayerDidStop(_ player: AudioPlayer) {}
}
</code></pre>
<h2 id="weak-storage">Weak storage</h2>
<p>åœ¨è®¾è®¡è§‚å¯Ÿapiæ—¶ï¼Œåªä¿ç•™å¯¹æ‰€æœ‰è§‚å¯Ÿè€…çš„å¼±å¼•ç”¨é€šå¸¸æ˜¯ä¸€ä¸ªå¥½åšæ³•ã€‚å¦åˆ™ï¼Œå½“è¢«è§‚å¯Ÿå¯¹è±¡çš„æ‰€æœ‰è€…ä¹Ÿæ˜¯è§‚å¯Ÿè€…æœ¬èº«æ—¶ï¼Œå¾ˆå®¹æ˜“å¼•å…¥ä¿ç•™å‘¨æœŸã€‚ç„¶è€Œï¼Œä»¥ä¸€ç§è‰¯å¥½çš„æ–¹å¼åœ¨Swifté›†åˆä¸­å¼±å­˜å‚¨å¯¹è±¡å¹¶ä¸æ€»æ˜¯ç›´æ¥çš„ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰é›†åˆéƒ½æ˜¯å¼ºä¿ç•™å…¶æˆå‘˜çš„ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ä»¥æ»¡è¶³æˆ‘ä»¬çš„è§‚å¯Ÿéœ€è¦ï¼Œæˆ‘ä»¬å°†å¼•å…¥ä¸€ä¸ªå°çš„åŒ…è£…å™¨ç±»å‹ï¼Œå®ƒç®€å•åœ°è·Ÿè¸ªä¸€ä¸ªå¸¦æœ‰å¼±å¼•ç”¨çš„è§‚å¯Ÿè€…:</p>
<pre><code class="language-swift">private extension AudioPlayer {
    struct Observation {
        weak var observer: AudioPlayerObserver?
    }
}
</code></pre>
<p>ä½¿ç”¨ä¸Šé¢çš„ç±»å‹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å‘æˆ‘ä»¬çš„AudioPlayeræ·»åŠ ä¸€ä¸ªè§‚å¯Ÿé›†åˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†é€‰æ‹©ä¸€ä¸ªå¸¦æœ‰ObjectIdentifieré”®çš„å­—å…¸æ¥è·å–å›ºå®šæ—¶é—´çš„æ’å…¥å’Œç§»é™¤è§‚å¯Ÿè€…:</p>
<pre><code class="language-swift">class AudioPlayer {
    private var observations = [ObjectIdentifier : Observation]()
}
</code></pre>
<p>ObjectIdentifieræ˜¯ä¸€ä¸ªå†…ç½®çš„å€¼ç±»å‹ï¼Œä½œä¸ºä¸€ä¸ªç±»çš„ç»™å®šå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹â€œSwiftä¸­è¯†åˆ«ç‰©ä½“â€ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡éå†æ‰€æœ‰è§‚å¯Ÿå¹¶è°ƒç”¨å¯¹åº”äºå½“å‰çŠ¶æ€çš„åè®®æ–¹æ³•æ¥å®ç°stateDidChange()ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬è¿˜å°†åˆ©ç”¨è¿™ä¸ªæœºä¼šæ¸…ç†ä»»ä½•æœªä½¿ç”¨çš„è§‚å¯Ÿ(å¦‚æœå¯¹åº”çš„å¯¹è±¡å·²è¢«é‡Šæ”¾)ã€‚</p>
<pre><code class="language-swift">private extension AudioPlayer {
    func stateDidChange() {
        for (id, observation) in observations {
            // If the observer is no longer in memory, we
            // can clean up the observation for its ID
            guard let observer = observation.observer else {
                observations.removeValue(forKey: id)
                continue
            }

            switch state {
            case .idle:
                observer.audioPlayerDidStop(self)
            case .playing(let item):
                observer.audioPlayer(self, didStartPlaying: item)
            case .paused(let item):
                observer.audioPlayer(self, didPausePlaybackOf: item)
            }
        }
    }
}
</code></pre>
<h2 id="observing">Observing</h2>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•è®©ç¬¦åˆAudioPlayerObserverçš„å¯¹è±¡å°†è‡ªå·±æ³¨å†Œä¸ºè§‚å¯Ÿè€…ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§ç®€å•çš„æ–¹æ³•è®©å¯¹è±¡æ³¨é”€è‡ªå·±ï¼Œä»¥é˜²å®ƒä»¬ä¸å†å¯¹æ›´æ–°æ„Ÿå…´è¶£ã€‚ ä¸ºäº†å®ç°è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨AudioPlayerä¸Šæ·»åŠ ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒå¢åŠ äº†ä¸¤ä¸ªæ–°æ–¹æ³•:</p>
<pre><code class="language-swift">extension AudioPlayer {
    func addObserver(_ observer: AudioPlayerObserver) {
        let id = ObjectIdentifier(observer)
        observations[id] = Observation(observer: observer)
    }

    func removeObserver(_ observer: AudioPlayerObserver) {
        let id = ObjectIdentifier(observer)
        observations.removeValue(forKey: id)
    }
}
</code></pre>
<p>å°±æ˜¯è¿™æ ·!ğŸ‰æˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´æ–°NowPlayingViewControlleræ¥ä½¿ç”¨æˆ‘ä»¬é—ªäº®çš„æ–°è§‚å¯Ÿåè®®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨NotificationCenter:</p>
<pre><code class="language-swift">class NowPlayingViewController: UIViewController {
    override func viewDidLoad() {
        super.viewDidLoad()
        player.addObserver(self)
    }
}

extension NowPlayingViewController: AudioPlayerObserver {
    func audioPlayer(_ player: AudioPlayer,
                     didStartPlaying item: AudioPlayer.Item) {
        titleLabel.text = item.title
        durationLabel.text = &quot;\(item.duration)&quot;
    }
}
</code></pre>
<p>æ­£å¦‚æ‚¨åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œä½¿ç”¨æ˜¾å¼è§‚å¯Ÿåè®®è€Œä¸æ˜¯ä¾èµ–NotificationCenterçš„ä¸»è¦ä¼˜ç‚¹æ˜¯æˆ‘ä»¬è·å¾—äº†å®Œå…¨çš„ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ã€‚å› ä¸ºæˆ‘ä»¬çš„åè®®ä½¿ç”¨äº†AudiPlayer.itemã€‚åœ¨æˆ‘ä»¬çš„è§‚å¯Ÿæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦åšä»»ä½•ç±»å‹è½¬æ¢â€”â€”ä»è€Œäº§ç”Ÿäº†æ›´å¤šæ¸…æ™°å’Œå¯é çš„ä»£ç ã€‚</p>
<p>æ·»åŠ ä¸€ä¸ªæ˜¾å¼çš„è§‚å¯ŸAPIè¿˜å¯ä»¥æé«˜å¯è§‚å¯Ÿå¯¹è±¡ç±»å·¥ä½œæ–¹å¼çš„é€æ˜æ€§ã€‚ å¾ˆæ˜æ˜¾ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä½ åº”è¯¥éµå¾ªAudioPlayerObserveræ¥è§‚å¯Ÿæ’­æ”¾å™¨ï¼Œè€Œä¸æ˜¯è€ƒè™‘åº”è¯¥ä½¿ç”¨NotificationCenterã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œå®ƒåœ¨AudioPlayerå†…éƒ¨éœ€è¦æ¯”ä½¿ç”¨NotificationCenteræ›´å¤šçš„ä»£ç ã€‚å®ƒè¿˜éœ€è¦å¼•å…¥é¢å¤–çš„åè®®å’Œç±»å‹ï¼Œå¦‚æœä»£ç åº“éå¸¸ä¾èµ–è§‚å¯Ÿï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªç¼ºç‚¹ã€‚</p>
<p><a href="https://www.swiftbysundell.com/articles/observers-in-swift-part-1/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/tag/3kIoTw_PC/" class="tag">
                    observers
                  </a>
                
                  <a href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/tag/4g5XtbTAR/" class="tag">
                    design pattern
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://e.coding.net/kayouyou/kayouyoublog/KayouyouBlog.git/post/using-the-builder-pattern-in-swift/">
                  <h3 class="post-title">
                    Using the builder pattern in Swift
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
