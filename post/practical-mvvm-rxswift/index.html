<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Practical MVVM + RxSwift | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1661042947575">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Practical MVVM + RxSwift


1.1. UI Setup

1.1.1. Child View Controllers


1.2. View Model Setup

1.2.1. Basic View M..." />
    <meta name="keywords" content="mvvm,rxswift" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1661042947575" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Practical MVVM + RxSwift</h2>
            <div class="post-date">2021-05-07</div>
            
              <div class="feature-container" style="background-image: url('https://tva1.sinaimg.cn/large/008i3skNgy1gq9vxy1gcuj31jk0nwgms.jpg')">
              </div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#PracticalMVVMRxSwift">Practical MVVM + RxSwift</a></li>
</ol>
<ul>
<li>1.1. <a href="#UISetup">UI Setup</a>
<ul>
<li>1.1.1. <a href="#ChildViewControllers">Child View Controllers</a></li>
</ul>
</li>
<li>1.2. <a href="#ViewModelSetup">View Model Setup</a>
<ul>
<li>1.2.1. <a href="#BasicViewModelArchitecture">Basic View Model Architecture</a></li>
<li>1.2.2. <a href="#AddingRxSwift">Adding RxSwift</a></li>
<li>1.2.3. <a href="#UItodatabindingRxCocoa">UI to data binding (RxCocoa)</a></li>
</ul>
</li>
<li>1.3. <a href="#Lasttouch">Last touch</a>
<ul>
<li>1.3.1. <a href="#ConnectAlbumsandTracksproperties">Connect Albums and Tracks properties</a></li>
<li>1.3.2. <a href="#RequestdatafromViewModel">Request data from View Model</a></li>
<li>1.3.3. <a href="#Addingbonusanimation">Adding bonus animation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<h2 id="1-a-namepracticalmvvmrxswiftapractical-mvvm-rxswift">1. <a name='PracticalMVVMRxSwift'></a>Practical MVVM + RxSwift</h2>
<p>ä»Šå¤©æˆ‘ä»¬å°†ä½¿ç”¨RxSwiftå®ç°MVVMè®¾è®¡æ¨¡å¼ã€‚å¯¹äºé‚£äº›åˆšæ¥è§¦RxSwiftçš„äººï¼Œæˆ‘åœ¨è¿™é‡Œåšäº†ä¸€ä¸ªä»‹ç»ã€‚</p>
<p>å¦‚æœä½ è®¤ä¸ºRxSwiftå¾ˆéš¾æˆ–è€…æ¨¡æ£±ä¸¤å¯ï¼Œä¸è¦æ‹…å¿ƒã€‚ä¹ä¸€çœ‹å¯èƒ½å¾ˆéš¾ï¼Œä½†é€šè¿‡å®ä¾‹å’Œå®è·µï¼Œå®ƒå°†å˜å¾—ç®€å•æ˜“æ‡‚ã€‚ğŸ‘</p>
<hr>
<p>åœ¨ä½¿ç”¨RxSwiftå®ç°MVVMè®¾è®¡æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬å°†åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨è¿™ç§æ–¹æ³•çš„æ‰€æœ‰ä¼˜ç‚¹ã€‚æˆ‘ä»¬å°†å·¥ä½œåœ¨ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œæ˜¾ç¤ºåœ¨UICollectionViewå’ŒUITableView (R.I.Påˆ‡æ–¯ç‰¹ğŸ™)æ—è‚¯å…¬å›­çš„ä¸“è¾‘å’Œæ­Œæ›²çš„åˆ—è¡¨ã€‚è®©æˆ‘ä»¬å¼€å§‹å§!</p>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9vxtptewj30b40jrt9m.jpg" alt="avatar" loading="lazy"></figure>
<hr>
<h3 id="11-a-nameuisetupaui-setup">1.1. <a name='UISetup'></a>UI Setup</h3>
<h4 id="111-a-namechildviewcontrollersachild-view-controllers">1.1.1. <a name='ChildViewControllers'></a>Child View Controllers</h4>
<p>åœ¨æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ—¶æˆ‘æƒ³éµå¾ªå¯é‡ç”¨æ€§åŸåˆ™ã€‚æˆ‘ä»¬å°†å®ç°TableViewæ­Œæ›² å’Œ CollectionViewä¸“è¾‘,åœ¨æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†æˆ‘ä»¬ç¨åå¯ä»¥é‡ç”¨è¿™äº›è§†å›¾ã€‚ä¾‹å¦‚,æƒ³è±¡æˆ‘ä»¬è¦æ˜¾ç¤ºæ¯ä¸ªä¸“è¾‘æ­Œæ›²æˆ–æˆ‘ä»¬æœ‰éƒ¨åˆ†ç›¸ä¼¼çš„ä¸“è¾‘æ˜¾ç¤ºã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ¯æ¬¡éƒ½å®ç°è¿™äº›éƒ¨åˆ†ï¼Œæœ€å¥½è®©å®ƒä»¬å¯é‡ç”¨ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬èƒ½åšä»€ä¹ˆå‘¢? å­è§†å›¾æ§åˆ¶å™¨æ¥æ‹¯æ•‘ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ContainerViewçš„UIViewControlleråˆ†ä¸ºä¸¤éƒ¨åˆ†:</p>
<ol>
<li><em>AlbumCollectionViewVC</em></li>
<li><em>TrackTableViewVC</em></li>
</ol>
<p>ç°åœ¨çˆ¶è§†å›¾æ§åˆ¶å™¨ç”±ä¸¤ä¸ªchildViewControllerç»„æˆ(è¦äº†è§£childViewControllerä½ å¯ä»¥é˜…è¯»<a href="https://coding-pages-bucket-3400815-8719473-16768-590431-1304325418.cos-website.ap-hongkong.myqcloud.com/post/managing-view-controllers-with-container-view-controllers/">è¿™ç¯‡æ–‡ç« </a>)ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9vy2brbej30yq0tsta7.jpg" alt="avatar" loading="lazy"></figure>
<p>ä¸ºäº†æ³¨å†Œnibæ–‡ä»¶çš„å•å…ƒæ ¼ï¼Œä½ åº”è¯¥æŠŠè¿™æ®µä»£ç æ”¾åœ¨AlbumCollectionViewVCç±»çš„viewDidLoadæ–¹æ³•ä¸­ã€‚æ‰€ä»¥UICollectionViewçŸ¥é“å®ƒåœ¨ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„å•å…ƒæ ¼:</p>
<pre><code class="language-swift">//register 'AlbumsCollectionViewCell' to UICollectionView
albumsCollectionView.register(UINib(nibName: &quot;AlbumsCollectionViewCell&quot;,bundle:nil),forCellWithReuseIdentifier:String(describing:AlbumsCollectionViewCell.Self))
</code></pre>
<p>è€ƒè™‘åˆ°è¿™æ®µä»£ç åº”è¯¥åœ¨AlbumCollectionViewVCç±»ä¸­ã€‚è¿™æ„å‘³ç€çˆ¶ç±»çš„ä¸€ä¸ªå­ç±»å’Œçˆ¶ç±»æš‚æ—¶ä¸éœ€è¦å¤„ç†å…¶å­ç±»çš„å¯¹è±¡ã€‚</p>
<p>å¯¹äºTrackTableViewVCï¼Œæˆ‘ä»¬åšäº†ç›¸åŒçš„è¿‡ç¨‹ï¼Œä¸åŒçš„æ˜¯å®ƒåªæ˜¯ä¸€ä¸ªtable viewã€‚ç°åœ¨æˆ‘ä»¬è¦å»çˆ¶ç±»ï¼Œæˆ‘ä»¬åº”è¯¥è®¾ç½®æˆ‘ä»¬çš„ä¸¤ä¸ªå­ç±»ã€‚</p>
<p>æ­£å¦‚ä½ åœ¨æ•…äº‹æ¿å›¾ç‰‡ä¸­çœ‹åˆ°çš„ï¼Œå­ç±»çš„ä½ç½®æ˜¯æˆ‘ä»¬çš„viewControllersè¢«æ”¾ç½®çš„ä¸¤ä¸ªè§†å›¾ã€‚è¿™äº›è§†å›¾ç§°ä¸ºContainerViewã€‚ä¸ºäº†è®¾ç½®è¿™äº›è§†å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç :</p>
<pre><code class="language-swift">IBOutlet weak var albumsVCView: UIView!
    
    private lazy var albumsViewController: AlbumsCollectionViewVC = {
        // Load Storyboard
        let storyboard = UIStoryboard(name: &quot;Home&quot;, bundle: Bundle.main)
        
        // Instantiate View Controller
        var viewController = storyboard.instantiateViewController(withIdentifier: &quot;AlbumsCollectionViewVC&quot;) as! AlbumsCollectionViewVC
        
        // Add View Controller as Child View Controller
        self.add(asChildViewController: viewController, to: albumsVCView)
        
        return viewController
    }()
</code></pre>
<h3 id="12-a-nameviewmodelsetupaview-model-setup">1.2. <a name='ViewModelSetup'></a>View Model Setup</h3>
<h4 id="121-a-namebasicviewmodelarchitectureabasic-view-model-architecture">1.2.1. <a name='BasicViewModelArchitecture'></a>Basic View Model Architecture</h4>
<p>æ‰€ä»¥æˆ‘ä»¬çš„è§†å›¾å·²ç»å‡†å¤‡å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥ViewModelå’ŒRxSwift:</p>
<p>åœ¨ä¸»ViewModelç±»ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå¹¶ä»¥è§†å›¾æƒ³è¦çš„æ–¹å¼è¿›è¡Œè§£æã€‚ç„¶åviewModelå°†è¿™äº›æ•°æ®äº¤ç»™çˆ¶ç±»ï¼Œçˆ¶ç±»å°†è¿™äº›æ•°æ®ä¼ é€’ç»™å­è§†å›¾æ§åˆ¶å™¨ã€‚è¿™æ„å‘³ç€çˆ¶ç±»ä»è§†å›¾æ¨¡å‹è¯·æ±‚æ•°æ®ï¼Œè§†å›¾æ¨¡å‹å‘ç½‘ç»œå±‚å‘é€è¯·æ±‚ã€‚ç„¶åè§†å›¾æ¨¡å‹è§£ææ•°æ®å¹¶å°†å…¶äº¤ç»™çˆ¶ç±»ã€‚</p>
<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œè¯·çœ‹ä¸‹é¢çš„å›¾è¡¨:</p>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9vy4lzf6j30w00redh5.jpg" alt="avatar" loading="lazy"></figure>
<p>The completed project in <a href="https://github.com/mohammadZ74/MVVMRx_SampleProject">GitHub</a> is implemented in RxSwift and without Rx. The implementation without Rx is in MVVMWithoutRx branch. In this article, we get through the RxSwift way. Please check without Rx way too, which implemented with closures.</p>
<h4 id="122-a-nameaddingrxswiftaadding-rxswift">1.2.2. <a name='AddingRxSwift'></a>Adding RxSwift</h4>
<p>ç°åœ¨ï¼ŒRxSwiftè¿›å…¥ğŸš¶â€â™‚ï¸ï¼Œè¿™æ˜¯ä»¤äººå…´å¥‹çš„éƒ¨åˆ†ã€‚åœ¨é‚£ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥ç†è§£è§†å›¾æ¨¡å‹åº”è¯¥ç»™æˆ‘ä»¬çš„ç±»æä¾›ä»€ä¹ˆ:</p>
<ol>
<li>
<p>loading(Bool):å½“æˆ‘ä»¬å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ˜¾ç¤ºåŠ è½½ã€‚è¿™æ ·ç”¨æˆ·å°±èƒ½ç†è§£ï¼Œæœ‰ä¸œè¥¿æ­£åœ¨åŠ è½½ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¸ƒå°”çš„å¯è§‚å¯Ÿå¯¹è±¡ã€‚å½“å®ƒä¸ºçœŸæ—¶æ„å‘³ç€å®ƒæ­£åœ¨åŠ è½½ï¼Œå½“å®ƒä¸ºå‡æ—¶â€”â€”å®ƒå·²ç»åŠ è½½äº†ã€‚</p>
</li>
<li>
<p>error(homeError):æ¥è‡ªæœåŠ¡å™¨çš„å¯èƒ½é”™è¯¯å’Œä»»ä½•å…¶ä»–é”™è¯¯ã€‚å®ƒå¯ä»¥æ˜¯å¼¹å‡ºçª—å£ï¼ŒInterneté”™è¯¯ç­‰ç­‰ï¼Œè¿™åº”è¯¥æ˜¯å¯ä»¥è§‚å¯Ÿåˆ°çš„é”™è¯¯ç±»å‹ï¼Œæ‰€ä»¥å¦‚æœå®ƒæœ‰ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬å°±ä¼šåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå®ƒã€‚</p>
</li>
</ol>
<p>The collection and table views data ,â€¦</p>
<p>æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸‰ç§ç±»å‹çš„å¯è§‚å¯Ÿå¯¹è±¡ï¼Œæˆ‘ä»¬çš„çˆ¶ç±»åº”è¯¥æ³¨å†Œç»™å®ƒä»¬:</p>
<pre><code class="language-swift">public enum homeError {
    case internetError(String)
    case serverMessage(String)
    public let albums: PublishSubject&lt;[Album]&gt; = PublishSubject()
    public let tracks: PublishSubject&lt;[Track]&gt; = PublishSubject()
    public let loading: PublishSubject&lt;Bool&gt; = PublishSubject()
    public let tracks: PublishSubject&lt;homeError&gt; = PublishSubject()
}
</code></pre>
<p>è¿™äº›æ˜¯æˆ‘ä»¬çš„è§†å›¾æ¨¡å‹ç±»å˜é‡ã€‚è¿™å››ä¸ªéƒ½æ˜¯å¯è§‚å¯Ÿçš„ï¼Œæ²¡æœ‰ç¬¬ä¸€ä¸ªåˆå§‹å€¼ã€‚ç°åœ¨æ‚¨å¯èƒ½ä¼šé—®:ä»€ä¹ˆæ˜¯<strong>PublishSubject</strong>?</p>
<p>å°±åƒæˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œä¸€äº›å˜é‡æ˜¯<em>Observer</em>ï¼Œä¸€äº›æ˜¯<em>Observable</em>ã€‚æˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªå¯ä»¥åŒæ—¶æ˜¯è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿå¯¹è±¡ï¼Œå®ƒä»¬è¢«ç§°ä¸º<strong>Subject</strong>ã€‚</p>
<p><strong>Subjects</strong> æœ¬èº«åˆ†ä¸º4ä¸ªéƒ¨åˆ†(è§£é‡Šæ¯ä¸ªéƒ¨åˆ†ï¼Œéœ€è¦å¦ä¸€ç¯‡æ–‡ç« )ã€‚ä½†æ˜¯æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨äº†PublishSubjectï¼Œè¿™æ˜¯æœ€æµè¡Œçš„ä¸€ä¸ªã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šçš„ä¸»é¢˜ï¼Œæˆ‘æ¨èä½ é˜…è¯»è¿™ç¯‡<a href="https://medium.com/fantageek/rxswift-subjects-part1-publishsubjects-103ff6b06932">æ–‡ç« </a>ã€‚</p>
<p>ä½¿ç”¨PublishSubjectçš„ä¸€ä¸ªå¾ˆå¥½çš„åŸå› æ˜¯å¯ä»¥åœ¨æ²¡æœ‰åˆå§‹å€¼çš„æƒ…å†µä¸‹è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<h4 id="123-a-nameuitodatabindingrxcocoaaui-to-data-binding-rxcocoa">1.2.3. <a name='UItodatabindingRxCocoa'></a>UI to data binding (RxCocoa)</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥ä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•å‘è§†å›¾æä¾›æ•°æ®:</p>
<p>åœ¨æˆ‘ä»¬è¿›å…¥è§†å›¾æ¨¡å‹ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡HomeVCç±»æ¥è§‚å¯ŸviewModelå˜é‡ï¼Œå¹¶ä»è§†å›¾æ¨¡å‹æ•°æ®ä¸­å“åº”è§†å›¾:</p>
<pre><code class="language-swift">homeViewModel.loading.bind(to: self.rx.isAnimating).disposed(by:disposeBag)
</code></pre>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†loadingç»‘å®šåˆ°isAnimatingï¼Œè¿™æ„å‘³ç€æ¯å½“viewModelæ”¹å˜åŠ loadingæ—¶ï¼Œè§†å›¾æ§åˆ¶å™¨çš„isAnimatingå€¼ä¹Ÿä¼šæ”¹å˜ã€‚ä½ å¯èƒ½ä¼šé—®ï¼Œæˆ‘ä»¬æ˜¯å¦æ­£åœ¨ç”¨è¿™æ®µä»£ç æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ã€‚ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä½†å®ƒéœ€è¦ä¸€äº›æ‰©å±•ï¼Œç¨åæˆ‘ä¼šè§£é‡Šã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬çš„æ•°æ®ç»‘å®šåˆ°UIKitï¼Œä¸ºäº†æ”¯æŒRxCocoaï¼Œæœ‰å¾ˆå¤šå±æ€§å¯ä»¥ä»ä¸åŒçš„è§†å›¾ä¸­è·å¾—ï¼Œä½ å¯ä»¥ä»rx propertyä¸­è®¿é—®è¿™äº›å±æ€§ã€‚è¿™äº›å±æ€§æ˜¯binderï¼Œå› æ­¤æ‚¨å¯ä»¥è½»æ¾åœ°è¿›è¡Œç»‘å®šã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€?</p>
<p>è¿™æ„å‘³ç€å½“æˆ‘ä»¬å°†ä¸€ä¸ªObservableç»‘å®šåˆ°ä¸€ä¸ªbinderæ—¶ï¼Œbinderä¼šå¯¹è¿™ä¸ªObservableçš„å€¼åšå‡ºååº”ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æœ‰ä¸€ä¸ªBoolçš„PublishSubjectï¼Œå®ƒäº§ç”ŸçœŸå’Œå‡ã€‚å¦‚æœæ‚¨å°†è¯¥ä¸»é¢˜ç»‘å®šåˆ°è§†å›¾çš„isHiddenå±æ€§ï¼Œé‚£ä¹ˆå¦‚æœpublishSubjectç”Ÿæˆtrueï¼Œè¯¥è§†å›¾å°†è¢«éšè—ã€‚å¦‚æœpublishSubjectç”Ÿæˆfalseï¼Œé‚£ä¹ˆviewishiddenå±æ€§å°†å˜ä¸ºfalseï¼Œç„¶åè§†å›¾å°†ä¸å†è¢«éšè—ã€‚å¾ˆé…·ï¼Œä¸æ˜¯å—?</p>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9xpt6cq5j30ve074wez.jpg" alt="avatar" loading="lazy"></figure>
<p>å°½ç®¡RxCocoaåŒ…å«äº†å¾ˆå¤šUIKitå±æ€§ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å±æ€§(ä¾‹å¦‚è‡ªå®šä¹‰çš„ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯animation)å¹¶ä¸åœ¨RxCocoaä¸­ï¼Œä½†æ˜¯ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°æ·»åŠ å®ƒä»¬:</p>
<pre><code class="language-swift">extension Reactive where Base: UIViewController {
    
    /// Bindable sink for `startAnimating()`, `stopAnimating()` methods.
    public var isAnimating: Binder&lt;Bool&gt; {
        return Binder(self.base, binding: { (vc, active) in
            if active {
                vc.startAnimating()
            } else {
                vc.stopAnimating()
            }
        })
    }
    
}
</code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬æ¥è§£é‡Šä¸Šé¢çš„ä»£ç :</p>
<ol>
<li>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªæ‰©å±•çš„ååº”ï¼Œè¿™æ˜¯åœ¨RxCocoaå’Œå½±å“RXå±æ€§çš„UIViewControllerã€‚</p>
</li>
<li>
<p>æˆ‘ä»¬ä¸ºUIViewControllerså®ç°äº†Binder<Bool>ç±»å‹çš„isAnimatingå˜é‡ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥è¢«ç»‘å®šäº†ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºBinderï¼Œå¯¹äºBinderéƒ¨åˆ†ï¼Œé—­åŒ…ç»™äº†æˆ‘ä»¬è§†å›¾æ§åˆ¶å™¨(vc)å’ŒisAnimating (active)çš„å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåœ¨isAnimatingçš„æ¯ä¸ªå€¼ä¸­è¯´viewControllerå‘ç”Ÿäº†ä»€ä¹ˆï¼Œæ‰€ä»¥å¦‚æœactiveä¸ºçœŸï¼Œæˆ‘ä»¬å°±ç”¨vc.startAnimating()æ¥æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œå½“activeä¸ºå‡æ—¶éšè—åŠ è½½ã€‚</p>
</li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬çš„loadingå·²ç»å‡†å¤‡å¥½ä»ViewModelæ¥æ”¶æ•°æ®äº†ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä»–çš„binders:</p>
<pre><code class="language-swift">// observing errors to show
        
homeViewModel
    .error
    .observeOn(MainScheduler.instance)
    .subscribe(onNext: { (error) in
        switch error {
        case .internetError(let message):
            MessageView.sharedInstance.showOnView(message: message, theme: .error)
        case .serverMessage(let message):
            MessageView.sharedInstance.showOnView(message: message, theme: .warning)
        }
    })
    .disposed(by: disposeBag)          
</code></pre>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ¯å½“ViewModelå‡ºç°é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šè®¢é˜…å®ƒã€‚æ‚¨å¯ä»¥å¯¹é”™è¯¯åšä»»ä½•æ‚¨æƒ³åšçš„äº‹æƒ…(æˆ‘æ­£åœ¨æ˜¾ç¤ºä¸€ä¸ªå¼¹å‡ºçª—å£)ã€‚</p>
<p>é‚£ä¹ˆ.observeon(mainscheduler.instance)æ˜¯ä»€ä¹ˆ? è¿™éƒ¨åˆ†ä»£ç å°†å‘å‡ºçš„ä¿¡å·(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯é”™è¯¯)å¸¦åˆ°ä¸»çº¿ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ViewModelæ­£åœ¨ä»åå°çº¿ç¨‹å‘é€å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é¿å…äº†åå°çº¿ç¨‹é€ æˆçš„è¿è¡Œæ—¶å´©æºƒã€‚ä½ åªéœ€åœ¨ä¸€è¡Œä¸­å°†ä¿¡å·å‘é€åˆ°ä¸»çº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨DispatchQueue.main.async{}æ–¹æ³•ã€‚</p>
<h3 id="13-a-namelasttouchalast-touch">1.3. <a name='Lasttouch'></a>Last touch</h3>
<h4 id="131-a-nameconnectalbumsandtrackspropertiesaconnect-albums-and-tracks-properties">1.3.1. <a name='ConnectAlbumsandTracksproperties'></a>Connect Albums and Tracks properties</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬ç»‘å®šä¸“è¾‘UICollectionViewå’ŒéŸ³è½¨çš„UITableViewã€‚å› ä¸ºtableViewå’ŒcollectionViewå±æ€§åœ¨å­ViewControllersä¸­ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªæ˜¯å°†ViewModelä¸­çš„ç›¸å†Œå’ŒéŸ³è½¨æ•°ç»„ç»‘å®šåˆ°childviewcontrollerçš„éŸ³è½¨å’ŒéŸ³è½¨å±æ€§ï¼Œå¹¶è®©å­è§†å›¾è´Ÿè´£æ˜¾ç¤ºå®ƒä»¬(æˆ‘å°†åœ¨æ–‡ç« çš„æœ€åå±•ç¤ºå¦‚ä½•åšåˆ°):</p>
<pre><code class="language-swift">// binding albums to album container
        
homeViewModel
    .albums
    .observeOn(MainScheduler.instance)
    .bind(to: albumsViewController.albums)
    .disposed(by: disposeBag)

// binding tracks to track container

homeViewModel
    .tracks
    .observeOn(MainScheduler.instance)
    .bind(to: tracksViewController.tracks)
    .disposed(by: disposeBag)
       
</code></pre>
<h4 id="132-a-namerequestdatafromviewmodelarequest-data-from-view-model">1.3.2. <a name='RequestdatafromViewModel'></a>Request data from View Model</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬å›åˆ°ViewModelï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ:</p>
<pre><code class="language-swift">public func requestData(){
        
    self.loading.onNext(true)
    APIManager.requestData(url: requestUrl, method: .get, parameters: nil, completion: { (result) in
        self.loading.onNext(false)
        switch result {
        case .success(let returnJson) :
            let albums = returnJson[&quot;Albums&quot;].arrayValue.compactMap {return Album(data: try! $0.rawData())}
            let tracks = returnJson[&quot;Tracks&quot;].arrayValue.compactMap {return Track(data: try! $0.rawData())}
            self.albums.onNext(albums)
            self.tracks.onNext(tracks)
        case .failure(let failure) :
            switch failure {
            case .connectionError:
                self.error.onNext(.internetError(&quot;Check your Internet connection.&quot;))
            case .authorizationError(let errorJson):
                self.error.onNext(.serverMessage(errorJson[&quot;message&quot;].stringValue))
            default:
                self.error.onNext(.serverMessage(&quot;Unknown Error&quot;))
            }
        }
    })        
}
</code></pre>
<ol>
<li>
<p>æˆ‘ä»¬å‘å‡ºloadingå€¼ä¸ºtrueï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨HomeVCç±»ä¸­åšäº†ç»‘å®šï¼Œæˆ‘ä»¬çš„viewControllerç°åœ¨æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€å‘ç½‘ç»œå±‚(Alamofireæˆ–ä»»ä½•ä½ æ‹¥æœ‰çš„ç½‘ç»œå±‚)å‘é€æ•°æ®è¯·æ±‚ã€‚</p>
</li>
<li>
<p>åœ¨é‚£ä¹‹åï¼Œæˆ‘ä»¬ä»æœåŠ¡å™¨å¾—åˆ°å“åº”ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡å‘loadingå‘é€falseæ¥ç»“æŸåŠ è½½åŠ¨ç”»ã€‚</p>
</li>
<li>
<p>line (13â€“19) ç°åœ¨æœ‰äº†æœåŠ¡å™¨çš„å“åº”ï¼Œå¦‚æœæˆ‘ä»¬é‡åˆ°éº»çƒ¦ï¼Œæˆ‘ä»¬å‘å‡ºé”™è¯¯å€¼ã€‚åŒæ ·ï¼Œå› ä¸ºHomeVCå·²ç»è®¢é˜…äº†é”™è¯¯ï¼Œæ‰€ä»¥å®ƒä»¬å°†æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚</p>
</li>
<li>
<p>(line 8â€“11)  å¦‚æœå“åº”æˆåŠŸï¼Œæˆ‘ä»¬è§£ææ•°æ®å¹¶å‘å‡ºä¸“è¾‘å’Œæ­Œæ›²çš„å€¼ã€‚</p>
</li>
</ol>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9yauxod4j319g04iabq.jpg" alt="avatar" loading="lazy"></figure>
<p>ç°åœ¨æˆ‘ä»¬çš„æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¼ é€’ç»™äº†æˆ‘ä»¬çš„childViewControllersï¼Œæœ€åæˆ‘ä»¬åº”è¯¥åœ¨CollectionViewå’ŒTableViewä¸­æ˜¾ç¤ºæ•°æ®:</p>
<p>å¦‚æœä½ è¿˜è®°å¾—HomeVCçš„è¯¾ç¨‹:</p>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9ycaopsrj30ma02e3ye.jpg" alt="avatar" loading="lazy"></figure>
<p>ç°åœ¨åœ¨trackTableViewVCçš„viewDidLoadæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å°†è½¨é“ç»‘å®šåˆ°UITableViewï¼Œè¿™å¯ä»¥åœ¨ä¸¤è¡Œä¸­å®Œæˆã€‚æ„Ÿè°¢RxCocoa !</p>
<pre><code class="language-swift">    tracks.bind(to: tracksTableView.rx.items(cellIdentifier:    &quot;TracksTableViewCell&quot;, cellType: TracksTableViewCell.self)) {  (row,track,cell) in
                cell.cellTrack = track
    }.disposed(by: disposeBag)
</code></pre>
<p>æ˜¯çš„ï¼Œä½ è¯´å¯¹äº†ï¼Œåªæœ‰ä¸¤è¡Œã€‚ä¸å†è®¾ç½®å§”æ‰˜æˆ–æ•°æ®æºï¼Œä¸å†numberOfSections, numberOfRowsInSectionå’ŒcellForRowAtã€‚RxCocoaåªéœ€ä¸¤è¡Œå°±å¯ä»¥å¤„ç†æ‰€æœ‰å†…å®¹ã€‚</p>
<p>ä½ åªéœ€è¦ä¼ é€’æ¨¡å‹(ç»‘å®šæ¨¡å‹åˆ°UITableView)å¹¶ç»™å®ƒä¸€ä¸ªcellTypeã€‚åœ¨é—­åŒ…ä¸­ï¼ŒRxCocoaå°†ä¸ºæ‚¨æä¾›ä¸æ¨¡å‹æ•°ç»„ç›¸å¯¹åº”çš„å•å…ƒæ ¼ã€æ¨¡å‹å’Œè¡Œï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥ä¸ºå•å…ƒæ ¼æä¾›ç›¸åº”çš„æ¨¡å‹ã€‚åœ¨æˆ‘ä»¬çš„å•å…ƒæ ¼ä¸­ï¼Œæ¯å½“æ¨¡å‹è¢«didSetè®¾ç½®ï¼Œå•å…ƒæ ¼å°±ä¼šç”¨æ¨¡å‹è®¾ç½®å±æ€§ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gq9yhutijtj30vy09yjs1.jpg" alt="avatar" loading="lazy"></figure>
<p>å½“ç„¶ï¼Œæ‚¨å¯ä»¥åœ¨é—­åŒ…å†…æ›´æ”¹è§†å›¾ï¼Œä½†æˆ‘æ›´å–œæ¬¢è®¡ç®—å±æ€§æ–¹å¼ã€‚</p>
<h4 id="133-a-nameaddingbonusanimationaadding-bonus-animation">1.3.3. <a name='Addingbonusanimation'></a>Adding bonus animation</h4>
<p>åœ¨æ–‡ç« ç»“æŸä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç»™æˆ‘ä»¬çš„tableViewå’ŒcollectionViewæ·»åŠ ä¸€äº›åŠ¨ç”»:</p>
<pre><code class="language-swift">// animation to cells
tracksTableView.rx.willDisplayCell
    .subscribe(onNext: ({ (cell,indexPath) in
        cell.alpha = 0
        let transform = CATransform3DTranslate(CATransform3DIdentity, -250, 0, 0)
        cell.layer.transform = transform
        UIView.animate(withDuration: 1, delay: 0, usingSpringWithDamping: 0.7, initialSpringVelocity: 0.5, options: .curveEaseOut, animations: {
            cell.alpha = 1
            cell.layer.transform = CATransform3DIdentity
        }, completion: nil)
    })).disposed(by: disposeBag)
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/30RN4if0u/" class="tag">
                    mvvm
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/r1b4Frlkm/" class="tag">
                    rxswift
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/managing-view-controllers-with-container-view-controllers/">
                  <h3 class="post-title">
                    Managing View Controllers With Container View Controllers
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
