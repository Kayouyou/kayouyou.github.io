<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 92: Dependency Injection Made Modular | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1661042947575">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Introduction




Using the architectureâ€™s environment




Tuplizing the environment




Testing with the environment..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1661042947575" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 92: Dependency Injection Made Modular</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Introduction">Introduction</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Usingthearchitecturesenvironment">Using the architectureâ€™s environment</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Tuplizingtheenvironment">Tuplizing the environment</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Testingwiththeenvironment">Testing with the environment</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Conclution">Conclution</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 92: Dependency Injection Made Modular -->
<h2 id="1-a-nameintroductionaintroduction">1. <a name='Introduction'></a>Introduction</h2>
<p>ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­æ„å»ºå‰©ä¸‹çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ¨¡å—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»æœ€ç®€å•ã€ä¾èµ–æœ€å°‘çš„æ¨¡å—å¼€å§‹ï¼Œç„¶åè¿”å›åˆ°ä¸»åº”ç”¨ç›®æ ‡ã€‚åŒæ ·å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä»£ç ä¸­ä½¿ç”¨äº†<strong>environment</strong>æŠ€æœ¯ï¼Œè¿™å°†ä½¿è½¬æ¢åˆ°è¿™ç§æ–°æ ·å¼å˜å¾—éå¸¸å®¹æ˜“ã€‚</p>
<h2 id="2-a-nameusingthearchitecturesenvironmentausing-the-architectures-environment">2. <a name='Usingthearchitecturesenvironment'></a>Using the architectureâ€™s environment</h2>
<p>è®©æˆ‘ä»¬ä»<strong>PrimeModal</strong>æ¨¡å—å¼€å§‹ã€‚å®ƒå®é™…ä¸Šæ²¡æœ‰ä»»ä½•<strong>effects</strong>ï¼Œå› æ­¤ä¸ä½¿ç”¨<strong>environment</strong>ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦æ›´æ–°å®ƒçš„<strong>reducer</strong>ä»¥ä½¿ç”¨æ–°çš„ç­¾åã€‚ é‚£ä¹ˆå®ƒåº”è¯¥æœ‰ä»€ä¹ˆæ ·çš„<strong>environment</strong>å‘¢?</p>
<pre><code class="language-swift">public func primeModalReducer(
  state: inout PrimeModalState,
  action: PrimeModalAction,
  environment: ???
) {
</code></pre>
<p>å› ä¸ºè¿™ä¸ªç‰¹æ€§ä¸éœ€è¦ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>Void</strong>ã€‚è¿™è¡¨ç¤ºä¸€ä¸ªä¸ä¿å­˜ä»»ä½•æœ‰æ„ä¹‰çš„ä¸œè¥¿çš„ç¯å¢ƒï¼Œå› æ­¤ä¸éœ€è¦ä»»ä½•ä¾èµ–æ¥å®Œæˆå®ƒçš„å·¥ä½œ:</p>
<pre><code class="language-swift">public func primeModalReducer(state: inout PrimeModalState, action: PrimeModalAction, environment: Void) {
</code></pre>
<p>ç°åœ¨<strong>PrimeModal</strong>æ¨¡å—æ­£åœ¨æ„å»ºã€‚</p>
<p>è®©æˆ‘ä»¬è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå¤æ‚çš„æ¨¡å—ï¼Œ<strong>FavoritePrimes</strong>æ¨¡å—ã€‚è¿™ç¡®å®æœ‰å½±å“ï¼Œä½†æ€»çš„æ¥è¯´è¿™ä¸ªç‰¹æ€§éå¸¸ç®€å•ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦æŠŠ<strong>reducer</strong>ä¿®å¥½:</p>
<pre><code class="language-swift">public func favoritePrimesReducer(state: inout [Int], action: FavoritePrimesAction) {
</code></pre>
<p>è¿™ä¸€æ¬¡æˆ‘ä»¬ç¡®å®éœ€è¦ä¸€ä¸ª<strong>environment</strong>ï¼Œè€Œä¸”å®é™…ä¸Šæˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¿…è¦ä¾èµ–é¡¹çš„<strong>environment</strong>ã€‚å®ƒå«<strong>FavoritePrimesEnvironment</strong>ï¼Œç°åœ¨å®ƒåªåŒ…å«ä¸€ä¸ª<strong>FileClient</strong>ï¼Œä½†æœªæ¥å®ƒå¯ä»¥å®¹çº³æ›´å¤šã€‚æ‰€ä»¥è®©æˆ‘ä»¬ç”¨å®ƒä½œä¸ºæˆ‘ä»¬çš„<strong>reducer</strong>çš„ç¯å¢ƒ:</p>
<pre><code class="language-swift">public func favoritePrimesReducer(
  state: inout [Int],
  action: FavoritePrimesAction,
  environment: FavoritePrimesEnvironment
) {
</code></pre>
<p>æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªå°é”™è¯¯:</p>
<blockquote>
<p>ğŸ›‘ Constant cannot be declared public because its type uses an internal type</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸º<strong>FavoritePrimesEnvironment</strong>æ˜¯å†…éƒ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©å®ƒå…¬å¼€:</p>
<pre><code class="language-swift">public struct FavoritePrimesEnvironment {
  var fileClient: FileClient
}
</code></pre>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™ä¸ªæ¨¡å—æ­£åœ¨æ„å»ºä¸­ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰åˆ©ç”¨<strong>reducer</strong>ä¸­ç»™å‡ºçš„<strong>environment</strong>ã€‚æˆ‘ä»¬ä»åœ¨å‘¼å”¤å…¨å±€<strong>Current</strong>ã€‚æ‰€ä»¥è®©æˆ‘ä»¬æ›´æ–°<strong>reducer</strong>:</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [
    environment.fileClient.save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
      .fireAndForget()
  ]

case .loadButtonTapped:
  return [
    environment.fileClient.load(&quot;favorite-primes.json&quot;)
      .compactMap { $0 }
      .decode(type: [Int].self, decoder: JSONDecoder())
      .catch { error in Empty(completeImmediately: true) }
      .map(FavoritePrimesAction.loadedFavoritePrimes)
      .eraseToEffect()
  ]
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ é™¤æˆ‘ä»¬çš„<strong>Current</strong>å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å®Œå…¨ä¾èµ–äºä¼ é€’ç»™<strong>reducer</strong>çš„<strong>environment</strong>:</p>
<pre><code class="language-swift">//var Current = FavoritePrimesEnvironment.live
</code></pre>
<p>ç°åœ¨è¿™ä¸ªæ¨¡å—æ­£åœ¨æ„å»ºï¼Œä½†åœ¨ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å—ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åˆ©ç”¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯æ¨¡å—åŒ–çš„è¿™ä¸€äº‹å®ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥ç›´æ¥åœ¨<strong>playground</strong>ä¸­æµ‹è¯•è¿™ä¸ªè§†å›¾ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡éƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<p>è¿™æ˜¯å”¯ä¸€å¯èƒ½çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åšäº†æ¨¡å—åŒ–çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬ä¸éœ€è¦å¾—åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºæ„å»ºæ¥æµ‹è¯•è¿™ä¸ªå˜åŒ–ã€‚æˆ‘ä»¬åªéœ€è¦å»ºç«‹è¿™ä¸ªæ¨¡å—ã€‚è¿™åœ¨å¤§å‹é¡¹ç›®ä¸­éå¸¸æœ‰ç”¨ã€‚å®ƒä¸ºä½ æä¾›äº†å¤§é‡çš„çµæ´»æ€§æ¥è¿›è¡Œæ½œåœ¨çš„é‡æ„å’Œä¿®æ”¹apiï¼Œå› ä¸ºä½ å¯ä»¥åªåœ¨åº”ç”¨çš„ä¸€å°éƒ¨åˆ†è¿›è¡Œæµ‹è¯•ï¼Œè€Œæ— éœ€è½¬æ¢æ•´ä¸ªåº”ç”¨ã€‚</p>
<p>æˆ‘ä»¬å·²ç»æœ‰äº†è¿™ä¸ªæ¨¡å—çš„<strong>playground</strong>ï¼Œä½†å®ƒä¸æ‰“ç®—ç¼–è¯‘ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†æ—§çš„<strong>Current</strong>ç¯å¢ƒæŠ€æœ¯ã€‚ ä¸å…¶æ”¹å˜å…¨å±€çš„<strong>Current</strong>å€¼ï¼Œä¸å¦‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå°çš„æœ¬åœ°ç¯å¢ƒæ¥ç©:</p>
<pre><code class="language-swift">var environment = FavoritePrimesEnvironment.mock
environment.fileClient.load = { _ in
  Effect.sync { try! JSONEncoder().encode(Array(1...10)) }
}
</code></pre>
<p>ç„¶åå½“æˆ‘ä»¬æ„å»ºè¿™ä¸ª<strong>store</strong>è®©è§†å›¾åœ¨è¿™ä¸ª<strong>playground</strong>ä¸Šè¿è¡Œæ—¶æˆ‘ä»¬å¯ä»¥ä¼ é€’è¿™ä¸ª<strong>environment</strong>:</p>
<pre><code class="language-swift">PlaygroundPage.current.liveView = UIHostingController(
  rootView: NavigationView {
    FavoritePrimesView(
      store: Store&lt;[Int], FavoritePrimesAction&gt;(
        initialValue: [2, 3, 5, 7, 11],
        reducer: favoritePrimesReducer,
        environment: environment
      )
    )
  }
)
</code></pre>
<p>å®ƒçš„è¡Œä¸ºå’Œä»¥å‰æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å†æ¬¡ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³é‡ç”³ï¼Œèƒ½å¤Ÿå¦‚æ­¤è¿…é€Ÿåœ°åšå‡ºè¿™æ ·çš„æ”¹å˜ï¼Œå¹¶åœ¨å­¤ç«‹çš„æƒ…å†µä¸‹è¿­ä»£è¿™äº›æƒ³æ³•æ˜¯å¤šä¹ˆå¼ºå¤§ã€‚å¦‚æœæˆ‘ä»¬ä¸å¾—ä¸æ›´æ–°æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•è¿™ä¸ªå˜åŒ–ï¼Œæˆ‘ä»¬ç”šè‡³å¯èƒ½ä¸é¼“åŠ±å°è¯•ã€‚æ¯•ç«Ÿï¼Œä¹Ÿè®¸æˆ‘ä»¬å‘ç°è¿™ä¸ªæ”¹å˜ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šæ¢å¤å®ƒã€‚å¦‚æœæŠŠæ‰€æœ‰çš„å·¥ä½œéƒ½æ‰”åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºæ„å»ºä¸­å»ï¼Œé‚£å°†æ˜¯ä¸€ä»¶ä»¤äººæ²®ä¸§çš„äº‹æƒ…ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥<strong>Counter</strong>æ¨¡å—ã€‚è¿™ä¸ªæ¨¡å—ä¸ä»…æœ‰ä¸€äº›å‰¯ä½œç”¨ï¼Œè€Œä¸”è¿˜æœ‰ä¸€äº›æˆ‘ä»¬åœ¨ä¹‹å‰çš„æ¨¡å—ä¸­æ²¡æœ‰çœ‹åˆ°çš„æ–°ä¸œè¥¿ã€‚ è®©æˆ‘ä»¬ä»<strong>counterReducer</strong>å¼€å§‹ã€‚æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªç¯å¢ƒï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ä¸€ä¸ªï¼Œ<strong>CounterEnvironment</strong>ï¼Œå®ƒå…·æœ‰è®¡ç®—ç¬¬nä¸ªç´ æ•°çš„nç´ æ•°æ•ˆåº”ã€‚</p>
<pre><code class="language-swift">public func counterReducer(
  state: inout CounterState,
  action: CounterAction,
  environment: CounterEnvironment
) -&gt; [Effect&lt;CounterAction&gt;] {
</code></pre>
<p>å°±åƒä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†<strong>environment</strong>å…¬å¼€åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å»æ‰å…¨å±€çš„<strong>Current</strong>å˜é‡:</p>
<pre><code class="language-swift">public struct CounterEnvironment {
  var nthPrime: (Int) -&gt; Effect&lt;Int?&gt;
}

//var Current = CounterEnvironment.live
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆ‘ä»¬ä¼ é€’åˆ°<strong>reducer</strong>çš„<strong>environment</strong>è€Œä¸æ˜¯<strong>Current</strong>ã€‚</p>
<pre><code class="language-swift">case .nthPrimeButtonTapped:
  state.isNthPrimeButtonDisabled = true
  return [
    environment.nthPrime(state.count)
      .map(CounterAction.nthPrimeResponse)
      .receive(on: DispatchQueue.main)
      .eraseToEffect()
]
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦ä¿®æ­£<strong>pullback</strong>ã€‚ç°åœ¨æˆ‘ä»¬åªæ˜¯æ²¿ç€<strong>reducer</strong>çš„çŠ¶æ€å’Œä½œç”¨å¾€å›æ‹‰ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦ç»“åˆå®ƒä»¬çš„ç¯å¢ƒï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿæè¿°å¦‚ä½•å°†å±€éƒ¨<strong>counter</strong>å’Œç´ æ¨¡æ€<strong>reducer</strong>åµŒå…¥åˆ°åŒ…å«å®ƒä»¬ä¸¤ç§åŠŸèƒ½çš„æ›´å¤§<strong>reducer</strong>ä¸­ã€‚</p>
<p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»æè¿°å¦‚ä½•å°†çˆ¶æ¨¡å¼ç¯å¢ƒè½¬åŒ–ä¸ºæ¯ä¸€ä¸ª<strong>counter</strong>å’Œ<strong>prime modal</strong> ç¯å¢ƒã€‚è®©æˆ‘ä»¬å…ˆç»™<strong>counterViewReducer</strong>ä¸€ä¸ªç±»å‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“æˆ‘ä»¬åˆ°åº•åœ¨è½¬æ¢ä»€ä¹ˆ:</p>
<pre><code class="language-swift">public let counterViewReducer: Reducer&lt;CounterViewState, CounterViewAction, ???&gt; = combine(
  pullback(
    counterReducer,
    value: \CounterViewState.counter,
    action: /CounterViewAction.counter,
    environment: { ??? }
  ),
  pullback(
    primeModalReducer,
    value: \.primeModal,
    action: /CounterViewAction.primeModal,
    environment: { ??? }
  )
)
</code></pre>
<p>æˆ‘ä»¬åº”è¯¥ç”¨ä»€ä¹ˆ<strong>environment</strong>? å®ƒéœ€è¦å…·æœ‰è®¡æ•°å™¨<strong>reducer</strong>å’Œåˆå§‹æ¨¡æ€<strong>reducer</strong>çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚ä½†æ˜¯ï¼Œ<strong>prime modal reducer</strong>æœ‰ä¸€ä¸ª<strong>Void</strong>ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªç»„åˆ<strong>reducer</strong>ä½¿ç”¨<strong>CounterEnvironment</strong>:</p>
<pre><code class="language-swift">public let counterViewReducer: Reducer&lt;CounterViewState, CounterViewAction, CounterEnvironment&gt;
</code></pre>
<p>ç„¶åï¼Œå¯¹äºæ¯ä¸ªå›è°ƒï¼Œæˆ‘ä»¬éœ€è¦æè¿°å¦‚ä½•å°†è¿™ä¸ª<strong>CounterEnvironment</strong>è½¬æ¢ä¸ºæˆ‘ä»¬æ­£åœ¨å›è°ƒçš„<strong>reducer</strong>çš„å„è‡ªç¯å¢ƒã€‚å¯¹äº<strong>counter reducer</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åªå–æ•´ä¸ªç¯å¢ƒï¼Œè€Œå¯¹äºprimeæ¨¡æ€reducerï¼Œæˆ‘ä»¬ä¸æƒ³å–ä»»ä½•ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¿½ç•¥<strong>counter environment</strong>ï¼Œåªè¿”å›void:</p>
<pre><code class="language-swift">public let counterViewReducer = combine(
  pullback(
    counterReducer,
    value: \CounterViewState.counter,
    action: /CounterViewAction.counter,
    environment: { $0 }
  ),
  pullback(
    primeModalReducer,
    value: \.primeModal,
    action: /CounterViewAction.primeModal,
    environment: { _ in () }
  )
)
</code></pre>
<p>å°±åƒè¿™æ ·<strong>Counter</strong>æ¨¡å—æ­£åœ¨æ„å»ºã€‚</p>
<p>æˆ‘ä»¬åªå‰©ä¸‹éœ€è¦ä¿®å¤çš„åº”ç”¨ç›®æ ‡ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬çš„playgroundä¸­ä¸€åˆ‡æ­£å¸¸ã€‚ä¸ºäº†è®©playgroundç¼–è¯‘ï¼Œæˆ‘ä»¬åªéœ€è¦åœæ­¢ä½¿ç”¨<strong>Current</strong>å˜é‡ï¼Œå¹¶å°†ä¸€ä¸ªç¯å¢ƒä¼ é€’ç»™<strong>store</strong>:</p>
<pre><code class="language-swift">var environment = CounterEnvironment.mock
environment.nthPrime = { _ in .sync { 7236893748932 }}

PlaygroundPage.current.liveView = UIHostingController(
  rootView: CounterView(
    store: Store&lt;CounterViewState, CounterViewAction&gt;(
      initialValue: CounterViewState(
        alertNthPrime: nil,
        count: 0,
        favoritePrimes: [],
        isNthPrimeButtonDisabled: false
      ),
      reducer: logging(counterViewReducer),
      environment: environment
    )
  )
)
</code></pre>
<p>ä¸€åˆ‡ä¼¼ä¹éƒ½å’Œä¹‹å‰ä¸€æ ·ã€‚</p>
<p>æˆ‘ä»¬åˆ°äº†é‡æ„çš„æœ€åä¸€æ­¥:<strong>the app target</strong>ã€‚è¿™ä¸ªç›®æ ‡è´Ÿè´£è·å–æ‰€æœ‰ç‰¹æ€§æ¨¡å—ä¸­å®šä¹‰çš„æ‰€æœ‰reducerså’Œviewsï¼Œå¹¶å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·å½¢æˆå®Œæ•´çš„åº”ç”¨ç¨‹åºã€‚åªæœ‰å‡ ä¸ªç¼–è¯‘å™¨é”™è¯¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯å›è°ƒï¼Œè¿™æ˜¯å¯ä»¥ç†è§£çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æè¿°å¦‚ä½•è½¬æ¢ç¯å¢ƒã€‚</p>
<p>è®©æˆ‘ä»¬ä»å›è°ƒå¼€å§‹ã€‚ç°åœ¨çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(
    counterViewReducer,
    value: \AppState.counterView,
    action: /AppAction.counterView
  ),
  pullback(
    favoritePrimesReducer,
    value: \.favoritePrimes,
    action: /AppAction.favoritePrimes
  )
)
</code></pre>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºçº§åˆ«æ‹¥æœ‰ä»€ä¹ˆæ ·çš„<strong>environment</strong>ã€‚å®ƒéœ€è¦åŒ…å«<strong>counterViewReducer</strong>å’Œ<strong>favoritePrimesReducer</strong>çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜è¿™äº›<strong>environments</strong>:</p>
<pre><code class="language-swift">struct AppEnvironment {
  var counter: CounterEnvironment
  var favoritePrimes: FavoritePrimesEnvironment
}
</code></pre>
<p>ç„¶åå½“æˆ‘ä»¬æ‹‰å›æ¯ä¸ªç‰¹æ€§<strong>reducers</strong>æ—¶æˆ‘ä»¬åªéœ€è¦æè¿°å¦‚ä½•å°†åº”ç”¨ç¨‹åºç¯å¢ƒè½¬æ¢ä¸ºå„è‡ªç‰¹æ€§çš„ç¯å¢ƒã€‚è¿™å°±åƒå–å‡ºæˆ‘ä»¬éœ€è¦çš„<strong>struct</strong>å­—æ®µä¸€æ ·ç®€å•:</p>
<pre><code class="language-swift">let appReducer: Reducer&lt;AppState, AppAction, AppEnvironment&gt; = combine(
  pullback(
    counterViewReducer,
    value: \AppState.counterView,
    action: /AppAction.counterView,
    environment: { $0.counter }
  ),
  pullback(
    favoritePrimesReducer,
    value: \.favoritePrimes,
    action: /AppAction.favoritePrimes,
    environment: { $0.favoritePrimes }
  )
)
</code></pre>
<p>ç°åœ¨<strong>pullback</strong>æ­£åœ¨ç¼–è¯‘ã€‚åœ¨å®è·µä¸­çœ‹åˆ°è¿™ç§è½¬æ¢æ˜¯å¾ˆé…·çš„ã€‚æˆ‘ä»¬å…è®¸çˆ¶ç‰¹æ€§åŒ…å«å…¶å­ç‰¹æ€§çš„æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œç„¶åå½“æˆ‘ä»¬å°†ä¸€å †å­ç‰¹æ€§ç»„åˆåœ¨ä¸€èµ·æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ‡æ‰å®ƒæ‰€å…³å¿ƒçš„ç¯å¢ƒçš„ä¸€éƒ¨åˆ†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæ‰€æœ‰è¿™3ä¸ªè½¬æ¢éƒ½æ˜¯é™æ€æ£€æŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¡®ä¿¡ï¼Œå¦‚æœç¼–è¯‘çš„è¯ï¼Œæˆ‘ä»¬çš„ç‰¹æ€§å¯ä»¥æ­£ç¡®åœ°æ’å…¥åˆ°ä¸€èµ·ã€‚</p>
<p>ä¸‹ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯æ˜¯åœ¨<strong>activity feed</strong>çš„é«˜é˜¶<strong>reducer</strong>ä¸­ã€‚ä¸ºäº†è®©å®ƒå†æ¬¡ç¼–è¯‘ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥ç¯å¢ƒæ³›å‹å’Œ<strong>reducer</strong>å‚æ•°ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™æˆ‘ä»¬æ­£åœ¨è½¬æ¢çš„<strong>reducer</strong>:</p>
<pre><code class="language-swift">func activityFeed(
  _ reducer: @escaping Reducer&lt;AppState, AppAction, AppEnvironment&gt;
) -&gt; Reducer&lt;AppState, AppAction, AppEnvironment&gt; {

  return { state, action, environment in
    â€¦

    return reducer(&amp;state, action, environment)
  }
}
</code></pre>
<p>æœ€åä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯æ˜¯åœ¨åˆ›å»ºä¸»å†…å®¹è§†å›¾æ—¶ï¼Œå®ƒéœ€è¦åˆ›å»ºä¸€ä¸ª<strong>store</strong>ï¼Œç°åœ¨éœ€è¦æä¾›ä¸€ä¸ªç¯å¢ƒã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æä¾›æ‰€æœ‰ä¾èµ–é¡¹çš„å®æ—¶ç‰ˆæœ¬æ¥å®ç°:</p>
<pre><code class="language-swift">window.rootViewController = UIHostingController(
  rootView: ContentView(
    store: Store(
      initialValue: AppState(),
      reducer: with(
        appReducer,
        compose(
          logging,
          activityFeed
        )
      ),
      environment: AppEnvironment(
        counter: .live,
        favoritePrimes: .live
      )
    )
  )
)
</code></pre>
<p>è¿™æ˜¯è¿™ä¹ˆä¹…ä»¥æ¥çš„ç¬¬ä¸€æ¬¡ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„æ„å»ºåº”ç”¨ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œå®ƒï¼Œä¸€åˆ‡éƒ½ä¼šåƒä¹‹å‰ä¸€æ ·ç»§ç»­å·¥ä½œã€‚çœ‹åˆ°æ¨¡å—åŒ–åœ¨æ¶æ„çš„è¿™ä¸€ç³»åˆ—é‡æ„ä¸­æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬çš„ï¼ŒçœŸæ˜¯å¤ªé…·äº†! æˆ‘ä»¬åšäº†ä¸€äº›ç›¸å½“å…¨é¢çš„æ›´æ”¹ï¼Œç„¶åèƒ½å¤Ÿä¸€æ¬¡æ›´æ–°å’Œæµ‹è¯•æ¯ä¸ªæ¨¡å—ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡é‡æ„æ‰€æœ‰å†…å®¹ã€‚</p>
<hr>
<h2 id="3-a-nametuplizingtheenvironmentatuplizing-the-environment">3. <a name='Tuplizingtheenvironment'></a>Tuplizing the environment</h2>
<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘è®¤ä¸ºæœ‰å¿…è¦é—®é—®<strong>environments</strong>ç»“æ„ä½“æ˜¯å¦å‘æŒ¥äº†ä½œç”¨ã€‚ä¸ºæ¯ä¸ªç‰¹æ€§æ¨¡å—æä¾›ç¯å¢ƒç»“æ„ä½“æ˜¯ä¸å¿…è¦çš„ç›¸äº’ä¾èµ–ã€‚æ¯ä¸ªç»“æ„ä½“ä¿å­˜åˆ°è‡ªå·±çš„ç‰ˆæœ¬çš„ä¾èµ–,ç”šè‡³å°†å¯èƒ½ä¸ºä¸¤ä¸ªä¸åŒçš„åŠŸèƒ½è¦è®¿é—®ç›¸åŒçš„ä¾èµ–,æˆ‘ä»¬è¢«è¿«æŠŠå®ƒå¤åˆ¶åœ¨çˆ¶ç¯å¢ƒ,å¦‚æœ<strong>FavoritePrimes</strong>æ¨¡å—ä¹Ÿéœ€è¦<strong>Wolfram Alpha</strong>â€**nth primeâ€œ**ç«¯ç‚¹ã€‚</p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ç¯å¢ƒç»“æ„ä½“çš„ä»»ä½•ç‰¹æ€§ã€‚æˆ‘ä»¬ä¸éœ€è¦ç»™å®ƒæ·»åŠ æ–¹æ³•ï¼Œæˆ–è€…æ”¹å˜å®ƒï¼Œæˆ–è€…è®©å®ƒç¬¦åˆåè®®ã€‚çœŸæ­£éœ€è¦çš„æ˜¯æˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡ä¼ é€’å¤šä¸ªä¾èµ–é¡¹ï¼Œå› æ­¤ç±»å‹åˆ«åå’Œå…ƒç»„å¯èƒ½æ˜¯æ›´ç®€å•çš„å·¥å…·æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒå¯èƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³æˆ‘ä»¬æ­£åœ¨çœ‹åˆ°çš„åµŒå¥—ä¾èµ–é¡¹é—®é¢˜ã€‚</p>
<p>åœ¨<strong>prime modal</strong>æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬åœ¨ç¯å¢ƒä¸­ä½¿ç”¨äº†<strong>Void</strong>ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç©ºå…ƒç»„çš„ç±»å‹åˆ«åã€‚</p>
<pre><code class="language-swift">public typealias Void = ()
</code></pre>
<p>çœ‹æ¥æˆ‘ä»¬å·²ç»è¢«å…ƒç»„åŒ–äº†ã€‚</p>
<p>åœ¨<strong>FavoritePrimes</strong>æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä¸ç”¨<strong>struct</strong>æ¥åŒ…è£…æ–‡ä»¶å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯è¾“å…¥åˆ«å<strong>FavoritePrimesEnvironment</strong>ä½œä¸º<strong>FileClient</strong>:</p>
<pre><code class="language-swift">//public struct FavoritePrimesEnvironment {
//  var fileClient: FileClient
//}
public typealias FavoritePrimesEnvironment = FileClient
</code></pre>
<p>å¦‚æœå°†æ¥è¿™ä¸ªæ¨¡å—éœ€è¦æ›´å¤šä¾èµ–ï¼Œæˆ‘ä»¬å°†æŠŠè¿™ä¸ªç±»å‹åˆ«åå‡çº§ä¸ºä¸€ä¸ªå¸¦å‘½åå‚æ•°çš„å…ƒç»„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å»æ‰æ‰€æœ‰è¿™äº›ä»£ç :</p>
<pre><code class="language-swift">//extension FavoritePrimesEnvironment {
//  public static let live = FavoritePrimesEnvironment(fileClient: .live)
//}
</code></pre>
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–°çš„ç¯å¢ƒå®šä¹‰ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–°æˆ‘ä»¬çš„<strong>reducer</strong>æ¥ç›´æ¥ä½¿ç”¨<strong>environment</strong>ï¼Œè€Œä¸æ˜¯è®¿é—®<strong>fileClient</strong>å­—æ®µ:</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [
    environment.save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
    â€¦
  ]

case .loadButtonTapped:
  return [
    environment.load(&quot;favorite-primes.json&quot;)
    â€¦
  ]
</code></pre>
<p>ä»£æ›¿ä¸ºæ•´ä¸ª<strong>FavoritePrimesEnvironment</strong>åˆ›å»ºä¸€ä¸ª<strong>mock</strong>ï¼Œè®©æˆ‘ä»¬ä¸º<strong>FileClient</strong>åˆ›å»ºä¸€ä¸ª<strong>mock</strong>ï¼Œå®ƒå¯ä»¥åœ¨æµ‹è¯•ä¸­ç”¨äºåˆ›å»ºä¸€ä¸ª<strong>FavoritePrimesEnvironment</strong>:</p>
<pre><code class="language-swift">#if DEBUG
extension FileClient {
  static let mock = FileClient(
    load: { _ in Effect&lt;Data?&gt;.sync {
      try! JSONEncoder().encode([2, 31])
      } },
    save: { _, _ in .fireAndForget {} }
  )
}
#endif
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹<strong>CounterEnvironment</strong>åšåŒæ ·çš„äº‹ã€‚å®ƒæœ‰ä¸€ä¸ªå•ä¸€çš„<strong>nthPrime</strong>ä¾èµ–é¡¹ï¼Œæˆ‘ä»¬å°†åœ¨ç±»å‹åˆ«åä¸­ç›´æ¥èµ‹å€¼ã€‚</p>
<pre><code class="language-swift">//public struct CounterEnvironment {
//  var nthPrime: (Int) -&gt; Effect&lt;Int&gt;
//}
public typealias CounterEnvironment = (Int) -&gt; Effect&lt;Int?&gt;
</code></pre>
<p>åœ¨å°†æ¥ï¼Œå¦‚æœè¿™ä¸ªç¯å¢ƒå¢é•¿ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒè½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«æ¯ä¸ªä¾èµ–é¡¹å­—æ®µçš„å…ƒç»„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ³¨é‡Šæ‰â€œå®æ—¶â€ç¯å¢ƒã€‚</p>
<pre><code class="language-swift">//extension CounterEnvironment {
//  public static let live = CounterEnvironment(nthPrime: Counter.nthPrime)
//}
</code></pre>
<p>ç„¶ååœ¨<strong>counterReducer</strong>ä¸­ï¼Œæˆ‘ä»¬å°†ç›´æ¥è°ƒç”¨ç¯å¢ƒ:</p>
<pre><code class="language-swift">case .nthPrimeButtonTapped:
  state.isNthPrimeButtonDisabled = true
  return [
    environment(state.count)
    ...
  ]
</code></pre>
<p>æœ€åï¼Œåœ¨<strong>ContentView</strong>ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨åº”ç”¨ç¯å¢ƒä¸­ä½¿ç”¨åµŒå¥—çš„ç»“æ„ä½“ï¼Œé‚£æ ·ä¼šä½¿å¤šä¸ªä¸‹æ¸¸ç‰¹æ€§ä¹‹é—´éš¾ä»¥å…±äº«ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¹³é¢å…ƒç»„æ¥ä¿å­˜æ¯ä¸ªç‰¹æ€§éœ€è¦çš„æ‰€æœ‰ä¾èµ–:</p>
<pre><code class="language-swift">typealias AppEnvironment = (
  fileClient: FileClient,
  nthPrime: (Int) -&gt; Effect&lt;Int?&gt;
)
</code></pre>
<p>ç„¶åï¼Œå½“å›è°ƒæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä»åº”ç”¨ç¯å¢ƒä¸­å–å‡ºæˆ‘ä»¬å…³å¿ƒçš„ä»»ä½•ä¾èµ–ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™å„è‡ªçš„ç‰¹æ€§:</p>
<pre><code class="language-swift">let appReducer: Reducer&lt;AppState, AppAction, AppEnvironment&gt; = combine(
  pullback(
    counterViewReducer,
    value: \AppState.counterView,
    action: /AppAction.counterView,
    environment: { $0.nthPrime }
  ),
  pullback(
    favoritePrimesReducer,
    value: \.favoritePrimes,
    action: /.AppActionfavoritePrimes,
    environment: { $0.fileClient }
  )
)
</code></pre>
<p>æœ€åï¼Œåœ¨<strong>sceneddelegate</strong>ä¸­ï¼Œå½“æ„å»º<strong>store</strong>æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¼‚äº®çš„æ‰å¹³ç¯å¢ƒå…ƒç»„æ¥ä¼ é€’:</p>
<pre><code class="language-swift">window.rootViewController = UIHostingController(
  rootView: ContentView(
    store: Store(
      initialValue: AppState(),
      reducer: with(
        appReducer,
        compose(
          logging,
          activityFeed
        )
      ),
      environment: AppEnvironment(
        fileClient: .live,
        nthPrime: Counter.nthPrime
      )
    )
  )
)
</code></pre>
<p>åœ¨æ ¹ç›®å½•ä¸­æœ‰ä¸€ä¸ªå¹³å¦çš„ä¾èµ–åˆ—è¡¨è¦å¥½å¾—å¤šï¼Œç„¶åæ¯å½“æˆ‘ä»¬æ‹‰å›<strong>reducer</strong>æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†³å®šè¦ä¼ é€’å“ªäº›ä¾èµ–ã€‚</p>
<p>åœ¨ç§»åŠ¨åˆ°å…ƒç»„çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¤±å»äº†ä¸€ä¸ªå°ä¸œè¥¿ï¼Œé‚£å°±æ˜¯è‡ªåŠ¨è¡¥å…¨å·¥å…·ã€‚ç»“æ„ä½“åˆå§‹åŒ–å™¨åœ¨è‡ªåŠ¨å®Œæˆæ—¶å‡ºç°ï¼Œä½†å…ƒç»„ç±»å‹åˆ«åä¸ä¼šå‡ºç°ã€‚å¸Œæœ›æœ‰ä¸€å¤©è¿™ç§æƒ…å†µä¼šæ”¹å˜å¹¶å¾—åˆ°æ”¯æŒã€‚</p>
<hr>
<h2 id="4-a-nametestingwiththeenvironmentatesting-with-the-environment">4. <a name='Testingwiththeenvironment'></a>Testing with the environment</h2>
<p>ç°åœ¨æˆ‘ä»¬çš„æ•´ä¸ªåº”ç”¨ç¨‹åºç»ˆäºå»ºç«‹èµ·æ¥äº†ï¼Œå®ƒå’Œä¹‹å‰ä¸€æ ·å·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»ä»æˆ‘ä»¬çš„ç‰¹æ€§ä¸­åˆ é™¤äº†å¯¹å…¨å±€ç¯å¢ƒçš„ä¾èµ–ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ˜¾å¼åœ°ä¼ é€’ç¯å¢ƒã€‚æœ€é‡è¦çš„æ˜¯ï¼Œç¯å¢ƒçš„ä¼ é€’ç›´æ¥èå…¥åˆ°ä½“ç³»ç»“æ„çš„å®šä¹‰ä¸­ï¼Œå› æ­¤ä½¿ç”¨å®ƒå¹¶ä¸å›°éš¾ã€‚å½“æˆ‘ä»¬æ‰§è¡Œå›è°ƒæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æè¿°å¦‚ä½•å°†çˆ¶ç¯å¢ƒè½¬æ¢ä¸ºå­ç¯å¢ƒã€‚</p>
<p>è™½ç„¶åº”ç”¨ç¨‹åºæ­£åœ¨æ„å»ºä¸­ï¼Œä½†å®ƒçš„æµ‹è¯•è¿˜æ²¡æœ‰ã€‚æ‰€ä»¥è®©æˆ‘ä»¬å¿«é€Ÿè§£å†³è¿™äº›é—®é¢˜ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„å·¥ä½œé¡¹ç›®ï¼Œå¹¶äº†è§£æˆ‘ä»¬å·²ç»å®Œæˆäº†ä»€ä¹ˆã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä»<strong>PrimeModal</strong>æ¨¡å—å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ²¡æœ‰å¤ªå¤šäº‹æƒ…è¦åšï¼Œå› ä¸ºè¿™ä¸ªç‰¹æ€§ç”šè‡³ä¸éœ€è¦ç¯å¢ƒï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†<strong>Void</strong>ã€‚å› æ­¤ï¼Œä¸ºäº†è®©è¿™ä¸ªæµ‹è¯•ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ª<strong>void</strong>å€¼ç»™æˆ‘ä»¬çš„<strong>reducer</strong>:</p>
<pre><code class="language-swift">class PrimeModalTests: XCTestCase {
  func testSaveFavoritesPrimesTapped() {
    var state = (count: 2, favoritePrimes: [3, 5])
    let effects = primeModalReducer(state: &amp;state, action: .saveFavoritePrimeTapped,environment: ())

    let (count, favoritePrimes) = state
    XCTAssertEqual(count, 2)
    XCTAssertEqual(favoritePrimes, [3, 5, 2])
    XCTAssert(effects.isEmpty)
  }

  func testRemoveFavoritesPrimesTapped() {
    var state = (count: 3, favoritePrimes: [3, 5])
    let effects = primeModalReducer(state: &amp;state, action: .removeFavoritePrimeTapped, environment: ())

    let (count, favoritePrimes) = state
    XCTAssertEqual(count, 3)
    XCTAssertEqual(favoritePrimes, [5])
    XCTAssert(effects.isEmpty)
  }
}
</code></pre>
<p>è¿™äº›æµ‹è¯•ç°åœ¨å»ºç«‹å¹¶é€šè¿‡äº†ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è·³è½¬åˆ°<strong>FavoritePrimesTests</strong>æ¨¡å—ï¼Œè¯¥æ¨¡å—æµ‹è¯•ç¡®å®éœ€è¦ç¯å¢ƒçš„ç‰¹æ€§ã€‚å®ƒä½¿ç”¨<strong>FileClient</strong>ä¾èµ–é¡¹æ¥ä»ç£ç›˜ä¿å­˜å’ŒåŠ è½½æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥æ³¨é‡Šæ‰æˆ‘ä»¬çš„æµ‹è¯•è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†æœ‰ä¸€ä¸ªå½“å‰ç¯å¢ƒæ¥æ¨¡æ‹Ÿã€‚</p>
<pre><code class="language-swift">class FavoritePrimesTests: XCTestCase {
//  override func setUp() {
//    super.setUp()
//    Current = .mock
//  }
</code></pre>
<p>ç¬¬ä¸€ä¸ªæµ‹è¯•å¯ä»¥é€šè¿‡å°†ä¸€ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶å®¢æˆ·ç«¯ç›´æ¥ä¼ é€’ç»™<strong>reducer</strong>æ¥ä¿®å¤:</p>
<pre><code class="language-swift">func testDeleteFavoritePrimes() {
  var state = [2, 3, 5, 7]
  let effects = favoritePrimesReducer(&amp;state, .deleteFavoritePrimes([2]), .mock)

  XCTAssertEqual(state, [2, 3, 7])
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>ä¸‹ä¸€ä¸ªæµ‹è¯•ä½¿ç”¨ä¸€ä¸ªç‰¹åˆ«è®¾è®¡çš„<strong>environment</strong>ã€‚å®ƒæƒ³è¦è¿›å…¥æ–‡ä»¶å®¢æˆ·ç«¯çš„<strong>save</strong>ç«¯ç‚¹ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç¡®ä¿å®ƒå®é™…ä¸Šæ˜¯ä»<strong>reducer</strong>ä¸­è°ƒç”¨çš„ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶å®¢æˆ·ç«¯æ¥åšæˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯æ”¹å˜<strong>Current</strong>çš„å€¼:</p>
<pre><code class="language-swift">func testSaveButtonTapped() {
  var didSave = false
  var environment = FileClient.mock
  environment.save = { _, data in
    .fireAndForget {
      didSave = true
    }
  }
</code></pre>
<p>ç„¶åä½¿ç”¨è¿™ä¸ª<strong>environment</strong>ï¼Œæˆ‘ä»¬å°†å®ƒä¼ é€’ç»™<strong>reducer</strong>:</p>
<pre><code class="language-swift"> var state = [2, 3, 5, 7]
  let effects = favoritePrimesReducer(&amp;state, .saveButtonTapped, environment)

  XCTAssertEqual(state, [2, 3, 5, 7])
  XCTAssertEqual(effects.count, 1)

  effects[0].sink { _ in XCTFail() }

  XCTAssert(didSave)
}
</code></pre>
<p>è¯¥æ–‡ä»¶ä¸­çš„æœ€ç»ˆæµ‹è¯•è¿˜éœ€è¦ä¸€ä¸ªç‰¹åˆ«è®¾è®¡çš„<strong>environment</strong>ï¼Œä½†è¿™ä¸€æ¬¡å®ƒå¸Œæœ›æ¨¡æ‹Ÿ<strong>FileClient</strong>ä¸­çš„åŠ è½½ç«¯ç‚¹åŠ è½½æŸäº›ç‰¹å®šæ•°æ®çš„æƒ…å†µã€‚</p>
<pre><code class="language-swift">func testLoadFavoritePrimesFlow() {
  var environment = FileClient.mock
  environment.load = { _ in .sync { try! JSONEncoder().encode([2, 31]) } }
</code></pre>
<p>ç„¶åæˆ‘ä»¬å°†è¿™ä¸ª<strong>environment</strong>ä¼ é€’ç»™æµ‹è¯•ä¸­çš„<strong>reducer</strong>:</p>
<pre><code class="language-swift">  var state = [2, 3, 5, 7]
  var effects = favoritePrimesReducer(&amp;state, .loadButtonTapped, environment)

  XCTAssertEqual(state, [2, 3, 5, 7])
  XCTAssertEqual(effects.count, 1)

  var nextAction: FavoritePrimesAction!
  let receivedCompletion = self.expectation(description: &quot;receivedCompletion&quot;)
  effects[0].sink(
    receiveCompletion: { _ in
      receivedCompletion.fulfill()
  },
    receiveValue: { action in
      XCTAssertEqual(action, .loadedFavoritePrimes([2, 31]))
      nextAction = action
  })
  self.wait(for: [receivedCompletion], timeout: 0)

  effects = favoritePrimesReducer(&amp;state, nextAction, environment)

  XCTAssertEqual(state, [2, 31])
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>ç°åœ¨è¿™ä¸ªæµ‹è¯•ç›®æ ‡æ­£åœ¨æ„å»ºï¼Œæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯<strong>Counter</strong>æ¨¡å—ï¼Œè¯¥æ¨¡å—æœ‰ä¸€ä¸ªç¯å¢ƒï¼Œè¯¥ç¯å¢ƒä¿å­˜äº†æˆ‘ä»¬ä¸ºäº†ä»å‰¯ä½œç”¨ä¸­åŠ è½½ç¬¬nä¸ªç´ æ•°è€Œç‚¹å‡»çš„ç«¯ç‚¹ã€‚</p>
<p>ç°åœ¨è¿™è¿˜ä¸æ˜¯ç¼–è¯‘ï¼Œå› ä¸º<strong>assert helper</strong>éœ€è¦ä¿®å¤ã€‚ ç°åœ¨å®ƒè¿˜æ²¡æœ‰æ„è¯†åˆ°<strong>environment</strong>é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥å¦ä¸€ä¸ªæ³›å‹çš„ç¯å¢ƒï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„<strong>environment</strong>:</p>
<pre><code class="language-swift">func assert&lt;Value: Equatable, Action: Equatable, Environment&gt;(
  initialValue: Value,
  reducer: Reducer&lt;Value, Action, Environment&gt;,
  environment: Environment,
</code></pre>
<p>ç„¶ååœ¨<strong>helper</strong>çš„ä¸»ä½“ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ª<strong>reducer</strong>ï¼Œè¿™æ„å‘³ç€å®ƒéœ€è¦ä¸€ä¸ªç¯å¢ƒæ¥å·¥ä½œã€‚</p>
<pre><code class="language-swift">func assert&lt;Value: Equatable, Action: Equatable, Environment&gt;(
  initialValue: Value,
  reducer: Reducer&lt;Value, Action, Environment&gt;,
  environment: Environment,
  steps: Step&lt;Value, Action&gt;...,
  file: StaticString = #file,
  line: UInt = #line
) {
  â€¦
  effects.append(contentsOf: reducer(&amp;state, action, environment))
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„<strong>counter</strong>æµ‹è¯•å‡ºç°äº†ä¸€äº›é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥ä»æ³¨é‡Šä¹‹å‰ä¸ºæ¨¡æ‹Ÿå…¨å±€ç¯å¢ƒæ‰€åšçš„è®¾ç½®å¼€å§‹ã€‚</p>
<pre><code class="language-swift">class CounterTests: XCTestCase {
//  override func setUp() {
//    super.setUp()
//    Current = .mock
//  }
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›è¡Œå¿«ç…§æµ‹è¯•ï¼Œè¿™å°†è´¯ç©¿æ•´ä¸ªç”¨æˆ·è„šæœ¬å¹¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­è¿›è¡Œå¿«ç…§ï¼Œä»¥ç¡®ä¿UIèƒ½å¤ŸæŒ‰ç…§æˆ‘ä»¬æ‰€æœŸæœ›çš„æ–¹å¼è¿›è¡Œæ”¹å˜ã€‚æˆ‘ä»¬éœ€è¦åœ¨æ„å»º<strong>store</strong>æ—¶æä¾›ä¸€ä¸ªç¯å¢ƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜:</p>
<pre><code class="language-swift">let store = Store(
  initialValue: CounterViewState(),
  reducer: counterViewReducer,
  environment: { _ in .sync { 17 } }
)
</code></pre>
<p>è¯¥æ–‡ä»¶ä¸­çš„å…¶ä»–æµ‹è¯•ä¸æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çœ‹åˆ°çš„å…¶ä»–æµ‹è¯•ç•¥æœ‰ä¸åŒï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬åˆ›å»ºçš„<strong>assert helper</strong>ï¼Œå®ƒä½¿æµ‹è¯•å¤§å‹<strong>reducer</strong>å˜å¾—è¶…çº§å®¹æ˜“ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè¦æµ‹è¯•é€’å¢å’Œé€’å‡é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿™æ ·åš:</p>
<pre><code class="language-swift">func testIncrDecrButtonTapped() {
  assert(
    initialValue: CounterViewState(count: 2),
    reducer: counterViewReducer,
    steps:
    Step(.send, .counter(.incrTapped)) { $0.count = 3 },
    Step(.send, .counter(.incrTapped)) { $0.count = 4 },
    Step(.send, .counter(.decrTapped)) { $0.count = 3 }
  )
}
</code></pre>
<p>æ—¢ç„¶æ–­è¨€åŠ©æ‰‹æ˜¯ç¯å¢ƒæ•æ„Ÿçš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿®å¤<strong>counter</strong>æµ‹è¯•äº†ã€‚ å¯¹äºç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ª<strong>nthPrime</strong>æ•ˆåº”ï¼Œå®ƒç›´æ¥è¿”å›17:</p>
<pre><code class="language-swift">func testIncrDecrButtonTapped() {
  assert(
    initialValue: CounterViewState(count: 2),
    reducer: counterViewReducer,
    environment: { _ in .sync { 17 } },
    steps:
    Step(.send, .counter(.incrTapped)) { $0.count = 3 },
    Step(.send, .counter(.incrTapped)) { $0.count = 4 },
    Step(.send, .counter(.decrTapped)) { $0.count = 3 }
  )
}
</code></pre>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥å¯¹ä¸‹ä¸€ä¸ªåšåŒæ ·çš„æ“ä½œ:</p>
<pre><code class="language-swift">func testNthPrimeButtonHappyFlow() {
  assert(
    â€¦
    environment: { _ in .sync { 17 } },
    â€¦
  )
}
</code></pre>
<p>ä¸‹ä¸€ä¸ªæµ‹è¯•ä¸å‰ä¸€ä¸ªç±»ä¼¼ï¼Œé™¤äº†å®ƒçš„ç¯å¢ƒéœ€è¦ä¸€ä¸ªå¤±è´¥çš„<strong>nthPrime</strong>ç«¯ç‚¹:</p>
<pre><code class="language-swift">func testNthPrimeButtonUnhappyFlow() {
  assert(
    â€¦
    environment: { _ in .sync { nil } },
    â€¦
  )
}
</code></pre>
<p>è¿™ä¸ªæ–‡ä»¶ä¸­çš„æœ€åä¸€ä¸ªæµ‹è¯•ï¼Œå®ƒçš„ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•ä¸º<strong>reducer</strong>ç¼–å†™ä¸€ç§â€œé›†æˆæµ‹è¯•â€ï¼Œåœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬åŒæ—¶åœ¨ä¸€ä¸ªæµ‹è¯•ä¸­ç»ƒä¹ ç»„åˆçš„<strong>reducer</strong>çš„è®¸å¤šéƒ¨åˆ†ã€‚ä¸ºäº†ç¼–è¯‘å®ƒï¼Œæˆ‘ä»¬éœ€è¦ç»™å®ƒä¸€ä¸ªæ¨¡æ‹Ÿç¯å¢ƒ:</p>
<pre><code class="language-swift">func testPrimeModal() {
  assert(
    â€¦
    environment: { _ in .sync { 17 } },
    â€¦
  )
}
</code></pre>
<p>ç°åœ¨è¿™ä¸ªç›®æ ‡æ­£åœ¨ç¼–è¯‘ï¼Œè®©æˆ‘ä»¬è¿è¡Œæµ‹è¯•!</p>
<blockquote>
<p>âŒ failed - Assertion failed to handle 1 pending effect(s)</p>
</blockquote>
<p>å“å‘€ï¼Œè¿™å‡ºä¹æˆ‘çš„æ„æ–™! è¿™åªæ˜¯å‘ç”Ÿäº†ï¼Œå› ä¸ºä¸ä¹…å‰æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª<strong>effect</strong>åˆ°æˆ‘ä»¬çš„<strong>counter reducer</strong>ï¼Œä»¥æ˜¾ç¤ºæ·»åŠ å¤æ‚çš„<strong>effect</strong>æ˜¯å¤šä¹ˆå®¹æ˜“ã€‚Letâ€™s go remove that effect:</p>
<pre><code class="language-swift">case .decrTapped:
  state.count -= 1
  let count = state.count
  return [
//    .fireAndForget {
//      print(count)
//    },
//
//    Just(.incrTapped)
//      .delay(for: 1, scheduler: DispatchQueue.main)
//      .eraseToEffect()
  ]
</code></pre>
<p>å¯ç»„åˆæ¶æ„èƒ½å¤Ÿè‡ªåŠ¨åœ°ä¸ºæˆ‘ä»¬æ•æ‰è¿™ç§å›å½’ï¼Œè¿™æ˜¯éå¸¸ä»¤äººæƒŠå¥‡çš„!</p>
<p>ç°åœ¨æµ‹è¯•é€šè¿‡äº†!</p>
<hr>
<h2 id="5-a-nameconclutionaconclution">5. <a name='Conclution'></a>Conclution</h2>
<p>æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆå®Œæˆäº†åº”ç”¨ç¨‹åºçš„æ„å»ºå’Œæ‰€æœ‰æµ‹è¯•â€¦</p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬çœŸçš„è§£å†³äº†æˆ‘ä»¬æ‰€è¯´çš„ç¯å¢ƒæŠ€æœ¯æ‰€å¸¦æ¥çš„é—®é¢˜äº†å—? åœ¨ä¸€å¤©ç»“æŸçš„æ—¶å€™ï¼Œè¿™çœŸçš„ä¼šå¸®åŠ©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå—?</p>
<p>ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„! è¿™ç§ç¯å¢ƒæŠ€æœ¯çš„æ”¹è¿›è§£å†³äº†æˆ‘ä»¬åœ¨æœ¬ç³»åˆ—èŠ‚ç›®å¼€å§‹æ—¶æè¿°çš„æ‰€æœ‰é—®é¢˜:</p>
<ul>
<li>
<p>æˆ‘ä»¬é‡åˆ°äº†å¤šä¸ªç¯å¢ƒçš„é—®é¢˜:å¦‚æœæ¯ä¸ªç‰¹æ€§æ¨¡å—éƒ½æœ‰è‡ªå·±çš„ç¯å¢ƒï¼Œé‚£ä¹ˆå°±å¾ˆéš¾çŸ¥é“å¦‚ä½•åŒæ—¶æ§åˆ¶æ‰€æœ‰çš„ç‰¹æ€§æ¨¡å—ï¼Œå¹¶ä¸”ä¼šå¤±å»ä¸€äº›é™æ€ä¿è¯ã€‚</p>
</li>
<li>
<p>è¿˜æœ‰æœ¬åœ°ä¾èµ–çš„æ¦‚å¿µã€‚ç”±äºæ¯ä¸ªæ¨¡å—åªæœ‰ä¸€ä¸ªç¯å¢ƒï¼Œå› æ­¤ä¸å¯èƒ½åœ¨ä¸åŒçš„ç¯å¢ƒä¸­é‡ç”¨ä¸€ä¸ªå±å¹•ã€‚</p>
</li>
<li>
<p>ç„¶åè¿˜æœ‰å…±äº«ä¾èµ–å…³ç³»çš„é—®é¢˜ã€‚æˆ‘ä»¬çš„æ¯ä¸ªç‰¹æ€§éƒ½å¯èƒ½å…·æœ‰å…·æœ‰å…±åŒä¾èµ–å…³ç³»çš„ç¯å¢ƒï¼Œè€Œæ¨¡å—çš„â€œå…¨å±€â€ç¯å¢ƒä½¿å…±äº«è¿™äº›å…±åŒä¾èµ–å…³ç³»å˜å¾—å›°éš¾ã€‚</p>
</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥èƒ½å¤Ÿå¯¹ç¯å¢ƒæŠ€æœ¯è¿›è¡Œè°ƒæ•´ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº†å¯ç»„åˆæ¶æ„(Composable Architecture)ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†æ„å»ºç‰¹æ€§å’Œè§£å†³è¿™äº›é—®é¢˜çš„å•ä¸€ã€ä¸€è‡´çš„æ–¹å¼ã€‚</p>
<p>ä¸ºäº†è¯æ˜è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€éæ¯ä¸ªé—®é¢˜ï¼Œå¹¶å‡†ç¡®åœ°æ¼”ç¤ºå®ƒæ˜¯å¦‚ä½•è§£å†³çš„â€¦â€¦</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-91-dependency-injection-made-composable/">
                  <h3 class="post-title">
                    PointFree Episode 91: Dependency Injection Made Composable
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
