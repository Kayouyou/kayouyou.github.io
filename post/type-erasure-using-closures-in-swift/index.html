<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Type erasure using closures in Swift | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1652020609222">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="Swiftæ¯”è®¸å¤šå…¶ä»–è¯­è¨€æ›´å®‰å…¨ã€æ›´ä¸å®¹æ˜“å‡ºé”™çš„åŸå› ä¹‹ä¸€æ˜¯å®ƒçš„é«˜çº§ç±»å‹ç³»ç»Ÿ(ä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼Œæ˜¯ä¸å¯é¥¶æ•çš„)ã€‚å®ƒæ˜¯ä¸€ç§è¯­è¨€ç‰¹æ€§ï¼Œæœ‰æ—¶ä¼šè®©äººå°è±¡æ·±åˆ»ï¼Œå¹¶ä½¿æ‚¨çš„å·¥ä½œæ•ˆç‡å¤§å¤§æé«˜ï¼Œä½†æœ‰æ—¶åˆä¼šè®©äººæ„Ÿåˆ°éå¸¸æ²®ä¸§ã€‚
ä»Šå¤©ï¼Œæˆ‘æƒ³å¼ºè°ƒåœ¨Swiftä¸­å¤„ç†æ³›å‹æ—¶å¯..." />
    <meta name="keywords" content="type erasure,closures,generics" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1652020609222" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Type erasure using closures in Swift</h2>
            <div class="post-date">2017-02-24</div>
            
            <div class="post-content" v-pre>
              <p>Swiftæ¯”è®¸å¤šå…¶ä»–è¯­è¨€æ›´å®‰å…¨ã€æ›´ä¸å®¹æ˜“å‡ºé”™çš„åŸå› ä¹‹ä¸€æ˜¯å®ƒçš„é«˜çº§ç±»å‹ç³»ç»Ÿ(ä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼Œæ˜¯ä¸å¯é¥¶æ•çš„)ã€‚å®ƒæ˜¯ä¸€ç§è¯­è¨€ç‰¹æ€§ï¼Œæœ‰æ—¶ä¼šè®©äººå°è±¡æ·±åˆ»ï¼Œå¹¶ä½¿æ‚¨çš„å·¥ä½œæ•ˆç‡å¤§å¤§æé«˜ï¼Œä½†æœ‰æ—¶åˆä¼šè®©äººæ„Ÿåˆ°éå¸¸æ²®ä¸§ã€‚</p>
<p>ä»Šå¤©ï¼Œæˆ‘æƒ³å¼ºè°ƒåœ¨Swiftä¸­å¤„ç†æ³›å‹æ—¶å¯èƒ½å‡ºç°çš„ä¸€ç§æƒ…å†µï¼Œä»¥åŠæˆ‘é€šå¸¸å¦‚ä½•ä½¿ç”¨åŸºäºé—­åŒ…çš„ç±»å‹æ“¦é™¤æŠ€æœ¯æ¥è§£å†³å®ƒã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æƒ³è¦ç¼–å†™ä¸€ä¸ªç±»ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½æ¨¡å‹ã€‚å› ä¸ºæˆ‘ä»¬ä¸æƒ³åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä¸ºæ¯ä¸ªæ¨¡å‹å¤åˆ¶è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©è®©å®ƒæˆä¸ºä¸€ä¸ªé€šç”¨ç±»ï¼Œåƒè¿™æ ·:</p>
<pre><code class="language-swift">class ModelLoader&lt;T: Unboxable &amp; Requestable&gt; {
    func load(completionHandler: (Result&lt;T&gt;) -&gt; Void) {
        networkService.loadData(from: T.requestURL) { data in
            do {
                try completionHandler(.success(unbox(data: data)))
            } catch {
                let error = ModelLoadingError.unboxingFailed(error)
                completionHandler(.error(error))
            }
        }
    }
}
</code></pre>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªModelLoaderï¼Œå®ƒèƒ½å¤ŸåŠ è½½ä»»ä½•æ¨¡å‹ï¼Œåªè¦å®ƒæ˜¯Unboxableï¼Œå¹¶ä¸”èƒ½å¤Ÿç»™æˆ‘ä»¬ä¸€ä¸ªrequestURLã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³è®©ä½¿ç”¨è¿™ä¸ªæ¨¡å‹åŠ è½½å™¨çš„ä»£ç æ˜“äºæµ‹è¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒçš„APIæå–åˆ°åè®®ä¸­:</p>
<pre><code class="language-swift">protocol ModelLoading {
    associatedtype Model

    func load(completionHandler: (Result&lt;Model&gt;) -&gt; Void)
}
</code></pre>
<p>è¿™ä¸€ç‚¹ï¼Œå†åŠ ä¸Šä¾èµ–æ³¨å…¥ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨æµ‹è¯•ä¸­è½»æ¾åœ°æ¨¡æ‹Ÿæˆ‘ä»¬çš„æ¨¡å‹åŠ è½½APIã€‚ ä½†å®ƒæœ‰ä¸€ç‚¹å¤æ‚ï¼Œåœ¨é‚£æ— è®ºä»€ä¹ˆæ—¶å€™æˆ‘ä»¬æƒ³è¦ä½¿ç”¨è¿™ä¸ªAPIï¼Œæˆ‘ä»¬ç°åœ¨å¿…é¡»å°†å…¶ç§°ä¸ºåè®®ModelLoadingï¼Œå®ƒå…·æœ‰å…³è”çš„ç±»å‹éœ€æ±‚ã€‚è¿™æ„å‘³ç€ä»…ä»…å¼•ç”¨ModelLoadingæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰æ›´å¤šçš„ä¿¡æ¯ï¼Œç¼–è¯‘å™¨å°±ä¸èƒ½æ¨æ–­å‡ºå®ƒçš„å…³è”ç±»å‹ã€‚æ‰€ä»¥è¯•ç€è¿™æ ·åš:</p>
<pre><code class="language-swift">class ViewController: UIViewController {
    init(modelLoader: ModelLoading) {
        ...
    }
}
</code></pre>
<p>will give us this error:</p>
<pre><code class="language-swift">Protocol 'ModelLoading' can only be used as a generic constraint because it as Self or associated type requirements
</code></pre>
<p>ä½†æ˜¯ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„çº¦æŸæ¥è½»æ¾åœ°æ¶ˆé™¤è¿™ä¸ªé”™è¯¯ï¼Œå¼ºåˆ¶ç¬¦åˆModelLoadingçš„å…·ä½“ç±»å‹å°†ç”±APIç”¨æˆ·æŒ‡å®šï¼Œå¹¶ä¸”å®ƒå°†åŠ è½½æˆ‘ä»¬æœŸæœ›çš„æ¨¡å‹ç±»å‹ã€‚æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-swift">class ViewController: UIViewController {
    init&lt;T: ModelLoading&gt;(modelLoader: T) where T.Model == MyModel {
        ...
    }
}
</code></pre>
<p>è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†å› ä¸ºæˆ‘ä»¬è¿˜å¸Œæœ›åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­æœ‰ä¸€ä¸ªæ¨¡å‹åŠ è½½å™¨çš„å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦èƒ½å¤ŸæŒ‡å®šè¯¥å±æ€§çš„ç±»å‹ã€‚ Tåªåœ¨åˆå§‹åŒ–å™¨çš„ä¸Šä¸‹æ–‡ä¸­æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç”¨ç±»å‹Tå®šä¹‰å±æ€§ï¼Œé™¤éæˆ‘ä»¬è®©è§†å›¾æ§åˆ¶å™¨ç±»æœ¬èº«æˆä¸ºæ³›å‹ -è¿™å°†å¾ˆå¿«ä½¿æˆ‘ä»¬é™·å…¥åˆ°å¤„éƒ½æ˜¯æ³›å‹ç±»çš„å…”å­æ´ä¸­ã€‚</p>
<p>ç›¸åï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ç±»å‹æ“¦é™¤ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä¿å­˜å¯¹Tçš„æŸç§å¼•ç”¨ï¼Œè€Œä¸å®é™…ä½¿ç”¨å®ƒçš„ç±»å‹ã€‚ è¿™å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªç±»å‹æ“¦é™¤çš„ç±»å‹æ¥å®ç°ï¼Œä¾‹å¦‚ä¸€ä¸ªåŒ…è£…ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">class AnyModelLoader&lt;T&gt;: ModelLoading {
    typealias CompletionHandler = (Result&lt;T&gt;) -&gt; Void

    private let loadingClosure: (CompletionHandler) -&gt; Void

    init&lt;L: ModelLoading&gt;(loader: L) where L.Model == T {
        loadingClosure = loader.load
    }

    func load(completionHandler: CompletionHandler) {
        loadingClosure(completionHandler)
    }
}
</code></pre>
<p>ä»¥ä¸Šæ˜¯ä¸€ç§ç±»å‹æ“¦é™¤æŠ€æœ¯ï¼Œå®ƒåœ¨Swiftæ ‡å‡†åº“ä¸­ä¹Ÿéå¸¸å¸¸ç”¨ï¼Œä¾‹å¦‚åœ¨AnySequenceç±»å‹ä¸­ã€‚åŸºæœ¬ä¸Šï¼Œæ‚¨å¯ä»¥å°†å…·æœ‰å…³è”å€¼éœ€æ±‚çš„åè®®åŒ…è£…åˆ°æ³›å‹ç±»å‹ä¸­ï¼Œç„¶åæ‚¨å°±å¯ä»¥ä½¿ç”¨è¯¥æ³›å‹ï¼Œè€Œä¸å¿…ä¸€ç›´ä½¿ä½¿ç”¨å®ƒçš„æ‰€æœ‰å†…å®¹ä¹Ÿéƒ½æ˜¯æ³›å‹çš„ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´æ–°æˆ‘ä»¬çš„è§†å›¾æ§åˆ¶å™¨ï¼Œä½¿ç”¨AnyModelLoader:</p>
<pre><code class="language-swift">class ViewController: UIViewController {
    private let modelLoader: AnyModelLoader&lt;MyModel&gt;

    init&lt;T: ModelLoading&gt;(modelLoader: T) where T.Model == MyModel {
        self.modelLoader = AnyModelLoader(loader: modelLoader)
        super.init(nibName: nil, bundle: nil)
    }
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªé¢å‘åè®®çš„APIï¼Œå…·æœ‰ç®€å•çš„å¯æ¨¡æ‹Ÿæ€§ï¼Œå®ƒä»ç„¶å¯ä»¥åœ¨éæ³›å‹ç±»ä¸­ä½¿ç”¨ï¼Œè¿™è¦æ„Ÿè°¢ç±»å‹æ“¦é™¤ğŸ‰</p>
<p>ç°åœ¨æ˜¯å¥–é‡‘ç¯èŠ‚ã€‚ä¸Šé¢çš„æŠ€æœ¯å·¥ä½œå¾—éå¸¸å¥½ï¼Œä½†æ˜¯å®ƒç¡®å®æ¶‰åŠäº†ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤ï¼Œç»™æˆ‘ä»¬çš„ä»£ç å¢åŠ äº†ä¸€äº›å¤æ‚æ€§ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­åšåŸºäºé—­åŒ…çš„ç±»å‹æ“¦é™¤ -ä¸å¿…å¼•å…¥AnyModelLoaderç±»ã€‚ç„¶åï¼Œæˆ‘ä»¬çš„è§†å›¾æ§åˆ¶å™¨å°±ä¼šå˜æˆè¿™æ ·:</p>
<pre><code class="language-swift">class ViewController: UIViewController {
    private let loadModel: ((Result&lt;MyModel&gt;) -&gt; Void) -&gt; Void

    init&lt;T: ModelLoading&gt;(modelLoader: T) where T.Model == MyModel {
        loadModel = modelLoader.load
        super.init(nibName: nil, bundle: nil)
    }
}
</code></pre>
<p>ä¸æˆ‘ä»¬çš„ç±»å‹åˆ é™¤ç±»AnyModelLoaderä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å°†loadå‡½æ•°çš„å®ç°ä½œä¸ºä¸€ä¸ªé—­åŒ…å¼•ç”¨ï¼Œç„¶ååœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ä¿å­˜å¯¹å®ƒçš„å¼•ç”¨ã€‚ç°åœ¨ï¼Œå½“æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ªæ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨loadModelï¼Œå°±åƒæˆ‘ä»¬å¯¹å…¶ä»–ä»»ä½•å‡½æ•°æˆ–é—­åŒ…ä¸€æ ·:</p>
<pre><code class="language-swift">override func viewWillAppear(_ animated: Bool) {
    super.viewWillAppear(animated)

    loadModel { result in
        switch result {
        case .success(let model):
            render(model)
        case .error(let error):
            render(error)
        }
    }
}
</code></pre>
<p>å°±æ˜¯è¿™æ ·!å¸Œæœ›æ‚¨åœ¨å¤„ç†Swiftä»£ç ä¸­çš„æ³›å‹å’Œåè®®æ—¶ï¼Œä¼šå‘ç°ä¸Šè¿°æŠ€æœ¯æœ‰ç”¨</p>
<p><a href="https://www.swiftbysundell.com/articles/type-erasure-using-closures-in-swift/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/3mcbew_6V/" class="tag">
                    type erasure
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/WHIN6Hnog/" class="tag">
                    closures
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/rXydJalIp/" class="tag">
                    generics
                  </a>
                
              </div>
            
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
