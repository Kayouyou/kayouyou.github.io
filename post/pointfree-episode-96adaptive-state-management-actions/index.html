<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 96:Adaptive State Management: Actions | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1652020609222">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Action adaptation




View store action sending




View actions




Tests and the view store




conclution






1..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1652020609222" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 96:Adaptive State Management: Actions</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Actionadaptation">Action adaptation</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Viewstoreactionsending">View store action sending</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Viewactions">View actions</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Testsandtheviewstore">Tests and the view store</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#conclution">conclution</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 96:Adaptive State Management: Actions -->
<h2 id="1-a-nameactionadaptationaaction-adaptation">1. <a name='Actionadaptation'></a>Action adaptation</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨è§†å›¾ä¸­æœ‰è¿™ä¸ªéå¸¸æ£’çš„å±æ€§åœ¨UIç»„ä»¶çš„æ¯ä¸ªåŠ¨ä½œé—­åŒ…ä¸­æˆ‘ä»¬ä¸åšä»»ä½•é€»è¾‘ï¼Œæˆ‘ä»¬åªå‘<strong>store</strong>å‘é€ä¸€ä¸ªåŠ¨ä½œã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬å¤©çœŸåœ°æ„å»ºä¸€ä¸ªæ™®é€šçš„SwiftUIè§†å›¾ï¼Œæˆ‘ä»¬ä¼šæŠŠå„ç§æ··ä¹±çš„é€»è¾‘å’ŒçŠ¶æ€çªå˜æ”¾åœ¨è¿™äº›é—­åŒ…ä¸­ï¼Œå®ƒä¼šæ©ç›–è¿™ä¸ªè§†å›¾è´Ÿè´£çš„æ‰€æœ‰äº‹æƒ…ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å‘é€åˆ°<strong>store</strong>çš„æ“ä½œå‡†ç¡®åœ°æè¿°äº†å¯¼è‡´è¿™äº›æ“ä½œå‘é€çš„åŸå› ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸ä¼šç”¨æˆ‘ä»¬æƒ³è¦æ”¹å˜åº”ç”¨çš„æ–¹å¼æ¥æè¿°å®ƒä»¬ï¼Œ,åƒâ€œ<strong>increment countâ€, â€œrequest nth primeâ€, â€œdismiss alertâ€</strong>,è€Œæ˜¯æˆ‘ä»¬åªæè¿°ç”¨æˆ·æ‰€åšçš„,â€œ<strong>increment button tappedâ€, â€œnth prime button tappedâ€ and â€œprime modal dismissed</strong>â€ç„¶åè®©<strong>reducer</strong>è§£é‡Šè¿™äº›è¡Œä¸º:</p>
<pre><code class="language-swift">self.store.send(.counter(.decrTapped))
self.store.send(.counter(.incrTapped))
self.store.send(.counter(.isPrimeButtonTapped))
self.store.send(.counter(.nthPrimeButtonTapped))
self.store.send(.counter(.primeModalDismissed))
self.store.send(.counter(.alertDismissButtonTapped))
</code></pre>
<p>è¿™ä½¿å¾—æˆ‘ä»¬çš„è§†å›¾éå¸¸ç®€å•ï¼Œå½“æˆ‘ä»¬è¯•å›¾ç†è§£è¿™äº›ä¸åŒUIç»„ä»¶æ“ä½œçš„ç›®çš„æ—¶ï¼Œæ²¡æœ‰ç•™ä¸‹å¤ªå¤šè§£é‡Šçš„ç©ºé—´ã€‚6ä¸ªæœˆåï¼Œè¿™äº›UIå…ƒç´ çš„æ“ä½œå¯èƒ½ä¼šåšæ›´å¤šçš„äº‹æƒ…ï¼Œæ¯”å¦‚è·Ÿè¸ªåˆ†æã€å¯åŠ¨è®¡æ—¶å™¨ç­‰ç­‰ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œæè¿°ç”¨æˆ·åœ¨åŠ¨ä½œåç§°ä¸­åšäº†ä»€ä¹ˆè¦æ¯”æè¿°è¦åšä»€ä¹ˆæ”¹å˜æˆ–è¦æ‰§è¡Œä»€ä¹ˆæ•ˆæœè¦å¥½å¾—å¤šã€‚</p>
<p>ç„¶è€Œï¼Œ<strong>CounterAction</strong>æšä¸¾ç¡®å®åŒ…å«äº†ä¸€äº›ä¸æ˜¯ç›´æ¥çš„UIæ“ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªä»<strong>effect</strong>åé¦ˆåˆ°ç³»ç»Ÿçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬æ”¶åˆ°<strong>Wolfram Alpha API</strong>çš„å“åº”æ—¶:</p>
<pre><code class="language-swift">case nthPrimeResponse(n: Int, prime: Int?)
</code></pre>
<p>è¿™è®©æˆ‘ä»¬å¯ä»¥åšä¸€äº›åœ¨æˆ‘ä»¬çœ‹æ¥è’è°¬çš„äº‹æƒ…ï¼Œæ¯”å¦‚:</p>
<pre><code class="language-swift">Button(&quot;What is the \(ordinal(self.viewStore.value.count)) prime?&quot;) {
  self.store.send(.counter(.nthPrimeResponse(n: 7, prime: 17)))
//  self.store.send(.counter(.nthPrimeButtonTapped))
}
</code></pre>
<p>æˆ‘ä»¬æ°¸è¿œä¸å¸Œæœ›åœ¨è§†å›¾ä¸­å‘é€è¿™ä¸ªæ“ä½œï¼Œå› ä¸ºå®ƒåº”è¯¥åªæ¥è‡ªäºæ‰§è¡Œäº†ä¸€ä¸ª<strong>effect</strong>ï¼Œç‰¹åˆ«æ˜¯<strong>Wolfram Alpha API</strong>è¯·æ±‚ã€‚</p>
<p>æ­¤å¤–ï¼Œå¦‚æœæœ‰ä¸€å †ç”¨æˆ·æ“ä½œéƒ½åœ¨åšç›¸åŒçš„äº‹æƒ…ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢? ä¾‹å¦‚ï¼Œå¯èƒ½æœ‰å¤šç§æ–¹æ³•æ¥è¯·æ±‚â€œ<strong>nth prime</strong>â€ã€‚æˆ‘ä»¬å¬è¯´æ‰‹åŠ¿å¾ˆæµè¡Œï¼Œæ‰€ä»¥å¦‚æœä½ åŒå‡»è¿™ä¸ªå±å¹•ï¼Œå®ƒå¯èƒ½ä¼šè°ƒç”¨â€œ<strong>nth prime</strong>â€è¯·æ±‚ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨<strong>CounterAction</strong>æšä¸¾ä¸­æ·»åŠ å¦ä¸€ä¸ªåŠ¨ä½œï¼Œç„¶åéœ€è¦åœ¨<strong>reducer</strong>ä¸­å¤„ç†è¯¥åŠ¨ä½œï¼Œå³ä½¿å®ƒå°†æ‰§è¡Œä¸å…¶ä»–åŠ¨ä½œå®Œå…¨ç›¸åŒçš„æ“ä½œ:</p>
<pre><code class="language-swift">public enum CounterAction: Equatable {
  â€¦
  case doubleTap
</code></pre>
<p>æˆ‘ä»¬éœ€è¦åœ¨<strong>reducer</strong>ä¸­å¤„ç†è¿™ä¸ªåŠ¨ä½œï¼Œè¿™å¯èƒ½åªæ˜¯ç®€å•åœ°é‡å¤å½“å‰<strong>nthprimebuttaapped</strong>æ‰€åšçš„:</p>
<pre><code class="language-swift">case .doubleTap:
  state.isNthPrimeRequestInFlight = true
  return [
    Current.nthPrime(state.count)
      .map(CounterAction.nthPrimeResponse)
      .receive(on: DispatchQueue.main)
      .eraseToEffect()
  ]
</code></pre>
<p>æˆ‘ä»¬å½“ç„¶ä¸æƒ³å¦‚æ­¤å…¬ç„¶åœ°é‡æ–°åˆ›å»ºè¿™ä¸ªå·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå·¥ä½œæå–åˆ°ä¸€ä¸ªå°çš„è¿·ä½ <strong>reducer</strong>ï¼Œæ¯ä¸ªåŠ¨ä½œè°ƒç”¨ï¼Œæˆ–è€…æˆ‘ä»¬ç”šè‡³å¯ä»¥åŒæ—¶å¤„ç†ä¸¤ä¸ªåŠ¨ä½œ:</p>
<pre><code class="language-swift">case .nthPrimeButtonTapped, .doubleTap:
</code></pre>
<p>åä¸€ç§æŠ€æœ¯å¯èƒ½æ˜¯æœ€ç›´æ¥çš„ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨è¿™äº›æ“ä½œä¸­ç»‘å®šä¸€äº›æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®ä¸å®Œå…¨åŒ¹é…ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå¤±æ•ˆã€‚æ¯”å¦‚å…¶ä¸­ä¸€ä¸ªæ“ä½œæŒæœ‰ä¸€ä¸ªæ•´æ•°ï¼Œå¦ä¸€ä¸ªæŒæœ‰ä¸€ä¸ªå¸ƒå°”å€¼ã€‚è¿™æ ·æˆ‘ä»¬å°±æ— æ³•åŒæ—¶å¤„ç†è¿™ä¸¤ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å°†å®ƒä»¬åˆ†å¼€ã€‚</p>
<p>ä¸ºäº†åœ¨è§†å›¾ä¸­è¿æ¥è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ ¹è§†å›¾ä¸­æ·»åŠ ä¸€ä¸ªåŒå‡»æ‰‹åŠ¿è¯†åˆ«å™¨ï¼Œç„¶ååœ¨è°ƒç”¨æ—¶å°†è¿™ä¸ªæ–°åŠ¨ä½œå‘é€åˆ°store:</p>
<pre><code class="language-swift">.onTapGesture(count: 2) {
  self.store.send(.counter(.doubleTap))
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å®ƒå¹¶ä¸åƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·æ­£ç¡®ã€‚å¦‚æœæˆ‘ä»¬åŒå‡»å±å¹•ç™½è‰²åŒºåŸŸçš„ä»»ä½•åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸ä¼šåƒé¢„æœŸçš„é‚£æ ·è§¦å‘<strong>onTapGesture</strong>åŠ¨ä½œã€‚è¿™æ˜¯å› ä¸ºæ‰‹åŠ¿åªåœ¨æ ¹VStackå†…çš„å•ä¸ªè§†å›¾ä¸Šå·¥ä½œï¼Œæ‰€ä»¥è§¦å‘å®ƒçš„å”¯ä¸€æ–¹æ³•æ˜¯åŒå‡»æ˜¾ç¤ºè®¡æ•°çš„å°æ–‡æœ¬ã€‚</p>
<p>ä¸€ä¸ªå¿«é€Ÿçš„ä¿®å¤æ–¹æ³•æ˜¯å°†VStackåŒ…è£…åœ¨ä¸€ä¸ªè§†å›¾ä¸­ï¼Œå¡«å……æ•´ä¸ªå±å¹•:</p>
<pre><code class="language-swift">.frame(minWidth: 0, maxWidth: .infinity, minHeight: 0, maxHeight: .infinity)
</code></pre>
<p>ç„¶è€Œï¼Œåœ¨æ²¡æœ‰å¯¹æ–°çš„åŒ…è£…å™¨è§†å›¾åšä»»ä½•äº‹æƒ…çš„æƒ…å†µä¸‹ï¼ŒSwiftUIå°†ä¼˜åŒ–å®ƒï¼Œç”šè‡³ä¸åˆ›å»ºä¸€ä¸ªå®é™…çš„UIViewï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å¯¹å®ƒåšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚ç»™å®ƒä¸€ä¸ªèƒŒæ™¯é¢œè‰²:</p>
<pre><code class="language-swift">.background(Color.white)
</code></pre>
<p>è¿™ä¹Ÿè®¸ä¸æ˜¯æœ€å¥½çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬ç°åœ¨å¹¶ä¸æ˜¯åœ¨æ•™æˆä½¿ç”¨SwiftUIçš„æœ€ä½³æ–¹æ³•ï¼Œæˆ‘ä»¬åªæ˜¯éœ€è¦è§£å†³ç›®å‰çš„é—®é¢˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å†æ¬¡è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šçœ‹åˆ°ï¼Œå½“ä½ åŒå‡»å±å¹•ç™½è‰²åŒºåŸŸçš„ä»»ä½•åœ°æ–¹æ—¶ï¼Œæˆ‘ä»¬ç¡®å®è°ƒç”¨äº†â€œ<strong>nth prime</strong>â€effectæ¥å¾—åˆ°ç»“æœã€‚</p>
<p>æˆ‘ä»¬å¼€å§‹çœ‹åˆ°ä¸€äº›ä¸æˆ‘ä»¬çœ‹åˆ°çš„çŠ¶æ€ç±»ä¼¼çš„æ¼äººä¹‹å¤„ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªè§†å›¾ä¸­å­˜åœ¨è§†å›¾å¹¶ä¸çœŸæ­£å…³å¿ƒçš„å¯ç”¨æ“ä½œï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬åœ¨çŠ¶æ€ä¸­çœ‹åˆ°çš„ã€‚å¯¹äºçŠ¶æ€ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨è¿‡åº¦è®¡ç®—è§†å›¾ï¼Œä½†å¯¹äºæ“ä½œï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åšä¸€äº›ä¸å¥½çš„äº‹æƒ…ï¼Œæ¯”å¦‚å‘é€ä¸åº”è¯¥ä»è§†å›¾å‘é€çš„æ“ä½œã€‚ç„¶åï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬ç»å¸¸éœ€è¦ä¸ºæˆ‘ä»¬çš„è§†å›¾æä¾›è¶…é¢†åŸŸç‰¹å®šçš„æ“ä½œï¼Œè€Œå°†æ‰€æœ‰è¿™äº›æ“ä½œæ·»åŠ åˆ°åŸŸå°†æ˜¯ä¸€ä»¶ç—›è‹¦çš„äº‹æƒ…ã€‚å¯¹äºçŠ¶æ€ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›æ·»åŠ å¯¹ç¦ç”¨UIæ›´å¤šéƒ¨åˆ†çš„æ”¯æŒï¼Œä½†è¿™éœ€è¦å‘ç»“æ„ä½“æ·»åŠ æ›´å¤šçš„çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬åœ¨<strong>store</strong>ä¸­ä½¿ç”¨çŠ¶æ€å’Œåœ¨<strong>store</strong>ä¸­å‘é€åŠ¨ä½œæ—¶çœ‹åˆ°çš„é—®é¢˜ä¹‹é—´æœ‰ä¸€ç§äºŒå…ƒæ€§ã€‚</p>
<hr>
<h2 id="2-a-nameviewstoreactionsendingaview-store-action-sending">2. <a name='Viewstoreactionsending'></a>View store action sending</h2>
<p>å› æ­¤ï¼Œä¹Ÿè®¸æˆ‘ä»¬åº”è¯¥é€šè¿‡åˆ é™¤å‘<strong>store</strong>å‘é€æ“ä½œçš„æ¦‚å¿µæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè€Œåªä½¿ç”¨ <strong>view store</strong>æ¥å‘é€æ“ä½œï¼Œå› ä¸ºè¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„åœ°æ–¹æ¥æ‰§è¡Œç‰¹å®šäºè§†å›¾çš„è½¬æ¢ã€‚<strong>store</strong>ä»ç„¶ä¼šè´Ÿè´£å¤„ç†éœ€è¦å®Œæˆçš„å·¥ä½œï¼Œå¦‚è¿è¡Œ<strong>reducer</strong>å’Œè¿è¡Œ<strong>reducer</strong>çš„effectsï¼Œä½†æˆ‘ä»¬ä¸ä¼šç›´æ¥å°†åŠ¨ä½œå‘é€åˆ°<strong>store</strong>ã€‚</p>
<p>è®©æˆ‘ä»¬å…ˆæŠŠ<strong>Store</strong>ä¸Šçš„<strong>send</strong>æ–¹æ³•è®¾ä¸ºç§æœ‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸èƒ½ç›´æ¥ç»™å®ƒå‘é€åŠ¨ä½œäº†ã€‚</p>
<pre><code class="language-swift">private func send(_ action: Action) {
</code></pre>
<p>ç„¶åæˆ‘ä»¬æƒ³ç»™<strong>ViewStore</strong>æ·»åŠ ä¸€ä¸ª<strong>send</strong>æ–¹æ³•ï¼Œè¿™æ„å‘³ç€<strong>ViewStore</strong>ä¹Ÿéœ€è¦ä¸€ä¸ªæ–°çš„æ³›å‹:</p>
<pre><code class="language-swift">public final class ViewStore&lt;Value, Action&gt;: ObservableObject {
  â€¦

  public func send(_ action: Action) {
    ???
  }
}
</code></pre>
<p>å½“è¿™ä¸ª<strong>send</strong>æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒå®é™…ä¸Šåº”è¯¥åªæ˜¯è°ƒç”¨è¿™ä¸ª<strong>view store</strong>çš„æ´¾ç”Ÿåº“ã€‚è¿™æ˜¯å› ä¸º<strong>store</strong>æ˜¯è´Ÿè´£å¤„ç†æ“ä½œçš„å®é™…è¿è¡Œæ—¶ã€‚<strong>view store</strong> sendåªæ˜¯æˆ‘ä»¬æ”¾åœ¨<strong>store</strong>å’Œ<strong>store</strong>ç”¨æˆ·ä¹‹é—´çš„ä¸€ä¸ªå±‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„åŠ¨ä½œçš„å½¢çŠ¶ã€‚</p>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬ä¸æƒ³åœ¨<strong>ViewStore</strong>ä¸­æœ‰ä¸€ä¸ª<strong>send</strong>æ–¹æ³•ï¼Œè€Œæ˜¯æƒ³è¦ä¸€ä¸ªåŒ…å«<strong>send</strong>å‡½æ•°çš„å±æ€§ï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨åˆ›å»º<strong>view store</strong>æ—¶ä»å¤–éƒ¨è‡ªå®šä¹‰:</p>
<pre><code class="language-swift">public final class ViewStore&lt;Value, Action&gt;: ObservableObject {
  @Published public fileprivate(set) var value: Value
  fileprivate var cancellable: Cancellable?
  public let send: (Action) -&gt; Void

  init(
    initialValue: Value,
    send: @escaping (Action) -&gt; Void
  ) {
    self.value = initialValue
    self.send = send
  }
}
</code></pre>
<p>è¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„è§†å›¾å‡½æ•°çš„ç¼–è¯‘å™¨é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ”¹å˜äº†åˆ›å»º<strong>view store</strong>æ‰€éœ€è¦çš„å†…å®¹ã€‚ä½†è¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è§£å†³ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å•†åº—ä¸­å¼•å…¥ä¸€ä¸ª<strong>Action</strong>é€šç”¨çš„<strong>send</strong>å‡½æ•°:</p>
<pre><code class="language-swift">extension Store {
  public func view(removeDuplicates predicate: (Value, Value) -&gt; Bool) -&gt; ViewStore&lt;Value, Action&gt; {
    let viewStore = ViewStore(
      initialValue: self.value,
      send: self.send
    )
    viewStore.viewCancellable = self.$value
      .removeDuplicates(by: predicate)
      .sink { newValue in
        viewStore.value = newValue
        self
    }
    return vs
  }
}
</code></pre>
<p>ç°åœ¨æ„å»ºäº†å¯ç»„åˆä½“ç³»ç»“æ„ï¼Œä½†åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…ç†ä¸€äº›ä¸œè¥¿ã€‚è¯·è®°ä½ï¼Œå‰é¢æˆ‘ä»¬å°†è¿™ä¸ª<strong>self</strong>æ•è·æ·»åŠ åˆ°<strong>sink</strong>é—­åŒ…ä¸­ï¼Œä»¥ä¾¿<strong>view store</strong>èƒ½å¤Ÿä¿ç•™å®ƒæ‰€æ´¾ç”Ÿçš„<strong>store</strong>ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œè¿™æ ·å¦‚æœæˆ‘ä»¬é¦–å…ˆç¡®å®šä¸€ä¸ª<strong>store</strong>çš„èŒƒå›´ï¼Œç„¶åæŸ¥çœ‹å®ƒï¼Œæˆ‘ä»¬å°±ä¸ä¼šå¤±å»åˆ›å»ºçš„ä¸­é—´<strong>store</strong>ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‘†è„±å®ƒå› ä¸º<strong>view store</strong>ç°åœ¨æ­£ç¡®åœ°æŒæœ‰<strong>store</strong>å› ä¸ºæˆ‘ä»¬ä¼ é€’äº†<strong>self.send</strong>åˆ°åˆå§‹åŒ–å™¨ã€‚</p>
<pre><code class="language-swift">.sink { newValue in
  viewStore.value = newValue
//  self
}
</code></pre>
<p>è¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰æƒå…³ç³»å¾ˆè‡ªç„¶ä¸€æ—¦æˆ‘ä»¬è®©<strong>view store</strong>è´Ÿè´£å‘é€åŠ¨ä½œã€‚ä¸ºäº†å®Œæˆå‰©ä¸‹çš„åº”ç”¨æ„å»ºï¼Œæˆ‘ä»¬å¯ä»¥åšæœ€ç®€å•çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯æš‚æ—¶ä¸æ”¹å˜åŠ¨ä½œã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨<strong>PrimeModal</strong>æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<pre><code class="language-swift">public struct IsPrimeModalView: View {
  â€¦
  @ObservedObject private var viewStore: ViewStore&lt;State, PrimeModalAction&gt;
  â€¦

  public var body: some View {
    â€¦
    self.viewStore.send(.removeFavoritePrimeTapped)
    â€¦
    self.viewStore.send(.saveFavoritePrimeTapped)
    â€¦
  }
}
</code></pre>
<p>ç±»ä¼¼åœ°ï¼Œå¯ä»¥å¯¹<strong>FavoritePrimes</strong>æ¨¡å—åšä¸€äº›å°æ”¹åŠ¨ï¼Œè®©å®ƒç¼–è¯‘:</p>
<pre><code class="language-swift">public struct FavoritePrimesView: View {
  @ObservedObject var viewStore: ViewStore&lt;[Int], FavoritePrimesAction&gt;
  â€¦

  public var body: some View {
    â€¦
    self.viewStore.send(.deleteFavoritePrimes(indexSet))
    â€¦
    self.viewStore.send(.saveButtonTapped)
    â€¦
    self.viewStore.send(.loadButtonTapped)
    â€¦
  }
}
</code></pre>
<p>æœ€åï¼Œ<strong>Counter</strong>æ¨¡å—çš„ç±»ä¼¼æ›´æ”¹å°†å†æ¬¡è·å¾—æ•´ä¸ªåº”ç”¨ç¨‹åºæ„å»º:</p>
<pre><code class="language-swift">public struct CounterView: View {
  @ObservedObject private var viewStore: ViewStore&lt;State, CounterFeatureAction&gt;
  â€¦

  public var body: some View {
    â€¦
    self.viewStore.send(.counter(.decrTapped))
    â€¦
    Button(&quot;+&quot;) { self.viewStore.send(.counter(.incrTapped)) }
    â€¦
    Button(&quot;Is this prime?&quot;) { self.viewStore.send(.counter(.isPrimeButtonTapped)) }
    â€¦
    self.viewStore.send(.counter(.nthPrimeButtonTapped))
    â€¦
    onDismiss: { self.viewStore.send(.counter(.primeModalDismissed)) }
    â€¦
    self.viewStore.send(.counter(.alertDismissButtonTapped))
    â€¦
  }
}
</code></pre>
<hr>
<h2 id="3-a-nameviewactionsaview-actions">3. <a name='Viewactions'></a>View actions</h2>
<p>ç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ­£åœ¨æ„å»ºï¼Œä½†æˆ‘ä»¬å½“ç„¶æ²¡æœ‰åˆ©ç”¨<strong>view store</strong>ä¸­çš„åŠ¨ä½œè½¬æ¢çš„åŠ›é‡ã€‚æˆ‘ä»¬å¸Œæœ›å®ƒä»¬ä¸ä»…èƒ½è®©æˆ‘ä»¬æœ‰æœºä¼šå°†ä¸€äº›ä¸éœ€è¦æ‹…å¿ƒçš„æ“ä½œéšè—èµ·æ¥ï¼Œè¿˜èƒ½è®©æˆ‘ä»¬æ•´åˆè®¸å¤šç±»ä¼¼çš„æ“ä½œï¼ŒåŒæ—¶ä»ç„¶ä¸ºè¿™äº›æ“ä½œä¿ç•™ç‰¹å®šäºåŸŸåçš„åç§°ã€‚</p>
<p>ç‰¹åˆ«åœ°ï¼Œè®©æˆ‘ä»¬å†æ¥çœ‹çœ‹<strong>counter</strong>æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªè§†å›¾ä¸éœ€è¦çŸ¥é“çš„æ“ä½œï¼Œå¹¶ä¸”æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ“ä½œæœ€ç»ˆåœ¨<strong>reducer</strong>ä¸­å¯¼è‡´ç›¸åŒçš„è¡Œä¸ºã€‚ æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–°çš„<strong>view store</strong>é€‚é…å·¥å…·æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œä»<strong>reducer</strong>çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯æœ‰ç‚¹å¥‡æ€ªçš„ï¼Œä¸æ–­å¼•å…¥è¶Šæ¥è¶Šå¤šçš„è¡ŒåŠ¨ï¼Œåœ¨å¼•æ“ç›–ä¸‹åšåŒæ ·çš„äº‹æƒ…ï¼Œç„¶è€Œä»è§†å›¾çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯å®Œç¾çš„æ„ä¹‰ï¼Œå› ä¸ºå®ƒå¸®åŠ©æˆ‘ä»¬çš„è§†å›¾å°½å¯èƒ½ç®€å•ã€‚</p>
<p>è§†å›¾é€»è¾‘å’Œreduceré€»è¾‘ä¹‹é—´çš„å·®å¼‚æ­£æ˜¯<strong>view store</strong>å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³çš„ã€‚æˆ‘ä»¬åº”è¯¥å…è®¸ä¸ºæ“ä½œæƒ³å‡ºå¯¹ä¸šåŠ¡é€»è¾‘é¢†åŸŸæœ€æœ‰æ„ä¹‰çš„åç§°ï¼ŒåŒæ—¶ä¹Ÿå…è®¸ä½¿ç”¨å¯¹è§†å›¾æœ‰æ„ä¹‰çš„æ“ä½œåç§°ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬é‡æ–°å®šä¹‰ç‰¹æ€§çš„æ“ä½œé¢†åŸŸï¼Œä»¥ä¾¿æ›´å¥½åœ°æè¿°ä¸šåŠ¡é€»è¾‘ã€‚ä¸å…¶ä¸º<strong>nthPrimeButtonTappedå’ŒdoubleTap</strong>åˆ›å»ºå•ç‹¬çš„æ“ä½œï¼Œä¸å¦‚åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ“ä½œæ¥è¯·æ±‚â€œç¬¬nä¸ªç´ æ•°â€:</p>
<pre><code class="language-swift">public enum CounterAction: Equatable {
  â€¦
//   case nthPrimeButtonTapped:
//   case doubleTap:
  case requestNthPrime:
</code></pre>
<p>ç„¶åæˆ‘ä»¬éœ€è¦æ›´æ–°<strong>reducer</strong>:</p>
<pre><code class="language-swift">// case .nthPrimeButtonTapped, .doubleTap
case .requestNthPrime:
  state.isNthPrimeButtonDisabled = true
  return [
    Current.nthPrime(state.count)
      .map(CounterAction.nthPrimeResponse)
      .receive(on: DispatchQueue.main)
      .eraseToEffect()
  ]
</code></pre>
<p>ä¸ºäº†ç¼–è¯‘ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è§†å›¾çš„ä»»ä½•åœ°æ–¹å‘é€.<strong>requestnthprime</strong>æ“ä½œ:</p>
<pre><code class="language-swift">self.viewStore.send(.requestNthPrime)
</code></pre>
<p>è¿™å½“ç„¶ä¸ç†æƒ³ï¼Œå› ä¸ºç”¨æˆ·æ‰€åšçš„ä¸æˆ‘ä»¬å‘é€ç»™<strong>store</strong>çš„å†…å®¹ä¹‹é—´å­˜åœ¨è„±èŠ‚ã€‚å¦‚æœè§†å›¾åªå…³å¿ƒå‘Šè¯‰storeç”¨æˆ·åˆ°åº•åšäº†ä»€ä¹ˆï¼Œç„¶åè®©<strong>store</strong>å°†å…¶è§£é‡Šä¸ºè¯·æ±‚â€œç¬¬nä¸ªè´¨æ•°â€ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å˜å¾—æ›´ç®€å•ã€‚</p>
<p>å› æ­¤ï¼Œå°±åƒæˆ‘ä»¬å¯¹çŠ¶æ€æ‰€åšçš„é‚£æ ·ï¼Œè®©æˆ‘ä»¬ä¸ºè¿™ä¸ªè§†å›¾ç¼–å†™ä¸€ä¸ªé¢†åŸŸç‰¹å®šæ“ä½œçš„æšä¸¾ã€‚åœ¨è¿™ä¸ªè§†å›¾ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆ?å®ƒåŸºæœ¬ä¸Šæ˜¯<strong>CounterAction</strong>æšä¸¾ä¸­çš„ä¸€åˆ‡ï¼Œä½†æ·»åŠ äº†ä¸€äº›æ“ä½œï¼Œåˆ é™¤äº†ä¸€äº›æ“ä½œ:</p>
<pre><code class="language-swift">enum Action {
  case decrTapped
  case incrTapped
  case nthPrimeButtonTapped
  case alertDismissButtonTapped
  case isPrimeButtonTapped
  case primeModalDismissed
  case doubleTap
}
</code></pre>
<p>ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬ç°åœ¨å°†<strong>requestNthPrime</strong>åˆ†ç¦»ä¸º<strong>nthprimebuttontappingå’ŒdoubleTap</strong>çš„ä¸¤ä¸ªæ“ä½œï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸å†æœ‰<strong>nthprimerresponse</strong>çš„æ“ä½œï¼Œå› ä¸ºå®ƒä»æœªä»è§†å›¾ä¸­å‘é€ã€‚</p>
<p>ä¸ºäº†ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¸Œæœ›è§†å›¾ä¸­çš„<strong>viewStore</strong>ä¸å†ä¸<strong>CounterActions</strong>ä¸€èµ·å·¥ä½œï¼Œè€Œåªæ˜¯ä½¿ç”¨è¿™ä¸ªå†…éƒ¨çš„<strong>Action</strong>:</p>
<pre><code class="language-swift">@ObservedObject private var viewStore: ViewStore&lt;State, Action&gt;
</code></pre>
<p>è¿™ä¼šäº§ç”Ÿä¸€å †é”™è¯¯:åœ¨æˆ‘ä»¬çš„<strong>viewStore</strong>è½¬æ¢ä¸­ï¼Œä»¥åŠåœ¨bodyå±æ€§ä¸­æˆ‘ä»¬å‘é€<strong>CounterFeatureActions</strong>è€Œä¸æ˜¯è¿™ä¸ªæ–°ç±»å‹çš„åŠ¨ä½œçš„ä¸€äº›åœ°æ–¹ã€‚</p>
<p>åä¸€ä¸ªé”™è¯¯æ˜¯æœ€å®¹æ˜“ä¿®å¤çš„ã€‚æˆ‘ä»¬åªéœ€è¦ä»æ­£åœ¨å‘é€çš„æ“ä½œä¸­åˆ é™¤.<strong>counter</strong>åŒ…è£…å™¨ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å‘é€æˆ‘ä»¬ç‚¹å‡»äº†â€œnä¸ªprimeâ€æŒ‰é’®æˆ–åŒå‡»äº†çš„ç‰¹å®šäºåŸŸçš„æ“ä½œã€‚</p>
<p>ä¸ºäº†ä¿®å¤<strong>viewStore</strong>è½¬æ¢ï¼Œæˆ‘ä»¬åªéœ€è¦æè¿°å¦‚ä½•å°†ä¸€ä¸ªä¼ å…¥çš„å†…éƒ¨æ“ä½œè½¬æ¢ä¸º<strong>reducer</strong>å®é™…ä½¿ç”¨çš„<strong>CounterFeatureAction</strong>ã€‚è¿™ä¸ªè½¬æ¢é€»è¾‘å¯ä»¥åœ¨è§†å›¾è°ƒç”¨ä¸­ç›´æ¥å‘ç”Ÿ:</p>
<pre><code class="language-swift">self.viewStore = self.store
    .view(
    value: primeModalViewState,
    action: {
        switch $0 {
        case .decrTapped:
        return .counter(.decrTapped)
        case .incrTapped:
        return .counter(.incrTapped)
        case .nthPrimeButtonTapped:
        return .counter(.requestNthPrime)
        case .alertDismissButtonTapped:
        return .counter(.alertDismissButtonTapped)
        case .isPrimeButtonTapped:
        return .counter(.isPrimeButtonTapped)
        case .primeModalDismissed:
        return .counter(.primeModalDismissed)
        case .doubleTap:
        return .counter(.requestNthPrime)
        }
    },
    removeDuplicates: ==
)
</code></pre>
<p>è¿™ç§è½¬æ¢éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è€ƒè™‘æ¯ä¸ªå±€éƒ¨çš„ã€ç‰¹å®šäºé¢†åŸŸçš„æ“ä½œï¼Œå¹¶ç¡®å®šå®ƒå¯¹<strong>reducer</strong>çš„ä¸šåŠ¡é€»è¾‘æ„å‘³ç€ä»€ä¹ˆã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ç¡®å®è†¨èƒ€äº†åˆå§‹åŒ–å™¨çš„ä»£ç ï¼Œæ‰€ä»¥å°±åƒæˆ‘ä»¬å¯¹çŠ¶æ€åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ªå°åŠ©æ‰‹å‡½æ•°ä¸­ï¼Œä½†è¿™æ¬¡å®ƒéœ€è¦æŠŠæˆ‘ä»¬çš„å±€éƒ¨<strong>Action</strong>è½¬æ¢æˆ<strong>CounterFeatureAction</strong>ã€‚ æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å®ƒè¡¨ç¤ºä¸ºæœ¬åœ° <strong>Action</strong> enumä¸­çš„ä¸€ä¸ªé™æ€å‡½æ•°:</p>
<pre><code class="language-swift">extension CounterFeatureAction {
  init(counterViewAction action: CounterView.Action) -&gt; CounterFeatureAction {
    switch action {
    case .decrTapped:
      self = .counter(.decrTapped)
    case .incrTapped:
      self = .counter(.incrTapped)
    case .nthPrimeButtonTapped:
      self = .counter(.requestNthPrime)
    case .alertDismissButtonTapped:
      self = .counter(.alertDismissButtonTapped)
    case .isPrimeButtonTapped:
      self = .counter(.isPrimeButtonTapped)
    case .primeModalDismissed:
      self = .counter(.primeModalDismissed)
    case .doubleTap:
      self = .counter(.requestNthPrime)
    }
  }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æ›´æ–°è§†å›¾çš„åˆå§‹åŒ–å™¨ã€‚</p>
<pre><code class="language-swift">public init(store: Store&lt;CounterFeatureState, CounterFeatureAction&gt;) {
  print(&quot;CounterView.init&quot;)
  self.store = store
  self.viewStore = self.store
    .scope(
      value: State.init,
      action: Action.init
  )
    .view(removeDuplicates: ==)
}
</code></pre>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»å®Œæˆäº†ä¸€äº›å¾ˆé…·çš„äº‹æƒ…ã€‚è®©æˆ‘ä»¬åé€€ä¸€æ­¥ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„<strong>view</strong>æ˜¯å¦‚ä½•å½¢æˆçš„ã€‚</p>
<p>è¯¥è§†å›¾é¦–å…ˆä¸ºè‡ªå·±çš„å°å±€éƒ¨åŸŸå£°æ˜ä¸€ä¸ªç»“æ„ä½“å’Œenumï¼Œå³å®ƒæ‰€å…³å¿ƒçš„æ•°æ®å—ï¼Œä»¥ä¾¿bodyå±æ€§å®Œæˆå®ƒçš„å·¥ä½œ:</p>
<pre><code class="language-swift">public struct CounterView: View {
  typealias State = (
    alertNthPrime: PrimeAlert?,
    count: Int,
    isNthPrimeButtonDisabled: Bool,
    isPrimeModalShown: Bool
  )
  enum Action {
    case decrTapped
    case incrTapped
    case nthPrimeButtonTapped
    case alertDismissButtonTapped
    case isPrimeButtonTapped
    case primeModalDismissed
    case doubleTap
  }
  â€¦
}
</code></pre>
<p>æ³¨æ„ï¼Œæ‰€æœ‰è¿™äº›å±æ€§å’Œç”¨ä¾‹éƒ½ä¸“é—¨é’ˆå¯¹UIå…³æ³¨ç‚¹è¿›è¡Œäº†è°ƒä¼˜ã€‚ æˆ‘ä»¬æŒ‰ç…§åœ¨UIä¸­ç›´æ¥è¡¨ç¤ºçš„æ–¹å¼æ¥æè¿°çŠ¶æ€ï¼Œæ¯”å¦‚æ˜¾ç¤ºalertæ—¶ï¼Œä»¥åŠç¦ç”¨æŒ‰é’®æ—¶ã€‚æˆ‘ä»¬æè¿°çš„æ“ä½œå°±æ˜¯ç”¨æˆ·åœ¨UIä¸­å¯ä»¥åšçš„äº‹æƒ…ï¼Œæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œå–æ¶ˆä¸€ä¸ªæ¨¡æ€ï¼Œæˆ–è€…åŒå‡»å±å¹•ã€‚å­—æ®µå’Œç”¨ä¾‹çš„åç§°ä¸å®ƒä»¬åœ¨UIä¸­æ‰€ä»£è¡¨çš„å†…å®¹ä¹‹é—´çš„è§£é‡Šç©ºé—´åº”è¯¥å¾ˆå°ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰è¿™ä¸ªè§†å›¾çš„è¿è¡Œæ—¶å¯¹è±¡:</p>
<pre><code class="language-swift">let store: Store&lt;CounterFeatureState, CounterFeatureAction&gt;
@ObservedObject var viewStore: ViewStore&lt;State, Action&gt;
</code></pre>
<p>é¦–å…ˆæ˜¯<strong>store</strong>ï¼Œå®ƒæ˜¯å®é™…è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å’Œeffectçš„è¿è¡Œç¯å¢ƒï¼Œå®ƒçš„åŸŸåŒ…å«è¯¥ç‰¹æ€§çš„æ‰€æœ‰å†…å®¹ï¼Œä»¥åŠæ‰§è¡Œå…¶å·¥ä½œæ‰€éœ€çš„æ‰€æœ‰å­ç‰¹æ€§ã€‚ç„¶åæˆ‘ä»¬æœ‰<strong>view store</strong>ï¼Œå®ƒæ”¯æŒè¿™ä¸ªè§†å›¾çš„å‘ˆç°ã€‚æˆ‘ä»¬è¯»å–å½“å‰çŠ¶æ€ï¼Œä»¥ä¾¿å®ç°æ„å»ºUIçš„bodyå±æ€§ï¼Œå¹¶å‘å®ƒå‘é€ç”¨æˆ·æ“ä½œï¼Œä»¥ä¾¿è¿è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰äº†åˆå§‹åŒ–å™¨ï¼Œå®ƒåªéœ€è¦ä»çˆ¶è§†å›¾ä¼ å…¥ä¸€ä¸ª<strong>store</strong>ï¼Œç„¶åæˆ‘ä»¬æŸ¥çœ‹è¯¥<strong>store</strong>ï¼Œä»¥ä¾¿åªæå–è§†å›¾å®é™…å…³å¿ƒçš„çŠ¶æ€å’ŒåŠ¨ä½œçš„åŸºæœ¬è¦ç´ ã€‚æˆ‘ä»¬ç”šè‡³é€šè¿‡å°†çŠ¶æ€å’ŒåŠ¨ä½œè½¬æ¢æå–åˆ°å¸®åŠ©å‡½æ•°ä¸­æ¥æ¸…ç†è¿™ä¸€ç‚¹ï¼Œåœ¨åˆå§‹åŒ–å™¨ä¸­ä¸€åˆ‡éƒ½å¾ˆå¥½å’Œæ•´æ´:</p>
<pre><code class="language-swift">public init(store: Store&lt;CounterFeatureState, CounterFeatureAction&gt;) {
  self.store = store
  self.viewStore = self.store
    .scope(
      value: State.init,
      action: CounterFeatureAction.init
   )
    .view
}
</code></pre>
<p>ç„¶ååœ¨<strong>body</strong>å±æ€§ä¸­ï¼ŒUIçš„å®é™…å·¥ä½œå‘ç”Ÿçš„åœ°æ–¹ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›éå¸¸ç›´æ¥å’Œå®Œå…¨æ²¡æœ‰é€»è¾‘çš„ä¸œè¥¿ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†æ˜¾ç¤ºè®¡æ•°å™¨å’ŒæŒ‰é’®çš„æ ¸å¿ƒUI:</p>
<pre><code class="language-swift">VStack {
  HStack {
    Button(&quot;-&quot;) { self.viewStore.send(.decrTapped) }
      .disabled(self.viewStore.value.isDecrementButtonDisabled)
    Text(&quot;\(self.viewStore.value.count)&quot;)
    Button(&quot;+&quot;) { self.viewStore.send(.incrTapped) }
      .disabled(self.viewStore.value.isIncrementButtonDisabled)
  }
  Button(&quot;Is this prime?&quot;) { self.viewStore.send(.isPrimeButtonTapped) }
  Button(&quot;What is the \(ordinal(self.viewStore.value.count)) prime?&quot;) {
    self.viewStore.send(.nthPrimeButtonTapped)
  }
  .disabled(self.viewStore.value.isNthPrimeButtonDisabled)
}
</code></pre>
<p>æŒ‰é’®åªæ˜¯å‘<strong>view store</strong>åŒºå‘é€æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œå‡†ç¡®åœ°æè¿°äº†å¯¼è‡´å®ƒä»¬çš„åŸå› ï¼Œæ‰€ä»¥æ²¡æœ‰ç©ºé—´è§£é‡Šæˆ‘ä»¬åº”è¯¥å‘é€ä»€ä¹ˆæ“ä½œã€‚ç±»ä¼¼åœ°ï¼Œä»<strong>view store</strong>åŒºè¯»å–çŠ¶æ€æ¥æ„é€ è¿™äº›UIç»„ä»¶ä¹Ÿéå¸¸ç®€å•ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¿™ä¹ˆåšï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥åˆ é™¤æŒ‰é’®çš„é€»è¾‘:</p>
<pre><code class="language-swift">Button(&quot;What is the \(ordinal(self.viewStore.value.count)) prime?&quot;) {
</code></pre>
<p>ä¸ºä»€ä¹ˆè¦åœ¨è§†å›¾ä¸­è¿›è¡Œè¿™ç§è®¡ç®—è€Œä¸æ˜¯æŠŠå®ƒç§»åˆ°<strong>view store</strong>ä¸­å‘¢?</p>
<pre><code class="language-swift">Button(self.viewStore.value.nthPrimeButtonTitle) {
</code></pre>
<p>ç„¶åæˆ‘ä»¬åªéœ€è¦æ›´æ–°æœ¬åœ°è§†å›¾çŠ¶æ€ã€‚</p>
<pre><code class="language-swift">public struct CounterView: View {
  struct State: Equatable {
    let alertNthPrime: PrimeAlert?
    let count: Int
    let isDecrementButtonDisabled: Bool
    let isIncrementButtonDisabled: Bool
    let isNthPrimeButtonDisabled: Bool
    let isPrimeModalShown: Bool
    let nthPrimeButtonTitle: String
  }
  â€¦
}

extension CounterView.State {
  init(counterFeatureState state: CounterFeatureState) {
    self.alertNthPrime = state.alertNthPrime
    self.count = state.count
    self.isDecrementButtonDisabled = state.isNthPrimeRequestInFlight
    self.isIncrementButtonDisabled = state.isNthPrimeRequestInFlight
    self.isNthPrimeButtonDisabled = state.isNthPrimeRequestInFlight
    self.isPrimeModalShown = state.isPrimeModalShown
    self.nthPrimeButtonTitle = &quot;What is the \(ordinal(state.count)) prime?&quot;
  }
}
</code></pre>
<p>ç»§ç»­åœ¨è§†å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æ›´å¤æ‚çš„UIç±»å‹ï¼Œå®ƒä»¬ä»ç„¶éå¸¸ç®€å•ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œè¦æ˜¾ç¤ºå’Œéšè—ä¸»æ¨¡æ€ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åš:</p>
<pre><code class="language-swift">.sheet(
  isPresented: .constant(self.viewStore.value.isPrimeModalShown),
  onDismiss: { self.viewStore.send(.primeModalDismissed) }
) {
  IsPrimeModalView(
    store: self.store.scope(
      value: { ($0.count, $0.favoritePrimes) },
      action: { .primeModal($0) }
    )
  )
}
</code></pre>
<p>åŒæ ·ï¼Œ<strong>view store</strong>çš„çŠ¶æ€å®Œç¾åœ°æè¿°äº†ä½•æ—¶åº”è¯¥æ˜¾ç¤ºæ¨¡æ€ï¼Œä»¥åŠå½“æ¨¡æ€è§£æ•£æ—¶è¯¥åšä»€ä¹ˆã€‚ç„¶åå±•ç¤ºçš„æ¨¡æ€è§†å›¾å‡†ç¡®åœ°æè¿°äº†å®ƒéœ€è¦ä»€ä¹ˆæ ·çš„<strong>store</strong>æ¥å®Œæˆå®ƒçš„å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¡®å®š<strong>store</strong>çš„èŒƒå›´æ¥ä¼ é€’ç»™å®ƒã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰äº†â€œ<strong>nth prime</strong>â€è­¦æŠ¥:</p>
<pre><code class="language-swift">.alert(
  item: .constant(self.viewStore.value.alertNthPrime)
) { alert in
  Alert(
    title: Text(alert.title),
    dismissButton: .default(Text(&quot;Ok&quot;)) {
      self.viewStore.send(.alertDismissButtonTapped)
    }
  )
}
</code></pre>
<p>åŒæ ·ï¼ŒçŠ¶æ€ç²¾ç¡®åœ°æè¿°äº†ä½•æ—¶æ˜¾ç¤ºè­¦æŠ¥ã€‚</p>
<p>æœ€åæˆ‘ä»¬æœ‰äº†tapæ‰‹åŠ¿:</p>
<pre><code class="language-swift">.onTapGesture(count: 2) {
  self.viewStore.send(.doubleTap)
}
</code></pre>
<p>åŒæ ·çš„ï¼ŒåŠ¨ä½œå‡†ç¡®åœ°æè¿°äº†åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™å‘é€ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªéå¸¸ç›´æ¥çš„é…æ–¹æ¥æ„é€ æˆ‘ä»¬çš„è§†å›¾ï¼Œä»¥ä¾¿å®ƒä»¬ä¸å¯ç»„åˆæ¶æ„ä¸€èµ·å·¥ä½œï¼Œä»¥ä¾¿å®ƒä»¬åŒ…å«å°½å¯èƒ½å°‘çš„é€»è¾‘ã€‚</p>
<ul>
<li>é¦–å…ˆï¼Œä½¿ç”¨çŠ¶æ€ç»“æ„å’Œæ“ä½œæšä¸¾æè¿°è§†å›¾çš„æœ¬åœ°åŸŸã€‚</li>
<li>ç„¶åï¼Œé€šè¿‡ç¡®å®šæ”¯æŒè¯¥è§†å›¾çš„ä¸šåŠ¡é€»è¾‘çš„<strong>store</strong>åŸŸä»¥åŠå®ƒçš„æ‰€æœ‰å­è§†å›¾ï¼Œä»¥åŠä»…æ”¯æŒè¯¥è§†å›¾çš„æœ¬åœ°åŸŸçš„<strong>view store</strong>åŸŸï¼Œæ¥æè¿°è§†å›¾çš„è¿è¡Œæ—¶ã€‚</li>
<li>æ¥ä¸‹æ¥ï¼Œå®ç°è§†å›¾çš„åˆå§‹åŒ–å™¨ï¼Œå®ƒå°†ä»¥<strong>store</strong>ä½œä¸ºå‚æ•°ï¼Œç„¶ååœ¨åˆå§‹åŒ–å™¨ä¸­ï¼Œæ‚¨éœ€è¦æè¿°å¦‚ä½•å°†æ•´ä¸ªç‰¹æ€§çš„åŸŸè½¬æ¢ä¸ºè§†å›¾çš„åŸŸã€‚</li>
<li>æœ€åä½ éœ€è¦å®ç°è§†å›¾çš„ä¸»ä½“ï¼Œå®ƒåº”è¯¥åšå°½å¯èƒ½å°‘çš„å·¥ä½œæ¥å°†<strong>view store</strong>çš„çŠ¶æ€è½¬æ¢ä¸ºUIã€‚</li>
</ul>
<hr>
<h2 id="4-a-nametestsandtheviewstoreatests-and-the-view-store">4. <a name='Testsandtheviewstore'></a>Tests and the view store</h2>
<p>å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»å¯¹æ¶æ„åšäº†ä¸€äº›ç›¸å½“å…¨é¢çš„æ”¹å˜ã€‚åœ¨è¿›ä¸€æ­¥æ·±å…¥ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥è€ƒè™‘å®ƒä»¬å¯¹æ¶æ„æµ‹è¯•æ•…äº‹çš„å½±å“ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¯•ç€æ„å»ºå¹¶è¿è¡Œæœ€å–œæ¬¢çš„è´¨æ•°æµ‹è¯•ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒä¸ä»…ä»ç„¶åœ¨æ„å»ºï¼Œè€Œä¸”ä¸€åˆ‡éƒ½é€šè¿‡äº†ã€‚è¿™æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹æ¶æ„æ‰€åšçš„æ›´æ”¹éƒ½æ˜¯å›´ç»•<strong>Storeså’ŒViewStores</strong>è¿›è¡Œçš„ã€‚è¿™äº›æµ‹è¯•æ˜¯ç®€å•çš„å•å…ƒæµ‹è¯•ï¼Œå®ƒä»¬ä½¿ç”¨ä¸€äº›çŠ¶æ€å’Œæ“ä½œç›´æ¥è°ƒç”¨<strong>reducer</strong>ï¼Œè‡ªä¸Šæ¬¡ä»¥æ¥è¿™äº›çŠ¶æ€å’Œæ“ä½œéƒ½æ²¡æœ‰æ›´æ”¹ã€‚</p>
<p>è´¨æ•°æ¨¡æ€æµ‹è¯•ä¹Ÿæ˜¯å¦‚æ­¤:ä¸€åˆ‡éƒ½å»ºç«‹å¹¶é€šè¿‡ã€‚è¿™å¤ªé…·äº†!è¿™æ„å‘³ç€å¯¹<strong>reducer</strong>çš„æµ‹è¯•å¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šæ”¹å˜ã€‚</p>
<p>So what about the counter tests?  ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä»¬å·²ç»ä¸å†äº•ç„¶æœ‰åºäº†ã€‚æˆ‘ä»¬ä¸ä»…åœ¨è®¡æ•°å™¨æ¨¡å—ä¸­è¿›è¡Œäº†ä¸€äº›é‡è¦çš„åŸŸé‡æ„ï¼Œè€Œä¸”è¿˜è¿›è¡Œäº†ä¸€ä¸ªé›†æˆé£æ ¼çš„æµ‹è¯•ï¼Œè¯¥æµ‹è¯•åˆ›å»ºäº†ä¸€ä¸ªè§†å›¾ï¼Œå¹¶ä½¿ç”¨å­˜å‚¨å’Œå¿«ç…§æµ‹è¯•äº†è®¡æ•°å™¨å±å¹•ã€‚</p>
<p>è®©æˆ‘ä»¬ä»å•å…ƒæµ‹è¯•å¼€å§‹ã€‚è®¡æ•°å™¨æ¨¡å—çš„å•å…ƒæµ‹è¯•ä½¿ç”¨å¯ç»„åˆæ¶æ„çš„<strong>assert</strong>åŠ©æ‰‹,å¯ä»¥ä»¥å£°æ˜å¼çš„æ–¹å¼,æè¿°ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œçš„ä¸€ç³»åˆ—æ­¥éª¤å’Œæ–­è¨€çŠ¶æ€å¦‚ä½•åœ¨æ¯ä¸€æ­¥ä¹‹åå‘ç”Ÿå˜åŒ–ï¼ŒåŒæ—¶éšè—ç®¡ç†å’Œè¿è¡Œå‰¯ä½œç”¨çš„ç»†èŠ‚ã€‚</p>
<p>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨ä¸€ä¸ªæµ‹è¯•ä¸­ï¼Œè¯¥æµ‹è¯•æ–­è¨€ä¸æŒ‰å¢é‡å’Œé€’å‡æŒ‰é’®ï¼Œå› ä¸ºå®ƒä»ç„¶å¼•ç”¨<strong>CounterViewState</strong>ï¼Œæˆ‘ä»¬ä¹‹å‰å°†å…¶é‡å‘½åä¸º<strong>CounterFeatureState</strong>ã€‚</p>
<pre><code class="language-swift">func testIncrDecrButtonTapped() {
  assert(
    initialValue: CounterFeatureState(count: 2),
    reducer: counterFeatureReducer,
    environment: { _ in .sync { 17 } },
    steps:
    Step(.send, .counter(.incrTapped)) { $0.count = 3 },
    Step(.send, .counter(.incrTapped)) { $0.count = 4 },
    Step(.send, .counter(.decrTapped)) { $0.count = 3 }
  )
}
</code></pre>
<p>ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨ä¸€ä¸ªæè¿°è¯·æ±‚â€œnä¸ªâ€ç´ æ•°çš„â€œå¿«ä¹æµâ€çš„æµ‹è¯•ä¸­ã€‚æˆ‘ä»¬å·²ç»é‡æ„äº†æ ¸å¿ƒåŸŸé€»è¾‘ï¼Œå› æ­¤ä¸å†æ­£ç¡®åœ°æ–­è¨€<strong>isNthPrimeButtonDisabled</strong>çŠ¶æ€æˆ–<strong>nthPrimeButtonTapped</strong>åŠ¨ä½œã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>isNthPrimeRequestInFlightå’ŒrequestNthPrime</strong>æ›´æŠ½è±¡åœ°æè¿°è¿™ä¸ªçŠ¶æ€å’Œæ“ä½œã€‚</p>
<pre><code class="language-swift">func testNthPrimeButtonHappyFlow() {
  assert(
    initialValue: CounterFeatureState(
      alertNthPrime: nil,
      count: 7,
      isNthPrimeRequestInFlight: false
    ),
    reducer: counterFeatureReducer,
    environment: { _ in .sync { 17 } },
    steps:
    Step(.send, .counter(.requestNthPrime)) {
      $0.isNthPrimeRequestInFlight = true
    },
    Step(.receive, .counter(.nthPrimeResponse(n: 7, prime: 17))) {
      $0.alertNthPrime = PrimeAlert(n: $0.count, prime: 17)
      $0.isNthPrimeRequestInFlight = false
    },
    Step(.send, .counter(.alertDismissButtonTapped)) {
      $0.alertNthPrime = nil
    }
  )
}
</code></pre>
<p>â€œä¸å¿«ä¹æµâ€éœ€è¦åšå‡ºåŒæ ·çš„æ”¹å˜:</p>
<pre><code class="language-swift">func testNthPrimeButtonUnhappyFlow() {
  assert(
    initialValue: CounterFeatureState(
      alertNthPrime: nil,
      count: 7,
      isNthPrimeRequestInFlight: false
    ),
    reducer: counterFeatureReducer,
    environment: { _ in .sync { nil } },
    steps:
    Step(.send, .counter(.requestNthPrime)) {
      $0.isNthPrimeRequestInFlight = true
    },
    Step(.receive, .counter(.nthPrimeResponse(n: 7, prime: nil))) {
      $0.isNthPrimeRequestInFlight = false
    }
  )
}
</code></pre>
<p>æœ€åæˆ‘ä»¬éœ€è¦æ›´æ–°<strong>testPrimeModal</strong>æ¥ä½¿ç”¨<strong>CounterFeatureState</strong>è€Œä¸æ˜¯<strong>CounterViewState</strong>ã€‚</p>
<p>å°±åƒè¿™æ ·ï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•å†æ¬¡ç¼–è¯‘!å¦‚æœæˆ‘ä»¬è®¤çœŸä½¿ç”¨Xcodeçš„é‡æ„å·¥å…·ï¼Œè¿™ç±»å·¥ä½œç”šè‡³å¯ä»¥è‡ªåŠ¨å®Œæˆã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥æåˆ°çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™äº›æµ‹è¯•ä¸å†ç”¨éå¸¸å…·ä½“çš„æœ¯è¯­æè¿°ç”¨æˆ·çš„æ“ä½œæˆ–å±å¹•ä¿æŒçš„çŠ¶æ€ã€‚åœ¨è¿™äº›æ›´æ”¹ä¹‹å‰ï¼Œè¿™äº›æµ‹è¯•å‡†ç¡®åœ°æè¿°äº†ç”¨æˆ·æ‰€åšçš„æ“ä½œï¼Œå› ä¸ºæ“ä½œç›´æ¥æ˜ å°„åˆ°æ­£åœ¨ç‚¹å‡»çš„ç¬¬nä¸ªä¸»æŒ‰é’®ï¼Œè€ŒçŠ¶æ€ç›´æ¥æ˜ å°„åˆ°ç¬¬nä¸ªè¢«ç¦ç”¨çš„ä¸»æŒ‰é’®ã€‚æˆ‘ä»¬ç°åœ¨å·²ç»å°†è·¨å¹³å°çš„ä¸œè¥¿æ™®éåŒ–äº†ï¼Œå…¶ä¸­ç‰¹å®šçš„ç”¨æˆ·æ“ä½œå’Œå±å¹•çŠ¶æ€å¯èƒ½ä¼šæœ‰ä¸€äº›å·®å¼‚ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ<strong>assert helper</strong>åœ¨æè¿°å’Œæµ‹è¯•ç”¨æˆ·æ„å›¾è„šæœ¬æ–¹é¢ä»ç„¶åšå¾—å¾ˆå¥½ï¼Œåªæ˜¯æ°å¥½æ˜ å°„åˆ°ä¸åŒå¹³å°ä¸Šçš„ä¸åŒUIã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰äº†<strong>testsnapshot</strong>æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé›†æˆé£æ ¼çš„æµ‹è¯•ï¼Œåœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå­˜å‚¨ã€ä¸€ä¸ªè§†å›¾ï¼Œå¹¶æ²¿ç€è¯¥å­˜å‚¨å‘é€äº†ä¸€ä¸ªæ“ä½œè„šæœ¬ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­æ ¹æ®å±å¹•æˆªå›¾è¿›è¡Œæ–­è¨€ã€‚</p>
<p>ä½†éšç€æˆ‘ä»¬å¯¹æ¶æ„çš„æ”¹å˜ï¼Œæˆ‘ä»¬ä¸èƒ½å†åœ¨<strong>store</strong>ä¸­ç›´æ¥è°ƒç”¨<strong>send</strong>:</p>
<pre><code class="language-swift">store.send(.counter(.incrTapped))

ğŸ›‘ â€˜sendâ€™ is inaccessible due to â€˜privateâ€™ protection level
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶äº‹æ˜¯å°†<strong>Store</strong>çš„<strong>send</strong>æ–¹æ³•æ”¾åœ¨<strong>internal</strong>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡@<strong>testable</strong>å¯¼å…¥æ¥è®¿é—®å®ƒã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ç»§ç»­å‘<strong>store</strong>å‘é€åŠŸèƒ½çº§åˆ«çš„<strong>CounterFeatureActions</strong>æ“ä½œã€‚ä¹Ÿè®¸æ›´ç®€å•ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>store</strong>ä¸Šæ·»åŠ ä¸€ä¸ª.<strong>view</strong>æ¥è®¿é—®å®ƒçš„è§†å›¾å•†åº—ã€‚</p>
<pre><code class="language-swift">let viewStore = store.view
</code></pre>
<p>ç„¶åæ›´æ–°æ‰€æœ‰å‘é€æ“ä½œåˆ°<strong>store</strong>çš„è°ƒç”¨ï¼Œå°†å®ƒä»¬å‘é€åˆ°<strong>view store</strong> :</p>
<pre><code class="language-swift">viewStore.send(.counter(.incrTapped))
â€¦
viewStore.send(.counter(.incrTapped))
â€¦
viewStore.send(.counter(.nthPrimeButtonTapped))
â€¦
viewStore.send(.counter(.alertDismissButtonTapped))
â€¦
viewStore.send(.counter(.isPrimeButtonTapped))
â€¦
viewStore.send(.primeModal(.saveFavoritePrimeTapped))
â€¦
viewStore.send(.counter(.primeModalDismissed))
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åªå‰©ä¸‹ä¸€ä¸ªé”™è¯¯:</p>
<pre><code class="language-swift">viewStore.send(.counter(.nthPrimeButtonTapped))
ğŸ›‘ Type â€˜CounterActionâ€™ has no member â€˜nthPrimeButtonTappedâ€™
</code></pre>
<p>æˆ‘ä»¬åªéœ€è¦å°†<strong>nthPrimeButtonTapped</strong>æ›´æ–°ä¸º<strong>requestNthPrime</strong>ï¼Œæˆ‘ä»¬åˆåœ¨æ„å»ºé¡ºåºäº†ã€‚å½“æˆ‘ä»¬è¿›è¡Œæµ‹è¯•æ—¶</p>
<pre><code class="language-swift">âŒ failed - Snapshot does not match reference.
</code></pre>
<p>æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¿«ç…§æ–­è¨€å¤±è´¥ã€‚å¦‚æœæˆ‘ä»¬çœ‹çœ‹å·®å¼‚ï¼Œè¿™æ˜¯æœ‰æ„ä¹‰çš„ã€‚</p>
<p>æˆ‘ä»¬æ›´æ–°äº†è§†å›¾ï¼Œåœ¨ç¬¬nä¸ªç´ æ•°è¯·æ±‚æ­£åœ¨è¿è¡Œæ—¶ç¦ç”¨<strong>incrå’Œdecr</strong>æŒ‰é’®ï¼Œå¿«ç…§æ­£ç¡®åœ°æ•è·äº†è¯¥è¡Œä¸ºã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é‡æ–°é‡å½•äº†ã€‚</p>
<pre><code class="language-swift">record = true
âŒ failed - Record mode is on. Turn record mode off and re-run â€œtestSnapshotsâ€ to test against the newly-recorded snapshot.
</code></pre>
<p>ä¸è¿‡ï¼Œå…³äºè¿™äº›æµ‹è¯•è¿˜æœ‰æ›´å¤šè¦è¯´çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¤±å»äº†ä¸€äº›è¦†ç›–èŒƒå›´ã€‚åœ¨counteræ¨¡å—ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›å°†<strong>CounterFeatureStateå’ŒCounterFeatureAction</strong>æ˜ å°„åˆ°<strong>CounterView.Stateå’ŒCounterView.Action</strong>ã€‚</p>
<pre><code class="language-swift">extension CounterView.State {
  init(counterFeatureState state: CounterFeatureState) {
    self.alertNthPrime = state.alertNthPrime
    self.count = state.count
    self.isDecrementButtonDisabled = state.isNthPrimeRequestInFlight
    self.isIncrementButtonDisabled = state.isNthPrimeRequestInFlight
    self.isNthPrimeButtonDisabled = state.isNthPrimeRequestInFlight
    self.isPrimeModalShown = state.isPrimeModalShown
    self.nthPrimeButtonTitle = &quot;What is the \(ordinal(state.count)) prime?&quot;
  }
}

extension CounterFeatureAction {
  init(counterViewAction action: CounterView.Action) -&gt; CounterFeatureAction {
    switch action {
    case .decrTapped:
      return .counter(.decrTapped)
    case .incrTapped:
      return .counter(.incrTapped)
    case .nthPrimeButtonTapped:
      return .counter(.requestNthPrime)
    case .alertDismissButtonTapped:
      return .counter(.alertDismissButtonTapped)
    case .isPrimeButtonTapped:
      return .counter(.isPrimeButtonTapped)
    case .primeModalDismissed:
      return .counter(.primeModalDismissed)
    case .doubleTap:
      return .counter(.requestNthPrime)
    }
  }
}
</code></pre>
<p>è€Œä¸”æˆ‘ä»¬çš„æµ‹è¯•éƒ½æ²¡æœ‰è¦†ç›–åˆ°è¿™äº›è½¬æ¢ã€‚</p>
<p>ç°åœ¨ï¼Œè¿™äº›å‡½æ•°å’Œæ•°æ®ç±»å‹éå¸¸ç®€å•ï¼Œå› æ­¤å¯ä»¥åˆç†åœ°é¢„æµ‹å®ƒä»¬å¯¹äºå•å…ƒæµ‹è¯•éå¸¸ç®€å•ã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„å¿«ç…§æµ‹è¯•ä¸­ï¼Œæœ€å¥½çŸ¥é“è§†å›¾çŠ¶æ€æ˜¯ç›´æ¥ä»è§†å›¾æ“ä½œè„šæœ¬æ›´æ”¹çš„ã€‚å› æ­¤ï¼Œä¸å…¶åœ¨æ•´ä¸ªè®¡æ•°å™¨ç‰¹æ€§çš„çŠ¶æ€å’Œæ“ä½œä¸Šä½¿ç”¨<strong>viewStore</strong>ï¼Œä¸å¦‚åˆ›å»ºä¸€ä¸ª<strong>counter-scoped</strong>çš„<strong>viewStore</strong>ã€‚</p>
<pre><code class="language-swift">let counterViewStore = store
  .scope(value: CounterView.State.init, action: CounterFeatureAction.init))
  .view
â€¦
counterViewStore.send(.incrTapped)
â€¦
counterViewStore.send(.incrTapped)
â€¦
counterViewStore.send(.nthPrimeButtonTapped)
â€¦
counterViewStore.send(.alertDismissButtonTapped)
â€¦
counterViewStore.send(.isPrimeButtonTapped)
â€¦
counterViewStore.send(.primeModal(.saveFavoritePrimeTapped))
â€¦
counterViewStore.send(.primeModalDismissed)

ğŸ›‘ Type â€˜CounterView.Actionâ€™ has no member â€˜primeModalâ€™
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„ä¸€ä¸ªæ“ä½œå®é™…ä¸Šæ¥è‡ªäº <strong>prime modal viewStore</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦å¼•å…¥å…¶ä¸­ä¸€ä¸ª:</p>
<pre><code class="language-swift">let primeModalViewStore = store
  .scope(value: { $0.primeModal }, action: { .primeModal($0) })
  .view(removeDuplicates: ==)
â€¦
primeModalViewStore.send(.saveFavoritePrimeTapped)
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åœ¨æ„å»ºé¡ºåºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå¹¶è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼Œå®ƒä»¬ä»ç„¶é€šè¿‡ï¼Œè¿™å¯ä»¥ç»™æˆ‘ä»¬ç›¸å½“å¥½çš„ä¿¡å¿ƒï¼Œæˆ‘ä»¬é€šè¿‡<strong>viewStore</strong>å‘é€çš„åŠ¨ä½œè¢«æ­£ç¡®æ˜ å°„åˆ°æˆ‘ä»¬çš„æœŸæœ›ã€‚</p>
<p>å¿…é¡»æ‰¿è®¤çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨è·å¾—ç²˜åˆä»£ç çš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†ä¸€äº›æ ·æ¿ï¼Œä½†åŒæ ·é‡è¦çš„æ˜¯è¦æŒ‡å‡ºï¼Œæˆ‘ä»¬çš„æ¶æ„å’Œä»¥å¾€ä¸€æ ·æ˜¯å¯æµ‹è¯•çš„!</p>
<hr>
<h2 id="5-a-nameconclutionaconclution">5. <a name='conclution'></a>conclution</h2>
<p>è¿‡å»çš„å‡ é›†å·²ç»å¾ˆé•¿äº†ï¼Œæˆ‘ä»¬å·²ç»èµ°äº†å¾ˆé•¿ä¸€æ®µè·¯ã€‚æˆ‘ä»¬æœ€åˆçš„åŠ¨æœºæ˜¯ä¸€ä¸ªç®€å•çš„æ€§èƒ½é—®é¢˜ï¼Œå³å¤©çœŸåœ°å°†è§†å›¾ä¸­çš„æ¯ä¸ª<strong>store</strong>éƒ½è®¾ç½®ä¸º@<strong>ObservableObject</strong>ï¼Œè¿™æ ·å°±ä¼šæ„å¤–åœ°è¿‡åº¦æ¸²æŸ“è§†å›¾ã€‚è§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä»å­˜å‚¨ä¸­æ´¾ç”Ÿäº†ä¸€ç§æ–°çš„å¯¹è±¡ï¼Œå«åš<strong>view store</strong>ï¼Œå®ƒåªåŒ…å«è§†å›¾çœŸæ­£å…³å¿ƒçš„çŠ¶æ€ä½ï¼Œå› æ­¤åªæœ‰å½“å®ƒæ‰€ä¾èµ–çš„ä¸œè¥¿å‘ç”Ÿå˜åŒ–æ—¶æ‰æ¸²æŸ“è§†å›¾ã€‚</p>
<p>ä½†æˆ‘ä»¬ä¸æƒ³åªåœç•™åœ¨è¿™é‡Œï¼Œå› ä¸ºè¿™ä¸ª<strong>view store</strong>æŠ½è±¡å¸®åŠ©æˆ‘ä»¬æ¸…ç†äº†è§†å›¾ä¸­çš„ä¸€äº›ç²—ç³™è¾¹ç¼˜ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†è§†å›¾ä¸­çš„ä¸€äº›é€»è¾‘ç§»åŠ¨åˆ°ä¸€ä¸ªå¾ˆå¥½çš„å¯æµ‹è¯•åŒºåŸŸï¼Œä»è€Œä½¿æˆ‘ä»¬çš„è§†å›¾æ›´ç®€å•å’Œæ›´å¯æµ‹è¯•ï¼Œå®ƒå…è®¸æˆ‘ä»¬æè¿°è§†å›¾çš„æ›´ç‰¹å®šäºé¢†åŸŸçš„çŠ¶æ€ï¼Œè€Œä¸å¿…åœ¨åº”ç”¨ç¨‹åºçŠ¶æ€ä¸­è¡¨ç¤ºå®ƒã€‚</p>
<p>ä½†æˆ‘ä»¬ä¹Ÿä¸æƒ³å°±æ­¤æ­¢æ­¥! é€šè¿‡è®©<strong>view store</strong>è´Ÿè´£å‘é€æ“ä½œï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æ¨åŠ¨äº†<strong>view store</strong>çš„æƒ³æ³•ï¼Œè¿™ç»™äº†æˆ‘ä»¬å¦ä¸€ä¸ªæœºä¼šæ¥ç²¾ç¡®åœ°å¡‘é€ è§†å›¾æ‰€å…³å¿ƒçš„é¢†åŸŸã€‚</p>
<p>æ‰€æœ‰è¿™äº›åŠ åœ¨ä¸€èµ·æ„å‘³ç€æˆ‘ä»¬çš„è§‚ç‚¹æ›´æ²¡æœ‰é€»è¾‘æ€§ï¼Œæ›´ç›´æ¥ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚</p>
<p>è™½ç„¶å¯ä»¥è®¤ä¸ºè§†å›¾æ›´ç®€å•ä¸€äº›ï¼Œä½†è¿™æ˜¯æœ‰ä»£ä»·çš„ã€‚æˆ‘ä»¬å¿…é¡»ä¸ºè§†å›¾å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„çŠ¶æ€ç»“æ„å’Œæ“ä½œæšä¸¾ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è§†å›¾ä¸­ä¿ç•™ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›è½¬æ¢æ¥æ„é€ <strong>view store</strong>ã€‚å¯¹äºæ¯ä¸ªè§†å›¾ï¼Œä¼¼ä¹è¦åšå¾ˆå¤šé¢å¤–çš„å·¥ä½œã€‚</p>
<p>è¿™ä¸€åˆ‡æ˜¯å¦çœŸçš„å€¼å¾—ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œå¦‚æœä½ çš„è§†å›¾å¾ˆç®€å•ï¼Œæˆ–è€…å¦‚æœä½ ä¸è®¤ä¸ºä½ çš„åº”ç”¨æˆ–ç‰¹å®šå±å¹•æœ‰ä»»ä½•æ€§èƒ½é—®é¢˜ï¼Œä½ å¯ä»¥é€šè¿‡ç‚¹å‡».viewæ¥æ´¾ç”Ÿä½ çš„è§†å›¾å•†åº—ï¼Œä½ å°±å®Œæˆäº†ã€‚ä¸éœ€è¦é¢å¤–çš„ä»ªå¼!</p>
<p>ç„¶è€Œï¼Œä¸€æ—¦åº”ç”¨ç¨‹åºçš„å¤§å°å’Œç”¨ä¾‹å¢åŠ ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°<strong>view store</strong>æŠ½è±¡æ­£æ˜¯æ‚¨éœ€è¦è®¨è®ºçš„å¤æ‚æ€§å’Œè§£é”æ–°åŠŸèƒ½ã€‚</p>
<p>ä¹Ÿè®¸å¯¹Macç‰ˆæœ¬çš„è®¡æ•°å’Œç´ æ•°è®¡ç®—å™¨åº”ç”¨çš„éœ€æ±‚å¹¶ä¸å¤§ï¼Œä½†å®ƒä¼šå¸®åŠ©æˆ‘ä»¬æ¼”ç¤ºä½¿ç”¨<strong>view store</strong>çš„ä¸€ä¸ªå…³é”®ä¼˜åŠ¿ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸šåŠ¡é€»è¾‘ä¸€èˆ¬åŒ–ï¼Œè¿™æ ·å°±ä¸éœ€è¦è€ƒè™‘å¹³å°ç‰¹æ€§ï¼Œç„¶åä½¿ç”¨<strong>view store</strong>å°†è¿™äº›é€šç”¨åŠŸèƒ½é€‚åº”äºç‰¹å®šçš„å¹³å°ï¼Œå¦‚iOSã€watchOSã€macOSã€tvOSæˆ–æ‰€æœ‰4ã€‚</p>
<p>ä¸ºäº†æ¼”ç¤ºè¿™ä¸ªï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªMacç‰ˆæœ¬çš„åº”ç”¨å®ƒä¸ä¹‹å‰åˆ›å»ºçš„iOSç‰ˆæœ¬æœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚ç‰¹åˆ«åœ°ï¼Œç°åœ¨å½“æˆ‘ä»¬é—®å½“å‰è®¡æ•°æ˜¯å¦ä¸ºè´¨æ•°æ—¶ï¼Œæˆ‘ä»¬ä¼šæ˜¾ç¤ºä¸€ä¸ªæ¨¡æ€ï¼Œä½†åœ¨Macä¸Šï¼Œæˆ‘ä»¬ä¼šæ˜¾ç¤ºå®ƒä¸ºå¼¹çª—ï¼Œå› ä¸ºmacOSä¸Šçš„å¼¹çª—æ˜¯è¶…è½»çš„ï¼Œä¸å¹¸çš„æ˜¯ï¼Œiphoneä¸æ”¯æŒã€‚æˆ‘ä»¬è¿˜å°†åˆ é™¤è¯·æ±‚â€œnä¸ªè´¨æ•°â€çš„åŒå‡»æ‰‹åŠ¿ï¼Œå› ä¸ºè¿™ç§æ‰‹åŠ¿åœ¨Macä¸Šä¸æ˜¯å¾ˆå¸¸è§â€¦â€¦</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-95adaptive-state-management-state/">
                  <h3 class="post-title">
                    PointFree Episode 95:Adaptive State Management: State
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
