<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Using tokens to handle async Swift code | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1665922595647">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="ä»¥ä¸€ç§å¯é¢„æµ‹ã€å¯è¯»å’Œæ˜“äºè°ƒè¯•çš„æ–¹å¼å¤„ç†å¼‚æ­¥ä»£ç ç¡®å®å…·æœ‰æŒ‘æˆ˜æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æ™®éçš„ç°è±¡ï¼Œå‡ ä¹æ‰€æœ‰çš„ç°ä»£ä»£ç åº“éƒ½æœ‰é«˜åº¦å¼‚æ­¥çš„éƒ¨ä»¶-æ— è®ºæ˜¯é€šè¿‡ç½‘ç»œåŠ è½½æ•°æ®ï¼Œæœ¬åœ°å¤„ç†å¤§æ•°æ®é›†è¿˜æ˜¯å…¶ä»–ä»»ä½•è®¡ç®—å¯†é›†å‹çš„æ“ä½œã€‚
å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œéƒ½åˆ›å»ºäº†ä¸€äº›æŠ½è±¡æ¥..." />
    <meta name="keywords" content="concurrency,networking" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1665922595647" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
       <a href="https://beian.miit.gov.cn/">è±«ICPå¤‡2021012281å·-1</a> | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Using tokens to handle async Swift code</h2>
            <div class="post-date">2017-10-29</div>
            
            <div class="post-content" v-pre>
              <p>ä»¥ä¸€ç§å¯é¢„æµ‹ã€å¯è¯»å’Œæ˜“äºè°ƒè¯•çš„æ–¹å¼å¤„ç†å¼‚æ­¥ä»£ç ç¡®å®å…·æœ‰æŒ‘æˆ˜æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æ™®éçš„ç°è±¡ï¼Œå‡ ä¹æ‰€æœ‰çš„ç°ä»£ä»£ç åº“éƒ½æœ‰é«˜åº¦å¼‚æ­¥çš„éƒ¨ä»¶-æ— è®ºæ˜¯é€šè¿‡ç½‘ç»œåŠ è½½æ•°æ®ï¼Œæœ¬åœ°å¤„ç†å¤§æ•°æ®é›†è¿˜æ˜¯å…¶ä»–ä»»ä½•è®¡ç®—å¯†é›†å‹çš„æ“ä½œã€‚</p>
<p>å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œéƒ½åˆ›å»ºäº†ä¸€äº›æŠ½è±¡æ¥å°è¯•ç®€åŒ–å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†ï¼Œè¿™å¹¶ä¸å¥‡æ€ªã€‚æˆ‘ä»¬å·²ç»åœ¨ä»¥å‰çš„æ–‡ç« ä¸­çœ‹è¿‡ä¸€äº›è¿™æ ·çš„æŠ€æœ¯å’ŒæŠ½è±¡â€”â€”åŒ…æ‹¬ä½¿ç”¨GCDå’Œfuture &amp; Promisesã€‚æœ¬å‘¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦ä¸€ç§æŠ€æœ¯ï¼Œå®ƒå¯ä»¥ä½¿ç®¡ç†å¼‚æ­¥è°ƒç”¨å˜å¾—æ›´ç®€å•ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™â€”â€”ä½¿ç”¨ä»¤ç‰Œã€‚</p>
<h2 id="token-based-apis">Token-based APIs</h2>
<p>åŸºäºä»¤ç‰Œçš„apiçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¯åŠ¨å¼‚æ­¥æˆ–å»¶è¿Ÿæ“ä½œçš„å‡½æ•°è¿”å›ä»¤ç‰Œã€‚ ç„¶åå¯ä»¥ä½¿ç”¨è¯¥ä»¤ç‰Œæ¥ç®¡ç†å’Œå–æ¶ˆè¯¥æ“ä½œã€‚è¿™æ ·ä¸€ä¸ªå‡½æ•°çš„ç­¾åå¯ä»¥æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-swift">func loadData(from url: URL, completion: @escaping (Result) -&gt; Void) -&gt; Token
</code></pre>
<p>ä»¤ç‰Œè¦æ¯”Futureså’ŒPromisesç­‰è½»é‡çº§å¾—å¤šâ€”â€”å› ä¸ºä»¤ç‰Œåªæ˜¯ä½œä¸ºä¸€ç§è·Ÿè¸ªè¯·æ±‚çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯åŒ…å«æ•´ä¸ªè¯·æ±‚æœ¬èº«ã€‚ è¿™ä¹Ÿä½¿å®ƒä»¬æ›´å®¹æ˜“æ·»åŠ åˆ°ç°æœ‰çš„ä»£ç åº“ä¸­ï¼Œè€Œä¸å¿…ä½¿ç”¨ä¸åŒçš„æ¨¡å¼é‡å†™å¤§é‡å¼‚æ­¥ä»£ç ï¼Œæˆ–è€…å¿…é¡»å…¬å¼€å®ç°ç»†èŠ‚ã€‚</p>
<p>é‚£ä¹ˆï¼Œè®©ä¸Šé¢çš„å‡½æ•°è¿”å›ä»¤ç‰Œæœ‰ä»€ä¹ˆå¥½å¤„å‘¢?  è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨ï¼Œå…è®¸ç”¨æˆ·åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æœç´¢å…¶ä»–ç”¨æˆ·:</p>
<pre><code class="language-swift">class UserSearchViewController: UIViewController, UISearchBarDelegate {
    private let userLoader: UserLoader
    private lazy var searchBar = UISearchBar()

    func searchBar(_ searchBar: UISearchBar, textDidChange searchText: String) {
        userLoader.loadUsers(matching: searchText) { [weak self] result in
            switch result {
            case .success(let users):
                self?.reloadResultsView(with: users)
            case .error(let error):
                self?.handle(error)
            }
        }
    }
}
</code></pre>
<p>æ­£å¦‚æ‚¨åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œè¿™äº›çœ‹èµ·æ¥éƒ½å¾ˆæ ‡å‡†ï¼Œä½†æ˜¯å¦‚æœæ‚¨æ›¾ç»å®ç°è¿‡è¿™ç§â€œéšç±»å‹æœç´¢â€åŠŸèƒ½ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½çŸ¥é“å…¶ä¸­éšè—ç€ä¸€ä¸ªbugã€‚é—®é¢˜æ˜¯ï¼Œåœ¨æœç´¢å­—æ®µä¸­è¾“å…¥å­—ç¬¦çš„é€Ÿåº¦ä¸ä¸€å®šä¸è¯·æ±‚å®Œæˆçš„é€Ÿåº¦ç›¸åŒ¹é…ã€‚è¿™å°†å¯¼è‡´ä¸€ä¸ªéå¸¸å¸¸è§çš„é—®é¢˜ï¼Œå³å½“å‰ä¸€ä¸ªè¯·æ±‚åœ¨åä¸€ä¸ªè¯·æ±‚ä¹‹åå®Œæˆæ—¶ï¼Œæ„å¤–åœ°å‘ˆç°æ—§çš„ç»“æœã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹tokenå¦‚ä½•å¸®åŠ©æˆ‘ä»¬è§£å†³ä¸Šè¿°é—®é¢˜ğŸ‘</p>
<h2 id="a-token-for-every-request">A token for every request</h2>
<p>è®©æˆ‘ä»¬å…ˆä»”ç»†çœ‹çœ‹UserLoaderã€‚å®ƒç›®å‰æ˜¯è¿™æ ·å®ç°çš„:</p>
<pre><code class="language-swift">class UserLoader {
    private let urlSession: URLSession

    func loadUsers(matching query: String,
                   completionHandler: @escaping (Result&lt;[User]&gt;) -&gt; Void) {
        let url = requestURL(forQuery: query)

        let task = urlSession.dataTask(with: url) { (data, _, error) in
            // Pattern match on the returned data and error to determine
            // the outcome of the operation
            switch (data, error) {
            case (_, let error?):
                completionHandler(.error(error))
            case (let data?, _):
                do {
                    let users: [User] = try unbox(data: data)
                    completionHandler(.success(users))
                } catch {
                    completionHandler(.error(error))
                }
            case (nil, nil):
                completionHandler(.error(Error.missingData))
            }
        }

        task.resume()
    }
}
</code></pre>
<p>ä¸ºäº†é¿å…UserSearchViewControllerä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ã€‚ æœ‰å‡ ç§æ–¹æ³•å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ä¸€ç§æ–¹æ³•æ˜¯è®©UserLoaderè‡ªå·±è·Ÿè¸ªå®ƒå½“å‰çš„æ•°æ®ä»»åŠ¡ï¼Œå¹¶åœ¨æ–°ä»»åŠ¡å¯åŠ¨æ—¶å–æ¶ˆå®ƒ:</p>
<pre><code class="language-swift">class UserLoader {
    private let urlSession: URLSession
    private weak var currentTask: URLSessionDataTask?

    func loadUsers(matching query: String,
                   completionHandler: @escaping (Result&lt;[User]&gt;) -&gt; Void) {
        currentTask?.cancel()

        let url = requestURL(forQuery: query)

        let task = urlSession.dataTask(with: url) { (data, _, error) in
            ...
        }

        task.resume()
        currentTask = task
    }
}
</code></pre>
<p>ä¸Šé¢çš„æ–¹æ³•æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œä¸”æ˜¯å®Œå…¨æœ‰æ•ˆçš„æ–¹æ³•ã€‚ ç„¶è€Œï¼Œå®ƒç¡®å®è®©APIå˜å¾—ä¸é‚£ä¹ˆæ˜æ˜¾äº†â€”â€”å› ä¸ºå–æ¶ˆç°åœ¨æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå¹¶ä¸”å·²ç»èå…¥åˆ°å®ç°ä¸­ã€‚ å¦‚æœUserLoaderåœ¨ä¸åº”è¯¥è¢«å–æ¶ˆçš„æ—§çš„è¯·æ±‚çš„ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼Œè¿™å¯èƒ½ä¼šåœ¨å°†æ¥å¼•èµ·æ½œåœ¨çš„é”™è¯¯ã€‚</p>
<p>å¦ä¸€ä¸ªé€‰é¡¹æ˜¯å½“loadUsersè¢«è°ƒç”¨æ—¶è¿”å›dataä»»åŠ¡æœ¬èº«:</p>
<pre><code class="language-swift">class UserLoader {
    private let urlSession: URLSession

    func loadUsers(matching query: String,
                   completionHandler: @escaping (Result&lt;[User]&gt;) -&gt; Void) -&gt; URLSessionDataTask {
        let url = requestURL(forQuery: query)

        let task = urlSession.dataTask(with: url) { (data, _, error) in
           ...
        }

        task.resume()

        return task
    }
}
</code></pre>
<p>è¿™ä¹Ÿæ˜¯ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•ï¼Œä½†ç¼ºç‚¹æ˜¯æˆ‘ä»¬ä¼šæ³„æ¼ä½œä¸ºAPIä¸€éƒ¨åˆ†çš„å®ç°ç»†èŠ‚ã€‚æ²¡æœ‰ç†ç”±(é™¤äº†å…è®¸å–æ¶ˆ)å…¶ä»–ä½¿ç”¨UserLoaderçš„ä»£ç å¿…é¡»çŸ¥é“å®ƒåœ¨åº•å±‚ä½¿ç”¨URLSessionDataTask - è¿™åº”è¯¥ä¿ç•™ä¸€ä¸ªç§æœ‰çš„å®ç°ç»†èŠ‚ï¼Œä½¿æµ‹è¯•å’Œé‡æ„æ›´å®¹æ˜“ã€‚</p>
<p>æœ€åï¼Œè®©æˆ‘ä»¬å°è¯•ä½¿ç”¨åŸºäºä»¤ç‰Œçš„APIæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªä»¤ç‰Œç±»å‹ï¼Œç„¶ååœ¨æ‰§è¡Œè¯·æ±‚æ—¶è¿”å›å®ƒ:</p>
<pre><code class="language-swift">class RequestToken {
    private weak var task: URLSessionDataTask?

    init(task: URLSessionDataTask) {
        self.task = task
    }

    func cancel() {
        task?.cancel()
    }
}
</code></pre>
<p>æ­£å¦‚æ‚¨åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬çš„RequestTokenéå¸¸ç®€å•ï¼Œå®é™…ä¸ŠåªåŒ…å«ä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ä»»åŠ¡çš„å¼•ç”¨ã€‚çœŸçš„æ²¡æœ‰ç†ç”±è®©å®ƒå˜å¾—æ›´å¤æ‚ï¼Œå®ƒæŒæœ‰å¯¹ä»»åŠ¡æœ¬èº«çš„å¼•ç”¨å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œåªè¦æˆ‘ä»¬ä¸å…¬å¼€å®ƒã€‚</p>
<p>è®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨RequestTokenä½œä¸ºUserLoaderä¸­çš„è¿”å›ç±»å‹</p>
<pre><code class="language-swift">class UserLoader {
    private let urlSession: URLSession

    @discardableResult
    func loadUsers(matching query: String,
                   completionHandler: @escaping (Result&lt;[User]&gt;) -&gt; Void) -&gt; RequestToken {
        let url = requestURL(forQuery: query)

        let task = urlSession.dataTask(with: url) { (data, _, error) in
            ...
        }

        task.resume()

        return RequestToken(task: task)
    }
}
</code></pre>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜å‘è¯¥æ–¹æ³•æ·»åŠ äº†@discardableResultå±æ€§ï¼Œè¿™æ ·åœ¨ä¸éœ€è¦ä»¤ç‰Œæ—¶å°±ä¸ä¼šå¼ºåˆ¶APIç”¨æˆ·ä½¿ç”¨ä»¤ç‰Œã€‚</p>
<p>å…¶ç»“æœæ˜¯ä¸€ä¸ªç®€æ´æŠ½è±¡çš„APIï¼Œå¯ä»¥åœ¨ä¸å¼•å…¥é¢å¤–çŠ¶æ€çš„æƒ…å†µä¸‹å–æ¶ˆæ“ä½œâ€”â€”éå¸¸æ£’!ğŸ­</p>
<h2 id="using-a-token-to-cancel-an-ongoing-task">Using a token to cancel an ongoing task</h2>
<p>ç°åœ¨æ˜¯æœ€åä¸€æ­¥äº†â€”â€”å½“ç”¨æˆ·åœ¨è§†å›¾æ§åˆ¶å™¨çš„æœç´¢æ ä¸­è¾“å…¥ä¸€ä¸ªæ–°å­—ç¬¦æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªä»¤ç‰Œæ¥å–æ¶ˆä¹‹å‰æœªå®Œæˆçš„è¯·æ±‚ã€‚</p>
<p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªå±æ€§æ¥å­˜å‚¨å½“å‰è¯·æ±‚ä»¤ç‰Œï¼Œå¹¶ä¸”åœ¨å¼€å§‹ä¸€ä¸ªæ–°è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬åªéœ€å¯¹å®ƒè°ƒç”¨cancel()ã€‚æœ€åï¼Œç”±äºå¼•å…¥äº†å–æ¶ˆï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ›´æ–°å¤„ç†ç»“æœä»£ç æ¥å¤„ç†URLError.cancelledï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å–æ¶ˆæ—§è¯·æ±‚æ—¶å°±ä¸ä¼šæ˜¾ç¤ºä¸€ä¸ªé”™è¯¯è§†å›¾ã€‚</p>
<p>ä¸‹é¢æ˜¯æœ€ç»ˆå®ç°çš„æ ·å­:</p>
<pre><code class="language-swift">class UserSearchViewController: UIViewController, UISearchBarDelegate {
    private let userLoader: UserLoader
    private lazy var searchBar = UISearchBar()
    private var requestToken: RequestToken?

    func searchBar(_ searchBar: UISearchBar, textDidChange searchText: String) {
        requestToken?.cancel()

        requestToken = userLoader.loadUsers(matching: searchText) { [weak self] result in
            switch result {
            case .success(let users):
                self?.reloadResultsView(with: users)
            case .error(URLError.cancelled):
                // Request was cancelled, no need to do any handling
                break
            case .error(let error):
                self?.handle(error)
            }
        }
    }
}
</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>å°†ä»¤ç‰Œæ·»åŠ åˆ°ç°æœ‰çš„å¼‚æ­¥apiæ˜¯ä¸€ç§å¾ˆå¥½çš„æ·»åŠ å–æ¶ˆæ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å¿…å®Œå…¨é‡å†™å®ç°ã€‚è€Œå…¶ä»–æ›´å¤æ‚çš„å¼‚æ­¥æŠ½è±¡(å¦‚æœŸè´§/æ‰¿è¯ºã€RxSwiftã€æ“ä½œç­‰)æä¾›äº†æ¯”ç®€å•ä»¤ç‰Œæ›´å¼ºå¤§çš„åŠŸèƒ½â€”â€”å¦‚æœä½ æ‰€éœ€è¦çš„åªæ˜¯å–æ¶ˆï¼Œä»¤ç‰Œå¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œè®©RequestTokenæ›´ä¸€èˆ¬åŒ–ï¼Œè®©å®ƒæ¥å—ä¸€ä¸ªç¬¦åˆå¯å–æ¶ˆåè®®çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„URLSessionDataTaskå¯¹è±¡ã€‚ä½†æ€»çš„æ¥è¯´ï¼Œæˆ‘å»ºè®®è®©ä»£å¸ä¿æŒè¶…çº§ç®€å•ï¼Œä»¥é¿å…è®©å®ƒä»¬æˆé•¿ä¸ºçœ‹èµ·æ¥æ›´åƒFutures/Promisesçš„ä¸œè¥¿ã€‚</p>
<p><a href="https://www.swiftbysundell.com/articles/using-tokens-to-handle-async-swift-code/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/ArhVOQ_GL/" class="tag">
                    concurrency
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/EV0rk5a8R1/" class="tag">
                    networking
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/capturing-objects-in-swift-closures/">
                  <h3 class="post-title">
                    Capturing objects in Swift closures
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
