<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 91: Dependency Injection Made Composable | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1647167519050">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Introduction




Effects recap




Environment recap




Current problems




Environment in the reducer




Environ..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1647167519050" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 91: Dependency Injection Made Composable</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Introduction">Introduction</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Effectsrecap">Effects recap</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Environmentrecap">Environment recap</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Currentproblems">Current problems</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Environmentinthereducer">Environment in the reducer</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Environmentinthestore">Environment in the store</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="#Erasingtheenvironmentfromthestore">Erasing the environment from the store</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 91: Dependency Injection Made Composable -->
<h2 id="1-a-nameintroductionaintroduction">1. <a name='Introduction'></a>Introduction</h2>
<p>åœ¨å»å¹´å¼•å…¥å¯ç»„åˆä½“ç³»ç»“æ„æ—¶ï¼Œæˆ‘ä»¬ç‰¹åˆ«å¼ºè°ƒäº†å‰¯ä½œç”¨å’Œæµ‹è¯•ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ç”¨äº†æ•´æ•´8é›†çš„æ—¶é—´æ¥è®¨è®ºè¿™äº›è¯é¢˜ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸ªæ¶æ„éƒ½éœ€è¦æœ‰ä¸€ä¸ªå…³äºå‰¯ä½œç”¨çš„æ•…äº‹:è¿™åªæ˜¯ç”Ÿæ´»ä¸­çš„ä¸€ä¸ªäº‹å®ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦å¼•å…¥å‰¯ä½œç”¨ï¼Œå°±æœ‰ç ´åå¯æµ‹è¯•æ€§çš„é£é™©ã€‚</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®©å‰¯ä½œç”¨å’Œå¯æµ‹è¯•æ€§å’Œè°å…±å­˜ï¼Œé€šè¿‡ä½¿ç”¨ä¸€ç§æˆ‘ä»¬åœ¨è¿‘ä¸¤å¹´å‰è°ˆåˆ°çš„è€æŠ€æœ¯:<strong>environment</strong>ã€‚ç¯å¢ƒæä¾›äº†ä¸€ä¸ªåœ°æ–¹æ¥æ”¾ç½®æ‰€æœ‰å¯èƒ½å¯¼è‡´å‰¯ä½œç”¨çš„ä¸œè¥¿ï¼Œå¹¶ä¸”æˆ‘ä»¬ç¦æ­¢è‡ªå·±ä½¿ç”¨ä»»ä½•ä¾èµ–é¡¹ï¼Œé™¤éå®ƒå­˜å‚¨åœ¨ç¯å¢ƒä¸­ã€‚è¿™ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ä¸€è‡´çš„è®¿é—®ä¾èµ–é¡¹çš„æ–¹å¼ï¼Œå¹¶ä¸”ä½¿å¾—åœ¨æµ‹è¯•å’Œ<strong>playgrounds</strong>ä¸­å°†ä¾èµ–é¡¹æ›¿æ¢ä¸ºå—æ§ä¾èµ–é¡¹å˜å¾—å¾ˆç®€å•ï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨è¿è¡Œå®é™…åº”ç”¨ç¨‹åºæ—¶ä½¿ç”¨æ¨¡æ‹Ÿä¾èµ–é¡¹ã€‚ å¦‚æœä½ æ— ç½‘çŠ¶æ€ï¼Œæˆ–è€…æƒ³è¦åœ¨ä¸€ä¸ªéå¸¸ç‰¹å®šçš„çŠ¶æ€ä¸‹æµ‹è¯•ä½ çš„åº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½ç‰¹åˆ«æœ‰ç”¨ã€‚</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¹¶ä¸æ˜¯å…¨éƒ¨ã€‚å®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½å·¥ä½œå¾—å¾ˆå¥½ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªæ›´åŠ å¥å£®å’Œé€šç”¨çš„è§£å†³æ–¹æ¡ˆæ¥è§£å†³å¯ç»„åˆä½“ç³»ç»“æ„ä¸­çš„ä¾èµ–å…³ç³»é—®é¢˜ã€‚ä¸ºäº†çœ‹åˆ°è¿™ä¸€åˆ‡ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å¯¹<strong>reducer</strong>çš„ç­¾ååšä¸€ä¸ªéå¸¸å°çš„è°ƒæ•´ï¼Œä¸€åˆ‡éƒ½ä¼šè‡ªç„¶åœ°éšä¹‹è€Œæ¥ã€‚</p>
<p>ä½†åœ¨æˆ‘ä»¬è¿›å…¥è¿™ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æé†’è‡ªå·±æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨<strong>environment</strong>æŠ€æœ¯æ¥æ§åˆ¶å’Œæµ‹è¯•æˆ‘ä»¬çš„å‰¯ä½œç”¨çš„ã€‚</p>
<h2 id="2-a-nameeffectsrecapaeffects-recap">2. <a name='Effectsrecap'></a>Effects recap</h2>
<p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨å¯ç»„åˆä½“ç³»ç»“æ„ä¸­è¡¨ç¤ºå‰¯ä½œç”¨çš„æ–¹å¼æ˜¯ä»æˆ‘ä»¬çš„<strong>reducer</strong>è¿”å›ä¸€ä¸ª<strong>effect</strong>å€¼æ•°ç»„ï¼Œç„¶ååœ¨å¹•å<strong>store</strong>è´Ÿè´£è·å–æ‰€æœ‰è¿™äº›<strong>effects</strong>å¹¶è¿è¡Œå®ƒä»¬ã€‚</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p><strong>Effect</strong>æ˜¯æˆ‘ä»¬æ„å»ºçš„è‡ªå®šä¹‰ç±»å‹ï¼Œå®ƒç¬¦åˆ<strong>Combine</strong>æ¡†æ¶ä¸­çš„<strong>Publisher</strong>åè®®:</p>
<pre><code class="language-swift">public struct Effect&lt;Output&gt;: Publisher {
  public typealias Failure = Never

  let publisher: AnyPublisher&lt;Output, Failure&gt;

  public func receive&lt;S&gt;(
    subscriber: S
  ) where S: Subscriber, Failure == S.Failure, Output == S.Input {
    self.publisher.receive(subscriber: subscriber)
  }
}
</code></pre>
<p>è¿™å…è®¸æˆ‘ä»¬åˆ©ç”¨<strong>Combine</strong>æ¥æå‡æˆ‘ä»¬çš„<strong>effects</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬çš„åŠ©æ‰‹æ¥æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œåœ¨æ¨¡å‹ä¸­è§£ç JSONï¼Œå®šæ—¶å™¨ï¼Œä»¥åŠæ‰€æœ‰ä½ å¯ä»¥ä¸<strong>publishers</strong>åšçš„æœ‰è¶£çš„è½¬æ¢ï¼Œå¦‚<strong>map, zip, flatMapï¼Œfilter</strong>ç­‰ç­‰ã€‚</p>
<p>æˆ‘ä»¬çš„<strong>Effect</strong>åªæ˜¯ç®€å•åœ°åŒ…è£…äº†ä¸€ä¸ªç°æœ‰çš„<strong>publisher</strong>ï¼Œæˆ‘ä»¬è¿™æ ·åšæ˜¯å› ä¸ºæˆ‘ä»¬æƒ³æ·»åŠ è‡ªå·±çš„æ–¹ä¾¿åŠ©æ‰‹ï¼Œè€Œä¸æ±¡æŸ“å…¶ä»–æ‰€æœ‰äººçš„<strong>publisher</strong>APIã€‚æˆ‘ä»¬æœ‰åƒ<strong>fireAndForget</strong>å‡½æ•°è¿™æ ·çš„åŠ©æ‰‹:</p>
<pre><code class="language-swift">extension Effect {
  public static func fireAndForget(work: @escaping () -&gt; Void) -&gt; Effect {
    return Deferred { () -&gt; Empty&lt;Output, Never&gt; in
      work()
      return Empty(completeImmediately: true)
    }.eraseToEffect()
  }
}
</code></pre>
<p>è¿™è®©æˆ‘ä»¬å¯ä»¥è§¦å‘ä¸€ä¸ªéœ€è¦åšä¸€äº›å·¥ä½œçš„å‰¯ä½œç”¨ï¼Œä½†ä¸éœ€è¦å‘ç³»ç»Ÿåé¦ˆä»»ä½•æ•°æ®ã€‚è¿™æ–¹é¢çš„ä¾‹å­å¯ä»¥æ˜¯æ—¥å¿—è®°å½•å’Œåˆ†æè·Ÿè¸ªï¼Œæˆ‘ä»¬ç”šè‡³ä½¿ç”¨è¿™ç§é£æ ¼æ•ˆæœå°†æ•°å­—åˆ—è¡¨ä¿å­˜åˆ°ç£ç›˜ä¸Šã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ª<strong>helper</strong>æ¥æ‰§è¡Œä¸€äº›åŒæ­¥å·¥ä½œï¼Œåœ¨æˆ‘ä»¬éœ€è¦ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„æ—¶å€™ï¼Œä½†å®ƒä¸ä¸€å®šéœ€è¦å¼‚æ­¥å®Œæˆ:</p>
<pre><code class="language-swift">extension Effect {
  public static func sync(work: @escaping () -&gt; Output) -&gt; Effect {
    return Deferred {
      Just(work())
    }.eraseToEffect()
  }
}
</code></pre>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥æ‰§è¡Œä»ç£ç›˜åŠ è½½ä¸€äº›æ•°æ®çš„æ•ˆæœã€‚</p>
<p>æ›´æ™®éçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>Combine</strong>ä¸­è‡ªç”±ä½¿ç”¨ä»»ä½•apiæ¥æ„é€ å’Œè½¬æ¢<strong>publishers</strong>ï¼Œç„¶ååœ¨å·¥ä½œçš„æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨<strong>eraseToEffect</strong>åŠ©æ‰‹å°†ä½ çš„<strong>publisher</strong>è½¬æ¢æˆä¸€ä¸ª<strong>effect</strong> :</p>
<pre><code class="language-swift">extension Publisher where Failure == Never {
  public func eraseToEffect() -&gt; Effect&lt;Output&gt; {
    return Effect(publisher: self.eraseToAnyPublisher())
  }
}
</code></pre>
<p>æˆ‘ä»¬å°†è¿™äº›<strong>effects</strong>å¼•å…¥åº”ç”¨ç¨‹åºçš„æ–¹æ³•æ˜¯æ„é€ å¹¶ä»<strong>reducer</strong>è¿”å›å®ƒä»¬ã€‚</p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³åœ¨ç‚¹å‡»å‡é‡æŒ‰é’®æ—¶åœ¨è®¡æ•°å™¨è§†å›¾ä¸­æ‰“å°ä¸€äº›ä¸œè¥¿ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿”å›ä¸€ä¸ª<strong>fireAndForget</strong>æ•ˆæœæ¥è¿›è¡Œæ‰“å°:</p>
<pre><code class="language-swift">public func counterReducer(state: inout CounterState, action: CounterAction) -&gt; [Effect&lt;CounterAction&gt;] {
  switch action {
  case .decrTapped:
    state.count -= 1
    return [
      .fireAndForget {
        print(state.count)
      }
    ]
</code></pre>
<blockquote>
<p>ğŸ›‘ Escaping closure captures â€˜inoutâ€™ parameter â€˜stateâ€™</p>
</blockquote>
<p>è¿™ç°åœ¨ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨è¯•å›¾è®¿é—®é€ƒé€¸é—­åŒ…ä¸­çš„<strong>inout</strong>çŠ¶æ€å˜é‡ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é”™è¯¯ï¼Œå› ä¸ºå¦‚æœSwiftå…è®¸è¿™æ ·åšï¼Œå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ç¨åæ‰§è¡Œçš„é—­åŒ…ä¸­æ”¹å˜æˆ‘ä»¬çš„çŠ¶æ€ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªé—­åŒ…å¯ä»¥åœ¨åˆ›å»ºåçš„10ç§’å†…æ‰§è¡Œï¼Œè¿™æ„å‘³ç€ä¸€äº›ç¥ç§˜çš„çªå˜æ­£åœ¨<strong>reducer</strong>æƒé™ä¹‹å¤–å‘ç”Ÿï¼Œè€Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦åœ¨æ¶æ„ä¸­é˜²æ­¢çš„ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬åœ¨é—­åŒ…å¤–éƒ¨å¾—åˆ°ä¸€ä¸ªä¸å¯å˜çš„è®¡æ•°å¼•ç”¨ï¼Œä¸€åˆ‡éƒ½ä¼šæ­£å¸¸å·¥ä½œ:</p>
<pre><code class="language-swift">case .decrTapped:
  state.count -= 1
  let count = state.count
  return [
    .fireAndForget {
      print(count)
    }
  ]
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æƒ³åšä¸€äº›æ›´å¤æ‚çš„äº‹æƒ…å‘¢? å¦‚æœåœ¨ç‚¹å‡»å‡é‡æŒ‰é’®ä¹‹åï¼Œæˆ‘ä»¬æƒ³è¦ç­‰å¾…1ç§’ï¼Œç„¶åå¢åŠ è®¡æ•°å‘¢? è¿™å½“ç„¶æ˜¯ä¸€ä»¶æ„šè ¢çš„äº‹æƒ…ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªç›¸å½“å¤æ‚çš„æ•ˆæœæƒ³è¦å¤„ç†ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨<strong>Combine</strong>æ¡†æ¶:</p>
<pre><code class="language-swift">return [
  .fireAndForget {
    print(&quot;Decr Tapped!&quot;, count)
  },

  Just(.incrTapped)
    .delay(for: 1, scheduler: DispatchQueue.main)
    .eraseToEffect()
]
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æƒ³è¦å‘é€çš„åŠ¨ä½œå°è£…åˆ°ä¸€ä¸ª<strong>Just publisher</strong>ä¸­ï¼Œè¿™ä¸ª<strong>publisher</strong>ä¼šç«‹å³å‘å‡ºå®ƒçš„å€¼ã€‚ç„¶åæˆ‘ä»¬å°†å®ƒçš„å‘å°„å»¶è¿Ÿ1ç§’ï¼Œå¹¶æœ€ç»ˆæŠŠ<strong>publisher</strong> ç±»å‹æ“¦é™¤ä¸ºä¸€ä¸ª<strong>effect</strong>ã€‚</p>
<p>è¿™ä¸‰è¡Œä»£ç å¾ˆæœ‰å†²å‡»åŠ›ï¼Œæ„å‘³ç€ç°åœ¨å¦‚æœæˆ‘ä»¬è¿è¡Œåº”ç”¨ï¼Œæ¯æ¬¡æˆ‘ä»¬å°è¯•å‡å°‘å®ƒéƒ½ä¼šåœ¨ä¸€ç§’åæ’¤é”€ã€‚å³ä½¿æˆ‘ä»¬å¤šæ¬¡ç‚¹å‡»å®ƒï¼Œå®ƒæœ€ç»ˆä¹Ÿä¼šæŠµæ¶ˆæ‰æ‰€æœ‰çš„å·¥ä½œã€‚</p>
<h2 id="3-a-nameenvironmentrecapaenvironment-recap">3. <a name='Environmentrecap'></a>Environment recap</h2>
<p>è¿™å°±æ˜¯<strong>effects</strong>ã€‚å®ƒä»¬è®©æˆ‘ä»¬èƒ½å¤Ÿå®Œæˆéœ€è¦ä¸å¤–ç•Œäº’åŠ¨çš„å·¥ä½œï¼Œè€Œè¿™äº›å·¥ä½œæ˜¯ç”±<strong>reducers</strong>è‡ªå·±æ— æ³•å®Œæˆçš„ã€‚ä½†å‰¯ä½œç”¨ä¹Ÿå¾ˆéš¾æµ‹è¯•ï¼Œæ‰€ä»¥ä¸ºäº†æ§åˆ¶æˆ‘ä»¬çš„å½±å“ï¼Œæˆ‘ä»¬è½¬å‘äº†<strong>environment</strong>æŠ€æœ¯ã€‚</p>
<p>ä¸ºäº†é‡‡ç”¨è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ª<strong>environment</strong>ç»“æ„ï¼Œå®ƒåŒ…å«æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦è®¿é—®çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚ä¾‹å¦‚ï¼Œ<strong>Counter</strong>æ¨¡å—åªéœ€è¦è®¿é—®ä¸€ä¸ªç”¨äºè®¡ç®—â€œç¬¬nä¸ªç´ æ•°â€çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šå¸¸ä¼šå‘ä¸€ä¸ªå¼ºå¤§çš„è®¡ç®—å¹³å°<strong>Wolfram Alpha</strong>å‘å‡ºç½‘ç»œè¯·æ±‚:</p>
<pre><code class="language-swift">struct CounterEnvironment {
  var nthPrime: (Int) -&gt; Effect&lt;Int?&gt;
}
</code></pre>
<p>æˆ‘ä»¬å°†è¿™ä¸ªå­—æ®µè®¾ç½®ä¸º<strong>var</strong>ï¼Œå› ä¸ºå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨<strong>testsã€playgroundså’Œstaged applications</strong>ä¸­å°†å®æ—¶ä¾èµ–é¡¹æ›¿æ¢ä¸ºæ¨¡æ‹Ÿä¾èµ–é¡¹ã€‚</p>
<p>ä½œä¸ºè¿™é¡¹æŠ€æœ¯çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¹Ÿå–œæ¬¢æä¾›å¯¹ç¯å¢ƒçš„å®æ—¶å’Œæ¨¡æ‹Ÿå®ç°çš„ç®€å•è®¿é—®ï¼Œè¡¨ç¤ºä¸ºé™æ€:</p>
<pre><code class="language-swift">extension CounterEnvironment {
  static let live = CounterEnvironment(nthPrime: Counter.nthPrime)
}

extension CounterEnvironment {
  static let mock = CounterEnvironment(nthPrime: { _ in .sync { 17 }})
}
</code></pre>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™äº›ä¼¼ä¹éƒ½æ²¡æœ‰äº‰è®®ï¼Œä½†æ¥ä¸‹æ¥æˆ‘ä»¬åšäº†ä¸€äº›éå¸¸å¥‡æ€ªçš„äº‹æƒ…:æˆ‘ä»¬å®šä¹‰äº†è¿™ä¸ª<strong>environment</strong>çš„å…¨å±€å¯å˜å®ä¾‹ï¼Œé»˜è®¤ä¸º<strong>live environment</strong>:</p>
<pre><code class="language-swift">var Current = CounterEnvironment.live
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¼ºè¿«è‡ªå·±æ°¸è¿œä¸è¦æ¥è§¦<strong>dependency</strong>ï¼Œé™¤éå®ƒå­˜å‚¨åœ¨<strong>environment</strong>ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®è¯¢é—®â€œç¬¬nä¸ªè´¨æ•°â€æ˜¯ä»€ä¹ˆæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡å½“å‰<strong>environment</strong>æ‰§è¡Œ<strong>effect</strong>:</p>
<pre><code class="language-swift">case .nthPrimeButtonTapped:
  state.isNthPrimeButtonDisabled = true
  return [
    Current.nthPrime(state.count)
      .map(CounterAction.nthPrimeResponse)
      .receive(on: DispatchQueue.main)
      .eraseToEffect()
]
</code></pre>
<p>è¿™ä¸ªå¯å˜å˜é‡å¯èƒ½çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œä½†å®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸€è¡Œä¸­è½»æ¾æ¨¡æ‹Ÿæ•´ä¸ªç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œåœ¨è®¡æ•°å™¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬åœ¨<strong>setUp</strong>å—ä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œ:</p>
<pre><code class="language-swift">class CounterTests: XCTestCase {
  override func setUp() {
    super.setUp()
    Current = .mock
  }
}
</code></pre>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿è¯æ¯ä¸ªæµ‹è¯•è¿è¡Œåœ¨ä¸€ä¸ªå—æ§åˆ¶çš„ç¯å¢ƒä¸­ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é‡å†™ä»»ä½•ä¾èµ–é¡¹æ¥è¿›ä¸€æ­¥è°ƒæ•´æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­çš„ç¯å¢ƒï¼Œä¾‹å¦‚:</p>
<pre><code class="language-swift">func testNthPrimeButtonHappyFlow() {
  Current.nthPrime = { _ in .sync { 17 } }

  assert(
</code></pre>
<h2 id="4-a-namecurrentproblemsacurrent-problems">4. <a name='Currentproblems'></a>Current problems</h2>
<p>è¿™å°±æ˜¯ç¯å¢ƒæŠ€æœ¯çš„å·¥ä½œåŸç†ã€‚å®ƒéå¸¸å®¹æ˜“ä¸Šæ‰‹ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å•ä¸€çš„ã€ä¸€è‡´çš„æ–¹å¼æ¥è®¿é—®æˆ‘ä»¬çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶æ¨¡æ‹Ÿæ‰€æœ‰çš„ä¾èµ–å…³ç³»æ˜¯å¾®ä¸è¶³é“çš„ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™å¹¶ä¸æ˜¯æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>ä¹Ÿè®¸æœ€æ˜æ˜¾çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å®šä¹‰çš„æ¯ä¸ª<strong>environments</strong>éƒ½ä½äºå®ƒä»¬è‡ªå·±çš„æ¨¡å—ä¸­ï¼Œå› æ­¤æ˜¯å®Œå…¨æ–­å¼€è¿æ¥çš„ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬å¯¹æ¶æ„çš„ç»„åˆå‡é€Ÿå™¨æ–¹æ³•çš„å¥½å¤„ä¹‹ä¸€æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ç±»ä¼¼é›†æˆçš„æµ‹è¯•ï¼Œä¸€æ¬¡æµ‹è¯•åº”ç”¨ç¨‹åºçš„å¤šä¸ªå±‚ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªæµ‹è¯•ï¼Œè¡¨æ˜è®¡æ•°å™¨ç‰¹å¾å’Œç´ æ•°æ¨¡æ€ç‰¹å¾æ­£ç¡®é›†æˆã€‚ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†è¿™æ ·ä¸€ä¸ªæƒ³æ³•:ç”¨æˆ·å°†è®¡æ•°å™¨åŠ 1ï¼Œç„¶åä»ä»–ä»¬å–œæ¬¢çš„è´¨æ•°ä¸­æ·»åŠ æˆ–åˆ é™¤è¿™ä¸ªæ•°å­—ã€‚ä»£ç æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-swift">func testPrimeModal() {
  assert(
    initialValue: CounterViewState(
      count: 1,
      favoritePrimes: [3, 5]
    ),
    reducer: counterViewReducer,
    steps:
    Step(.send, .counter(.incrTapped)) {
      $0.count = 2
    },
    Step(.send, .primeModal(.saveFavoritePrimeTapped)) {
      $0.favoritePrimes = [3, 5, 2]
    },
    Step(.send, .primeModal(.removeFavoritePrimeTapped)) {
      $0.favoritePrimes = [3, 5]
    }
  )
}
</code></pre>
<p>è¿™æ˜¯ä¸å¯æ€è®®çš„å¼ºå¤§ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šä»æˆ‘ä»¬çš„å¯ç»„åˆ<strong>reducers</strong>å…è´¹å¾—åˆ°å®ƒã€‚</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨è¿™ä¸ªæ­¥éª¤è„šæœ¬ä¸­æµ‹è¯•ä»»ä½•æ•ˆæœï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°å…¨è²Œã€‚ç°åœ¨åªæœ‰<strong>Counter</strong>æ¨¡å—æœ‰ä»»ä½•æ•ˆæœï¼Œ<strong>PrimeModal</strong>æ¨¡å—æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œæ‰€ä»¥å¾ˆéš¾çœ‹å‡ºè¿™é‡Œçš„å¤æ‚æ€§ã€‚ä¸ºäº†æ¨¡æ‹Ÿæ‰€æœ‰çš„<strong>effects</strong>ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯:</p>
<pre><code class="language-swift">func testPrimeModal() {
  Current = .mock

  assert(
</code></pre>
<p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è€ƒè™‘ä¸ºæˆ‘ä»¬çš„ä¸»è¦åº”ç”¨ç›®æ ‡ç¼–å†™é›†æˆæµ‹è¯•ï¼Œå³å°†æ‰€æœ‰å†…å®¹ç»„åˆåˆ°ä¸€ä¸ªå¤§<strong>appReducer</strong>ä¸­ï¼Œæˆ‘ä»¬å°†æ›´å¥½åœ°äº†è§£éœ€è¦ä»€ä¹ˆã€‚è®©æˆ‘ä»¬é¦–å…ˆæ¸…ç†PrimeTimeTestsæ–‡ä»¶:</p>
<pre><code class="language-swift">import XCTest
@testable import PrimeTime

class PrimeTimeTests: XCTestCase {
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æƒ³ä¸ºæ­¤ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¼å…¥æ‰€æœ‰çš„åŠŸèƒ½:</p>
<pre><code class="language-swift">@testable import Counter
@testable import FavoritePrimes
@testable import PrimeModal
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªæµ‹è¯•å‡½æ•°:</p>
<pre><code class="language-swift">class PrimeTimeTests: XCTestCase {
  func testIntegration() {
  }
}
</code></pre>
<p>ç°åœ¨ï¼Œåœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦ç¡®ä¿æˆ‘ä»¬å¤„äºä¸€ä¸ªå®Œå…¨å—æ§çš„ç¯å¢ƒä¸­ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿæ¯ä¸ªæ¨¡å—çš„ç¯å¢ƒã€‚ è¿™æ„å‘³ç€<strong>Counter</strong>æ¨¡å—å’Œ<strong>FavoritePrimes</strong>æ¨¡å—:</p>
<pre><code class="language-swift">class PrimeTimeTests: XCTestCase {
  func testIntegration() {
    Counter.Current = .mock
    FavoritePrimes.Current = .mock
  }
}
</code></pre>
<p>è¿™æœ‰ç‚¹ä»¤äººå¤±æœ›ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰ä»ç¼–è¯‘å™¨é‚£é‡Œå¾—åˆ°ä»»ä½•é™æ€å¸®åŠ©æ¥ç¡®ä¿æˆ‘ä»¬æ­£ç¡®åœ°æ‰§è¡Œäº†è¿™ä¸ªæ“ä½œã€‚éšç€æˆ‘ä»¬å‘åº”ç”¨ç¨‹åºæ·»åŠ è¶Šæ¥è¶Šå¤šçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ–°çš„æ¨¡å—æ¥å®¹çº³è¿™äº›ç‰¹æ€§ï¼Œæ¯ä¸ªæ¨¡å—éƒ½å°†æ‹¥æœ‰<strong>environments</strong>ï¼Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ä¼šè¿«ä½¿æˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬å·²ç»æ¨¡æ‹Ÿå‡ºäº†è¿™äº›<strong>environments</strong>ã€‚æˆ‘ä»¬å†’ç€åœ¨æµ‹è¯•æœŸé—´è°ƒç”¨æ´»åŠ¨ä¾èµ–é¡¹çš„é£é™©ã€‚</p>
<p>è¿™å¯¹ä½ å’Œä½ çš„å›¢é˜Ÿæ¥è¯´å¯èƒ½ä¸æ˜¯æœ€å¤§çš„é—®é¢˜ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥æŠŠä¸€äº›æµç¨‹æ”¾åˆ°åˆé€‚çš„åœ°æ–¹ï¼Œå¸®åŠ©æ•æ‰è¿™æ ·çš„äº‹æƒ…ã€‚ä½†è¿™æ˜¯éœ€è¦è®°ä½çš„ï¼Œç†æƒ³æƒ…å†µä¸‹åº”è¯¥æœ‰ä¸€ä¸ªæ›´æ™®éçš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>è¿™ç§æ–¹æ³•çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œè·¨æ¨¡å—å…±äº«ä¾èµ–é¡¹å¹¶ä¸å®¹æ˜“ã€‚ä¾‹å¦‚ï¼Œ<strong>FavoritePrimes</strong>æ¨¡å—æŒæœ‰ä¸€ä¸ª<strong>FileClient</strong>ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥ä¿å­˜å’ŒåŠ è½½æ•°æ®åˆ°ç£ç›˜ã€‚å¦‚æœæˆ‘ä»¬æƒ³åœ¨å¦ä¸€ä¸ªæ¨¡å—ä¸­ä½¿ç”¨åŒæ ·çš„ä¾èµ–ï¼Œæˆ‘ä»¬å¾ˆå¯èƒ½å¿…é¡»æ„é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶å®¢æˆ·ç«¯å¹¶åœ¨è¯¥æ¨¡å—ä¸­ä½¿ç”¨å®ƒã€‚å¦åˆ™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ›´é«˜çš„å±‚æ¬¡ä¸Šè¿›è¡Œä¸€äº›åè°ƒã€‚ä¾‹å¦‚ï¼Œåœ¨åº”ç”¨ç¨‹åºå§”æ‰˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›é¢å¤–çš„å·¥ä½œï¼Œä»¥ç¡®ä¿<strong>FavoritePrimes</strong>æ¨¡å—å’Œå…¶ä»–æ¨¡å—å…±äº«ç›¸åŒçš„æ–‡ä»¶å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬è¿˜å¿…é¡»ç¡®ä¿åœ¨æµ‹è¯•ä¸­åšåŒæ ·çš„å·¥ä½œï¼Œä»¥ç¡®ä¿æ‰€æœ‰æ¨¡å—éƒ½ä½¿ç”¨ç›¸åŒçš„ä¾èµ–é¡¹è¿›è¡Œæµ‹è¯•ã€‚ è¿™æ˜¯æœ‰å¯èƒ½è§£å†³çš„ï¼Œä½†ç†æƒ³æƒ…å†µä¸‹ä¼šæœ‰ä¸€ä¸ªæ›´æ™®éçš„è§£å†³æ–¹æ¡ˆï¼Œ</p>
<p>æœ€åï¼Œè¿™ç§å½¢å¼çš„<strong>environment</strong>æŠ€æœ¯çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæ¨¡å—ä¸­æ‰€æœ‰äº‹ç‰©çš„å®ä¾‹åªèƒ½ä½¿ç”¨è¯¥<strong>environment</strong>ä¸­çš„ä¸€ä¸ªçœŸå®<strong>environment</strong>ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸èƒ½åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨è§†å›¾ï¼Œå®ƒä½¿ç”¨<strong>Wolfram API</strong>æ¥åšå®ƒçš„è®¡ç®—ï¼Œä½†åŒæ—¶ä¹Ÿåˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨è§†å›¾ï¼Œå®ƒä½¿ç”¨ä¸€äº›å…¶ä»–APIæ¥åšå®ƒçš„è®¡ç®—ã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ¯ä¸ªæ¨¡å—ä¸­çš„ä»£ç çš„çµæ´»æ€§æœ‰æ‰€é™ä½ã€‚</p>
<p>æ‰€æœ‰è¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥æ˜¾å¼åœ°å°†ä¾èµ–å…³ç³»ä¼ é€’ç»™éœ€è¦è¿™äº›ä¾èµ–å…³ç³»çš„å‡½æ•°ã€‚å¦‚æœæ‚¨ä¸ºä¸€ä¸ªå‡½æ•°æä¾›äº†å®Œæˆå…¶å·¥ä½œæ‰€éœ€çš„ä¸€åˆ‡ï¼Œé‚£ä¹ˆæµ‹è¯•å’Œæ§åˆ¶å®ƒä»¬å°±å¾ˆç®€å•äº†ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™å¹¶ä¸æ€»æ˜¯å¯èƒ½æˆ–å®¹æ˜“åšåˆ°çš„ã€‚åœ¨ç°å®ä¸–ç•Œçš„ä»£ç åŸºç¡€ä¸­ï¼Œå¯èƒ½éš¾ä»¥ç½®ä¿¡åœ°æˆ–ç”šè‡³ä¸å¯èƒ½åƒæ‚¨å¸Œæœ›çš„é‚£æ ·ä¼ é€’ä¾èµ–å…³ç³»ã€‚æ‚¨å¯èƒ½æœ‰é—ç•™çš„ä»£ç ä½¿å®ƒå˜å¾—å›°éš¾ï¼Œæˆ–è€…æ‚¨å¯èƒ½æœ‰æŠ½è±¡å±‚é˜»æ­¢æ‚¨åšæ‚¨æƒ³åšçš„äº‹æƒ…ã€‚è¿™å°±æ˜¯ç¯å¢ƒæŠ€æœ¯çœŸæ­£å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚å®ƒå…è®¸æ‚¨åœ¨ä»»ä½•ä»£ç åº“ä¸­ç«‹å³è·å¾—ä¸€äº›å¯æµ‹è¯•æ€§å’Œå¯¹ä¾èµ–é¡¹çš„ä¸€äº›æ§åˆ¶ã€‚</p>
<h2 id="5-a-nameenvironmentinthereduceraenvironment-in-the-reducer">5. <a name='Environmentinthereducer'></a>Environment in the reducer</h2>
<p>ç„¶è€Œï¼Œå¯¹äºå¯ç»„åˆä½“ç³»ç»“æ„ï¼Œæƒ…å†µæœ‰äº›ä¸åŒã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å•ä¸€ã€ä¸€è‡´çš„æ–¹å¼æ¥æ„å»ºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç‰¹æ€§ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥è®©æ¶æ„æ„è¯†åˆ°ç¯å¢ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸éœ€è¦æ¥è§¦å…¨å±€ç¯å¢ƒï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨åœ°ä½¿ç”¨å®ƒã€‚</p>
<p>é¦–å…ˆè¦åšçš„æ˜¯<strong>reducer</strong>ï¼Œå› ä¸º<strong>reducer</strong>è´Ÿè´£äº§ç”Ÿåæ¥ç”±<strong>store</strong>è¿è¡Œçš„<strong>effects</strong>ã€‚ä¸ºäº†ä½¿è¿™äº›<strong>effects</strong>æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬éœ€è¦ä»¥å¯æ§çš„æ–¹å¼è®¿é—®å®ƒçš„ä¾èµ–å…³ç³»ã€‚ä¹‹å‰æˆ‘ä»¬æ¥è§¦äº†æ¨¡å—çš„ç¯å¢ƒï¼Œä½†æ˜¯å¦‚æœ<strong>reducer</strong>å†…éƒ¨æœ‰ä¸€ä¸ªå¯ç”¨çš„ç¯å¢ƒå‘¢?</p>
<p>æˆ‘ä»¬çš„<strong>reducer</strong>ä¸æ˜¯è¿™æ ·çš„</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>æˆ‘ä»¬å°†ä½¿<strong>reducer</strong>åœ¨å½“å‰å€¼å’ŒåŠ¨ä½œä¹‹å¤–æä¾›ä¸€ä¸ªç¯å¢ƒï¼Œè¿™æ„å‘³ç€å¼•å…¥å¦ä¸€ä¸ªæ³›å‹:</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action, Environment&gt; = (inout Value, Action) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ç§é€šç”¨çš„ä¸€ç§æ–¹æ³•æ˜¯å¯¹<strong>reducer</strong>è¿›è¡Œ<strong>curry</strong>å¤„ç†ï¼Œè¿™æ ·é¦–å…ˆç»™å®ƒä¸€ä¸ªç¯å¢ƒï¼Œç„¶åå®ƒå°†è¿”å›ä¸€ä¸ªä¼ ç»Ÿçš„<strong>reducer</strong>ç­¾å:</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action, Environment&gt; = (Environment) -&gt; (inout Value, Action) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>è¿™æ˜¯å®Œå…¨æœ‰æ•ˆçš„ï¼Œäº‹å®ä¸Šï¼Œè¿™æ˜¯æˆ‘ä»¬å¦‚ä½•æ§åˆ¶å‰¯ä½œç”¨åœ¨æˆ‘ä»¬çš„<a href="https://www.pointfree.co/episodes/ep2-side-effects">ç¬¬äºŒé›†Point-Free</a>ã€‚åœ¨é‚£ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªæ—¥æœŸå€¼æ”¾å…¥å‡½æ•°ä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å®ƒã€‚</p>
<p>ç„¶è€Œï¼Œå¯¹<strong>reducer</strong>ä½¿ç”¨è¿™ä¸ªç­¾åå°†æ„å‘³ç€æ€»æ˜¯ä»æˆ‘ä»¬çš„<strong>reducer</strong>è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™å°†åœ¨ä¸€æ®µæ—¶é—´åå˜å¾—å¾ˆçƒ¦äººã€‚ å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªç­‰ä»·çš„å…¬å¼ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ç¯å¢ƒä¸­é€šè¿‡<strong>stateå’Œaction</strong>:</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action, Environment&gt; = (inout Value, Action, Environment) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠå‡½æ•°å¾€å¦ä¸€ä¸ªæ–¹å‘<strong>curry</strong>:</p>
<pre><code class="language-swift">//public typealias Reducer&lt;Value, Action, Environment&gt; = (inout Value, Action) -&gt; (Environment) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>æˆ‘ä»¬ä¸ä¼šé‚£æ ·åšï¼Œä½†å®ƒä¹Ÿæ˜¯å®šä¹‰<strong>reducers</strong>çš„æœ‰æ•ˆæ–¹æ³•ï¼Œæˆ‘ä»¬æœ‰ç»ƒä¹ æ¥æ¢ç´¢è¿™ä¸ªã€‚</p>
<p>è¿™ä¸ª<strong>Environment</strong>é€šç”¨å‹ä½¿æˆ‘ä»¬æœ‰æœºä¼šæä¾›<strong>reducer</strong>æ‰€éœ€çš„ä»»ä½•ä¾èµ–é¡¹ï¼Œä»¥äº§ç”Ÿå¢å¼ºå…¶é€»è¾‘çš„æ•ˆæœã€‚</p>
<p>è¿™å½“ç„¶ä¼šç ´åå¾ˆå¤šä¸œè¥¿ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹ä¿®å¤ã€‚è®©æˆ‘ä»¬é¦–å…ˆå…³æ³¨<strong>ComposableArchitecture</strong>æ¨¡å—ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯æ˜¯åœ¨<strong>combine</strong>å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°å–ä¸€å †ç›¸åŒç±»å‹çš„<strong>reducer</strong>å¹¶å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªå·¨å‹çš„<strong>reducer</strong>ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥ç¯å¢ƒæ³›å‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™æ¯ä¸€ä¸ª<strong>sub-reducers</strong>:</p>
<pre><code class="language-swift">public func combine&lt;Value, Action, Environment&gt;(
  _ reducers: Reducer&lt;Value, Action, Environment&gt;...
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return { value, action, environment in
    let effects = reducers.flatMap { $0(&amp;value, action, environment) }
    return effects
  }
}
</code></pre>
<p>å¾ˆç®€å•ã€‚æ¥ä¸‹æ¥æ˜¯<strong>pullback</strong>ï¼Œå®ƒç°åœ¨é‡åˆ°äº†éº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä»¬å†æ¬¡éœ€è¦è€ƒè™‘æ–°ç¯å¢ƒçš„é€šç”¨æƒ…å†µã€‚æœ€ç®€å•çš„è§£å†³æ–¹æ³•æ˜¯å¼•å…¥ä¸€ä¸ª<strong>Environment</strong>æ³›å‹ï¼Œå¹¶åœ¨æ‰§è¡Œ<strong>pullback</strong>æ—¶å°†<strong>Environment</strong>ä¼ é€’ç»™æœ¬åœ°<strong>reducer</strong>ã€‚</p>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction, Environment&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction, Environment&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: CasePath&lt;GlobalAction, LocalAction&gt;
) -&gt; Reducer&lt;GlobalValue, GlobalAction, Environment&gt; {
  return { globalValue, globalAction, environment in
    guard let localAction = action.extract(globalAction) else { return [] }
    let localEffects = reducer(&amp;globalValue[keyPath: value], localAction, environment)

    return localEffects.map { localEffect in
      localEffect.map(action.embed)
        .eraseToEffect()
    }
  }
}
</code></pre>
<p>è¿™å¯ä»¥æ­£å¸¸<strong>build</strong>ï¼Œä½†å¹¶ä¸ç†æƒ³ã€‚ <strong>reducers</strong>ä¸Šçš„<strong>pullback</strong>æ“ä½œå®Œå…¨æ˜¯å…³äºèƒ½å¤Ÿå°†åœ¨å±€éƒ¨åŸŸä¸Šå·¥ä½œçš„<strong>reducers</strong>è½¬æ¢ä¸ºåœ¨å…¨å±€åŸŸä¸Šå·¥ä½œçš„<strong>reducers</strong>ã€‚è¿™å¯¹äºæ¨¡å—åŒ–å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬å°†æˆ‘ä»¬çš„åŠŸèƒ½åˆ†è§£æˆåªåŒ…å«è¯¥åŠŸèƒ½çœŸæ­£å…³å¿ƒçš„åŸŸç±»å‹çš„æ¨¡å—ï¼Œç„¶ååº”ç”¨ç¨‹åºç›®æ ‡å¯ä»¥å°†è¿™äº›åŸŸç»„è£…æˆå®Œæ•´çš„åº”ç”¨ç¨‹åºåŸŸã€‚</p>
<p>ä¸ºäº†ç»´æŠ¤è¿™ç§æ¨¡å—åŒ–ï¼Œå¹¶å°†å±€éƒ¨ç¯å¢ƒä¸å…¨å±€ç¯å¢ƒçš„æ— å…³ç»†èŠ‚éš”ç¦»å¼€æ¥ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›èƒ½å¤Ÿè½¬æ¢ç¯å¢ƒã€‚</p>
<p>å› æ­¤ï¼Œè®©æˆ‘ä»¬ä¸ºå±€éƒ¨å’Œå…¨å±€ç¯å¢ƒå¼•å…¥æ³›å‹ï¼Œå¹¶çœ‹çœ‹ç¯å¢ƒè½¬æ¢éœ€è¦æˆä¸ºä»€ä¹ˆæ ·çš„å½¢çŠ¶:</p>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction, LocalEnvironment, GlobalEnvironment&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction, LocalEnvironment&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: CasePath&lt;GlobalAction, LocalAction&gt;,
  environment: ???
) -&gt; Reducer&lt;GlobalValue, GlobalAction, GlobalEnvironment&gt; {
</code></pre>
<p>åœ¨è¿™ä¸ªå‡½æ•°çš„å‡½æ•°ä½“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„<strong>reducer</strong>ï¼Œå®ƒå¯ä»¥åœ¨å…¨å±€ç¯å¢ƒä¸‹å·¥ä½œ:</p>
<pre><code class="language-swift">return { globalValue, globalAction, globalEnvironment in
</code></pre>
<p>ç„¶åï¼Œå½“æˆ‘ä»¬å°è¯•è¿è¡Œæœ¬åœ°<strong>reducer</strong>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå®ƒæä¾›ä¸€ä¸ªæœ¬åœ°ç¯å¢ƒã€‚ä¼¼ä¹æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œå°†ç°æœ‰çš„å…¨çƒç¯å¢ƒè½¬å˜ä¸ºå±€éƒ¨ç¯å¢ƒï¼Œè€Œè¿™å°±å†³å®šäº†æˆ‘ä»¬éœ€è¦é‡‡å–çš„è½¬å˜æ–¹å¼:</p>
<pre><code class="language-swift">environment: @escaping (GlobalEnvironment) -&gt; LocalEnvironment
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥ç®€å•åœ°é€šè¿‡ä»¥ä¸‹æ“ä½œæ¥ä¿®å¤å›è°ƒ:</p>
<pre><code class="language-swift">return { globalValue, globalAction, globalEnvironment in
  guard let localAction = action.extract(globalAction) else { return [] }
  let localEffects = reducer(&amp;globalValue[keyPath: value], localAction, environment(globalEnvironment))

  return localEffects.map { localEffect in
    localEffect.map(action.embed)
      .eraseToEffect()
  }
}
</code></pre>
<p>å°±åƒ<strong>pullback</strong>ä¸€æ ·ç°åœ¨ç¼–è¯‘ã€‚å…³äºè¿™ä¸€ç‚¹:</p>
<ul>
<li>
<p>è¯·æ³¨æ„ï¼Œç¯å¢ƒè½¬æ¢çš„æ–¹å‘ä¸ä»·å€¼å’Œè¡ŒåŠ¨è½¬æ¢çš„æ–¹å‘ç›¸åŒã€‚è¿™ä¸‰ç§æ–¹æ³•éƒ½æ˜¯ä»å…¨å±€åˆ°å±€éƒ¨çš„ã€‚æ‰€ä»¥è¿™ä¸ªå˜æ¢åœ¨å®ƒçš„æ¯ä¸€ä¸ªæ³›å‹ä¸­ä»ç„¶æ˜¯é€†å˜çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<strong>pullback</strong>ä»ç„¶æ˜¯è¿™ä¸ªæ“ä½œçš„å¥½åå­—ã€‚</p>
</li>
<li>
<p>æˆ‘ä»¬è¿˜æƒ³è¯´ï¼Œæ²¿ç€æ™®é€šå‡½æ•°è€Œä¸æ˜¯å…³é”®è·¯å¾„æˆ–caseè·¯å¾„<strong>pullback</strong>ç¯å¢ƒæ˜¯å®Œå…¨å¯ä»¥çš„ã€‚å…³é”®è·¯å¾„å’Œ<strong>case</strong>è·¯å¾„ä¹‹æ‰€ä»¥å¿…ä¸å¯å°‘ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¼ºå¤§çš„å·¥å…·æ¥åˆ†ç¦»çŠ¶æ€å’Œè¡Œä¸ºå¹¶å°†å®ƒä»¬ç²˜åœ¨ä¸€èµ·ã€‚ä½†æ˜¯å¯¹äºç¯å¢ƒï¼Œæˆ‘ä»¬åªéœ€è¦å°†å±€éƒ¨ç¯å¢ƒä»å…¨å±€ç¯å¢ƒä¸­æŠ•å½±å‡ºæ¥ï¼Œä¸€ä¸ªç®€å•çš„å‡½æ•°å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
</li>
</ul>
<p>å¥½äº†ï¼Œè¿™ä¸ªæ¨¡å—ä¸­çš„ä¸‹ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯æ˜¯æ—¥å¿—é«˜é˜¶å‡é€Ÿå™¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬å‘ä»»ä½•å‡é€Ÿå™¨æ·»åŠ æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚æˆ‘ä»¬åªéœ€è¦ç¡®ä¿å°†ç¯å¢ƒä¼ é€’ç»™æˆ‘ä»¬æ­£åœ¨æ·»åŠ æ—¥å¿—çš„å‡é€Ÿæœº:</p>
<pre><code class="language-swift">public func logging&lt;Value, Action, Environment&gt;(
  _ reducer: @escaping Reducer&lt;Value, Action, Environment&gt;
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return { value, action, environment in
    let effects = reducer(&amp;value, action, environment)
    let newValue = value
    return [.fireAndForget {
      print(&quot;Action: \(action)&quot;)
      print(&quot;Value:&quot;)
      dump(newValue)
      print(&quot;---&quot;)
      }] + effects
  }
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥é€šè¿‡è¦æ±‚è°ƒç”¨è€…æä¾›ä¸€ä¸ªä¿å­˜æ‰“å°å‡½æ•°çš„ç¯å¢ƒæ¥æ”¹è¿›è¿™ä¸ªé«˜é˜¶å‡é€Ÿå™¨ã€‚å°±åƒè¿™æ ·ï¼Œæˆ‘ä»¬æ›´æ–°äº†<strong>reducers</strong>å’Œå®ƒä»¬çš„è½¬æ¢å‡½æ•°æ¥é€‚åº”ç¯å¢ƒï¼Œè¿™æ˜¯éå¸¸ç®€å•çš„ã€‚</p>
<hr>
<h2 id="6-a-nameenvironmentinthestoreaenvironment-in-the-store">6. <a name='Environmentinthestore'></a>Environment in the store</h2>
<p>ä½†æˆ‘ä»¬åœ¨<strong>Store</strong>ç±»å‹ä¸­æœ‰ä¸€å †é”™è¯¯ã€‚</p>
<p>é¦–å…ˆï¼Œå®ƒæŒæœ‰çš„<strong>Reducer</strong>ç°åœ¨æœ‰3ä¸ªæ³›å‹:</p>
<pre><code class="language-swift">private let reducer: Reducer&lt;Value, Action&gt;
</code></pre>
<blockquote>
<p>ğŸ›‘ Generic type â€˜Reducerâ€™ specialized with too few type parameters (got 2, but expected 3)</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼æä¾›è¿™ä¸ªæ³›å‹ã€‚ä¼¼ä¹æ²¡æœ‰å¤ªå¤šçš„å…¶ä»–æˆ‘ä»¬å¯ä»¥åšï¼Œé™¤äº†æ·»åŠ æ³›å‹åˆ°æˆ‘ä»¬çš„å•†åº—:</p>
<pre><code class="language-swift">public final class Store&lt;Value, Action, Environment&gt;: ObservableObject {
  private let reducer: Reducer&lt;Value, Action, Environment&gt;
</code></pre>
<p>è¿™å¯èƒ½æ˜¯åˆç†çš„ï¼Œæ¯•ç«Ÿæˆ‘ä»¬ä¼¼ä¹æœ‰ç›¸åŒçš„å½¢çŠ¶çš„<strong>Reducer</strong>å’Œ<strong>Store</strong>çš„å½¢çŠ¶ã€‚</p>
<p>ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨<strong>Store</strong>çš„åˆå§‹åŒ–å¼ä¸­ï¼Œå®ƒåªéœ€è¦æ–°çš„æ³›å‹:</p>
<pre><code class="language-swift">public init(initialValue: Value, reducer: @escaping Reducer&lt;Value, Action, Environment&gt;) {
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨<strong>send</strong>æ–¹æ³•ä¸­å‡ºç°é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬è¯•å›¾åœ¨ä¸æä¾›ç¯å¢ƒçš„æƒ…å†µä¸‹è°ƒç”¨<strong>reducer</strong>:</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effects = self.reducer(&amp;self.value, action)
</code></pre>
<blockquote>
<p>ğŸ›‘ Missing argument for parameter #3 in call</p>
</blockquote>
<p>æˆ‘ä»¬è¦ä»å“ªé‡Œå¾—åˆ°è¿™æ ·çš„ç¯å¢ƒ? ä¼¼ä¹æˆ‘ä»¬åº”è¯¥åœ¨åˆ›å»º<strong>Store</strong>æ—¶ä¸ºå…¶æä¾›ç¯å¢ƒã€‚è¿™æ ·ï¼Œå®ƒå°±å¯ä»¥æŠ“ä½ç¯å¢ƒï¼Œå¹¶åœ¨ä»»ä½•åŠ¨ä½œå‡ºç°æ—¶å°†ç¯å¢ƒä¼ é€’ç»™å®ƒçš„<strong>Reducer</strong>ã€‚è®©æˆ‘ä»¬è¿™æ ·åš:</p>
<pre><code class="language-swift">public final class Store&lt;Value, Action, Environment&gt;: ObservableObject {
  private let reducer: Reducer&lt;Value, Action, Environment&gt;
  private let environment: Environment
  @Published public private(set) var value: Value
  private var viewCancellable: Cancellable?
  private var effectCancellables: Set&lt;AnyCancellable&gt; = []

  public init(
    initialValue: Value,
    reducer: @escaping Reducer&lt;Value, Action, Environment&gt;,
    environment: Environment
  ) {
    self.reducer = reducer
    self.value = initialValue
    self.environment = environment
  }
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€äº›ä¸œè¥¿è¦ä¼ é€’ç»™<strong>Reducer</strong>:</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effects = self.reducer(&amp;self.value, action, self.environment)
</code></pre>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™äº›é”™è¯¯éƒ½å¾ˆå®¹æ˜“ä¿®å¤ã€‚</p>
<p>ä½†ä¸‹ä¸€ä¸ªæœ‰ç‚¹æ£˜æ‰‹ã€‚å®ƒåœ¨<strong>Store</strong>çš„<strong>view</strong>æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•å…è®¸æˆ‘ä»¬å°†<strong>Store</strong>è½¬æ¢ä¸ºåªå…¬å¼€å±€éƒ¨åŸŸçš„<strong>Store</strong>ã€‚ è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•å°†<strong>Store</strong>æ”¾åœ¨ä¸€ä¸ªSwiftUIè§†å›¾ä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ä¸€ä¸ªæ›´å°çš„è§†å›¾ï¼Œè¯¥è§†å›¾åªéœ€è¦çˆ¶è§†å›¾çš„çŠ¶æ€å’Œæ“ä½œçš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>ç°åœ¨å®ƒæ­£åœ¨æŠ±æ€¨ï¼Œå› ä¸ºæˆ‘ä»¬ç¼ºå°‘ç¬¬ä¸‰ä¸ªæ³›å‹:</p>
<pre><code class="language-swift">public func view&lt;LocalValue, LocalAction&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action
) -&gt; Store&lt;LocalValue, LocalAction&gt; {
  let localStore = Store&lt;LocalValue, LocalAction&gt;(
</code></pre>
<blockquote>
<p>ğŸ›‘ Generic type â€˜Storeâ€™ specialized with too few type parameters (got 2, but expected 3)</p>
</blockquote>
<p>ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯å…³äºå°†ä¸€ä¸ªå…¨å±€åŸŸä¸Šçš„<strong>Store</strong>è½¬æ¢ä¸ºä¸€ä¸ªå±€éƒ¨åŸŸä¸Šçš„<strong>Store</strong>ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè®¤ä¸ºæˆ‘ä»¬åº”è¯¥åœ¨è¿™é‡Œçš„å€¼å’Œæ“ä½œè½¬æ¢ä¹‹å¤–æä¾›å¦ä¸€ä¸ªè½¬æ¢ã€‚</p>
<p>å› æ­¤ï¼Œè®©æˆ‘ä»¬é¦–å…ˆä¸ºæœ¬åœ°ç¯å¢ƒå¼•å…¥ä¸€ä¸ªæ³›å‹å’Œä¸€ä¸ªæ–°çš„è½¬æ¢å‚æ•°:</p>
<pre><code class="language-swift">public func view&lt;LocalValue, LocalAction, LocalEnvironment&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action,
  environment: ???
) -&gt; Store&lt;LocalValue, LocalAction, LocalEnvironment&gt; {
  let localStore = Store&lt;LocalValue, LocalAction, LocalEnvironment&gt;(
    â€¦
    environment: ???
  )
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æƒ³æä¾›è¿™æ ·çš„è®ºæ®ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªå±€éƒ¨ç¯å¢ƒï¼Œæˆ‘ä»¬æ‰‹è¾¹æœ‰ä¸€ä¸ªå…¨å±€ç¯å¢ƒï¼Œæ‰€ä»¥è¿™ä¼¼ä¹å†³å®šäº†æˆ‘ä»¬çš„è½¬å˜åº”è¯¥èµ°å‘:</p>
<pre><code class="language-swift">public func view&lt;LocalValue, LocalAction, LocalEnvironment&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action,
  environment toLocalEnvironment: @escaping (Environment) -&gt; LocalEnvironment
) -&gt; Store&lt;LocalValue, LocalAction, LocalEnvironment&gt; {
  let localStore = Store&lt;LocalValue, LocalAction, LocalEnvironment&gt;(
    initialValue: toLocalValue(self.value),
    reducer: { localValue, localAction in
      self.send(toGlobalAction(localAction))
      localValue = toLocalValue(self.value)
      return []
  },
    environment: toLocalEnvironment(self.environment)
  )
</code></pre>
<p>è¶Šæ¥è¶Šè¿‘äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­åˆå¤šäº†ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯</p>
<blockquote>
<p>ğŸ›‘ Contextual closure type â€˜(inout LocalValue, LocalAction, LocalEnvironment) -&gt; [Effect]â€™ expects 3 arguments, but 2 were used in closure body</p>
</blockquote>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œå®ç°çš„<strong>reducer</strong>ä½¿ç”¨äº†<strong>reducer</strong>çš„è€ç­¾åï¼Œåªæœ‰ä¸¤ä¸ªå‚æ•°ã€‚æˆ‘ä»¬ç°åœ¨æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„æœ¬åœ°ç¯å¢ƒ</p>
<pre><code class="language-swift">reducer: { localValue, localAction, localEnvironment in
</code></pre>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œè¿™å°±å¾—åˆ°äº†ç¼–è¯‘çš„ç»“æœã€‚ å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä½¿ç”¨å±€éƒ¨ç¯å¢ƒã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿æ¥è¡¨ç¤ºå®ƒæ ¹æœ¬æ²¡æœ‰è¢«ä½¿ç”¨:</p>
<pre><code class="language-swift">reducer: { localValue, localAction, _ in
</code></pre>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬å¹¶æ²¡æœ‰ä»¥ä»»ä½•æœ‰æ„ä¹‰çš„æ–¹å¼åˆ©ç”¨ç¯å¢ƒã€‚æˆ‘ä»¬æ‰€åšçš„åªæ˜¯å°†å…¶è½¬æ¢å¹¶å°†å…¶ä¼ é€’ç»™æ–°<strong>Store</strong>ï¼Œä½†æ–°<strong>Store</strong>å¹¶æ²¡æœ‰å°†å…¶å…¨éƒ¨ä½¿ç”¨ã€‚</p>
<hr>
<h2 id="7-a-nameerasingtheenvironmentfromthestoreaerasing-the-environment-from-the-store">7. <a name='Erasingtheenvironmentfromthestore'></a>Erasing the environment from the store</h2>
<p>å¯ç»„åˆæ¶æ„æ¨¡å—ç»ˆäºå¼€å§‹æ„å»ºäº†ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨æ„å»ºè¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›å¥‡æ€ªçš„äº‹æƒ…ã€‚<strong>Store</strong>ä¸Šçš„<strong>view</strong>æ–¹æ³•çš„å®ç°éå¸¸å¥‡æ€ªï¼Œè¿™è®©æˆ‘æ€€ç–‘æˆ‘ä»¬æ˜¯å¦åœ¨åšæ­£ç¡®çš„äº‹æƒ…ã€‚æˆ‘ä»¬éœ€è¦åœ¨è§†å›¾æ–¹æ³•ä¸­è€ƒè™‘ç¯å¢ƒï¼Œå³ä½¿å®ƒæ²¡æœ‰ä»¥ä»»ä½•æœ‰æ„ä¹‰çš„æ–¹å¼ä½¿ç”¨ã€‚</p>
<p>äº‹å®ä¸Šï¼Œ<strong>Store</strong>ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¦‚å¿µä¸ç¯å¢ƒå‡ ä¹æ²¡æœ‰å…³ç³»ã€‚<strong>Store</strong>çš„ç”¨æˆ·åªå…³å¿ƒä»å®ƒè·å–çŠ¶æ€å€¼å¹¶å‘å®ƒå‘é€æ“ä½œã€‚ä»–ä»¬ä»ä¸è®¿é—®ç¯å¢ƒï¼Œç”šè‡³ä¸éœ€è¦äº†è§£æ­£åœ¨åº•å±‚ä½¿ç”¨çš„ç¯å¢ƒã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦ä»<strong>Store</strong>ç±»ä¸­â€œåˆ é™¤â€è¿™ä¸ªç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›ä»<strong>Store</strong>ä¸­åˆ é™¤æ³›å‹ï¼Œå¹¶å°†ç¯å¢ƒç»†èŠ‚éšè—åœ¨ç±»çš„å®ç°ä¸­ï¼Œè€Œä¸æ˜¯å°†å…¶å…¬å¼€ã€‚</p>
<p>å…³äºSwiftçš„ç±»å‹æ“¦é™¤æœ‰å¾ˆå¤šå¯è¯´çš„ï¼Œä½†æˆ‘ä»¬è¶³å¤Ÿå¹¸è¿çš„æ˜¯ï¼Œå¯¹äº<strong>Store</strong>ç±»å‹ï¼Œæ“¦é™¤è¿™ç§ç±»å‹éå¸¸å®¹æ˜“ã€‚è®©æˆ‘ä»¬ä»åˆ é™¤ç¯å¢ƒæ³›å‹å¼€å§‹ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦åšä»€ä¹ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜:</p>
<pre><code class="language-swift">public final class Store&lt;Value, Action&gt;: ObservableObject {
</code></pre>
<p>éšç€æ³›å‹ç±»å‹çš„æ¶ˆå¤±ï¼Œæˆ‘ä»¬ä¸èƒ½å†ä¿ç•™æŒ‡å®šäº†environmentç±»å‹çš„<strong>Reducer</strong>æˆ–ç¯å¢ƒã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›ç±»å‹æ›¿æ¢ä¸º<strong>Any</strong>ï¼Œè¿™æ ·æˆ‘ä»¬ç°åœ¨å°±ä¸éœ€è¦æ”¾å…¥å…·ä½“çš„ç±»å‹ï¼Œä½†åœ¨è¿è¡Œæ—¶å¯ä»¥ä½¿ç”¨ä»»ä½•å€¼:</p>
<pre><code class="language-swift">public final class Store&lt;Value, Action&gt;: ObservableObject {
  private let reducer: Reducer&lt;Value, Action, Any&gt;
  private let environment: Any
</code></pre>
<p>ç„¶åï¼Œå¯¹äºåˆå§‹åŒ–å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬å®é™…ä¸Šéœ€è¦ç¯å¢ƒä¿¡æ¯çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªæ³›å‹å¹¶å°†å…¶ç”¨äº<strong>reducer</strong>å’Œç¯å¢ƒå‚æ•°:</p>
<pre><code class="language-swift">public init&lt;Environment&gt;(
  initialValue: Value,
  reducer: @escaping Reducer&lt;Value, Action, Environment&gt;,
  environment: Environment
) {
  self.reducer = reducer
  self.value = initialValue
  self.environment = environment
}
</code></pre>
<p>è¿™ä¼šå¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“å¦‚ä½•åœ¨<strong>Any</strong>ç¯å¢ƒçš„<strong>reducer</strong>å’Œç‰¹å®šç¯å¢ƒçš„<strong>reducer</strong>ä¹‹é—´è¿›è¡Œè½¬æ¢:</p>
<blockquote>
<p>ğŸ›‘ Cannot assign value of type â€˜(inout Value, Action, Environment) -&gt; [Effect]â€™ to type â€˜(inout Value, Action, Any) -&gt; [Effect]â€™</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¿™ä¸ªåˆå§‹åŒ–å™¨ä¸­å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„<strong>reducer</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯¥<strong>reducer</strong>å¼ºåˆ¶å°†Anyå€¼è½¬æ¢ä¸ºä¸€ä¸ªåˆé€‚çš„<strong>Environment</strong>å€¼ã€‚è¿™å¬èµ·æ¥å¯èƒ½å¾ˆå±é™©ï¼Œä½†å¦‚æœæˆ‘ä»¬å°å¿ƒï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šæ„å¤–åœ°å¾—åˆ°ä¸€ä¸ªæˆ‘ä»¬ä¸æœŸæœ›çš„ç¯å¢ƒã€‚æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹:</p>
<pre><code class="language-swift">public init&lt;Environment&gt;(
  initialValue: Value,
  reducer: @escaping Reducer&lt;Value, Action, Environment&gt;,
  environment: Environment
) {
  self.reducer = { value, action, environment in
    reducer(&amp;value, action, environment as! Environment)
  }
  self.value = initialValue
  self.environment = environment
}
</code></pre>
<p>è¿™ä¼šå¾—åˆ°åˆå§‹åŒ–å™¨çš„ç¼–è¯‘ï¼Œä½†<strong>view</strong>æ–¹æ³•åˆæœ‰é—®é¢˜äº†ï¼Œä½†æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯åˆ é™¤ç¯å¢ƒæ³›å‹å¹¶å°†æˆ‘ä»¬è‡ªå·±çš„ç¯å¢ƒä¼ é€’ç»™æ–°çš„<strong>store</strong>:</p>
<pre><code class="language-swift">public func view&lt;LocalValue, LocalAction&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action
) -&gt; Store&lt;LocalValue, LocalAction&gt; {
  let localStore = Store&lt;LocalValue, LocalAction&gt;(
    initialValue: toLocalValue(self.value),
    reducer: { localValue, localAction, _ in
      self.send(toGlobalAction(localAction))
      localValue = toLocalValue(self.value)
      return []
  },
    environment: self.environment
  )
  localStore.viewCancellable = self.$value.sink { [weak localStore] newValue in
    localStore?.value = toLocalValue(newValue)
  }
  return localStore
}
</code></pre>
<p>äº‹æƒ…æ­£åœ¨å‘å±•ä¸­!å¼ºåˆ¶æ–½æ³•å¯èƒ½çœ‹èµ·æ¥å¾ˆå¯æ€•ï¼Œä½†ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨å¼ºåˆ¶æ–½æ³•è€Œè¿›è¡Œè¿™ç§ç±»å‹çš„æ“¦é™¤ã€‚</p>
<p>æˆ‘ä»¬ä¸éœ€è¦åœ¨è§†å›¾ä¸­æ˜¾å¼åœ°è½¬æ¢ç¯å¢ƒï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œä½†è¯·è®°ä½ï¼Œç¯å¢ƒçº¯ç²¹æ˜¯å­˜å‚¨ä¸­çš„ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè€Œä¸”æ‰€æœ‰çš„ç¯å¢ƒè½¬æ¢éƒ½å·²ç»åº”ç”¨åˆ°<strong>reducer</strong>ä¸Šäº†ã€‚</p>
<hr>
<p>å¹¸è¿çš„æ˜¯ï¼Œåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ¨¡å—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»æœ€ç®€å•ã€ä¾èµ–æœ€å°‘çš„æ¨¡å—å¼€å§‹ï¼Œç„¶åè¿”å›åˆ°ä¸»åº”ç”¨ç›®æ ‡ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-90composing-architecture-with-case-paths/">
                  <h3 class="post-title">
                    PointFree Episode 90:Composing Architecture with Case Paths 
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
