<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Using @autoclosure when designing Swift APIs | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1645875724842">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="Swiftçš„@autoclosureå±æ€§å…è®¸ä½ å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°è‡ªåŠ¨è¢«å°è£…åœ¨ä¸€ä¸ªé—­åŒ…ä¸­ã€‚ å®ƒä¸»è¦ç”¨äºå°†è¡¨è¾¾å¼çš„æ‰§è¡Œå»¶è¿Ÿåˆ°å®é™…éœ€è¦çš„æ—¶å€™ï¼Œè€Œä¸æ˜¯åœ¨ä¼ é€’å‚æ•°æ—¶ç›´æ¥æ‰§è¡Œã€‚
åœ¨Swiftæ ‡å‡†åº“ä¸­ä½¿ç”¨è¯¥å‡½æ•°çš„ä¸€ä¸ªä¾‹å­æ˜¯assertå‡½æ•°ã€‚ç”±äºæ–­è¨€åªåœ¨..." />
    <meta name="keywords" content="api design" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1645875724842" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Using @autoclosure when designing Swift APIs</h2>
            <div class="post-date">2017-05-28</div>
            
            <div class="post-content" v-pre>
              <p>Swiftçš„@autoclosureå±æ€§å…è®¸ä½ å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°è‡ªåŠ¨è¢«å°è£…åœ¨ä¸€ä¸ªé—­åŒ…ä¸­ã€‚ å®ƒä¸»è¦ç”¨äºå°†è¡¨è¾¾å¼çš„æ‰§è¡Œå»¶è¿Ÿåˆ°å®é™…éœ€è¦çš„æ—¶å€™ï¼Œè€Œä¸æ˜¯åœ¨ä¼ é€’å‚æ•°æ—¶ç›´æ¥æ‰§è¡Œã€‚</p>
<p>åœ¨Swiftæ ‡å‡†åº“ä¸­ä½¿ç”¨è¯¥å‡½æ•°çš„ä¸€ä¸ªä¾‹å­æ˜¯assertå‡½æ•°ã€‚ç”±äºæ–­è¨€åªåœ¨è°ƒè¯•æ„å»ºä¸­è§¦å‘ï¼Œæ‰€ä»¥ä¸éœ€è¦è®¡ç®—åœ¨å‘å¸ƒæ„å»ºä¸­æ–­è¨€çš„è¡¨è¾¾å¼ã€‚è¿™å°±æ˜¯@autoclosureçš„ä½œç”¨:</p>
<pre><code class="language-swift">func assert(_ expression: @autoclosure () -&gt; Bool,
            _ message: @autoclosure () -&gt; String) {
    guard isDebug else {
        return
    }

    // Inside assert we can refer to expression as a normal closure
    if !expression() {
        assertionFailure(message())
    }  
}
</code></pre>
<p>@autoclosureçš„å¥½å¤„æ˜¯å®ƒå¯¹è°ƒç”¨ç«™ç‚¹æ²¡æœ‰å½±å“ã€‚å¦‚æœassertæ˜¯ç”¨â€œæ™®é€šâ€é—­åŒ…å®ç°çš„ï¼Œä½ å¿…é¡»è¿™æ ·ä½¿ç”¨å®ƒ:</p>
<pre><code class="language-swift">assert({ someCondition() }, { &quot;Hey, it failed!&quot; })
</code></pre>
<p>ä½†æ˜¯ç°åœ¨ï¼Œä½ å¯ä»¥åƒè°ƒç”¨ä»»ä½•å¸¦æœ‰éé—­åŒ…å‚æ•°çš„å‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒ:</p>
<pre><code class="language-swift">assert(someCondition(), &quot;Hey it failed!&quot;)
</code></pre>
<p>æœ¬å‘¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨@autoclosureï¼Œä»¥åŠå®ƒå¦‚ä½•ä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¾è®¡ä¸€äº›æ¼‚äº®çš„apiã€‚</p>
<h2 id="inlining-assignments">Inlining assignments</h2>
<p>@autoclosureæ”¯æŒçš„ä¸€ä»¶äº‹æ˜¯åœ¨å‡½æ•°è°ƒç”¨ä¸­å†…è”è¡¨è¾¾å¼ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚å°†èµ‹å€¼è¡¨è¾¾å¼ä½œä¸ºå‚æ•°ä¼ é€’ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­è¿™æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p>
<p>åœ¨iOSä¸Šï¼Œä½ é€šå¸¸ä½¿ç”¨è¿™ä¸ªAPIæ¥å®šä¹‰è§†å›¾åŠ¨ç”»:</p>
<pre><code class="language-swift">UIView.animate(withDuration: 0.25) {
    view.frame.origin.y = 100
}
</code></pre>
<p>é€šè¿‡@autoclosureï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªåŠ¨ç”»å‡½æ•°ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŠ¨ç”»é—­åŒ…å¹¶æ‰§è¡Œå®ƒï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">func animate(_ animation: @autoclosure @escaping () -&gt; Void,
             duration: TimeInterval = 0.25) {
    UIView.animate(withDuration: duration, animations: animation)
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„å‡½æ•°è°ƒç”¨æ¥æ‰§è¡ŒåŠ¨ç”»ï¼Œè€Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„{}è¯­æ³•:</p>
<pre><code class="language-swift">animate(view.frame.origin.y = 100)
</code></pre>
<p>ä½¿ç”¨ä¸Šè¿°æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥çœŸæ­£å‡å°‘åŠ¨ç”»ä»£ç çš„å†—é•¿ï¼Œè€Œä¸ç‰ºç‰²å¯è¯»æ€§å’Œè¡¨ç°åŠ›ğŸ‰</p>
<h2 id="passing-errors-as-expressions">Passing errors as expressions</h2>
<p>æˆ‘å‘ç°@autoclosureéå¸¸æœ‰ç”¨çš„å¦ä¸€ç§æƒ…å†µæ˜¯åœ¨ç¼–å†™å¤„ç†é”™è¯¯çš„å®ç”¨ç¨‹åºæ—¶ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³åœ¨Optionalä¸Šæ·»åŠ ä¸€ä¸ªæ‰©å±•ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ä¸€ä¸ªæŠ›å‡ºAPIæ¥å±•å¼€å®ƒã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¦æ±‚optionalä¸ºénilï¼Œæˆ–è€…æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œåƒè¿™æ ·:</p>
<pre><code class="language-swift">extension Optional {
    func unwrapOrThrow(_ errorExpression: @autoclosure () -&gt; Error) throws -&gt; Wrapped {
        guard let value = self else {
            throw errorExpression()
        }

        return value
    }
}
</code></pre>
<p>ä¸å®ç°assertçš„æ–¹å¼ç±»ä¼¼ï¼Œæˆ‘ä»¬åªåœ¨éœ€è¦æ—¶æ‰è®¡ç®—é”™è¯¯è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¯•å›¾æ‰“å¼€å¯é€‰å¯¹è±¡æ—¶éƒ½å¿…é¡»è¿™æ ·åšã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥åƒè¿™æ ·ä½¿ç”¨unwrapOrThrow API:</p>
<pre><code class="language-swift">let name = try argument(at: 1).unwrapOrThrow(ArgumentError.missingName)
</code></pre>
<h2 id="type-inference-using-default-values">Type inference using default values</h2>
<p>æˆ‘å‘ç°çš„@autoclosureçš„æœ€åä¸€ä¸ªç”¨ä¾‹æ˜¯åœ¨ä»å­—å…¸ã€æ•°æ®åº“æˆ–UserDefaultsä¸­æå–å¯é€‰å€¼æ—¶ã€‚</p>
<p>é€šå¸¸ï¼Œå½“ä»ä¸€ä¸ªæ— ç±»å‹å­—å…¸ä¸­æå–ä¸€ä¸ªå€¼å¹¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼æ—¶ï¼Œä½ å¿…é¡»è¿™æ ·å†™:</p>
<pre><code class="language-swift">let coins = (dictionary[&quot;numberOfCoins&quot;] as? Int) ?? 100
</code></pre>
<p>è¿™æœ‰ç‚¹éš¾è¯»ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šè¯­æ³•æ··ä¹±çš„ç±»å‹è½¬æ¢å’Œ??æ“ä½œç¬¦ã€‚é€šè¿‡@autoclosureï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªAPIï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ç¼–å†™ç›¸åŒçš„è¡¨è¾¾å¼:</p>
<pre><code class="language-swift">let coins = dictionary.value(forKey: &quot;numberOfCoins&quot;, defaultValue: 100)
</code></pre>
<p>åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤å€¼æ—¢ç”¨äºç¼ºå°‘å€¼æ—¶ï¼Œä¹Ÿå…è®¸Swiftå¯¹è¯¥å€¼è¿›è¡Œç±»å‹æ¨æ–­ï¼Œè€Œä¸éœ€è¦æŒ‡å®šç±»å‹æˆ–æ‰§è¡Œç±»å‹è½¬æ¢ã€‚æ¼‚äº®æ•´æ´çš„ğŸ‘</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç¼–å†™è¿™æ ·çš„API:</p>
<pre><code class="language-swift">extension Dictionary where Value == Any {
    func value&lt;T&gt;(forKey key: Key, defaultValue: @autoclosure () -&gt; T) -&gt; T {
        guard let value = self[key] as? T else {
            return defaultValue()
        }

        return value
    }
}
</code></pre>
<p>åŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨@autoclosureæ¥é¿å…æ¯æ¬¡è°ƒç”¨è¯¥æ–¹æ³•æ—¶éƒ½å¿…é¡»è®¡ç®—é»˜è®¤å€¼ã€‚</p>
<h2 id="conclusion">Conclusion</h2>
<p>å‡å°‘å†—é•¿æ€»æ˜¯éœ€è¦ä»”ç»†è€ƒè™‘çš„äº‹æƒ…ã€‚æˆ‘ä»¬çš„ç›®æ ‡åº”è¯¥å§‹ç»ˆæ˜¯ç¼–å†™å¯Œæœ‰è¡¨ç°åŠ›ã€æ˜“äºé˜…è¯»çš„ä»£ç ï¼Œå› æ­¤åœ¨è®¾è®¡ä½å†—é•¿çš„apiæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸ä¼šä»è°ƒç”¨ç«™ç‚¹åˆ é™¤é‡è¦çš„ä¿¡æ¯ã€‚</p>
<p>æˆ‘è®¤ä¸ºåœ¨é€‚å½“çš„æƒ…å†µä¸‹ä½¿ç”¨@autoclosureæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·ã€‚å¤„ç†è¡¨è¾¾å¼ï¼Œè€Œä¸ä»…ä»…æ˜¯å€¼ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå‡å°‘å†—é•¿å’Œç¹çï¼ŒåŒæ—¶è¿˜å¯èƒ½è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p><a href="https://www.swiftbysundell.com/articles/using-autoclosure-when-designing-swift-apis/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/rkVUhmDgHK/" class="tag">
                    api design
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/picking-the-right-way-of-failing-in-swift/">
                  <h3 class="post-title">
                    Picking the right way of failing in Swift
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
