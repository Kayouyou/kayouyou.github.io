<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 77:Effectful State Management: Unidirectional Effects | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1661042947575">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Introduction




Recap




Synchronous effects that produce results




Combining multiple effects that produce resu..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1661042947575" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 77:Effectful State Management: Unidirectional Effects</h2>
            <div class="post-date">2021-11-20</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Introduction">Introduction</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Recap">Recap</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Synchronouseffectsthatproduceresults">Synchronous effects that produce results</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Combiningmultipleeffectsthatproduceresults">Combining multiple effects that produce results</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Pullinglocaleffectsbackglobally">Pulling local effects back globally</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Workingwithourneweffects">Working with our new effects</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="#Whatsunidirectionaldataflow">Whatâ€™s unidirectional data flow?</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 77:Effectful State Management: Unidirectional Effects -->
<h2 id="1-a-nameintroductionaintroduction">1. <a name='Introduction'></a>Introduction</h2>
<p>æˆ‘ä»¬å·²ç»å°†ç¬¬ä¸€ä¸ª<strong>effect</strong>æå–åˆ°æˆ‘ä»¬çš„æ¶æ„ä¸­ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšå®Œæˆäº†ä»€ä¹ˆã€‚</p>
<h2 id="2-a-namerecaparecap">2. <a name='Recap'></a>Recap</h2>
<p>åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå‰¯ä½œç”¨ï¼Œå°†æœ€å–œæ¬¢çš„è´¨æ•°ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•æ¥æ§åˆ¶ã€‚ä¸€æ–¹é¢ï¼Œå®ƒæ˜¯ä¸å¯æµ‹è¯•çš„ä»£ç ï¼Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å‘ç°ç®€åŒ–è§†å›¾çš„ä¸€ä¸ªæœ‰ç”¨æ–¹æ³•æ˜¯å°†æ‰€æœ‰çš„é€»è¾‘ç§»åŠ¨åˆ°æˆ‘ä»¬çš„<strong>reducer</strong>ä¸­ï¼Œå¹¶ç®€å•åœ°è®©è§†å›¾è´Ÿè´£å‘<strong>store</strong>å‘é€ç”¨æˆ·æ“ä½œã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¾ˆå¤©çœŸåœ°å°†å‰¯ä½œç”¨ä»£ç ç§»åŠ¨åˆ°<strong>reducer</strong>ä¸­ã€‚è¿™åœ¨æŠ€æœ¯ä¸Šå®Œæˆäº†ä»»åŠ¡ï¼Œä½†å´ç ´åäº†<strong>reducer</strong>çš„æ‰€æœ‰è‰¯å¥½çš„å¯æµ‹è¯•æ€§å’Œå¯ç†è§£æ€§ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å›é¡¾äº†ä»ä¹‹å‰çš„ç« èŠ‚ä¸­å­¦åˆ°çš„å…³äºå‰¯ä½œç”¨çš„ä¸€äº›ç»éªŒæ•™è®­ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬ç»å¸¸å¯ä»¥é€šè¿‡å¼•å…¥ä¸€ä¸ªæ–°çš„è¾“å‡ºåˆ°å‡½æ•°çš„è¾¹ç•Œï¼Œè¡¨ç¤ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„<strong>effect</strong>ï¼Œè€Œä¸å®é™…æ‰§è¡Œå®ƒã€‚</p>
<p>è¿™å¯¼è‡´æˆ‘ä»¬å°†<strong>reducer</strong>ç­¾åæ›´æ”¹ä¸ºä¸€ä¸ªè¿”å›<strong>void-to-void</strong>é—­åŒ…çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥ä¿å­˜å‰¯ä½œç”¨å·¥ä½œï¼Œè€Œæ— éœ€å®é™…æ‰§è¡Œå®ƒï¼Œä»è€Œå°†æ‰§è¡Œå·¥ä½œçš„è´£ä»»ä¼ é€’ç»™<strong>store</strong>ã€‚</p>
<p>åœ¨ä¿®æ­£äº†ä¸€äº›ç¼–è¯‘å™¨é”™è¯¯ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºèƒ½å¤Ÿå°†ä¿å­˜å·¥ä½œå°è£…åœ¨ä¸€ä¸ªé—­åŒ…ä¸­ï¼Œå¹¶è®©<strong>store</strong>åº“ä¸ºæˆ‘ä»¬è¿è¡Œå®ƒï¼Œè€Œä¸æ˜¯åœ¨reducerä¸­è¿è¡Œå®ƒã€‚æœ€é‡è¦çš„æ˜¯ï¼Œåƒè¿™æ ·æ”¹å˜<strong>reducer</strong>ç­¾åå¹¶æ²¡æœ‰é˜»æ­¢æˆ‘ä»¬ä»ç„¶æ‹¥æœ‰å¯ç»„åˆ<strong>reducer</strong>å’Œ<strong>store</strong>ï¼Œè¿™æ˜¯è¿™ç§ç±»å‹æ¶æ„èƒŒåçš„çœŸæ­£åŠ›é‡ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬åœ¨æ¶æ„ä¸­å¼•å…¥<strong>effect</strong>çš„ç¬¬ä¸€æ­¥ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„<strong>effect</strong>ã€‚æˆ‘ä»¬è¿˜æœ‰å‡ ä¸ªæ­¥éª¤è¦åšï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å»ºæ¨¡æ›´å¤æ‚çš„<strong>effect</strong>ã€‚ ä¾‹å¦‚ï¼ŒåŠ è½½æœ€å–œæ¬¢çš„è´¨æ•°åˆ—è¡¨ä¸ä¿å­˜æœ‰ä¸€ç‚¹ä¸åŒã€‚ä¿å­˜ä¸»è¦æ˜¯ä¸€ä¸ªâ€œå°„åä¸ç†â€çš„æ“ä½œï¼Œæˆ‘ä»¬åªè¿è¡Œå·¥ä½œï¼Œä¸éœ€è¦å‘<strong>reducer</strong>åé¦ˆå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p>ç„¶è€Œï¼ŒåŠ è½½åšäº†ä¸€äº›å·¥ä½œæ¥ä»ç£ç›˜åŠ è½½æ•°æ®ï¼Œç„¶åæˆ‘ä»¬æƒ³è¦å°†è¿™äº›å·¥ä½œåé¦ˆç»™<strong>reducer</strong>ã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬éœ€è¦å¦‚ä½•æ”¹å˜è¿™ä¸ªå½±å“æ¨¡å‹æ¥è·å¾—è¿™ç§èƒ½åŠ›ã€‚</p>
<h2 id="3-a-namesynchronouseffectsthatproduceresultsasynchronous-effects-that-produce-results">3. <a name='Synchronouseffectsthatproduceresults'></a>Synchronous effects that produce results</h2>
<p>æˆ‘ä»¬ç°åœ¨æƒ³æŠŠè¿™ä¸ªåŠ è½½çš„å‰¯ä½œç”¨åˆ°æˆ‘ä»¬çš„<strong>reducer</strong>ã€‚</p>
<pre><code class="language-swift">Button(&quot;Load&quot;) {
  let documentsPath = NSSearchPathForDirectoriesInDomains(
    .documentDirectory, .userDomainMask, true
    )[0]
  let documentsUrl = URL(fileURLWithPath: documentsPath)
  let favoritePrimesUrl = documentsUrl
    .appendingPathComponent(&quot;favorite-primes.json&quot;)
  guard
    let data = try? Data(contentsOf: favoritePrimesUrl),
    let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
    else { return }
  self.store.send(.loadedFavoritePrimes(favoritePrimes))
}
</code></pre>
<p>å½“ç‚¹å‡»åŠ è½½æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª<strong>action</strong>è¢«å‘é€åˆ°<strong>store</strong>ï¼Œä½†å®ƒå¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚è§†å›¾æ­£åœ¨åšé™„å¸¦çš„å·¥ä½œæ¥è·å–æœ€å–œæ¬¢çš„è´¨æ•°æ•°ç»„ï¼Œç„¶ååœ¨æ“ä½œä¸­å°†æ•°æ®å‘é€åˆ°<strong>store</strong>ã€‚æˆ‘ä»¬æƒ³æŠŠè¿™ä¸ªå‰¯ä½œç”¨ç§»åŠ¨åˆ°<strong>reducer</strong>ä¸Šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠåŠ è½½æŒ‰é’®æ”¹ä¸ºå‘é€ä¸€ä¸ª<strong>action</strong>åˆ°<strong>store</strong>ã€‚</p>
<pre><code class="language-swift">Button(&quot;Load&quot;) {
  self.store.send(.loadButtonTapped)
</code></pre>
<p>ä¸ºäº†è®©å®ƒèµ·ä½œç”¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<strong>action enum</strong>ä¸­å¼•å…¥ä¸€ä¸ªæ–°çš„<strong>action</strong>:</p>
<pre><code class="language-swift">public enum FavoritePrimesAction {
  // â€¦
  case loadButtonTapped
</code></pre>
<p>æˆ‘ä»¬éœ€è¦åœ¨<strong>reducer</strong>ä¸­å¤„ç†è¿™ç§æƒ…å†µ:</p>
<pre><code class="language-swift">case .loadButtonTapped:
</code></pre>
<p>ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œåšä»€ä¹ˆå‘¢?æˆ‘ä»¬æƒ³åšä¹‹å‰åœ¨è§†å›¾ä¸­åšçš„æ‰€æœ‰å·¥ä½œã€‚</p>
<pre><code class="language-swift">case .loadButtonTapped:
  let documentsPath = NSSearchPathForDirectoriesInDomains(
    .documentDirectory, .userDomainMask, true
    )[0]
  let documentsUrl = URL(fileURLWithPath: documentsPath)
  let favoritePrimesUrl = documentsUrl
    .appendingPathComponent(&quot;favorite-primes.json&quot;)
  guard
    let data = try? Data(contentsOf: favoritePrimesUrl),
    let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
    else { return }
  self.store.send(.favoritePrimesLoaded(favoritePrimes))
</code></pre>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬ä¸æƒ³ç›´æ¥åšè¿™é¡¹å·¥ä½œã€‚æˆ‘ä»¬æƒ³æŠŠå®ƒåŒ…è£…æˆä¸€ä¸ª<strong>effect closure</strong>ï¼Œè¿™æ ·<strong>reducer</strong>å°±ä¸ä¼šæ‰§è¡Œå‰¯ä½œç”¨ï¼Œè€Œç”±<strong>store</strong>æ‰§è¡Œã€‚</p>
<pre><code class="language-swift">case .loadButtonTapped:
  return {
    let documentsPath = NSSearchPathForDirectoriesInDomains(
      .documentDirectory, .userDomainMask, true
      )[0]
    let documentsUrl = URL(fileURLWithPath: documentsPath)
    let favoritePrimesUrl = documentsUrl
      .appendingPathComponent(&quot;favorite-primes.json&quot;)
    guard
      let data = try? Data(contentsOf: favoritePrimesUrl),
      let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
      else { return }
    self.store.send(.favoritePrimesLoaded(favoritePrimes))
  }
</code></pre>
<blockquote>
<p>ğŸ›‘ Use of unresolved identifier â€˜selfâ€™</p>
</blockquote>
<p>ä½†è¿™ä¹Ÿä¸å®Œå…¨æ­£ç¡®ã€‚æˆ‘ä»¬æƒ³æŠŠæ‰€æœ‰è¿™äº›å·¥ä½œçš„ç»“æœå‘é€åˆ°<strong>store</strong>ï¼Œä½†æ˜¯åœ¨<strong>reducer</strong>ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰<strong>selfæˆ–store</strong>å¯ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚</p>
<p>å½“è¿™ä¸ªé€»è¾‘åœ¨è§†å›¾ä¸­æ—¶ï¼Œå®ƒè¿è¡Œ<strong>effect</strong>ï¼Œå¹¶å‘<strong>store</strong>å‘é€ä¸€ä¸ª<strong>action</strong>ï¼Œè®©å®ƒçŸ¥é“åº”è¯¥æ›´æ”¹çŠ¶æ€ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»ç§»åŠ¨åˆ°æˆ‘ä»¬çš„<strong>reducer</strong>çš„<strong>effect</strong>ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è€ƒè™‘çš„äº‹æƒ…ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æä¾›ä¸€ç§æ–¹å¼ï¼Œé‡‡å–ä¸€ä¸ª<strong>effect</strong>çš„ç»“æœï¼Œå¹¶å°†å…¶ç›´æ¥è¿”å›åˆ°<strong>reducer</strong>!</p>
<p>é—æ†¾çš„æ˜¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ç›®å‰å»ºæ¨¡<strong>effect</strong>çš„æ–¹å¼(å¦‚()-&gt; Voidé—­åŒ…)å¹¶ä¸ååˆ†æ­£ç¡®ã€‚å®ƒéœ€è¦å¤šä¸€ç‚¹ï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿æ”¹å˜<strong>reducer</strong>çš„æœªæ¥çŠ¶æ€ã€‚æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª<strong>action</strong>ï¼Œ<strong>favoritePrimesLoaded</strong>ï¼Œå®ƒå°±æ˜¯è¿™æ ·åšçš„ï¼Œæ‰€ä»¥å®ƒå¬èµ·æ¥ä¸æ˜¯å‘Voidå‘å°„<strong>effect</strong>ï¼Œè€Œæ˜¯éœ€è¦ç»™å®ƒä»¬è¿”å›ä¸€ä¸ªå¯ä»¥å½±å“çŠ¶æ€çš„<strong>action</strong>çš„èƒ½åŠ›ã€‚</p>
<p>è¿™æ„å‘³ç€ä¹Ÿè®¸æˆ‘ä»¬çš„<strong>effect</strong>ç±»å‹åº”è¯¥æœ‰ä»¥ä¸‹ç­¾å:</p>
<pre><code class="language-swift">public typealias Effect&lt;Action&gt; = () -&gt; Action
</code></pre>
<p>è¿™æ„å‘³ç€åœ¨Effecté—­åŒ…ä¸­å‘ç”Ÿçš„å·¥ä½œå¯ä»¥åªå¯¹å®Œæˆå®Œæˆ<strong>effect</strong>æ‰€éœ€çš„æœ€å°å·¥ä½œæ„Ÿå…´è¶£ï¼Œç„¶åé€šè¿‡å°†å…¶åŒ…è£…åœ¨<strong>action</strong>ä¸­å°†å·¥ä½œç»“æœå‘é€å›<strong>reducer</strong>ã€‚</p>
<p>ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„å½¢çŠ¶ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„<strong>effect</strong>éƒ½ä¼šäº§ç”Ÿéœ€è¦åé¦ˆåˆ°ç³»ç»Ÿä¸­çš„æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç°æœ‰çš„<strong>effect</strong>æ˜¯å°†æœ€å–œæ¬¢çš„è´¨æ•°å†™å…¥ç£ç›˜ã€‚ä¹Ÿè®¸æˆ‘ä»¬æƒ³è¦çš„æ˜¯è®©<strong>effect</strong>è¿”å›ä¸€ä¸ªå¯é€‰çš„<strong>action</strong>ï¼Œè¿™æ ·<strong>fire-and-forget</strong>çš„<strong>effect</strong>å°±å¯ä»¥è¿”å›nilï¼Œè¿™äº›ä¼šè¢«storeå¿½ç•¥ã€‚</p>
<pre><code class="language-swift">public typealias Effect&lt;Action&gt; = () -&gt; Action?
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥ç›¸åº”åœ°æ›´æ–°æˆ‘ä»¬çš„<strong>reducer</strong>ç­¾åã€‚</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; Effect
</code></pre>
<blockquote>
<p>ğŸ›‘ Reference to generic type â€˜Effectâ€™ requires arguments in &lt;â€¦&gt;<br>
é€šè¿‡æä¾›Actionæ³›å‹ã€‚</p>
</blockquote>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; Effect&lt;Action&gt;
</code></pre>
<p>sendå‡½æ•°å†æ¬¡éœ€è¦æ›´æ–°ã€‚</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effect = self.reducer(&amp;self.value, action)
  effect()
</code></pre>
<blockquote>
<p>âš ï¸ Result of call to function returning â€˜Action?â€™ is unused</p>
</blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è­¦å‘Šã€‚ç°åœ¨è°ƒç”¨<strong>effect</strong>å°†è¿”å›ä¸€ä¸ªéœ€è¦å¤„ç†çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥å¤„ç†å®ƒ</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effect = self.reducer(&amp;self.value, action)
  let action = effect()
</code></pre>
<p>è¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå°è¯•æ‰“å¼€å®ƒã€‚</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effect = self.reducer(&amp;self.value, action)
  if let action = effect() {

  }
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ª<strong>action</strong>åé¦ˆå›å‘é€ã€‚</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effect = self.reducer(&amp;self.value, action)
  if let action = effect() {
    self.send(action)
  }
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬å¾—åˆ°çš„ä¸€ç§åé¦ˆå¾ªç¯:å½“ä¸€ä¸ª<strong>effect</strong>è¿è¡Œæ—¶ï¼Œå¦‚æœå®ƒäº§ç”Ÿäº†ä¸€ä¸ª<strong>action</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å®ƒåé¦ˆç»™<strong>store</strong>ã€‚</p>
<p>è§†å›¾æ–¹æ³•è¿˜æ²¡æœ‰ç¼–è¯‘ã€‚æ— æ“ä½œé—­åŒ…ç°åœ¨å¿…é¡»æ˜¾å¼è¿”å›ä¸€ä¸ªç©ºæ“ä½œã€‚</p>
<pre><code class="language-swift">return { nil }
</code></pre>
<p>æˆ‘ä»¬çš„<strong>reducer</strong>åˆæˆå‡½æ•°éœ€è¦æ›´æ–°ã€‚ç¬¬ä¸€:<strong>combine</strong>ã€‚</p>
<pre><code class="language-swift">public func combine&lt;Value, Action&gt;(
  _ reducers: Reducer&lt;Value, Action&gt;...
) -&gt; Reducer&lt;Value, Action&gt; {
  return { value, action in
    let effects = reducers.map { $0(&amp;value, action) }
    return {
      for effect in effects {
        effect()
      }
    }
</code></pre>
<blockquote>
<p>âš ï¸ Result of call to function returning â€˜Action?â€™ is unused</p>
</blockquote>
<p>è¿™å’Œä¹‹å‰çš„è­¦å‘Šæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è­¦å‘Šï¼Œå› ä¸ºå®ƒè®©æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æ²¡æœ‰å¤„ç†<strong>effect</strong>å¯èƒ½äº§ç”Ÿçš„<strong>action</strong>ã€‚</p>
<pre><code class="language-swift">return {
  for effect in effects {
    let action = effect()
  }
}
</code></pre>
<p>è®©æˆ‘ä»¬è®°ä½è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ª(**)-&gt; Action?**é—­åŒ…ã€‚</p>
<p>åœ¨è¿™ä¸ªé—­åŒ…ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ªå¯é€‰çš„æ“ä½œã€‚</p>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é©¬ä¸Šè¿˜å›å»ã€‚</p>
<pre><code class="language-swift">return { () -&gt; Action? in
  for effect in effects {
    let action = effect()
    return action
  }
}
</code></pre>
<p>è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬å°†åªæ‰§è¡Œç¬¬ä¸€ä¸ª<strong>effect</strong>ï¼Œå¹¶ä¸”åªæœ‰å®ƒçš„å¯é€‰æ“ä½œå¯ä»¥åé¦ˆåˆ°<strong>reducer</strong>ã€‚è¿™æ„å‘³ç€ä»¥åäº§ç”Ÿçš„ä»»ä½•å…¶ä»–å½±å“å°†è¢«å¿½ç•¥ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œæ¯ä¸ª<strong>effect</strong>å¹¶è·Ÿè¸ªæœ€ç»ˆäº§ç”Ÿçš„éé›¶æ“ä½œã€‚</p>
<pre><code class="language-swift">return { () -&gt; Action? in
  var finalAction: Action?
  for effect in effects {
    let action = effect()
    if let action = action {
      finalAction = action
    }
  }
  return finalAction
}
</code></pre>
<p>ä½†è¿™ä¹Ÿå¾ˆå¥‡æ€ªï¼Œå› ä¸ºå°½ç®¡æˆ‘ä»¬è¿è¡Œäº†æ‰€æœ‰çš„<strong>effect</strong>ï¼Œä½†æˆ‘ä»¬åªæä¾›äº†ä¸€ç³»åˆ—<strong>effect</strong>äº§ç”Ÿçš„æœ€åä¸€ä¸ª<strong>action</strong>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯èƒ½ä¼šé”™è¿‡ä¸€äº›åº”è¯¥åé¦ˆç»™<strong>store</strong>çš„<strong>action</strong>ã€‚</p>
<h2 id="4-a-namecombiningmultipleeffectsthatproduceresultsacombining-multiple-effects-that-produce-results">4. <a name='Combiningmultipleeffectsthatproduceresults'></a>Combining multiple effects that produce results</h2>
<p>çœ‹æ¥æˆ‘ä»¬çš„<strong>reducer</strong>å‡½æ•°çš„å½¢çŠ¶è¿˜æ˜¯ä¸å¤ªå¯¹ã€‚</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; Effect&lt;Action&gt;
</code></pre>
<p>è¿”å›ä¸€ä¸ªåŠ¨ä½œçš„å•ä¸ª<strong>effect</strong>ä¸å¤ªè¶³å¤Ÿï¼Œå› ä¸ºå½“æˆ‘ä»¬æŠŠè¿˜åŸå™¨ç»“åˆåœ¨ä¸€èµ·æ—¶ï¼Œæˆ‘ä»¬è¢«è¿«ä¸¢å¤±ä¸€äº›ä¿¡æ¯ã€‚</p>
<p>ç›¸åï¼Œå¦‚æœæˆ‘ä»¬çš„ç®€åŒ–ç¨‹åºå¯ä»¥è¿”å›<strong>effect</strong>æ•°ç»„ï¼Œæˆ‘ä»¬å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action&gt; = (inout Value, Action) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>è¿™ç ´åäº†<strong>send</strong>ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨å¿…é¡»å¾ªç¯æ¯ä¸ª<strong>effect</strong>å¹¶åœ¨å°†å…¶è¿”å›åˆ°å‘é€æ–¹æ³•ä¹‹å‰å±•å¼€å®ƒã€‚</p>
<pre><code class="language-swift">public func send(_ action: Action) {
  let effects = self.reducer(&amp;self.value, action)
  effects.forEach { effect in
    if let action = effect() {
      self.send(action)
    }
  }
}
</code></pre>
<p>åœ¨è§†å›¾æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè€Œä¸æ˜¯nilçš„æ— æ“ä½œé—­åŒ…ã€‚</p>
<pre><code class="language-swift">return []
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿé‡æ–°å®šä¹‰<strong>combine</strong>å‡½æ•°äº†ã€‚<strong>effect</strong>ç°åœ¨ä»¥æ•°ç»„çš„å½¢å¼è¿”å›ï¼Œå› æ­¤æ˜ å°„åˆ°<strong>reducer</strong>ä¸Šå¹¶æ”¶é›†å®ƒä»¬çš„æ‰€æœ‰<strong>effect</strong>çš„ç»“æœå¯¼è‡´äº†<strong>effect</strong>çš„åµŒå¥—æ•°ç»„ã€‚</p>
<pre><code class="language-swift">public func combine&lt;Value, Action&gt;(
  _ reducers: Reducer&lt;Value, Action&gt;...
) -&gt; Reducer&lt;Value, Action&gt; {
  return { value, action in
    let effects = reducers.map { $0(&amp;value, action) }
    ///let effects: [[() -&gt; Action?]]
</code></pre>
<p>æ¯å½“æ‚¨é‡åˆ°è¿™ç§åµŒå¥—é—®é¢˜ï¼Œå³æ˜ å°„ä¸€ä¸ªå€¼è¿›ä¸€æ­¥åµŒå¥—å®ƒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½¬å‘<strong>flatMap</strong>! å› æ­¤ï¼Œé€šè¿‡å°†<strong>map</strong>æ›´æ–°ä¸º<strong>flatMap</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å°†<strong>reducer</strong>æ˜ å°„åˆ°<strong>effect</strong>æ•°ç»„ä¸­ï¼Œç„¶åå°†å®ƒä»¬å±•å¼€ä¸º<strong>effect</strong>æµ…æ•°ç»„ã€‚</p>
<pre><code class="language-swift">let effects = reducers.flatMap { $0(&amp;value, action) }
</code></pre>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬è¦è¿”å›çš„ã€‚</p>
<pre><code class="language-swift">return effects
</code></pre>
<h2 id="5-a-namepullinglocaleffectsbackgloballyapulling-local-effects-back-globally">5. <a name='Pullinglocaleffectsbackglobally'></a>Pulling local effects back globally</h2>
<p>What about <strong>pullback</strong>?</p>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;
) -&gt; Reducer&lt;GlobalValue, GlobalAction&gt; {
  return { globalValue, globalAction in
    guard let localAction = globalAction[keyPath: action] else { return {} }
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert return expression of type â€˜() -&gt; ()â€™ to return type â€˜[() -&gt; GlobalAction]â€™</p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†ç©ºé—­åŒ…æ›¿æ¢ä¸ºç©ºæ•°ç»„ã€‚</p>
<pre><code class="language-swift">guard let localAction = globalAction[keyPath: action] else { return [] }
</code></pre>
<p>å¯¹äºç¬¬äºŒä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å¿…é¡»å¤„ç†è¿™æ ·ä¸€ä¸ªäº‹å®:<strong>effects</strong>ç°åœ¨å…·æœ‰è¿”å›æ“ä½œçš„èƒ½åŠ›ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åŒæ—¶å¤„ç†å±€éƒ¨æ“ä½œå’Œå…¨å±€æ“ä½œã€‚</p>
<pre><code class="language-swift">let effect = reducer(&amp;globalValue[keyPath: value], localAction)
return effect
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert return expression of type â€˜[() -&gt; LocalAction]â€™ to return type â€˜[() -&gt; GlobalAction]â€™</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥å°†<strong>effect</strong>é‡å‘½åä¸º<strong>localEffects</strong>ï¼Œå› ä¸ºå®ƒç°åœ¨æ˜¯ä¸€ä¸ªè¿”å›å±€éƒ¨æ“ä½œçš„å±€éƒ¨æ•ˆæœæ•°ç»„ã€‚</p>
<pre><code class="language-swift">let localEffects = reducer(&amp;globalValue[keyPath: value], localAction)
</code></pre>
<p>æˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼å°†è¿”å›å±€éƒ¨æ“ä½œçš„å±€éƒ¨<strong>effects</strong> æ•°ç»„è½¬æ¢ä¸ºè¿”å›å…¨å±€æ“ä½œçš„å…¨å±€<strong>effects</strong> æ•°ç»„ã€‚è®©æˆ‘ä»¬è¯•è¯•<strong>map</strong>ã€‚æ¯æ¬¡é—­åŒ…è¿è¡Œæ—¶ï¼Œå®ƒéƒ½ä¼šä¼ é€’ä¸€ä¸ªå±€éƒ¨<strong>effect</strong>ã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in

}
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ªå…¨å±€<strong>effect</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿”å›ä¸€ä¸ªå…¨æ–°çš„é—­åŒ…æ¥æè¿°è¿™ä¸ª<strong>effect</strong>ã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in

  }
}
</code></pre>
<p>ä½†æˆ‘ä»¬å¦‚ä½•äº§ç”Ÿå…¨çƒ<strong>effect</strong>å‘¢? æˆ‘ä»¬éœ€è¦è¿™ä¸ªé—­åŒ…è¿”å›ä¸€ä¸ªå¯é€‰çš„å…¨å±€æ“ä½œï¼Œæœ€å¥½æ˜¯ä»å¯é€‰çš„å±€éƒ¨æ“ä½œè¿”å›ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œå±€éƒ¨<strong>effect</strong>æ¥è·å¾—å¯é€‰çš„å±€éƒ¨åŠ¨ä½œã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in
    let localAction = localEffect()

  }
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬ä¸èƒ½è§£åŒ…å®ƒï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›ä¸€ä¸ªnilå…¨å±€æ“ä½œã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in
    guard let localAction = localEffect() else { return nil }

  }
}
</code></pre>
<p>åœ¨è¿™ä¸ª<strong>guard</strong>ä¹‹åï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè¯šå®çš„åœ°æ–¹è¡ŒåŠ¨ï¼Œä½†æˆ‘ä»¬æ‰€å¤„çš„é—­åŒ…éœ€è¦ä¸€ä¸ªå…¨å±€è¡ŒåŠ¨ã€‚æˆ‘ä»¬æ€ä¹ˆåšå‘¢?</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯å†™çš„é”®è·¯å¾„å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹!ä¸ºäº†è·å¾—ä¸€ä¸ªå¯å˜çš„å…¨å±€æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œå¤åˆ¶ã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in
    guard let localAction = localEffect() else { return nil }
    var globalAction = globalAction

  }
}
</code></pre>
<p>ä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é”®è·¯å¾„ä¸‹æ ‡åµŒå…¥ä¸€ä¸ªå±€éƒ¨æ“ä½œã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in
    guard let localAction = localEffect() else { return nil }
    var globalAction = globalAction
    globalAction[keyPath: action] = localAction

  }
}
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä»å…¨å±€<strong>effect</strong>ä¸­è¿”å›å…¨å±€<strong>action</strong>ã€‚</p>
<pre><code class="language-swift">localEffects.map { localEffect in
  return { () -&gt; GlobalAction? in
    guard let localAction = localEffect() else { return nil }
    var globalAction = globalAction
    globalAction[keyPath: action] = localAction
    return globalAction
  }
}
</code></pre>
<p>æˆ‘ä»¬æœ€ç»ˆå¯ä»¥è¿”å›ç»“æœã€‚</p>
<pre><code class="language-swift">return localEffects.map { localEffect in
</code></pre>
<p>ç¼–è¯‘å™¨å¯¹<strong>pullback</strong>å¾ˆæ»¡æ„ã€‚è®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´æ¥è§£é‡Šä¸€ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆå› ä¸ºè¿™ä¸ªå‡½æ•°åšäº†å¾ˆå¤šäº‹æƒ…ã€‚</p>
<p>éå¸¸æ£’çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸º<strong>action enum</strong>ç”Ÿæˆçš„<strong>enum</strong>å±æ€§å¸¦æœ‰<strong>setter</strong>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä»å®ƒä»¬ä¸­è·å¾—å¯å†™é”®è·¯å¾„ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬å®ç°è¿™ä¸ª<strong>pullback</strong>æ‰€éœ€è¦çš„ã€‚</p>
<p><strong>pullback</strong>å‡½æ•°æ˜¯æˆ‘ä»¬å°†ä½œç”¨äºå±€éƒ¨çŠ¶æ€å’Œè¡ŒåŠ¨çš„<strong>reducer</strong>è½¬æ¢ä¸ºä½œç”¨äºå…¨å±€çŠ¶æ€å’Œè¡ŒåŠ¨çš„<strong>reducer</strong>çš„æ–¹æ³•ã€‚å®ƒé€šè¿‡æ„å»ºä¸€ä¸ªå…¨å±€<strong>reducer</strong>,å½“å…¨å±€stateå’Œactionåˆ°æ¥æ—¶,å®ƒä½¿ç”¨å…³é”®è·¯å¾„æå–å±€éƒ¨stateå’Œaction,æœ¬åœ°<strong>reducer</strong>è¿è¡Œå®ƒ,ç„¶åä½¿ç”¨å…³é”®è·¯å¾„æ¥å¡«è¡¥æ–°å±€éƒ¨çŠ¶æ€å›åˆ°å…¨å±€çŠ¶æ€ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿è¡Œå±€éƒ¨<strong>reducer</strong>ç°åœ¨ä¼šäº§ç”Ÿä¸€ä¸ªå±€éƒ¨<strong>effects</strong>æ•°ç»„ï¼Œå³å¯ä»¥å°†å±€éƒ¨æ“ä½œå‘é€å›ç³»ç»Ÿçš„æ•ˆæœã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œå±€éƒ¨<strong>effect</strong>ï¼Œè·å–äº§ç”Ÿçš„å±€éƒ¨<strong>action</strong>ï¼Œå¹¶ä½¿ç”¨å¯å†™é”®è·¯å¾„å°†å…¶åµŒå…¥åˆ°å…¨å±€<strong>action</strong>ä¸­ï¼Œä»è€Œå°†å±€éƒ¨<strong>effect</strong>è½¬æ¢ä¸ºå…¨å±€<strong>effect</strong>ã€‚å°†æ­¤è½¬æ¢åº”ç”¨äºå±€éƒ¨<strong>effect</strong>æ•°ç»„ä¸­çš„æ¯ä¸ª<strong>effect</strong>ï¼Œå°±å®Œæˆäº†è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚</p>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;
) -&gt; Reducer&lt;GlobalValue, GlobalAction&gt; {
  return { globalValue, globalAction in
    guard let localAction = globalAction[keyPath: action] else { return [] }
    let localEffects = reducer(&amp;globalValue[keyPath: value], localAction)
    return localEffects.map { localEffect in
      return { () -&gt; GlobalAction? in
        guard let localAction = localEffect() else { return nil }
        var globalAction = globalAction
        globalAction[keyPath: action] = localAction
        return globalAction
      }
    }
  }
}
</code></pre>
<p><strong>pullback</strong>åšäº†å¾ˆå¤šï¼Œä½†è¿™éƒ½æ˜¯å¾ˆè‡ªç„¶çš„æœºæ¢°å·¥ä½œã€‚åœ¨å®ç°è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ²¡æœ‰å¤ªå¤šçš„é€‰æ‹©ã€‚å®ƒåŸºæœ¬ä¸Šæ€»æ˜¯ä¸€ä¸ª<strong>ç”¨å…³é”®è·¯å¾„å°†å±€éƒ¨å†…å®¹è½¬æ¢ä¸ºå…¨å±€å†…å®¹çš„è¿‡ç¨‹</strong>ã€‚</p>
<p>æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿éœ€è¦æ›´æ–°ï¼Œé‚£å°±æ˜¯<strong>logging</strong>çš„é«˜é˜¶å‡é€Ÿå™¨ã€‚</p>
<pre><code class="language-swift">public func logging&lt;Value, Action&gt;(
  _ reducer: @escaping Reducer&lt;Value, Action&gt;
) -&gt; Reducer&lt;Value, Action&gt; {
  return { value, action in
    let effect = reducer(&amp;value, action)
    let newValue = value
    return {
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert return expression of type â€˜() -&gt; ()â€™ to return type â€˜[() -&gt; Action?]â€™</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦åšä¸€äº›æ”¹åŠ¨ã€‚<strong>reducer</strong>ç°åœ¨è¿”å›ä¸€ä¸ª<strong>effects</strong>æ•°ç»„ã€‚</p>
<pre><code class="language-swift">return { value, action in
  let effects = reducer(&amp;value, action)
</code></pre>
<p>æˆ‘ä»¬éœ€è¦åœ¨è¿™äº›<strong>effects</strong>ä¹‹å‰åŠ ä¸Šæˆ‘ä»¬çš„ <strong>logging effect</strong>ã€‚</p>
<pre><code class="language-swift">public func logging&lt;Value, Action&gt;(
  _ reducer: @escaping Reducer&lt;Value, Action&gt;
) -&gt; Reducer&lt;Value, Action&gt; {
  return { value, action in
    let effects = reducer(&amp;value, action)
    let newValue = value
    return [{
      print(&quot;Action: \(action)&quot;)
      print(&quot;Value:&quot;)
      dump(newValue)
      print(&quot;---&quot;)
      return nil
    }] + effects
  }
}
</code></pre>
<h2 id="6-a-nameworkingwithourneweffectsaworking-with-our-new-effects">6. <a name='Workingwithourneweffects'></a>Working with our new effects</h2>
<p>å¥½å§! å¯ç»„åˆæ¶æ„ç°åœ¨å·²ç»å®Œå…¨æ„å»ºå¥½äº†ï¼Œä½†æ˜¯æœ€å—æ¬¢è¿çš„è´¨æ•°æ¨¡å—è¿˜æ²¡æœ‰ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°ç­¾åï¼Œä»¥åœ¨å…¶æ“ä½œç±»å‹ä¸Šè¿”å›ä¸€ä¸ª<strong>effects</strong>æ³›å‹æ•°ç»„ã€‚</p>
<pre><code class="language-swift">public func favoritePrimesReducer(
  state: inout [Int], action: FavoritePrimesAction
) -&gt; [Effect&lt;FavoritePrimesAction&gt;] {
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸ª<strong>effect</strong>éœ€è¦è§£å†³ã€‚æˆ‘ä»¬å¯ä»¥å°†<strong>no-op</strong>é—­åŒ…æ›´æ–°ä¸º<strong>no-op</strong>æ•°ç»„ã€‚</p>
<pre><code class="language-swift">case let .deleteFavoritePrimes(indexSet):
  for index in indexSet {
    state.remove(at: index)
  }
  return []

case let .loadedFavoritePrimes(favoritePrimes):
  state = favoritePrimes
  return []
</code></pre>
<p><strong>savebuttontap effect</strong>éœ€è¦åŒ…è£…åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå¹¶è¿”å›<strong>nil</strong>ï¼Œä»¥è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå°„åä¸ç†çš„æ“ä½œï¼Œä¸ä¼šå°†ä»»ä½•ç»“æœè¿”å›ç»™<strong>store</strong>ã€‚</p>
<pre><code class="language-swift">case .saveButtonTapped:
  let state = state
  return [{
    let data = try! JSONEncoder().encode(state)
    let documentsPath = NSSearchPathForDirectoriesInDomains(
      .documentDirectory, .userDomainMask, true
      )[0]
    let documentsUrl = URL(fileURLWithPath: documentsPath)
    let favoritePrimesUrl = documentsUrl
      .appendingPathComponent(&quot;favorite-primes.json&quot;)
    try! data.write(to: favoritePrimesUrl)
    return nil
  }]
</code></pre>
<p><strong>loadbuttontap</strong>ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚æˆ‘ä»¬å¯ä»¥å…ˆæŠŠå®ƒåŒ…è£…åœ¨ä¸€ä¸ªæ•°ç»„ä¸­:</p>
<pre><code class="language-swift">case .loadButtonTapped:
  return [{
    let documentsPath = NSSearchPathForDirectoriesInDomains(
      .documentDirectory, .userDomainMask, true
      )[0]
    let documentsUrl = URL(fileURLWithPath: documentsPath)
    let favoritePrimesUrl = documentsUrl
      .appendingPathComponent(&quot;favorite-primes.json&quot;)
    guard
      let data = try? Data(contentsOf: favoritePrimesUrl),
      let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
      else { return }
    self.store.send(.favoritePrimesLoaded(favoritePrimes))
  }]
</code></pre>
<p>ä»¥å‰æˆ‘ä»¬ä¾èµ–äºå¯¹<strong>store</strong>çš„è®¿é—®ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»<strong>effect</strong>è¿”å›æ­¤æ“ä½œï¼Œä»¥ä¾¿<strong>store</strong>ç¨åå¯ä»¥å¯¹å…¶è¿›è¡Œæ‰§è¡Œã€‚</p>
<pre><code class="language-swift">return .favoritePrimesLoaded(favoritePrimes)
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦è¿”å›ä¹‹å‰çº¾å›°çš„nilã€‚</p>
<pre><code class="language-swift">else { return nil }
</code></pre>
<p>è¯¥æ¨¡å—ç°åœ¨å¤„äºæ„å»ºé¡ºåºä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿè¿è¡Œæˆ‘ä»¬çš„<strong>playground</strong>ï¼Œåœ¨é‚£é‡Œä¸€åˆ‡éƒ½åƒä»¥å‰ä¸€æ ·å·¥ä½œï¼Œä½†ç°åœ¨æ‰€æœ‰çš„å‰¯ä½œç”¨éƒ½ç”±<strong>store</strong>æ‰§è¡Œï¼Œè€Œæˆ‘ä»¬çš„<strong>reducer</strong>ä»ç„¶æ˜¯ä¸€ä¸ªçº¯ç²¹çš„å‡½æ•°ã€‚</p>
<p>ä¸€ä¸ªå…³äºç§»åŠ¨è¿™ä¸ª<strong>effect</strong>çš„å·¥ä½œåˆ°<strong>reducer</strong>çš„ç¼ºç‚¹æ˜¯æˆ‘ä»¬çš„<strong>reducer</strong>å·²ç»å˜å¾—ç›¸å½“å¤§ã€‚</p>
<p>å½“æˆ‘ä»¬æ”¯æŒæ›´å¤šçš„<strong>actions</strong>å’Œæ›´å¤šçš„<strong>effects</strong>æ—¶ï¼Œæˆ‘ä»¬é¢ä¸´ç€<strong>reducer</strong>å˜å¾—å·¨å¤§å’Œéš¾ä»¥é˜…è¯»çš„é£é™©ã€‚<br>
ä¸€ä¸ªå¸¸è§çš„è§£å†³æ–¹æ³•æ˜¯æŠŠè¿™ä¸ª<strong>effect</strong>æå–å‡ºæ¥ç»™å°çš„ç§äººåŠ©æ‰‹å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬çš„<strong>reducer</strong>å°±å¯ä»¥ä¿æŒæ¼‚äº®å’Œç®€æ´ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¿å­˜æ•ˆæœæå–åˆ°ä¸€ä¸ªç§æœ‰å‡½æ•°ä¸­ã€‚</p>
<pre><code class="language-swift">private func saveEffect(favoritePrimes: [Int]) -&gt; Effect&lt;FavoritePrimesAction&gt; {
  return {
    let data = try! JSONEncoder().encode(favoritePrimes)
    let documentsPath = NSSearchPathForDirectoriesInDomains(
      .documentDirectory, .userDomainMask, true
      )[0]
    let documentsUrl = URL(fileURLWithPath: documentsPath)
    try! data.write(to: documentsUrl.appendingPathComponent(&quot;favorite-primes.json&quot;))
    return nil
  }
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥ä»<strong>reducer</strong>ä¸­è°ƒç”¨å®ƒã€‚</p>
<pre><code class="language-swift">case .saveButtonTapped:
  let state = state
  return [saveEffect(favoritePrimes: state)]
</code></pre>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ç§»é™¤åœ¨æ•ˆæœé—­åŒ…ä¸­è®¿é—®çŠ¶æ€æ‰€éœ€çš„<strong>let state = state</strong>ã€‚è¿™ä»¥å‰æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºstateæ˜¯å¯å˜çš„ï¼Œè€Œä¸”ä¸å…è®¸ä»é€ƒé€¸é—­åŒ…è®¿é—®å®ƒã€‚ä½†åœ¨æˆ‘ä»¬çš„<strong>saveEffect</strong>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼åœ°è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªä¸å¯å˜çš„æ•´æ•°æ•°ç»„ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†<strong>state</strong>ä¼ é€’ç»™å®ƒã€‚</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [saveEffect(favoritePrimes: state)]
</code></pre>
<p>è´Ÿè½½æ•ˆåº”å¯ä»¥ç±»ä¼¼åœ°æå–:</p>
<pre><code class="language-swift">private let loadEffect: Effect&lt;FavoritePrimesAction&gt; = {
  let documentsPath = NSSearchPathForDirectoriesInDomains(
    .documentDirectory, .userDomainMask, true
    )[0]
  let documentsUrl = URL(fileURLWithPath: documentsPath)
  let favoritePrimesUrl = documentsUrl
    .appendingPathComponent(&quot;favorite-primes.json&quot;)
  guard
    let data = try? Data(contentsOf: favoritePrimesUrl),
    let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
    else { return nil }
  return .favoritePrimesLoaded(favoritePrimes)
}
</code></pre>
<p>And called out to in the reducer:</p>
<pre><code class="language-swift">case .loadButtonTapped:
  return [loadEffect]
</code></pre>
<p>é€šè¿‡æå–è¿™äº›<strong>effects</strong>ï¼Œæˆ‘ä»¬å·²ç»ä½¿æˆ‘ä»¬çš„<strong>reducer</strong>æ›´åŠ ç®€æ´ã€‚å°†å¤æ‚çš„å†…è”æ•ˆæœé‡æ„åˆ°æå–çš„å¸®åŠ©ç¨‹åºä¸­æ€»æ˜¯å¾ˆå®¹æ˜“çš„ã€‚</p>
<h2 id="7-a-namewhatsunidirectionaldataflowawhats-unidirectional-data-flow">7. <a name='Whatsunidirectionaldataflow'></a>Whatâ€™s unidirectional data flow?</h2>
<p>åˆæå–äº†ä¸€ä¸ª<strong>effect</strong>ã€‚è®©æˆ‘ä»¬å†èŠ±ä¸€ç‚¹æ—¶é—´æ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æ‰€å–å¾—çš„æˆå°±ã€‚</p>
<p>æˆ‘ä»¬æƒ³ä»æˆ‘ä»¬çš„è§†å›¾ä¸­æå–ç£ç›˜<strong>effect</strong>çš„åŠ è½½ï¼Œå¹¶ä»¥æŸç§æ–¹å¼åœ¨<strong>reducer</strong>ä¸­å»ºæ¨¡ã€‚æˆ‘ä»¬å¾ˆå¿«æ„è¯†åˆ°è¿™ç§<strong>effect</strong>ä¸æˆ‘ä»¬ä¹‹å‰å¤„ç†çš„<strong>effect</strong>ä¸å¤ªä¸€æ ·ã€‚ä¿å­˜çš„æ•ˆæœæœ¬è´¨ä¸Šæ˜¯â€œå°„åä¸ç†â€ï¼Œå®ƒåªæ˜¯å®Œæˆäº†è‡ªå·±çš„å·¥ä½œï¼Œä¹‹åä¸éœ€è¦é€šçŸ¥ä»»ä½•äººä»»ä½•äº‹æƒ…ã€‚</p>
<p>ç„¶è€Œï¼ŒåŠ è½½<strong>effect</strong>éœ€è¦ä»¥æŸç§æ–¹å¼å°†åŠ è½½çš„æ•°æ®åé¦ˆåˆ°<strong>reducer</strong>ä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿä½œå‡ºååº”ã€‚è¿™å¯¼è‡´æˆ‘ä»¬å°†ç­¾åä»ä¸€ä¸ªç©ºåˆ°ç©ºçš„é—­åŒ…é‡æ„ä¸ºä¸€ä¸ªç©ºåˆ°å¯é€‰çš„åŠ¨ä½œé—­åŒ…ã€‚è¿™å…è®¸<strong>effect</strong>åšæœ€å°‘çš„å¿…è¦å·¥ä½œæ¥å®Œæˆå·¥ä½œï¼Œç„¶åé€šè¿‡å‘é€å¦ä¸€ä¸ªåŠ¨ä½œå°†ç»“æœè¿”å›åˆ°<strong>reducer</strong>ã€‚ ç„¶åï¼Œ<strong>store</strong>æˆä¸ºè¿™äº›<strong>effects</strong>çš„è§£é‡Šå™¨ï¼Œé¦–å…ˆè¿è¡Œ<strong>reducer</strong>ï¼Œæ”¶é›†æ‰€æœ‰æƒ³è¦æ‰§è¡Œçš„æ•ˆæœï¼Œéå†è¯¥é”™è¯¯ä»¥æ‰§è¡Œ<strong>effects</strong>ï¼Œç„¶åå°†<strong>effects</strong>äº§ç”Ÿçš„ä»»ä½•æ“ä½œå‘é€å›<strong>store</strong>ã€‚</p>
<p>è¿™å°±æ˜¯äººä»¬æ‰€è¯´çš„â€œå•å‘æ•°æ®æµâ€ã€‚æ•°æ®åªä¼šä»¥ä¸€ç§æ–¹å¼è¢«æ”¹å˜:ä¸€ä¸ªåŠ¨ä½œè¿›å…¥<strong>reducer</strong>ï¼Œå®ƒå…è®¸<strong>reducer</strong>æ”¹å˜çŠ¶æ€ã€‚å¦‚æœä½ æƒ³é€šè¿‡ä¸€äº›å‰¯ä½œç”¨æ¥æ”¹å˜çŠ¶æ€ï¼Œä½ åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½æ„å»ºä¸€ä¸ªæ–°çš„åŠ¨ä½œï¼Œç„¶ååé¦ˆç»™<strong>reducer</strong>ï¼Œåªæœ‰è¿™æ ·ä½ æ‰æœ‰èƒ½åŠ›æ”¹å˜ã€‚</p>
<p>è¿™ç§ç±»å‹çš„æ•°æ®æµæ˜¯éå¸¸å®¹æ˜“ç†è§£çš„ï¼Œå› ä¸ºæ‚¨åªæœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥æŸ¥çœ‹çŠ¶æ€å¦‚ä½•å‘ç”Ÿçªå˜ï¼Œä½†å®ƒçš„ä»£ä»·æ˜¯éœ€è¦æ·»åŠ é¢å¤–çš„æ“ä½œï¼Œä»¥ä¾¿å°†æ•ˆæœ<strong>effects</strong>è¿”å›åˆ°<strong>reducer</strong>ä¸­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè®¸å¤šUIæ¡†æ¶ï¼ŒåŒ…æ‹¬<strong>SwiftUI</strong>ï¼Œæä¾›äº†ä¸€äº›æ–¹æ³•æ¥é¿å¼€ä¸¥æ ¼çš„å•å‘é£æ ¼ï¼Œä»¥ä¾¿ç®€åŒ–ä½¿ç”¨ï¼Œå°±åƒä»–ä»¬ä½¿ç”¨åŒå‘ç»‘å®šä¸€æ ·ï¼Œä½†è¿™å¯èƒ½ä»¥ä½¿æ•°æ®é€šè¿‡UIçš„æ–¹å¼å¤æ‚åŒ–ä¸ºä»£ä»·ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-76effectful-state-management-synchronous-effects/">
                  <h3 class="post-title">
                    PointFree Episode 76:Effectful State Management: Synchronous Effects
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
