<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Task-based concurrency in Swift | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1663222449571">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="å°±åƒåºåˆ—ä»£ç ä¸€æ ·ï¼Œå¹¶å‘ä»£ç å¯ä»¥æœ‰è®¸å¤šä¸åŒçš„å½¢çŠ¶å’Œå½¢å¼ã€‚å–å†³äºæˆ‘ä»¬è¯•å›¾å®ç°çš„ç›®æ ‡â€”â€”æ— è®ºæ˜¯å¼‚æ­¥è·å–æ•°æ®å—ã€ä»ç£ç›˜åŠ è½½å¤§é‡æ–‡ä»¶ï¼Œè¿˜æ˜¯æ‰§è¡Œä¸€ç»„ç›¸å…³æ“ä½œâ€”â€”å°†è¢«è¯æ˜æ˜¯æœ€é€‚åˆçš„æŠ½è±¡å¯èƒ½å› ç”¨ä¾‹ä¸åŒè€Œæœ‰å¾ˆå¤§å·®å¼‚ã€‚
è¿™æ ·çš„å¹¶å‘ç¼–ç¨‹æŠ½è±¡ä¹‹ä¸€å°±æ˜¯ä»»åŠ¡ã€‚è™½ç„¶ä¹ä¸€..." />
    <meta name="keywords" content="concurrency,GCD" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1663222449571" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Task-based concurrency in Swift</h2>
            <div class="post-date">2019-02-03</div>
            
            <div class="post-content" v-pre>
              <p>å°±åƒåºåˆ—ä»£ç ä¸€æ ·ï¼Œå¹¶å‘ä»£ç å¯ä»¥æœ‰è®¸å¤šä¸åŒçš„å½¢çŠ¶å’Œå½¢å¼ã€‚å–å†³äºæˆ‘ä»¬è¯•å›¾å®ç°çš„ç›®æ ‡â€”â€”æ— è®ºæ˜¯å¼‚æ­¥è·å–æ•°æ®å—ã€ä»ç£ç›˜åŠ è½½å¤§é‡æ–‡ä»¶ï¼Œè¿˜æ˜¯æ‰§è¡Œä¸€ç»„ç›¸å…³æ“ä½œâ€”â€”å°†è¢«è¯æ˜æ˜¯æœ€é€‚åˆçš„æŠ½è±¡å¯èƒ½å› ç”¨ä¾‹ä¸åŒè€Œæœ‰å¾ˆå¤§å·®å¼‚ã€‚</p>
<p>è¿™æ ·çš„å¹¶å‘ç¼–ç¨‹æŠ½è±¡ä¹‹ä¸€å°±æ˜¯ä»»åŠ¡ã€‚è™½ç„¶ä¹ä¸€çœ‹ï¼Œä»»åŠ¡å¯èƒ½ä¸Futures &amp; promiseå’ŒFoundationçš„æ“ä½œAPIéå¸¸ç›¸ä¼¼ï¼Œä½†åœ¨å®ƒä»¬çš„è¡Œä¸ºæ–¹å¼ä»¥åŠå®ƒä»¬ç»™APIç”¨æˆ·çš„æ§åˆ¶çº§åˆ«ä¸Šæœ‰ä¸€äº›æ˜æ˜¾çš„ä¸åŒã€‚</p>
<p>æœ¬å‘¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…¶ä¸­çš„ä¸€äº›åŒºåˆ«ï¼Œä»¥åŠä¸€äº›ä»»åŠ¡å¯ä»¥å˜å¾—éå¸¸æœ‰ç”¨çš„åœºæ™¯ã€‚</p>
<h2 id="the-task-at-hand">The task at hand</h2>
<p>å‡è®¾æˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ªç¤¾äº¤ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”æˆ‘ä»¬å‘ç”¨æˆ·æä¾›äº†åœ¨å‘å¸ƒå¸–å­æ—¶é™„åŠ ç…§ç‰‡å’Œè§†é¢‘çš„é€‰é¡¹ã€‚ç›®å‰ï¼Œå½“ç”¨æˆ·ç‚¹å‡»â€œPublishâ€æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼Œå®ƒä¸Šä¼ æ‰€æœ‰é™„åŠ çš„åª’ä½“ï¼Œä¹Ÿä¸Šä¼ å¸–å­æœ¬èº«çš„æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">func publish(_ post: Post) {
    for photo in post.photos {
        upload(photo)
    }

    for video in post.videos {
        upload(video)
    }

    upload(post)
}
</code></pre>
<p>è™½ç„¶ä¸Šé¢çš„ä»£ç éå¸¸ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€äº›é—®é¢˜ã€‚ é¦–å…ˆï¼Œå½“å‘å¸ƒå®Œæˆæ—¶ï¼Œæˆ‘ä»¬æ— æ³•å¾—åˆ°é€šçŸ¥ã€‚æˆ‘ä»¬ä¹Ÿä¸åšä»»ä½•é”™è¯¯å¤„ç†ï¼Œè¿™æ„å‘³ç€å¦‚æœç…§ç‰‡æˆ–è§†é¢‘ä¸Šä¼ å¤±è´¥ -æˆ‘ä»¬å°†ç»§ç»­ä¸Šä¼ postæ•°æ®ï¼Œè¿™å¹¶ä¸ç†æƒ³ã€‚</p>
<p>æœ‰ç›¸å½“å¤šçš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç€æ‰‹è§£å†³ä¸Šè¿°é—®é¢˜ã€‚ä¸€ç§æƒ³æ³•å¯èƒ½æ˜¯ä½¿ç”¨å†…ç½®çš„Operationå’ŒOperationQueueç±»å‹æ¥é¡ºåºæ‰§è¡Œæ‰€æœ‰æ“ä½œ - ä½†è¿™éœ€è¦æˆ‘ä»¬è¦ä¹ˆè®©æˆ‘ä»¬çš„ç½‘ç»œä»£ç åŒæ­¥ï¼Œæˆ–å­ç±»åŒ–Operationä»¥åˆ›å»ºéå¸¸è‡ªå®šä¹‰çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸¤ç§é€‰æ‹©éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä½†å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹â€œä¸¥å‰â€ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦å¯¹åŸå§‹ä»£ç è¿›è¡Œå¾ˆå¤§çš„ä¿®æ”¹ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œä¸ºäº†è·å¾—æˆ‘ä»¬éœ€è¦çš„æ§åˆ¶ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯æ·±å…¥å †æ ˆä¸€å±‚ï¼Œ å¹¶ä½¿ç”¨äº†Operationå’ŒOperationQueueåŸºäºçš„æ¡†æ¶â€”â€”GCDã€‚</p>
<p>å°±åƒæˆ‘ä»¬åœ¨â€œSwiftä¸­å¤®è°ƒåº¦çš„æ·±å…¥ç ”ç©¶â€ä¸­çœ‹åˆ°çš„ï¼ŒGCDè®©æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å°†ä¸€ç³»åˆ—æ“ä½œç»„åˆåœ¨ä¸€èµ·ï¼Œ å¹¶åœ¨å®Œæˆæ‰€æœ‰ä»»åŠ¡åå¾—åˆ°é€šçŸ¥ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†å¯¹ä¹‹å‰çš„ä¸Šä¼ åŠŸèƒ½åšä¸€äº›å¾®è°ƒ-æ‰€ä»¥ä»–ä»¬ç°åœ¨ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§ä½¿ç”¨é—­åŒ…æ¥è§‚å¯Ÿä»–ä»¬å®Œæˆçš„æ–¹æ³•ï¼Œ å¹¶å¹³è¡¡å‘¼å«è¿›å…¥å’Œç¦»å¼€ä¸€ä¸ªè°ƒåº¦ç»„ï¼Œä»¥ä¾¿åœ¨æ‰€æœ‰åª’ä½“ä¸Šä¼ å®Œæˆæ—¶å¾—åˆ°é€šçŸ¥:</p>
<pre><code class="language-swift">func publish(_ post: Post) {
    let group = DispatchGroup()
    for photo in post.photos {
        group.enter()
        upload(photo) {
            group.leave()
        }
    }
    for video in post.videos {
        group.enter()
        upload(video) {
            group.leave()
        }
    }
    // Calling â€˜notifyâ€™ allows us to observe whenever the whole
    // group was finished using a closure.
    group.notify(queue: .main) {
        upload(post)
    }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç è¿è¡Œå¾—éå¸¸å¥½ï¼Œç»™æˆ‘ä»¬ç•™ä¸‹äº†éå¸¸æ•´æ´çš„ä»£ç ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æ²¡æœ‰è§£å†³ç¼ºä¹é”™è¯¯å¤„ç†çš„é—®é¢˜-æ— è®ºåª’ä½“ä¸Šä¼ æˆåŠŸä¸å¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šç›²ç›®ä¸Šä¼ å¸–å­ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¯é€‰çš„Errorå˜é‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è·Ÿè¸ªå‘ç”Ÿçš„ä»»ä½•é”™è¯¯ã€‚æˆ‘ä»¬å°†å¯¹ä¸Šä¼ å‡½æ•°åšå¦ä¸€ä¸ªè°ƒæ•´ï¼Œè®©å®ƒä»¬å°†ä¸€ä¸ªå¯é€‰çš„é”™è¯¯å‚æ•°ä¼ é€’ç»™å®ƒä»¬çš„å®Œæˆå¤„ç†å™¨ï¼Œ å¹¶ä½¿ç”¨å®ƒæ¥æ•è·é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯-åƒè¿™æ ·:</p>
<pre><code class="language-swift">func publish(_ post: Post) {
    let group = DispatchGroup()
    var anyError: Error?
    for photo in post.photos {
        group.enter()
        upload(photo) { error in
            anyError = anyError ?? error
            group.leave()
        }
    }
    for video in post.videos {
        group.enter()
        upload(video) { error in
            anyError = anyError ?? error
            group.leave()
        }
    }
    group.notify(queue: .main) {
        // If an error was encountered while uploading the
        // postâ€™s media, weâ€™ll call an error handling function
        // instead of proceeding with the post data upload.
        if let error = anyError {
            return handle(error)
        }
        upload(post)
    }
}
</code></pre>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»ä¿®å¤äº†åŸå§‹ä»£ç çš„æ‰€æœ‰æ­£ç¡®æ€§é—®é¢˜ï¼Œä½†åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®©å®ƒå˜å¾—æ›´åŠ å¤æ‚å’Œéš¾ä»¥é˜…è¯»ã€‚ æˆ‘ä»¬çš„æ–°è§£å†³æ–¹æ¡ˆä¹Ÿç›¸å½“ç¹ç(æœ‰ä¸€ä¸ªéœ€è¦è·Ÿè¸ªçš„æœ¬åœ°é”™è¯¯å˜é‡å’Œè°ƒåº¦ç»„è°ƒç”¨)ï¼Œè¿™åœ¨è¿™é‡Œå¯èƒ½ä¸æ˜¯é—®é¢˜ï¼Œä½†åªè¦æˆ‘ä»¬å¼€å§‹ç§»åŠ¨æ›´å¤šçš„å¼‚æ­¥ä»£ç æ¥ä½¿ç”¨è¿™ä¸ªæ¨¡å¼-äº‹æƒ…ä¼šå¾ˆå¿«å˜å¾—æ›´éš¾ç»´æŠ¤ã€‚</p>
<h2 id="its-abstraction-time">Itâ€™s abstraction time!</h2>
<p>è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥é€šè¿‡å¼•å…¥åœ¨GCDä¹‹ä¸Šå¼•å…¥ä¸€ä¸ªåŸºäºä»»åŠ¡çš„ç˜¦æŠ½è±¡å±‚æ¥ç®€åŒ–ä¸Šè¿°æ“ä½œ.</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸ºTaskçš„ç±»å‹ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé—­åŒ…çš„å°è£…åŒ…ï¼Œå®ƒå°†è®¿é—®æ§åˆ¶ä»»åŠ¡æµçš„æ§åˆ¶å™¨:</p>
<pre><code class="language-swift">struct Task {
    typealias Closure = (Controller) -&gt; Void
    private let closure: Closure
    init(closure: @escaping Closure) {
        self.closure = closure
    }
}
</code></pre>
<p>Controllerç±»å‹åè¿‡æ¥æä¾›äº†å®Œæˆæˆ–å¤±è´¥ä¸å…¶å…³è”çš„ä»»åŠ¡çš„æ–¹æ³•ï¼Œ å¹¶é€šè¿‡è°ƒç”¨ä¸€ä¸ªå¤„ç†å™¨æ¥æŠ¥å‘Šä»»åŠ¡çš„ç»“æœ:</p>
<pre><code class="language-swift">extension Task {
    struct Controller {
        fileprivate let queue: DispatchQueue
        fileprivate let handler: (Outcome) -&gt; Void
        func finish() {
            handler(.success)
        }
        func fail(with error: Error) {
            handler(.failure(error))
        }
    }
}
</code></pre>
<p>æ­£å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼ŒResultæœ‰ä¸¤ç§æƒ…å†µâ€”â€”.successå’Œ.failureâ€”â€”è¿™ä½¿å¾—å®ƒéå¸¸ç±»ä¼¼äºå¸¦æœ‰æ³›å‹Voidçš„Resultç±»å‹ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†Resultå®ç°ä¸ºå®ƒè‡ªå·±çš„enumç±»å‹ï¼Œæˆ–è€…ç®€å•åœ°ä½¿ç”¨â€œSwiftç±»å‹åˆ«åçš„åŠ›é‡â€ä¸­çš„ä¸€ç§æŠ€æœ¯ï¼Œä½¿å…¶æˆä¸ºResult<Void>çš„é€šç”¨ç®€å†™:</p>
<pre><code class="language-swift">extension Task {
    enum Outcome {
        case success
        case failure(Error)
    }
}
extension Task {
    typealias Outcome = Result&lt;Void&gt;
}
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å®é™…æ‰§è¡Œæˆ‘ä»¬å°†å®šä¹‰çš„ä»»åŠ¡ã€‚ ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬åœ¨Taskä¸Šæ·»åŠ ä¸€ä¸ªperformæ–¹æ³•ï¼Œå®ƒå°†æ¥å—ä¸€ä¸ªæ˜¾å¼çš„DispatchQueueæ¥æ‰§è¡Œä»»åŠ¡-æˆ–è€…ç®€å•åœ°æ£€ç´¢ä»»ä½•å…¨å±€å¤„ç†ç¨‹åº-ä»¥åŠåœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆåè°ƒç”¨çš„å¤„ç†ç¨‹åºã€‚åœ¨å†…éƒ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç»™å®šçš„DispatchQueueæ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œ é€šè¿‡åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨å¹¶å°†å®ƒä¼ é€’åˆ°ä»»åŠ¡çš„é—­åŒ…ä¸­â€”â€”åƒè¿™æ ·:</p>
<pre><code class="language-swift">extension Task {
    func perform(on queue: DispatchQueue = .global(),
                 then handler: @escaping (Outcome) -&gt; Void) {
        queue.async {
            let controller = Controller(
                queue: queue,
                handler: handler
            )
            self.closure(controller)
        }
    }
}
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„å†…å®¹ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡APIçš„åˆå§‹ç‰ˆæœ¬å°±å®Œæˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨å®ƒäº†ã€‚è®©æˆ‘ä»¬ä»å®šä¹‰ä¸€ä¸ªä»»åŠ¡å¼€å§‹ï¼Œå®ƒå°†å–ä»£ä¹‹å‰çš„ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½ -å®ƒè°ƒç”¨ä¸€ä¸ªåº•å±‚çš„Uploaderç±»ï¼Œç„¶åä½¿ç”¨ä»»åŠ¡çš„æ§åˆ¶å™¨é€šçŸ¥æˆ‘ä»¬ç»“æœ:</p>
<pre><code class="language-swift">extension Task {
    static func uploading(_ photo: Photo,
                          using uploader: Uploader) -&gt; Task {
        return Task { controller in
            uploader.upload(photo.data, to: photo.url) { error in
                if let error = error {
                    controller.fail(with: error)
                } else {
                    controller.finish()
                }
            }
        }
    }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¯ç”¨äº†-è®©æˆ‘ä»¬çœ‹çœ‹åœ¨è°ƒç”¨ç«™ç‚¹ä½¿ç”¨å®ƒæ˜¯ä»€ä¹ˆæ ·å­çš„:</p>
<pre><code class="language-swift">for photo in photos {
    let task = Task.uploading(photo, using: uploader)

    task.perform { outcome in
        // Handle outcome
    }
}
</code></pre>
<p>å¾ˆé…·!ğŸ˜ç„¶è€Œï¼Œå½“æˆ‘ä»¬å¼€å§‹å¯¹ä»»åŠ¡è¿›è¡Œåˆ†ç»„å’Œæ’åºæ—¶ï¼Œä»»åŠ¡çš„åŠ›é‡æ‰çœŸæ­£å¼€å§‹æ˜¾ç°ï¼Œè¿™å°†è®©æˆ‘ä»¬ä»¥ä¸€ç§éå¸¸ä¼˜é›…çš„æ–¹å¼è§£å†³æˆ‘ä»¬æœ€åˆçš„é—®é¢˜ã€‚æ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­!</p>
<h2 id="grouping">Grouping</h2>
<p>åœ¨å‰é¢ï¼Œä¸ºäº†è·Ÿè¸ªä¸€ç»„æ“ä½œä½•æ—¶å®Œæˆï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè¾“å…¥å’Œç¦»å¼€çš„DispatchGroupï¼Œå› æ­¤è®©æˆ‘ä»¬å°†è¯¥é€»è¾‘ç§»æ¤åˆ°æ–°çš„ä»»åŠ¡ç³»ç»Ÿä¸­ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨Taskä¸Šæ·»åŠ ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒå°†æ¥å—ä¸€ä¸ªä»»åŠ¡æ•°ç»„å¹¶å°†å®ƒä»¬åˆ†ç»„åœ¨ä¸€èµ·ã€‚ åœ¨åº•å±‚ï¼Œæˆ‘ä»¬ä»å°†ä½¿ç”¨ä¸ä¹‹å‰å®Œå…¨ç›¸åŒçš„åˆ†æ´¾ç»„é€»è¾‘â€”â€”ä½†ç°åœ¨å°è£…åœ¨ä¸€ä¸ªæ›´å¥½çš„APIä¸­:</p>
<pre><code class="language-swift">extension Task {
    static func group(_ tasks: [Task]) -&gt; Task {
        return Task { controller in
            let group = DispatchGroup()

            // To avoid race conditions with errors, we set up a private
            // queue to sync all assignments to our error variable
            let errorSyncQueue = DispatchQueue(label: &quot;Task.ErrorSync&quot;)
            var anyError: Error?

            for task in tasks {
                group.enter()

                // Itâ€™s important to make the sub-tasks execute
                // on the same DispatchQueue as the group, since
                // we might cause unexpected threading issues otherwise.
                task.perform(on: controller.queue) { outcome in
                    switch outcome {
                    case .success:
                        break
                    case .failure(let error):
                        errorSyncQueue.sync {
                            anyError = anyError ?? error
                        }
                    }
                    group.leave()
                }
            }
            group.notify(queue: controller.queue) {
                if let error = anyError {
                    controller.fail(with: error)
                } else {
                    controller.finish()
                }
            }
        }
    }
}
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§å¤§ç®€åŒ–ä»¥å‰çš„åª’ä½“ä¸Šä¼ ä»£ç ã€‚æˆ‘ä»¬ç°åœ¨æ‰€è¦åšçš„å°±æ˜¯å°†æ¯ä¸ªåª’ä½“ç‰‡æ®µæ˜ å°„åˆ°ä¸€ä¸ªä»»åŠ¡ä¸­ï¼Œç„¶åå°†è¿™äº›ä»»åŠ¡çš„ç»„åˆæ•°ç»„ä¼ é€’åˆ°æˆ‘ä»¬æ–°çš„group APIä¸­ï¼Œå°†å®ƒä»¬éƒ½åˆ†ç»„åˆ°ä¸€ä¸ªå•ä¸€çš„ä»»åŠ¡ä¸­â€”â€”åƒè¿™æ ·:</p>
<pre><code class="language-swift">let photoTasks = post.photos.map { photo in
    return Task.uploading(photo, using: uploader)
}
let videoTasks = post.videos.map { video in
    return Task.uploading(video, using: uploader)
}
let mediaGroup = Task.group(photoTasks + videoTasks)
</code></pre>
<p>æˆ‘ä»¬ä¸ä¾èµ–äºå®Œæˆåˆ†ç»„ä»»åŠ¡çš„é¡ºåºæ—¶ï¼Œåˆ†ç»„æ˜¯å¾ˆå¥½çš„ï¼Œä½†å¹¶ä¸æ€»æ˜¯è¿™æ ·ã€‚å›åˆ°æˆ‘ä»¬æœ€åˆçš„é—®é¢˜ï¼Œæ²¡æœ‰ä¸Šä¼ ä¸€ä¸ªå¸–å­çš„æ•°æ®ï¼Œç›´åˆ°æˆ‘ä»¬ç¡®å®šæ‰€æœ‰åª’ä½“éƒ½æˆåŠŸä¸Šä¼ -è¿™å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå°†åª’ä½“ä¸Šä¼ æ“ä½œä¸å®Œæˆpostä¸Šä¼ çš„æ“ä½œè¿›è¡Œé“¾ç»“æˆ–æ’åºã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ‰©å±•Taskæ¥æ”¯æŒå®ƒ</p>
<h2 id="sequencing">Sequencing</h2>
<p>ä¸å…¶ä½¿ç”¨DispatchGroup(å®ƒå¯¹æˆ‘ä»¬çš„æ“ä½œé¡ºåºæ²¡æœ‰ä»»ä½•æ„è§)ï¼Œä¸å¦‚é€šè¿‡è·Ÿè¸ªå½“å‰ä»»åŠ¡çš„ç´¢å¼•æ¥å®ç°æ’åºï¼Œç„¶ååœ¨å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ä¸€æ—¦æˆ‘ä»¬åˆ°è¾¾äº†ä»»åŠ¡åˆ—è¡¨çš„æœ«å°¾ï¼Œæˆ‘ä»¬å°†è€ƒè™‘å®Œæˆåºåˆ—:</p>
<pre><code class="language-swift">extension Task {
    static func sequence(_ tasks: [Task]) -&gt; Task {
        var index = 0

        func performNext(using controller: Controller) {
            guard index &lt; tasks.count else {
                // Weâ€™ve reached the end of our array of tasks,
                // time to finish the sequence.
                controller.finish()
                return
            }
            let task = tasks[index]
            index += 1
            task.perform(on: controller.queue) { outcome in
                switch outcome {
                case .success:
                    performNext(using: controller)
                case .failure(let error):
                    // As soon as an error was occurred, weâ€™ll
                    // fail the entire sequence.
                    controller.fail(with: error)
                }
            }
        }
        return Task(closure: performNext)
    }
}
</code></pre>
<p>æˆ‘ä»¬ä¸ç®€å•åœ°ä½¿ç”¨ä¸²è¡Œè°ƒåº¦é˜Ÿåˆ—æ¥å®ç°æ’åºçš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å‡è®¾æˆ‘ä»¬çš„åºåˆ—æ€»æ˜¯åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸Šè¢«è°ƒåº¦ - APIç”¨æˆ·å¯ä»¥é€‰æ‹©åœ¨ä»»ä½•ç±»å‹çš„é˜Ÿåˆ—ä¸Šæ‰§è¡Œå®ƒã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬åˆ©ç”¨äº†SwiftåŒæ—¶æ”¯æŒç¬¬ä¸€ç±»å‡½æ•°å’Œå†…è”å‡½æ•°å®šä¹‰çš„äº‹å®â€”â€”å› ä¸ºæˆ‘ä»¬å°†performNextå‡½æ•°ä½œä¸ºä¸€ä¸ªé—­åŒ…ä¼ é€’æ¥ä¸ºæˆ‘ä»¬çš„åºåˆ—åˆ›å»ºä¸€ä¸ªä»»åŠ¡ã€‚</p>
<p>å°±æ˜¯è¿™æ ·â€”â€”ä¿¡ä¸ä¿¡ç”±ä½ ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šå·²ç»ä»å¤´å¼€å§‹æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„åŸºäºä»»åŠ¡çš„å¹¶å‘ç³»ç»Ÿ!ğŸ˜€</p>
<h2 id="putting-all-the-pieces-together">Putting all the pieces together</h2>
<p>æ‰€æœ‰çš„éƒ¨åˆ†å°±ç»ªä¹‹åï¼Œè®©æˆ‘ä»¬æœ€åæ›´æ–°åŸå§‹çš„é‚®æ”¿å‘å¸ƒä»£ç ï¼Œä»¥å……åˆ†åˆ©ç”¨æˆ‘ä»¬çš„æ–°ç³»ç»Ÿæ‰€æä¾›çš„ä¸€åˆ‡ã€‚ æˆ‘ä»¬ä¸å¿…è·Ÿè¸ªé”™è¯¯ï¼Œä¹Ÿä¸å¿…å› ä¸ºç½‘ç»œè°ƒç”¨çš„ä¸å¯é¢„æµ‹æ€§è€Œé‡åˆ°bugã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†ä¸€ç»„åª’ä½“ä¸Šä¼ æ“ä½œä¸ä¸€ä¸ªpostä¸Šä¼ ä»»åŠ¡ç»“åˆèµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªåºåˆ—ï¼Œå°±åƒè¿™æ ·:</p>
<pre><code class="language-swift">func publish(_ post: Post,
             then handler: @escaping (Outcome) -&gt; Void) {
    let photoTasks = post.photos.map { photo in
        return Task.uploading(photo, using: uploader)
    }

    let videoTasks = post.videos.map { video in
        return Task.uploading(video, using: uploader)
    }

    let sequence = Task.sequence([
        .group(photoTasks + videoTasks),
        .uploading(post, using: uploader)
    ])

    sequence.perform(then: handler)
}
</code></pre>
<p>ä¸Šè¿°è§£å†³æ–¹æ¡ˆçš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼Œæ‰€æœ‰å†…å®¹éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„â€”â€”ä½¿ç”¨åˆ†æ´¾é˜Ÿåˆ—-åœ¨å¹•åï¼Œä½†ä½œä¸ºä¸€ä¸ªAPIç”¨æˆ·ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€äº›ä»»åŠ¡ï¼Œå¹¶å‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬æƒ³è¦å¦‚ä½•ç»„åˆå®ƒä»¬ã€‚ç”±äºæˆ‘ä»¬çš„æŠ½è±¡æ˜¯å¦‚æ­¤çš„è–„å¼±ï¼Œå¦‚æœæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜æˆ–æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åªéœ€è¦é™ä½ä¸€çº§æ¥è°ƒè¯•ã€‚</p>
<h2 id="conclusion">Conclusion</h2>
<p>ä»»åŠ¡å¯ä»¥æ˜¯æŠ½è±¡å¤§é‡å¹¶å‘ä»£ç çš„å¥½æ–¹æ³•ï¼Œè¿™äº›ä»£ç è¦ä¹ˆåº”è¯¥ä»¥å°½å¯èƒ½å¤šçš„å¹¶è¡Œæ€§æ‰§è¡Œï¼Œè¦ä¹ˆç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåå†ç»§ç»­æ‰§è¡Œã€‚å®ƒä»¬æœ¬è´¨ä¸Šæä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥åœ¨GCDä¹‹ä¸Šåˆ›å»ºä¸€ä¸ªç®€å•ã€è–„çš„å±‚â€”â€”è¿™è®©æˆ‘ä»¬èƒ½å¤Ÿä»¥ä¸€ç§éå¸¸å¥½çš„æ–¹å¼åˆ©ç”¨å®ƒçš„æ‰€æœ‰åŠŸèƒ½ã€‚</p>
<p>æ­£å¦‚æœ¬æ–‡å‰é¢æåˆ°çš„ï¼Œå½“ç„¶è¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•å¯ä»¥åœ¨Swiftä¸­å®ç°æˆ–ä½¿ç”¨å¹¶å‘æ€§.  Futures &amp; promisesä½¿å¾—éšè—æ­£åœ¨è¿›è¡Œçš„å¹¶å‘å¾ˆå®¹æ˜“ï¼Œä½†ä»£ä»·æ˜¯æ§åˆ¶é‡ç¨ä½â€”â€”è€ŒåƒRxSwiftè¿™æ ·çš„æ¡†æ¶ä½¿æ„å»ºæ›´å¤æ‚çš„æ‰§è¡Œé“¾æˆä¸ºå¯èƒ½ï¼Œä½†ä½¿ç”¨äº†æ›´é‡çš„æŠ½è±¡ã€‚</p>
<p>æˆ‘çš„å»ºè®®æ˜¯åœ¨Swiftä¸­å°è¯•å¤šç§ä¸åŒç±»å‹çš„å¹¶å‘ç¼–ç¨‹â€”â€”çœ‹çœ‹å“ªç§(æˆ–å¤šç§)æœ€é€‚åˆä½ ã€ä½ çš„å›¢é˜Ÿå’Œä½ çš„é¡¹ç›®ã€‚å¸Œæœ›æœ¬æ–‡èƒ½è®©æ‚¨å¯¹å¿«é€Ÿå®ç°ä»»åŠ¡çš„ä¸€ç§æ–¹æ³•æœ‰ä¸€äº›äº†è§£ï¼Œä»¥åŠä¸ç¤¾åŒºä¸­å¸¸ç”¨çš„å…¶ä»–è§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œä»»åŠ¡çš„å®ç°æ–¹å¼å¦‚ä½•ã€‚å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘è®¤ä¸ºæˆ‘çš„ä½¿å‘½å®Œæˆäº†ğŸ˜€ã€‚</p>
<p><a href="https://www.swiftbysundell.com/articles/task-based-concurrency-in-swift/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/ArhVOQ_GL/" class="tag">
                    concurrency
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/C46TKgaZSw/" class="tag">
                    GCD
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/the-power-of-type-aliases-in-swift/">
                  <h3 class="post-title">
                    The power of type aliases in Swift
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
