<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 98:Ergonomic State Management: Part 1 | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1663222449571">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Introduction




The architecture's surface area




Free functions




Reducer as a struct




Reducer methods




..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1663222449571" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 98:Ergonomic State Management: Part 1</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Introduction">Introduction</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Thearchitecturessurfacearea">The architecture's surface area</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Freefunctions">Free functions</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Reducerasastruct">Reducer as a struct</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Reducermethods">Reducer methods</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Updatingtheappsmodules">Updating the app's modules</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 98:Ergonomic State Management: Part 1 -->
<h2 id="1-a-nameintroductionaintroduction">1. <a name='Introduction'></a>Introduction</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»èŠ±äº†å¾ˆå¤šå¾ˆå¤šå‘¨çš„æ—¶é—´ï¼Œä»ç¬¬ä¸€æ€§åŸç†;æ„å»ºäº†æˆ‘ä»¬çš„å¯ç»„åˆæ¶æ„ã€‚å…¶æ ¸å¿ƒè®¾è®¡çš„åŠ¨æœºæ˜¯è¯•å›¾è§£å†³äº”ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å‘ç°è¿™äº”ä¸ªé—®é¢˜å¯¹ä»»ä½•åº”ç”¨ç¨‹åºæ¶æ„éƒ½è‡³å…³é‡è¦ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬æ”¹è¿›äº†è¿™ä¸ªè®¾è®¡ï¼Œè§£å†³äº†ä¸€äº›å†…å­˜æ³„æ¼é—®é¢˜ï¼Œä»¥åŠæˆ‘ä»¬çš„æ¶æ„æœ€åˆå¦‚ä½•ä¸SwiftUIæ¥å£çš„æ½œåœ¨æ€§èƒ½é—®é¢˜ã€‚è§£å†³åä¸€ä¸ªé—®é¢˜ä½¿æˆ‘ä»¬æœ‰æœºä¼šå¢å¼ºæˆ‘ä»¬çš„ä½“ç³»ç»“æ„ï¼Œä½¿å…¶æ›´èƒ½é€‚åº”å„ç§æƒ…å†µï¼Œè¿™å…è®¸æˆ‘ä»¬åœ¨å¤šä¸ªå¹³å°ä¸Šå…±äº«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒåŒæ—¶æ”¹è¿›æ¯ä¸ªå¹³å°ä¸å…±äº«é€»è¾‘äº¤äº’çš„æ–¹å¼ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„æ¶æ„ä¸­è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šä¸œè¥¿éœ€è¦æ¢ç´¢ï¼Œä½†æ˜¯åœ¨è§£å†³äº†è¿™äº›æ¼æ´å’Œæ€§èƒ½é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯æ—¶å€™å°†è¿™äº›ä¸œè¥¿æ‰“åŒ…åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨äº†ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ä¸å…¨ä¸–ç•Œåˆ†äº«ã€‚</p>
<p>ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è§‰å¾—è¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ²¡æœ‰èŠ±å¤§é‡çš„æ—¶é—´åœ¨å¯ç»„åˆæ¶æ„çš„äººä½“å·¥å­¦ä¸Šã€‚æ ¸å¿ƒåº“éå¸¸å°:ä¸åˆ°å‡ ç™¾è¡Œä»£ç ã€‚</p>
<hr>
<h2 id="2-a-namethearchitecturessurfaceareaathe-architectures-surface-area">2. <a name='Thearchitecturessurfacearea'></a>The architecture's surface area</h2>
<p>å®ƒä»å…¶æ ¸å¿ƒå•å…ƒçš„å®šä¹‰å¼€å§‹:ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œ<strong>reducer</strong>â€:</p>
<pre><code class="language-swift">public typealias Reducer&lt;Value, Action, Environment&gt; = (inout Value, Action, Environment) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>è¿™ä¸ªç­¾åæè¿°äº†æ•´ä¸ªåº”ç”¨ç¨‹åºçš„é€»è¾‘:</p>
<ul>
<li>å®ƒå¯ä»¥æ”¹å˜åº”ç”¨ç¨‹åºçŠ¶æ€(è¿™æ˜¯ç”±<strong>Value</strong>ç±»æ•è·çš„)ç»™å®šä¸€ä¸ªåŠ¨ä½œ(é€šå¸¸æ˜¯ä¸€ä¸ªç”¨æˆ·åŠ¨ä½œï¼Œæ¯”å¦‚ç‚¹å‡»æŒ‰é’®)</li>
<li>è¿˜æä¾›äº†è¿™ä¸ª<strong>Environment</strong>ç±»å‹ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬æ‰€æœ‰ç‰¹æ€§çš„ä¾èµ–é¡¹ï¼Œæ¯”å¦‚APIå®¢æˆ·ç«¯ã€æ–‡ä»¶å®¢æˆ·ç«¯å’Œå…¶ä»–éœ€è¦è¿›å…¥æ··ä¹±çš„å¤–éƒ¨ä¸–ç•Œçš„ä»»ä½•ä¸œè¥¿ã€‚</li>
<li>æˆ‘ä»¬å¿…é¡»è¿”å›ä¸€ä¸ªå°†åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œåè¿è¡Œçš„<strong>effects</strong>æ•°ç»„ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’ï¼Œå¹¶å°†å¤–éƒ¨ä¸–ç•Œçš„ä¿¡æ¯åé¦ˆåˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç­¾åå¹¶è¯•å›¾åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºç¼–å†™é€»è¾‘ï¼Œéšç€çŠ¶æ€å’Œæ“ä½œçš„å¢é•¿ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—éš¾ä»¥å¤„ç†ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼Œå‡½æ•°æ˜¯è¶…çº§å¯ç»„åˆçš„ï¼Œ<strong>reducer</strong>ä¹Ÿä¸ä¾‹å¤–ã€‚å®ƒä»¬å¯ä»¥è¢«åˆ†è§£æˆè¶Šæ¥è¶Šå°ã€æ›´å®¹æ˜“ç†è§£çš„å•å…ƒï¼Œç„¶åè¿™äº›å•å…ƒå¯ä»¥è¢«ç²˜åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæ•´ä½“ã€‚</p>
<p>æˆ‘ä»¬èƒ½å¤Ÿåšåˆ°è¿™ä¸€ç‚¹çš„æ–¹æ³•æ˜¯é€šè¿‡ä¸¤ä¸ªå¼ºå¤§çš„æ“ä½œï¼Œ<strong>combine</strong>å’Œ<strong>pullback</strong>ã€‚</p>
<pre><code class="language-swift">public func combine&lt;Value, Action, Environment&gt;(
  _ reducers: Reducer&lt;Value, Action, Environment&gt;...
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  â€¦
}
public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction, GlobalEnvironment, LocalEnvironment&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction, LocalEnvironment&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;,
  environment: @escaping (GlobalEnvironment) -&gt; LocalEnvironment
) -&gt; Reducer&lt;GlobalValue, GlobalAction, GlobalEnvironment&gt; {
  â€¦
}
</code></pre>
<p><strong>combine</strong>å‡½æ•°å…è®¸æˆ‘ä»¬æŠŠä¸€å †<strong>reducers</strong>å·¥ä½œåœ¨åŒä¸€ä¸ªåŸŸç»„åˆè¿›ä¸€ä¸ª,<strong>mega-reducer</strong> è¿è¡Œå¼•æ“ç›–ä¸‹çš„æ‰€æœ‰<strong>reducers</strong>,è€Œ<strong>pullback</strong>å…è®¸æˆ‘ä»¬å°†ä¸€ä¸ªåœ¨å±€éƒ¨åŸŸä¸­å·¥ä½œçš„<strong>reducer</strong>è½¬æ¢ä¸ºä¸€ä¸ªåœ¨æ›´å…¨å±€åŸŸä¸­å·¥ä½œçš„<strong>reducer</strong>ã€‚å®ƒä»¬ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†åº”ç”¨ç¨‹åºé€»è¾‘åˆ†è§£ä¸ºä¸€å †è¾ƒå°çš„ç®€åŒ–ç¨‹åºï¼Œè¿™äº›ç®€åŒ–ç¨‹åºå¯ä»¥ç‹¬ç«‹å­˜åœ¨äºå®ƒä»¬è‡ªå·±çš„ç‹¬ç«‹æ¨¡å—ä¸­ã€‚ç„¶åï¼Œåœ¨åº”ç”¨ç¨‹åºçº§åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰æ›´å°çš„ã€æ›´ç‰¹å®šäºé¢†åŸŸçš„<strong>reducer</strong>æ‹‰å›å…¨å±€çš„åº”ç”¨ç¨‹åºåŸŸï¼Œåœ¨é‚£é‡Œå®ƒä»¬å¯ä»¥åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„<strong>reducer</strong>ï¼Œä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæä¾›åŠ¨åŠ›ã€‚</p>
<p>åœ¨è¿™äº›å‡½æ•°çš„æ­£ä¸‹æ–¹ï¼Œæˆ‘ä»¬æœ‰å¦ä¸€ä¸ªå‡½æ•°ï¼Œ<strong>logging</strong>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œé«˜é˜¶â€<strong>reducer</strong>ï¼Œå› ä¸ºå®ƒå°†<strong>reducer</strong>ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ª<strong>reducer</strong>ä½œä¸ºè¾“å‡ºã€‚</p>
<pre><code class="language-swift">public func logging&lt;Value, Action, Environment&gt;(
  _ reducer: Reducer&lt;Value, Action, Environment&gt;
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  â€¦
}
</code></pre>
<hr>
<h2 id="3-a-namefreefunctionsafree-functions">3. <a name='Freefunctions'></a>Free functions</h2>
<p>åœ¨æˆ‘ä»¬ç»§ç»­è®¨è®ºè¿™ä¸ªæ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥è§£å†³ä¸€ä¸ªäº‹å®ï¼Œå³è¿™äº›apiå¯èƒ½æ¯”è¾ƒçªå‡ºï¼Œå› ä¸ºå®ƒä»¬éƒ½è¢«å®šä¹‰ä¸ºè‡ªç”±å‡½æ•°:â€œ<strong>free</strong>â€æ˜¯å› ä¸ºå®ƒä»¬æ²¡æœ‰è¢«é™åˆ¶åœ¨ä¸€ä¸ªç±»å‹ä¸­ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­è¿˜æ˜¯ä¼šæ„Ÿè§‰æœ‰ç‚¹ä¸åˆé€‚ï¼Œè€Œä¸”å®ƒä»¬å¯èƒ½ä¼šå¼•å…¥ä¸€äº›å°´å°¬çš„äººä½“å·¥ç¨‹å­¦ã€‚</p>
<p>è¦æŸ¥çœ‹<strong>pullback and combine</strong>åœ¨å®è·µä¸­çš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥è·³åˆ°æˆ‘ä»¬çš„åº”ç”¨ç›®æ ‡ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬æ„å»ºäº†é¡¶çº§çš„<strong>app reducer</strong>:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(
    counterViewReducer,
    value: \AppState.counterView,
    action: /AppAction.counterView,
    environment: { $0.nthPrime }
  ),
  pullback(
    counterViewReducer,
    value: \AppState.counterView,
    action: /AppAction.offlineCounterView,
    environment: { $0.offlineNthPrime }
  ),
  pullback(
    favoritePrimesReducer,
    value: \.favoritePrimes,
    action: /AppAction.favoritePrimesState,
    environment: { ($0.fileClient, $0.nthPrime) }
  )
)
</code></pre>
<p>åƒè¿™æ ·çš„å‡½æ•°è°ƒç”¨å¯¹å¤§å¤šæ•°Swiftå¼€å‘äººå‘˜æ¥è¯´å¯èƒ½æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ™¯è±¡ï¼Œå¯¹ä¸€äº›äººæ¥è¯´ç”šè‡³å¯èƒ½æ˜¯ä¸€ä¸ªä¸èˆ’æœçš„! æ„Ÿè§‰ä¸Šå¥½åƒ<strong>pullback and combine</strong>å·²ç»æ³„éœ²åˆ°â€œ<strong>global</strong>â€åç§°ç©ºé—´ä¸­äº†ã€‚</p>
<p>å‡½æ•°è°ƒç”¨ä¹Ÿå˜å¾—åµŒå¥—ï¼Œåœ¨Swiftä¸­éš¾ä»¥é˜…è¯»:ä½ çš„çœ¼ç›éœ€è¦æµè§ˆåœ†æ‹¬å·å±‚ï¼Œä»¥è·å¾—å‡½æ•°è°ƒç”¨é¡ºåºçš„å¥æŸ„ã€‚</p>
<p>ç°åœ¨æœ‰äº†è§£å†³åµŒå¥—é—®é¢˜çš„æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œæ—©åœ¨Point-Freeçš„ç¬¬ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å°±çœ‹åˆ°ï¼Œåœ¨ä¸€ä¸¤ä¸ªæ“ä½œç¬¦çš„å¸®åŠ©ä¸‹ï¼Œå¯ä»¥ä½¿è‡ªç”±å‡½æ•°è°ƒç”¨æ›´å…·å¯è¯»æ€§ã€‚ç„¶è€Œ,æˆ‘ä»¬ç†è§£,è‡ªå®šä¹‰æ“ä½œç¬¦çš„è¯é¢˜åœ¨Swiftç¤¾åŒºè®¨è®ºå¾ˆæ¿€çƒˆ,è€Œä¸æ˜¯æ¯ä¸ªäººæˆ–æ¯ä¸ªå›¢é˜Ÿå°†èˆ’é€‚çš„å¼•å…¥ä»–ä»¬ä»£ç åº“,æ‰€ä»¥ä¸€æ®µæ—¶é—´ä»¥å,æˆ‘ä»¬å¼•å…¥äº†å¦ä¸€ä¸ªæ“ä½œç¬¦çš„å½¢å¼â€œ<strong>Overture</strong>â€,ä¸€ç»„é€šç”¨å‡½æ•°å¼ç¼–ç¨‹çš„åŠŸèƒ½ã€‚å®ƒä¹Ÿæ—¨åœ¨è§£å†³è¿™ç§åµŒå¥—é—®é¢˜ï¼Œä½†ä¸éœ€è¦è‡ªå®šä¹‰æ“ä½œç¬¦ã€‚</p>
<p>è™½ç„¶åœ¨<strong>combine</strong>ä¸­åµŒå¥—<strong>pullback</strong>å¹¶ä¸æ˜¯é‚£ä¹ˆç³Ÿç³•ï¼Œä½†æ˜¯åµŒå¥—ä¼šéšç€æˆ‘ä»¬æ·»åŠ é¢å¤–åŠŸèƒ½è€Œå¢åŠ ï¼Œå°±åƒæˆ‘ä»¬ä½¿ç”¨æ›´é«˜é˜¶çš„<strong>reducers</strong>(å¦‚æ—¥å¿—è®°å½•)ä¸€æ ·ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘ä»¬è·³è½¬åˆ°æˆ‘ä»¬çš„<strong>scene delegate</strong>ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°:</p>
<pre><code class="language-swift">rootView: ContentView(
  store: Store(
    initialValue: AppState(),
    reducer: with(
      appReducer,
      compose(
        logging,
        activityFeed
      )
    ),
    â€¦
  )
)
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ä¸€ç»„åµŒå¥—å‡½æ•°è°ƒç”¨ï¼Œç”¨äºæ·»åŠ <strong>logging</strong>å’Œå¦ä¸€ä¸ªé«˜é˜¶<strong>reducer activityFeed</strong>ï¼Œåˆ°æˆ‘ä»¬çš„åº”ç”¨<strong>reducer</strong>ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<strong>withå’Œcompose</strong>å‡½æ•°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œå®ƒä»¬æ¥è‡ªæˆ‘ä»¬çš„Overtureåº“!å¦‚æœæ²¡æœ‰å®ƒä»¬ï¼Œæˆ‘ä»¬é€’ç»™å•†åº—çš„å‡é€Ÿå™¨å°†æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-swift">logging(activityFeed(appReducer))
</code></pre>
<p>è¿™ä¸ªç‰¹æ®Šçš„ä¾‹å­æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é¿å…çš„åµŒå¥—å¹¶ä¸æ˜¯ä¸–ç•Œä¸Šæœ€ç³Ÿç³•çš„ï¼Œä½†æ˜¯ä½ å¯ä»¥æƒ³è±¡å½“ä½ æœ‰å…­ä¸ªé«˜é˜¶çš„<strong>reducers</strong>æ—¶ï¼ŒåµŒå¥—ä¼šå˜å¾—è¶Šæ¥è¶Šç¬¨æ‹™ã€‚</p>
<pre><code class="language-swift">logging(activityFeed(barEnhancer(fooEnhancer(appReducer))))
</code></pre>
<p><strong>Overture</strong>æ˜¯é’ˆå¯¹è¿™äº›é—®é¢˜çš„å®Œç¾è§£å†³æ–¹æ¡ˆï¼Œä½†ç†æƒ³æƒ…å†µä¸‹å®ƒä¸æ˜¯å¯ç»„åˆæ¶æ„çš„ä¾èµ–ï¼Œä¹Ÿä¸æ˜¯ä»¥äººä½“å·¥ç¨‹å­¦æ–¹å¼ä½¿ç”¨æˆ‘ä»¬çš„æ¶æ„çš„è¦æ±‚ã€‚</p>
<p>å¦‚æœä¸æ˜¯åœ¨è‡ªç”±å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨å“ªé‡Œå®šä¹‰è¿™äº›ä¸œè¥¿? Swiftä¼¼ä¹æ›´å–œæ¬¢å°†é€»è¾‘æ”¾åœ¨é™æ€å‡½æ•°å’Œç±»å‹çš„æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šæŠŠè¿™ä¸ªé€»è¾‘ç§»åŠ¨åˆ°ä¸€ä¸ª<strong>Reducer</strong>æ‰©å±•ä¸­:</p>
<pre><code class="language-swift">extension Reducer {
}
ğŸ›‘ Non-nominal type â€˜Reducerâ€™ cannot be extended
</code></pre>
<p>ä½†è¿™ä¸ä¼šèµ·ä½œç”¨ï¼Œå› ä¸º<strong>Reducer</strong>åªæ˜¯ä¸€ä¸ªå‡½æ•°ç­¾åçš„ç±»å‹åˆ«åï¼Œè€Œå‡½æ•°æ˜¯Swiftç§°ä¸ºâ€œnon-nominalâ€ç±»å‹çš„ä¸€ä¸ªä¾‹å­ï¼Œè€Œéæ ‡ç§°ç±»å‹ç›®å‰ä¸èƒ½ç”¨é™æ€å‡½æ•°æˆ–æ–¹æ³•æ‰©å±•ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªé€‰æ‹©ã€‚æœ‰ä¸€ç§éå¸¸ç®€å•çš„æ–¹æ³•å¯ä»¥ä¸ºå‡½æ•°åˆ›å»ºä¸€ä¸ªæ¼‚äº®çš„åç§°ç©ºé—´ï¼Œæ¯”å¦‚<strong>reducers</strong>ï¼Œé‚£å°±æ˜¯å°†å®ƒä»¬åŒ…è£…åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ã€‚</p>
<p>ä¸ºäº†äººæœºå·¥ç¨‹å­¦ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå‡½æ•°åŒ…è£…ä¸ºä¸€ä¸ªç±»å‹:</p>
<p>äº‹å®ä¸Šï¼Œè¿™ä¸ªæ•…äº‹ç”šè‡³å·²ç»åœ¨å¯ç»„åˆæ¶æ„ä¸­å‡ºç°äº†! æˆ‘ä»¬é¦–å…ˆå°†<strong>Effect</strong>ç±»å‹ä½œä¸ºå‡½æ•°çš„ç®€å•ç±»å‹åˆ«åå¼•å…¥ã€‚</p>
<pre><code class="language-swift">typealias Effect&lt;A&gt; = (@escaping (A) -&gt; Void) -&gt; Void
</code></pre>
<p>ä½†æ˜¯å½“æˆ‘ä»¬å¼€å§‹æ¢ç´¢<strong>effects</strong>æ˜¯å¦‚ä½•ç»„åˆå’Œè½¬æ¢æ—¶ï¼Œæˆ‘ä»¬ä¹ŸæŠŠå®ƒåŒ…è£…åœ¨ä¸€ä¸ªç»“æ„ä¸­!</p>
<pre><code class="language-swift">//struct Effect&lt;A&gt; {
//  let run: (@escaping (A) -&gt; Void) -&gt; Void
//}
</code></pre>
<p>æ¯æ¬¡æˆ‘ä»¬å°†ä¸€ä¸ªå‡½æ•°åŒ…è£…åœ¨ä¸€ä¸ªç±»å‹ä¸­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®ƒå˜å¾—æ›´åŠ ç¬¦åˆäººä½“å·¥ç¨‹å­¦ã€‚</p>
<hr>
<h2 id="4-a-namereducerasastructareducer-as-a-struct">4. <a name='Reducerasastruct'></a>Reducer as a struct</h2>
<p>è¿™é‡Œæˆ‘ä»¬åˆæœ‰äº†å¦ä¸€ä¸ªå‡½æ•°ï¼Œ<strong>reducer</strong>ã€‚è®©æˆ‘ä»¬æŠŠå®ƒåŒ…è£…åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥å†æ¬¡æ”¹å–„ä½¿ç”¨å®ƒä»¬çš„äººä½“å·¥ç¨‹å­¦ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç®€å•åœ°æ³¨é‡Šæ‰å®šä¹‰çš„ç±»å‹åˆ«åã€‚</p>
<pre><code class="language-swift">//public typealias Reducer&lt;Value, Action, Environment&gt; = (inout Value, Action, Environment) -&gt; [Effect&lt;Action&gt;]
</code></pre>
<p>å¹¶åœ¨å…·æœ‰å•ä¸ªå­—æ®µçš„ç»“æ„ä½“ä¸­è¿›è¡Œäº¤æ¢ã€‚</p>
<pre><code class="language-swift">public struct Reducer&lt;Value, Action, Environment&gt; {
  let reducer: (inout Value, Action, Environment) -&gt; [Effect&lt;Action&gt;]
}
</code></pre>
<p>æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»å¯ç»„åˆæ¶æ„æ¨¡å—å¤–éƒ¨å®ä¾‹åŒ–è¿™äº›å€¼ï¼Œå› æ­¤è®©æˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªå…¬å…±åˆå§‹åŒ–å™¨ã€‚</p>
<pre><code class="language-swift">public init(
  _ reducer: @escaping (inout Value, Action, Environment) -&gt; [Effect&lt;Action&gt;]
) {
  self.reducer = reducer
}
</code></pre>
<p>å¥½äº†ï¼Œè¿™ä¸ªæ¨¡å—ä¸­æœ‰å¾ˆå¤šä¸œè¥¿åäº†ã€‚è®©æˆ‘ä»¬ä¸€æ¬¡è§£å†³ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ç»„åˆå‡½æ•°ä¸­æœ‰å‡ ä¸ªé”™è¯¯ã€‚</p>
<pre><code class="language-swift">public func combine&lt;Value, Action, Environment&gt;(
  _ reducers: Reducer&lt;Value, Action, Environment&gt;...
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return { value, action, environment in

ğŸ›‘ Cannot convert return expression of type â€˜(_, _, _) -&gt; _â€™ to return type â€˜Reducer&lt;Value, Action, Environment&gt;â€™
</code></pre>
<p>æ—¢ç„¶<strong>reducers</strong>æ˜¯ä¸€ç§ç±»å‹ï¼Œé‚£ä¹ˆä½¿ç”¨è£¸é—­åŒ…åˆ›å»ºå®ƒä»¬å°±ä¸å†æœ‰æ•ˆäº†ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªå°¾éšé—­åŒ…ä¼ é€’ç»™<strong>Reducer</strong>åˆå§‹åŒ–å™¨ã€‚</p>
<pre><code class="language-swift">public func combine&lt;Value, Action, Environment&gt;(
  _ reducers: Reducer&lt;Value, Action, Environment&gt;...
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return Reducer { value, action, environment in
    let effects = reducers.flatMap { $0.reducer(&amp;value, action, environment) }
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot call value of non-function type â€˜Reducer&lt;Value, Action, Environment&gt;â€™</p>
</blockquote>
<p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯Reducerç°åœ¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæˆ‘ä»¬ä¸èƒ½å†æŠŠå®ƒä½œä¸ºå‡½æ•°ç›´æ¥è°ƒç”¨ã€‚</p>
<p>æˆ‘ä»¬çš„ä¸€ä¸ªé€‰æ‹©æ˜¯è¿›å…¥å®ƒçš„<strong>reducer</strong>å­—æ®µ:</p>
<pre><code class="language-swift">public func combine&lt;Value, Action, Environment&gt;(
  _ reducers: Reducer&lt;Value, Action, Environment&gt;...
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return Reducer { value, action, environment in
    let effects = reducers.flatMap { $0.reducer(&amp;value, action, environment) }
</code></pre>
<p>ä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¾èµ–Swift5.2 çš„å…¨æ–°åŠŸèƒ½â€œ<strong>callable values</strong>â€ã€‚å¦‚æœç±»å‹å®šä¹‰äº†<strong>callAsFunction</strong>æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è°ƒç”¨å®ƒï¼Œå°±åƒå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ä¸€æ ·ã€‚</p>
<pre><code class="language-swift">extension Reducer {
  public func callAsFunction(
    _ value: inout Value,
    _ action: Action,
    _ environment: Environment
  ) -&gt; [Effect&lt;Action&gt;] {
    self.reducer(&amp;value, action, environment)
  }
}
</code></pre>
<p>ç°åœ¨<strong>reducer</strong>å¯ä»¥åƒä»¥å‰ä¸€æ ·æ„‰å¿«åœ°è¢«è°ƒç”¨ã€‚</p>
<pre><code class="language-swift">let effects = reducers.flatMap { $0(&amp;value, action, environment) }
</code></pre>
<p>æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯<strong>pullback</strong>ã€‚</p>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction, LocalEnvironment, GlobalEnvironment&gt;(
  _ reducer: @escaping Reducer&lt;LocalValue, LocalAction&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;,
  environment: @escaping (GlobalEnvironment) -&gt; LocalEnvironment
) -&gt; Reducer&lt;GlobalValue, GlobalAction&gt; {
  return { globalValue, globalAction, globalEnvironment in
    guard let localAction = globalAction[keyPath: action] else { return [] }
    let localEffects = reducer(&amp;globalValue[keyPath: value], action: localAction, environment: environment(globalEnvironment))
</code></pre>
<blockquote>
<p>ğŸ›‘ @escaping attribute only applies to function types ğŸ›‘ Cannot convert return expression of type â€˜(_, _, _) -&gt; _â€™ to return type â€˜Reducer&lt;Value, Action, Environment&gt;â€™</p>
</blockquote>
<ul>
<li>
<p>æˆ‘ä»¬ä¸å†éœ€è¦@escapingå±æ€§ï¼Œå› ä¸ºå®ƒåªé€‚ç”¨äºå‡½æ•°ç±»å‹ï¼Œè€Œ<strong>Reducer</strong>ç°åœ¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè€Œä¸”<strong>Reducer</strong>ç»“æ„ä½“çš„åˆå§‹åŒ–å™¨å·²ç»æ•è·äº†å‡½æ•°å·²è½¬ä¹‰çš„äº‹å®ã€‚</p>
</li>
<li>
<p>æˆ‘ä»¬è¿˜éœ€è¦å°†è¿”å›çš„å‡½æ•°åŒ…è£…åœ¨<strong>Reducer</strong>åˆå§‹åŒ–å™¨ä¸­ã€‚</p>
</li>
</ul>
<pre><code class="language-swift">public func pullback&lt;LocalValue, GlobalValue, LocalAction, GlobalAction, LocalEnvironment, GlobalEnvironment&gt;(
  _ reducer: Reducer&lt;LocalValue, LocalAction&gt;,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;,
  environment: @escaping (GlobalEnvironment) -&gt; LocalEnvironment
) -&gt; Reducer&lt;GlobalValue, GlobalAction&gt; {
  return .init { globalValue, globalAction, globalEnvironment in
    guard let localAction = globalAction[keyPath: action] else { return [] }
    let localEffects = reducer(&amp;globalValue[keyPath: value], localAction, environment(globalEnvironment))
</code></pre>
<p>æˆ‘ä»¬éœ€è¦å¯¹æ—¥å¿—çš„é«˜é˜¶<strong>reducer</strong>åšåŒæ ·çš„æ›´æ”¹:</p>
<pre><code class="language-swift">public func logging&lt;Value, Action, Environment&gt;(
  _ reducer: Reducer&lt;Value, Action, Environment&gt;
) -&gt; Reducer&lt;Value, Action, Environment&gt; {
  return .init { value, action, environment in
</code></pre>
<p>åªå‰©ä¸‹å‡ ä¸ªé”™è¯¯äº†ï¼Œå®ƒä»¬åœ¨<strong>Store</strong>ä¸­ï¼Œ<strong>Store</strong>æ˜¯æ”¯æŒæˆ‘ä»¬æ¶æ„çš„è¿è¡Œæ—¶ç±»ã€‚</p>
<p><strong>Stores</strong>æ˜¯ç”¨ä¸€ä¸ª<strong>reducer</strong>åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†æ¬¡åˆ é™¤@<strong>escaping</strong>è¦æ±‚:</p>
<pre><code class="language-swift">public init&lt;Environment&gt;(
  initialValue: Value,
  reducer: Reducer&lt;Value, Action, Environment&gt;,
  environment: Environment
) {
</code></pre>
<p>åœ¨åˆå§‹åŒ–å™¨çš„ä¸»ä½“ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°çš„<strong>reducer</strong>åŒ…è£…ç»™å®šçš„<strong>reducer</strong>ï¼Œä»¥ä¾¿â€œæ¶ˆé™¤â€å®ƒçš„ç¯å¢ƒï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨æ¨¡å—ä¾èµ–ç®¡ç†çš„ç« èŠ‚ä¸­æåˆ°çš„ã€‚è¿™ä¸ª<strong>reducer</strong>ä¹Ÿéœ€è¦è°ƒç”¨<strong>Reducer</strong>çš„åˆå§‹åŒ–å™¨:</p>
<pre><code class="language-swift">) {
  self.reducer = Reducer { value, action, environment in
    reducer(&amp;value, action, environment as! Environment)
  }
  self.value = initialValue
  self.environment = environment
}
</code></pre>
<p>æœ€åï¼Œ<strong>stores</strong>æœ‰ä¸€ä¸ª<strong>scope</strong>æ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†å…¨å±€çŠ¶æ€å’Œå…¨å±€æ“ä½œä¸Šçš„<strong>stores</strong>è½¬æ¢ä¸ºæ›´å¤šå±€éƒ¨çŠ¶æ€å’Œå±€éƒ¨æ“ä½œä¸Šçš„<strong>stores</strong>ã€‚ æ­£æ˜¯è¿™ä¸ªæ“ä½œå…è®¸æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºçš„è§†å›¾éš”ç¦»åˆ°å®ƒä»¬è‡ªå·±çš„æ¨¡å—ä¸­ã€‚</p>
<p>åœ¨å†…éƒ¨ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªéœ€è¦æ–°çš„<strong>reducer</strong>çš„æ–°<strong>store</strong>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è°ƒç”¨<strong>reducer</strong>ã€‚å†æ¬¡åˆå§‹åŒ–:</p>
<pre><code class="language-swift">public func view&lt;LocalValue, LocalAction&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action
) -&gt; Store&lt;LocalValue, LocalAction&gt; {
  let localStore = Store&lt;LocalValue, LocalAction&gt;(
    initialValue: toLocalValue(self.value),
    reducer: .init { localValue, localAction, _ in
</code></pre>
<p>å°±åƒè¿™æ ·ï¼Œå¯ç»„åˆæ¶æ„åˆå¼€å§‹æ„å»ºäº†!</p>
<hr>
<h2 id="5-a-namereducermethodsareducer-methods">5. <a name='Reducermethods'></a>Reducer methods</h2>
<p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªè‡ªç„¶çš„å‘½åç©ºé—´ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ç»„åˆå‡½æ•°å¯ä»¥æ›´æ–°ä¸ºæ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„é™æ€å‡½æ•°å’Œæ–¹æ³•:</p>
<p>è®©æˆ‘ä»¬ä»<strong>combine</strong>å¼€å§‹ã€‚å®ƒæ˜¯ä¸€ä¸ªè‡ªç”±çš„ã€å¯å˜çš„å‡½æ•°ï¼Œç»“åˆäº†ä»»æ„æ•°é‡çš„ç»™å®š<strong>reducers</strong>ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä¸ªé™æ€å‡½æ•°åµŒå¥—åœ¨<strong>Reducer</strong>æ‰©å±•ä¸­ï¼Œç„¶åå»æ‰æ³›å‹ï¼Œå› ä¸ºå®ƒä»¬ç°åœ¨åœ¨ç±»å‹ä¸­æ˜¯éšå¼çš„:</p>
<pre><code class="language-swift">extension Reducer {
  public static func combine(
    _ reducers: Reducer...
  ) -&gt; Reducer {
    return Reducer { value, action, environment in
      let effects = reducers.flatMap { $0(&amp;value, action, environment) }
      return effects
    }
  }
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°ä½“ä¸­çš„ä»»ä½•ä¸œè¥¿éƒ½ä¸éœ€è¦æ”¹å˜ã€‚</p>
<p>æˆ‘ä»¬å°†å…¶ä½œä¸ºä¸€ä¸ªé™æ€å‡½æ•°è€Œä¸æ˜¯æ–¹æ³•ï¼Œå› ä¸ºä¸æ¸…æ¥šæ˜¯å¦æœ‰ä¸€ä¸ªç‰¹å®šçš„<strong>reducer</strong>å¯ä»¥è¿›è¡Œç‚¹è¿æ¥ã€‚ç›¸åï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå®Œæ•´çš„åˆ—è¡¨ï¼Œæ‰€æœ‰çš„<strong>reducers</strong>éƒ½æ˜¯åŒç­‰é‡è¦çš„ã€‚</p>
<p>æ¥ä¸‹æ¥:<strong>pullback</strong>ã€‚å› ä¸º<strong>pullback</strong>ä»¥å•ä¸ª<strong>reducer</strong>ä½œä¸ºè¾“å…¥ï¼Œè€Œä¸æ˜¯åˆ›å»ºå¦ä¸€ä¸ªé™æ€å‡½æ•°ï¼Œæˆ‘ä»¬å¯èƒ½å¯ä»¥æ›´å¥½åœ°å°†å…¶åŠŸèƒ½è¡¨è¾¾ä¸ºå¢å¼ºå½“å‰self<strong>reducer</strong>çš„æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†<strong>pullback</strong>ç§»åŠ¨åˆ°æˆ‘ä»¬çš„<strong>Reducer</strong>ç»“æ„ä½“ä¸­ï¼Œæ¶ˆé™¤<strong>Reducer</strong>å‚æ•°:</p>
<pre><code class="language-swift">extension Reducer {
  // â€¦
  public func pullback&lt;GlobalValue, GlobalAction, GlobalEnvironment&gt;(
    value: WritableKeyPath&lt;GlobalValue, Value&gt;,
    action: WritableKeyPath&lt;GlobalAction, Action?&gt;,
    environment: @escaping (GlobalEnvironment) -&gt; Environment
  ) -&gt; Reducer&lt;GlobalValue, GlobalAction, GlobalEnvironment&gt; {
    return .init { globalValue, globalAction, globalEnvironment in
      guard let localAction = globalAction[keyPath: action] else { return [] }
      let localEffects = self(&amp;globalValue[keyPath: value], localAction, environment(globalEnvironment))
</code></pre>
<p>æˆ‘ä»¬ç”šè‡³èƒ½å¤Ÿé€šè¿‡åˆ©ç”¨<strong>reducer</strong>çš„<strong>Value, Action, and Environment</strong>æ‘†è„±3ä¸ªæœ¬åœ°æ³›å‹ã€‚</p>
<p>è®©æˆ‘ä»¬ç»§ç»­è®¨è®º<strong>logging</strong>çš„é«˜é˜¶<strong>reducer</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªä»¥å•ä¸ª<strong>reducer</strong>ä¸ºè¾“å…¥çš„å‡½æ•°ã€‚å› æ­¤ï¼Œå°±åƒ<strong>pullback</strong>ä¸€æ ·ï¼Œå®ƒåº”è¯¥æ˜¯å¦ä¸€ä¸ªè¢«å®šä¹‰ä¸ºæ“ä½œselfçš„æ–¹æ³•çš„å€™é€‰:</p>
<pre><code class="language-swift">extension Reducer {
  â€¦
  public func logging() -&gt; Reducer {
    return .init { value, action, environment in
      let effects = self.reduce(into: &amp;value, action: action, environment: environment)
</code></pre>
<p>å¥½å§! ä¸€åˆ‡éƒ½æ˜¯å»ºç«‹ï¼Œæˆ‘ä»¬å·²ç»ç§»åŠ¨äº†æ‰€æœ‰çš„æ“ä½œç»„åˆå’Œè½¬åŒ–<strong>reducer</strong>åˆ°æ–°çš„<strong>reducer</strong>ç±»å‹ã€‚</p>
<p>ä½†æ˜¯åœ¨ç»§ç»­ä¹‹å‰ï¼Œå½“æˆ‘ä»¬åœ¨è¿™é‡Œå¯¹æ¶æ„çš„å·¥æ•ˆå­¦è¿›è¡Œæ”¹è¿›æ—¶ï¼Œè®©æˆ‘ä»¬å…ˆæ¦‚æ‹¬ä¸€ä¸‹æ—¥å¿—åŠŸèƒ½ï¼Œå› ä¸ºå®ƒå¯ä»¥è®¿é—®ç¯å¢ƒã€‚æˆ‘ä»¬ç›®å‰ä½¿ç”¨Swiftæ ‡å‡†åº“çš„æ‰“å°å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯èƒ½æƒ³è°ƒç”¨å…¶ä»–çš„æ—¥å¿—è®°å½•æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡æè¿°å¦‚ä½•ä»ä¸€ä¸ªç¯å¢ƒä¸­å–å‡ºä¸€å°æ‰“å°æœºæ¥å®šåˆ¶åœ¨å¼•çº¿ç½©ä¸‹ä½¿ç”¨çš„æ‰“å°æœºç±»å‹ï¼Œä¼šæ€ä¹ˆæ ·å‘¢?</p>
<pre><code class="language-swift">public func logging(
  printer: (Environment) -&gt; (String) -&gt; Void,
) -&gt; Reducer {
  return .init { value, action, environment in
    let effects = self.reduce(into: &amp;value, action: action, environment: environment)
    let newValue = value
    let print = printer(environment)
    return [.fireAndForget {
      print(&quot;Action: \(action)&quot;)
      print(&quot;Value:&quot;)
      var dumpedNewValue = &quot;&quot;
      dump(newValue, to: &amp;dumpedNewValue)
      print(dumpedNewValue)
      print(&quot;---&quot;)
      }] + effects
</code></pre>
<p>ç°åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ‰€æœ‰çš„æ‰“å°éƒ½è¦é€šè¿‡æˆ‘ä»¬ä»ç¯å¢ƒä¸­æå–çš„æ‰“å°æœºå®Œæˆã€‚</p>
<p>å¦‚æœåœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­ï¼Œå½“Swiftæ ‡å‡†åº“çš„æ‰“å°åŠŸèƒ½åœ¨æ‰‹è¾¹æ—¶ï¼Œè¦æ±‚æˆ‘ä»¬æ€»æ˜¯æŒæœ‰ä¸€å°æ‰“å°æœºï¼Œè¿™ä¼¼ä¹æœ‰ç‚¹ç¬¨æ‹™ï¼Œæˆ‘ä»¬å¯ä»¥é»˜è®¤è¿™ä¸ªå‚æ•°å¿½ç•¥ç¯å¢ƒï¼Œç›´æ¥è®¿é—®è¯¥åŠŸèƒ½ã€‚</p>
<pre><code class="language-swift">public func logging(
  printer: (Environment) -&gt; (String) -&gt; Void = { _ in { print($0) } }
) -&gt; Reducer {
</code></pre>
<p>è¿™è¡¨æ˜ï¼Œé€šè¿‡å…è®¸æˆ‘ä»¬æè¿°æˆ‘ä»¬å¯¹ç¯å¢ƒçš„éœ€æ±‚ï¼Œæé«˜å…·æœ‰æ›´å¼ºèƒ½åŠ›çš„é«˜é˜¶<strong>reducer</strong>æ˜¯å¤šä¹ˆå®¹æ˜“ã€‚</p>
<hr>
<h2 id="6-a-nameupdatingtheappsmodulesaupdating-the-apps-modules">6. <a name='Updatingtheappsmodules'></a>Updating the app's modules</h2>
<p>ä¸€åˆ‡éƒ½æ˜¯åœ¨å¯ç»„åˆæ¶æ„ä¸­æ„å»ºçš„ã€‚å½“ç„¶ï¼Œæ¯å½“æˆ‘ä»¬å¯¹æ¶æ„è¿›è¡Œæ›´æ”¹æ—¶ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨åº”ç”¨çš„æ¨¡å—ä¸­åšå¤§é‡å·¥ä½œæ¥é‡æ–°æ„å»ºæ‰€æœ‰å†…å®¹ã€‚æ‰€ä»¥è®©æˆ‘ä»¬ä¸€æ¬¡æ›´æ–°æ¯ä¸ªæ¨¡å—ï¼Œçœ‹çœ‹äººä½“å·¥ç¨‹å­¦æœ‰ä»€ä¹ˆå˜åŒ–ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åˆ‡æ¢åˆ°æœ€å–œæ¬¢çš„è´¨æ•°æ¨¡å—ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰è¶£çš„æ˜¯ï¼Œæ‰€æœ‰çš„ä¸œè¥¿ä»ç„¶å¯ä»¥æ„å»º! è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ²¡æœ‰ä¸€ä¸ªå¯¹<strong>Reducer</strong>çš„å¼•ç”¨ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å°†<strong>favoritePrimesReducer</strong>ç›´æ¥å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°:</p>
<pre><code class="language-swift">public func favoritePrimesReducer(
  state: inout FavoritePrimesState,
  action: FavoritePrimesAction,
  environment: FavoritePrimesEnvironment
) -&gt; [Effect&lt;FavoritePrimesAction&gt;] {
</code></pre>
<p>ç›¸åï¼Œè®©æˆ‘ä»¬å°†å…¶å®šä¹‰ä¸ºä¸€ä¸ª<strong>Reducer</strong>å€¼ã€‚è¿™åªæ˜¯è°ƒç”¨ä¸€ä¸ªå¸¦å°¾é—­åŒ…çš„åˆå§‹åŒ–å™¨çš„é—®é¢˜:</p>
<pre><code class="language-swift">public let favoritePrimesReducer
  = Reducer&lt;FavoritePrimesState, FavoritePrimesAction, FavoritePrimesEnvironment&gt; { state, action, environment in
</code></pre>
<p>è¿™ä¼¼ä¹æ˜¯æœ¬æ¨¡å—ä¸­éœ€è¦æ›´æ”¹çš„æ‰€æœ‰å†…å®¹ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥è·³è½¬åˆ°è¿™ä¸ªæ¨¡å—çš„<strong>playground</strong>ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡ä»åœ¨å·¥ä½œã€‚</p>
<p>è®©æˆ‘ä»¬è¿›å…¥ä¸»æ¨¡æ€ã€‚</p>
<p>å®ƒä¹Ÿä»ç„¶æ„å»ºï¼Œä½†ä¹Ÿéœ€è¦å®ä¾‹åŒ–å®ƒçš„<strong>reducer</strong>ä½œä¸ºä¸€ä¸ªå€¼:</p>
<pre><code class="language-swift">public let primeModalReducer
  = Reducer&lt;PrimeModalState, PrimeModalAction, Void&gt; { state, action, _ in
</code></pre>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>prime modal reducer</strong>æ²¡æœ‰æ‰§è¡Œä»»ä½•å‰¯ä½œç”¨ï¼Œå› æ­¤æˆ‘ä»¬ç»™å®ƒä¸€ä¸ªVoidç¯å¢ƒï¼Œè¿™è¡¨ç¤ºè¿™ä¸ªç¯å¢ƒä¸ä¿å­˜ä»»ä½•æœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼Œå› æ­¤ä¸éœ€è¦ä»»ä½•ä¾èµ–é¡¹æ¥å®Œæˆå®ƒçš„å·¥ä½œ</p>
<p>è®¡æ•°å™¨æ¨¡å—æœ‰ç‚¹å¤æ‚ï¼Œå¹¶ä¸”ä¸å†åœ¨å»ºé€ ç§©åºä¸­ã€‚ä½†æ˜¯åœ¨æˆ‘ä»¬å¤„ç†è¿™äº›é”™è¯¯ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ›´æ–°<strong>counter reducer</strong>ä¸ºä¸€ä¸ª<strong>reducer</strong>å€¼:</p>
<pre><code class="language-swift">public let counterReducer
  = Reducer&lt;CounterState, CounterAction, CounterEnvironment&gt; { state, action, environment in
</code></pre>
<p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæ¨¡å—æ„å»ºä¸æˆåŠŸå‘¢? å®ƒè´Ÿè´£ä½¿ç”¨å›è°ƒå’Œç»„åˆå°†ä¸€å¯¹reduceç»„åˆåœ¨ä¸€èµ·ï¼Œå®ƒä»ç„¶ä½¿ç”¨æ—§çš„ã€è‡ªç”±çš„å‡½æ•°æ¥å£ï¼Œå®ƒä¸å†å­˜åœ¨:</p>
<pre><code class="language-swift">public let counterViewReducer = combine(
  pullback(
    counterReducer,
    value: \CounterViewState.counter,
    action: /CounterViewAction.counter,
    environment: { $0 }
  ),
  pullback(
    primeModalReducer,
    value: \.primeModal,
    action: /CounterViewAction.primeModal,
    environment: { _ in () }
  )
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Use of unresolved identifier â€˜combineâ€™ ğŸ›‘ Use of unresolved identifier â€˜pullbackâ€™</p>
</blockquote>
<p><strong>combine</strong>å‡½æ•°ç°åœ¨é™æ€åœ°å­˜åœ¨äº<strong>Reducer</strong>ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨å®ƒã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ª<strong>Reducer</strong>çš„å€¼ä¸Šç›´æ¥è°ƒç”¨<strong>callback</strong>ä½œä¸ºæ–¹æ³•ã€‚</p>
<pre><code class="language-swift">public let counterViewReducer = Reducer.combine(
  counterReducer.pullback(
    value: \CounterViewState.counter,
    action: /CounterViewAction.counter
    environment: { $0 }
  ),
  primeModalReducer.pullback(
    value: \.primeModal,
    action: /CounterViewAction.primeModal,
    environment: { _ in () }
  )
)
</code></pre>
<p>è¿™å°±æ˜¯åœ¨è®¡æ•°å™¨æ¨¡å—ä¸­éœ€è¦æ”¹å˜çš„ä¸€åˆ‡!</p>
<p>ä¸»åº”ç”¨ç›®æ ‡ä¹Ÿè¿˜æ²¡æœ‰å®Œå…¨æ„å»ºï¼Œè¿™æ˜¯å› ä¸ºï¼Œåƒ<strong>counter</strong>æ¨¡å—ä¸€æ ·ï¼Œå®ƒè´Ÿè´£å›è°ƒå’Œåˆå¹¶ä¸€äº›<strong>reducers</strong>ï¼Œè€Œè¿™äº›è°ƒç”¨éœ€è¦æ›´æ–°åˆ°æ–°çš„æ¥å£:</p>
<pre><code class="language-swift">let appReducer Reducer&lt;AppState, AppAction, AppEnvironment&gt; = .combine(
  counterViewReducer.pullback(
    value: \AppState.counterView,
    action: /AppAction.counterView
    environment: { $0.counter }
  ),
  counterViewReducer.pullback(
    value: \AppState.counterView,
    action: /AppAction.offlineCounterView,
    environment: { $0.offlineNthPrime }
  ),
  favoritePrimesReducer.pullback(
    value: \.favoritePrimes,
    action: /AppAction.favoritePrimes
    environment: { $0.favoritePrimes }
  )
)
</code></pre>
<p><strong>activityFeed</strong>é«˜é˜¶<strong>reducers</strong>ä¹Ÿæœ‰ä¸€äº›é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥åˆ é™¤@<strong>escaping</strong>å¹¶ä½¿ç”¨<strong>reducer</strong>åˆå§‹åŒ–å™¨åŒ…è£…å®ƒè¿”å›çš„<strong>reducer</strong>ã€‚</p>
<pre><code class="language-swift">func activityFeed(
  _ reducer: Reducer&lt;AppState, AppAction, AppEnvironment&gt;
) -&gt; Reducer&lt;AppState, AppAction, AppEnvironment&gt; {

  return .init { state, action, environment in
</code></pre>
<p>ä½†æ›´å¥½çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªé€»è¾‘ç§»åŠ¨åˆ°<strong>Reducer</strong>ç±»å‹ä¸­ï¼Œå°±åƒæˆ‘ä»¬å¯¹é«˜é˜¶æ—¥å¿—è®°å½•å‡½æ•°æ‰€åšçš„é‚£æ ·ã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦æœ‰æ¡ä»¶åœ°æ‰©å±•<strong>Reducer</strong>ï¼Œå…¶ä¸­å€¼ã€åŠ¨ä½œå’Œç¯å¢ƒéƒ½åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåŸŸä¸­ï¼Œç„¶åå®šä¹‰<strong>activityFeed</strong>ä½œä¸ºä¸€ä¸ªè®¡ç®—å±æ€§æ¥å¢å¼º<strong>self</strong>ã€‚</p>
<pre><code class="language-swift">extension Reducer where Value == AppState, Action == AppAction, Environment == AppEnvironment {
  func activityFeed() -&gt; Reducer {
    .init { state, action, environment in
      â€¦
      return self(&amp;state, action, environment)
    }
  }
}
</code></pre>
<p>åœ¨åˆ›å»ºæ ¹è§†å›¾å¹¶å°†å…¶ä¼ é€’ç»™<strong>store</strong>æ—¶ï¼Œæˆ‘ä»¬åªå‡ºç°äº†å‡ ä¸ªæ„å»ºé”™è¯¯:</p>
<pre><code class="language-swift">window.rootViewController = UIHostingController(
  rootView: ContentView(
    store: Store(
      initialValue: AppState(),
      reducer: with(
        appReducer,
        compose(
          logging,
          activityFeed
        )
      ),
      â€¦
    )
  )
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Use of unresolved identifier â€˜loggingâ€™ ğŸ›‘ Use of unresolved identifier â€˜activityFeedâ€™</p>
</blockquote>
<p><strong>loggingå’ŒactivityFeed</strong>éƒ½è½¬ç§»åˆ°äº†<strong>reducer</strong>ç±»å‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸å†éœ€è¦ä¾èµ–<strong>Overtureçš„withå’Œcompose</strong>å‡½æ•°ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›å±æ€§ç›´æ¥é“¾åœ¨<strong>appReducer</strong>ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦ç¡®ä¿æˆ‘ä»¬è·å¾—äº†æ­£ç¡®çš„é¡ºåºï¼Œä»¥ç¡®ä¿æ´»åŠ¨æè¦è¢«è®°å½•:</p>
<pre><code class="language-swift">window.rootViewController = UIHostingController(
  rootView: ContentView(
    store: Store(
      initialValue: AppState(),
      reducer: appReducer
        .activityFeed()
        .logging(),
      â€¦
    )
  )
)
</code></pre>
<p>è¿™è¯»èµ·æ¥çœŸçš„å¾ˆå¥½!æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹åˆ°ï¼Œæˆ‘ä»¬æ­£åœ¨é€šè¿‡ä¸€ä¸ªæ´»åŠ¨feedå’Œæ—¥å¿—è®°å½•æ¥å¢å¼ºæˆ‘ä»¬çš„<strong>app reducer</strong>ã€‚</p>
<p>æ›´å¥½çš„æ˜¯ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥æ›´å®¹æ˜“åœ°å°†è¿™äº›æ›´æ”¹æœ¬åœ°åŒ–åˆ°æˆ‘ä»¬æ‰€å…³å¿ƒçš„<strong>reducer</strong>ã€‚å‡è®¾æˆ‘ä»¬ä¸æƒ³è®°å½•æ•´ä¸ªåº”ç”¨ä¸­çš„æ¯ä¸€ä¸ªåŠ¨ä½œï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨åªå…³å¿ƒ<strong>counter reducer</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œç§»é™¤.<strong>logger</strong>ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°<strong>counter reducer</strong>çš„æœ«ç«¯:</p>
<pre><code class="language-swift">public let counterReducer = Reducer&lt;CounterState, CounterAction, CounterEnvironment&gt; { state, action, environment in
  ...
}
.logging()
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å°†åªè®°å½•é€šè¿‡<strong>counter reducer</strong>çš„æ“ä½œã€‚è¿™å¯¹äºå°†åŠŸèƒ½æœ¬åœ°åŒ–åˆ°ç‰¹å®šçš„<strong>reducer</strong>æ¥è¯´æ˜¯éå¸¸å¼ºå¤§çš„ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-97adaptive-state-management-the-point/">
                  <h3 class="post-title">
                    PointFree Episode 97:Adaptive State Management: The Point
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
