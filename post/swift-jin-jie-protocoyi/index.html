<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Swift è¿›é˜¶: Protocol åˆæ¢ | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1647167519050">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Swift: Protocol


1.1. PAT: Protocol with Associated Type
1.2. Existential &amp; Witness

1.2.1. ä»€ä¹ˆæ˜¯ Protocol Witnes..." />
    <meta name="keywords" content="advanced,pwt,pat,protocols" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1647167519050" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Swift è¿›é˜¶: Protocol åˆæ¢</h2>
            <div class="post-date">2021-05-23</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Swift:Protocol">Swift: Protocol</a></li>
</ol>
<ul>
<li>1.1. <a href="#PAT:ProtocolwithAssociatedType">PAT: Protocol with Associated Type</a></li>
<li>1.2. <a href="#ExistentialWitness">Existential &amp; Witness</a>
<ul>
<li>1.2.1. <a href="#ProtocolWitnessTable">ä»€ä¹ˆæ˜¯ Protocol Witness Table</a></li>
</ul>
</li>
<li>1.3. <a href="#ProtocolWitnessTable-1">è‡ªå·±å®ç° Protocol Witness Table</a></li>
</ul>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<h2 id="1-a-nameswiftprotocolaswift-protocol">1. <a name='Swift:Protocol'></a>Swift: Protocol</h2>
<h3 id="11-a-namepatprotocolwithassociatedtypeapat-protocol-with-associated-type">1.1. <a name='PAT:ProtocolwithAssociatedType'></a>PAT: Protocol with Associated Type</h3>
<p>PAT å°±æ˜¯ä¸€ä¸ªæœ‰æ³›å‹èƒ½åŠ›çš„ Protocolï¼Œè®©ä½ çš„ Protocol æ›´èƒ½è¢«å¹¿æ³›è¿ç”¨ï¼Œæ›´å¼ºå¤§ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ Sequence ï¼Œæˆ‘ä»¬å¯ä»¥ä» source code æ‰¾åˆ°å®ƒå®šä¹‰å¦‚ä¸‹ï¼ˆç®€åŒ–è¿‡ï¼‰</p>
<pre><code class="language-swift">protocol Sequence {
    associatedtype Element
    associatedtype Iterator : IteratorProtocol where Iterator.Element == Element

    func makeIterator() -&gt; Iterator
}
</code></pre>
<p>å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšå‡ºä¸€ç¾¤çš†åå‡º Int çš„å„ç§ Iterator ï¼Œæˆ–è€…æ˜¯ Stringï¼Œå¯ä»¥å¤§å¤§åœ°ææ˜‡ç¨‹å¼ç çš„å…±ç”¨åº¦ï¼Œå¯æƒœçš„æ˜¯ PAT ç›®å‰æœ‰äº›ä½¿ç”¨ä¸Šçš„å›°å¢ƒï¼Œåœ¨äº†è§£è¿™ä¸ªå›°å¢ƒå‰æˆ‘ä»¬å¿…é¡»å…ˆè®²ä¸€ä¸‹ä»€éº½æ˜¯ Existential Container å’Œ Witness Tableã€‚</p>
<h3 id="12-a-nameexistentialwitnessaexistential-witness">1.2. <a name='ExistentialWitness'></a>Existential &amp; Witness</h3>
<p>åœ¨ç¨‹å¼ç ä¸­æ‰“å‡º Protocol åç§°æ—¶æœ‰å‡ ç§æƒ…å¢ƒï¼Œæœ‰æ—¶æˆ‘ä»¬ç”¨å®ƒæ¥åšä¸ºä¸€äº›çº¦æŸæ¡ä»¶ï¼Œæˆ–è€…æˆ‘ä»¬ç›´æ¥æŠŠå®ƒåšä¸ºä¸€ç§ã€Œå‹åˆ«ã€ã€‚ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œ<em>Protocol æœ¬èº«å…¶å®ä¸å…·å¤‡å®ä½œçš„å®ä½“ï¼Œä½†ä¸ºä»€éº½å¯ä»¥å½“åšä¸€ç§å‹åˆ«æ¥ä½¿ç”¨å‘¢</em>ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸º Swift Compiler ä½¿ç”¨äº† <em>Existential Container</em> ï¼Œä¸‹ä¾‹ä¸­ä¸¤ä¸ªçœ‹ä¼¼ç›¸åŒçš„ instance å…¶å®å´æœ‰å®Œå…¨ä¸åŒçš„ memory layout</p>
<pre><code class="language-swift">protocol MyProcotol {}

struct MyStruct {
  let x = 1
  let y = 2
}
// What's the difference of following two?
let existentialContainer: MyProtocol = MyStruct()
let structInstance = MyStruct()

print(MemoryLayout.size(ofValue: existentialContainer)) // 40
print(MemoryLayout.size(ofValue: structInstance)) // 16
</code></pre>
<p>åŸå› æ­£æ˜¯å› ä¸ºå½“ä½ å°†ä¸€ä¸ªå‹åˆ«æ˜ç¡®åœ° (Explicitly) æŒ‡ä¸ºä¸€ä¸ª Protocol æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„å®ä½“ï¼ˆå‹åˆ«ï¼‰ï¼Œè€Œæ˜¯å®ä½œäº†è¯¥ Protocol è§„èŒƒçš„ã€Œæ‰€æœ‰å¯èƒ½ã€å‹åˆ«éƒ½èƒ½å¥—ç”¨äºæ­¤ï¼Œå¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ª runtime æ‰èƒ½å†³å®šçš„äº‹æƒ…ï¼Œcompiler å¯èƒ½æ— æ³•åœ¨ compile time çŸ¥é“ä½ é€è°è¿›æ¥ï¼Œäºæ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸‡ç”¨çš„ä¸­é—´å±‚ï¼ˆæ²¡æœ‰ä¸­é—´å±‚è§£å†³ä¸äº†çš„äº‹å•Šï¼‰ï¼Œæ‰€ä»¥å…¶å®ä½ æŒ‡å®šçš„å¹¶ä¸æ˜¯ Protocol è¿™ä¸ªå‹åˆ«ï¼Œè€Œæ˜¯è¯¥ Protocol çš„ Existential Container ã€‚</p>
<p>ä¸€ä¸ª Existential Container ç»“æ„å¦‚ä¸‹å›¾ï¼Œé•¿åº¦æ˜¯ 5 ä¸ª machine word ï¼Œå¯ä»å‰ä¾‹çš„ memory layout size å¾—çŸ¥</p>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gqri5hetk3j30ew0hi74i.jpg" alt="avatar" loading="lazy"></figure>
<p>å…¶ä¸­ value buffer è®°å½•äº†å®é™…å‹åˆ«çš„ properties ï¼Œçœ‹åˆ°è¿™ä½ ä¸€å®šé©¬ä¸Šæƒ³ï¼Œ3 ä¸ª word å“ªå¤Ÿå•Šï¼Ÿï¼Ÿï¼Ÿ äº‹å®ä¸Šæ˜¯ï¼Œè‹¥è¶…è¿‡ 3 ä¸ª word æ¥å­˜æ”¾çš„ value type ï¼Œä¼šå†å¦å¤–è¦ä¸€å—ç©ºé—´ï¼Œvalue buffer è£¡å°±åªä¼šæ”¾ä¸€ä¸ª pointer æŒ‡å‘è¿™ä¸ªç©ºé—´ï¼›åä¹‹åˆ™ä¾åºå­˜æ”¾ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„èŒƒä¾‹ä¸­æ¢ç´¢ä¸€ä¸‹å®é™…çš„æƒ…å†µ</p>
<pre><code class="language-swift">struct ExistentialContainer {
    var valueBuffer: (Int, Int, Int)
    var vwt: UnsafePointer&lt;ValueWitness&gt;
    var pwt: UnsafePointer&lt;ProtocolWitness&gt;
}

protocol Fooable {
    func foo()
}

struct Concrete: Fooable {
    let x = 99
    let y = 2
    func foo() {
        print(&quot;foo in concrete&quot;)
    }
}

// In main.swift
var concrete: Fooable = Concrete()
withUnsafePointer(to: &amp;concrete) { pointer in
    pointer.withMemoryRebound(to: ExistentialContainer.self, capacity: 1) { wpointer in
        print(wpointer.pointee.valueBuffer.0) // 99
        print(wpointer.pointee.valueBuffer.1) // 2
    }
}
</code></pre>
<p>ä¸Šä¾‹ä¸­çš„ ExistentialContainer struct å’Œå®é™…ä¸Šçš„ memory layout æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚è€Œ vwt åŒºå—åˆ™ å­˜æ”¾ä¸€ä¸ªæŒ‡å‘ Value Witness Table çš„ pointerï¼Œvalue witness table è®°è½½äº† value çš„ allocate, copy, destruct å’Œ deallocateï¼› è‡³äº pwt åˆ™æ˜¯æŒ‡å‘ Protocol Witness Table çš„ pointerï¼Œè¿™è£¡å¯ä»¥æ‰¾åˆ°æ‰€æœ‰å®ä½œäº† protocol è£¡ method çš„å®ä½“ä½ç½®ï¼ˆæ¬²çŸ¥æ›´å¤šç»†èŠ‚ï¼Œæ¨èæ”¶çœ‹ WWDC 2016 çš„ Understanding Swift Performanceï¼‰</p>
<h4 id="121-a-nameprotocolwitnesstableaä»€ä¹ˆæ˜¯-protocol-witness-table">1.2.1. <a name='ProtocolWitnessTable'></a>ä»€ä¹ˆæ˜¯ Protocol Witness Table</h4>
<p><a href="https://github.com/bestswifter/blog/blob/master/articles/swift-assembly-1-pwt.md">è¿™ç¯‡post</a>æœ‰ä¸€äº›æ¢ç´¢</p>
<p>æˆ‘ä»¬çŸ¥é“ C å‡½æ•°è°ƒç”¨æ˜¯é™æ€æ´¾å‘ï¼Œç®€å•æ¥è¯´å¯ä»¥ç†è§£ä¸ºæ˜¯ç”¨æ±‡ç¼–å‘½ä»¤ call $address æ¥å®ç°ã€‚è¿™ç§æ–¹å¼æ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯çµæ´»æ€§ä¸å¤Ÿã€‚</p>
<p>OC çš„æ–¹æ³•è°ƒç”¨å®Œå…¨æ˜¯åŸºäºåŠ¨æ€æ´¾å‘ï¼Œæ€»æ˜¯è°ƒç”¨ objc_msgSend å®ç°ã€‚è¿™ç§æ–¹å¼éå¸¸çµæ´»ï¼Œå…è®¸å„ç§ Hook é»‘ç§‘æŠ€ï¼Œä½†æ˜¯æµç¨‹æœ€é•¿ï¼Œæ•ˆç‡æœ€ä½ã€‚</p>
<p>åœ¨ Swift ä¸­ï¼Œåè®®æ–¹æ³•çš„è°ƒç”¨ï¼Œä½¿ç”¨åè®®æ–¹æ³•è¡¨çš„æ–¹å¼å®Œæˆï¼Œä¹Ÿå°±æ˜¯ <strong>Protocol Witness Table</strong>ï¼Œä¸‹æ–‡ç®€ç§° <strong>PWT</strong>ã€‚å‚è€ƒä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<pre><code class="language-swift">protocol Drawable {
    func draw() -&gt; Int
}

struct Point: Drawable {
    var x, y: Int
    func draw() -&gt; Int {
        return x + y
    }
}

struct Line: Drawable {
    var length: Int
    func draw() -&gt; Int {
        return length
    }
}

func foo() -&gt; Int {
    let p: Drawable = xxx
    return p.draw()
}
</code></pre>
<blockquote>
<p>åœ¨ foo å‡½æ•°ä¸­ï¼Œå˜é‡ p å¹¶æ²¡æœ‰æ˜ç¡®çš„ç±»å‹ï¼ŒåªçŸ¥é“å®ƒéµå®ˆ Drawable åè®®ï¼Œå®ç°äº† draw æ–¹æ³•ã€‚ä½†æ˜¯ç¼–è¯‘æ—¶å¹¶ä¸èƒ½çŸ¥é“ï¼Œè°ƒç”¨çš„æ˜¯ç»“æ„ä½“ Line è¿˜æ˜¯ Point çš„ draw æ–¹æ³•ã€‚<br>
å› æ­¤ï¼ŒPWT çš„å®ç°æ–¹å¼æ˜¯ï¼šæ¯ä¸ªç±»éƒ½ä¼šæœ‰ä¸€ä¸ªæ–¹æ³•è¡¨ï¼ˆé€šè¿‡æ•°ç»„æ¥å®ç°ï¼‰ï¼Œé‡Œé¢ä¿å­˜äº†å®ƒç”¨äºå®ç°åè®®çš„å‡½æ•°çš„åœ°å€ã€‚åªè¦çŸ¥é“ä¸€ä¸ªç±»çš„ä¿¡æ¯å’Œå‡½æ•°ä¿¡æ¯ï¼Œå°±å¯ä»¥å®ç°å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•è¡¨ï¼Œå°±æ˜¯ PWTã€‚</p>
</blockquote>
<ul>
<li>PWT æ˜¯ä¸ºäº†è§£å†³åè®®æ–¹æ³•è°ƒç”¨åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šåœ°å€ï¼Œè€Œå¼•å…¥çš„ä¸­é—´å±‚</li>
<li>æ¯ä¸ªéµå®ˆäº†åè®®çš„ç±»ï¼Œéƒ½ä¼šæœ‰è‡ªå·±çš„ PWTã€‚éµå®ˆçš„åè®®ä¸­å‡½æ•°è¶Šå¤šï¼ŒPWT ä¸­å­˜å‚¨çš„å‡½æ•°åœ°å€å°±è¶Šå¤šã€‚</li>
<li>å‡†ç¡®æ¥è¯´ï¼ŒPWT æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªæŒ‡é’ˆå¹¶ä¸æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œè€Œæ˜¯ protocol conformance descriptorï¼Œä»ç¬¬äºŒä¸ªå¼€å§‹æ‰æ˜¯å‡½æ•°æŒ‡é’ˆã€‚å¦‚æœæœ‰è¯»è€…çŸ¥é“è¿™ä¸ª conformance descriptor ä¸­å­˜å‚¨ä¿¡æ¯çš„å«ä¹‰ï¼Œæ¬¢è¿æŒ‡æ•™</li>
<li>å¯¹åè®®æ–¹æ³•çš„è°ƒç”¨ï¼Œé¦–å…ˆä¼šè°ƒç”¨ä¸€ä¸ª PWT address + offset è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¢«å«åš protocol witnessï¼Œå®ƒçš„å†…éƒ¨ä¼šåšä¸€äº›å‚æ•°å¤„ç†ï¼Œæœ€åå†è°ƒç”¨çœŸå®çš„å‡½æ•°</li>
<li>å¯¹äºå®é™…è¢«è°ƒç”¨çš„æ¥è¯´ï¼Œåªçœ‹å®ƒçš„å†…éƒ¨å®ç°ï¼Œæ— æ³•å’Œå…¶å®ƒå‡½æ•°åšå‡ºåŒºåˆ†ã€‚ä½†æ˜¯å¯ä»¥è§‚å¯Ÿå®ƒçš„ callerï¼Œå¦‚æœæ˜¯ä¸€ä¸ª protocol witness å°±å¯ä»¥è¯´æ˜ã€‚</li>
</ul>
<p>é‚£ï¼Œä¸ºä»€éº½è¦è®²è¿™ä¸ªğŸ¤”</p>
<p><strong>å› ä¸º compiler æ— æ³•ä¸º PAT ç”Ÿæˆ Existential Container å•¦ï¼ï¼ï¼</strong><br>
å…·ä½“åŸå› å°±æ˜¯ï¼šåœ¨ Swift 5 é‡Œï¼Œå­˜åœ¨ä½“åªé’ˆå¯¹é‚£äº›æ²¡æœ‰å…³è”ç±»å‹å’Œ Self çº¦æŸçš„åè®®ã€‚ç¼–è¯‘å™¨ç¦æ­¢ä¸ºåŒ…å«å…³è”ç±»å‹çº¦æŸçš„åè®® (æˆ–è€…ä½¿ç”¨äº† Self çš„åè®®ï¼Œæœ¬è´¨ä¸Šè¿™ä¹Ÿæ˜¯ä¸€ç§å…³è”ç±»å‹) ç”Ÿæˆå­˜åœ¨ä½“ï¼ˆExistential Containerï¼‰ã€‚</p>
<p>è‹¥ä½ ä¸€æ—¶æ— æ³•æ„ä¼šè¿™å¥è¯æ˜¯ä»€éº½æ„æ€ï¼Œè¯·è¯•è‘—å†™å‡ºè¿™æ ·çš„ code</p>
<pre><code class="language-swift">let sequences: [Sequence]
</code></pre>
<p>å†™å®Œåä½ å°±ä¼šå¾—åˆ°ä»¥ä¸‹è­¦æŠ¥</p>
<blockquote>
<p>Protocol â€˜Sequenceâ€™ can only be used as a generic constraint because it has Self or associated type requirements.(â€œSequenceâ€Sequenceåªèƒ½ä½œä¸ºé€šç”¨çº¦æŸä½¿ç”¨ï¼Œå› ä¸ºå®ƒæœ‰Selfæˆ–ç›¸å…³çš„ç±»å‹éœ€æ±‚ã€‚)</p>
</blockquote>
<p>å¦‚æœè¿™ä¸ªä¾‹å­ä½ æ— æ³•æ„ŸåŒèº«å—çš„è¯ï¼Œè¯·å®¹è®¸æˆ‘å±•ç¤ºå¦ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ç®€å•çš„ç½‘è·¯è¯·æ±‚æƒ…å¢ƒä¸‹æˆ‘å¸¸ç”¨è¿™ä¸ªä»å–µç¥é‚£å­¦æ¥çš„ protocol-oriented newtork request architecture ï¼ˆä»¥ RxSwift å‘ˆç°ï¼‰</p>
<pre><code class="language-swift">import Foundation
import RxSwift

// Requests 
enum HTTPMethod: String {
    case POST, GET
}

// Define what a request is
protocol Request {
    var path: String { get }
    var method: HTTPMethod { get }
    var param: [String: Any] { get }

    associatedtype ResponseObject: Decodable
}

// Define what shoud have to send a request
protocol RequestSender {
    var base: String { get }
    func send&lt;T: Request&gt;(_ r: T) -&gt; Observable&lt;T.ResponseObject?&gt;
}

// An object who can send out Request
struct URLSessionRequestSender: RequestSender {
    var base = &quot;http://www.dummy.api&quot;
    func send&lt;T: Request&gt;(_ r: T) -&gt; Observable&lt;T.ResponseObject?&gt; {
        let url = URL(string: base.appending(r.path))!
        var request = URLRequest(url: url)
        request.httpMethod = r.method.rawValue

        if let body = try? JSONSerialization.data(withJSONObject: r.param, options: .prettyPrinted) {
            request.httpBody = body
        }

        return Observable.create { subscriber in
            let task =  URLSession.shared.dataTask(with: request) { data, res, error in
                if let data = data, let object = try? JSONDecoder().decode(T.ResponseObject.self, from: data) {
                    subscriber.onNext(object)
                } else {
                    subscriber.onError(error!)
                }
            }
            task.resume()
            return Disposables.create()
        }
    }
}

// An object
struct User: Decodable {
    let id: String
    let name: String
    let gender: String
}

// A real request
struct GetUserRequest: Request {
    typealias ResponseObject = User
    let id: String
    var path: String {
        return &quot;/users/\(id)&quot;
    
    var param: [String : Any]
    let method: HTTPMethod = .GET

    init(id: String, param: [String: Any] = [:]) {
        self.id = id
        self.param = param
    }
}

// usage example
func example() {
    let request = GetUserRequest(id: &quot;a12345&quot;, param: [&quot;foo&quot;: &quot;bar&quot;])
    _ = URLSessionRequestSender().send(request)
        .subscribe(onNext: { user in
            if let user = user {
                print(&quot;user is : \(user.name)&quot;)
            } else {
                print(&quot;got nothing&quot;)
            }
        })
}
</code></pre>
<p>ä¸Šä¾‹ä¼˜é›…åœ°åˆ©ç”¨ associatedtype æ¥æŠŠ Request ç›¸å…³çš„å…ƒç´ éƒ½é›†ä¸­åœ¨ä¸€ä¸ªèµ„æ–™ç»“æ„è£¡ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª sender ï¼ˆä¹Ÿå¯ä»¥æ›¿æ¢æˆä¸åŒå®ä½œï¼‰æ¥é€å‡ºå„ç§ä¸åŒçš„ request è€Œä¸” return type éƒ½æ˜¯åœ¨ compile time å°±èƒ½å¤Ÿå¾—çŸ¥çš„ï¼Œthe power of generic and protocolï¼</p>
<p>ç„¶è€Œï¼Œå½“ä½ å¼€å§‹å¼€å¿ƒåœ°ç©ä¸‹å»ï¼Œå‘ç°ä½ æƒ³è¦å®ä½œä¸€ä¸ª queue å¯ä»¥è®©å¤šä¸ªä¸åŒçš„ request å¯ä»¥ä¾åºé€å‡ºï¼Œæˆ–è€…æœ‰ç›¸ä¾å…³ä¿‚ï¼Œå› æ­¤ä½ å†™å‡ºäº†è¿™æ ·çš„ code:</p>
<pre><code class="language-swift">var requestQueue: [Request]
</code></pre>
<blockquote>
<p>Protocol â€˜Requestâ€™ can only be used as a generic constraint because it has Self or associated type requirements.( â€œè¯·æ±‚â€åè®®åªèƒ½ä½œä¸ºé€šç”¨çº¦æŸä½¿ç”¨ï¼Œå› ä¸ºå®ƒæœ‰Selfæˆ–ç›¸å…³çš„ç±»å‹éœ€æ±‚ã€‚)</p>
</blockquote>
<p>å¥½å§ï¼Œæ”¶æ¨ç ´ç¢çš„å¿ƒï¼Œ code è¿˜æ˜¯è¦å†™å®Œä¸ç„¶ä¼šæ²¡å·¥ä½œï¼Œé‡åˆ°è¿™ä¸ªçŠ¶å†µè¯¥æ€éº½åŠå‘¢ï¼Ÿå…ˆè®²ç»ˆæç»“è®ºï¼Œè¿™ä¸ªé—®é¢˜åº”è¯¥å°±åœ¨ä¸ä¹…åçš„å°†æ¥å°±ä¼šè¢«è§£å†³ï¼ŒSwift æ€»æœ‰ä¸€å¤©ä¼šæ”¯æ´ let request: Request&lt;ResponseObject: User&gt; çš„å†™æ³•ï¼ˆæˆ–è€…å¯èƒ½æ˜¯ some Requestï¼Œå¯ä»¥å‚è€ƒSE-0244ï¼‰ã€‚ä½†åœ¨é‚£å¤©åˆ°æ¥å‰ï¼ŒSwift ç¤¾ç¾¤æœ‰å¾ˆå¤š workaround çš„è®¨è®ºä»¥ç»•å¼€è¿™ä¸ªé—®é¢˜ï¼Œtype erasure çš„æŠ€å·§å¦‚ AnyIteratorã€Any XXX ç­‰éƒ½å¯ä»¥ï¼Œä¸è¿‡éƒ½è¿˜å¾ˆéº»çƒ¦è€Œä¸”ä¸€å®šè¦å†å¼•å…¥å¦ä¸€ä¸ª containerã€‚ç›´åˆ°æœ€è¿‘æˆ‘çœ‹åˆ°ä¸€ä¸ªè®©æˆ‘ğŸ¤¯ğŸ¤¯ğŸ¤¯çš„å¤©æ‰æƒ³æ³•ï¼š</p>
<blockquote>
<p>Why donâ€™t you write Protocol Witness Table by yourselfï¼Ÿ( ä½ ä¸ºä»€ä¹ˆä¸è‡ªå·±å†™åè®®è§è¯è¡¨å‘¢?)</p>
</blockquote>
<p>ä¸€å£æ°”è§£å¼€äº† PAT çš„é—®é¢˜ï¼Œæ›´æ‰“å¼€äº†ä¸€ä¸ªå®ä½“åªèƒ½æœ‰ä¸€ç§ Protocol å®ä½œçš„é™åˆ¶ï¼Œæ ¹æœ¬ç¥ä¹‹æ€ç»´å•Šå•Šï¼ï¼ï¼</p>
<h3 id="13-a-nameprotocolwitnesstable-1aè‡ªå·±å®ç°-protocol-witness-table">1.3. <a name='ProtocolWitnessTable-1'></a>è‡ªå·±å®ç° Protocol Witness Table</h3>
<p>åˆšæ‰æåˆ°äº†ä¸€ä¸ªç ´å¤©è’çš„æƒ³æ³•ï¼Œè‡ªå·±å®åšä¸€ä¸ª Protocol Witness Tableï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥æ·±å…¥ç‚¹çœ‹çœ‹ Protocol Witness Tableï¼Œé¦–å…ˆæ˜¯ compiler åœ¨ SIL é˜¶æ®µåšäº†ä»€éº½äº‹ï¼ˆå®˜æ–¹æ–‡ä»¶ï¼‰ï¼Œé¦–å…ˆæ–‡ä»¶è£¡æåˆ°</p>
<blockquote>
<p>A witness table is emitted for every declared explicit conformance.</p>
</blockquote>
<p>æ‰€ä»¥æ¯å½“æˆ‘ä»¬å½“å£°æ˜ä¸€ä¸ªå‹åˆ«éµå®ˆ(confrom to)æŸä¸ª Protocol æ—¶å°±ä¼šç”Ÿæˆä¸€ä¸ª witness tableï¼Œè€Œè¿™ä¸ª witness table ä¼šç”¨ã€Œå‹åˆ«ï¼šProtocolã€è¿™ç»„åˆç”Ÿæˆä¸€ä¸ªç‹¬ç‰¹çš„ id æ¥å½“ key ä¿å­˜è‘—ï¼Œæ–‡ä»¶è£¡å…±å®šä¹‰äº”ç§éµå®ˆ protocol çš„å¯èƒ½æ€§ï¼Œæˆ‘ä»¬åªçœ‹æœ€ä¸€èˆ¬çš„ä¸€èˆ¬æ€§éµå®ˆ</p>
<pre><code class="language-swift">protocol-conformance ::= normal-protocol-conformance
</code></pre>
<p>å› ä¸ºæ¯ä¸ªå‹åˆ«åªèƒ½éµå®ˆä¸€ä¸ª protocol ä¸€æ¬¡ï¼ˆé‡ç‚¹é‡ç‚¹ï¼ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯è¿™æ ·çš„é…å¯¹æ˜¯ 1:1ï¼Œè€Œä¸”ä¹Ÿåªæœ‰è¿™ä¸ªä¸€èˆ¬çš„éµå®ˆæ–¹å¼ä¼šç›´æ¥ä¸ witness table å…³è”ï¼Œå…¶å®ƒæ¯”è¾ƒè¤‡æ‚çš„æƒ…å†µå¤šåŠæ˜¯é—´æ¥æˆ–å¤šä¸ª table ä¹‹é—´çš„å…³è”ã€‚è‡³äºä¸€ä¸ª witness table ä¼šç”± 4 ä¸ª entry ç»„æˆä»¥æè¿°æ‰€æœ‰ç›¸å…³èµ„è®¯ï¼Œæˆ‘ä»¬åªåœ¨æ„æœ€é‡è¦çš„ä¸€ä¸ª method entryï¼š</p>
<pre><code class="language-swift">sil-witness-entry ::= 'method' sil-decl-ref ':' sil-function-name
</code></pre>
<p>è¿™è£¡å¾ˆå•çº¯ï¼Œå‰è€…æ˜¯ protocol æ‰€å®šä¹‰çš„ä»‹é¢ï¼Œåè€…æ˜¯çœŸå®çš„ method å®ä½œï¼Œåªæ˜¯æŠŠå®ƒä»¬è¿ç»“èµ·æ¥è€Œå·²ï¼Œå¦‚è¿™è£¡å¤ªæŠ½è±¡æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å›¾å’Œç¨‹å¼ç ï¼Œå°±æ‹¿ WWDC 2016 Session 416 çš„èŒƒä¾‹æ¥è¯´ï¼š</p>
<pre><code class="language-swift">protocol Drawable {
    func draw()
}

struct Point: Drawable {
    var x: Int
    var y: Int
    
    func draw() {
        print(&quot;Draw a point at (\(x), \(y))&quot;)
    }
}

// Main
let point: Drawable = Point(x: 1, y: 1)
point.draw()
</code></pre>
<p>æˆ‘ä»¬è¿™è£¡çš„å˜æ•° point ä¼šæ˜¯ä¸ª Existential Containerï¼Œå› ä¸ºæˆ‘ä»¬å®£å‘Šå®ƒçš„å‹åˆ«æ˜¯ä¸ª protocolï¼Œç»“åˆå‰è¿°æ‰€è¯´ï¼Œcontainer å’Œ protocol witness table é•¿å¾—åƒè¿™æ ·ï¼ˆå¤§å®¶è¿˜è®°å¾—ç¬¬äºŒé›†è®²åˆ° container çš„æ¨¡æ ·å—ï¼Ÿï¼‰</p>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gqrjpggv7aj30m80bu0t3.jpg" alt="avatar" loading="lazy"></figure>
<p>å¦‚æœç”¨ç¨‹å¼ç è¡¨ç¤ºï¼Œè¿™ä¸ª point çš„ container ä¸ Point: Drawable çš„ witness table ä¼šåƒè¿™æ ·ï¼š</p>
<pre><code class="language-swift">struct ExistentialContainer {
    var valueBuffer: (Int, Int, Int)
    var vwt: UnsafePointer&lt;ValueWitness&gt;
    var pwt: UnsafePointer&lt;ProtocolWitness&gt;
}

struct ProtocolWitness {
    var descriptor: ProtocolConformanceDescriptor
    var draw: FunctionRef
}
</code></pre>
<p>æ€€ç–‘è®ºè€…è‡³æ­¤å¦‚æœè¿˜æœ‰æ€€ç–‘ï¼Œå¯ä»¥è¯•è‘—åœ¨å‰é¢çš„ point.draw() æ‰“ä¸ªä¸­æ–­ç‚¹ï¼Œæ‰§è¡Œç¨‹å¼å¹¶åœåœ¨è¯¥å¤„ï¼Œåœ¨ lldb è£¡è¯»ä¸€ä¸‹ register ï¼Œå¯ä»¥çœ‹åˆ°</p>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gqrjsjxc4vj31no0ic0wp.jpg" alt="avatar" loading="lazy"></figure>
<p>å…¶ä¸­ 0x000000010fb21978 æ˜¯ protocol witness tableï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è£¡é¢çš„å†…å®¹</p>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gqrjuuiz02j30vu03a3z0.jpg" alt="avatar" loading="lazy"></figure>
<p>ç¬¬ä¸€ä¸ªæ˜¯æŒ‡å‘ descriptor ï¼Œç¬¬äºŒä¸ªå°±æ˜¯æŒ‡å‘æˆ‘ä»¬ draw() åœ¨ point çš„å®ä½œï¼Œæˆ‘ä»¬å°†ç¬¬äºŒä¸ªçš„ä½å€åç»„è¯‘ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„ç¡®å°±æ˜¯ Point å¯¹ Drawable è£¡ draw() çš„å®ä½œï¼ˆåœ¨æˆ‘ç¨‹å¼è£¡æ˜¯ç¬¬ 19 è¡Œæ²¡é”™ï¼‰</p>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gqrju7zjaqj320a0dq0vk.jpg" alt="avatar" loading="lazy"></figure>
<p>æ¢ç©¶è‡³æ­¤ï¼Œæƒ³å¿…å¤§å®¶éƒ½å·²ç»æœ‰å¾ˆå…·ä½“çš„è®¤çŸ¥äº†ï¼Œé‚£æˆ‘ä»¬æƒ³æƒ³ï¼Œè¿™æ ·çš„è®¾è®¡å¯èƒ½ä¼šæœ‰ä»€éº½é—®é¢˜ï¼Ÿ</p>
<p>é™¤äº†å‰é›†æåˆ°çš„ PAT ä¸èƒ½ç”Ÿæˆ container å¤–ï¼Œæœ‰æ—¶è¿™ 1å¯¹1 çš„å…³ä¿‚ï¼ˆä¸€å‹åˆ«åªèƒ½éµå®ˆä¸€ä¸ª protocol ä¸€æ¬¡ï¼‰è®©æˆ‘ä»¬ä¸èƒ½ä»¥æœ€å¤§æ•ˆç›Šå…±ç”¨ç¨‹å¼ç ï¼Œæ¯”å¦‚å‰é¢æåˆ° Requestï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ç”Ÿæˆä¸åŒå›ä¼ å‹åˆ«çš„ Request ï¼Œå°±è¦å®£å‘Šä¸åŒçš„ concrete type ï¼Œæ¯”å¦‚ UserRequestï¼ŒListsRequestç­‰ï¼Œå…¶å®å¤§åŒå°å¼‚ï¼Œè¿™æ ·å°±è¦å®£å‘Šä¸€ä¸ªæ–°å‹åˆ«å¥½åƒæœ‰ç‚¹æµªè´¹ï¼Ÿ</p>
<p>ä»å‰é¢ Point å’Œ Drawable çš„ä¾‹å­æ¥çœ‹ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ› Point æœ‰ä¸åŒçš„ç”»æ³•å‘¢ï¼Ÿæ¯”å¦‚ç©ºå¿ƒç‚¹ã€å®å¿ƒç‚¹æˆ–è€…è™šçº¿ç‚¹ï¼Œè¿™æ ·åŠ¿å¿…è¦ä¸‰ç§å‹åˆ«æ‰èƒ½è¾¾æˆå•Šï¼Œä¸ç®¡æ˜¯çº¯éµå®ˆ protocol æˆ–è€…ä½¿ç”¨ç»§æ‰¿ ï¼ä¸è¿‡æ–¹æ‰æˆ‘ä»¬ä¹Ÿçœ‹åˆ° witness table åœ¨ SIL çš„ç»“æ„ï¼Œçœ‹èµ·æ¥ä¸éš¾æï¼Œå…¶å®å°±æ˜¯ draw è¦ä¿å­˜ä¸€ä¸ªå®ä½œçš„ä½å€å˜›ï¼åœ¨ Swift è£¡ function å¯æ˜¯ â€œfirst-class citizenâ€ï¼Œä¹Ÿå°±æ˜¯ function å¯ä»¥å½“ä½œå˜æ•°æ¥è¿ç”¨ï¼Œè¿™æä¾›äº†ä¸€ä¸ªå¤§å¥½çš„å¥‘æœºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Drawable witness table çš„ draw property æ”¹å†™ä¸€ä¸‹</p>
<pre><code class="language-swift">var draw: FunctionRef -&gt; var draw: (Shape) -&gt; ()
</code></pre>
<p>æ•´å€‹ä¾‹å­å°±å¯ä»¥æ”¹å¯«æˆ</p>
<pre><code class="language-swift">// From:
protocol Drawable {
    func draw()
}

// To:
struct Drawing&lt;Shape&gt; {
    var draw: (Shape) -&gt; ()
}

// ç”¨ä¾†ç•«å¯¦å¿ƒé»
let solidPointDrawer = Drawing&lt;CGPoint&gt; { point in
    print(&quot;draw solid point: (\(point.x), \(point.y))&quot;)
}

// ç”¨ä¾†ç•«ç©ºå¿ƒé»
let hollowPointDrawer = Drawing&lt;CGPoint&gt; { point in
    print(&quot;draw hollow point: (\(point.x), \(point.y))&quot;)
}                      

let point = CGPoint(x: 1, y: 1)

solidPointDrawer.draw(point) // ç•«å¯¦å¿ƒé»
hollowPointDrawer.draw(point) // ç•«ç©ºå¿ƒé»
</code></pre>
<p>æ˜¯ä¸æ˜¯çªç„¶å°±æœ‰èµ°å…¥æ–°ä¸–ç•Œçš„æ„Ÿè§‰äº†å‘¢ï¼Ÿæ‰“é“è¦è¶çƒ­ï¼Œæˆ‘ä»¬ç»§ç»­æŠŠä¸Šæ¬¡çš„ network rqeust èŒƒä¾‹ä¸€èµ·ç”¨è¿™ç§æ–¹å¼é‡æ–°æ”¹å†™ï¼ˆå› ä¸ºè¦ä¼ å…¥ handler ä¸”å®ƒæ˜¯ä¸ª closureï¼Œå¦‚æœè¦å†™å¾—ä¼˜é›…ç‚¹éœ€è¦ç”¨ curry çš„æ–¹å¼æ¶ˆå‚æ•°ï¼Œæ€•å¤±ç„¦å°±å…ˆå€Ÿç”¨ RxSwift è¯¥ç¨‹å¼ç ä¼˜é›…ç‚¹ï¼‰</p>
<pre><code class="language-swift">import Foundation
import RxSwift

// MARK: Model
struct User: Decodable {
    let id: Int
    let name: String
}

let usersDecode: (Data) -&gt; [User]? = { data in
    return try? JSONDecoder().decode([User].self, from: data)
}

// MARK: Request related
enum HTTPMethod: String {
    case GET
    case POST
}

struct Request&lt;Response: Decodable&gt; {
    var endpoint: String
    var method: HTTPMethod
    var param: [String: Any]?
    let decode: (Data) -&gt; Response?
}

struct RequestSender {
    let base = &quot;https://foo.bar&quot;
    private let sendingRequst: (URLRequest) -&gt; Observable&lt;Data&gt; // To abstract your network framework
    init(_ sendingRequst: @escaping(URLRequest) -&gt; Observable&lt;Data&gt;) {
        self.sendingRequst = sendingRequst
    }

    func send&lt;Response: Decodable&gt;(_ r: Request&lt;Response&gt;) -&gt; Observable&lt;Response?&gt; {
        let url = URL(string: base + r.endpoint)!
        var request = URLRequest(url: url)
        request.httpMethod = r.method.rawValue
        if let param = r.param, let body = try? JSONSerialization.data(withJSONObject: param, options: .prettyPrinted) {
            request.httpBody = body
        }

        return sendingRequst(request).map(r.decode)
    }
}

// MARK: Main
// Instance of requests and request sender
let getUsersRequest = Request(endpoint: &quot;/users&quot;, method: .GET, param: nil, decode: usersDecode)

// You can use any other network framework such as Alamofire
let urlSessionRequestSender = RequestSender { request in
    return Observable&lt;Data&gt;.create { subscriber in
        let task = URLSession.shared.dataTask(with: request) { data, res, error in
            if let data = data {
                subscriber.onNext(data)
            } else {
                subscriber.onError(error!)
            }
        }
        task.resume()
        return Disposables.create()
    }
}

// Actually do request (get users)
_ = urlSessionRequestSender.send(getUsersRequest).subscribe(onNext: { users in
    guard let users = users else {
        return
    }
    print(users)
})
</code></pre>
<p>RequestSender çš„éƒ¨åˆ†å°±å†™ä¸ªæ„æ€æ„æ€ï¼ˆä½†çœŸçš„ä¼šåŠ¨ï¼‰ï¼Œå¤§å®¶å¯ä»¥å†è‡ªå·±ä¼˜åŒ–ï¼Œä¸»è¦çš„é‡ç‚¹è¿˜æ˜¯åœ¨ Request è¿™ä¸ªæ³›å‹ struct è£¡ï¼Œåˆ©ç”¨å®ƒçš„æ³›å‹èµ„è®¯å†è®© RequestSender å¯ä»¥å¤„ç†å„ç§ return type çš„ requestã€‚</p>
<p><a href="https://www.fewbutripe.com/talks/#">ç›¸å…³talk</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/TDh4b4Zil/" class="tag">
                    advanced
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/EsLtslOpr/" class="tag">
                    pwt
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/Kvxtc31eQB/" class="tag">
                    pat
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/_qqECQ7kWd/" class="tag">
                    protocols
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/debugging-swift-code-with-lldb/">
                  <h3 class="post-title">
                    Debugging Swift code with LLDB
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
