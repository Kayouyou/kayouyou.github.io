<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 68:Composable State Management: Reducers | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico?v=1652020986569">
<link rel="stylesheet" href="http://localhost:4000/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Introduction




Recap: our app so far




A better way to model global state




Functional state management




Er..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="http://localhost:4000">
        <img src="http://localhost:4000/images/avatar.png?v=1652020986569" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="http://localhost:4000/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 68:Composable State Management: Reducers</h2>
            <div class="post-date">2021-11-20</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Introduction">Introduction</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Recap:ourappsofar">Recap: our app so far</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Abetterwaytomodelglobalstate">A better way to model global state</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Functionalstatemanagement">Functional state management</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Ergonomics:capturingreducerinstore">Ergonomics: capturing reducer in store</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Ergonomics:in-outreducers">Ergonomics: in-out reducers</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="#Movingmoremutationsintothestore">Moving more mutations into the store</a></li>
</ol>
</li>
<li>
<ol start="8">
<li><a href="#Tillnexttime">Till next time</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 68:Composable State Management: Reducers -->
<h2 id="1-a-nameintroductionaintroduction">1. <a name='Introduction'></a>Introduction</h2>
<p>åœ¨è¿‡å»çš„å‡ å‘¨é‡Œï¼Œæˆ‘ä»¬æ¢ç´¢äº†åº”ç”¨ç¨‹åºæ¶æ„çš„é—®é¢˜ç©ºé—´ï¼Œå¹¶è¯•å›¾æ­ç¤ºä½¿å…¶å¦‚æ­¤å¤æ‚çš„æ ¹æºã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆæ„å»ºäº†ä¸€ä¸ªä¸­ç­‰å¤æ‚çš„åº”ç”¨ç¨‹åºï¼Œå°½ç®¡å®ƒæœ‰ç‚¹åƒä¸€ä¸ªç©å…·æ ·ä¾‹ï¼Œä½†å®ƒå¼ºè°ƒäº†æˆ‘ä»¬åœ¨æ„å»ºåº”ç”¨ç¨‹åºæ—¶é‡åˆ°çš„æ‰€æœ‰ç—›ç‚¹ã€‚ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬çœ‹åˆ°:</p>
<ul>
<li>æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæœ‰å¤æ‚çš„åº”ç”¨çŠ¶æ€ï¼Œå¯ä»¥åœ¨å¤šä¸ªå±å¹•ä¸Šå…±äº«ï¼Œè¿™æ ·ï¼ŒæŸä¸ªçŠ¶æ€çš„å˜åŒ–å¯ä»¥ç«‹å³åæ˜ åˆ°å…¶ä»–å±å¹•ä¸Šã€‚</li>
<li>æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»¥ä¸€è‡´çš„æ–¹å¼æ”¹å˜çŠ¶æ€ï¼Œè¿™æ ·å¯¹äºä»£ç åº“çš„æ–°æ‰‹æ¥è¯´ï¼Œæ•°æ®æ˜¯å¦‚ä½•åœ¨åº”ç”¨ç¨‹åºä¸­æµåŠ¨çš„å°±å¾ˆæ˜æ˜¾äº†ã€‚</li>
<li>æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿç”¨ç®€å•ã€å¯ç»„åˆçš„å•å…ƒæ„å»ºå¤§å‹ã€å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®Œå…¨ç‹¬ç«‹åœ°æ„å»ºç»„ä»¶ï¼Œç”šè‡³å¯èƒ½åœ¨å…¶è‡ªå·±çš„æ¨¡å—ä¸­ï¼Œç„¶åå°†è¯¥ç»„ä»¶æ’å…¥åˆ°æ›´å¤§çš„åº”ç”¨ç¨‹åºä¸­ã€‚</li>
<li>æˆ‘ä»¬æƒ³è¦ä¸€ç§å®šä¹‰è‰¯å¥½çš„æœºåˆ¶æ¥æ‰§è¡Œå‰¯ä½œç”¨å¹¶å°†å…¶ç»“æœåé¦ˆç»™åº”ç”¨ç¨‹åºã€‚</li>
<li>æœ€åï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„æ¶æ„æ˜¯å¯æµ‹è¯•çš„ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿç”¨å¾ˆå°‘çš„è®¾ç½®æ¥ç¼–å†™æµ‹è¯•ï¼Œå…è®¸æˆ‘ä»¬æè¿°ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­æ‰€åšçš„ä¸€ç³»åˆ—æ“ä½œï¼Œç„¶ååœ¨è¿™äº›æ“ä½œæ‰§è¡Œåæ–­è¨€åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚</li>
</ul>
<p>è¿™äº›éƒ½æ˜¯éœ€è¦è§£å†³çš„é‡è¦é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æˆ‘ä»¬æ‰©å±•ä»£ç åº“ï¼Œä»¥å¤„ç†è®¸å¤šåŠŸèƒ½å’Œè®¸å¤šå¼€å‘äººå‘˜åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸Šå·¥ä½œã€‚ä¸å¹¸çš„æ˜¯ï¼ŒSwiftUIå¹¶æ²¡æœ‰å®Œå…¨è§£å†³è¿™äº›é—®é¢˜ã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº†è®¸å¤šè‡ªå·±è§£å†³å®ƒçš„å·¥å…·ï¼Œä½†å®ƒå–å†³äºæˆ‘ä»¬é‡‡å–é¢å¤–çš„åŠªåŠ›ã€‚</p>
<p>æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±å¼€å§‹è¿™æ ·åšã€‚æˆ‘ä»¬å°†ä»‹ç»è§£å†³è¿™äº›é—®é¢˜çš„åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ã€‚å®ƒçš„å›ºæ‰§å·±è§å’ŒSwiftUIå·®ä¸å¤šã€‚å®ƒå‡†ç¡®åœ°å‘Šè¯‰æˆ‘ä»¬åº”è¯¥å¦‚ä½•å¯¹åº”ç”¨ç¨‹åºçŠ¶æ€å»ºæ¨¡ï¼Œå‘Šè¯‰æˆ‘ä»¬å¦‚ä½•å°†çªå˜åº”ç”¨åˆ°è¯¥çŠ¶æ€ï¼Œå‘Šè¯‰æˆ‘ä»¬å¦‚ä½•æ‰§è¡Œå‰¯ä½œç”¨ç­‰ç­‰ã€‚å¦‚æœæˆ‘ä»¬éµå¾ªè¿™äº›å¤„æ–¹ï¼Œä¸€äº›çœŸæ­£æƒŠäººçš„å¥½å¤„å°†å¼€å§‹å‡ºç°ã€‚å½“ç„¶ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªä½“ç³»ç»“æ„å®Œå…¨æ˜¯å—åˆ°å‡½æ•°å¼ç¼–ç¨‹çš„å¯å‘!æˆ‘ä»¬å°†ä»ç®€å•çš„å‡½æ•°å’Œå‡½æ•°ç»„åˆä¸­è·å¾—çµæ„Ÿï¼Œä»è€Œç†è§£å¦‚ä½•è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è¯´è¿™ä¸ªä½“ç³»ç»“æ„æ˜¯ä¸€ç§çµä¸¹å¦™è¯ï¼Œå¯ä»¥è§£å†³æ‚¨æ‰€æœ‰çš„é—®é¢˜ï¼Œè€Œä¸”è‚¯å®šä¼šæœ‰ä¸€äº›æ—¶å€™ï¼Œæ‚¨æ­£åœ¨å¤„ç†çš„é—®é¢˜ä¼¼ä¹æ ¹æœ¬ä¸é€‚åˆè¿™ä¸ªæ¡†æ¶ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶è§‰å¾—è¿™äº›æƒ³æ³•å€¼å¾—æ¢ç´¢ï¼Œè€Œä¸”å¦‚æœä½ ä»æ­£ç¡®çš„è§’åº¦çœ‹å¾…é—®é¢˜ï¼Œå¯ä»¥ç”¨è¿™ç§æ¶æ„è§£å†³è®¸å¤šé—®é¢˜ï¼Œè¿™ä¹Ÿä¼šä»¤äººæƒŠè®¶ã€‚</p>
<h2 id="2-a-namerecapourappsofararecap-our-app-so-far">2. <a name='Recap:ourappsofar'></a>Recap: our app so far</h2>
<p>è®©æˆ‘ä»¬å¿«é€Ÿå›é¡¾ä¸€ä¸‹ä¸ŠèŠ‚è¯¾çš„å†…å®¹ã€‚æˆ‘ä»¬æœ‰æ ‡å‡†çš„è®¡æ•°appï¼Œä½†æœ‰ä¸€äº›é™„åŠ åŠŸèƒ½ã€‚</p>
<ul>
<li>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥åˆ°è®¡æ•°å±å¹•ï¼Œç‚¹å‡»+å’Œ-æŒ‰é’®æ¥å¢åŠ å’Œå‡å°‘è®¡æ•°å™¨ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥è¯¢é—®å½“å‰è®¡æ•°å™¨å€¼æ˜¯å¦ä¸ºç´ æ•°ï¼Œå¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”¶è—åˆ—è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤ç´ æ•°ã€‚</li>
<li>æˆ‘ä»¬è¿˜å¯ä»¥æ±‚ç¬¬nä¸ªè´¨æ•°ï¼Œå…¶ä¸­næ˜¯å½“å‰è®¡æ•°å™¨çš„å€¼ã€‚æŒ‰ä¸‹è¿™ä¸ªæŒ‰é’®å®é™…ä¸Šä¼šè§¦å‘ä¸€ä¸ªAPIè¯·æ±‚ï¼Œå¹¶åœ¨å¾—åˆ°å“åº”æ—¶æ˜¾ç¤ºä¸€ä¸ªè­¦æŠ¥ã€‚</li>
<li>ç„¶åæˆ‘ä»¬å¯ä»¥è¿›å…¥æ”¶è—ç•Œé¢æŸ¥çœ‹æ‰€æœ‰çš„æ”¶è—ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ é™¤ä»»ä½•ä¸å†æ˜¯æˆ‘ä»¬æ”¶è—çš„æ•°å­—ï¼Œè¿™äº›æ›´æ”¹ä¼šåœ¨åº”ç”¨ç¨‹åºçš„å„ä¸ªå±å¹•ä¸Šä¼ æ’­ã€‚</li>
</ul>
<p>è®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹ä»£ç ã€‚</p>
<p>æˆ‘ä»¬æœ‰æ ¹<strong>AppState</strong>ï¼Œå®ƒä¿å­˜äº†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰çŠ¶æ€ã€‚</p>
<pre><code class="language-swift">class AppState: ObservableObject {
  @Published var count = 0
  @Published var favoritePrimes: [Int] = []
  @Published var loggedInUser: User?
  @Published var activityFeed: [Activity] = []

  struct Activity {
    let timestamp: Date
    let type: ActivityType

    enum ActivityType {
      case addedFavoritePrime(Int)
      case removedFavoritePrime(Int)
    }
  }

  struct User {
    let id: Int
    let name: String
    let bio: String
  }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬æœ‰<strong>CounterView</strong>ï¼Œå®ƒç¬¦åˆSwiftUIçš„<strong>View</strong>åè®®ï¼Œå¯¹åº”è®¡æ•°å™¨å±å¹•ã€‚</p>
<pre><code class="language-swift">struct CounterView: View {
  @ObservedObject var state: AppState
  @State var isPrimeModalShown = false
  @State var alertNthPrime: PrimeAlert?
  @State var isNthPrimeButtonDisabled = false

  var body: some View {
    VStack {
      HStack {
        Button(&quot;-&quot;) { self.state.count -= 1 }
        Text(&quot;\(self.state.count)&quot;)
        Button(&quot;+&quot;) { self.state.count += 1 }
      }
      Button(&quot;Is this prime?&quot;) { self.isPrimeModalShown = true }
      Button(
        &quot;What is the \(ordinal(self.state.count)) prime?&quot;,
        action: self.nthPrimeButtonAction
      )
      .disabled(self.isNthPrimeButtonDisabled)
    }
    .font(.title)
    .navigationBarTitle(&quot;Counter demo&quot;)
    .sheet(isPresented: self.$isPrimeModalShown) {
      IsPrimeModalView(state: self.state)
    }
    .alert(item: self.$alertNthPrime) { alert in
      Alert(
        title: Text(&quot;The \(ordinal(self.state.count)) prime is \(alert.prime)&quot;),
        dismissButton: .default(Text(&quot;Ok&quot;))
      )
    }
  }

  func nthPrimeButtonAction() {
    self.isNthPrimeButtonDisabled = true
    nthPrime(self.state.count) { prime in
      self.alertNthPrime = prime.map(PrimeAlert.init(prime:))
      self.isNthPrimeButtonDisabled = false
    }
  }
}
</code></pre>
<p>æˆ‘ä»¬è¿˜æœ‰<strong>IsPrimeModalView</strong>ï¼Œå®ƒå¯¹åº”äºæ¨¡æ€è§†å›¾ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ä»æ‚¨çš„æ”¶è—ä¸­æ·»åŠ æˆ–åˆ é™¤ç´ æ•°ã€‚</p>
<pre><code class="language-swift">struct IsPrimeModalView: View {
  @ObservedObject var state: AppState

  var body: some View {
    VStack {
      if isPrime(self.state.count) {
        Text(&quot;\(self.state.count) is prime ğŸ‰&quot;)
        if self.state.favoritePrimes.contains(self.state.count) {
          Button(&quot;Remove from favorite primes&quot;) {
            self.state.favoritePrimes.removeAll(where: { $0 == self.state.count })
            self.state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(self.state.count)))
          }
        } else {
          Button(&quot;Save to favorite primes&quot;) {
            self.state.favoritePrimes.append(self.state.count)
            self.state.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(self.state.count)))

          }
        }
      } else {
        Text(&quot;\(self.state.count) is not prime :(&quot;)
      }
    }
  }
}
</code></pre>
<p>ä¹‹åæ˜¯<strong>FavoritePrimesView</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ”¶è—ç´ æ•°åˆ—è¡¨ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•æ—¶å€™åˆ é™¤æ”¶è—ã€‚</p>
<pre><code class="language-swift">struct FavoritePrimesView: View {
  @ObservedObject var state: AppState

  var body: some View {
    List {
      ForEach(self.state.favoritePrimes, id: \.self) { prime in
        Text(&quot;\(prime)&quot;)
      }
      .onDelete { indexSet in
        for index in indexSet {
          let prime = self.state.favoritePrimes[index]
          self.state.favoritePrimes.remove(at: index)
          self.state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(prime)))
        }
      }
    }
    .navigationBarTitle(&quot;Favorite Primes&quot;)
  }
}
</code></pre>
<p>æœ€åæˆ‘ä»¬æœ‰<strong>ContentView</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ¹è§†å›¾ï¼Œå°†æ•´ä¸ªåº”ç”¨ç¨‹åºæ”¾åœ¨ä¸€èµ·ã€‚</p>
<pre><code class="language-swift">struct ContentView: View {
  @ObservedObject var state: AppState

  var body: some View {
    NavigationView {
      List {
        NavigationLink(
          &quot;Counter demo&quot;,
          destination: CounterView(state: self.state)
        )
        NavigationLink(
          &quot;Favorite primes&quot;,
          destination: FavoritePrimesView(state: self.state)
        )
      }
      .navigationBarTitle(&quot;State management&quot;)
    }
  }
}
</code></pre>
<p>åœ¨<strong>playground</strong>çš„æœ€åï¼Œæˆ‘ä»¬åšäº†ä¸€äº›å·¥ä½œè®©å®ƒåœ¨å®æ—¶è§†å›¾ä¸­æ¸²æŸ“ã€‚</p>
<pre><code class="language-swift">import PlaygroundSupport
PlaygroundPage.current.liveView = UIHostingController(
  rootView: ContentView(state: AppState())
)
</code></pre>
<p>æ•´ä¸ªåº”ç”¨ç¨‹åºåªæœ‰å¤§çº¦140è¡Œä»£ç ï¼Œè€Œä¸”éå¸¸ç®€å•æ˜äº†! <strong>SwiftUI</strong>æ­£åœ¨ä¸ºæˆ‘ä»¬åšä¸€äº›ä¸å¯æ€è®®çš„äº‹æƒ…ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸æ„å‘³ç€å®ƒæ²¡æœ‰ä¸€äº›å°é—®é¢˜éœ€è¦æˆ‘ä»¬è§£å†³ã€‚</p>
<ul>
<li>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çš„<strong>view</strong>ä¸­å……æ–¥ç€çªå˜ï¼Œè¿™å¯èƒ½ä¼šæ¨¡ç³Šæ•°æ®å¦‚ä½•è¾“å…¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚æœ‰äº›çªå˜éšè—åœ¨<strong>helper</strong>æ–¹æ³•ä¸­(è¿™åªæ˜¯ä¸€ä¸ªé—´æ¥å±‚ï¼Œä½†æ‚¨å¯ä»¥æƒ³è±¡æ›´å¤š)ï¼Œè€Œå…¶ä»–æ“ä½œåœ¨è§†å›¾ä¸­åŒ…å«å¤šä¸ªçªå˜å’Œå¤§é‡ä»£ç ã€‚</p>
</li>
<li>
<p>æˆ‘ä»¬ä¹Ÿæƒ³è¦ä¸€ç§æ–¹æ³•æ¥åˆ†è§£è§†å›¾ï¼Œè¿™æ ·ä»–ä»¬å°±ä¸å¿…æ¥å—æ•´ä¸ªåº”ç”¨çŠ¶æ€ã€‚é€šå¸¸æˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªè§†å›¾ï¼Œåªéœ€è¦åº”ç”¨çŠ¶æ€çš„å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹å¼æ¥å®Œæˆå®ƒã€‚</p>
</li>
<li>
<p>å› ä¸ºæ‰€æœ‰è¿™äº›çªå˜éƒ½è¢«æ†ç»‘åœ¨<strong>SwiftUI</strong>è§†å›¾ä¸­ï¼Œæ²¡æœ‰æ›´å¥½çš„æ–¹æ³•æ¥æµ‹è¯•å®ƒä»¬ï¼Œè‹¹æœä¹Ÿæ²¡æœ‰ç»™æˆ‘ä»¬æä¾›å¦‚ä½•æµ‹è¯•çš„æŒ‡å¯¼ã€‚</p>
</li>
</ul>
<p>è¿™æ˜¯ç›®å‰ä¸ºæ­¢çš„åº”ç”¨ç¨‹åºã€‚å®ƒéå¸¸ç®€å•ï¼Œä½†å®ƒç¡®å®è§£å†³äº†æˆ‘ä»¬åœ¨æ„å»ºå¤§å‹åº”ç”¨ç¨‹åºæ—¶éœ€è¦è§£å†³çš„è®¸å¤šé—®é¢˜ã€‚</p>
<p>è®©æˆ‘ä»¬ç€æ‰‹è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<h2 id="3-a-nameabetterwaytomodelglobalstateaa-better-way-to-model-global-state">3. <a name='Abetterwaytomodelglobalstate'></a>A better way to model global state</h2>
<p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªéœ€è¦è§£å†³çš„æ›´ç®€å•çš„é—®é¢˜å¼€å§‹:ä¸€ä¸ªæ›´å¥½çš„å»ºæ¨¡å…¨å±€çŠ¶æ€çš„æ–¹æ³•ã€‚</p>
<p>æ—©äº›æ—¶å€™å½“æˆ‘ä»¬ä½¿ç”¨betaç‰ˆæœ¬ç¬¬ä¸€æ¬¡æ„å»ºè¿™ä¸ªåº”ç”¨ç¨‹åº,æˆ‘ä»¬é‡‡ç”¨äº†<strong>BindableObject</strong>åè®®,è¿™è¦æ±‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç±»,è€Œä¸æ˜¯ä¸€ä¸ªå€¼ç±»å‹,å£°æ˜ä¸€ä¸ªå‘å¸ƒè€…ï¼Œå®ƒéœ€è¦åœ¨ä»»ä½•æ—¶é—´çŠ¶æ€æ”¹å˜æ—¶è¿›è¡Œping,ç„¶åæ‰‹åŠ¨è¿›å…¥æ¯ä¸ªå­—æ®µçš„<strong>didSet</strong>ï¼Œä»¥pingé‚£ä¸ªå‘å¸ƒè€…ã€‚</p>
<p>å½“ä½ ä½¿ç”¨æ—©æœŸæµ‹è¯•ç‰ˆæ—¶ï¼Œç”Ÿæ´»å°±ä¼šæ¥å¾—å¾ˆå¿«! è‹¹æœå·²ç»å¼ƒç”¨äº†è¿™äº›apiï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ›´æ–°ã€æ›´æ—¶é«¦çš„apiã€‚æˆ‘ä»¬å·²ç»æ›´æ–°äº†ä»£ç ä»¥ä½¿ç”¨è¿™äº›æ›´æ–°çš„apiï¼Œäº‹æƒ…çœ‹èµ·æ¥å¥½å¤šäº†ã€‚</p>
<pre><code class="language-swift">class AppState: ObservableObject {
  @Published var count = 0
  @Published var favoritePrimes: [Int] = []
  @Published var activityFeed: [Activity] = []
  @Published var loggedInUser: User? = nil

  struct Activity {
    let type: ActivityType
    let timestamp = Date()

    enum ActivityType {
      case addedFavoritePrime(Int)
      case removedFavoritePrime(Int)
    }
  }

  struct User {
    let id: Int
    let name: String
    let bio: String
  }
}
</code></pre>
<p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ°:</p>
<ul>
<li>SwiftUIçš„<strong>BindableObject</strong>åè®®å·²ç»è¢«<strong>Combine</strong>çš„<strong>ObservableObject</strong>åè®®æ‰€å–ä»£ã€‚</li>
<li>å½“çŠ¶æ€æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦å£°æ˜ä¸€ä¸ªå‘å¸ƒè€…æ¥è·å–ä¿¡æ¯:<strong>ObservableObject</strong>ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆæˆä¸€ä¸ª<strong>objectWillChange</strong>å‘å¸ƒè€…ã€‚</li>
<li>æˆ‘ä»¬ä¹Ÿä¸å†éœ€è¦æ‰‹åŠ¨pingå‘å¸ƒè€…:ä»»ä½•å¸¦æœ‰@<strong>Published</strong>åŒ…è£…çš„å±æ€§éƒ½ä¼šåœ¨æ›´æ–°ä¹‹å‰è‡ªåŠ¨pingå‘å¸ƒè€…ã€‚</li>
</ul>
<p>å¾ˆé«˜å…´è‹¹æœå·²ç»æ¶ˆé™¤äº†æ—©æœŸæµ‹è¯•ç‰ˆå¸¦æ¥çš„è®¸å¤šè¿·é›¾ï¼Œä½†ä»æœ‰ä¸€äº›æ”¹è¿›çš„ç©ºé—´:</p>
<ul>
<li>æˆ‘ä»¬çš„æ¨¡å‹å±‚ä¸Combineæ¡†æ¶ç´§å¯†è€¦åˆ:å®ƒç¬¦åˆæ¥è‡ª<strong>Combine</strong>çš„åè®®ï¼Œå¹¶ä¸”æ¯ä¸ªå±æ€§éƒ½ç”±ä¸€ä¸ª<strong>Combine publisher</strong>åŒ…è£…ã€‚è¿™å°±å¼•å…¥äº†ä¸€ä¸ªä¾èµ–å…³ç³»ï¼Œå½“æˆ‘ä»¬åœ¨SwiftUIè§†å›¾ä¹‹å¤–ä¸æ¨¡å‹å±‚äº¤äº’æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å¹¶ä¸å…³å¿ƒè¿™ä¸ªä¾èµ–å…³ç³»ã€‚äº‹å®ä¸Šï¼Œè¿™ç§ä¾èµ–å¯èƒ½ä¼šé˜»æ­¢æˆ‘ä»¬ä¸æ— æ³•å¯¼å…¥<strong>Combine</strong>çš„ä»£ç å…±äº«è¯¥æ¨¡å‹ï¼Œæ¯”å¦‚<strong>Linux</strong>ä¸Šçš„æœåŠ¡å™¨ç«¯<strong>Swift</strong>ã€‚</li>
<li>å³ä½¿äº‹æƒ…æ¯”ä»¥å‰å°‘äº†å¾ˆå¤šå¹²æ‰°ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰ä½¿ç”¨@<strong>Published</strong>åŒ…è£…æ¯ä¸ªå±æ€§çš„å¹²æ‰°ã€‚</li>
<li>å¦‚æœæˆ‘ä»¬å¿˜è®°ç”¨@<strong>Published</strong>åŒ…è£…å±æ€§ï¼Œ<strong>SwiftUI</strong>å°†ä¸ä¼šæ”¶åˆ°å®ƒçš„æ›´æ”¹é€šçŸ¥ã€‚</li>
<li><strong>ObservableObjectå’ŒBindableObject</strong>ä¸€æ ·ï¼Œä»ç„¶è¦æ±‚æˆ‘ä»¬ä½¿ç”¨ç±»è€Œä¸æ˜¯å€¼ç±»å‹ã€‚ å€¼ç±»å‹æ˜¯å¾ˆå¥½çš„çŠ¶æ€å®¹å™¨:å®ƒä»¬ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹å¯å˜æ€§çš„ç»†ç²’åº¦æ§åˆ¶å’Œä¿è¯ã€‚</li>
</ul>
<p>å°†åº”ç”¨çŠ¶æ€ä»<strong>Combine</strong>ä¸­è§£è€¦å¹¶ä»å€¼è¯­ä¹‰ä¸­è·ç›Šçš„ä¸€ç§æ–¹æ³•æ˜¯å°†<strong>AppState</strong>è½¬æ¢ä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œç„¶åå›´ç»•å®ƒåˆ›å»ºä¸€ä¸ªéå¸¸è½»é‡çš„<strong>ObservableObject</strong>åŒ…è£…å™¨ã€‚</p>
<p>å°†æˆ‘ä»¬çš„çŠ¶æ€è½¬æ¢ä¸ºç»“æ„ä½“éå¸¸ç®€å•:</p>
<pre><code class="language-swift">struct AppState {
  var count = 0
  var favoritePrimes: [Int] = []
  var activityFeed: [Activity] = []
  var loggedInUser: User? = nil

  struct Activity {
    let type: ActivityType
    let timestamp = Date()

    enum ActivityType {
      case addedFavoritePrime(Int)
      case removedFavoritePrime(Int)
    }
  }

  struct User {
    let id: Int
    let name: String
    let bio: String
  }
}
</code></pre>
<p>ç°åœ¨è¿™æ›´ç®€å•äº†! æˆ‘ä»¬èƒ½å¤Ÿæ‘†è„±æ‰€æœ‰é‚£äº›@<strong>Published</strong>æ³¨è§£ï¼Œä¸å†éœ€è¦éµå¾ª<strong>ObservableObject</strong>ã€‚</p>
<p>ä¸ºäº†æ¢å¤è¿™ä¸ª<strong>ObservableObject</strong>ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¿™ä¸ªç»“æ„ä½“åŒ…è£…åœ¨ä¸€ä¸ªç±»ä¸­ã€‚æˆ‘ä»¬å°†å…¶å‘½åä¸º<strong>Store</strong>:</p>
<pre><code class="language-swift">final class Store: ObservableObject {
  @Published var value: AppState

  init(initialValue: AppState) {
    self.value = value
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€äº›ç¼–è¯‘å™¨é”™è¯¯éœ€è¦ä¿®å¤ï¼Œä½†åœ¨ä¿®å¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»è¿‡äºå…·ä½“ã€‚ Storeæ‰€è¦åšçš„å°±æ˜¯åŒ…è£…ä¸€ä¸ªå€¼ç±»å‹ï¼Œä¸ºå®ƒçš„è§‚å¯Ÿè€…æä¾›ä¸€ä¸ªé’©å­ã€‚ å®ƒä¸éœ€è¦çŸ¥é“ä»»ä½•å…³äº<strong>AppState</strong>çš„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿåœ°å°†å®ƒçš„æ³›å‹è®¾ç½®ä¸ºå®ƒåŒ…è£…çš„å€¼:</p>
<pre><code class="language-swift">final class Store&lt;Value&gt;: ObservableObject {
  @Published var value: Value

  init(initialValue: Value) {
    self.value = value
  }
}
</code></pre>
<p>Now if we form something like:</p>
<pre><code class="language-swift">Store&lt;AppState&gt;
</code></pre>
<p>æˆ‘ä»¬å°†è·å¾—ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œä¸€æ—¦<strong>AppState</strong>å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œå®ƒå°±ä¼šé€šçŸ¥å‘ç”Ÿäº†å˜åŒ–ã€‚æˆ‘ä»¬å·²ç»æœ‰æ•ˆåœ°å°†æ‰€æœ‰çš„çŠ¶æ€ä½åˆå¹¶åˆ°ä¸€ä¸ªå€¼ä¸­ã€‚</p>
<p>è¿™å¾ˆå¥½ï¼Œä½†ç°åœ¨æˆ‘ä»¬æœ‰ä¸€å †ç ´ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ä¸€äº›æœç´¢å’Œæ›¿æ¢æ¥ä¿®å¤è¿™æ®µä»£ç ã€‚é¦–å…ˆæˆ‘ä»¬æ›¿æ¢è¿™ä¸ª:</p>
<pre><code class="language-swift">@ObservedObject var state: AppState
</code></pre>
<p>With this:</p>
<pre><code class="language-swift">@ObservedObject var store: Store&lt;AppState&gt;
</code></pre>
<p>æ¯ä¸ªè§†å›¾ç°åœ¨éƒ½å°†å¯¹åº”ç”¨çŠ¶æ€å­˜å‚¨è¿›è¡Œæ“ä½œï¼Œè¿™æ ·ä»»ä½•åº”ç”¨çŠ¶æ€çš„å˜åŒ–éƒ½ä¼šè¢«æ­£ç¡®åœ°é€šçŸ¥åˆ°SwiftUIè§†å›¾ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ›¿æ¢æ‰€æœ‰çš„å¼•ç”¨:</p>
<pre><code class="language-swift">self.state -&gt; self.store.value
</code></pre>
<p>è¿™å°†ç¡®ä¿æ‰€æœ‰è§†å›¾éƒ½æ­£ç¡®åœ°ä»å•†åº—çš„çŠ¶æ€è¯»å–å¹¶å¯¹å•†åº—çš„çŠ¶æ€åº”ç”¨æ›´æ”¹ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿæœ‰ä¸€äº›è¿™æ ·çš„åœ°æ–¹:</p>
<pre><code class="language-swift">(state: self.store.value) -&gt; (store: self.store)
</code></pre>
<p>æœ€åï¼Œå½“æˆ‘ä»¬åˆ›å»ºæ ¹å†…å®¹è§†å›¾æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä¼ é€’ä¸€ä¸ª<strong>store</strong>è€Œä¸æ˜¯<strong>app state</strong>:</p>
<pre><code class="language-swift">rootView: ContentView(store: Store(value: AppState()))
</code></pre>
<h2 id="4-a-namefunctionalstatemanagementafunctional-state-management">4. <a name='Functionalstatemanagement'></a>Functional state management</h2>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»ä»<strong>Combineå’ŒSwiftUI</strong>æ¡†æ¶ä¸­è§£è€¦äº†åº”ç”¨çŠ¶æ€ï¼Œå¹¶åœ¨å€¼ç±»å‹ä¸­æ•è·å®ƒï¼Œè€Œä¸æ˜¯åœ¨ç±»ä¸­ã€‚æˆ‘ä»¬è¿˜å¯ä»¥éšæ„æ·»åŠ æ–°çš„çŠ¶æ€ï¼Œè€Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„å·¥ä½œã€‚è¿™å·²ç»æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„èƒœåˆ©äº†</p>
<p>è®©æˆ‘ä»¬æ¥è§£å†³å¦ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æ¯”ä¸Šä¸€ä¸ªç¨å¾®å¤æ‚ä¸€äº›:æˆ‘ä»¬å¦‚ä½•å¤„ç†çŠ¶æ€çªå˜ï¼Œä»¥ä¾¿æœ‰ä¸€ç§å•ä¸€ã€ä¸€è‡´çš„æ–¹å¼æ¥æ‰§è¡Œçªå˜ã€‚ç›®å‰ï¼Œå¯¹äºæˆ‘ä»¬å¦‚ä½•å¯¹æˆ‘ä»¬çš„stateè¿›è¡Œçªå˜ï¼ŒçœŸçš„æ²¡æœ‰ä»»ä½•è§„å¾‹æˆ–ç†ç”±ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å„ç§æ“ä½œå¤„ç†ç¨‹åºå’Œäº‹ä»¶å›è°ƒä¸­æ·»åŠ çªå˜æ˜¯ç›¸å½“å®¹æ˜“çš„ï¼Œä½†è¿™æ ·åšäº†å‡ æ¬¡ä¹‹åï¼Œå°±ä¸æ¸…æ¥šæ•°æ®æ˜¯å¦‚ä½•åœ¨åº”ç”¨ç¨‹åºä¸­æµåŠ¨çš„ã€‚æˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ç§å•ä¸€çš„ã€ä¸€è‡´çš„æ–¹å¼æ¥æè¿°å’Œæ‰§è¡Œåº”ç”¨ç¨‹åºä¸­çš„å˜åŒ–ï¼Œè¿™æ ·æ— è®ºä½ åœ¨å“ªä¸ªæ–‡ä»¶ä¸­ï¼Œä½ éƒ½å¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹åˆ°ä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•éšç€å„ç§ç”¨æˆ·æ“ä½œè€Œå‘å±•çš„ã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬è¯•ç€æç‚¼çŠ¶æ€çªå˜çš„æœ¬è´¨ï¼Œå¹¶æå‡ºä¸€ä¸ªæè¿°ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¼–ç åˆ°ä¸€ä¸ªå®é™…çš„ç¨‹åºä¸­ã€‚çŠ¶æ€çªå˜æ˜¯æŒ‡è·å–å½“å‰çŠ¶æ€å’Œå‘ç”Ÿçš„äº‹ä»¶(å¦‚ç”¨æˆ·ç‚¹å‡»æŒ‰é’®)ï¼Œå¹¶ä½¿ç”¨è¿™ä¸¤éƒ¨åˆ†ä¿¡æ¯æ¥æ´¾ç”Ÿä¸€ä¸ªå…¨æ–°çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„çŠ¶æ€<strong>count</strong>ä¸º0ï¼Œç„¶åä¸€ä¸ªç”¨æˆ·æ“ä½œæ˜¾ç¤ºç”¨æˆ·ç‚¹å‡»äº†â€œ+â€æŒ‰é’®ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥ç”Ÿæˆä¸€ä¸ªæ–°çš„çŠ¶æ€<strong>count</strong>ä¸º1ã€‚è¿™å¬èµ·æ¥åƒä¸ªå‡½æ•°!</p>
<p>å”¯ä¸€çš„é—®é¢˜æ˜¯â€œç”¨æˆ·åŠ¨ä½œâ€äº‹ä»¶ç°åœ¨å®šä¹‰ä¸æ¸…ã€‚ç›®å‰ï¼Œâ€œç”¨æˆ·åŠ¨ä½œâ€åªæ˜¯æŒ‡é‚£äº›åœ¨SwiftUIä¸­æ‰§è¡Œçš„åŠ¨ä½œé—­åŒ…ä¸­çš„ä¸€ä¸ªã€‚æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªæ¦‚å¿µè½¬æ¢ä¸ºåˆé€‚çš„æ•°æ®ç±»å‹ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œå®é™…æ“ä½œã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸æ˜¯ç›´æ¥åœ¨è§†å›¾ä¸­è¿›è¡Œæ›´æ”¹ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ•°æ®ç±»å‹æ¥æè¿°å®ƒä»¬ã€‚</p>
<p>å› ä¸ºç”¨æˆ·å¯ä»¥æ‰§è¡Œè®¸å¤šç±»å‹çš„æ“ä½œï¼Œè€Œä¸€ä¸ªæ“ä½œå¯ä»¥æ˜¯è¿™äº›ç±»å‹ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œæ‰€ä»¥æšä¸¾å¯èƒ½æ˜¯åˆé€‚çš„:</p>
<pre><code class="language-swift">enum CounterAction {
  case decrTapped
  case incrTapped
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—å½“å‰çš„çŠ¶æ€ç‰‡æ®µï¼Œå¹¶å°†å…¶ç»„åˆæˆä¸€ä¸ªåŠ¨ä½œï¼Œä»¥è·å¾—æ›´æ–°çš„çŠ¶æ€ã€‚å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre><code class="language-swift">func counterReducer(state: AppState, action: CounterAction) -&gt; AppState {
  switch action {
  case .decrTapped:
    return AppState(
      count: state.count - 1,
      favoritePrimes: state.favoritePrimes,
      loggedInUser: state.loggedInUser,
      activityFeed: state.activityFeed
    )
  case .incrTapped:
    return AppState(
      count: state.count + 1,
      favoritePrimes: state.favoritePrimes,
      loggedInUser: state.loggedInUser,
      activityFeed: state.activityFeed
    )
  }
}
</code></pre>
<p>å¯¹äºè¿™ä¹ˆç®€å•çš„äº‹æƒ…æ¥è¯´ï¼Œè¿™æ˜¯ç›¸å½“å†—é•¿çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»ä¸ºæˆ‘ä»¬æƒ³è¦åšçš„æ¯ä¸ªçªå˜åˆ›å»ºæ‰€æœ‰æ–°çš„çŠ¶æ€å€¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤åˆ¶æˆ‘ä»¬çš„çŠ¶æ€æ¥ä¿®å¤å†—é•¿çš„é—®é¢˜ï¼Œä½†ä»£ä»·æ˜¯ä½¿ç”¨ä¸€äº›æ ·æ¿æ–‡ä»¶:</p>
<pre><code class="language-swift">func counterReducer(state: AppState, action: CounterAction) -&gt; AppState {
  var copy = state
  switch action {
  case .decrTapped:
    copy.count -= 1
  case .incrTapped:
    copy.count += 1
  }
  return copy
}
</code></pre>
<p>å®ƒè‚¯å®šæ›´çŸ­ï¼Œä½†æ¯ä¸€ä¸ª<strong>reducer</strong>éƒ½è¦åšè¿™ä¸ªå¤åˆ¶èˆã€‚ å¦‚æœæˆ‘ä»¬ä¸å°å¿ƒæŠŠæ‹·è´å’ŒçŠ¶æ€å¼„æ··äº†ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€äº›éå¸¸å¾®å¦™çš„é”™è¯¯ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨å°±å¼€å§‹å§ï¼Œæˆ‘ä»¬ä¸€ä¼šå„¿ä¼šè®²åˆ°è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å«å®ƒ<strong>counterReducer</strong>? å¥½åƒæ˜¯ä¸ªå¥‡æ€ªçš„åå­—ã€‚è¿™ä¸ªåå­—çš„çµæ„Ÿæ¥è‡ªäºæ•°ç»„ä¸Š<strong>reduce</strong>å‡½æ•°çš„ç­¾åï¼Œä¾‹å¦‚:</p>
<pre><code class="language-swift">[1, 2, 3].reduce(
  &lt;#initialResult: Result#&gt;,
  &lt;#nextPartialResult: (Result, Int) throws -&gt; Result#&gt;
)
</code></pre>
<p><strong>Result</strong>å€¼å°±åƒæˆ‘ä»¬çš„çŠ¶æ€ï¼Œå½“æˆ‘ä»¬å°†è¶Šæ¥è¶Šå¤šçš„æ•´æ•°åˆå¹¶åˆ°å®ƒæ—¶ï¼Œè¿™ä¸ªå€¼å°±ä¼šç´¯ç§¯ã€‚æ‰€ä»¥æˆ‘ä»¬è¾“å…¥åˆ°æ•°ç»„<strong>reduce</strong>ä¸­çš„ç´¯åŠ å™¨å‡½æ•°çš„ç­¾åä¸<strong>counterReducer</strong>çš„ç­¾åéå¸¸ç›¸ä¼¼ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿™æ ·å‘½åè¿™ä¸ªå‡½æ•°ã€‚</p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬æ€ä¹ˆç”¨è¿™ä¸ªå‘¢? æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€äº›çŠ¶æ€æ¥ç©ï¼Œç„¶ååº”ç”¨å‡ æ¬¡<strong>counterReducer</strong>å‡½æ•°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å˜åŒ–çš„:</p>
<pre><code class="language-swift">let state = AppState()
counterReducer(value: value, action: .incrTapped)
print(state)
// AppState(count: 0, favoritePrimes: [], loggedInUser: nil, activityFeed: [])
</code></pre>
<p>çŠ¶æ€æ²¡æœ‰æ”¹å˜ï¼Œå› ä¸º<strong>counterReducer</strong>è¿”å›ä¸€ä¸ªå…¨æ–°çš„appçŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸæ­£æƒ³æ‰“å°çš„æ˜¯å‡½æ•°è¿”å›çš„å€¼ã€‚</p>
<pre><code class="language-swift">print(counterReducer(value: value, action: .incrTapped))
// AppState(count: 1, favoritePrimes: [], loggedInUser: nil, activityFeed: [])
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çœ‹åˆ°è®¡æ•°å¢åŠ äº†ã€‚å¦‚æœæˆ‘ä»¬æƒ³å‡å°‘è®¡æ•°ï¼Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·åš:</p>
<pre><code class="language-swift">print(counterReducer(value: value, action: .decrTapped))
</code></pre>
<p>ç”±äºæ¯æ¬¡é€šè¿‡<strong>counterReducer</strong>éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥åçš„åº”ç”¨ç¨‹åºä¸ä¼šæ”¹å˜ä»¥å‰çš„çŠ¶æ€ã€‚ä¸ºäº†è·å¾—è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦åƒè¿™æ ·åµŒå¥—:</p>
<pre><code class="language-swift">print(
  counterReducer(
    value: counterReducer(
      value: value,
      action: .incrTapped
    ),
    action:.decrTapped
  )
)
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°è¿™ç§åµŒå¥—çš„åŸå› æ˜¯<strong>counterReducer</strong>å‡½æ•°ä¸€æ¬¡åªä»£è¡¨ä¸€ä¸ªçªå˜ï¼Œå®ƒå°†æ‚¨ä»ä¸€ä¸ªçŠ¶æ€å¸¦åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚å®ƒæ²¡æœ‰èƒ½åŠ›éšç€æ—¶é—´çš„æ¨ç§»å°†å¤šä¸ªçªå˜ç§¯ç´¯æˆåº”ç”¨çŠ¶æ€çš„ä¸€ä¸ªå·¨å¤§çªå˜ã€‚æˆ‘ä»¬éœ€è¦å¦ä¸€ç§æœºåˆ¶ã€‚ä½†æ˜¯å®ƒåº”è¯¥ä½åœ¨å“ªé‡Œå‘¢?</p>
<p>æˆ‘ä»¬å·²ç»æœ‰äº†è¿™ä¸ª<strong>Store</strong>ç±»æ¥ä¿å­˜åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€ï¼Œè¿™æ˜¯æˆ‘ä»¬æƒ³è¦æ”¹å˜çš„çŠ¶æ€ä»¥ä¾¿åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰è§†å›¾åœ¨å‘ç”Ÿå˜åŒ–æ—¶éƒ½èƒ½å¾—åˆ°é€šçŸ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä»åšä¸€äº›æ„šè ¢çš„äº‹æƒ…å¼€å§‹ï¼Œå°†å­˜å‚¨çŠ¶æ€çš„ç›´æ¥çªå˜æ›¿æ¢ä¸ºé¦–å…ˆè°ƒç”¨<strong>reducer</strong>çš„ä¸œè¥¿ï¼Œç„¶åå°†æ–°çŠ¶æ€å¡«å……åˆ°å­˜å‚¨ä¸­ã€‚å¦‚å‡é‡æŒ‰é’®:</p>
<pre><code class="language-swift">Button(&quot;-&quot;) {
  self.store.value = counterReducer(state: self.store.value, action: .decrTapped)
//  self.store.state.count -= 1
}
</code></pre>
<p>åœ¨å¢é‡æŒ‰é’®ä¸­:</p>
<pre><code class="language-swift">Button(&quot;+&quot;) {
  self.store.value = counterReducer(state: self.store.value, action: .incrTapped)
//  self.store.state.count += 1
}
</code></pre>
<p>And everything compiles and works as it did before.</p>
<p>è¿™è¦å†—é•¿å¾—å¤šï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå¥½å¤„ã€‚æˆ‘ä»¬ä¸æ˜¯ç›´æ¥æ”¹å˜æŒ‰é’®åŠ¨ä½œé—­åˆå†…éƒ¨çš„çŠ¶æ€ï¼Œè€Œæ˜¯å°†ç›¸åº”çš„åŠ¨ä½œå€¼å‘é€ç»™reducerï¼Œè®©<strong>reducer</strong>åšæ‰€æœ‰å¿…è¦çš„å˜åŒ–ã€‚è¿™å°±æ˜¯ç”¨æˆ·æ“ä½œçš„è¯´æ˜æ€§çš„å«ä¹‰:æˆ‘ä»¬æè¿°ç”¨æˆ·æ‰€åšçš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯æ‰§è¡Œé‚£äº›ç”±ç”¨æˆ·æ“ä½œå¯¼è‡´çš„æ··ä¹±çš„ã€å¾ªåºæ¸è¿›çš„å˜åŒ–ã€‚ç°åœ¨çªå˜å¾ˆç®€å•ï¼Œä½†æ˜¯ä½ å¯ä»¥æƒ³è±¡<strong>reducer</strong>éœ€è¦åšå¾ˆå¤šå·¥ä½œï¼Œæˆ‘ä»¬ç°åœ¨åœ¨<strong>reducer</strong>ä¸­è¿›è¡Œäº†å·¥ä½œã€‚</p>
<h2 id="5-a-nameergonomicscapturingreducerinstoreaergonomics-capturing-reducer-in-store">5. <a name='Ergonomics:capturingreducerinstore'></a>Ergonomics: capturing reducer in store</h2>
<p>ç„¶è€Œï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ä½¿ç”¨<strong>reducer</strong>å’Œ<strong>store</strong>çš„æ–¹å¼ã€‚æ¯æ¬¡ç›´æ¥è°ƒç”¨<strong>reducer</strong>å¹¶ä½¿ç”¨<strong>reducer</strong>çš„è¾“å‡ºé‡æ–°åˆ†é…<strong>store</strong>çš„æ€å°†ä¼šæœ‰å¤§é‡çš„æ ·æ¿æ–‡ä»¶ã€‚ ä¼¼ä¹æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæ ·æ¿ä»£ç ç§»åˆ°<strong>store</strong>ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦åšä¸€æ¬¡ï¼Œç„¶åè§†å›¾ä¸­çš„call-siteså°±ä¼šå¾ˆå¥½ï¼Œå¾ˆæ•´é½ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡è°ƒç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•å‘Šè¯‰<strong>store</strong>å·²ç»è°ƒç”¨äº†ä¸€ä¸ªç”¨æˆ·æ“ä½œï¼Œç„¶å<strong>store</strong>è´Ÿè´£è¿è¡Œ<strong>reducer</strong>ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¼ªä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•å‡å°‘æˆ‘ä»¬çš„è®¡æ•°:</p>
<pre><code class="language-swift">Button(&quot;-&quot;) { self.store.send(.decrTapped) }
</code></pre>
<ul>
<li></li>
</ul>
<pre><code class="language-swift">Button(&quot;+&quot;) { self.store.send(.incrTapped) }
</code></pre>
<p>æˆ‘ä»¬è®¾æƒ³è¦å‘é€è¿™ä¸ªæ–¹æ³•çš„åç§°ï¼Œå› ä¸ºå®ƒæ¨¡ä»¿äº†<strong>Combine</strong>æ¡†æ¶ç”¨äºå‘å‘å¸ƒè€…å‘é€æ•°æ®çš„å‘½åã€‚</p>
<p>ç„¶å<strong>store</strong>å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠ¨ä½œåœ¨<strong>store</strong>çš„å½“å‰çŠ¶æ€ä¸Šè¿è¡Œ<strong>reducer</strong>ï¼Œå®ƒå¯ä»¥é‡æ–°åˆ†é…çŠ¶æ€ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ°æ‰€æœ‰è§†å›¾æ›´æ–°ã€‚<strong>store</strong>å¼€å§‹å°è£…è¶Šæ¥è¶Šå¤šçš„åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶è¡Œä¸ºã€‚</p>
<p>æˆ‘ä»¬æ€ä¹ˆåšå‘¢?</p>
<p>é¦–å…ˆï¼Œç”±äºæˆ‘ä»¬çš„<strong>store</strong>ç°åœ¨å¿…é¡»çŸ¥é“åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä»¥åŠå¯ä»¥æ”¹å˜çŠ¶æ€çš„æ“ä½œç±»å‹ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºæˆ‘ä»¬è¯†åˆ«çš„æ“ä½œç±»å‹å¼•å…¥ä¸€ä¸ªæ–°çš„æ³›å‹:</p>
<pre><code class="language-swift">final class Store&lt;Value, Action&gt;: ObservableObject {
  â€¦
  func send(_ action: Action) {

  }
}
</code></pre>
<p>ç°åœ¨ï¼Œåœ¨è¿™ä¸ª<strong>send</strong>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æƒ³ç”¨æˆ‘ä»¬çš„å½“å‰çŠ¶æ€è°ƒç”¨<strong>reducer</strong>ï¼Œç„¶åç”¨<strong>reducer</strong>äº§ç”Ÿçš„æ–°çŠ¶æ€æ›¿æ¢å½“å‰çŠ¶æ€ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ²¡æœ‰<strong>reducer</strong>ï¼Œæ‰€ä»¥å¬èµ·æ¥æˆ‘ä»¬çš„<strong>store</strong>éœ€è¦ä¿ç•™<strong>reducer</strong>:</p>
<pre><code class="language-swift">class Store&lt;Value, Action&gt;: ObservableObject {
  let reducer: (Value, Action) -&gt; Value
  â€¦
  init(initialValue: Value, reducer: @escaping (Value, Action) -&gt; Value) {
    self.value = value
    self.reducer = reducer
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°<strong>send</strong>æ–¹æ³•äº†:</p>
<pre><code class="language-swift">func send(_ action: Action) {
  self.value = self.reducer(self.value, action)
}
</code></pre>
<p>é€šè¿‡è¿™äº›æ”¹å˜ï¼Œæˆ‘ä»¬éœ€è¦ä¿®å¤ä¸€äº›ç¼–è¯‘å™¨é”™è¯¯ã€‚æˆ‘ä»¬éœ€è¦æ›´æ–°å¯¹<strong>Store</strong>çš„å¼•ç”¨ï¼Œä»¥åŒ…å«é¢å¤–çš„æ³›å‹:</p>
<pre><code class="language-swift">@ObservedObject var store: Store&lt;AppState, CounterAction&gt;
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ª<strong>reducer</strong>æ¥åˆå§‹åŒ–æˆ‘ä»¬çš„<strong>store</strong>ï¼Œè®©æˆ‘ä»¬è¿™æ ·åš:</p>
<pre><code class="language-swift">ContentView(store: Store(state: AppState(), reducer: counterReducer))
</code></pre>
<p>ç°åœ¨ä¸€åˆ‡éƒ½é‡æ–°ç¼–è¯‘äº†ï¼Œä¸€åˆ‡éƒ½å’Œä»¥å‰ä¸€æ ·ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œæˆ‘ä»¬å°†å°‘é‡çš„çŠ¶æ€çªå˜éš”ç¦»åˆ°æˆ‘ä»¬çš„<strong>reducer</strong>ä¸­ï¼Œå¹¶ä¸”æˆ‘ä»¬é€šè¿‡è°ƒç”¨<strong>store</strong>ä¸Šçš„<strong>send</strong>æ–¹æ³•å¼ºåˆ¶è‡ªå·±æ‰§è¡Œè¿™äº›çªå˜ã€‚æˆ‘ä»¬ä¸è¢«å…è®¸åœ¨ä»»ä½•åœ°æ–¹è¿›è¡Œä»»ä½•æˆ‘ä»¬æƒ³è¦çš„çªå˜ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠå®ƒæ‰“åŒ…æˆä¸€ä¸ª<strong>action</strong>ï¼Œç„¶åé€å»<strong>reducer</strong>ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†<strong>Store</strong>çš„<strong>value</strong>å±æ€§è®¾ç½®ä¸ºç§æœ‰!è¿™æ„å‘³ç€é™¤éé€šè¿‡<strong>reducer</strong>ï¼Œå¦åˆ™ä¸å¯èƒ½æ”¹å˜åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚</p>
<h2 id="6-a-nameergonomicsin-outreducersaergonomics-in-out-reducers">6. <a name='Ergonomics:in-outreducers'></a>Ergonomics: in-out reducers</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä»æˆ‘ä»¬çš„<strong>view</strong>ä¸­æå–æ›´å¤šçš„çªå˜ï¼Œå¹¶å°†å®ƒä»¬å¡è¿›æˆ‘ä»¬çš„<strong>action</strong>å’Œ<strong>reducer</strong>ä¸­ï¼Œä½†æˆ‘ä»¬è¿˜å¯ä»¥å¯¹æˆ‘ä»¬çš„è®¾ç½®åšå‡ºå¦ä¸€ä¸ªæ”¹è¿›ã€‚ç°åœ¨ï¼Œå…³äºæˆ‘ä»¬å®šä¹‰<strong>reducer</strong>çš„æ–¹å¼ï¼Œæœ‰ä¸¤ä¸ªçƒ¦äººçš„åœ°æ–¹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åœ¨æ¯ä¸ª<strong>reducer</strong>ä¸­æœ‰ä¸€äº›æ ·æ¿ï¼Œæˆ‘ä»¬åˆ›å»ºçŠ¶æ€çš„å‰¯æœ¬ï¼Œå¯¹å‰¯æœ¬è¿›è¡Œçªå˜ï¼Œç„¶åè¿”å›å‰¯æœ¬ã€‚è¿™ä¸ªæ ·æ¿æ–‡ä»¶å¾ˆå®¹æ˜“å‡ºé”™ï¼Œè€Œä¸”å¾ˆéº»çƒ¦ã€‚ç¬¬äºŒï¼Œå¤åˆ¶è¿‡ç¨‹ä¸ä¼šéå¸¸é«˜æ•ˆå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§çš„åº”ç”¨çŠ¶æ€ã€‚æ¯æ¬¡ç”¨æˆ·æ‰§è¡Œä¸€ä¸ªæ“ä½œå¹¶è¿è¡Œ<strong>reducer</strong>æ—¶ï¼Œéƒ½è¦å¤åˆ¶å®Œæ•´çš„åº”ç”¨çŠ¶æ€ï¼Œè¿™æ˜¯æ— æ³•å¾ˆå¥½åœ°æ‰©å±•çš„ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæŠ€å·§ï¼Œå°†è¿™ä¸ªçœ‹ä¼¼ä½æ•ˆçš„å‡½æ•°è½¬æ¢ä¸ºä¸€ä¸ªç­‰æ•ˆçš„æ›´é«˜æ•ˆçš„å‡½æ•°ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬åœ¨Point-Freeçš„ç¬¬äºŒé›†è®¨è®ºäº†è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬è®¨è®ºäº†å‰¯ä½œç”¨å’ŒSwiftçš„<strong>inout</strong>åŠŸèƒ½ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå½¢å¼çš„åŠŸèƒ½ä¹‹é—´æ˜¯ç­‰ä»·çš„:</p>
<pre><code class="language-swift">// (A) -&gt; A  ----&gt; (inout A) -&gt; Void
</code></pre>
<p>ä½ å¯ä»¥æŠŠä½ å¯¹<strong>inout A</strong>åšçš„ä»»ä½•çªå˜çœ‹ä½œæ˜¯å‡½æ•°çš„éšè—è¾“å‡ºï¼Œå› æ­¤å®ƒçš„è¡Œä¸ºå°±åƒ(<strong>A) - &gt;A</strong>å‡½æ•°ã€‚</p>
<p>å½“ä½ çš„å‡½æ•°æœ‰å¤šä¸ªè¾“å…¥æˆ–è¾“å‡ºæ—¶ï¼Œä»–çš„æŠ€å·§ä¹Ÿæœ‰æ•ˆã€‚ä¾‹å¦‚</p>
<pre><code class="language-swift">// (A, B) -&gt; (A, C)  ----&gt; // (inout A, B) -&gt; C
</code></pre>
<p>é€šå¸¸ï¼Œå¦‚æœç±»å‹å‚æ•°åœ¨å‡½æ•°ç®­å¤´çš„ä¸¤è¾¹æ°å¥½å‡ºç°ä¸€æ¬¡ï¼Œåˆ™å¯ä»¥å°†å…¶ä»å³ä¾§ç§»é™¤ï¼Œä½†ä»£ä»·æ˜¯åœ¨å·¦ä¾§å¼•å…¥<strong>inout</strong>å‚æ•°ã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æŠŠè¿™ä¸ªæƒ³æ³•åº”ç”¨åˆ°<strong>reducer</strong>ç­¾åä¸Š:</p>
<pre><code class="language-swift">// (Value, Action) -&gt; Value  -----&gt; // (inout Value, Action) -&gt; Void
</code></pre>
<p>è¿™ç§å½¢å¼çš„<strong>reducer</strong>å’Œä¹‹å‰çš„è¡¨ç°æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ•ˆç‡æ›´é«˜ä¸€ç‚¹ã€‚ äº‹å®ä¸Šï¼ŒSwiftæ ‡å‡†åº“æœ‰ä¸€ä¸ªç²¾ç¡®çš„è¿™ä¸ªç­¾åçš„<strong>reduce</strong>é‡è½½ã€‚æœ€åˆæ˜¯ç”±æˆ‘ä»¬çš„è€æœ‹å‹Chris Eidhofæå‡ºçš„ï¼Œåæ¥åœ¨ã€ŠSwift 3ã€‹ä¸­è¢«å¼•å…¥:</p>
<pre><code class="language-swift">[1, 2, 3].reduce(
  into: &lt;#Result#&gt;,
  &lt;#updateAccumulatingResult: (inout Result, Int) throws -&gt; ()#&gt;
)
</code></pre>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„<strong>reducer</strong>ã€‚è®©æˆ‘ä»¬ä»æ”¹å˜å®ƒçš„ç­¾åå¼€å§‹:</p>
<pre><code class="language-swift">func counterReducer(value: inout AppState, action: CounterAction) {
</code></pre>
<p>ç„¶åï¼Œæˆ‘ä»¬å°†é€šè¿‡æ‰§è¡Œçªå˜è€Œä¸æ˜¯å¤åˆ¶å’Œè¿”å›æ–°å€¼æ¥ä¿®å¤ç¼–è¯‘é”™è¯¯:</p>
<pre><code class="language-swift">func counterReducer(value: inout AppState, action: CounterAction) {
  switch action {
  case .decrTapped:
    value.count -= 1
  case .incrTapped:
    value.count += 1
  }
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨å…¶ä»–<strong>reducer</strong>ä¸€æ ·ä½¿ç”¨è¿™ç§<strong>reducer</strong>:</p>
<pre><code class="language-swift">var state = AppState()
counterReducer(value: &amp;state, action: .incrTapped)
counterReducer(value: &amp;state, action: .decrTapped)
</code></pre>
<p>ç°åœ¨å¾ˆå®¹æ˜“å…³æ³¨æ¯ä¸ª<strong>action</strong>ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜è·å¾—äº†æ›´é«˜æ•ˆç‡çš„é¢å¤–å¥½å¤„ã€‚ä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€äº›ç¼–è¯‘é”™è¯¯éœ€è¦ä¿®å¤ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¿®å¤<strong>reducer</strong>åœ¨ä»“åº“çš„ç­¾å:</p>
<pre><code class="language-swift">class Store&lt;Value, Action&gt;: ObservableObject {
  let reducer: (inout Value, Action) -&gt; Void
</code></pre>
<p>åˆå§‹åŒ–å™¨éœ€è¦æ›´æ–°:</p>
<pre><code class="language-swift">init(initialValue: Value, reducer: @escaping (inout Value, Action) -&gt; Void) {
  self.value = value
  self.reducer = reducer
}
</code></pre>
<p><strong>send</strong>æ–¹æ³•ç°åœ¨ç®€åŒ–ä¸º:</p>
<pre><code class="language-swift">func send(_ action: Action) {
  self.reducer(&amp;self.value, action)
}
</code></pre>
<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç°åœ¨ç¼–è¯‘ï¼Œå·¥ä½œå®Œå…¨åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬çš„ä»£ç å˜å¾—æ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦ï¼Œç”šè‡³æ€§èƒ½æ›´ä¼˜ã€‚å¬èµ·æ¥æ˜¯ä¸ªåŒèµ¢çš„å±€é¢ã€‚</p>
<h2 id="7-a-namemovingmoremutationsintothestoreamoving-more-mutations-into-the-store">7. <a name='Movingmoremutationsintothestore'></a>Moving more mutations into the store</h2>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨ä»ç„¶ç”Ÿæ´»åœ¨ä¸¤ä¸ªä¸–ç•Œã€‚é€šè¿‡è¿™ä¸ªæ¼‚äº®çš„æ–°æ¥å£ï¼Œæˆ‘ä»¬çš„ä¸€äº›çŠ¶æ€æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå‘æˆ‘ä»¬çš„<strong>store</strong>å‘é€åŠ¨ä½œï¼Œå¹¶è®©å®ƒé€šè¿‡æˆ‘ä»¬çš„<strong>reducer</strong>å¤„ç†å˜åŒ–é€»è¾‘ï¼Œè€Œæˆ‘ä»¬çš„ä¸€äº›çŠ¶æ€ä»ç„¶åœ¨æˆ‘ä»¬çš„è§†å›¾ä¸­ç›´æ¥å†…è”åœ°å‘ç”Ÿå˜åŒ–ã€‚è®©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>IsPrimeModalView</strong>åœ¨æŒ‰é’®æ“ä½œä¸­ç›´æ¥å‘ç”Ÿäº†ä»¥ä¸‹å˜åŒ–:</p>
<pre><code class="language-swift">Button(&quot;Remove from favorite primes&quot;) {
  self.store.value.favoritePrimes.removeAll(where: { $0 == self.store.value.count })
  self.store.value.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(self.store.value.count)))
}
â€¦
Button(&quot;Save to favorite primes&quot;) {
  self.store.value.favoritePrimes.append(self.store.value.count)
  self.store.value.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(self.store.value.count)))
}
</code></pre>
<p>è¿™äº›çªå˜è´Ÿè´£å‘æˆ‘ä»¬çš„æ”¶è—è´¨æ•°åˆ—è¡¨æ·»åŠ æˆ–åˆ é™¤å½“å‰è®¡æ•°å™¨å€¼ï¼Œä»¥åŠå°†è¯¥äº‹ä»¶æ·»åŠ åˆ°ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­æ‰€åšçš„äº‹æƒ…çš„æ´»åŠ¨feedä¸­ï¼Œå°½ç®¡æˆ‘ä»¬å®é™…ä¸Šè¿˜æ²¡æœ‰æ„å»ºå‡ºé‚£ä¸ªå±å¹•ã€‚</p>
<p>è®©æˆ‘ä»¬åƒå¤„ç†å¢é‡çªå˜å’Œé€’å‡çªå˜ä¸€æ ·å¤„ç†è¿™äº›çªå˜ã€‚æˆ‘ä»¬å°†æ·»åŠ æ–°çš„æ¡ˆä¾‹åˆ°æˆ‘ä»¬çš„åŠ¨ä½œæšä¸¾ä¸­:</p>
<pre><code class="language-swift">enum CounterAction {
  â€¦
  case saveFavoritePrimeTapped
  case removeFavoritePrimeTapped
}
</code></pre>
<p>è¿™åœ¨æˆ‘ä»¬çš„<strong>reducer</strong>ä¸­åˆ›å»ºäº†ä¸€ä¸ªç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æœ‰æ–°çš„æƒ…å†µéœ€è¦å¤„ç†:</p>
<pre><code class="language-swift">func counterReducer(value: AppState, action: CounterAction) -&gt; AppState {
  switch action {
  â€¦
  case .saveFavoritePrimeTapped:
    fatalError()
  case .removeFavoritePrimeTapped:
    fatalError()
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å¡«å…¥è¿™äº›ç©ºç™½ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆè§£å†³ä¸€ä¸ªå¥‡æ€ªçš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦æŠŠæ¨¡æ€çš„é€»è¾‘å¡è¿›æ‰€è°“çš„<strong>counterReducerå’ŒCounterAction</strong>ä¸­? å°±åƒæˆ‘ä»¬æœ‰ä¸€ä¸ªå«åš<strong>AppState</strong>çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯èƒ½åº”è¯¥æœ‰ä¸€ä¸ªå«åš<strong>AppAction</strong>çš„ä¸œè¥¿æ¥ä¿å­˜åº”ç”¨çš„æ‰€æœ‰åŠ¨ä½œã€‚</p>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸»<strong>AppAction</strong>æšä¸¾ï¼Œå®ƒå°†ä¿å­˜æ¯ä¸ªå±å¹•çš„æ‰€æœ‰åŠ¨ä½œ:</p>
<pre><code class="language-swift">enum AppAction {
  case decrTapped
  case incrTapped
  case saveFavoritePrimeTapped
  case removeFavoritePrimeTapped
}
</code></pre>
<p>ä½†æˆ‘ä»¬ç°åœ¨å¤±å»äº†ä¸€äº›æ¨¡å—åŒ–ã€‚ æˆ‘ä»¬å°†è®¡æ•°åŠ¨ä½œå’Œæ¨¡æ€åŠ¨ä½œæ†ç»‘åœ¨ä¸€èµ·ã€‚å°†æ¯ä¸€ç»„æ“ä½œä¿å­˜åœ¨å®ƒä»¬è‡ªå·±çš„æšä¸¾ä¸­å¯èƒ½ä¼šæ›´å¥½ï¼Œ<strong>AppAction</strong>åªæ˜¯åœ¨å…¶ä¸­åµŒå¥—æ¯ä¸ªå­æ“ä½œã€‚</p>
<pre><code class="language-swift">enum CounterAction {
  case decrTapped
  case incrTapped
}
enum PrimeModalAction {
  case saveFavoritePrimeTapped
  case removeFavoritePrimeTapped
}
enum AppAction {
  case counter(CounterAction)
  case primeModal(PrimeModalAction)
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬çš„<strong>reducer</strong>å¯ä»¥æ˜¯ä¸€ä¸ª<strong>appReducer</strong>ï¼Œé€šè¿‡å¯¹æ¯ä¸ªåµŒå¥—æ“ä½œè¿›è¡Œåˆ‡æ¢æ¥å¤„ç†è¿™ä¸ªå®Œæ•´çš„æ“ä½œé›†:</p>
<pre><code class="language-swift">func appReducer(value: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    value.count -= 1
  case .counter(.incrTapped):
    value.count += 1
  case .primeModal(.saveFavoritePrimeTapped):
    fatalError()
  case .primeModal(.removeFavoritePrimeTapped):
    fatalError()
  }
}
</code></pre>
<p>æˆ‘ä»¬ä»ç„¶éœ€è¦å¡«è¡¥è¿™äº›ç©ºç™½ï¼Œä½†è®©æˆ‘ä»¬é¦–å…ˆä¿®å¤ä¸€äº›ç¼–è¯‘å™¨é”™è¯¯ã€‚å½“å‘å•†åº—å‘é€è®¡æ•°å™¨å±å¹•çš„åŠ¨ä½œæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å°†åŠ¨ä½œåŒ…è£…åœ¨æ–°çš„åº”ç”¨åŠ¨ä½œæ¡ˆä¾‹ä¸­:</p>
<pre><code class="language-swift">Button(&quot;-&quot;) { self.store.send(.counter(.decrTapped)) }
Text(&quot;\(self.store.value.count)&quot;)
Button(&quot;+&quot;) { self.store.send(.counter(.incrTapped)) }
</code></pre>
<p>ç°åœ¨ï¼Œäº‹æƒ…æ­£åœ¨ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å°†æˆ‘ä»¬çš„çªå˜é€»è¾‘ç§»å‡ºè§†å›¾ï¼Œè¿›å…¥<strong>reducer</strong>:</p>
<pre><code class="language-swift">case .primeModal(.saveFavoritePrimeTapped):
  value.favoritePrimes.append(value.count)
  value.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(value.count)))

case .primeModal(.removeFavoritePrimeTapped):
  value.favoritePrimes.removeAll(where: { $0 == value.count })
  value.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(value.count)))
</code></pre>
<p>ç„¶åæˆ‘ä»¬çš„æŒ‰é’®åŠ¨ä½œå¯ä»¥ç®€å•åœ°å°†ç›¸åº”çš„åŠ¨ä½œå‘é€åˆ°<strong>store</strong>:</p>
<pre><code class="language-swift">Button(&quot;Remove from favorite primes&quot;) {
  self.store.send(.primeModal(.removeFavoritePrimeTapped))
}
â€¦
Button(&quot;Save to favorite primes&quot;) {
  self.store.send(.primeModal(.saveFavoritePrimeTapped))
}
</code></pre>
<p>ä¸€åˆ‡éƒ½åƒä»¥å‰ä¸€æ ·åœ¨ç¼–è¯‘å’Œå·¥ä½œã€‚é™¤äº†éœ€è¦é‡æ–°å‘½åå’Œç§»åŠ¨ä¸€äº›å†…å®¹ä¹‹å¤–ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°†çªå˜å†…å®¹æå–åˆ°æˆ‘ä»¬çš„<strong>store</strong>ä¸­ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§å˜å¼‚å¾ˆå®¹æ˜“æå–å‡ºæ¥ã€‚åœ¨<strong>FavoritePrimesView</strong>ä¸­ï¼Œæˆ‘ä»¬åœ¨<strong>onDelete</strong>å¤„ç†ç¨‹åºä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<pre><code class="language-swift">.onDelete { indexSet in
  for index in indexSet {
    self.store.value.favoritePrimes.remove(at: index)
    self.store.value.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(prime)))
  }
}
</code></pre>
<p>è®©æˆ‘ä»¬éµå¾ªå‰é¢ä¸¤ç»„çªå˜æ‰€ä½¿ç”¨çš„æ¨¡å¼ã€‚è¿™æ˜¯ä¸€ä¸ªæ–°çš„å±å¹•ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å±å¹•ä¸€ä¸ªæ–°çš„enumå¹¶æ·»åŠ ä¸€ä¸ªcaseåˆ°AppAction:</p>
<pre><code class="language-swift">enum FavoritePrimesAction {
  case deleteFavoritePrimes(IndexSet)
}
enum AppAction {
  â€¦
  case favoritePrimes(FavoritePrimesAction)
}
</code></pre>
<p>æˆ‘ä»¬ç«‹å³åœ¨<strong>reducer</strong>ä¸­å¾—åˆ°ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜:</p>
<pre><code class="language-swift">func appReducer(value: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  â€¦
  case let .favoritePrimes(.deleteFavoritePrimes(indexSet)):
    for index in indexSet {
      let prime = value.favoritePrimes[index]
      value.favoritePrimes.remove(at: index)
      value.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(prime)))
    }
  }
}
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬åœ¨è§†å›¾ä¸­ä½¿ç”¨å†…è”çªå˜ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºç®€å•åœ°å°†æ“ä½œå‘é€åˆ°<strong>store</strong>çš„ä»£ç :</p>
<pre><code class="language-swift">.onDelete { indexSet in
  self.store.send(.favoritePrimes(.removeFavoritePrimes(at: indexSet)))
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å°†æ‰€æœ‰çš„å†…è”çªå˜ä»æŒ‰é’®æ“ä½œè½¬ç§»åˆ°æˆ‘ä»¬çš„<strong>reducer</strong>ä¸­ï¼Œä¸€åˆ‡ä»ç„¶åƒä»¥å‰ä¸€æ ·å·¥ä½œã€‚</p>
<p>è™½ç„¶æˆ‘ä»¬å·²ç»å°†å¾ˆå¤šçªå˜è½¬ç§»åˆ°<strong>reducer</strong>ä¸­ï¼Œä»è€Œæ¸…ç†äº†æˆ‘ä»¬çš„viewï¼Œä½†ä»ç„¶æœ‰ä¸€äº›çªå˜åœ¨viewä¸­å‘ç”Ÿã€‚</p>
<p>è¿™äº›æ˜¯æˆ‘ä»¬å†³å®šä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€çº§åˆ«ä¸Šè·Ÿè¸ªçš„æ‰€æœ‰å±€éƒ¨çªå˜ã€‚å›æƒ³ä¸€ä¸‹ï¼ŒSwiftUIä¸­çš„æœ¬åœ°çŠ¶æ€æ˜¯ç”¨@<strong>State</strong>å»ºæ¨¡çš„ï¼Œè€Œ<strong>CounterView</strong>æœ‰3ä¸ªæœ¬åœ°çŠ¶æ€å®ä¾‹:</p>
<pre><code class="language-swift">@State var isPrimeModalShown = false
@State var alertNthPrime: Int?
@State var isNthPrimeButtonDisabled = false
</code></pre>
<p>æœ‰ä¸€äº›åœ°æ–¹è¿™äº›å€¼æ˜¯çªå˜çš„ï¼Œå®ƒæ˜¯å®Œå…¨åœ¨æˆ‘ä»¬çš„<strong>reducer</strong>æƒé™ä¹‹å¤–åšçš„ã€‚è¿™æ˜¯ä¸å¹¸çš„ï¼Œå› ä¸ºå°†æˆ‘ä»¬æ‰€æœ‰çš„çªå˜ç»Ÿä¸€åˆ°ä¸€ä¸ªå†…èšçš„åŒ…ä¸­æ˜¯å¾ˆå¥½çš„ï¼Œä½†æ˜¯å¤„ç†<strong>alertå’Œmodal</strong>æœ‰ç‚¹å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨äº†è§£äº†<strong>reducers</strong>çš„åŸºç¡€çŸ¥è¯†åè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="8-a-nametillnexttimeatill-next-time">8. <a name='Tillnexttime'></a>Till next time</h2>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†ä¸€ä¸ªéå¸¸åŸºæœ¬çš„æ¶æ„ç‰ˆæœ¬ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ª<strong>store</strong>ç±»ï¼Œå®ƒæ˜¯çŠ¶æ€ç±»å‹çš„æ³›å‹ï¼Œè¡¨ç¤ºåº”ç”¨ç¨‹åºçš„å®Œæ•´çŠ¶æ€ï¼Œå®ƒæ˜¯æ“ä½œç±»å‹çš„æ³›å‹ï¼Œè¡¨ç¤ºåº”ç”¨ç¨‹åºä¸­å¯èƒ½å‘ç”Ÿçš„æ‰€æœ‰ç”¨æˆ·æ“ä½œã€‚</p>
<ul>
<li><strong>store</strong>ç±»åŒ…è£…äº†ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„å€¼ç±»å‹ï¼Œè¿™å…è®¸æˆ‘ä»¬ä¸€æ¬¡æ€§åœ°æŒ‚é’©åˆ°è§‚å¯Ÿè€…ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨çŠ¶æ€å³å°†å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥SwiftUIã€‚</li>
<li><strong>store</strong>ç±»è¿˜ä¿ç•™äº†ä¸€ä¸ª<strong>reducer</strong>ï¼Œå®ƒæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å¤§è„‘ã€‚ å®ƒæè¿°äº†å¦‚ä½•è·å–åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€å’Œæ¥è‡ªç”¨æˆ·çš„ä¼ å…¥æ“ä½œï¼Œå¹¶ç”Ÿæˆåº”ç”¨ç¨‹åºçš„å…¨æ–°çŠ¶æ€ï¼Œç„¶åå°†å…¶å‘ˆç°å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚</li>
</ul>
<p>è¿™ä¸ªå°å°çš„å·¥ä½œå·²ç»è§£å†³äº†æˆ‘ä»¬åœ¨æœ¬é›†å¼€å§‹æ—¶æåˆ°çš„5ä¸ªé—®é¢˜ä¸­çš„2ä¸ªã€‚</p>
<p>ä½†æ˜¯ï¼Œå°½ç®¡è¿™ä¸€åˆ‡éƒ½å¾ˆé…·ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥èµ°å¾—æ›´è¿œã€‚è®©æˆ‘ä»¬æ¥è§£å†³åœ¨<strong>appReducer</strong>ä¸­å¼€å§‹å‘å±•çš„é—®é¢˜ã€‚ç°åœ¨å®ƒçœ‹èµ·æ¥ç›¸å½“åºå¤§:ä¸€ä¸ªå·¨å¤§çš„<strong>reducer</strong>å¤„ç†3ä¸ªä¸åŒå±å¹•çš„çªå˜ã€‚è¿™ä¼¼ä¹ä¸æ˜¯ç‰¹åˆ«å…·æœ‰å¯æ‰©å±•æ€§ã€‚å¦‚æœæˆ‘ä»¬æœ‰24ä¸ªå±å¹•æˆ‘ä»¬çœŸçš„éœ€è¦ä¸€ä¸ªå¼€å…³è¯­å¥æ¥åˆ‡æ¢24ä¸ªä¸åŒå±å¹•çš„æ¯ä¸ªåŠ¨ä½œå—? Thatâ€™s not going to work.</p>
<p>æˆ‘ä»¬éœ€è¦ç ”ç©¶å°†<strong>reducer</strong>åˆæˆæˆæ›´å¤§çš„<strong>reducer</strong>çš„æ–¹æ³•ã€‚å¦‚ä½•å°†ä¸€ä¸ªå¤§çš„<strong>reducer</strong>åˆ†è§£æˆè®¸å¤šå°çš„åªåšä¸€ä»¶ç‰¹å®šäº‹æƒ…çš„<strong>reducer</strong>ç„¶åå°†å®ƒä»¬ç²˜åœ¨ä¸€èµ·å½¢æˆæˆ‘ä»¬çš„ä¸»<strong>reducer</strong>?</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="http://localhost:4000/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="http://localhost:4000/post/pointfree-episode-67-swiftui-and-state-management-part-3/">
                  <h3 class="post-title">
                    PointFree Episode 67: SwiftUI and State Management: Part 3
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
