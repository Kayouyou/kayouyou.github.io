<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 83:Testable State Management: Effects | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1663232760640">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Recap: the environment




Controlling the favorite primes save effect




Controlling the favorite primes load effe..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1663232760640" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 83:Testable State Management: Effects</h2>
            <div class="post-date">2021-11-28</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Recap:theenvironment">Recap: the environment</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Controllingthefavoriteprimessaveeffect">Controlling the favorite primes save effect</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Controllingthefavoriteprimesloadeffect">Controlling the favorite primes load effect</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Testingthefavoriteprimessaveeffect">Testing the favorite primes save effect</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Testingthefavoriteprimesloadeffect">Testing the favorite primes load effect</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Controllingthecountereffect">Controlling the counter effect</a></li>
</ol>
</li>
<li>
<ol start="7">
<li><a href="#Testingthecountereffects">Testing the counter effects</a></li>
</ol>
</li>
<li>
<ol start="8">
<li><a href="#Nexttime:testergonomics">Next time: test ergonomics</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 83:Testable State Management: Effects -->
<h2 id="1-a-namerecaptheenvironmentarecap-the-environment">1. <a name='Recap:theenvironment'></a>Recap: the environment</h2>
<p>ç®€è€Œè¨€ä¹‹ï¼Œ<strong>environment</strong>å…è®¸æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä¾èµ–é¡¹ä¸å¯å˜å­—æ®µæ†ç»‘åœ¨ä¸€ä¸ªå•ä¸€çš„æ•°æ®ç±»å‹ä¸­ï¼Œè¿™ä½¿å¾—å°†<strong>mock</strong>å®ç°è½¬æ¢ä¸º<strong>live</strong>å®ç°éå¸¸å®¹æ˜“ï¼Œåä¹‹äº¦ç„¶ã€‚è¿™è®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä»£ç ä¸­æµ‹è¯•æ‰€æœ‰çš„è¾¹ç¼˜æƒ…å†µå’Œä¸æ„‰å¿«çš„è·¯å¾„ï¼Œè¿™ä¸ä»…å¯¹äºç¼–å†™æµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œè€Œä¸”å¯¹äºåœ¨<strong>playgrounds</strong>ä¸­è¿è¡Œä»£ç ä¹Ÿéå¸¸æœ‰ç”¨ã€‚</p>
<p>æˆ‘ä»¬å°†å°è¯•<strong>environment</strong>ç†å¿µæ¥æ§åˆ¶åº”ç”¨ç¨‹åºä¸­çš„å‰¯ä½œç”¨ã€‚æˆ‘ä»¬å°†ä»æ”¶è—ç´ æ•°å±å¹•å¼€å§‹ï¼Œå®ƒå…·æœ‰æœ€ç®€å•çš„ä¿å­˜å’ŒåŠ è½½æ”¶è—ç´ æ•°çš„<strong>effects</strong>ã€‚æˆ‘ä»¬å°†å¼•å…¥ä¸€ä¸ª<strong>environment</strong>ç»“æ„ä½“ï¼Œå®ƒæœ€ç»ˆå°†åŒ…å«æˆ‘ä»¬è¿™ä¸ªæ¨¡å—æ‰€éœ€çš„æ‰€æœ‰å‰¯ä½œç”¨ä¾èµ–é¡¹:</p>
<pre><code class="language-swift">struct Environment {
}
</code></pre>
<p>ä¸ºäº†è®©æˆ‘ä»¬å›å¿†ä¸€ä¸‹å¦‚ä½•å°†ä¾èµ–é¡¹æ·»åŠ åˆ°è¿™ä¸ª<strong>environment</strong>ä¸­ï¼Œå‡è®¾è¿™ä¸ªæ¨¡å—éœ€è¦è®¿é—®å½“å‰æ—¥æœŸã€‚è¿™è‚¯å®šæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨ï¼Œå› ä¸ºæ¯æ¬¡åˆ›å»ºæ—¥æœŸæ—¶æ—¶é—´éƒ½ä¼šæ”¹å˜ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸å…è®¸è‡ªå·±ç›´æ¥ä»ä»£ç ä¸­è°ƒç”¨æ—¥æœŸåˆå§‹åŒ–å™¨ï¼Œè€Œæ˜¯å°†å®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„<strong>environment</strong>ä¸­:</p>
<pre><code class="language-swift">struct Environment {
  var date: () -&gt; Date
}
</code></pre>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨è¿™äº›ä¾èµ–é¡¹çš„é»˜è®¤å®æ—¶å®ç°æ¥æ‰©å±•ç¯å¢ƒã€‚</p>
<pre><code class="language-swift">extension Environment {
  static let live = Environment(
    date: Date.init
  )
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬åœ¨æ¨¡å—ä¸­æœ‰ä¸€ä¸ªå…¨å±€<strong>environment</strong>ï¼Œæ‰€ä»¥ä»»ä½•æ—¶å€™æˆ‘ä»¬æƒ³è¦è®¿é—®æ—¥æœŸï¼Œæˆ‘ä»¬åªè®¿é—®å½“å‰<strong>environment</strong>ä¸­çš„æ—¥æœŸ:</p>
<pre><code class="language-swift">var Current = Environment()
</code></pre>
<p>è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬æƒ³è¦è·å¾—ä¸€ä¸ªæ—¥æœŸå€¼æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å¼ºåˆ¶è‡ªå·±é€šè¿‡<strong>Current environment</strong>ï¼Œè€Œä¸æ˜¯å…è®¸è‡ªå·±æ¥è§¦åˆ°ä¸å—æ§åˆ¶çš„æ—¥æœŸåˆå§‹åŒ–å™¨ã€‚</p>
<pre><code class="language-swift">Current.date()
</code></pre>
<p>å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¯å˜å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ä¸€ç§æ›´å¯æ§çš„æ–¹å¼äº¤æ¢æˆ‘ä»¬çš„å®ç°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<strong>mock</strong>ç‰ˆæœ¬çš„ç¯å¢ƒï¼Œå…¶ä¸­åªæœ‰dateå‡½æ•°æ€»æ˜¯è¿”å›ç›¸åŒçš„æ—¥æœŸ:</p>
<pre><code class="language-swift">extension Environment {
  static let mock = Environment(
    date: { Date(timeIntervalSince1970: 1234567890) }
  )
}
</code></pre>
<p>ç„¶ååœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°†ç”¨<strong>mock</strong>ç¯å¢ƒæ¥æ›¿æ¢æˆ‘ä»¬çš„<strong>live</strong>ç¯å¢ƒ:</p>
<pre><code class="language-swift">Current = .mock
</code></pre>
<p>è¿™å…è®¸æˆ‘ä»¬åœ¨éœ€è¦çš„æ—¶å€™ä»¥ä¸€ç§è½»é‡çº§çš„æ–¹å¼æ§åˆ¶è¿™ç§ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚åœ¨<strong>tests</strong>å’Œ<strong>playgrounds</strong>ä¸Šï¼Œè€Œç”Ÿäº§åº”ç”¨ç¨‹åºå°†ä½¿ç”¨è¿™äº›ä¾èµ–å…³ç³»çš„<strong>live</strong>ç‰ˆæœ¬ã€‚</p>
<p>æ—¥æœŸä¾èµ–éå¸¸ç®€å•ï¼Œä½†åœ¨<a href="https://www.pointfree.co/episodes/ep16-dependency-injection-made-easy">ä¾èµ–æ³¨å…¥</a>é‚£ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬è¿˜å±•ç¤ºäº†ä¸€ä¸ªæ›´å¤æ‚çš„ä¾èµ–:ä¸€ä¸ª<strong>GitHub API</strong>å®¢æˆ·ç«¯:</p>
<pre><code class="language-swift">struct GitHubClient {
  var fetchRepos: (@escaping (Result&lt;[Repo], Error&gt;) -&gt; Void) -&gt; Void

  struct Repo: Decodable {
    var archived: Bool
    var description: String?
    var htmlUrl: URL
    var name: String
    var pushedAt: Date?
  }
}
</code></pre>
<p>åŒæ ·ï¼Œå®ƒè¢«è¡¨ç¤ºä¸ºå¸¦æœ‰ä¸€äº›å¯å˜å­—æ®µçš„ç®€å•ç»“æ„ä½“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†å®ç°æ›¿æ¢ä¸º<strong>mock</strong>ã€‚</p>
<p>æˆ‘ä»¬å®Œå…¨ç†è§£è¿™äº›ä»£ç å¯èƒ½ä¼šè®©æˆ‘ä»¬çš„ä¸€äº›è§‚ä¼—æ„Ÿåˆ°ä¸èˆ’æœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦å¤§å†™çš„å˜é‡ã€‚å¦ä¸€æ–¹é¢æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯å˜çš„å…¨å±€å˜é‡ã€‚ç„¶è€Œï¼Œè¿™äº›ä¾èµ–é¡¹åªèƒ½åœ¨<strong>playgrounds and tests</strong>ä¸­äº¤æ¢ã€‚åœ¨ç”Ÿäº§åº”ç”¨ç¨‹åºä¸­ï¼Œä¾èµ–é¡¹åº”è¯¥åœ¨ç¯å¢ƒä¸­åˆ›å»ºï¼Œç„¶åä¸å—å½±å“ã€‚æ‚¨ç”šè‡³å¯ä»¥åˆ›å»º<strong>lint</strong>è§„åˆ™ï¼Œä»¥ç¡®ä¿ä¸ä¼šåœ¨<strong>playground or test</strong>ä¹‹å¤–ä¿®æ”¹ç¯å¢ƒã€‚æ‚¨è¿˜å¯ä»¥åˆ©ç”¨<strong>Environment</strong>æ˜¯ä¸€ç§å€¼ç±»å‹è¿™ä¸€äº‹å®ï¼Œå¹¶å¼ºåˆ¶å®ƒåœ¨ç”Ÿäº§ä¸­å®Œå…¨ä¸å¯å˜:</p>
<pre><code class="language-swift">#if DEBUG
var Current = Environment()
#else
let Current = Environment()
#endif
</code></pre>
<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯<strong>environment</strong>!</p>
<ul>
<li>ä½ åˆ›å»ºä¸€ä¸ªåä¸º<strong>Environment</strong>çš„ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«ä¸€å †æè¿°åº”ç”¨ç¨‹åºä¾èµ–å…³ç³»çš„å¯å˜å­—æ®µã€‚</li>
<li>æ‚¨åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘æ‰€æœ‰ä¾èµ–é¡¹çš„<strong>live</strong>ç‰ˆæœ¬çš„<strong>live</strong>ç‰ˆæœ¬ã€‚</li>
<li>æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª<strong>mock</strong>ç‰ˆæœ¬ï¼Œä½¿ç”¨ç®€å•çš„ã€å—æ§åˆ¶çš„é»˜è®¤å€¼å°†è¿™äº›ä¸åŒçš„ç«¯ç‚¹å­˜æ ¹å‡ºæ¥ã€‚</li>
<li>ç„¶ååœ¨æ‚¨çš„<strong>tests and playgrounds</strong>ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<strong>mock</strong>ç‰ˆæœ¬å¹¶è¿›ä¸€æ­¥äº¤æ¢å…¶ä»–<strong>mock</strong>åœºæ™¯ï¼Œè€Œåœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨å°†ä½¿ç”¨<strong>live</strong>ç‰ˆæœ¬ã€‚</li>
</ul>
<p>å¦‚æœæ‚¨ä»ç„¶å¯¹æ­¤æ„Ÿåˆ°ä¸èˆ’æœï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨è§‚çœ‹å…³äºè¿™ä¸ªä¸»é¢˜çš„ç¬¬16é›†ï¼Œå¸Œæœ›æˆ‘ä»¬èƒ½è®©æ‚¨ç›¸ä¿¡è¿™ç§ç±»å‹çš„ä¾èµ–é¡¹ç®¡ç†æœ‰å¾ˆå¤šå¥½å¤„ï¼Œå¹¶æå¤§åœ°é™ä½äº†ç°æœ‰è§£å†³æ–¹æ¡ˆçš„æ ·æ¿å’Œå¤æ‚æ€§ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å°è¯•<strong>live</strong>ç¯å¢ƒæ¥æ§åˆ¶åº”ç”¨ç¨‹åºçš„<strong>effects</strong>ã€‚</p>
<h2 id="2-a-namecontrollingthefavoriteprimessaveeffectacontrolling-the-favorite-primes-save-effect">2. <a name='Controllingthefavoriteprimessaveeffect'></a>Controlling the favorite primes save effect</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»è®°ä½äº†<strong>environment</strong>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<strong>environment</strong>æ¥æ§åˆ¶è¿™ä¸ªæ¨¡å—ä¸­çš„ä¿å­˜å’ŒåŠ è½½æ•ˆæœã€‚å®ƒä»¬ç›®å‰æ˜¯å°çš„ç§æœ‰åŠ©æ‰‹ï¼Œå°†æœ‰æ•ˆé€»è¾‘åŒ…è£…åœ¨<strong>Effect</strong>ç±»å‹ä¸­:</p>
<pre><code class="language-swift">private func saveEffect(favoritePrimes: [Int]) -&gt; Effect&lt;FavoritePrimesAction&gt; {
  return .fireAndForget {
    let data = try! JSONEncoder().encode(favoritePrimes)
    let documentsPath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]
    let documentsUrl = URL(fileURLWithPath: documentsPath)
    let favoritePrimesUrl = documentsUrl.appendingPathComponent(&quot;favorite-primes.json&quot;)
    try! data.write(to: favoritePrimesUrl)
  }
}

private let loadEffect = Effect&lt;FavoritePrimesAction&gt;.sync {
  let documentsPath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]
  let documentsUrl = URL(fileURLWithPath: documentsPath)
  let favoritePrimesUrl = documentsUrl.appendingPathComponent(&quot;favorite-primes.json&quot;)
  guard
    let data = try? Data(contentsOf: favoritePrimesUrl),
    let favoritePrimes = try? JSONDecoder().decode([Int].self, from: data)
    else { return nil }
  return .loadedFavoritePrimes(favoritePrimes)
}
.eraseToEffect()
</code></pre>
<p>è¿™äº›<strong>effects</strong>çš„<strong>live</strong>å®ç°ä¼šä»<strong>reducer</strong>è¿”å›:</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [saveEffect(favoritePrimes: state)]

case .loadButtonTapped:
  return [loadEffect]
</code></pre>
<p>æˆ‘ä»¬æƒ³è¦åœ¨ä¸€ä¸ªå¯ä»¥æ”¾åˆ°ç¯å¢ƒä¸­çš„ä¾èµ–é¡¹ä¸­æ•æ‰è¿™äº›<strong>effects</strong>ã€‚è®©æˆ‘ä»¬ä¸ºå–œçˆ±çš„ç´ æ•°æ¨¡å—å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„<strong>environment</strong>ã€‚</p>
<pre><code class="language-swift">struct FavoritePrimesEnvironment {

}
</code></pre>
<p>è¿™é‡Œæ˜¯ä»€ä¹ˆ? æˆ‘ä»¬å¯ä»¥å°†<strong>saveå’Œload</strong>æ•ˆæœçš„å­—æ®µç›´æ¥æ·»åŠ åˆ°è¿™ä¸ªç»“æ„ä½“ä¸­ï¼Œä½†å› ä¸ºå®ƒä»¬æ˜¯ç›¸å…³çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»<strong>GitHubClient</strong>ä¸­è·å¾—ä¸€äº›çµæ„Ÿï¼Œåˆ›å»ºä¸€ä¸ª<strong>FileClient</strong>æ¥ä¿å­˜ä¿å­˜å’ŒåŠ è½½çš„<strong>effects</strong>:</p>
<pre><code class="language-swift">struct FileClient {
}
</code></pre>
<p>æ¯ä¸ª<strong>effect</strong>éƒ½æ˜¯è¿™ä¸ªç»“æ„ä½“ä¸­çš„ä¸€ä¸ªå­—æ®µ:</p>
<pre><code class="language-swift">struct FileClient {
//  var load:
//  var save:
}
</code></pre>
<p>è®©æˆ‘ä»¬ä»<strong>load effect</strong>å¼€å§‹ã€‚åœ¨å®ƒçš„æ ¸å¿ƒï¼Œæ‰€æœ‰çš„åŠ è½½éƒ½æ¶‰åŠåˆ°ç”Ÿæˆä¸€ä¸ªè¡¨ç¤ºæœ€å–œæ¬¢çš„è´¨æ•°çš„æ•´æ•°æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šå°è¯•åšä»¥ä¸‹äº‹æƒ…:</p>
<pre><code class="language-swift">struct FileClient {
  var load: () -&gt; [Int]?
//  var save:
}
</code></pre>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜:</p>
<ul>
<li>é¦–å…ˆï¼Œç±»å‹æ²¡æœ‰ç»™å‡ºä»»ä½•ä¼šå‘ç”Ÿå½±å“çš„è¿¹è±¡ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬çŸ¥é“å®ƒå°†è®¿é—®ç£ç›˜ä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨ç±»å‹è¡¨ç¤ºã€‚</li>
<li>å…¶æ¬¡ï¼Œè¿™ç§<strong>effect</strong>éå¸¸ç‰¹å®šäºæˆ‘ä»¬çš„ä¸€ä¸ªç”¨ä¾‹ï¼Œå³ä»åä¸º<strong>favorite-prime .json</strong>çš„æ–‡ä»¶ä¸­åŠ è½½ä¸€ä¸ªæ•´æ•°æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥é€šç”¨åŒ–ï¼Œä¼ å…¥ä¸€ä¸ªæ–‡ä»¶åï¼Œç„¶åå¾—åˆ°<strong>Data</strong>ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥è‡ªå·±è§£ç <strong>JSON</strong>ã€‚</li>
</ul>
<p>è§£å†³è¿™äº›é—®é¢˜å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬å¯ä»¥é¦–å…ˆä¸ºæ–‡ä»¶åå¼•å…¥ä¸€ä¸ª<strong>String</strong>å‚æ•°ï¼Œç„¶åæ³›åŒ–å¯é€‰æ•°æ®è¿”å›çš„å¯é€‰æ•´æ•°æ•°ç»„ã€‚</p>
<pre><code class="language-swift">struct FileClient {
  var load: (String) -&gt; Effect&lt;Data?&gt;
//  var save:
}
</code></pre>
<p>å¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼å¤„ç†<strong>save</strong>å­—æ®µï¼Œä½†å®ƒå¯ä»¥æ¥å—è¦ä¿å­˜çš„æ–‡ä»¶çš„åç§°ä»¥åŠéœ€è¦ä¿å­˜çš„æ•°æ®ã€‚å®ƒè¿˜éœ€è¦è¿”å›ä¸€ä¸ª<strong>effect</strong>ï¼Œä½†è¿˜ä¸æ¸…æ¥šä»€ä¹ˆ<strong>effect</strong>åº”è¯¥æ˜¯é€šç”¨çš„:</p>
<pre><code class="language-swift">var save: (String, Data) -&gt; Effect&lt;???&gt;
</code></pre>
<p>è®°ä½ï¼Œè¿™æ˜¯ä¸€ç§â€œ<strong>fire-and-forget</strong>â€çš„<strong>effect</strong>ã€‚å®ƒåªéœ€è¦å°†ä¸€äº›æ•°æ®ä¿å­˜åˆ°ç£ç›˜ï¼Œè€Œä¸éœ€è¦å°†ä»»ä½•æ•°æ®å‘é€å›ç³»ç»Ÿã€‚æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶äº‹æ˜¯å°†<strong>FavoritePrimesAction</strong>ç¡¬ç¼–ç æˆè¿™æ ·çš„<strong>effect</strong>:</p>
<pre><code class="language-swift">var save: (String, Data) -&gt; Effect&lt;FavoritePrimesAction&gt;
</code></pre>
<p>ç„¶è€Œï¼Œè¿™ä¸å¿…è¦åœ°å°†è¿™ä¸ªæ–‡ä»¶å®¢æˆ·ç«¯ç›´æ¥è€¦åˆåˆ°è¿™ä¸ªæ¨¡å—ã€‚å®ƒé˜»æ­¢æˆ‘ä»¬åœ¨æŸä¸€å¤©å°†è¿™ä¸ªå®¢æˆ·ç«¯æå–åˆ°å®ƒè‡ªå·±çš„æ¨¡å—ä¸­ï¼Œå¹¶åœ¨å…¶ä»–å±å¹•æˆ–åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼Œè€Œè¿™äº›å±å¹•æˆ–åº”ç”¨ç¨‹åºå¹¶ä¸å…³å¿ƒè¿™ä¸ªæœ€å–œæ¬¢çš„primeå±å¹•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿<strong>FileClient</strong>æ³›å‹æ¥ä»<strong>FileClient</strong>ä¸­è§£è€¦<strong>effect</strong>çš„ç±»å‹ã€‚è¿™å°†å…è®¸ä»»ä½•äººä½¿ç”¨æ–‡ä»¶å®¢æˆ·ç«¯è‡ªå¸¦è‡ªå·±çš„ç±»å‹:</p>
<pre><code class="language-swift">struct FileClient&lt;Action&gt; {
  // â€¦
  var save: (String, Data) -&gt; Effect&lt;A&gt;
}
</code></pre>
<p>ä½†è¿™ä¼¼ä¹å¾ˆé‡è¦ï¼Œæˆ‘ä»¬ç”šè‡³ä¸æƒ³è®©<strong>save effect</strong>èƒ½å¤Ÿäº§ç”Ÿåé¦ˆåˆ°ç³»ç»Ÿçš„åŠ¨ä½œã€‚</p>
<p>æˆ‘ä»¬ç”šè‡³å¯èƒ½ä¼šå°è¯•ä½¿ç”¨<strong>Void</strong>ä½œä¸ºæ•ˆæœçš„ç±»å‹ï¼Œå› ä¸ºå®ƒä»£è¡¨äº†ä¸€æ®µæ²¡æœ‰è¯­ä¹‰æˆ–æ„ä¹‰çš„æ•°æ®:</p>
<pre><code class="language-swift">struct FileClient {
  // â€¦
  var save: (String, Data) -&gt; Effect&lt;Void&gt;
}
</code></pre>
<p>è¿™ä»ç„¶æ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºè¿™å°†å…è®¸<strong>save effect</strong>å‘é€ä¸€ä¸ªç©ºå€¼å›ç³»ç»Ÿã€‚</p>
<p>æˆ‘ä»¬æ­£åœ¨æ¢ç´¢çš„æ‰€æœ‰è¿™äº›é”™è¯¯çš„å¼€å§‹éƒ½æŒ‡å‘äº†ä¸€äº›éå¸¸é‡è¦çš„ä¸œè¥¿ã€‚æˆ‘ä»¬æƒ³åœ¨è¿™ç§<strong>effect</strong>çš„ç±»å‹ä¸­è¡¨ç°ä¸€äº›éå¸¸å…·ä½“çš„ä¸œè¥¿ã€‚æˆ‘ä»¬æƒ³è¦ä¸€ç§<strong>effect</strong>ï¼Œå®ƒèƒ½æ­£å¸¸å·¥ä½œï¼Œä½†ä¸èƒ½äº§ç”Ÿå€¼ã€‚å®ƒåº”è¯¥æ²¡æœ‰èƒ½åŠ›å°†æ“ä½œå‘é€å›<strong>store</strong>ã€‚</p>
<p>æœ‰ä¸€ç§ç±»å‹å¯ä»¥è®©æˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹:<strong>Never</strong>ã€‚</p>
<pre><code class="language-swift">var save: (String, Data) -&gt; Effect&lt;Never&gt;
</code></pre>
<p>ä»ä¸æ˜¯æ‰€è°“çš„â€œæ— äººå±…ä½â€ç±»å‹ã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨Swiftæ ‡å‡†åº“ä¸­å®šä¹‰çš„<strong>zero cases</strong>çš„<strong>enum</strong>ï¼Œã€‚</p>
<pre><code class="language-swift">public enum Never {
}
</code></pre>
<p>æ„é€ <strong>Never</strong>ç±»å‹çš„å€¼æ˜¯ä¸å¯èƒ½çš„ã€‚ å› ä¸ºä¸å¯èƒ½æ„é€ ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥è¿™ä¸ª<strong>effect</strong>å‘å¸ƒè€…ä¹Ÿä¸å¯èƒ½äº§ç”Ÿä¸€ä¸ª<strong>Never</strong>ç±»å‹çš„æ’æ”¾ã€‚è¿™æ˜¯å¯¹æˆ‘ä»¬æƒ³è¦æ­¤<strong>effect</strong>æ»¡è¶³çš„å±æ€§çš„ç¼–è¯‘æ—¶éªŒè¯ã€‚</p>
<p>è¿™ä¹Ÿä¸ºæˆ‘ä»¬çš„apiæä¾›äº†éå¸¸å¥½çš„æ–‡æ¡£ã€‚å¦‚æœæ‚¨æ›¾ç»é‡åˆ°è¿‡**Effect<Never>**ç±»å‹ï¼Œæ‚¨ç”šè‡³ä¸ç”¨æŸ¥çœ‹å®ç°å°±çŸ¥é“å®ƒæ°¸è¿œä¸ä¼šäº§ç”Ÿå€¼ï¼Œå› æ­¤å®ƒä¸€å®šæ˜¯ä¸€ç§â€œ<strong>fire-and-forget</strong>â€<strong>effect</strong>ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å°†ä¾èµ–é¡¹æè¿°ä¸ºä¸€ä¸ªç®€å•çš„æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå®ƒçš„æ´»åŠ¨ç‰ˆæœ¬ç”¨äºç”Ÿäº§ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒå®šä¹‰ä¸º<strong>FileClient</strong>ç±»å‹çš„é™æ€å˜é‡:</p>
<pre><code class="language-swift">extension FileClient {
  static let live = Self(
    load: &lt;#(String) -&gt; Effect&lt;Data?&gt;#&gt;,
    save: &lt;#(String, Data) -&gt; Effect&lt;Never&gt;#&gt;
  )
}
</code></pre>
<p>æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥å°†å½“å‰çš„<strong>effect</strong>å¤åˆ¶ç²˜è´´åˆ°è¿™äº›é—­åŒ…ä¸­ï¼Œåªåšæœ€å°çš„æ›´æ”¹:</p>
<pre><code class="language-swift">extension FileClient {
  static let live = Self(
    load: { fileName in
      .sync {
        let documentsPath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]
        let documentsUrl = URL(fileURLWithPath: documentsPath)
        let favoritePrimesUrl = documentsUrl.appendingPathComponent(fileName)
        return try? Data(contentsOf: favoritePrimesUrl)
      }
  },
    save: { fileName, data in
      .fireAndForget {
        let documentsPath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]
        let documentsUrl = URL(fileURLWithPath: documentsPath)
        let favoritePrimesUrl = documentsUrl.appendingPathComponent(fileName)
        try! data.write(to: favoritePrimesUrl)
      }
  })
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªä¾èµ–æ·»åŠ åˆ°æˆ‘ä»¬çš„<strong>environment</strong>ä¸­:</p>
<pre><code class="language-swift">struct FavoritePrimesEnvironment {
  var fileClient: FileClient
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç¯å¢ƒçš„<strong>live</strong>ç‰ˆæœ¬ï¼Œå®ƒä½¿ç”¨æ–‡ä»¶å®¢æˆ·ç«¯çš„<strong>live</strong>å®ç°:</p>
<pre><code class="language-swift">extension FavoritePrimesEnvironment {
  static let live = FavoritePrimesEnvironment(fileClient: .live)
}
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨å¤§å†™çš„<strong>Current</strong>å®ä¾‹åŒ–ç¯å¢ƒçš„ä¸€ä¸ª<strong>live</strong>å®ä¾‹:</p>
<pre><code class="language-swift">var Current = FavoritePrimesEnvironment.live
</code></pre>
<p>ç¯å¢ƒå°±ç»ªåï¼Œæˆ‘ä»¬åªéœ€è¦é‡æ„æˆ‘ä»¬çš„<strong>reducer</strong>ï¼Œä½¿å…¶ä¸å†ç›´æ¥æ„é€ å…¶<strong>effects</strong>ï¼Œè€Œåªä½¿ç”¨<strong>Current</strong>ç¯å¢ƒã€‚</p>
<p>è®©æˆ‘ä»¬ä»<strong>save effect</strong>å¼€å§‹:</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [saveEffect(favoritePrimes: state)]
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­ä½¿ç”¨æ–°çš„<strong>effect</strong>ï¼Œè€Œä¸æ˜¯è°ƒç”¨è¿™ä¸ªå±€éƒ¨çš„ç§æœ‰<strong>effect</strong>:</p>
<pre><code class="language-swift">Current.fileClient.save
</code></pre>
<p>æ–‡ä»¶åå’Œæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨çš„æ–‡ä»¶åæ˜¯ä¸€æ ·çš„</p>
<pre><code class="language-swift">Current.fileClient
  .save(&quot;favorite-primes.json&quot;, ???)
</code></pre>
<p>è¦ç»™å‡ºè¿™ä¸ªå‡½æ•°æ•°æ®ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨<strong>reducer</strong>ä¸­æ­£ç¡®åœ°æ‰§è¡ŒJSONç¼–ç ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åšæ³•ï¼Œå› ä¸ºJSONç¼–ç æ˜¯ä¸€ä¸ªçº¯æ“ä½œ:</p>
<pre><code class="language-swift">Current.fileClient.save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
</code></pre>
<p>ç°åœ¨è¿™ä¸ªè¿˜ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºå®ƒè¿”å›ä¸€ä¸ª<strong>Effect<Never></strong>ï¼Œä½†æˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ª<strong>Effect<FavoritePrimesAction></strong>ã€‚</p>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜Effectâ€™ to expected element type â€˜Effectâ€™</p>
</blockquote>
<p>æˆ‘ä»¬åˆšæ‰è®¨è®ºäº†è¿”å›<strong>Effect<Never><strong>æ¥è¡¨ç¤º</strong>fire-and-forget****effect</strong>æ˜¯å¦‚ä½•æ­£ç¡®çš„ï¼Œä½†ç°åœ¨å®ƒä¼¼ä¹ç»™æˆ‘ä»¬å¸¦æ¥äº†é—®é¢˜ã€‚ æˆ‘ä»¬ç©¶ç«Ÿå¦‚ä½•å°†<strong>Never</strong>å€¼è½¬æ¢ä¸º<strong>FavoritePrimesAction</strong>å€¼å‘¢?</p>
<p>å½“ç„¶ï¼Œè¿™æ˜¯å®Œå…¨å¯èƒ½çš„ï¼Œæˆ‘ä»¬åœ¨Point-Freeçš„ç¬¬9é›†è®¨è®ºSwiftçš„ç±»å‹ç³»ç»Ÿå’Œä»£æ•°ä¹‹é—´çš„å…³ç³»æ—¶è®¨è®ºè¿‡ã€‚ä½¿ç”¨ä»£æ•°ä½œä¸ºæˆ‘ä»¬çš„æŒ‡è·¯æ˜ç¯ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå‘ç°ä¸‹é¢çš„ç­¾åå®é™…ä¸Šæœ‰ä¸€ä¸ªå®ç°:</p>
<pre><code class="language-swift">// (Never) -&gt; A
</code></pre>
<p>We called it absurd, because it seems pretty absurd:</p>
<pre><code class="language-swift">func absurd&lt;A&gt;(_ never: Never) -&gt; A {
  switch never {}
}
</code></pre>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„<strong>switch</strong>å·²ç»è¯¦å°½åœ°å¤„ç†äº†<strong>Never</strong>ä¸­çš„æ¯ä¸ª<strong>case</strong>ï¼Œè¿™æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œå› ä¸º<strong>Never</strong>æ²¡æœ‰<strong>case</strong>ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬åœ¨æœ¬é›†çš„å®ç°ï¼Œä½†ä»é‚£ä»¥åSwiftå˜å¾—æ›´èªæ˜äº†ï¼Œæˆ‘ä»¬ç°åœ¨ç”šè‡³å¯ä»¥çœç•¥è¿™ä¸ªå‡½æ•°ä½“:</p>
<pre><code class="language-swift">func absurd&lt;A&gt;(_ never: Never) -&gt; A {}
</code></pre>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„å‡½æ•°ï¼Œå°†æˆ‘ä»¬çš„â€œ<strong>fire-and-forget effect</strong>â€ä»â€œ<strong>Nevers</strong>â€çš„ä¸–ç•Œæå‡åˆ°â€œ<strong>reducer</strong>â€è¡ŒåŠ¨çš„ä¸–ç•Œ:</p>
<pre><code class="language-swift">Current.fileClient.save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
  .map(absurd)
</code></pre>
<p>ç°åœ¨è¿™æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç¡®ä¿å°†<strong>publisher</strong>ç±»å‹æ“¦é™¤å›<strong>effect</strong>ç±»å‹</p>
<pre><code class="language-swift">Current.fileClient.save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
  .map(absurd)
  .eraseToEffect()
</code></pre>
<p>ç°åœ¨å¯ä»¥ç¼–è¯‘äº†ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥å°†è¿™ä¸ªå°å°çš„<strong>absurd dance</strong>æ†ç»‘åœ¨ä¸€ä¸ªè‡ªå®šä¹‰æ“ä½œç¬¦ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸ºå®ƒå–ä¸€ä¸ªå¥½å¬çš„åå­—:</p>
<pre><code class="language-swift">extension Publisher where Output == Never, Failure == Never {
  func fireAndForget&lt;A&gt;() -&gt; Effect&lt;A&gt; {
    return self.map(absurd).eraseToEffect()
  }
}
</code></pre>
<p>And now we can simply do:</p>
<pre><code class="language-swift">Current.fileClient
  .save(&quot;favorite-primes.json&quot;, try! JSONEncoder().encode(state))
  .fireAndForget()
</code></pre>
<p>è¿™è¯»èµ·æ¥å¾ˆä¸é”™ã€‚å®ƒæ¸…æ¥šåœ°è¯´æ˜äº†è¿™æ˜¯ä¸€ç§<strong>fire-and-forget effect</strong>ï¼Œå®ƒå…è®¸æˆ‘ä»¬å‘ä¸ŠæŠ•å°„<strong>Never</strong>ç±»å‹åˆ°æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ª<strong>reducer</strong>è¿”å›çš„ä»»ä½•ç±»å‹ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ é™¤ä¹‹å‰çš„<strong>saveEffect</strong>äº†:</p>
<pre><code class="language-swift">//private func saveEffect(favoritePrimes: [Int]) -&gt; Effect&lt;FavoritePrimesAction&gt; {
//  return .fireAndForget {
//    let data = try! JSONEncoder().encode(favoritePrimes)
//    let documentsPath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]
//    let documentsUrl = URL(fileURLWithPath: documentsPath)
//    let favoritePrimesUrl = documentsUrl.appendingPathComponent(&quot;favorite-primes.json&quot;)
//    try! data.write(to: favoritePrimesUrl)
//  }
//}
</code></pre>
<h2 id="3-a-namecontrollingthefavoriteprimesloadeffectacontrolling-the-favorite-primes-load-effect">3. <a name='Controllingthefavoriteprimesloadeffect'></a>Controlling the favorite primes load effect</h2>
<p>ä¸€ä¸ª<strong>effect</strong>æ¶ˆå¤±äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªã€‚æˆ‘ä»¬èƒ½å¤Ÿå°†æˆ‘ä»¬çš„<strong>effect</strong>æå–åˆ°ä¸€ä¸ªç¯å¢ƒä¸­ï¼Œä»¥ä¾¿å®ƒä»¬çš„<strong>live</strong>å®ç°å¯ä»¥è¢«æ›¿æ¢ä¸º<strong>mock</strong>å®ç°ï¼Œä½†æˆ‘ä»¬åªå¤„ç†äº†ä¸€ä¸ªâ€œ<strong>fire-and-forget</strong>â€çš„<strong>effect</strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜<strong>load effect</strong>æ¥ä½¿ç”¨ç¯å¢ƒ:</p>
<pre><code class="language-swift">case .loadButtonTapped:
  return [
    loadEffect
      .compactMap { $0 }
      .eraseToEffect()
  ]
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥ä»è°ƒç”¨ç¯å¢ƒä¸Šçš„ç«¯ç‚¹å¼€å§‹</p>
<pre><code class="language-swift">Current.fileClient.load(&quot;favorite-primes.json&quot;)
</code></pre>
<p>è¿™å°±äº§ç”Ÿäº†<strong>Data?<strong>çš„</strong>effect</strong>ã€‚æˆ‘ä»¬æƒ³è¦ä»<strong>JSON</strong>ä¸­è§£ç è¿™äº›å†…å®¹ï¼Œå¹¸è¿çš„æ˜¯ï¼Œåœ¨<strong>Combine publishers</strong>ä¸Šæœ‰ä¸€ä¸ªå¸®æ‰‹æ¥åšè¿™ä»¶äº‹:</p>
<pre><code class="language-swift">Current.fileClient.load(&quot;favorite-primes.json&quot;)
  .decode(type: [Int].self, decoder: JSONDecoder())
</code></pre>
<p>ç„¶è€Œï¼Œè¿™å¹¶ä¸å·¥ä½œï¼Œå› ä¸º<strong>decode</strong>æœŸæœ›ä¸€ä¸ªè¯šå®çš„æ•°æ®çš„å‘å¸ƒè€…ï¼Œè€Œæˆ‘ä»¬ç»™å®ƒå¯é€‰çš„æ•°æ®ã€‚</p>
<pre><code class="language-swift">Current.fileClient
  .load(&quot;favorite-primes.json&quot;)
  .compactMap { $0 }
  .decode(type: [Int].self, decoder: JSONDecoder())
</code></pre>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¯èƒ½ä¼šå¤±è´¥çš„å‘è¡Œå•†ï¼Œå› ä¸ºä»JSONè§£ç çš„è¿‡ç¨‹å¯èƒ½ä¼šå¤±è´¥ã€‚ä½†æ˜¯æˆ‘ä»¬çš„<strong>Effect publisher</strong>æ˜¯ä¸å…è®¸å¤±è´¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»ç›´æ¥åœ¨æˆ‘ä»¬çš„<strong>reducer</strong>ä¸­æ˜¾å¼åœ°å¤„ç†ä»»ä½•å¤±è´¥ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>publishers</strong>ä¸Šçš„<strong>catch</strong>æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå…è®¸æ‚¨æ‹¦æˆª<strong>publishers</strong>äº§ç”Ÿçš„ä»»ä½•é”™è¯¯ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°ä¸€ä¸ªå…¨æ–°çš„<strong>publisher</strong>ã€‚</p>
<pre><code class="language-swift">Current.fileClient
  .load(&quot;favorite-primes.json&quot;)
  .compactMap { $0 }
  .decode(type: [Int].self, decoder: JSONDecoder())
  .catch { _ in Empty(completeImmediately: true) }
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªç®€å•çš„æ•´æ•°æ•°ç»„çš„<strong>publisher</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†å®ƒæ˜ å°„åˆ°<strong>FavoritePrimesAction</strong>ä¸­ï¼Œå¹¶å°†<strong>publisher</strong>æ“¦é™¤åˆ°æˆ‘ä»¬çš„<strong>effect</strong>ç±»å‹:</p>
<pre><code class="language-swift">Current.fileClient
  .load(&quot;favorite-primes.json&quot;)
  .compactMap { $0 }
  .decode(type: [Int].self, decoder: JSONDecoder())
  .catch { _ in Empty(completeImmediately: true) }
  .map(FavoritePrimesAction.loadedFavoritePrimes)
  .eraseToEffect()
</code></pre>
<p>ç°åœ¨è¿™ä¸ªæ¨¡å—æ­£åœ¨ç¼–è¯‘ï¼Œå°±åƒåˆšæ‰é‚£æ ·ï¼Œæˆ‘ä»¬å·²ç»æ§åˆ¶äº†è¿™ä¸ªå±å¹•ä¸­çš„æ‰€æœ‰<strong>effects</strong>ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥æ³¨é‡Šæ‰æ—§çš„ã€æ— æ³•æ§åˆ¶çš„<strong>load effect</strong>ã€‚ä»»ä½•å¯ä»¥æ‰§è¡Œå‰¯ä½œç”¨çš„ä¸œè¥¿éƒ½è¢«å¡«å……åˆ°è¿™ä¸ª<strong>Environment</strong>ç±»å‹ä¸­ï¼Œå®ƒä¿å­˜äº†ç”Ÿäº§åº”ç”¨ç¨‹åºçš„<strong>live</strong>å®ç°ï¼Œä½†ä¹Ÿè®©æˆ‘ä»¬åœ¨éœ€è¦æ—¶æ–¹ä¾¿åœ°åˆ‡æ¢å®ç°ã€‚</p>
<p>ä¸ºäº†çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<strong>mock</strong>ç‰ˆæœ¬ä¸æˆ‘ä»¬çš„<strong>live</strong>ç‰ˆæœ¬å…±å­˜:</p>
<pre><code class="language-swift">extension FavoritePrimesEnvironment {
  static let mock = FavoritePrimesEnvironment(
    fileClient: FileClient(
      load: { _ in Effect&lt;Data?&gt;.sync { try! JSONEncoder().encode([2, 31])) } },
      save: { _, _ in .fireAndForget {} }
    )
  )
}
</code></pre>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨è°ƒè¯•æ£€æŸ¥ä¸­ä¿æŠ¤è¿™æ®µä»£ç ï¼Œä»¥ä¾¿å®ƒåªä¸åº”ç”¨çš„è°ƒè¯•ç‰ˆæœ¬ä¸€èµ·å‘å¸ƒ:</p>
<pre><code class="language-swift">#if DEBUG
// â€¦
#endif
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ç§è¶…çº§ç®€å•çš„æ–¹æ³•æ¥å°†ç¯å¢ƒçš„<strong>live</strong>ç‰ˆæœ¬æ›¿æ¢ä¸º<strong>mock</strong>ç‰ˆæœ¬ã€‚ä¸ºäº†å±•ç¤ºå®ƒçš„å¼ºå¤§åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬æ›´æ–°<strong>playground</strong>ï¼Œä½¿ç”¨<strong>mock</strong>ç¯å¢ƒï¼Œè€Œä¸æ˜¯å®é™…è®¿é—®æ–‡ä»¶ç³»ç»Ÿ:</p>
<pre><code class="language-swift">@testable import FavoritePrimes
// â€¦

Current = .mock

PlaygroundPage.current.liveView = UIHostingController(
  rootView: NavigationView {
    FavoritePrimesView(
      store: Store&lt;[Int], FavoritePrimesAction&gt;(
        initialValue: [2, 3],
        reducer: favoritePrimesReducer
      )
    )
  }
)
</code></pre>
<p>å¦‚æœæˆ‘ä»¬è¿è¡Œ<strong>playground</strong>å¹¶ç‚¹å‡»<strong>load</strong>ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è´¨æ•°2å’Œ31å¼¹å‡ºï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰ç‚¹å‡»<strong>save</strong>ã€‚è¿™æ˜¯å› ä¸º <strong>mock load effect</strong>ç¡¬ç¼–ç äº†è¦åŠ è½½çš„å¯åŠ¨æ•°ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥å¯¹è¿™ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åŠ è½½è¶…å¤§çš„è´¨æ•°åˆ—è¡¨çš„:</p>
<pre><code class="language-swift">Current = .mock
Current.fileClient.load = { _ in
  Effect.sync { try! JSONEncoder().encode(Array(1...100)) }
}
</code></pre>
<p>å°±åƒæˆ‘ä»¬çœ‹åˆ°çš„ï¼Œå½“æˆ‘ä»¬è¯•å›¾åŠ è½½100ä¸ªæ•°å­—åˆ°è¿™ä¸ªç•Œé¢æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚å½“ç„¶ï¼Œå®ƒä»¬ä¸æ˜¯è´¨æ•°ï¼Œä½†è¿™å¯¹æˆ‘ä»¬ç°åœ¨è¦æµ‹è¯•çš„ä¸œè¥¿å¹¶ä¸é‡è¦ã€‚ä¸ºäº†æ›´æ¸…æ¥šåœ°è¯´æ˜è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬å¢å¤§è¿™ä¸ªæ•°ç»„çš„å¤§å°ï¼Œä»¥å®¹çº³1000ä¸ªæ•´æ•°:</p>
<pre><code class="language-swift">Current.fileClient.load = { _ in
  Effect.sync { try! JSONEncoder().encode(Array(1...1000)) }
}
</code></pre>
<p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬åœ¨ç•Œé¢ä¸­ç‚¹å‡»åŠ è½½æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒä¼šå†»ç»“å‡ ç§’é’Ÿï¼Œç„¶åå°†æ›´æ”¹åŠ¨ç”»åˆ°ä½ã€‚å¯¹äº<strong>SwiftUI</strong>å’Œéå¸¸å¤§çš„åˆ—è¡¨æ¥è¯´ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¨¡æ‹Ÿ<strong>effects</strong>è½»æ¾åœ°å¯¹ç•Œé¢è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œè€Œä¸éœ€è¦æ‰¾åˆ°å°†ä¸€ä¸ªå¤§çš„æ•´æ•°JSONæ–‡ä»¶æ”¾åˆ°ç£ç›˜ä¸Šçš„æ–¹æ³•ï¼Œè¿™æ˜¯éå¸¸æ£’çš„ã€‚</p>
<h2 id="4-a-nametestingthefavoriteprimessaveeffectatesting-the-favorite-primes-save-effect">4. <a name='Testingthefavoriteprimessaveeffect'></a>Testing the favorite primes save effect</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å…·å¤‡äº†å¼€å§‹ä¸º<strong>effects</strong>ç¼–å†™ä¸€äº›æµ‹è¯•æ‰€éœ€çš„ä¸€åˆ‡ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å·²ç»ä¸º<strong>favoritePrimesReducer</strong>ç¼–å†™äº†å“ªäº›æµ‹è¯•:</p>
<pre><code class="language-swift">func testSaveButtonTapped() {
  var state = [2, 3, 5, 7]
  let effects = favoritePrimesReducer(state: &amp;state, action: .saveButtonTapped)
  XCTAssertEqual(state, [2, 3, 5, 7])
  XCTAssertEqual(effects.count, 1)
}
</code></pre>
<p>è¿™æ˜¯æœ€ç®€å•çš„æµ‹è¯•ï¼Œå³å½“æˆ‘ä»¬ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šæ”¹å˜çŠ¶æ€ï¼Œä½†æˆ‘ä»¬ä¼šå‘å‡ºä¸€ç§<strong>effect</strong>ã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸ª<strong>effect</strong>ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œå®ƒ:</p>
<pre><code class="language-swift">_ = effects[0].sink { }
</code></pre>
<p>è®°ä½ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è¿™ä¸ª<strong>effect</strong>çš„å®æ—¶å®ç°ï¼Œè¿™æ„å‘³ç€è¦ç†è§£è¿™ä¸ª<strong>effect</strong>çš„ä½œç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶å¹¶æ–­è¨€ä¿å­˜äº†ä»€ä¹ˆã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œè¿™æ˜¯ä¸€ä»¶éå¸¸è„†å¼±çš„äº‹æƒ…ï¼Œå› ä¸ºæˆ‘ä»¬ç”šè‡³å¯èƒ½æ²¡æœ‰å¯¹è¿™ä¸ªç£ç›˜çš„è¯»å†™æƒé™ã€‚æˆ‘ä»¬å¸Œæœ›å®Œå…¨æ¶ˆé™¤å¤„ç†å®é™…ç£ç›˜å­˜å‚¨çš„å„ç§æ€ªå¼‚æ“ä½œï¼Œè¿™å¯ä»¥é€šè¿‡ä½¿ç”¨<strong>mock</strong>ç¯å¢ƒæ¥å®ç°:</p>
<pre><code class="language-swift">Current = .mock
</code></pre>
<p>è¿™æ ·å°±ä¸ä¼šç¢°åˆ°ç£ç›˜äº†ã€‚ç„¶è€Œï¼Œè¿™ä»ç„¶ä¸èƒ½å¸®åŠ©æˆ‘ä»¬æµ‹è¯•ä¿å­˜<strong>effect</strong>ã€‚æˆ‘ä»¬çœŸæ­£æƒ³æµ‹è¯•çš„æ˜¯æ˜¯å¦è°ƒç”¨äº†ä¿å­˜<strong>effect</strong>ã€‚ æˆ‘ä»¬å¿…é¡»ç›¸ä¿¡ï¼Œåªè¦ä¼ é€’äº†æ­£ç¡®çš„ä¿¡æ¯ï¼Œå®æ—¶ä¿å­˜<strong>effect</strong>å°±ä¼šåšæ­£ç¡®çš„äº‹æƒ…ã€‚ä¸ºäº†åœ¨æ¨¡æ‹Ÿ<strong>effect</strong>ä¸­æ•æ‰åˆ°å®ƒï¼Œæˆ‘ä»¬åªéœ€åœ¨å‘¨å›´ä¿ç•™ä¸€ä¸ªå¯å˜çš„å¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦æ‰§è¡Œäº†<strong>save</strong>æ•ˆæœï¼Œç„¶ååœ¨<strong>effect</strong>ä¸­ç¿»è½¬å®ƒ:</p>
<pre><code class="language-swift">var didSave = false
Current.fileClient.save = { _, _ in .fireAndForget { didSave = true } }
</code></pre>
<p>ç„¶åæˆ‘ä»¬åªæƒ³ç¡®ä¿è¿™ä¸ªå¸ƒå°”å€¼åœ¨æ‰§è¡Œ<strong>effect</strong>åè¢«ç¿»è½¬ä¸º<strong>true</strong>:</p>
<pre><code class="language-swift">_ = effects[0].sink { _ in }

XCTAssert(didSave)
</code></pre>
<p>å¦‚æœæˆ‘ä»¬è¿è¡Œæµ‹è¯•ï¼Œå®ƒé€šè¿‡äº†ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»æ–­è¨€<strong>reducer</strong>ä½¿ç”¨äº†æˆ‘ä»¬æœŸæœ›çš„<strong>effect</strong>! è¿™æ„å‘³ç€åªè¦æˆ‘ä»¬ç›¸ä¿¡ä¿å­˜<strong>effect</strong>æ˜¯æ­£ç¡®çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„<strong>effect</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè®¸å¯ä»¥ç›¸ä¿¡å®ƒæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡³å°‘å¯ä»¥å¾—åˆ°ä¸€äº›å…³äºè¿™ä¸ª<strong>effect</strong>çš„æŠ¥é“ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œç¡®ä¿è¿™ä¸ª<strong>effect</strong>çš„å›è°ƒå‡½æ•°æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºè¿™ä¸ª<strong>effect</strong>åº”è¯¥æ˜¯â€œ<strong>fire-and-forget</strong>â€çš„:</p>
<pre><code class="language-swift">_ = effects[0].sink { _ in XCTFail() }
</code></pre>
<p>è¿™å¾ˆå¥½ï¼Œå› ä¸ºå®ƒä¿è¯æˆ‘ä»¬å·²ç»æ•è·äº†è¿™ä¸ª<strong>effect</strong>çš„æ•´ä¸ªå‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª<strong>effect</strong>ä¸ä¼šäº§ç”Ÿä»»ä½•æˆ‘ä»¬éœ€è¦é€šè¿‡<strong>reducer</strong>æ¥éªŒè¯å…¶è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸçš„æ“ä½œã€‚</p>
<p>æˆ‘ä»¬åˆšåˆšåœ¨è¿™é‡Œå–å¾—çš„æˆå°±å€¼å¾—åæ€ã€‚åªéœ€è¦å¾ˆå°‘çš„è®¾ç½®ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿä»¥ä¸€ç§éå¸¸ç›´æ¥çš„æ–¹å¼ç¡®è®¤å½“ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶æˆ‘ä»¬ä¸ä¼šæ”¹å˜çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šæ‰§è¡Œä¸€ä¸ªè°ƒç”¨æˆ‘ä»¬çš„<strong>save</strong>ä¾èµ–é¡¹çš„å‰¯ä½œç”¨ï¼Œå¹¶ä¸”ä¸ä¼šå‘å‡ºä»»ä½•å…¶ä»–åŠ¨ä½œå‘é€åˆ°<strong>store</strong>ä¸­ã€‚è¿™æ˜¯éå¸¸å¹¿æ³›çš„è¦†ç›–ï¼Œå¾ˆå°‘çš„å·¥ä½œã€‚</p>
<p>ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ¾„æ¸…ï¼Œæˆ‘ä»¬è·å¾—è¿™ç§èƒ½åŠ›çš„ä¸€ä¸ªä¸»è¦åŸå› æ˜¯æˆ‘ä»¬çš„ä¾èµ–æ€§æ˜¯å¦‚ä½•å»ºç«‹çš„ã€‚å½“ä¾èµ–å…³ç³»å°½å¯èƒ½ç®€å•æ—¶ï¼Œè¿™ç§ç±»å‹çš„æµ‹è¯•æ•ˆæœæœ€å¥½ã€‚ç®€å•åˆ°ä½ å¯ä»¥ç›¸ä¿¡ä»–ä»¬ä¼šåšæ­£ç¡®çš„äº‹æƒ…åªè¦ä½ ç»™ä»–ä»¬æ­£ç¡®çš„æ•°æ®ã€‚å®ƒä»¬éå¸¸ç®€å•ï¼Œæœ¬èº«å‡ ä¹æ²¡æœ‰é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œä¿å­˜å’ŒåŠ è½½æ•ˆæœåªå®Œæˆå°†æ•°æ®å­˜å…¥ç£ç›˜å’Œä»ç£ç›˜å–å‡ºæ‰€éœ€çš„æœ€ä½é™åº¦çš„å·¥ä½œã€‚å®ƒä¸åšä»»ä½•æ•°æ®è½¬æ¢ï¼Œæ¯”å¦‚JSONè§£ç ï¼Œå®ƒæŠŠè¿™äº›å·¥ä½œç•™ç»™ä¾èµ–é¡¹çš„ç”¨æˆ·ã€‚æˆ‘ä»¬çš„æµ‹è¯•å°†æµ‹è¯•è¿™äº›æ•°æ®è½¬æ¢ï¼Œè€Œå°†ä¸ç£ç›˜äº¤äº’çš„æ··ä¹±ç•™ç»™ä¾èµ–é¡¹ã€‚</p>
<p>ä¸ºäº†è¯æ˜è¿™ä¸ªæµ‹è¯•ç¡®å®æ•æ‰äº†æˆ‘ä»¬<strong>reducer</strong>çš„ä¸€äº›è¡Œä¸ºï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬çŠ¯äº†ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„<strong>copy-pasta</strong>é”™è¯¯ï¼Œæˆ‘ä»¬ä¸å°å¿ƒåœ¨ä¿å­˜æ“ä½œä¸­ä½¿ç”¨äº†åŠ è½½æ•ˆæœ:</p>
<pre><code class="language-swift">case .saveButtonTapped:
  return [
    Current.fileClient
      .load(&quot;favorite-primes.json&quot;)
      .compactMap { $0 }
      .decode(type: [Int].self, decoder: JSONDecoder())
      .catch { _ in Empty(completeImmediately: true) }
      .map(FavoritePrimesAction.loadedFavoritePrimes)
      .eraseToEffect()
  ]
</code></pre>
<p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸¤ä¸ªå¤±è´¥:</p>
<ul>
<li>The effect at effects[0] emitted a value, which we know it should not.</li>
<li>The didSave flag was not flipped to true, which means the save effect was not invoked.</li>
</ul>
<p>è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥åŠ å¼ºè¿™ä¸ªæµ‹è¯•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æå–å‘é€åˆ°ä¿å­˜ç«¯ç‚¹çš„æ•°æ®ï¼Œå¹¶éªŒè¯å®ƒç¼–ç çš„æ•´æ•°æ•°ç»„æ˜¯å¦æ­£ç¡®ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨å¾ˆå°‘çš„å·¥ä½œæ¥è¦†ç›–æ›´å¤šçš„å†…å®¹ï¼Œä½†æ˜¯æˆ‘ä»¬å°†æŠŠå®ƒç•™ç»™è§‚ä¼—ä½œä¸ºç»ƒä¹ ã€‚</p>
<p>è¿™å˜å¾—éå¸¸é…·ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ§åˆ¶æˆ‘ä»¬çš„<strong>effects</strong>çš„æ„ä¹‰çš„å¼€ç«¯:åªè¦æˆ‘ä»¬å°†ä¾èµ–å…³ç³»æè¿°ä¸ºå¸¦æœ‰å¯å˜å­—æ®µçš„ç®€å•ç»“æ„ï¼Œåªè¦æˆ‘ä»¬å¼ºåˆ¶<strong>reducer</strong>åœ¨è¯¥ç»“æ„ä¸­ä½¿ç”¨è¿™äº›ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†æ´»åŠ¨å®ç°æ›¿æ¢ä¸ºæ¨¡æ‹Ÿå®ç°ï¼Œå¹¶å®é™…æ‰§è¡Œè¿™äº›æ•ˆæœï¼Œä»¥æ–­è¨€å®ƒä»¬äº§ç”Ÿäº†æ­£ç¡®çš„å€¼æ¥åé¦ˆç»™ç³»ç»Ÿï¼Œæˆ–è€…æ ¹æœ¬æ²¡æœ‰äº§ç”Ÿä»»ä½•ä¸œè¥¿ã€‚</p>
<p>å› ä¸º<strong>effects</strong>åº”è¯¥åŒ…å«å¾ˆå°‘çš„é€»è¾‘ï¼Œå¹¶ä¸”ä¸“æ³¨äºå®ƒä»¬éœ€è¦åšçš„æœ€å°æ•°é‡çš„å·¥ä½œï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‹…å¿ƒæµ‹è¯•<strong>effects</strong>æœ¬èº«çš„ç»†èŠ‚ã€‚å¦‚æœä¸€ä¸ª<strong>effect</strong>ä»…ä»…è°ƒç”¨è‹¹æœçš„apiä»ç£ç›˜åŠ è½½æ•°æ®ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå¸Œæœ›å®ƒèƒ½æ­£å¸¸å·¥ä½œã€‚æˆ‘ä»¬å…³å¿ƒçš„æ˜¯æ•è·æ˜¯å¦è°ƒç”¨äº†ç‰¹å®šçš„<strong>effect</strong>ï¼Œå¹¶æ•è·å®ƒåé¦ˆç»™<strong>reducer</strong>çš„æ•°æ®ã€‚</p>
<h2 id="5-a-nametestingthefavoriteprimesloadeffectatesting-the-favorite-primes-load-effect">5. <a name='Testingthefavoriteprimesloadeffect'></a>Testing the favorite primes load effect</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æµ‹è¯•äº†ä¿å­˜<strong>effect</strong>ï¼Œè®©æˆ‘ä»¬æµ‹è¯•åŠ è½½<strong>effect</strong>ï¼Œè¿™æœ‰ç‚¹ä¸åŒï¼Œå› ä¸ºå®ƒéœ€è¦å°†æ•°æ®åé¦ˆåˆ°<strong>reducer</strong>ã€‚<br>
æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¹‹å‰ç¼–å†™çš„ä¸‹ä¸€ä¸ªæµ‹è¯•:</p>
<pre><code class="language-swift">func testLoadFavoritePrimesFlow() {
  var state = [2, 3, 5, 7]

  var effects = favoritePrimesReducer(state: &amp;state, action: .loadButtonTapped)

  XCTAssertEqual(state, [2, 3, 5, 7])
  XCTAssertEqual(effects.count, 1)

  effects = favoritePrimesReducer(state: &amp;state, action: .loadedFavoritePrimes([2, 31]))

  XCTAssertEqual(state, [2, 31])
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>è¿™å°†æµ‹è¯•å¦‚æœæˆ‘ä»¬ç‚¹å‡»åŠ è½½æŒ‰é’®ï¼ŒçŠ¶æ€ä¸ä¼šæ”¹å˜ï¼Œä½†ä¼šå‘å‡ºä¸€ä¸ª<strong>effect</strong>ã€‚æˆ‘ä»¬ä¸çŸ¥é“æ˜¯å“ªä¸ª<strong>effect</strong>ï¼Œä½†æˆ‘ä»¬å‡è®¾å®ƒæ˜¯<strong>loaddfavoriteprimes effect</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨<strong>reducer</strong>ä¸­è¿è¡Œè¯¥åŠ¨ä½œï¼Œå¹¶æ–­è¨€çŠ¶æ€å·²æ›´æ”¹ï¼Œæ²¡æœ‰å‘å‡ºè¿›ä¸€æ­¥çš„<strong>effect</strong>ã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦ä¸€äº›æµ‹è¯•è¦†ç›–æˆ‘ä»¬å¿½ç•¥çš„<strong>effect</strong>ï¼Œä½†å¦‚æœæˆ‘ä»¬åªæ˜¯å¤©çœŸåœ°è¿è¡Œå®ƒï¼Œæˆ‘ä»¬ä¸ä¼šå¾—åˆ°ä»»ä½•è¶…çº§æœ‰ç”¨çš„ä¸œè¥¿:</p>
<pre><code class="language-swift">_ = effects[0].sink { action in
  print(action)
}
</code></pre>
<p>æˆ‘ä»¬ä¸æƒ³ä¸ºäº†è¿è¡Œè¿™ä¸ªæµ‹è¯•è€Œä¾èµ–äºç£ç›˜çš„çŠ¶æ€ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»æ§åˆ¶äº†è¿™ç§å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®Œå…¨ç»•è¿‡ç£ç›˜ï¼Œç›´æ¥æä¾›æ•°æ®:</p>
<pre><code class="language-swift">Current = .mock
Current.fileClient.load = { _ in .sync { try! JSONEncoder().encode([2, 31]) } }
</code></pre>
<p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œæµ‹è¯•æ—¶ï¼Œæ‰“å°çŠ¶æ€æ‰§è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å¾—åˆ°çš„åŠ¨ä½œæ˜¯:</p>
<pre><code class="language-swift">loadedFavoritePrimes([2, 31])
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ•°æ®ï¼Œå› ä¸ºå®ƒè¡¨æ˜<strong>effect</strong>åšäº†ä¸€äº›å·¥ä½œï¼Œå¹¶è¿”å›è¿™ä¸ªåŠ¨ä½œåé¦ˆåˆ°ç³»ç»Ÿä¸­ã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾ç›´æ¥æ–­è¨€ï¼Œæˆ‘ä»¬å°±æœ‰ä¸€ä¸ªé—®é¢˜:</p>
<pre><code class="language-swift">_ = effects[0].sink { action in
  XCTAssertEqual(action, .loadedFavoritePrimes([2, 31]))
}
</code></pre>
<blockquote>
<p>ğŸ›‘ Global function â€˜XCTAssertEqual(::_:file:line:)â€™ requires that â€˜FavoritePrimesActionâ€™ conform to â€˜Equatableâ€™</p>
</blockquote>
<p>æˆ‘ä»¬ä¸èƒ½æ–­è¨€è¿™ä¸ªåŠ¨ä½œç­‰äºä»€ä¹ˆï¼Œå› ä¸ºå®ƒä¸æ˜¯<strong>Equatable</strong>ã€‚è¿™å¾ˆå®¹æ˜“è§£å†³:</p>
<pre><code class="language-swift">public enum FavoritePrimesAction: Equatable {
</code></pre>
<p>ç°åœ¨ï¼Œæµ‹è¯•è¢«ç¼–è¯‘äº†ï¼Œå®ƒé€šè¿‡äº†ï¼Œå› ä¸º<strong>effect</strong>äº§ç”Ÿçš„åŠ¨ä½œç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ã€‚ä½†æˆ‘ä»¬ä¸æƒ³åœ¨è¿™é‡Œåœæ­¢ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦é‡‡å–è¿™ä¸ªè¡ŒåŠ¨ï¼Œå¹¶æŠŠå®ƒé¦ˆå›<strong>reducer</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨<strong>reducer</strong>å¤–éƒ¨è·å–è¿™ä¸ªåŠ¨ä½œçš„å¼•ç”¨ï¼Œç„¶ååœ¨ä¹‹åä½¿ç”¨å®ƒæ¥å®ç°:</p>
<pre><code class="language-swift">var nextAction: FavoritePrimesAction!
_ = effects[0].sink { action in
  XCTAssertEqual(action, .loadedFavoritePrimes([2, 31]))
  nextAction = action
}

effects = favoritePrimesReducer(state: &amp;state, action: nextAction)

XCTAssertEqual(state, [2, 31])
XCTAssert(effects.isEmpty)
</code></pre>
<p>ç°åœ¨è¿™å¾ˆé…·ã€‚æˆ‘ä»¬å¹¶ä¸æ˜¯æ‰‹åŠ¨æ„é€ æˆ‘ä»¬è®¤ä¸ºä¼šäº§ç”Ÿ<strong>effect</strong>çš„åŠ¨ä½œï¼Œåªæ˜¯ä¸ºäº†å°†å…¶åé¦ˆç»™<strong>store</strong>ã€‚ç›¸åï¼Œæˆ‘ä»¬è¿è¡Œè¿™ä¸ª<strong>effect</strong>ï¼Œæ–­è¨€å®ƒäº§ç”Ÿäº†æˆ‘ä»¬æœŸæœ›çš„åŠ¨ä½œï¼Œå°†å®ƒåé¦ˆç»™<strong>reducer</strong>ï¼Œç„¶åæ–­è¨€è¿™ä¸ªæ–°åŠ¨ä½œå¦‚ä½•æ”¹å˜äº†æˆ‘ä»¬çš„çŠ¶æ€ã€‚</p>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œæ–­è¨€è¿™ä¸ª<strong>effect</strong>ä¸ä»…äº§ç”Ÿäº†æˆ‘ä»¬é¢„æœŸçš„åŠ¨ä½œï¼Œè€Œä¸”å®ƒå®Œæˆäº†ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿå¦ä¸€ä¸ª<strong>effect</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªæµ‹è¯•æœŸæœ›ï¼Œåœ¨<strong>sink</strong>ä¹‹åç­‰å¾…å®ƒï¼Œç„¶ååœ¨<strong>completion block</strong>ä¸­å®ç°è¿™ä¸ªæœŸæœ›:</p>
<pre><code class="language-swift">var nextAction: FavoritePrimesAction!
let receivedCompletion = self.expectation(description: &quot;receivedCompletion&quot;)
_ = effects[0].sink(
  receiveCompletion: { _ in receivedCompletion.fulfill() },
  receiveValue: { action in
    nextAction = action
    XCTAssertEqual(action, .loadedFavoritePrimes([2, 31]))
})
self.wait(for: [receivedCompletion], timeout: 0)
</code></pre>
<p>è¿™è®©æˆ‘ä»¬çš„æµ‹è¯•æ›´åŠ æœ‰åŠ›ã€‚å¦‚æœæˆ‘ä»¬ä¿®æ”¹<strong>reducer</strong>çš„<strong>load effect</strong>ä¸ºæ°¸ä¸å®Œæˆï¼Œæˆ‘ä»¬å°†ä¼šå¾—åˆ°ä¸€ä¸ªå¤±è´¥:</p>
<pre><code class="language-swift">return [
  Current.fileClient
    .load(&quot;favorite-primes.json&quot;)
    .decode(type: [Int].self, decoder: JSONDecoder())
    .catch { _ in Empty(completeImmediately: true) }
    .map(FavoritePrimesAction.loadedFavoritePrimes)
    .merge(with: Empty(completeImmediately: false))
    .eraseToEffect()
]
</code></pre>
<blockquote>
<p>ğŸ›‘ Asynchronous wait failed: Exceeded timeout of 0 seconds, with unfulfilled expectations: â€œreceivedCompletionâ€.</p>
</blockquote>
<p>æˆ‘ä»¬æ•æ‰åˆ°çš„äº‹å®æ˜¯æƒŠäººçš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æ­£åœ¨è¯æ˜ï¼Œæœªæ¥ä¸å­˜åœ¨æˆ‘ä»¬å¯èƒ½ä¼šæ„å¤–å¿˜è®°çš„è¡Œä¸ºã€‚</p>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä½¿å®ƒæ›´å¼ºï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬å¹¶æ²¡æœ‰æ–­è¨€è¿™ç§<strong>effect</strong>åªä¼šäº§ç”Ÿä¸€æ¬¡ã€‚å®ƒå¯èƒ½å·²ç»å‘å°„äº†å¾ˆå¤šæ¬¡ï¼Œä½†è¿™ä¸ªæµ‹è¯•ä»ç„¶å¯ä»¥é€šè¿‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨<strong>reducer</strong>çš„<strong>load effect</strong>ä¸­å·å·åŠ å…¥è¿™ä¸ª:</p>
<pre><code class="language-swift">.merge(with: Just(FavoritePrimesAction.loadedFavoritePrimes([2, 31])))
</code></pre>
<p>ä¸€åˆ‡éƒ½è¿‡å»äº†ï¼Œä½†æ˜¾ç„¶è¿™æ˜¯éå¸¸ä¸åŒçš„è¡Œä¸ºã€‚æ‰€ä»¥æˆ‘ä»¬ä»ç„¶æ²¡æœ‰æ•æ‰åˆ°å…¨éƒ¨çš„<strong>effect</strong>ï¼Œä½†æˆ‘ä»¬å¾—åˆ°äº†å¾ˆå¤šã€‚æˆ‘ä»¬å¾ˆå¿«å°±èƒ½æ•è·æ›´å¤šï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å®Œæˆæ§åˆ¶å™¨å¹¶åœ¨åº”ç”¨ç¨‹åºä¸­æµ‹è¯•å…¶ä½™çš„å‰¯ä½œç”¨ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é€šè¿‡åœ¨æµ‹è¯•çš„<strong>setUp</strong>æ–¹æ³•ä¸­è®¾ç½®é»˜è®¤çš„æ¨¡æ‹Ÿç¯å¢ƒæ¥ç¨å¾®æ¸…ç†ä¸€ä¸‹è¿™ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œè¿™æ ·æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½å°†ä»ä¸€ä¸ªæ–°çš„æ¨¡æ‹Ÿç¯å¢ƒå¼€å§‹ï¼Œä»–ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ„æ„¿æ¥å®šåˆ¶:</p>
<pre><code class="language-swift">override func setUp() {
  super.setUp()
  Current = .mock
}
</code></pre>
<h2 id="6-a-namecontrollingthecountereffectacontrolling-the-counter-effect">6. <a name='Controllingthecountereffect'></a>Controlling the counter effect</h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™å·²ç»å¾ˆæœ‰å¯å‘æ€§äº†ã€‚å°½ç®¡ä¿å­˜å’ŒåŠ è½½æ•ˆæœçœ‹èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä½†æˆ‘ä»¬èƒ½å¤Ÿå¯¹å®ƒä»¬è¿›è¡Œå¤§é‡æµ‹è¯•ã€‚æˆ‘ä»¬ä¸ä»…å¯ä»¥æµ‹è¯•ä¿å­˜<strong>effect</strong>æ˜¯å¦æœ‰æ•ˆï¼Œè¿˜å¯ä»¥æµ‹è¯•å®ƒæ˜¯å¦ä¸ä¼šäº§ç”Ÿå¦ä¸€ä¸ªåŠ¨ä½œã€‚æˆ‘ä»¬ä¸ä»…å¯ä»¥æµ‹è¯•<strong>load effect</strong>æ˜¯å¦èµ·ä½œç”¨ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ–­è¨€å®ƒæ˜¯å¦èµ·åˆ°äº†æˆ‘ä»¬é¢„æœŸçš„ä½œç”¨å¹¶å°†æ­£ç¡®çš„åŠ¨ä½œåé¦ˆç»™ç³»ç»Ÿã€‚æˆ‘ä»¬ç”¨éå¸¸å°‘çš„å·¥ä½œè·å¾—äº†å¤§é‡çš„æµ‹è¯•è¦†ç›–ã€‚</p>
<p>æ—¢ç„¶æ‰€æœ‰çš„å‰¯ä½œç”¨éƒ½åœ¨<strong>FavoritePrimes</strong>æ¨¡å—ä¸­å¾—åˆ°äº†æ§åˆ¶å’Œæµ‹è¯•ï¼Œç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›è½¬å‘<strong>Counter</strong>æ¨¡å—ã€‚å®ƒåªæœ‰ä¸€ä¸ªæ•ˆæœï¼Œå³è®¿é—®<strong>Wolfram Alpha API</strong>çš„ç½‘ç»œè¯·æ±‚ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯æœ€éš¾å¤„ç†çš„ï¼Œå› ä¸ºå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œè¦ç†è§£å®ƒå¦‚ä½•é€‚åˆæˆ‘ä»¬çš„ä½“ç³»ç»“æ„éœ€è¦ç›¸å½“å¤šçš„å·¥ä½œã€‚ ç„¶è€Œï¼Œæ§åˆ¶å®ƒå°±ç›¸å½“ç®€å•äº†ã€‚</p>
<p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„<strong>effect</strong>æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œå®ƒè®¡ç®—ç»™å®šç‰¹å®šnçš„â€œç¬¬nä¸ªç´ æ•°â€:</p>
<pre><code class="language-swift">func nthPrime(_ n: Int) -&gt; Effect&lt;Int?&gt; {

}
</code></pre>
<p>è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„<strong>effect</strong>ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç¯å¢ƒç»“æ„ä½“å¹¶å°†å…¶æ·»åŠ åˆ°ç¯å¢ƒä¸­:</p>
<pre><code class="language-swift">struct CounterEnvironment {
  var nthPrime: (Int) -&gt; Effect&lt;Int?&gt;
}
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨å½“å‰çš„<strong>nthPrime</strong>æ•ˆæœæ¥åˆ›å»ºè¿™ä¸ªç¯å¢ƒçš„<strong>live</strong>å®ç°:</p>
<pre><code class="language-swift">extension CounterEnvironment {
  static let live = Self(nthPrime: Counter.nthPrime)
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é»˜è®¤å½“å‰çš„ç¯å¢ƒæ˜¯<strong>live</strong>ã€‚</p>
<pre><code class="language-swift">var Current = CounterEnvironment.live
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»º<strong>mock</strong>ç‰ˆæœ¬:</p>
<pre><code class="language-swift">#if DEBUG
extension CounterEnvironment {
  static let mock = CounterEnvironment(nthPrime: { _ in .sync { 17 } })
}
#endif
</code></pre>
<p>ç¯å¢ƒå°±ä½åï¼Œç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯ä½¿ç”¨ç¯å¢ƒçš„<strong>nthPrime effect</strong>ï¼Œè€Œä¸æ˜¯åœ¨è¿™ä¸ªæ¨¡å—ä¸­ä½¿ç”¨<strong>live</strong>:</p>
<pre><code class="language-swift">//      nthPrime(state.count)
      Current.nthPrime(state.count)
        .map(CounterAction.nthPrimeResponse)
        .receive(on: DispatchQueue.main)
        .eraseToEffect()
</code></pre>
<p>è¿™å°±æ˜¯å®Œå…¨æ§åˆ¶æ¨¡å—å‰¯ä½œç”¨æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚ æ¯”<strong>FavoritePrimes</strong>æ¨¡å—ç®€å•å¤šäº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨<strong>playground</strong>ä¸­è¿è¡Œè®¡æ•°å™¨å±å¹•è€Œè·å¾—ç›Šå¤„:</p>
<pre><code class="language-swift">@testable import Counter
// â€¦

Current = .mock

PlaygroundPage.current.liveView = UIHostingController(
  rootView: CounterView(
    store: Store&lt;CounterViewState, CounterViewAction&gt;(
      initialValue: CounterViewState(
        alertNthPrime: nil,
        count: 0,
        favoritePrimes: [],
        isNthPrimeButtonDisabled: false
      ),
      reducer: logging(counterViewReducer)
    )
  )
)
</code></pre>
<p>ç°åœ¨å½“æˆ‘ä»¬è¿è¡Œæ“åœºï¼Œç‚¹å‡»â€œç¬¬nä¸ªè´¨æ•°æ˜¯å¤šå°‘?â€ï¼Œæˆ‘ä»¬ä¼šç«‹å³å¾—åˆ°ä¸€ä¸ªå“åº”ï¼Œè¯´è´¨æ•°æ˜¯2ã€‚è¿™å½“ç„¶æ˜¯é”™è¯¯çš„ï¼Œä½†ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¾èµ–äº<strong>Wolfram Alpha</strong>æœåŠ¡çš„æƒ…å†µä¸‹æµ‹è¯•è¿™ä¸ªåŠŸèƒ½ã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨æ²¡æœ‰äº’è”ç½‘æ¥å…¥çš„é£æœºä¸Šï¼Œæˆ–è€…å¯èƒ½æœ‰ä¸€å¤©<strong>Wolfram API</strong>ä¼šå®•æœºã€‚å½“æ‚¨èƒ½å¤Ÿæ­£ç¡®åœ°æ§åˆ¶åº”ç”¨ç¨‹åºä¸­çš„å‰¯ä½œç”¨æ—¶ï¼Œè¿™äº›éƒ½ä¸é‡è¦ã€‚</p>
<h2 id="7-a-nametestingthecountereffectsatesting-the-counter-effects">7. <a name='Testingthecountereffects'></a>Testing the counter effects</h2>
<p>ç°åœ¨æˆ‘ä»¬æ§åˆ¶äº†<strong>counter effects</strong>ï¼Œè®©æˆ‘ä»¬æ¥æµ‹è¯•å®ƒä»¬ã€‚æˆ‘ä»¬å¯ä»¥ä»æµ‹è¯•å¥—ä»¶çš„è®¾ç½®ä¸­æ¨¡æ‹Ÿç¯å¢ƒå¼€å§‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿æˆ‘ä»¬æ°¸è¿œä¸ä¼šä½¿ç”¨ä¾èµ–é¡¹çš„å®æ—¶å®ç°:</p>
<pre><code class="language-swift">override func setUp() {
  super.setUp()
  Current = .mock
}
</code></pre>
<p>å‰å‡ ä¸ªæµ‹è¯•æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆå¯åšçš„:</p>
<pre><code class="language-swift">func testIncrTapped() {
  // â€¦
  XCTAssert(effects.isEmpty)
}

func testDecrTapped() {
  // â€¦
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>ä¸‹ä¸€ä¸ªæµ‹è¯•ï¼Œ<strong>testNthPrimeButtonHappyFlow</strong>ï¼Œåœ¨æ­¤å±å¹•ä¸­æµ‹è¯•ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·æµ:</p>
<pre><code class="language-swift">func testNthPrimeTappedFlow() {
  var state = CounterViewState(
    alertNthPrime: nil,
    count: 7,
    favoritePrimes: [2, 3],
    isNthPrimeButtonDisabled: false
  )

  var effects = counterViewReducer(&amp;state, .counter(.nthPrimeButtonTapped))
  XCTAssertEqual(
    state,
    CounterViewState(
      alertNthPrime: nil,
      count: 7,
      favoritePrimes: [2, 3],
      isNthPrimeButtonDisabled: true
    )
  )
  XCTAssertEqual(effects.count, 1)

  effects = counterViewReducer(&amp;state, .counter(.nthPrimeResponse(17)))
  XCTAssertEqual(
    state,
    CounterViewState(
      alertNthPrime: PrimeAlert(prime: 17),
      count: 7,
      favoritePrimes: [2, 3],
      isNthPrimeButtonDisabled: false
    )
  )
  XCTAssert(effects.isEmpty)

  effects = counterViewReducer(&amp;state, .counter(.alertDismissButtonTapped))
  XCTAssertEqual(
    state,
    CounterViewState(
      alertNthPrime: nil,
      count: 7,
      favoritePrimes: [2, 3],
      isNthPrimeButtonDisabled: false
    )
  )
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>å½“ç”¨æˆ·ç‚¹å‡»â€œç¬¬nä¸ªç´ æ•°â€æŒ‰é’®æ—¶ï¼ŒæŸäº›çŠ¶æ€ä¼šå‘ç”Ÿæ”¹å˜ï¼Œç‰¹åˆ«æ˜¯<strong>isNthPrimeButtonDisabled</strong>å­—æ®µä¼šè¢«åˆ‡æ¢ä¸º<strong>true</strong>ï¼Œå¹¶è¿”å›ä¸€ä¸ª<strong>effect</strong>ï¼Œå°½ç®¡æˆ‘ä»¬ç›®å‰è¿˜ä¸çŸ¥é“è¿™ä¸ª<strong>effect</strong>æ˜¯ä»€ä¹ˆã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡å‘<strong>reducer</strong>ä¸­è¾“å…¥å¦ä¸€ä¸ªåŠ¨ä½œæ¥æ¨¡æ‹Ÿæ¥è‡ªAPIçš„å“åº”ï¼Œè¯¥<br>
æ˜¯æˆ‘ä»¬æœŸæœ›ä»<strong>effect</strong>ä¸­å¾—åˆ°çš„ï¼Œä½†æˆ‘ä»¬ä»ç„¶ç¼ºå°‘å¯¹<strong>effect</strong>çš„è¦†ç›–ã€‚è®©æˆ‘ä»¬é‡å¤æˆ‘ä»¬å¯¹æœ€å–œæ¬¢çš„primes<strong>effect</strong>æ‰€åšçš„ï¼Œé€šè¿‡è¿è¡Œè¿™ä¸ªæ•ˆåº”ï¼Œçœ‹çœ‹æˆ‘ä»¬èƒ½å‘ç°ä»€ä¹ˆã€‚æˆ‘ä»¬å¯ä»¥åœ¨<strong>effect</strong>ä¸Šè°ƒç”¨<strong>sink</strong>æ¥è·å¾—å®ƒçš„å®Œæˆå’Œå€¼äº‹ä»¶:</p>
<pre><code class="language-swift">_ = effects[0].sink(
  receiveCompletion: { _ in },
  receiveValue: { action in }
)
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æ–­è¨€ï¼Œè¿™ç§<strong>effect</strong>äº§ç”Ÿçš„åŠ¨ä½œæ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„<strong>nthprimerresponse</strong>:</p>
<pre><code class="language-swift">_ = effects[0].sink(
  receiveCompletion: { _ in },
  receiveValue: { action in
    XCTAssertEqual(action, .counter(.nthPrimeResponse(3)))
})
</code></pre>
<p>æˆ‘ä»¬åªéœ€è¦ç¡®ä¿æˆ‘ä»¬çš„<strong>actions</strong>æ˜¯å…¬å¹³çš„ã€‚</p>
<pre><code class="language-swift">enum CounterViewAction: Equatable {
// â€¦
enum CounterAction: Equatable {
// â€¦
enum PrimeModalAction: Equatable {
</code></pre>
<p>ä½†æˆ‘ä»¬æœŸæœ›çš„æ•°å­—æ˜¯å¤šå°‘?è¿™å–å†³äºæˆ‘ä»¬åœ¨æ¨¡æ‹Ÿä¸­ä½¿ç”¨äº†ä»€ä¹ˆã€‚æˆ‘ç¢°å·§è®°å¾—ï¼Œæˆ‘ä»¬ä½¿ç”¨17ä¸ºè¿™ä¸ªæ¨¡æ‹Ÿæ•ˆæœï¼Œä½†ä¸ºä»€ä¹ˆè¦ä¾èµ–äºå®ƒï¼Œå½“æˆ‘ä»¬å¯ä»¥ç”¨æˆ‘ä»¬è‡ªå·±çš„<strong>mock</strong>è¦†ç›–ç«¯ç‚¹ï¼Œè¿™æ˜¯æœ¬åœ°çš„æµ‹è¯•:</p>
<pre><code class="language-swift">Current.nthPrime = { _ in .sync { 17 } }
// â€¦
effects[0].sink(
  receiveCompletion: { _ in },
  receiveValue: { action in
    XCTAssertEqual(action, .counter(.nthPrimeResponse(17)))
})
</code></pre>
<p>ä½†æ˜¯ï¼Œå°½ç®¡è¿™ä¸ªæµ‹è¯•çœ‹èµ·æ¥ä¸é”™ï¼Œå®ƒå¯èƒ½ä¼šæ›´å¥½ã€‚åœ¨å¤„ç†æœ€å–œæ¬¢çš„ç´ æ•°<strong>effect</strong>æ—¶ï¼Œæˆ‘ä»¬è¿˜æµ‹è¯•äº†å®ƒä»¬æ˜¯å¦åƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·å®Œæˆï¼Œæˆ‘ä»¬ç”šè‡³æ•è·äº†è¯¥<strong>effect</strong>æ‰€å‘å‡ºçš„åŠ¨ä½œï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶åé¦ˆç»™<strong>reducer</strong>ã€‚è®©æˆ‘ä»¬è¯•ä¸€è¯•:</p>
<pre><code class="language-swift">var nextAction: CounterViewAction!
let receivedCompletion = self.expectation(description: &quot;receiveCompletion&quot;)
_ = effects[0].sink(
  receiveCompletion: { _ in receivedCompletion.fulfill() },
  receiveValue: { action in
    nextAction = action
    XCTAssertEqual(action, .counter(.nthPrimeResponse(17)))
})
self.wait(for: [receivedCompletion], timeout: 0.1)

effects = counterViewReducer(&amp;state, nextAction)
</code></pre>
<ul>
<li>Created an implicitly unwrapped CounterViewAction so that we could capture the action produced by the effect</li>
<li>Created an expectation</li>
<li>Fulfilled it when we received a completion event from the effect</li>
<li>Capture the action when we receive a value</li>
<li>Waited for the expectation to be fulfilled</li>
<li>And finally sent the action back into the reducer</li>
</ul>
<p>If we run this, we get a crash:</p>
<blockquote>
<p>ğŸ›‘ Fatal error: Unexpectedly found nil while implicitly unwrapping an Optional value</p>
</blockquote>
<p>çœ‹èµ·æ¥<strong>nextAction</strong>æ°¸è¿œä¸ä¼šè¢«è®¾ç½®ã€‚ä¸ºäº†äº†è§£åŸå› ï¼Œè®©æˆ‘ä»¬è·³åˆ°<strong>reducer</strong>ã€‚</p>
<pre><code class="language-swift">Current.nthPrime(state.count)
  .map(CounterAction.nthPrimeResponse)
  .receive(on: DispatchQueue.main)
  .eraseToEffect()
</code></pre>
<p>è¿™ä¸ª<strong>effect</strong>æ­£åœ¨åšä»¥å‰çš„<strong>effect</strong>éƒ½æ²¡æœ‰åšè¿‡çš„äº‹æƒ…:åœ¨å¦ä¸€ä¸ªé˜Ÿåˆ—ä¸Šè¿›è¡Œå·¥ä½œï¼Œè¿™éœ€è¦æ¯”æˆ‘ä»¬å½“å‰ç­‰å¾…çš„0ç§’æ›´å¤šçš„æ—¶é—´ã€‚</p>
<pre><code class="language-swift">self.wait(for: [receivedCompletion], timeout: 0.01)
</code></pre>
<p>æµ‹è¯•é€šè¿‡äº†ï¼Œç°åœ¨æˆ‘ä»¬æ­£åœ¨æµ‹è¯•<strong>effect</strong>çš„è¦†ç›–ç‡ã€‚è¿™å·²ç»å¾ˆä¸å¯æ€è®®äº†ã€‚æˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨æµ‹è¯•<strong>reducer</strong>æ˜¯å¦äº§ç”Ÿäº†è¿™æ ·ä¸€ç§<strong>effect</strong>ï¼Œå³å½“è¿è¡Œæ—¶äº§ç”Ÿäº†æˆ‘ä»¬æ‰€æœŸæœ›çš„åŠ¨ä½œã€‚ç„¶åï¼Œå½“æŠŠè¿™ä¸ªåŠ¨ä½œåé¦ˆç»™<strong>reducer</strong>æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ–­è¨€åº”ç”¨ç¨‹åºçš„çŠ¶æ€æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ã€‚</p>
<p>ä½†æˆ‘ä»¬è¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥ã€‚ç°åœ¨æˆ‘ä»¬æ§åˆ¶äº†è¿™ç§å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æµ‹è¯•ä¸€äº›è¾¹ç¼˜æƒ…å†µå’Œä¸æ„‰å¿«çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿå½“<strong>Wolfram Alpha API</strong>å‡ºç°é—®é¢˜æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œè¿™æ„å‘³ç€<strong>effect</strong>è¿”å›<strong>nil</strong>:</p>
<pre><code class="language-swift">func testNthPrimeButtonUnhappyFlow() {
  Current.nthPrime = { _ in .sync { nil } }
</code></pre>
<p>è¿™å°±æ˜¯æ¨¡æ‹Ÿæœ‰é”™è¯¯çš„APIæ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥å¤åˆ¶ç²˜è´´ä¹‹å‰çš„æµ‹è¯•ï¼Œåªåšä¸€äº›å°çš„æ”¹å˜:</p>
<pre><code class="language-swift">func testNthPrimeButtonUnhappyFlow() {
  Current.nthPrime = { _ in Effect(value: nil) }
  var state = CounterViewState(
    alertNthPrime: nil,
    count: 7,
    favoritePrimes: [2, 3],
    isNthPrimeButtonDisabled: false
  )

  var effects = counterViewReducer(&amp;state, .counter(.nthPrimeButtonTapped))
  XCTAssertEqual(
    state,
    CounterViewState(
      alertNthPrime: nil,
      count: 7,
      favoritePrimes: [2, 3],
      isNthPrimeButtonDisabled: true
    )
  )
  XCTAssertEqual(effects.count, 1)

  let receivedCompletion = self.expectation(description: &quot;receivedCompletion&quot;)
  var nextAction: CounterViewAction!
  _ = effects[0].sink(
    receiveCompletion: { _ in
      receivedCompletion.fulfill()
  },
    receiveValue: { action in
      nextAction = action
      XCTAssertEqual(action, .counter(.nthPrimeResponse(nil)))
  })
  self.wait(for: [receivedCompletion], timeout: 0.1)

  effects = counterViewReducer(&amp;state, nextAction)
  XCTAssertEqual(
    state,
    CounterViewState(
      alertNthPrime: nil,
      count: 7,
      favoritePrimes: [2, 3],
      isNthPrimeButtonDisabled: false
    )
  )
  XCTAssert(effects.isEmpty)
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æµ‹è¯•äº†æ•´ä¸ªç”¨æˆ·æµï¼Œå½“APIå¤±è´¥æ—¶ï¼Œç”¨æˆ·è¯•å›¾è¯·æ±‚â€œnä¸ªç´ æ•°â€ã€‚ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬è¦ç¡®ä¿<strong>alert</strong>ä¸æ˜¾ç¤ºï¼Œå¹¶ä¸”<strong>isNthPrimeButtonDisabled</strong>æ­£ç¡®åœ°ç¿»å›<strong>false</strong>ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¸å®ƒäº¤äº’ã€‚</p>
<h2 id="8-a-namenexttimetestergonomicsanext-time-test-ergonomics">8. <a name='Nexttime:testergonomics'></a>Next time: test ergonomics</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¼–å†™äº†ä¸€äº›çœŸæ­£å¼ºå¤§çš„æµ‹è¯•ã€‚æˆ‘ä»¬ä¸ä»…æµ‹è¯•å½“ç”¨æˆ·åœ¨UIä¸­åšå„ç§äº‹æƒ…æ—¶åº”ç”¨ç¨‹åºçš„çŠ¶æ€å¦‚ä½•æ¼”å˜ï¼Œè€Œä¸”è¿˜é€šè¿‡æ–­è¨€æ‰§è¡Œäº†æ­£ç¡®çš„<strong>effect</strong>å¹¶è¿”å›äº†æ­£ç¡®çš„æ“ä½œæ¥å¯¹<strong>effect</strong>è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦æåŠçš„æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨æ„å»ºç¯å¢ƒçš„æ–¹å¼å¹¶ä¸æ˜¯100%ç†æƒ³çš„ã€‚å®ƒå®Œæˆäº†è¿™ä¸ªåº”ç”¨ç¨‹åºçš„å·¥ä½œï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æƒ³è¦åœ¨è®¸å¤šç‹¬ç«‹æ¨¡å—ä¹‹é—´å…±äº«ä¸€ä¸ªä¾èµ–å…³ç³»ï¼Œå°±ä¼šé‡åˆ°é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„<strong>PrimeModal</strong>æ¨¡å—æƒ³è¦è®¿é—®<strong>FileClient</strong>ã€‚æˆ‘ä»¬åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½ä¸ºé‚£ä¸ªæ¨¡å—åˆ›å»ºä¸€ä¸ªæ–°çš„<strong>FileClient</strong>å®ä¾‹ï¼Œè¿™æ„å‘³ç€åº”ç”¨ç¨‹åºæœ‰ä¸¤ä¸ª<strong>FileClient</strong>ã€‚å¹¸è¿çš„æ˜¯ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¾ˆå¿«ä¼šåœ¨æœªæ¥çš„ä¸€é›†é‡Œåšè¿™ä¸ªã€‚</p>
<p>æˆ‘ä»¬çš„æµ‹è¯•çš„å¦ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹æ˜¯å®ƒä»¬éå¸¸ç¬¨é‡ã€‚æˆ‘ä»¬æœ€è¿‘ç¼–å†™çš„ä¸€äº›æµ‹è¯•è¶…è¿‡äº†60è¡Œ!å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åªç¼–å†™10ä¸ªæµ‹è¯•ï¼Œè¿™ä¸ªæ–‡ä»¶å°±å·²ç»è¶…è¿‡600è¡Œäº†ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çš„æµ‹è¯•æœ‰å¾ˆå¤šä»ªå¼ã€‚æˆ‘ä»¬å¿…é¡»:</p>
<ul>
<li>create expectations</li>
<li>run the effects</li>
<li>wait for expectations</li>
<li>fulfill expectations</li>
<li>capture the next action</li>
<li>assert what action we got and feed it back into the reducer.</li>
</ul>
<p>å¯¹äºæˆ‘ä»¬æ‰€æµ‹è¯•çš„æ¯ä¸ªæ•ˆæœæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸å¼ºçƒˆçš„é‡å¤ï¼Œå°±åƒæˆ‘ä»¬æ‰€æåˆ°çš„é‚£æ ·ï¼Œå®ƒç”šè‡³ä¸èƒ½æ•æ‰åˆ°æ‰€æœ‰çš„<strong>effect</strong>ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ä¸€äº›é¢å¤–çš„<strong>effect</strong>å‡ºç°ã€‚</p>
<p>ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥å…³æ³¨æœ€åŸºæœ¬çš„è¦ç´ :æˆ‘ä»¬éœ€è¦åšäº›ä»€ä¹ˆæ¥ç¡®å®šå¯¹æˆ‘ä»¬æ¶æ„çš„æœŸæœ›ã€‚å®ƒä¼¼ä¹å¯ä»¥å½’ç»“ä¸ºæä¾›ä¸€äº›åˆå§‹çŠ¶æ€ï¼Œæä¾›æˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„<strong>reducer</strong>ï¼Œç„¶ååœ¨è¿‡ç¨‹ä¸­æä¾›ä¸€ç³»åˆ—çš„åŠ¨ä½œå’ŒæœŸæœ›ï¼Œç†æƒ³æƒ…å†µä¸‹ä»¥å¸¦æœ‰å°‘é‡æ ·æ¿çš„å£°æ˜å¼æ–¹å¼â€¦â€¦ä¸‹æ¬¡å§!</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-82testable-state-management-reducers/">
                  <h3 class="post-title">
                    PointFree Episode 82:Testable State Management: Reducers
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
