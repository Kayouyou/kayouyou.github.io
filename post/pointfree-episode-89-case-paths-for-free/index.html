<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 89: Case Paths for Free | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1653141457723">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



Reflection in Swift




Reflecting into enums




Reflecting case paths




Reflection gotchas




Introducing the /..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1653141457723" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 89: Case Paths for Free</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#ReflectioninSwift">Reflection in Swift</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Reflectingintoenums">Reflecting into enums</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Reflectingcasepaths">Reflecting case paths</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Reflectiongotchas">Reflection gotchas</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Introducingtheoperator">Introducing the / operator</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#Whatsthepoint">Whatâ€™s the point?</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 89: Case Paths for Free -->
<h2 id="1-a-namereflectioninswiftareflection-in-swift">1. <a name='ReflectioninSwift'></a>Reflection in Swift</h2>
<p>è®©æˆ‘ä»¬ä»ç®€å•çš„å¼€å§‹ï¼Œå®ç°æˆ‘ä»¬åˆšæ‰æè¿°çš„ä¾‹å­: æˆ‘ä»¬å¸Œæœ›å®ç°è¿™æ ·ä¸€ä¸ªå‡½æ•°:å½“ç»™å®šä»»ä½•<strong>struct</strong>å€¼æ—¶ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œè¯¥æ•°ç»„åˆ—å‡ºäº†è¯¥å€¼ä¸­å­˜å‚¨çš„æ¯ä¸ªå±æ€§åã€‚ è¿™æ ·çš„å‡½æ•°å°†å…·æœ‰ä»¥ä¸‹ç‰¹å¾:</p>
<pre><code class="language-swift">func allProperties(_ value: Any) -&gt; [String] {
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ªåæ˜ æˆ‘ä»¬å€¼çš„é•œå­æ¥è®¿é—®Swiftçš„åå°„èƒ½åŠ›(æ˜ç™½å—?)</p>
<pre><code class="language-swift">func allProperties(_ value: Any) -&gt; [String] {
  let mirror = Mirror(reflecting: value)
}
</code></pre>
<p>è¿™ä¸ªé•œåƒå€¼ä¿å­˜æœ‰å…³ä¼ å…¥å€¼å†…éƒ¨å†…å®¹çš„ä¿¡æ¯ã€‚ ç‰¹åˆ«æ˜¯ï¼Œæœ‰ä¸€ä¸ªå­å±æ€§:</p>
<blockquote>
<p>A collection of Child elements describing the structure of the reflected subject.</p>
</blockquote>
<p>è¿™æœ‰ç‚¹å«ç³Šä¸æ¸…ï¼Œä½†æ­£æ˜¯è¿™ä¸ªé›†åˆä¿å­˜äº†ç»“æ„ä½“ä¸­æœ‰å…³storeå±æ€§çš„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥æ˜ å°„è¿™ä¸ªé›†åˆï¼Œè¯•å›¾ä»æ¯ä¸ªå­å…ƒç´ ä¸­æå–ä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿:</p>
<pre><code class="language-swift">func allProperties(_ value: Any) -&gt; [String] {
  let mirror = Mirror(reflecting: value)
  mirror.map { child in }
}
</code></pre>
<p>æ¯ä¸ªå­å…ƒç´ éƒ½æœ‰ä¸€ä¸ª<strong>label</strong>å±æ€§å’Œ<strong>value</strong>å±æ€§ã€‚<strong>label</strong>çœ‹èµ·æ¥å¾ˆæœ‰å‰é€”ï¼Œä½†å®ƒè¿”å›ä¸€ä¸ªå¯é€‰çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸçš„éœ€è¦ä¸€ä¸ª<strong>compactMap</strong>ï¼Œè®©æˆ‘ä»¬ä»å‡½æ•°ä¸­è¿”å›è¿™ä¸ªå€¼:</p>
<pre><code class="language-swift">func allProperties(_ value: Any) -&gt; [String] {
  return Mirror(reflecting: value).children
    .compactMap { $0.label }
}
</code></pre>
<p>ç„¶åï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒä¼¼ä¹æ˜¯æœ‰æ•ˆçš„:</p>
<pre><code class="language-swift">allProperties(users) // [&quot;id&quot;, &quot;isAdmin&quot;, &quot;location&quot;, &quot;name&quot;]
</code></pre>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ä¸çŸ¥é“è¿™æ˜¯å¦é€‚ç”¨äºäº¤ç»™è¯¥å‡½æ•°çš„æ‰€æœ‰ç»“æ„ä½“ã€‚Swiftçš„åå°„APIéå¸¸ç®€å•ï¼Œæ–‡æ¡£ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥ä¸æ¸…æ¥šè¿™æ˜¯å¦å¯èƒ½è¿”å›æ›´å¤šä¿¡æ¯ï¼Œæ¯”å¦‚è®¡ç®—å±æ€§ã€‚</p>
<p>è¿™å°±æ˜¯ä½¿ç”¨åå°„çš„ä»£ä»·ã€‚é€šè¿‡åœ¨è¿è¡Œæ—¶åçœæˆ‘ä»¬çš„<strong>values</strong>ï¼Œå®ƒç»™æˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šåŠ›é‡ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šä¸ç¡®å®šæ€§ã€‚</p>
<hr>
<h2 id="2-a-namereflectingintoenumsareflecting-into-enums">2. <a name='Reflectingintoenums'></a>Reflecting into enums</h2>
<p>æœ‰äº†è¿™äº›è­¦å‘Šï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åå°„å‘æˆ‘ä»¬æ­ç¤ºäº†å…³äºæšä¸¾çš„ä»€ä¹ˆã€‚è®©æˆ‘ä»¬æ„é€ ä¸€ä¸ª<strong>Authenticated</strong>ç±»å‹çš„å€¼:</p>
<pre><code class="language-swift">let auth = Authentication.authenticated(AccessToken(token: &quot;deadbeef&quot;))
</code></pre>
<p>åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé•œåƒæ¥åå°„å€¼æ¥è®¿é—®å®ƒçš„å±æ€§:</p>
<pre><code class="language-swift">let mirror = Mirror(reflecting: auth)
</code></pre>
<p>ç»“æœæ˜¯è¿™ä¸ªå­é›†åˆåªåŒ…å«ä¸€ä¸ªå€¼:</p>
<pre><code class="language-swift">mirror.children.count // 1
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æ‰“å°è¿™ä¸ªå”¯ä¸€çš„å­å…ƒç´ ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿:</p>
<pre><code class="language-swift">dump(mirror.children.first!)
â–¿ (2 elements)
  â–¿ label: Optional(&quot;authenticated&quot;)
    - some: &quot;authenticated&quot;
  â–¿ value: __lldb_expr_7.AccessToken
    - token: &quot;deadbeef&quot;
</code></pre>
<p>æœ‰è¶£çš„æ˜¯ï¼Œé•œåƒä¸ä»…å‘æˆ‘ä»¬æ˜¾ç¤ºäº†æšä¸¾ä¸­ä¿å­˜çš„æ•°æ®(åŒ…å«å­—ç¬¦ä¸²â€œdeadbeefâ€çš„è®¿é—®ä»¤ç‰Œ)ï¼Œè€Œä¸”è¿˜æ˜¾ç¤ºäº†è¯¥å€¼æ‰€åœ¨çš„<strong>case</strong>çš„åç§°(â€œauthenticatedâ€)ã€‚è¿™ä¸ªä¿¡æ¯è¢«ä¿å­˜åœ¨ä¸€ä¸ªåŒ…å«å‘½åç»„ä»¶çš„å…ƒç»„ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¿›å…¥å€¼ç»„ä»¶ï¼Œå°±ä¼šå¾—åˆ°è®¿é—®ä»¤ç‰Œ:</p>
<pre><code class="language-swift">mirror.children.first!.value
//AccessToken
</code></pre>
<p>ç„¶è€Œï¼Œè¿™æ˜¯ä¸€ç§è¯¯å¯¼ã€‚æˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªçœŸå®çš„<strong>AccessToken</strong>å€¼ï¼Œé•œåƒæ²¡æœ‰ä»»ä½•ç±»å‹ä¿¡æ¯:</p>
<pre><code class="language-swift">mirror.children.first!.value as AccessToken
</code></pre>
<blockquote>
<p>ğŸ›‘ â€˜Anyâ€™ is not convertible to â€˜AccessTokenâ€™</p>
</blockquote>
<p>è¿™é‡Œçš„å€¼çš„ç±»å‹æ˜¯<strong>Any</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½åšçš„æœ€å¥½çš„æ˜¯å°è¯•å°†å®ƒè½¬æ¢ä¸º<strong>AccessToken</strong>:</p>
<pre><code class="language-swift">mirror.children.first!.value as? AccessToken
</code></pre>
<p>æˆ‘ä»¬å·²ç»å¼€å§‹äº†è§£å¦‚ä½•ä½¿ç”¨åå°„å®ç°æå–å‡½æ•°ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°ï¼Œä»…ä»…ç»™å®šå€¼ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæœ€ç»ˆä»å€¼ä¸­è·å¾—è®¿é—®ä»¤ç‰Œã€‚æ²¡æœ‰å¼€å…³ï¼Œæ¶‰åŠ<strong>if case lets or guard case let</strong>ï¼Œåªæœ‰åå°„é•œã€‚</p>
<p>è®©æˆ‘ä»¬å°è¯•å®ç°ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå®ƒèƒ½å¤Ÿä»æ ¹æšä¸¾å€¼ä¸­æå–ç›¸å…³çš„å€¼:</p>
<pre><code class="language-swift">func extract&lt;Root, Value&gt;(from root: Root) -&gt; Value? {
}
</code></pre>
<p>å®ƒçš„å®ç°åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢æ‰€åšçš„ã€‚æˆ‘ä»¬éœ€è¦è·å–æ ¹èŠ‚ç‚¹çš„é•œåƒï¼Œå°è¯•è·å–é•œåƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå–å‡ºè¯¥å­èŠ‚ç‚¹çš„å€¼ï¼Œç„¶åå°è¯•å°†å…¶è½¬æ¢ä¸º<strong>value</strong>ç±»å‹:</p>
<pre><code class="language-swift">func extract&lt;Root, Value&gt;(from root: Root) -&gt; Value? {
  let mirror = Mirror(reflecting: root)
  guard let child = mirror.children.first else { return nil }
  return child.value as? Value
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬å°è¯•ä½¿ç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åœ¨ç±»å‹ä¸­æœ‰ä¸€äº›æ­§ä¹‰:</p>
<pre><code class="language-swift">extract(from: auth)
</code></pre>
<blockquote>
<p>ğŸ›‘ Generic parameter â€˜Valueâ€™ could not be inferred</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æä¾›ä»»ä½•ä¿¡æ¯æ¥è®©å®ƒçŸ¥é“æˆ‘ä»¬æƒ³ä»æ ¹å€¼ä¸­æå–ä»€ä¹ˆã€‚æˆ‘ä»¬å¯ä»¥å‘Šè¯‰å®ƒæˆ‘ä»¬æœŸæœ›ç¼–è¯‘ä»€ä¹ˆç±»å‹çš„ä¸œè¥¿:</p>
<pre><code class="language-swift">extract(from: auth) as AccessToken?
</code></pre>
<p>ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œè¿™å¾ˆæœ‰æ•ˆï¼Œä½†å½“ç„¶è¿™å¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å‘Šè¯‰å®ƒæˆ‘ä»¬æƒ³ä»æ ¹ä¸­æå–ä»€ä¹ˆç±»å‹ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰å‘Šè¯‰å®ƒåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ã€‚è¿™æ˜¯æˆ‘ä»¬ç°åœ¨å¿½ç•¥çš„éå¸¸é‡è¦çš„ä¿¡æ¯ã€‚ä¸¾ä¸ªæ„šè ¢çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæšä¸¾ï¼Œä¸¤ä¸ªå…³è”çš„å€¼éƒ½æ˜¯æ•´æ•°:</p>
<pre><code class="language-swift">enum Example {
  case foo(Int)
  case bar(Int)
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æƒ³ä»<strong>Example</strong>ç±»å‹çš„å€¼ä¸­æå–ä¸€ä¸ªæ•´å‹ï¼Œæˆ‘ä»¬æ— æ³•è¯´æ˜æˆ‘ä»¬å¸Œæœ›ä»å“ªç§æƒ…å†µä¸­è·å–æ•´å‹:</p>
<pre><code class="language-swift">extract(from: Example.foo(2)) as Int?
</code></pre>
<p>è¿™ä¸ªAPIä¸­æ²¡æœ‰ä»»ä½•ä¸œè¥¿å…è®¸æˆ‘ä»¬è¯´æˆ‘ä»¬æƒ³è¦<strong>bar case</strong>ä¸‹çš„æ•´æ•°ï¼Œè€Œä¸æ˜¯<strong>foo case</strong>ä¸‹çš„æ•´æ•°ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°†è¿™ç§æƒ…å†µåˆå¹¶åˆ°è¿™ä¸ªæå–å‡½æ•°ä¸­å‘¢? è®°ä½ï¼Œé•œåƒç»™äº†æˆ‘ä»¬è®¿é—®<strong>case</strong>çš„åç§°ï¼Œå®ƒåœ¨å­å…ƒç»„çš„æ ‡ç­¾ç»„ä»¶ä¸­:</p>
<pre><code class="language-swift">mirror.children.first!.label // &quot;authenticated&quot;
</code></pre>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶æ„šè ¢çš„äº‹æƒ…æ˜¯è®©<strong>extract</strong>å‡½æ•°å–æˆ‘ä»¬æƒ³è¦æå–çš„<strong>case</strong>çš„åç§°ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°çš„å®ç°ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯:</p>
<pre><code class="language-swift">func extract&lt;Root, Value&gt;(case: String, from root: Root) -&gt; Value? {
  let mirror = Mirror(reflecting: root)
  guard let child = mirror.children.first else { return nil }
  guard `case` == child.label else { return nil }
  return child.value as? Value
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰èƒ½åŠ›ç¡®åˆ‡åœ°æŒ‡å®šæˆ‘ä»¬æƒ³ä»ä¸­æå–çš„æƒ…å†µ:</p>
<pre><code class="language-swift">extract(case: &quot;foo&quot;, from: Example.foo(2)) as Int? // 2
extract(case: &quot;bar&quot;, from: Example.foo(2)) as Int? // nil
</code></pre>
<p>ç„¶è€Œï¼Œ<strong>stringy API</strong>å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬å¯èƒ½ä¼šå¼•å…¥ä¸€ä¸ªæ‰“å­—é”™è¯¯ï¼Œè€Œç¼–è¯‘å™¨ä¸ä¼šæ•æ‰åˆ°å®ƒï¼Œå¦‚æœæˆ‘ä»¬ç¨åé‡æ„<strong>case names</strong>ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½ä¼šæ— å£°åœ°ä¸­æ–­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è®¿é—®ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚è¿™ä¸ªå­—ç¬¦ä¸²çš„é™æ€ç‰ˆæœ¬ã€‚enumçš„caseæ˜¯ç¼–è¯‘å™¨çŸ¥é“çš„é™æ€ç¬¦å·ï¼Œåç§°ä¸­çš„ä»»ä½•æ‹¼å†™é”™è¯¯éƒ½ä¼šç«‹å³å¯¼è‡´ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯:</p>
<pre><code class="language-swift">Example.foo // (Int) -&gt; Example
Example.bar // (Int) -&gt; Example
</code></pre>
<p>æ‰€ä»¥ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªé™æ€ä¿¡æ¯è€Œä¸æ˜¯å­—ç¬¦ä¸²æ¥å†³å®šæˆ‘ä»¬è®¡åˆ’ä»å“ªä¸ªcaseä¸­æå–:</p>
<pre><code class="language-swift">func extract&lt;Root, Value&gt;(
  case: (Value) -&gt; Root,
  from root: Root
) -&gt; Value? {
  let mirror = Mirror(reflecting: root)
  guard let child = mirror.children.first else { return nil }
  guard `case` == child.label else { return nil }
  return child.value as? Value
}
</code></pre>
<p>ç°åœ¨ç›´æ¥æ£€æŸ¥caseæ ‡ç­¾ä¸å†æœ‰æ•ˆï¼Œå› ä¸ºcaseæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬æ€æ ·æ‰èƒ½ç¡®å®š<strong>child.value</strong>æ˜¯å¦ä¸ä¼ å…¥çš„caseå‡½æ•°æè¿°çš„æƒ…å†µç›¸åŒ?</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨caseå‡½æ•°æ¥æŠŠ<strong>child.Value</strong>è¿”å›åˆ°æ ¹ç›®å½•ï¼Œåå°„è¿™ä¸ªæ–°çš„rootï¼Œå¹¶ç¡®å®šæ–°æ ¹æ˜¯å¦ä¸å½“å‰çš„å­èŠ‚ç‚¹ç›¸åŒã€‚å¬èµ·æ¥å¾ˆå¤šï¼Œä½†åšèµ·æ¥å¾ˆç®€å•:</p>
<pre><code class="language-swift">func extract&lt;Root, Value&gt;(
  case: @escaping (Value) -&gt; Root,
  from root: Root
) -&gt; Value? {
  let mirror = Mirror(reflecting: root)
  guard let child = mirror.children.first else { return nil }
  guard let value = child.value as? Value else { return nil }

  let newRoot = `case`(value)
  let newMirror = Mirror(reflecting: newRoot)
  guard let newChild = newMirror.children.first else { return nil }

  guard newChild.label == child.label else { return nil }

  return value
}
</code></pre>
<hr>
<h2 id="3-a-namereflectingcasepathsareflecting-case-paths">3. <a name='Reflectingcasepaths'></a>Reflecting case paths</h2>
<p>å°±åƒè¿™æ ·ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªAPIï¼Œå…è®¸æˆ‘ä»¬é™æ€åœ°ç¡®å®šæˆ‘ä»¬è¯•å›¾ä»enumä¸­æå–å“ªç§æƒ…å†µ:</p>
<pre><code class="language-swift">extract(case: Authentication.authenticated, from: auth) // AccessToken
extract(case: Authentication.authenticated, from: .unauthenticated) // nil

extract(case: Result&lt;Int, Error&gt;.success, from: .success(42)) // 42

struct MyError: Error {}

extract(case: Result&lt;Int, Error&gt;.failure, from: .failure(MyError())) // MyError

extract(case: Example.foo, from: .foo(2)) // 2
extract(case: Example.bar, from: .foo(2)) // nil
</code></pre>
<p>è¿™ä¼¼ä¹å¾ˆæœ‰æ•ˆ! ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç‰¹å®šæƒ…å†µä¸‹çš„æšä¸¾å€¼æå–ç›¸å…³å€¼ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡çŸ¥é“åµŒå…¥å‡½æ•°æ˜¯ä»€ä¹ˆæ¥ç¥å¥‡åœ°å…è´¹åˆ›å»ºcaseè·¯å¾„ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨CasePathä¸Šåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„åˆå§‹åŒ–å™¨ï¼Œå®ƒåªåœ¨ç»™å®šçš„åµŒå…¥å‡½æ•°ä¸­èµ·ä½œç”¨:</p>
<pre><code class="language-swift">extension CasePath {
  init(_ case: @escaping (Value) -&gt; Root) {
    self.embed = `case`
    self.extract = { root in
      extractHelp(case: `case`, from: root)
    }
  }
}
</code></pre>
<p>ä¸ºäº†é¿å…ä¸å®ä¾‹å˜é‡<strong>extract</strong>æ··æ·†ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»é‡å‘½åæˆ‘ä»¬çš„<strong>extract</strong>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©äº†<strong>extractHelp</strong>:</p>
<pre><code class="language-swift">func extractHelp&lt;Root, Value&gt;(
  case: @escaping (Value) -&gt; Root,
  from root: Root
) -&gt; Value? {
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“åœ°åœ¨è¿è¡Œä¸­åˆ›å»ºæ¡ˆä¾‹è·¯å¾„:</p>
<pre><code class="language-swift">CasePath(Example.foo)
CasePath(Example.bar)
CasePath(Authentication.authenticated)
</code></pre>
<p>è¿™çœ‹èµ·æ¥çœŸçš„å¾ˆå¥½ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥ä»æ—©äº›æ—¶å€™çš„æƒ…èŠ‚åˆ é™¤å¤§é‡é‡å¤çš„ä»£ç ï¼Œä½†æ— è®ºä½•æ—¶æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æšä¸¾æˆ–é‡åˆ°ä¸€ä¸ªæ¥è‡ªç¬¬ä¸‰æ–¹ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…æ¥è·å–æ¯ä¸ªcaseçš„<strong>case paths</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä¸åšåŠŸå°±ç›´æ¥æ¨å¯¼å‡ºå®ƒä»¬ã€‚</p>
<hr>
<h2 id="4-a-namereflectiongotchasareflection-gotchas">4. <a name='Reflectiongotchas'></a>Reflection gotchas</h2>
<p>ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªå·¨å¤§çš„è­¦å‘Šã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œä»»ä½•æ—¶å€™å¤„ç†åå°„é—®é¢˜éƒ½æ˜¯å¦‚å±¥è–„å†°ã€‚é¦–å…ˆï¼ŒSwiftçš„åå°„æ–‡æ¡£ç›¸å½“ç¨€ç–ï¼Œå…¶æ¬¡ï¼Œé€šè¿‡ä½¿ç”¨åå°„ï¼Œæˆ‘ä»¬è¶…å‡ºäº†ç¼–è¯‘å™¨çš„ç›‘è§†èŒƒå›´ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é™æ€ä¿è¯æˆ‘ä»¬æ­£ç¡®åœ°ç¼–å†™äº†æå–åŠ©æ‰‹ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå®ƒç°åœ¨ä¸æ˜¯å¾ˆæ­£ç¡®ã€‚ç›®å‰çš„å®ç°ä¸æ”¯æŒä¸€äº›è¾¹ç¼˜æƒ…å†µã€‚é¦–å…ˆï¼Œå¦‚æœåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ä½¿ç”¨å‚æ•°æ ‡ç­¾ï¼Œæå–åŠ©æ‰‹å°†æ€»æ˜¯å¤±è´¥:</p>
<pre><code class="language-swift">enum ExampleWithArgumentLabels {
  case foo(value: Int)
}

extractHelp(case: ExampleWithArgumentLabels.foo, from: .foo(value: 2)) // nil
</code></pre>
<p>è™½ç„¶å®ƒåº”è¯¥ä¼šæˆåŠŸï¼Œä½†å´å¤±è´¥äº†ã€‚ è¿™æ˜¯å¯èƒ½çš„ï¼Œäº‹å®ä¸Šå¾ˆå®¹æ˜“è§£å†³çš„ï¼Œä½†æˆ‘ä»¬å°†æŠŠå®ƒç•™ç»™è§‚ä¼—ä½œä¸ºç»ƒä¹ ã€‚</p>
<p>è¿˜æœ‰å¦ä¸€ç§è¾¹ç•Œæƒ…å†µï¼Œå³æ²¡æœ‰å…³è”å€¼çš„æšä¸¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„<strong>extract helper</strong>ç”šè‡³ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºæ²¡æœ‰å…³è”å€¼çš„enumç”šè‡³ä¸æ˜¯å‡½æ•°:</p>
<pre><code class="language-swift">extractHelp(case: Authentication.unauthenticated, from: .unauthenticated)
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜Authenticationâ€™ to expected argument type â€˜(_) -&gt; _â€™</p>
</blockquote>
<p>è¿™æ˜¯å¦ä¸€ä¸ªè¦è§£å†³çš„è¾¹ç•Œæƒ…å†µï¼Œè¿™æ˜¯å®Œå…¨å¯èƒ½çš„ã€‚</p>
<p>å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ³¨æ„äº‹é¡¹æ˜¯ï¼Œåªæœ‰å½“æ‚¨ç»™CasePathä¸€ä¸ªå®é™…çš„æšä¸¾æƒ…å†µçš„åµŒå…¥å‡½æ•°æ—¶ï¼Œè¿™ç§åå°„é­”æœ¯æ‰ä¼šèµ·ä½œç”¨ã€‚å®ƒå¹¶ä¸æ„å‘³ç€åœ¨ä»»ä½•å…¶ä»–æƒ…å†µä¸‹éƒ½èƒ½ç¥å¥‡åœ°å‘æŒ¥ä½œç”¨ã€‚ä½œä¸ºä¸€ä¸ªæ„šè ¢çš„ä¾‹å­ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬è¯•å›¾æ„å»ºä¸€ä¸ªcaseè·¯å¾„åˆ°ä¸€ä¸ªåœ°ç‚¹çš„å›½å®¶ã€‚</p>
<pre><code class="language-swift">let countryCasePath = CasePath&lt;Location, String&gt;(
  { country in Location(city: &quot;Brooklyn&quot;, country: country) }
)
</code></pre>
<p>è¿™å½“ç„¶å¾ˆæ„šè ¢ï¼Œå› ä¸º<strong>Location</strong>æ˜¯ä¸€ä¸ªç»“æ„ï¼Œæ‰€ä»¥ä½¿ç”¨é”®è·¯å¾„æ¥å…³æ³¨å®ƒçš„éƒ¨åˆ†æ¯”caseè·¯å¾„æ›´åˆé€‚ã€‚ ä½†æ˜¯ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢æˆ‘ä»¬ç¼–å†™è¿™ä¸ªå¥‡æ€ªçš„ä»£ç ã€‚å¦‚æœæˆ‘ä»¬è¿™æ ·åšï¼Œcaseè·¯å¾„å°±ä¸ä¼šåƒæˆ‘ä»¬æœŸæœ›çš„é‚£æ ·:</p>
<pre><code class="language-swift">countryCasePath.extract(from: Location(city: &quot;Brooklyn&quot;, country: &quot;USA&quot;))
// &quot;Brooklyn&quot;
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¯•å›¾ä½¿ç”¨å›½å®¶caseè·¯å¾„å°†å›½å®¶ä»ä¸€ä¸ªä½ç½®æå–å‡ºæ¥ï¼Œä½†å®ƒè¿”å›â€œ<strong>Brooklyn</strong>â€ã€‚è¿™å½“ç„¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½†æˆ‘ä»¬å¹¶ä¸æ‰“ç®—ä¸ºè¿™äº›æƒ…å†µåˆ›å»ºcaseè·¯å¾„ã€‚</p>
<p>ä½†æ’‡å¼€æ‰€æœ‰è¿™äº›ä¸è°ˆï¼Œæˆ‘ä»¬å·²ç»å¤§å¤§æ”¹è¿›äº†åˆ›é€ caseè·¯å¾„çš„äººæœºå·¥ç¨‹å­¦ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°åœ¨<strong>CasePath</strong>åˆå§‹åŒ–å¼ä¸­å°è£…ä¸€ä¸ªenum caseæ„é€ å‡½æ•°ï¼Œç„¶åç«‹å³å¾—åˆ°ä¸€ä¸ªcaseè·¯å¾„ã€‚ä¾‹å¦‚ï¼ŒResultå’ŒOptionalç±»å‹æ˜¯enumï¼Œæˆ‘ä»¬ç«‹å³è·å¾—å®ƒä»¬çš„caseè·¯å¾„ï¼Œä¸ä»…åœ¨å®ƒä»¬çš„caseä¸Šï¼Œè€Œä¸”åœ¨ä»»ä½•é€šç”¨çš„æƒ…å†µä¸‹:</p>
<pre><code class="language-swift">CasePath(Result&lt;Int, Error&gt;.success)
CasePath(Result&lt;String, Error&gt;.success)
CasePath(Result&lt;String, Error&gt;.failure)
CasePath(Result&lt;String, NSError&gt;.failure)

CasePath(Optional&lt;Int&gt;.some)
CasePath(Optional&lt;String&gt;.some)
CasePath(Optional&lt;[Int]&gt;.some)
</code></pre>
<p>è¿™é‡Œæœ‰å¤§é‡çš„æšä¸¾ï¼Œä¸ä»…åœ¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç ä¸­ï¼Œä¹Ÿåœ¨ç¬¬ä¸‰æ–¹ä»£ç ä¸­ï¼Œæ¯”å¦‚è‹¹æœçš„æ¡†æ¶ä¸­ã€‚Foundationæä¾›äº†ä¸€ä¸ªåä¸º<strong>DispatchTimeInterval</strong>çš„ç¨‹åºï¼Œå®ƒæè¿°äº†ä»¥ç§’ã€æ¯«ç§’ã€å¾®ç§’å’Œçº³ç§’ä¸ºå•ä½çš„æ—¶é—´é—´éš”ï¼Œæˆ‘ä»¬å¯ä»¥å…è´¹è·å¾—æ‰€æœ‰è¿™äº›æƒ…å†µçš„è·¯å¾„:</p>
<pre><code class="language-swift">CasePath(DispatchTimeInterval.seconds)
CasePath(DispatchTimeInterval.milliseconds)
CasePath(DispatchTimeInterval.microseconds)
CasePath(DispatchTimeInterval.nanoseconds)
</code></pre>
<p>ç”šè‡³è¿Combineæ¡†æ¶ä¹Ÿæœ‰è‡ªå·±çš„ä¸€äº›æšä¸¾ï¼Œæ¯”å¦‚æè¿°<strong>publisher</strong>å®Œæˆæ–¹å¼çš„<strong>Completion</strong>æšä¸¾ã€‚æˆ‘ä»¬å…è´¹è·å¾—caseè·¯å¾„:</p>
<pre><code class="language-swift">CasePath(Subscribers.Completion&lt;Error&gt;.failure)
</code></pre>
<hr>
<h2 id="5-a-nameintroducingtheoperatoraintroducing-the-operator">5. <a name='Introducingtheoperator'></a>Introducing the / operator</h2>
<p>è¿™çœŸçš„å¾ˆæ£’ï¼Œä½†æˆ‘ä»¬å¯ä»¥è®©äººä½“å·¥ç¨‹å­¦æ›´å¥½ã€‚è®©æˆ‘ä»¬æŠŠä¸€ä¸ªå…³é”®è·¯å¾„å’Œä¸€ä¸ªcaseè·¯å¾„æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°è¯­æ³•ä¸Šçš„åŒºåˆ«:</p>
<pre><code class="language-swift">\User.id
CasePath(DispatchTimeInterval.seconds)
</code></pre>
<p>çœ‹èµ·æ¥ä¸å¤ªå¯¹ç§°ã€‚å¦‚æœæˆ‘ä»¬èƒ½è®©caseè·¯å¾„çš„è¯­æ³•çœ‹èµ·æ¥æ›´åƒé”®è·¯å¾„ï¼Œé‚£å°±å¤ªå¥½äº†ã€‚å¦‚æœæœ‰å¯èƒ½å¼•å…¥ä¸€ä¸ªå‰ç¼€æ“ä½œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åœ¨enumä¹‹å‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¶ˆé™¤CasePathå¹²æ‰°? æˆ‘ä»¬ä¸ä»…å¯ä»¥è¿™æ ·åšï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ­£æ–œæ ä½œä¸ºæ“ä½œç¬¦ï¼Œä½¿å®ƒçœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre><code class="language-swift">\User.id
/DispatchTimeInterval.seconds
</code></pre>
<p>é‚£å°±å¤ªæ£’äº†ã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦å£°æ˜ä¸€ä¸ªæ–°çš„æ“ä½œç¬¦:</p>
<pre><code class="language-swift">prefix operator /
</code></pre>
<p>ç„¶åç”¨å®ƒå®šä¹‰ä¸€ä¸ªå‰ç¼€å‡½æ•°ï¼Œç®€å•åœ°åœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ªCasePath:</p>
<pre><code class="language-swift">prefix func / &lt;Root, Value&gt;(
  case: @escaping (Value) -&gt; Root
) -&gt; CasePath&lt;Root, Value&gt; {
  return CasePath(`case`)
}
</code></pre>
<p>ç°åœ¨å®Œå…¨å¯ä»¥è¿™ä¹ˆåšäº†:</p>
<pre><code class="language-swift">\User.id
/DispatchTimeInterval.seconds
</code></pre>
<p>é”®è·¯å¾„åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šä½¿ç”¨æ–œçº¿ï¼Œè€Œcaseè·¯å¾„åœ¨å¦ä¸€ä¸ªæ–¹å‘ä¸Šä½¿ç”¨æ–œçº¿ã€‚æ¯•ç«Ÿï¼Œå®ƒä»¬æ˜¯ä¸åŒä½†ç›¸ç­‰çš„æ“ä½œã€‚ä¸€æšç¡¬å¸çš„ä¸¤é¢ã€‚å¦‚æœä½ æ„¿æ„çš„è¯ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªå‰ç¼€æ“ä½œç¬¦ä¸å¤åˆæ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åšæ›´å¼ºå¤§çš„äº‹æƒ…ï¼Œæ¯”å¦‚æ„é€ ä¸€ä¸ªéå†æšä¸¾æˆåŠŸçš„caseè·¯å¾„ï¼Œç„¶åæ˜¯è°ƒåº¦é—´éš”çš„ç§’æ•°:</p>
<pre><code class="language-swift">/Result&lt;DispatchTimeInterval, Error&gt;.success .. /DispatchTimeInterval.seconds
</code></pre>
<p>ä½†æ˜¯æˆ‘ä»¬å·²ç»å¼•å…¥äº†å¦ä¸€ä¸ªæ“ä½œç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥é—®è‡ªå·±å®ƒæ˜¯å¦æ»¡è¶³æˆ‘ä»¬å¸Œæœ›æ“ä½œç¬¦æ»¡è¶³çš„è¦æ±‚ã€‚</p>
<ul>
<li>æˆ‘ä»¬æ˜¯å¦é‡è½½äº†å…·æœ‰æ–°å«ä¹‰çš„ç°æœ‰æ“ä½œç¬¦? /æ˜¯ä¸€ä¸ªä¸­ç¼€æ“ä½œç¬¦ï¼Œåœ¨Swiftä¸­è¡¨ç¤ºé™¤æ³•ï¼Œä½†å®ƒä¸ä½œä¸ºå‰ç¼€æ“ä½œç¬¦å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¤ªå¯èƒ½é€ æˆ/çš„é¢å¤–ä¸­ç¼€ä½¿ç”¨æ‰€é€ æˆçš„æ··æ·†ã€‚</li>
<li>å‰ç¼€/æœ‰ç°æœ‰æŠ€æœ¯å—? ä¸å®Œå…¨æ˜¯ï¼Œä½†å¦‚æœæˆ‘ä»¬è€ƒè™‘åˆ°å®ƒæ˜¯Swiftç”¨æ¥è¯†åˆ«å…³é”®è·¯å¾„çš„\çš„é•œåƒï¼Œå®ƒçš„å½¢çŠ¶ä¼¼ä¹éå¸¸å®Œç¾ã€‚</li>
<li>å®ƒæ˜¯è§£å†³äº†ä¸€ä¸ªæ™®éçš„é—®é¢˜ï¼Œè¿˜æ˜¯å®ƒè§£å†³çš„é—®é¢˜æ›´ç‰¹å®šäºæŸä¸ªé¢†åŸŸ? å®ƒå¯ä»¥è®©æˆ‘ä»¬å¾ˆå®¹æ˜“åœ°ï¼Œç”¨ä¸€ä¸ªå•ä¸€çš„è§’è‰²ï¼Œå‡­ç©ºå¾—å‡ºcaseè·¯å¾„ã€‚Swiftåœ¨è¯­è¨€çº§åˆ«ä¸ºç»“æ„ä½“é”®è·¯å¾„æä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥ç±»ä¼¼çš„æšä¸¾è·¯å¾„è§£å†³æ–¹æ¡ˆä¼¼ä¹æ˜¯åˆç†çš„ã€‚</li>
</ul>
<p>è¿™æ˜¯å¦ä¸€ä¸ªä¸å®Œå…¨å‹¾é€‰æ‰€æœ‰æ–¹æ¡†çš„è¿ç®—ç¬¦ã€‚è™½ç„¶æˆ‘ä»¬å–œæ¬¢å®ƒåœ¨å…³é”®è·¯å¾„å’Œcaseè·¯å¾„ä¹‹é—´æ¶èµ·äº†äººæœºå·¥ç¨‹å­¦çš„æ¡¥æ¢ï¼Œä½†æˆ‘ä»¬çŸ¥é“ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½æ„¿æ„å°†æ“ä½œç¬¦å¼•å…¥ä»–ä»¬çš„ä»£ç åº“ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¯¥æ“ä½œä»ç„¶å¯ä»¥ä½œä¸ºCasePathä¸Šçš„åˆå§‹åŒ–å™¨å¼•å…¥ï¼Œå› æ­¤æ‚¨ä»ç„¶å¯ä»¥ä»å¼ºå¤§çš„åŠŸèƒ½ä¸­å—ç›Šï¼Œåªéœ€è¦å¢åŠ ä¸€ç‚¹é¢å¤–çš„å™ªéŸ³ã€‚</p>
<hr>
<h2 id="6-a-namewhatsthepointawhats-the-point">6. <a name='Whatsthepoint'></a>Whatâ€™s the point?</h2>
<p>è®©æˆ‘ä»¬èŠ±ä¸€ç‚¹æ—¶é—´æ¥ä½“éªŒcaseè·¯å¾„çš„ä¹è¶£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç†Ÿæ‚‰caseè·¯å¾„çš„æ—…ç¨‹äº†ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€äº›æšä¸¾ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨æ‘†å¼„å®ƒä»¬ã€‚è®©æˆ‘ä»¬å†å®šä¹‰ä¸€äº›ï¼Œè®©äº‹æƒ…æ›´æœ‰è¶£ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé€šç”¨çš„enumæ¥è¡¨ç¤ºæŸäº›æ•°æ®çš„åŠ è½½çŠ¶æ€:</p>
<pre><code class="language-swift">enum LoadState&lt;A&gt; {
  case loading
  case offline
  case loaded(Result&lt;A, Error&gt;)
}
</code></pre>
<p>é€šè¿‡caseè·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è¡¨è¾¾è¿™æ ·çš„æƒ³æ³•:åœ¨è¿™ä¸ªenumçš„åŠ è½½æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦å…³æ³¨ç»“æœçš„æˆåŠŸæ¡ˆä¾‹:</p>
<pre><code class="language-swift">/LoadState&lt;Int&gt;.loaded .. /Result.success
//CasePath&lt;LoadState&lt;Int&gt;, Int&gt;
</code></pre>
<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªè£…è½½çŠ¶æ€çš„æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æå–å‡ºæ‰€æœ‰æˆåŠŸçš„å€¼ï¼Œé€šè¿‡ä½¿ç”¨è¿™ä¸ªcaseè·¯å¾„ã€‚è€ƒè™‘ä»¥ä¸‹çš„çŠ¶æ€æ•°ç»„:</p>
<pre><code class="language-swift">let states1: [LoadState&lt;Int&gt;] = [
  .loaded(.success(2)),
  .loaded(.failure(NSError(domain: &quot;&quot;, code: 1, userInfo: [:]))),
  .loaded(.success(3)),
  .loading,
  .loaded(.success(4)),
  .offline,
]
</code></pre>
<p>å®ƒåŒ…å«ä¸€äº›åŠ è½½ä¸­çš„å€¼ï¼Œä¸€äº›å·²åŠ è½½çš„å€¼ï¼Œä¾æ¬¡æœ‰ä¸€äº›æˆåŠŸçš„å€¼å’Œä¸€äº›å¤±è´¥çš„å€¼ã€‚å¦‚æœæˆ‘ä»¬æƒ³åœ¨æ¯æ¬¡æˆåŠŸçš„æƒ…å†µä¸‹è½»æ¾åœ°æå–æ•´æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿™æ ·åš:</p>
<pre><code class="language-swift">states1
  .compactMap(^(/LoadState.loaded .. /Result.success)) // [2, 3, 4]
</code></pre>
<p>è¿™å¾ˆç¥å¥‡ï¼Œä½†è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªèº«ä»½éªŒè¯å€¼çš„åŠ è½½çŠ¶æ€æ•°ç»„:</p>
<pre><code class="language-swift">let states2: [LoadState&lt;Authentication&gt;] = [
  .loading,
  .loaded(.success(.authenticated(AccessToken(token: &quot;deadbeef&quot;)))),
  .loaded(.failure(NSError(domain: &quot;&quot;, code: 1, userInfo: [:]))),
  .loaded(.success(.authenticated(AccessToken(token: &quot;cafed00d&quot;)))),
  .loaded(.success(.unauthenticated)),
  .offline
]
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€äº›åŠ è½½ä¸­çš„å€¼ï¼Œä¸€äº›å·²åŠ è½½çš„å€¼ã€‚åŠ è½½çš„å€¼å¯ä»¥å¤„äºæˆåŠŸæˆ–å¤±è´¥çŠ¶æ€ã€‚ç”šè‡³æˆåŠŸä¹Ÿå¯èƒ½å¤„äºç»è¿‡éªŒè¯æˆ–æœªç»è¿‡éªŒè¯çš„çŠ¶æ€ã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•ä»è¿™ä¸ªå¤æ‚çš„ç»“æ„ä¸­å–å‡ºæ‰€æœ‰çš„è®¿é—®ä»¤ç‰Œ?  é€šè¿‡å°†ä¸‰ä¸ªcaseè·¯å¾„é™„åŠ åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªcaseè·¯å¾„ï¼Œéå†æ•´ä¸ªè®¿é—®ä»¤ç‰Œ:</p>
<pre><code class="language-swift">states2
  .compactMap(^(/LoadState.loaded .. /Result.success .. /Authentication.authenticated))
</code></pre>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå°é—®é¢˜:</p>
<blockquote>
<p>ğŸ›‘ Adjacent operators are in non-associative precedence group â€˜DefaultPrecedenceâ€™</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦å‘Šè¯‰æ“ä½œç¬¦å®ƒåº”è¯¥å¦‚ä½•å°†æ‹¬å·éšå¼åœ°æ‹¬åœ¨è¿™ä¸ªè¡¨è¾¾å¼çš„å„ä¸ªéƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†æ‹¬å·å‘å·¦åŠ æƒ:</p>
<pre><code class="language-swift">(/LoadState.loaded .. /Result.success) .. /Authentication.authenticated
</code></pre>
<p>æˆ–å‘å³:</p>
<pre><code class="language-swift">/LoadState.loaded .. (/Result.success .. /Authentication.authenticated)
</code></pre>
<p>å®é™…ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¿™å¹¶ä¸é‡è¦ï¼Œå› ä¸ºcaseè·¯å¾„çš„ç»„åˆæ˜¯å·¦è”æƒ³å’Œå³è”æƒ³çš„ã€‚ ä¸ç®¡ä½ æ€æ ·ç”¨æ‹¬å·æ‹¬ä½è¡¨è¾¾å¼ï¼Œå¾—åˆ°çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦é€‰æ‹©æ­£ç¡®çš„ç»“åˆå¾‹</p>
<pre><code class="language-swift">precedencegroup Composition {
  associativity: right
}

infix operator ..: Composition
</code></pre>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸ä½¿ç”¨æ‹¬å·æ¥ç»„åˆè¿™äº›å…³é”®è·¯å¾„:</p>
<pre><code class="language-swift">states2
  .compactMap(^(/LoadState.loaded .. /Result.success .. /Authentication.authenticated))
// [{token &quot;deadbeef&quot;}, {token &quot;cafed00d&quot;}]
</code></pre>
<p>è¿™å¤ªé…·äº†ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éå†åˆ°ä¸€ä¸ªéå¸¸å¤æ‚çš„ç»“æ„ã€‚</p>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨é—­åŒ…ä¸­è¿›è¡Œæ˜¾å¼æ¨¡å¼åŒ¹é…</p>
<pre><code class="language-swift">states2
  .compactMap {
    if case let .loaded(.success(.authenticated(token))) = $0 {
      return token
    }
    return nil
}
</code></pre>
<p>ä½†å³ä½¿è¿™æ ·ä¹Ÿä¸è¡Œï¼Œå› ä¸ºåœ¨Swiftä¸­å¤šè¡Œé—­åŒ…éœ€è¦æ˜¾å¼ç±»å‹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªé—­åŒ…ä¸­çš„å˜é‡å¼•å…¥ä¸€ä¸ªåç§°ï¼Œå¹¶æŒ‡å®šè¿”å›ç±»å‹:</p>
<pre><code class="language-swift">states2
  .compactMap { state -&gt; AccessToken? in
    if case let .loaded(.success(.authenticated(token))) = state {
      return token
    }
    return nil
}
</code></pre>
<p>æœ‰æ›´å¤šçš„åœ°æ–¹å¯ä»¥éšè—å°é”™è¯¯ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ç¡®å®èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ªå·¥å…·æ¸…ç†ä¸€äº›ä»£ç ï¼Œè€Œä¸”è¿™åªæ˜¯å¼€å§‹ã€‚ æˆ‘ä»¬å¸Œæœ›æ¯ä¸ªäººéƒ½èƒ½çœ‹åˆ°caseè·¯å¾„çš„æ¦‚å¿µæ˜¯å¤šä¹ˆæœ‰è¶£ï¼Œè°çŸ¥é“å‘¢ï¼Œä¹Ÿè®¸æœ‰ä¸€å¤©Swiftä¼šç»™æˆ‘ä»¬æä¾›ä¸€æµçš„æ”¯æŒæ¥åˆ†ææšä¸¾ï¼Œå°±åƒæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ç»“æ„ä½“ä¸€æ ·ã€‚</p>
<p>å½“æˆ‘ä»¬æƒ³è¦ä½¿ç”¨å’Œç±»å‹å’Œæšä¸¾æ—¶ï¼Œcaseè·¯å¾„å°†æ˜¯æˆ‘ä»¬çš„æœ‹å‹ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬å•ç‹¬å¤„ç†æšä¸¾çš„éƒ¨åˆ†ã€‚</p>
<p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹å‘¨å±•ç¤ºcaseè·¯å¾„ï¼Œä»¥æå¤§åœ°æ¸…ç†å¯ç»„åˆä½“ç³»ç»“æ„ä¸­çš„ä¸€äº›ä»£ç ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-88-the-case-for-case-paths-properties/">
                  <h3 class="post-title">
                    PointFree Episode 88: The Case for Case Paths: Properties
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
