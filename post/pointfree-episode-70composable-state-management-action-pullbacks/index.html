<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 70:Composable State Management: Action Pullbacks | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1679904102931">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="

PointFree Episode 70:Composable State Management: Action Pullbacks

Introduction
Focusing a reducer's actions
Enums an..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1679904102931" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
       <a href="https://beian.miit.gov.cn/">è±«ICPå¤‡2021012281å·-1</a> | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 70:Composable State Management: Action Pullbacks</h2>
            <div class="post-date">2021-11-20</div>
            
            <div class="post-content" v-pre>
              <!-- TOC -->
<ul>
<li><a href="#pointfree-episode-70composable-state-management-action-pullbacks">PointFree Episode 70:Composable State Management: Action Pullbacks</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#focusing-a-reducers-actions">Focusing a reducer's actions</a></li>
<li><a href="#enums-and-key-paths">Enums and key paths</a></li>
<li><a href="#enum-properties">Enum properties</a></li>
<li><a href="#pulling-back-reducers-along-actions">Pulling back reducers along actions</a></li>
<li><a href="#pulling-back-more-reducers">Pulling back more reducers</a></li>
<li><a href="#till-next-time">Till next time</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<!-- # PointFree Episode 70:Composable State Management: Action Pullbacks -->
<h2 id="introduction">Introduction</h2>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»éå¸¸æ¥è¿‘å®Œæˆå¦ä¸€ä¸ªæˆ‘ä»¬åœ¨è¿™ä¸€ç³»åˆ—å‰§é›†å¼€å§‹æ—¶å°±å¼€å§‹ç€æ‰‹è§£å†³çš„æ¶æ„é—®é¢˜ã€‚æˆ‘ä»¬è¯´è¿‡ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿç”¨ç®€å•çš„ã€å¯ç»„åˆçš„å•å…ƒæ„å»ºå¤§å‹å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨æˆ‘ä»¬çš„<strong>reducers</strong>å’Œå®ƒä»¬è¿è¡Œçš„çŠ¶æ€æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™æˆ‘ä»¬çš„<strong>reducers</strong>ï¼Œè®©å®ƒä»¬åœ¨æœ€ä½é™åº¦çš„çŠ¶æ€ä¸‹è¿è¡Œï¼Œä»¥å®Œæˆå·¥ä½œï¼Œç„¶åæŠŠå®ƒä»¬æ‹‰å›æ¥ï¼Œæ”¾å…¥ä¸€ä¸ªæ›´å¤§çš„<strong>reducers</strong>ä¸­ï¼Œå¹¶åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸‹è¿è¡Œã€‚</p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³å¸Œæœ›è¿™äº›ç®€å•çš„ã€å¯ç»„åˆçš„å•å…ƒèƒ½å¤Ÿè¢«éš”ç¦»ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†å®ƒä»¬æ”¾åœ¨è‡ªå·±çš„æ¨¡å—ä¸­ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥è½»æ¾åœ°ä¸å…¶ä»–æ¨¡å—å’Œåº”ç”¨ç¨‹åºå…±äº«ã€‚</p>
<p>è¿™çœŸæ˜¯å¤ªä»¤äººå…´å¥‹äº†!ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å°½ç®¡æˆ‘ä»¬çš„<strong>reducers</strong>è¿è¡Œäºæ›´å°çš„æ•°æ®å—ï¼Œä½†å®ƒä»¬ä»ç„¶å¯¹åµŒå…¥å…¶ä¸­çš„æ›´å¤§çš„<strong>reducers</strong>äº†è§£å¾—å¤ªå¤šï¼Œç‰¹åˆ«æ˜¯å®ƒä»¬å¯ä»¥ç›‘å¬æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ“ä½œã€‚</p>
<h2 id="focusing-a-reducers-actions">Focusing a reducer's actions</h2>
<p>è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„<strong>counterReducer</strong>:</p>
<pre><code class="language-swift">func counterReducer(state: inout Int, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    state -= 1

  case .counter(.incrTapped):
    state += 1

  default:
    break
  }
}
</code></pre>
<p>è¿™ä¸ª<strong>reducers</strong>åªå¯¹ä¸€ä¸ªæ•´æ•°èµ·ä½œç”¨ï¼Œè¿™å¾ˆå¥½ã€‚è¿™å¯¹æˆ‘çš„æ€ç»´æ¨¡å¼å¾ˆæœ‰å¸®åŠ©ï¼Œæˆ‘çŸ¥é“<strong>reducers</strong>æƒ³è¦å®Œæˆä»€ä¹ˆï¼Œå› ä¸ºæˆ‘çŸ¥é“å®ƒçœŸçš„ä¸èƒ½åšå¤ªå¤šã€‚ å®ƒåªæœ‰ä¸€ä¸ªæ•´æ•°å¯ä»¥æ”¹å˜ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œå®ƒä¹ŸåŒ…å«åº”ç”¨ç¨‹åºçš„å…¨éƒ¨æ“ä½œã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥çŸ¥é“å‡ºé”™äº†ï¼Œå› ä¸ºåœ¨<strong>switch</strong>è¯­å¥ä¸­æœ‰ä¸€ä¸ª<strong>default</strong>æƒ…å†µã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬å‘<strong>CounterAction</strong>æšä¸¾ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ“ä½œï¼Œæˆ‘ä»¬å°†ä¸ä¼šå¾—åˆ°ç¼–è¯‘å™¨é”™è¯¯ï¼Œå¹¶ä¸”ä¼šåœ¨<strong>reducers</strong>ä¸­é™é»˜åœ°å¿½ç•¥è¯¥æ“ä½œã€‚</p>
<p>è§£å†³è¿™ä¸€ç¼ºç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯åœ¨å½»åº•<strong>switching</strong>ä¹‹å‰å…ˆæå–<strong>counter</strong>åŠ¨ä½œ:</p>
<pre><code class="language-swift">func counterReducer(state: inout Int, action: AppAction) -&gt; Void {
  switch action {
  case let .counter(action):
    switch action {
    case .decrTapped:
      state -= 1

    case .incrTapped:
      state += 1
    }

  default:
    break
  }
}
</code></pre>
<p>ä½†è¿™å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºè¿™ä¼šå¢åŠ åµŒå¥—å’Œå™ªéŸ³ã€‚</p>
<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬é‡æ„è¿™ä¸ª<strong>reducer</strong>ï¼Œè®©å®ƒåªæ‰§è¡Œå®ƒå…³å¿ƒçš„åŠ¨ä½œ:</p>
<pre><code class="language-swift">func counterReducer(state: inout Int, action: CounterAction) -&gt; Void {
  switch action {
  case .decrTapped:
    state -= 1

  case .incrTapped:
    state += 1
  }
}
</code></pre>
<p>è¿™å¾ˆç®€å•ï¼Œå®ƒä½¿ä»£ç æ›´çŸ­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦<strong>default</strong>æƒ…å†µã€‚å®ƒç°åœ¨åªå…³æ³¨åŠ¨ä½œå’ŒçŠ¶æ€ï¼Œç”šè‡³å¯ä»¥è¢«æå–åˆ°æ¨¡å—ä¸­ã€‚è¿™æ˜¯ä¸€ä»¶å¾ˆå¼ºå¤§çš„äº‹æƒ…!ä¾‹å¦‚ï¼Œä¸€ä¸ªä»£ç åº“çš„æ–°æ‰‹å¯èƒ½ä¼šåœ¨è‡ªå·±çš„æ¨¡å—ä¸­çœ‹åˆ°ä¸€ä¸ª<strong>reducer</strong>ï¼Œå¹¶çŸ¥é“å®ƒä¸å¯èƒ½è§¦åŠåº”ç”¨ç›®æ ‡ä¸­çš„ä»»ä½•ä¸œè¥¿ã€‚</p>
<h2 id="enums-and-key-paths">Enums and key paths</h2>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªç¼–è¯‘é”™è¯¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº<strong>reducer</strong>:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(counterReducer, value: \.count),
  primeModalReducer,
  pullback(favoritePrimesReducer, value: \.favoritePrimesState)
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Type of expression is ambiguous without more context</p>
</blockquote>
<p>å°½ç®¡<strong>counterReducer</strong>åœ¨çŠ¶æ€æ–¹é¢ä¸å…¶ä»–<strong>reducer</strong>ä½¿ç”¨ç›¸åŒçš„è¯­è¨€ï¼Œä½†å®ƒä¸å†ä½¿ç”¨ç›¸åŒçš„<strong>actions</strong>è¯­è¨€ã€‚<strong>counter reducer</strong>åªç†è§£è®¡æ•°å™¨åŠ¨ä½œï¼Œè€Œå…¶ä»–<strong>reducers</strong>åˆ™ç†è§£æ•´ä¸ªåº”ç”¨åŠ¨ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†å°†è¿™äº›<strong>reducers</strong>ç»„åˆåœ¨ä¸€èµ·ã€‚</p>
<p>æ‰€ä»¥ï¼Œé—®é¢˜æ˜¯:æˆ‘ä»¬å¦‚ä½•æŠŠä¸€ä¸ªåªç†è§£å±€éƒ¨ä½œç”¨çš„<strong>reducer</strong>è½¬å˜æˆä¸€ä¸ªç†è§£å…¨å±€ä½œç”¨çš„<strong>reducer</strong>?</p>
<p>è¿™ä¸æˆ‘ä»¬åœ¨<strong>reducer</strong>å’ŒçŠ¶æ€ä¸Šé‡åˆ°çš„é—®é¢˜éå¸¸ç›¸ä¼¼ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³å°†åœ¨å±€éƒ¨çŠ¶æ€ä¸‹å·¥ä½œçš„<strong>reducer</strong>è½¬æ¢ä¸ºåœ¨å…¨å±€çŠ¶æ€ä¸‹å·¥ä½œçš„<strong>reducer</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‘ç°è§£å†³æ–¹æ¡ˆæ˜¯æ²¿ç€ä¸€æ¡ä»å…¨å±€çŠ¶æ€åˆ°å±€éƒ¨çŠ¶æ€çš„å…³é”®è·¯å¾„<strong>pullback</strong>ã€‚ä½†åœ¨<strong>action</strong>ä¸–ç•Œä¸­ï¼Œç›¸åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆå‘¢?</p>
<p>æˆ‘ä»¬çš„æ“ä½œæ˜¯æšä¸¾ï¼Œæšä¸¾æ²¡æœ‰é”®è·¯å¾„çš„æ¦‚å¿µï¼Œè‡³å°‘ä¸æ˜¯Swiftå®šä¹‰çš„ï¼Œä¹Ÿä¸æ˜¯Swiftç¼–è¯‘å™¨è‡ªåŠ¨æä¾›çš„ã€‚ç„¶è€Œï¼Œè¿™ä¸åº”è¯¥é˜»æ­¢æˆ‘ä»¬æ¢ç´¢å¯¹åº”çš„æšä¸¾å…³é”®è·¯å¾„çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¹¶çœ‹çœ‹è¿™æ˜¯å¦å¯èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¦å°†å…³é”®è·¯å¾„çš„æœ¬è´¨æå–åˆ°ä¸€ä¸ªåŒ…ä¸­ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre><code class="language-swift">struct _KeyPath&lt;Root, Value&gt; {
  let get: (Root) -&gt; Value
  let set: (inout Root, Value) -&gt; Void
}
</code></pre>
<p>è¿™æ ¹æœ¬ä¸æ˜¯åœ¨Swiftä¸­å®ç°å…³é”®è·¯å¾„çš„æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨å‰é¢åŠ ä¸Šäº†ä¸‹åˆ’çº¿ï¼Œä»¥è¡¨æ˜è¿™åªæ˜¯ä¸€ä¸ªæ€æƒ³å®éªŒã€‚ä½†å…³é”®è·¯å¾„çš„æ ¸å¿ƒåœ¨äºï¼Œå®ƒä»¬ä¸ºæ‚¨æä¾›äº†ä¸€ç§ä»æ ¹ä¸­â€œè·å–â€å€¼çš„æ–¹æ³•ï¼Œå¹¶å…è®¸æ‚¨åœ¨æ ¹ä¸­è®¾ç½®å€¼ï¼Œä»è€Œä¸ºæ‚¨æä¾›ä¸€ä¸ªå·²æ›´æ”¹çš„æ–°æ ¹ã€‚è¿™ä¸¤ä¸ªæ“ä½œåŸºæœ¬ä¸Šæ˜¯æ‚¨å¯ä»¥åœ¨ç»“æ„ä¸Šæ‰§è¡Œçš„æœ€ä¸€èˆ¬çš„æ“ä½œã€‚æ‚¨å¯ä»¥ä»ç»“æ„ä¸­æå–å­—æ®µï¼Œä¹Ÿå¯ä»¥åœ¨ç»“æ„ä¸Šçš„å­—æ®µä¸­è®¾ç½®æ–°å€¼ã€‚</p>
<p>ä¸¾è¿˜æœ‰ä¸¤ä¸ªéå¸¸åŸºæœ¬çš„æ“ä½œå¯ä»¥åœ¨å…¶ä¸Šæ‰§è¡Œï¼Œå®ƒä»¬éå¸¸ç±»ä¼¼äºå…³é”®è·¯å¾„çš„<strong>getå’Œset</strong>ã€‚å¯¹äºæŸäº›æšä¸¾ç±»å‹ï¼Œæ‚¨å¯ä»¥è·å–ä¸€ä¸ªå€¼å¹¶å°†å…¶åµŒå…¥åˆ°æšä¸¾çš„ä¸€ç§æƒ…å†µä¸­ï¼Œæˆ–è€…æ‚¨å¯ä»¥è·å–æšä¸¾çš„ä¸€ä¸ªå€¼å¹¶å°è¯•åœ¨å…¶ä¸­ä¸€ç§æƒ…å†µä¸­æå–ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»æˆ‘ä»¬çš„<strong>AppAction</strong>æšä¸¾ã€‚æˆ‘ä»¬å¯ä»¥ä»<strong>case</strong>çš„ç›¸å…³æ•°æ®ä¸­è·å–ä¸€ä¸ªå€¼ï¼Œå¹¶å°†å…¶æ”¾å…¥æšä¸¾ä¸­:</p>
<pre><code class="language-swift">AppAction.counter(CounterAction.incrTapped)
</code></pre>
<p>è¿™æœ‰ç‚¹åƒ<strong>setter</strong>:æˆ‘ä»¬æ¥å—ä¸€ä¸ªå€¼å¹¶å°†å…¶åµŒå…¥åˆ°<strong>AppAction enum</strong>ä¸­ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿæœ‰ç±»ä¼¼<strong>getter</strong>çš„ä¸œè¥¿:æˆ‘ä»¬å¯ä»¥å–ä¸€ä¸ªæšä¸¾å€¼å¹¶å°è¯•ä»ä¸€ä¸ªç‰¹å®šçš„æƒ…å†µä¸­æå–ä¸€ä¸ªå€¼:</p>
<pre><code class="language-swift">let action = AppAction.favoritePrimes(.deleteFavoritePrimes([1]))
let favoritePrimesAction: FavoritePrimesAction?
switch action {
case let .favoritePrimes(action):
  favoritePrimesAction = action
default:
  favoritePrimesAction = nil
}
</code></pre>
<p>è™½ç„¶è¿™éå¸¸å†—é•¿ï¼Œä½†å®ƒç±»ä¼¼äº<strong>getter</strong>æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæ¨¡å¼åŒ¹é…å¹¶æå–å¯é€‰çš„å…³è”å€¼ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹æšä¸¾åšçš„ä¸¤ä¸ªæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸€ä¸ªæšä¸¾åšã€‚å¦‚æœSwiftæ”¯æŒ<strong>enum</strong>é”®è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤ä¸ªæ“ä½œæ‰“åŒ…æˆä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œå¯èƒ½åƒè¿™æ ·:</p>
<pre><code class="language-swift">struct EnumKeyPath&lt;Root, Value&gt; {
  let embed: (Value) -&gt; Root
  let extract: (Root) -&gt; Value?
}
</code></pre>
<p>ä¹Ÿè®¸Swiftç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºæšä¸¾é”®è·¯å¾„ï¼Œæ¯ä¸ªæšä¸¾éƒ½æœ‰ä¸€ä¸ªé”®è·¯å¾„ï¼Œä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›¸åŒçš„è¯­æ³•è®¿é—®å®ƒä»¬:</p>
<pre><code class="language-swift">// \AppAction.counter // EnumKeyPath&lt;AppAction, CounterAction&gt;
</code></pre>
<h2 id="enum-properties">Enum properties</h2>
<p>ç°åœ¨ï¼Œå³ä½¿Swiftä»Šå¤©æ²¡æœ‰ç»™æˆ‘ä»¬è¿™ä¸ªåŠŸèƒ½ï¼Œä½†äº‹å®è¯æ˜ï¼Œå¦‚æœæˆ‘ä»¬åªåšä¸€ç‚¹å‰æœŸå·¥ä½œï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸æ¥è¿‘è¿™ä¸ªåŠŸèƒ½ã€‚äº‹å®ä¸Šï¼Œå…³äºè¿™ä¸ªè¯é¢˜ï¼Œæˆ‘ä»¬æœ‰ä¸€æ•´ç³»åˆ—çš„èŠ‚ç›®ã€‚</p>
<p>å‡ ä¸ªæœˆå‰ï¼Œæˆ‘ä»¬èŠ±äº†å‡ é›†çš„æ—¶é—´è®¨è®ºç»“æ„ä½“å’Œæšä¸¾å®é™…ä¸Šåªæ˜¯ä¸€æšç¡¬å¸çš„ä¸¤é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬æ˜¯åŸºæœ¬ç›¸è¿çš„æ¦‚å¿µã€‚è¿™è®©æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸€ä¸ªæ¦‚å¿µæ‹¥æœ‰çš„è®¸å¤šåŠŸèƒ½ï¼Œå¦ä¸€ä¸ªæ¦‚å¿µè‡ªç„¶ä¹Ÿä¼šæ‹¥æœ‰ã€‚ç„¶è€Œï¼Œæœ‰æ—¶Swiftæ›´å–œæ¬¢ç»“æ„ä½“è€Œä¸æ˜¯æšä¸¾ï¼Œå› ä¸ºå®ƒæä¾›äº†å¼ºå¤§çš„ç‰¹æ€§ï¼Œåœ¨æšä¸¾ä¸–ç•Œä¸­æ²¡æœ‰ç›¸åº”çš„ç‰ˆæœ¬ã€‚</p>
<p>ç‰¹åˆ«æ˜¯:å±æ€§å’Œé”®è·¯å¾„ã€‚ç»“æ„ä½“é€šè¿‡ç‚¹è¯­æ³•æœ‰éå¸¸ç®€å•çš„æ•°æ®è®¿é—®ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°è®¿é—®ç»“æ„ä½“ä¸­çš„å­—æ®µï¼Œåªéœ€è¦åšâ€œ.â€ç„¶åæ˜¯ä½ çš„å­—æ®µåç§°ã€‚æšä¸¾æ²¡æœ‰è¿™æ ·çš„åŠŸèƒ½ã€‚å¦‚æœæ‚¨æƒ³è¦è·å–æšä¸¾ä¸­çš„æ•°æ®ï¼Œæ‚¨åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½<strong>switch</strong>æšä¸¾ï¼Œåœ¨æ‚¨å…³å¿ƒçš„æƒ…å†µä¸‹è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œç„¶ååœ¨è¯¥æƒ…å†µä¸‹è·å–ç›¸å…³çš„æ•°æ®ã€‚æ­¤å¤–ï¼Œç»“æ„ä¸Šçš„æ¯ä¸ªå±æ€§éƒ½è·å¾—ç¼–è¯‘å™¨ç”Ÿæˆçš„é”®è·¯å¾„ï¼Œè¿™å°±åƒä¸€ä¸ªå°çš„<strong>getter/setter</strong>å¯¹ï¼Œå¯ä»¥è§£é”æ‰€æœ‰ç±»å‹çš„æœ‰è¶£çš„ä¸œè¥¿ã€‚å¯¹äºæšä¸¾æ²¡æœ‰è¿™æ ·çš„ä¸œè¥¿ã€‚</p>
<p>è¿™ä¸¤ä¸ªæ¦‚å¿µä¹‹é—´å­˜åœ¨å¾ˆå¤§çš„ä¸å¹³è¡¡ã€‚è¿™ä½¿å¾—Swiftä¼¼ä¹æ›´å–œæ¬¢ç»“æ„ä½“è€Œä¸æ˜¯æšä¸¾ï¼Œå°½ç®¡å…¶ä¸­ä¸€ä¸ªå¹¶ä¸æ¯”å¦ä¸€ä¸ªæ›´é‡è¦ã€‚å› æ­¤ï¼Œåœ¨æœ¬ç³»åˆ—çš„ä¸‹ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡å¼•å…¥â€œenumå±æ€§â€æ¦‚å¿µæ¥å¼¥è¡¥è¿™ä¸€ç¼ºé™·ã€‚è¿™äº›æ˜¯åœ¨æšä¸¾ä¸Šå®šä¹‰çš„è®¡ç®—å±æ€§ï¼Œæ¯ä¸ªæšä¸¾å¯¹åº”ä¸€ä¸ªã€‚å®ƒåŸºæœ¬ä¸ŠæŠŠæˆ‘ä»¬åœ¨ä¸Šé¢çš„ç‰¹åˆ«æ–¹å¼ä¸­æ‰€åšçš„å·¥ä½œæ‰“åŒ…æˆä¸€ä¸ªæ¼‚äº®çš„ã€ä¸€è‡´çš„åŒ…ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äº<strong>AppAction</strong>æšä¸¾ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:</p>
<pre><code class="language-swift">enum AppAction {
  case counter(CounterAction)
  case primeModal(PrimeModalAction)
  case favoritePrimes(FavoritePrimesAction)

  var counter: CounterAction? {
    get {
      guard case let .counter(value) = self else { return nil }
      return value
    }
  }
  var primeModal: PrimeModalAction? {
    get { 
      guard case let .primeModal(value) = self else { return nil }
      return value
    }
  }
  var favoritePrimes: FavoritePrimesAction? {
    get {
      guard case let .favoritePrimes(value) = self else { return nil }
      return value
    }
  }
}
</code></pre>
<p>é€šè¿‡è¿™äº›å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—<strong>AppAction</strong>æšä¸¾ä¸­ä»»ä½•æƒ…å†µä¸‹çš„å…³è”æ•°æ®çš„å®ä¾‹è®¿é—®æƒï¼Œè¿™ç»™äº†åº”ç”¨ç¨‹åº<strong>actions</strong>å¾ˆå¤šä¸åº”ç”¨ç¨‹åº<strong>state</strong>ç»“æ„ä½“ç›¸åŒçš„äººæœºå·¥ç¨‹å­¦ã€‚</p>
<p>å°½ç®¡è¿™äº›æšä¸¾å±æ€§éå¸¸æœ‰ç”¨ï¼Œä½†ä»å¤´ç¼–å†™å’Œç»´æŠ¤å®ƒä»¬æ˜¯ç›¸å½“ç—›è‹¦çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èŠ±äº†<a href="https://www.pointfree.co/episodes/ep54-advanced-swift-syntax-enum-properties">ä¸‰é›†</a>é¢å¤–çš„æ—¶é—´æ¥æ¢ç´¢è‹¹æœçš„<strong>SwiftSyntax</strong>åº“ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·æ¥ä¸ºæˆ‘ä»¬ç”Ÿæˆè¿™äº›å±æ€§ï¼Œå¹¶è‡ªåŠ¨å°†ä»£ç æ’å…¥åˆ°æˆ‘ä»¬çš„æºä»£ç ä¸­ã€‚æˆ‘ä»¬æœ€ç»ˆå¼€æ”¾äº†è¿™ä¸ªå·¥å…·ï¼Œå®ƒå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å®ƒæ·»åŠ åˆ°è¿™ä¸ª<strong>playground</strong>ä¸­ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰è¿™äº›<strong>enum</strong>å±æ€§ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§!</p>
<p>æˆ‘ä»¬å·²ç»åœ¨<strong>playground</strong>å½“å‰æ‰€åœ¨çš„ç›®å½•ä¸­æ·»åŠ äº†ä¸€ä¸ª<strong>Package.swift</strong>æ–‡ä»¶ï¼Œå®ƒçš„ä¾èµ–é¡¹æŒ‡å‘å¼€æºçš„<strong>swift-enum-properties</strong> repo:</p>
<pre><code class="language-swift">// swift-tools-version:4.2
import PackageDescription

let package = Package(
  name: &quot;StateManagement&quot;,
  dependencies: [
    .package(url: &quot;https://github.com/pointfreeco/swift-enum-properties.git&quot;, from: &quot;0.1.0&quot;)
  ]
)
</code></pre>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿è¡Œè¿™ä¸ªå·¥å…·é™„å¸¦çš„generate-enum-propertieså¯æ‰§è¡Œæ–‡ä»¶äº†:</p>
<pre><code class="language-swift">$ swift run generate-enum-properties
Generate enum properties (version 0.1.0).

usage: generate-enum-properties [--help|-h] [--dry-run|-n] [&lt;file&gt;...]

    -h, --help
        Print this message.

    -n, --dry-run
        Don't update files in place. Print to stdout instead.

    --version
        Print the version.
</code></pre>
<p>è¿™å°†æ‰“å°å‡ºä½¿ç”¨è¯´æ˜ã€‚</p>
<p>è¦çœŸæ­£è°ƒç”¨è¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å®ƒæŒ‡å‘è¿™ä¸ªç›®å½•å’Œæ‰€æœ‰å­ç›®å½•ä¸­çš„æ‰€æœ‰.<strong>swift</strong>æ–‡ä»¶ã€‚è®©æˆ‘ä»¬é¦–å…ˆåˆ é™¤<strong>AppAction</strong>ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å®ƒçš„ä½œç”¨äº†ã€‚ç„¶åè¿è¡Œ:</p>
<pre><code class="language-swift">$ swift run generate-enum-properties ComposableArchitecture.playground/Contents.swift
Updating ComposableArchitecture.playground/Contents.swift
</code></pre>
<p>å°±åƒæˆ‘ä»¬çš„<strong>playground</strong>ä»£ç è¢«æ›´æ–°ä¸ºæ–°ä»£ç ï¼Œå®ƒä¸ºæˆ‘ä»¬å®šä¹‰çš„æ¯ä¸€ä¸ªæšä¸¾ä»¥åŠè¯¥æšä¸¾ä¸­çš„æ¯ä¸€ä¸ªæƒ…å†µæä¾›æšä¸¾å±æ€§ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ªå±æ€§è¢«æ·»åŠ åˆ°<strong>AppAction</strong>ä¸­:</p>
<pre><code class="language-swift">var counter: CounterAction? {
  get {
    guard case let .counter(value) = self else { return nil }
    return value
  }
  set {
    guard case .counter = self, let newValue = newValue else { return }
    self = .counter(newValue)
  }
}
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬æœ‰ä¹‹å‰å®šä¹‰çš„<strong>getter</strong>ï¼Œç”šè‡³è¿˜æœ‰<strong>setter</strong>ï¼Œæˆ‘ä»¬ç°åœ¨ä¸ä¼šç”¨åˆ°ï¼Œä½†åœ¨åé¢çš„ç« èŠ‚ä¸­ä¼šå¾ˆæ–¹ä¾¿ã€‚</p>
<p>å·¥å…·ç°åœ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è¿™äº›å±æ€§ä½¿æšä¸¾çš„è¡Œä¸ºéå¸¸ç±»ä¼¼äºç»“æ„ä½“ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»æšä¸¾å®ä¾‹ä¸­æå–ä¸€ä¸ªå€¼:</p>
<pre><code class="language-swift">let someAction = AppAction.counter(.incrTapped)
someAction.counter
// Optional(incrTapped)

someAction.favoritePrimes
// nil
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºæšä¸¾çš„æ¯ä¸ªä¾‹å­è·å–å…³é”®è·¯å¾„:</p>
<pre><code class="language-swift">\AppAction.counter
// WritableKeyPath&lt;AppAction, CounterAction?&gt;
</code></pre>
<h2 id="pulling-back-reducers-along-actions">Pulling back reducers along actions</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ç§æ–¹æ³•æ¥ä¸ºæ¯ä¸ªæšä¸¾ç”Ÿæˆå±æ€§å’Œé”®è·¯å¾„ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä»€ä¹ˆ? ç»“æ„ä½“ä¸Šçš„å…³é”®è·¯å¾„æ­£æ˜¯è®©æˆ‘ä»¬èƒ½å¤Ÿæ²¿ç€<strong>state</strong>æ‹‰å›<strong>reducers</strong>çš„åŸå› ã€‚å¸Œæœ›<strong>enum</strong>ä¸Šçš„å…³é”®è·¯å¾„ç»™æˆ‘ä»¬åŒæ ·çš„èƒ½åŠ›ï¼Œé™¤äº†æˆ‘ä»¬æƒ³æ²¿ç€<strong>action</strong>æ‹‰å›reducerã€‚</p>
<p>ä¸ºäº†ç†è§£æˆ‘ä»¬è¯•å›¾å®Œæˆçš„ä»»åŠ¡ï¼Œè®©æˆ‘ä»¬ç¼–é€ ä¸€ä¸ªå‡½æ•°ç­¾åã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå°†çŸ¥é“å¦‚ä½•ä¸æœ¬åœ°<strong>actions</strong>åˆä½œçš„<strong>reducers</strong>æ’¤å›åˆ°çŸ¥é“å¦‚ä½•ä¸å…¨çƒ<strong>actions</strong>åˆä½œçš„<strong>reducers</strong>:</p>
<pre><code class="language-swift">func pullback&lt;Value, GlobalAction, LocalAction&gt;(
  _ reducer: @escaping (inout Value, LocalAction) -&gt; Void,
  ???
) -&gt; (inout Value, GlobalAction) -&gt; Void {

  ???
}
</code></pre>
<p>é—®é¢˜æ˜¯:æˆ‘ä»¬è¦æŠŠä»€ä¹ˆæ‹‰å›æ¥? å¯¹äºç»“æ„ä½“ï¼Œå®ƒæ˜¯ä»å…¨å±€çŠ¶æ€åˆ°å±€éƒ¨çŠ¶æ€çš„ç®€å•å…³é”®è·¯å¾„ã€‚ä½†è¿™åœ¨è¿™é‡Œå¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºä»å…¨å±€<strong>action</strong>ä¸­æå–ç‰¹å®šçš„å±€éƒ¨<strong>action</strong>å¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ã€‚è¿™å°±æ˜¯<strong>enum</strong>å±æ€§è¿”å›å¯é€‰å€¼çš„åŸå› ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªå¯é€‰çš„æœ¬åœ°<strong>action</strong>çš„å…³é”®è·¯å¾„:</p>
<pre><code class="language-swift">func pullback&lt;Value, GlobalAction, LocalAction&gt;(
  _ reducer: @escaping (inout Value, LocalAction) -&gt; Void,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;
) -&gt; (inout Value, GlobalAction) -&gt; Void {

  ???
}
</code></pre>
<p>æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå®ç°è¿™ä¸ªå‡½æ•°ã€‚åœ¨è¿™ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæƒ³æƒ³å®ƒåº”è¯¥ä»£è¡¨ä»€ä¹ˆã€‚æˆ‘ä»¬ä»ä¸€ä¸ªæ“ä½œå±€éƒ¨<strong>actions</strong>çš„<strong>reducers</strong>å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯ç‰¹å®šäºå¤§åº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªå°å±å¹•çš„åŠ¨ä½œã€‚æˆ‘ä»¬è¿˜ä»ä¸€ä¸ªå…³é”®è·¯å¾„å¼€å§‹ï¼Œè¯¥è·¯å¾„å¯ä»¥ä»å…¨å±€<strong>actions</strong>ä¸­æå–å±€éƒ¨<strong>actions</strong>ï¼Œä½†æœ‰æ—¶ä¼šå¤±è´¥ã€‚æˆ‘ä»¬æƒ³æŠŠè¿™ä¸ªèµ·å§‹ä¿¡æ¯å˜æˆä¸€ä¸ª<strong>reducers</strong>ï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å…¨å±€åŠ¨ä½œä¸Šå·¥ä½œã€‚å®ƒçš„åšæ³•æ˜¯ï¼Œå½“ä¸€ä¸ªå…¨å±€<strong>actions</strong>è¿›æ¥æ—¶ï¼Œæˆ‘ä»¬ä¼šå°è¯•ä½¿ç”¨å…³é”®è·¯å¾„ä»å®ƒæå–ä¸€ä¸ªå±€éƒ¨<strong>actions</strong>ã€‚å¦‚æœæˆåŠŸäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒä¼ é€’ç»™<strong>reducers</strong>ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œæˆ‘ä»¬å°±é»˜é»˜åœ°è®©å®ƒè¿‡å»ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚</p>
<p>è¿™çœŸçš„å¾ˆç®€å•ï¼Œå®ç°ä¹Ÿå¾ˆç®€å•:</p>
<pre><code class="language-swift">func pullback&lt;Value, GlobalAction, LocalAction&gt;(
  _ reducer: @escaping (inout Value, LocalAction) -&gt; Void,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;
) -&gt; (inout Value, GlobalAction) -&gt; Void {

  return { value, globalAction in
    guard let localAction = globalAction[keyPath: action] else { return }
    reducer(&amp;value, localAction)
  }
}
</code></pre>
<p>å°±è¿™äº›ã€‚</p>
<p>åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿåœ°æ¸…ç†ä¸€ä¸‹ã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„æ‹‰å›:ä¸€ä¸ªç”¨äº<strong>state</strong>ï¼Œä¸€ä¸ªç”¨äº<strong>action</strong>ã€‚è®©æˆ‘ä»¬å°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå•ç‹¬çš„æ‹‰å›:</p>
<pre><code class="language-swift">func pullback&lt;GlobalValue, LocalValue, GlobalAction, LocalAction&gt;(
  _ reducer: @escaping (inout LocalValue, LocalAction) -&gt; Void,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;,
  action: WritableKeyPath&lt;GlobalAction, LocalAction?&gt;
) -&gt; (inout GlobalValue, GlobalAction) -&gt; Void {

  return { globalValue, globalAction in
    guard let localAction = globalAction[keyPath: action] else { return }
    reducer(&amp;globalValue[keyPath: value], localAction)
  }
}
</code></pre>
<p>æˆ‘ä»¬æ€ä¹ˆç”¨è¿™ä¸ªå‘¢? ç°åœ¨æˆ‘ä»¬çš„<strong>appReducer</strong>æ— æ³•ç¼–è¯‘ã€‚ æˆ‘ä»¬éœ€è¦æ›´æ–°è¿™äº›å›è°ƒï¼Œä»¥ä¾¿å®ƒä»¬èƒ½å¤Ÿä¸æ–°ç­¾åä¸€èµ·å·¥ä½œï¼Œè¿™éœ€è¦æŒ‡å®š<strong>action</strong>ã€‚<strong>counter reducer</strong>ç°åœ¨å¯ä»¥é€šè¿‡å°†åº”ç”¨<strong>action</strong>æŠ•å°„åˆ°counter<strong>action</strong>ä¸­çš„å…³é”®è·¯å¾„è¢«æ‹‰å›:</p>
<pre><code class="language-swift">let _appReducer = combine(
  pullback(counterReducer, value: \.count, action: \.counter),
  primeModalReducer,
  pullback(favoritePrimesReducer, value: \.favoritePrimesState)
)
</code></pre>
<p>æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°<strong>favoritePrimesReducer</strong>å’Œ<strong>appReducer</strong>çš„å›è°ƒã€‚æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶ç®€å•çš„äº‹æƒ…æ˜¯æ²¿ç€<strong>identity key path</strong>å°†å®ƒæ‹‰å›æ¥:</p>
<pre><code class="language-swift">let _appReducer = combine(
  pullback(counterReducer, value: \.count, action: \.counter),
  primeModalReducer,
  pullback(favoritePrimesReducer, value: \.favoritePrimesState, action: \.self)
)
let appReducer = pullback(_appReducer, value: \.self, action: \.self)
</code></pre>
<p>è¿™è®©ä»£ç å†æ¬¡ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®¡æ•°å™¨å·¥ä½œå°±åƒä»¥å‰ä¸€æ ·ï¼Œå°½ç®¡å®ƒçš„<strong>reducers</strong>å®Œå…¨ä¸åº”ç”¨ç¨‹åº<strong>state</strong>å’Œåº”ç”¨ç¨‹åº<strong>action</strong>éš”ç¦»ã€‚</p>
<h2 id="pulling-back-more-reducers">Pulling back more reducers</h2>
<p>æˆ‘ä»¬ç°åœ¨æœ‰äº†ç¬¬ä¸‰ç§å½¢å¼çš„<strong>reducers</strong>ç»„åˆ:æˆ‘ä»¬èƒ½å¤Ÿæ²¿ç€<strong>action</strong>çš„å…³é”®è·¯å¾„æ‹‰å›ï¼Œä»¥ä¾¿è®©æˆ‘ä»¬çš„<strong>reducers</strong>åªå…³æ³¨å±€éƒ¨<strong>action</strong>ï¼Œæˆ‘ä»¬å°†å…¶æ‹‰å›å…¨çƒ<strong>action</strong>çš„ä¸–ç•Œã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¤§å¤§ç®€åŒ–äº†è®¡æ•°å™¨<strong>reducer</strong>ã€‚</p>
<p>æˆ‘ä»¬çš„å…¶ä»–<strong>reducer</strong>ä»ç„¶åœ¨å…¨çƒ<strong>action</strong>ä¸­è¿è¡Œï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¿®å¤å®ƒ!</p>
<p><strong>favoritePrimesReducer</strong>æ­£åœ¨æ²¿ç€æ ‡è¯†é”®è·¯å¾„æ‹‰å›å®ƒçš„<strong>action</strong>ï¼Œè¿™æ„å‘³ç€å®ƒä»ç„¶åœ¨æ“ä½œå®Œæ•´çš„åº”ç”¨ç¨‹åº<strong>action enum</strong>ã€‚</p>
<pre><code class="language-swift">pullback(favoritePrimesReducer, value: \.favoritePrimesState, action: \.self)
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥è®©<strong>reducer</strong>æ›´ç®€å•ã€æ›´å…·ä½“ï¼Œåªä½¿ç”¨æœ€å–œæ¬¢çš„<strong>primes</strong>åŠ¨ä½œ:</p>
<pre><code class="language-swift">func favoritePrimesReducer(state: inout FavoritePrimesState, action: FavoritePrimesAction) -&gt; Void {
  switch action {
  case let .deleteFavoritePrimes(indexSet):
    for index in indexSet {
      state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.favoritePrimes[index])))
      state.favoritePrimes.remove(at: index)
    }
  }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æ›´æ–°å›æ‹‰ï¼Œæ²¿ç€å…³é”®è·¯å¾„å°†<strong>app action</strong>æŠ•å°„åˆ°<strong>favorite prime</strong> actionä¸­:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(counterReducer, value: \.count, action: \.counter),
  primeModalReducer,
  pullback(favoritePrimesReducer, value: \.favoritePrimesState, action: \.favoritePrimes)
)
</code></pre>
<p>ä¸€åˆ‡ä»ç„¶åƒä»¥å‰ä¸€æ ·æ„å»ºå’Œè¿è¡Œã€‚</p>
<p>æœ€åæˆ‘ä»¬æœ‰<strong>primeModalReducer</strong>ï¼Œå®ƒçš„æ“ä½œä¹Ÿéå¸¸ä¸€èˆ¬åŒ–ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è®©å®ƒæ›´å…·ä½“ï¼Œåªå·¥ä½œäºæ¨¡æ€<strong>actions</strong>:</p>
<pre><code class="language-swift">func primeModalReducer(state: inout AppState, action: PrimeModalAction) -&gt; Void {
  switch action {
  case .removeFavoritePrimeTapped:
    state.favoritePrimes.removeAll(where: { $0 == state.count })
    state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.count)))

  case .saveFavoritePrimeTapped:
    state.favoritePrimes.append(state.count)
    state.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(state.count)))
  }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·æ›´æ–°<strong>app reducer</strong>:</p>
<pre><code class="language-swift">let _appReducer = combine(
  pullback(counterReducer, value: \.count, action: \.counter),
  pullback(primeModalReducer, value: \.self, action: \.primeModal),
  pullback(favoritePrimesReducer, value: \.favoritePrimesState, action: \.favoritePrimes)
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Generic parameter â€˜Actionâ€™ could not be inferred</p>
</blockquote>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å®Œå…¨ä»<strong>AppAction</strong>éš”ç¦»äº†æˆ‘ä»¬çš„<strong>reducer</strong>ï¼Œæ‰€ä»¥å®ƒä¸èƒ½å†æ¨æ–­ã€‚ç¼–è¯‘å™¨ä¸çŸ¥é“å®ƒå›è°ƒåˆ°å“ªç§å…¨å±€æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‡æ³¨<strong>reducer</strong>å‡½æ•°æ¥ç»™å®ƒä¸€ä¸ªæç¤ºã€‚</p>
<pre><code class="language-swift">let _appReducer: (inout AppState, AppAction) -&gt; Void = combine(
  pullback(counterReducer, value: \.count, action: \.counter),
  pullback(primeModalReducer, value: \.self, action: \.primeModal),
  pullback(favoritePrimesReducer, value: \.favoritePrimesState, action: \.favoritePrimes)
)
</code></pre>
<p>ç¼–è¯‘å™¨å¾ˆé«˜å…´ï¼Œä¸€åˆ‡æ­£å¸¸!</p>
<p>æˆ‘ä»¬å·²ç»å°†å¤„ç†å…¨çƒ<strong>state</strong>å’Œå…¨çƒ<strong>action</strong>çš„å·¨å‹<strong>reducer</strong>é‡æ„ä¸º3ä¸ªæ›´å°çš„<strong>reducer</strong>ï¼Œå®ƒä»¬åªå¤„ç†å®ƒä»¬å…³å¿ƒçš„<strong>stateå’Œaction</strong>ã€‚ç„¶åæˆ‘ä»¬ä¾¿èƒ½å¤Ÿå°†è¿™äº›å°å‹<strong>reducer</strong>è¿›è¡Œæ•´åˆï¼Œä»è€Œå½¢æˆæˆ‘ä»¬çš„å¤§å‹åº”ç”¨<strong>reducer</strong>ã€‚</p>
<p>æˆ‘ä»¬èƒ½å¤Ÿç”¨å¾ˆå°‘çš„åº“ä»£ç å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œã€‚æˆ‘ä»¬çš„<strong>Store</strong>ç±»å¤§çº¦æœ‰15è¡Œä»£ç ï¼Œè€Œå›è°ƒåˆ™éœ€è¦å¦å¤–4è¡Œå·¦å³ã€‚è¿™æ˜¯æˆ‘ä»¬â€œ<strong>architecture</strong>â€çš„æ ¸å¿ƒï¼Œå®ƒæè¿°äº†åœ¨åº”ç”¨ç¨‹åºä¸­åº”ç”¨çŠ¶æ€å˜åŒ–çš„ä¸€è‡´æ–¹å¼ã€‚</p>
<p>è¿™ç§æ¶æ„é£æ ¼çš„å”¯ä¸€ç¼ºç‚¹å’Œæˆæœ¬æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›ä»£ç ç”Ÿæˆï¼Œä»¥ä¾¿ä¸ºæˆ‘ä»¬çš„æ“ä½œæšä¸¾çš„æ¯ä¸ªæ¡ˆä¾‹æä¾›å…³é”®è·¯å¾„ã€‚ æˆ‘ä»¬åŒæ„è¿™ä¸æ˜¯ç†æƒ³çš„ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬åªæ˜¯åœ¨åšä»£ç ç”Ÿæˆæ¥å¼¥è¡¥Swiftä¸­ç»“æ„ä½“å’Œæšä¸¾ä¹‹é—´çš„ä¸å¹³è¡¡ã€‚æˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯ä»£ç ç”Ÿæˆçš„ä¸€ç§æ— å®³çš„ç”¨æ³•ï¼Œå› ä¸ºå®ƒè§£å†³äº†Swiftæ•°æ®ç±»å‹çš„ä¸€ä¸ªä¸¥é‡ç¼ºé™·ï¼Œå¸Œæœ›æœ‰ä¸€å¤©Swiftèƒ½å¤Ÿè§£å†³structå’Œenumä¹‹é—´çš„è¿™ç§ä¸å¹³è¡¡ã€‚</p>
<h2 id="till-next-time">Till next time</h2>
<p>æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†æ¶æ„çš„åŸºç¡€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ¢ç´¢ä¸ä¹‹ç›¸å…³çš„ä¸œè¥¿ï¼Œä»¥è§£é”åœ¨æ—§çš„åº”ç”¨ç¨‹åºåˆ¶ä½œæ–¹å¼ä¸­ç”šè‡³ä¸å¯èƒ½å®ç°çš„åŠŸèƒ½ã€‚æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºè¿‡å¾ˆå¤šæ¬¡å…³äºç§°ä¸ºâ€œé«˜é˜¶ç»“æ„â€ã€‚åœ¨è¿™é‡Œï¼Œä½ è¦åšä¸€äº›ä½ å·²ç»å­¦ä¹ è¿‡çš„æ„é€ ï¼Œå¹¶å°†å®ƒæå‡åˆ°ä¸€ä¸ªæ›´é«˜çš„å±‚æ¬¡ï¼Œé€šè¿‡è€ƒè™‘å‡½æ•°ï¼ŒæŠŠé‚£ä¸ªå¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œç„¶åè¿”å›é‚£ä¸ªå¯¹è±¡ä½œä¸ºè¾“å‡ºã€‚ å…¸å‹çš„ä¾‹å­æ˜¯â€œé«˜é˜¶å‡½æ•°â€ï¼Œå³ä»¥å‡½æ•°ä½œä¸ºè¾“å…¥ï¼Œä»¥å‡½æ•°ä½œä¸ºè¾“å‡ºçš„å‡½æ•°ã€‚</p>
<p>ä½†åœ¨Point-Freeä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè€ƒè™‘äº†â€œé«˜é˜¶éšæœºæ•°ç”Ÿæˆå™¨â€ï¼Œå³å°†Genç±»å‹ä½œä¸ºè¾“å…¥å¹¶è¿”å›Genç±»å‹ä½œä¸ºè¾“å‡ºçš„å‡½æ•°ã€‚æˆ‘ä»¬è¿˜è€ƒè™‘äº†â€œé«˜é˜¶è§£æå™¨â€ï¼Œè¿™æ˜¯å°†è§£æå™¨ä½œä¸ºè¾“å…¥å¹¶å°†è§£æå™¨ä½œä¸ºè¾“å‡ºçš„å‡½æ•°ã€‚æ¯å½“ä½ å½¢æˆè¿™äº›æ›´é«˜é˜¶ç»“æ„ä¹‹ä¸€æ—¶ï¼Œä½ å°±è·å¾—äº†è§£é”æ–°ä¸œè¥¿çš„èƒ½åŠ›ï¼Œè¿™æ˜¯æ™®é€šç»“æ„å•ç‹¬åšä¸åˆ°çš„ã€‚</p>
<p>é‚£ä¹ˆâ€œ<strong>higher order reducer</strong>â€åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„å‘¢? ä¸€ä¸ªå‡½æ•°ä»¥<strong>reducer</strong>ä½œä¸ºè¾“å…¥ï¼Œä»¥<strong>reducer</strong>ä½œä¸ºè¾“å‡ºï¼Œè¿™æ„å‘³ç€ä»€ä¹ˆ?</p>
<p>æˆ‘ä»¬ä¸‹æ¬¡å†æ¢è®¨è¿™ä¸ªé—®é¢˜!</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-69-composable-state-management-state-pullbacks/">
                  <h3 class="post-title">
                    PointFree Episode 69: Composable State Management: State Pullbacks
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
