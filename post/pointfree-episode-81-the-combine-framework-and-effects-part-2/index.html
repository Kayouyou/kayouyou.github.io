<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 81: The Combine Framework and Effects: Part 2 | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1645875724842">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="

PointFree Episode 81: The Combine Framework and Effects: Part 2

Effect as a Combine publisher
Pulling back reducers w..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1645875724842" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 81: The Combine Framework and Effects: Part 2</h2>
            <div class="post-date">2021-11-28</div>
            
            <div class="post-content" v-pre>
              <!-- TOC -->
<ul>
<li><a href="#pointfree-episode-81-the-combine-framework-and-effects-part-2">PointFree Episode 81: The Combine Framework and Effects: Part 2</a>
<ul>
<li><a href="#effect-as-a-combine-publisher">Effect as a Combine publisher</a></li>
<li><a href="#pulling-back-reducers-with-publishers">Pulling back reducers with publishers</a></li>
<li><a href="#finishing-the-architecture-refactor">Finishing the architecture refactor</a></li>
<li><a href="#refactoring-synchronous-effects">Refactoring synchronous effects</a></li>
<li><a href="#refactoring-asynchronous-effects">Refactoring asynchronous effects</a></li>
<li><a href="#whats-the-point">Whatâ€™s the point?</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<!-- # PointFree Episode 81: The Combine Framework and Effects: Part 2 -->
<h2 id="effect-as-a-combine-publisher">Effect as a Combine publisher</h2>
<p>é‡æ„éå¸¸ç®€å•ï¼Œè¿‡ç¨‹ä¸­åªæœ‰ä¸€äº›æ›²æŠ˜ã€‚ä¹Ÿè®¸æœ€ç®€å•çš„å¼€å§‹æ–¹æ³•æ˜¯ç®€å•åœ°æ³¨é‡Šæ‰<strong>Effect</strong>ç±»å‹ï¼Œå¹¶ç”¨æŒ‡å‘<strong>publisher</strong>çš„ç±»å‹åˆ«åæ›¿æ¢å®ƒã€‚ç„¶è€Œï¼Œç”±äº<strong>Publisher</strong>æ˜¯ä¸€ä¸ªåè®®ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¿…é¡»å®é™…é€‰æ‹©ä¸€ä¸ªå…·ä½“çš„<strong>Publisher</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‹¹æœæä¾›çš„<strong>AnyPublisher</strong>å®ç°ä¸€è‡´æ€§ï¼Œä½†æ‹¥æœ‰è‡ªå·±çš„å‘½åç±»å‹ä¼šå¾ˆæ–¹ä¾¿ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸æ±¡æŸ“<strong>AnyPublisher</strong>çš„æƒ…å†µä¸‹ä¸ºå®ƒæ·»åŠ ç‰¹å®šçš„å¸®åŠ©å’Œæ‰©å±•ã€‚</p>
<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å°è¯•ä»é›¶å¼€å§‹åˆ›é€ ä¸€ä¸ªåˆæ ¼çš„<strong>publisher</strong>:</p>
<pre><code class="language-swift">public struct Effect: Publisher {
}
</code></pre>
<blockquote>
<p>ğŸ›‘ Type â€˜Effectâ€™ does not conform to protocol â€˜Publisherâ€™</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦å®ç°ä¸€äº›ä¸€è‡´æ€§ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹éœ€è¦ä»€ä¹ˆ:</p>
<pre><code class="language-swift">public struct Effect: Publisher {
  public typealias Output = &lt;#type#&gt;
  public typealias Failure = &lt;#type#&gt;

}
</code></pre>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>Outputå’ŒFailure</strong>ç±»å‹ã€‚è®°ä½ï¼Œ<strong>effect</strong>çš„å”¯ä¸€ç›®çš„æ˜¯æœ€ç»ˆäº§ç”Ÿä¸€ä¸ªåé¦ˆåˆ°<strong>store</strong>çš„åŠ¨ä½œã€‚å³ä½¿<strong>effect</strong>åœ¨æŸç§ç¨‹åº¦ä¸Šå‡ºé”™ï¼Œæ¯”å¦‚è®¾å¤‡ç¦»çº¿æ—¶çš„ç½‘ç»œè¯·æ±‚ï¼Œå®ƒä»ç„¶éœ€è¦äº§ç”Ÿä¸€ä¸ªåŠ¨ä½œã€‚å› æ­¤ï¼Œæ•ˆæœå¯ä»¥åœ¨åŠ¨ä½œä¸­æ”¾å…¥<strong>Result</strong>å€¼æ¥è¡¨ç¤ºå¤±è´¥ï¼Œä½†<strong>effect publisher</strong>æœ¬èº«ä¸èƒ½å¤±è´¥ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åº”è¯¥å°†<strong>Never</strong>ç”¨äº<strong>publisher</strong>çš„<strong>Failure</strong>ç±»å‹:</p>
<pre><code class="language-swift">public struct Effect: Publisher {
  public typealias Output = &lt;#type#&gt;
  public typealias Failure = Never
}
</code></pre>
<p>å¦ä¸€æ–¹é¢ï¼Œè¿™ç§ç±»å‹çš„ç”¨æˆ·éœ€è¦ç¡®å®šè¾“å‡ºï¼Œæ‰€ä»¥å®ƒåº”è¯¥æ˜¯é€šç”¨çš„:</p>
<pre><code class="language-swift">public struct Effect&lt;Output&gt;: Publisher {
  public typealias Failure = Never
}
</code></pre>
<p>å®Œæˆåè¿˜æœ‰ä¸€ä¸ªè¦æ±‚:</p>
<pre><code class="language-swift">public func receive&lt;S&gt;(
  subscriber: S
) where S: Subscriber, Failure == S.Failure, Output == S.Input {
  &lt;#code#&gt;
}
</code></pre>
<p>å½“<strong>subscriber</strong>é™„åŠ åˆ°æ­¤<strong>publisher</strong>æ—¶å°†è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦å‘é€æ­¤<strong>subscriber</strong>å€¼çš„åœ°æ–¹ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å®é™…ä¸Šä¸æƒ³åœ¨è¿™é‡Œåšä»»ä½•è‡ªå®šä¹‰å·¥ä½œã€‚æˆ‘ä»¬åªæ˜¯æƒ³å……å½“<strong>publishers</strong>çš„åŒ…è£…å™¨ï¼Œå°±åƒ<strong>AnyPublisher</strong>ä¸€æ ·ã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æŠŠ<strong>AnyPublisher</strong>éšè—èµ·æ¥å¹¶å§”æ‰˜ç»™å®ƒ:</p>
<pre><code class="language-swift">let publisher: AnyPublisher&lt;Output, Failure&gt;

public func receive&lt;S&gt;(subscriber: S) where S : Subscriber, Failure == S.Failure, Output == S.Input {
  self.publisher.receive(subscriber: subscriber)
}
</code></pre>
<p>ç°åœ¨<strong>Effect publisher</strong>å’Œ<strong>AnyPublisher</strong>å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œåªä¸è¿‡å®ƒçš„å¤±è´¥æ˜¯ä¸“é—¨é’ˆå¯¹<strong>Never</strong>çš„ã€‚ç„¶è€Œï¼Œæœ‰äº†è‡ªå·±çš„ç±»å‹ï¼Œæˆ‘ä»¬å°±èƒ½æ›´å¥½åœ°æ§åˆ¶å®ƒçš„è½¬å˜ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°ã€‚</p>
<p>è¿™é€ æˆäº†è®¸å¤šç¼–è¯‘é”™è¯¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯:</p>
<pre><code class="language-swift">effect.run(self.send)
</code></pre>
<blockquote>
<p>ğŸ›‘ Value of type â€˜Effectâ€™ has no member â€˜runâ€™</p>
</blockquote>
<p>ä»£æ›¿è¿è¡Œæˆ‘ä»¬çš„<strong>effect</strong>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ƒä¸Šè°ƒç”¨<strong>sink</strong>ï¼Œå¹¶ä¸”æˆ‘ä»¬ä»ç„¶å¯ä»¥å°†<strong>send</strong>æ–¹æ³•ä¼ é€’ç»™<strong>receive</strong>å—:</p>
<pre><code class="language-swift">effect.sink(receiveValue: self.send)
</code></pre>
<p>Now we have a warning:</p>
<blockquote>
<p>âš ï¸ Result of call to â€˜sink(receiveValue:)â€™ is unused</p>
</blockquote>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬çš„<strong>store</strong>ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªå¯å–æ¶ˆå¯¹è±¡çš„å®ä¾‹å˜é‡:</p>
<pre><code class="language-swift">private var cancellable: Cancellable?
</code></pre>
<p>å½“æˆ‘ä»¬è®¨è®ºæŸ¥çœ‹<strong>store</strong>çš„æ¦‚å¿µæ—¶ï¼Œæˆ‘ä»¬åœ¨å…³äºæ¨¡å—åŒ–çš„ç« èŠ‚ä¸­æ·»åŠ äº†è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å±•ç¤ºäº†å°†æ“ä½œå…¨å±€çŠ¶æ€å’Œæ“ä½œçš„<strong>store</strong>è½¬æ¢ä¸ºæ“ä½œæœ¬åœ°çŠ¶æ€å’Œæ“ä½œçš„<strong>store</strong>æ˜¯å¯èƒ½çš„ã€‚ä½†æ˜¯ï¼Œä¸ºäº†åœ¨æœ¬åœ°<strong>store</strong>ä¸­åæ˜ å¯¹å…¨å±€<strong>store</strong>çš„æ›´æ”¹ï¼Œæˆ‘ä»¬å¿…é¡»è®¢é˜…å…¨å±€<strong>store</strong>å¹¶åœ¨æœ¬åœ°<strong>store</strong>ä¸­é‡æ’­è¿™äº›æ›´æ”¹ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¸æƒ³é‡æ–°ä½¿ç”¨è¿™ä¸ªå¯å–æ¶ˆçš„å€¼ï¼Œå®ƒç°åœ¨æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„è´£ä»»ã€‚äº‹å®ä¸Šï¼Œä¹Ÿè®¸æˆ‘ä»¬åº”è¯¥é‡æ–°å‘½åå®ƒï¼Œä»¥æ›´å¥½åœ°åæ˜ å®ƒçš„ç›®çš„:</p>
<pre><code class="language-swift">private var viewCancellable: Cancellable?
</code></pre>
<p>æˆ‘ä»¬éœ€è¦åˆ†åˆ«è·Ÿè¸ªè¿™äº›å¯å–æ¶ˆçš„æ•ˆæœå’Œè¿™ä¸ªå¯å–æ¶ˆè§†å›¾ã€‚æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªæ–°çš„å®ä¾‹å˜é‡:</p>
<pre><code class="language-swift">private var effectCancellable: Cancellable?
</code></pre>
<p>ä½†æˆ‘ä»¬çœŸçš„éœ€è¦ä¸€å †å¯å–æ¶ˆçš„ä¸œè¥¿ã€‚æ¯ä¸ª<strong>reducer</strong>éƒ½å¯ä»¥è¿”å›ä¸€ä¸ª<strong>effects</strong>æ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬æ¯æ¬¡å‘é€ä¸€ä¸ªåŠ¨ä½œæ—¶éƒ½å¯èƒ½è¦å¤„ç†å¤šä¸ª<strong>effects</strong>ã€‚é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å‡çº§åˆ°ä¸€ä¸ªæ•°ç»„:</p>
<pre><code class="language-swift">private var effectCancellables: [Cancellable] = []
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¿ç•™è°ƒç”¨<strong>sink</strong>æ—¶çš„å¯å–æ¶ˆå‡½æ•°ï¼Œè¿™æ ·å®ƒå°±èƒ½æ´»å¾ˆä¹…ï¼Œè®©æˆ‘ä»¬çš„<strong>effect</strong>å®Œæˆå®ƒçš„å·¥ä½œ:</p>
<pre><code class="language-swift">effectCancellables.append(
  effect.sink(receiveValue: self.send)
)
</code></pre>
<p>ç„¶è€Œï¼Œè¿™å¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚è¿™ä¸ª<strong>effectCancellables</strong>æ•°ç»„å°†éšç€åº”ç”¨ç¨‹åºçš„è¿›å±•è€Œç»§ç»­å¢é•¿ã€‚æˆ‘ä»¬æ°¸è¿œä¸ä¼šä»è¿™ä¸ªæ•°ç»„ä¸­åˆ é™¤å¯å–æ¶ˆé¡¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•æ¥çŸ¥é“ä»€ä¹ˆæ—¶å€™æ•ˆæœç»“æŸï¼Œç„¶åæˆ‘ä»¬åº”è¯¥ä»æ•°ç»„ä¸­åˆ é™¤å®ƒçš„å¯å–æ¶ˆã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦ä¸€ç§è¶…è½½æ°´æ§½ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨<strong>publisher</strong>çš„å®Œæˆäº‹ä»¶:</p>
<pre><code class="language-swift">effectCancellables.append(
  effect.sink(
    receiveCompletion: { _ in
      &lt;#code#&gt;
    },
    receiveValue: self.send
  )
)
</code></pre>
<p>åœ¨è¿™ä¸ª<strong>receiveCompletion</strong>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä»æ•°ç»„ä¸­ç§»é™¤è¿™ä¸ª<strong>cancellable</strong>ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šæ²¡æœ‰è®¿é—®å®ƒçš„æƒé™ã€‚æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹çš„é—®é¢˜ï¼Œ<strong>cancellable</strong>æ˜¯é€šè¿‡è°ƒç”¨<strong>sink</strong>åˆ›å»ºçš„ï¼Œä½†æˆ‘ä»¬éœ€è¦ä»å®šä¹‰<strong>sink</strong>çš„ä¸€ä¸ªé—­åŒ…ä¸­è®¿é—®<strong>cancellable</strong>ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†<strong>cancellable</strong>æå–åˆ°éšå¼è§£åŒ…è£…çš„å¯é€‰å¯¹è±¡ä¸­ï¼Œè¿™å…è®¸æˆ‘ä»¬åœ¨ç±»å‹ä¿å­˜å€¼ä¹‹å‰è·å–å˜é‡ï¼Œç„¶åå†å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ã€‚</p>
<p>å®ƒçœ‹èµ·æ¥åƒè¿™æ ·;</p>
<pre><code class="language-swift">var effectCancellable: Cancellable!
effectCancellable = effect.sink(
  receiveCompletion: { _ in

},
  receiveValue: self.send
)
self.effectCancellables.append(
)
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è®¿é—®<strong>receiveCompletion</strong>å†…éƒ¨çš„å¯å–æ¶ˆæ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨<strong>publisher</strong>å®Œæˆæ—¶åˆ é™¤å¯å–æ¶ˆå¯¹è±¡ã€‚æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥ä»æ•°ç»„ä¸­åˆ é™¤ä¸€ä¸ªå€¼ï¼Œä¾‹å¦‚åˆ é™¤ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªæˆ–ç‰¹å®šçš„ä¸‹æ ‡ï¼Œä½†è¦ä»æ•°ç»„ä¸­åˆ é™¤ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œæˆ‘ä»¬å¿…é¡»æœç´¢æ•´ä¸ªæ•°ç»„å¹¶æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦åˆ é™¤çš„å€¼:</p>
<pre><code class="language-swift">self.effectCancellables.removeAll(where: { $0 == effectCancellable })
</code></pre>
<p>ä½†è¿™æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸º<strong>Cancellable</strong>åè®®æ²¡æœ‰ç»§æ‰¿<strong>Equatable</strong>åè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åšè¿™ä¸ªç­‰å¼æ£€æŸ¥ã€‚ç„¶è€Œï¼Œ<strong>AnyCancellable</strong>åŒ…è£…å™¨æ˜¯ä¸€ä¸ªç±»ï¼Œå› æ­¤ç”±äºå¯¹è±¡æ ‡è¯†ï¼Œå®ƒæ˜¯<strong>equatable</strong>ã€‚</p>
<p>æˆ‘ä»¬æŠŠæ‰€æœ‰éƒ½å‡çº§åˆ°<strong>AnyCancellable</strong>ã€‚å±æ€§:</p>
<pre><code class="language-swift">private var effectCancellables: [AnyCancellable] = []

// â€¦
func send(_ action: Action) {
  // â€¦
  var effectCancellable: AnyCancellable!
  effectCancellable = effect.sink(
    receiveCompletion: { _ in
      self.effectCancellables.removeAll(where: { $0 == effectCancellable })
  },
    receiveValue: self.send
  )
</code></pre>
<p>æœ€åå°†è¿™ä¸ª<strong>cancellable</strong>æ·»åŠ åˆ°æ•°ç»„ä¸­ã€‚</p>
<pre><code class="language-swift">self.effectCancellables.append(effectCancellable)
</code></pre>
<p>ä¸€ä¸ªå°é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬åœ¨<strong>cancellable</strong>çš„<strong>completion handler</strong>ä¸­å¼•ç”¨äº†<strong>self</strong>ï¼Œè€Œ<strong>cancellable</strong>è¢«<strong>self</strong>å¼•ç”¨:</p>
<pre><code class="language-swift">effectCancellable = effect.sink(
  receiveCompletion: { _ in
    self.effectCancellables.removeAll(where: { $0 == effectCancellable })
},
</code></pre>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨[**weak self]**æ¥æ‰“ç ´è¿™ä¸ªå¾ªç¯:</p>
<pre><code class="language-swift">receiveCompletion: { [weak self] _ in
  self?.effectCancellables.removeAll(where: { $0 == effectCancellable })
}
</code></pre>
<p>è¿™åœ¨æŠ€æœ¯ä¸Šä¿®å¤äº†æˆ‘ä»¬æ¶æ„çš„è¿™ä¸€éƒ¨åˆ†ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ­¤åšå‡ºå¿«é€Ÿæ”¹è¿›ã€‚<strong>AnyCancellable</strong>ç±»ç¬¦åˆ<strong>Hashable</strong>åè®®ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªé›†åˆä¸­ä½¿ç”¨å®ƒä»¬ï¼Œè¿™å°†ç»™æˆ‘ä»¬ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•æ¥åˆ é™¤å®ƒä»¬:</p>
<pre><code class="language-swift">private var effectCancellables: Set&lt;AnyCancellable&gt; = []

// â€¦
func send(_ action: Action) {
  // â€¦
  var effectCancellable: AnyCancellable!
  effectCancellable = effect.sink(
    receiveCompletion: { [weak self] _ in
      self?.effectCancellables.remove(effectCancellable)
    },
    receiveValue: self.send
  )
  effectCancellables.insert(effectCancellable)
</code></pre>
<h2 id="pulling-back-reducers-with-publishers">Pulling back reducers with publishers</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„æ¶æ„å¼•å…¥äº†è‡ªå·±çš„<strong>publisher Effect</strong>ã€‚æˆ‘ä»¬å·²ç»å‡çº§äº†<strong>Store</strong>ï¼Œåœ¨å®ƒçš„<strong>send</strong>æ–¹æ³•ä¸­å¤„ç†è¿™äº›<strong>effects</strong>ï¼ŒåŒ…æ‹¬å¤„ç†å®ƒä»¬ç›¸å…³çš„å¯å–æ¶ˆå’Œå®Œæˆçš„æ‰€æœ‰å¤æ‚æ€§ã€‚</p>
<p>ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨<strong>pullback</strong>æ–¹æ³•ä¸­ï¼Œè®©æˆ‘ä»¬æé†’è‡ªå·±è¿™æ˜¯åšä»€ä¹ˆçš„ã€‚å®ƒéœ€è¦<strong>reducers</strong>å¯¹å±€éƒ¨stateå’Œè¡ŒåŠ¨èµ·ä½œç”¨ï¼Œå¹¶å°†å®ƒä»¬æ‹‰å›å¯¹æ›´å…¨å±€çš„stateå’Œè¡ŒåŠ¨çš„ä½œç”¨ã€‚å½“å±€éƒ¨<strong>reducer</strong>äº§ç”Ÿå±€éƒ¨<strong>effect</strong>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬åŒ–ä¸ºæ›´å…¨å±€çš„<strong>effect</strong>ã€‚å±€éƒ¨<strong>effect</strong>å¯ä»¥å°†å±€éƒ¨æ“ä½œè¿”å›åˆ°<strong>store</strong>ä¸­ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¯¥å±€éƒ¨æ“ä½œåŒ…è£…åˆ°æ›´å…¨å±€çš„æ“ä½œä¸­ã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨æˆ‘ä»¬çš„æ–°<strong>publisher</strong>æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚</p>
<p><strong>pullback</strong>å‡½æ•°å½“å‰æœ‰ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚</p>
<pre><code class="language-swift">return localEffects.map { localEffect in
  Effect { callback in
    localEffect.run { localAction in // ğŸ›‘
      var globalAction = globalAction
      globalAction[keyPath: action] = localAction
      callback(globalAction)
    }
  }
}
</code></pre>
<blockquote>
<p>ğŸ›‘ Value of type â€˜Effectâ€™ has no member â€˜runâ€™</p>
</blockquote>
<p>æˆ‘ä»¬æ­£åœ¨å°è¯•è°ƒç”¨<strong>run</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å­˜åœ¨äºæˆ‘ä»¬çš„æ—§<strong>effect</strong>ç±»å‹ä¸­ï¼Œä½†åœ¨æˆ‘ä»¬çš„<strong>publisher</strong>ä¸­ä¸å†å­˜åœ¨ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨<strong>sink</strong>:</p>
<pre><code class="language-swift">return localEffects.map { localEffect in
  Effect { callback in
    localEffect.sink { localAction in // ğŸ›‘
      var globalAction = globalAction
      globalAction[keyPath: action] = localAction
      callback(globalAction)
    }
  }
}
</code></pre>
<p>ä½†<strong>sink</strong>è¿”å›ä¸€ä¸ª<strong>AnyCancellable</strong>ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦è·Ÿè¸ªçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ç”šè‡³ä¸æ¸…æ¥šæˆ‘ä»¬è¦æ€ä¹ˆåšï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸€ä¸ª<strong>pullback</strong>ï¼Œè¿™æ˜¯åœ¨çº¯å‡½æ•°<strong>reducer</strong>çš„ä¸–ç•Œï¼Œæ²¡æœ‰<strong>store</strong>åœ¨å¯è§†èŒƒå›´å†…ç®¡ç†è¿™äº›ç»†èŠ‚ã€‚</p>
<p>æˆ‘ä»¬è¿˜è¯•å›¾åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å›è°ƒé—­åŒ…çš„æ•ˆæœï¼Œä½†æˆ‘ä»¬ä¸å†æ‹¥æœ‰é‚£ä¸ªæ¥å£ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³ä¸€ä¸‹è¿™æ®µä»£ç å®é™…ä¸Šåœ¨åšä»€ä¹ˆï¼Œå®ƒåªæ˜¯è¯•å›¾å°†ä¸€ä¸ªå¯ä»¥äº§ç”Ÿå±€éƒ¨åŠ¨ä½œçš„<strong>effect</strong>è½¬æ¢æˆä¸€ä¸ªå¯ä»¥äº§ç”Ÿå…¨å±€åŠ¨ä½œçš„<strong>effect</strong>ã€‚è¿™æ­£æ˜¯<strong>map</strong>æ“ä½œå…è®¸æˆ‘ä»¬å¯¹æ³›å‹ç±»å‹æ‰€åšçš„ï¼Œå¹¸è¿çš„æ˜¯ï¼Œ<strong>Publisher</strong>ç±»å‹æ”¯æŒ<strong>map</strong>æ“ä½œ!</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<strong>Publisher</strong>æ‹¥æœ‰<strong>map</strong>è¿™ä¸€äº‹å®ï¼Œå°†æ‰€æœ‰è¿™äº›æ‰‹åŠ¨<strong>effect</strong>è½¬æ¢ä»£ç æ›¿æ¢ä¸ºä¸€ä¸ªç®€å•çš„<strong>map</strong>:</p>
<pre><code class="language-swift">localEffect.map { localAction in
  var globalAction = globalAction
  globalAction[keyPath: action] = localAction
  callback(globalAction)
}
</code></pre>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°å°†è¿™ä¸ªå€¼è¿”å›ç»™<strong>map</strong>ï¼Œè€Œä¸æ˜¯å°†<strong>globalAction</strong>æä¾›ç»™<strong>callback</strong>å‡½æ•°:</p>
<pre><code class="language-swift">localEffect.map { localAction in
  var globalAction = globalAction
  globalAction[keyPath: action] = localAction
  return globalAction
}
</code></pre>
<p>è¿™åŸºæœ¬ä¸Šæ˜¯å¯¹çš„ï¼Œä½†ä¸æ˜¯ç¼–è¯‘ã€‚è¿™ä¸ªé”™è¯¯æ¶ˆæ¯ä¸æ˜¯å¾ˆå¥½ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨é—­åŒ…ä¸­æ·»åŠ ä¸€ä¸ªè¿”å›ç±»å‹ï¼Œå®ƒä¼šå˜å¾—å¥½ä¸€ç‚¹:</p>
<pre><code class="language-swift">localEffect.map { localAction -&gt; GlobalAction in
  var globalAction = globalAction
  globalAction[keyPath: action] = localAction
  return globalAction
}
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜Publishers.Map&lt;Effect, GlobalAction&gt;â€™ to closure result type â€˜Effectâ€™</p>
</blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„é”™è¯¯æ¶ˆæ¯ï¼Œä½†å®ƒæ­£ç¡®åœ°æè¿°äº†ä»€ä¹ˆæ˜¯é”™è¯¯çš„ã€‚æˆ‘ä»¬æœŸæœ›ä»<strong>map</strong>è¿”å›çš„ç±»å‹æ˜¯<strong>Effect<GlobalAction></strong>ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªå‡½æ•°è¿”å›è¿™äº›ä¸œè¥¿çš„æ•°ç»„ã€‚ä½†å®ƒæ²¡æœ‰æ‰¾åˆ°è¿™ç§ç±»å‹ï¼Œè€Œæ˜¯æ‰¾åˆ°äº†è¿™ä¸ªå¥‡æ€ªçš„**Publisher.Map&lt;Effect<LocalAction>ï¼Œ GlobalAction&gt;**ç±»å‹ï¼Œæœ‰ç‚¹æ‹—å£ã€‚</p>
<p>è¿™ç»™æˆ‘ä»¬å¸¦æ¥äº†åœ¨å¤„ç†<strong>Combine</strong>æ¡†æ¶æ—¶çš„å¦ä¸€ä¸ªé‡è¦æ•™è®­ã€‚ <strong>Publisher</strong>æœ‰å¾ˆå¤šæ“ä½œï¼Œåƒ<strong>map, zip, flatMap, filter</strong>ç­‰ç­‰ã€‚ä½†å®ƒä»¬ä¸ä¼šè¿”å›ä¸å®ƒä»¬æ‰€æ“ä½œçš„<strong>publisher</strong>ç±»å‹å®Œå…¨ç›¸åŒçš„<strong>publisher</strong>ï¼Œå®ƒä»¬åªè¿”å›ç¬¦åˆ<strong>Publisher</strong>åè®®çš„å†…å®¹ã€‚è¿™æ˜¯ç”±äºSwiftçš„ç±»å‹ç³»ç»Ÿçš„é™åˆ¶ï¼Œè™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†ä¸èƒ½è¡¨è¾¾å¯¹ä¸€ä¸ª<strong>publisher</strong>è¿›è¡Œ<strong>map</strong>æ“ä½œè¿”å›ä¸€ä¸ªç›¸åŒç±»å‹çš„<strong>publisher</strong>çš„æƒ³æ³•ï¼Œæ¯”å¦‚<strong>map on Effect</strong>è¿”å›å¦ä¸€ä¸ª<strong>Effect</strong>ã€‚</p>
<p><strong>map</strong>æ“ä½œè¿”å›çš„ç±»å‹ç§°ä¸º<strong>Map publisher</strong>ã€‚</p>
<pre><code class="language-swift">Publishers.Map&lt;Effect&lt;LocalAction&gt;, GlobalAction&gt;
</code></pre>
<p>ç¬¬ä¸€ä¸ªæ³›å‹æŒ‡çš„æ˜¯æˆ‘ä»¬è¦æ˜ å°„çš„<strong>publisher</strong>ï¼Œç¬¬äºŒä¸ªæ³›å‹æŒ‡çš„æ˜¯æ˜ å°„çš„<strong>publisher</strong>å¯ä»¥å‘å‡ºçš„æ–°å€¼ã€‚è¿™è¡¨ç¤ºæˆ‘ä»¬å·²ç»æ˜ å°„åˆ°<strong>Effect</strong>ä¸Šå°†<strong>LocalActions</strong>çš„å€¼è½¬æ¢ä¸º<strong>GlobalActions</strong>ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ª<strong>publisher</strong>å˜æˆä¸€ä¸ªæ™®é€šçš„æ—§<strong>Effect</strong>ã€‚</p>
<p>è¿™ä¸<strong>Combine</strong>çš„<strong>AnyPublisher</strong>æ‰€é¢ä¸´çš„é—®é¢˜å®Œå…¨ç›¸åŒï¼Œä»–ä»¬çš„è§£å†³æ–¹æ³•æ˜¯å…è®¸ä»»ä½•<strong>publisher</strong>å°†è‡ªå·±è½¬å˜ä¸º<strong>AnyPublisher</strong>:</p>
<pre><code class="language-swift">.eraseToAnyPublisher()
</code></pre>
<p>æˆ‘ä»¬åŸºæœ¬ä¸Šæƒ³è¦è¿™ä¸ªåŠŸèƒ½ï¼Œä½†ç”¨æˆ‘ä»¬çš„<strong>Effect</strong>ç±»å‹ä»£æ›¿ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ª<strong>eraseToEffect</strong>æ–¹æ³•ã€‚å®ƒè¢«è¡¨ç¤ºä¸º<strong>Publisher</strong>åè®®ä¸Šçš„æ‰©å±•ï¼Œå› æ­¤ä»»ä½•<strong>publisher</strong>éƒ½å¯ä»¥è¢«åˆ é™¤ï¼Œä½†å®ƒåº”è¯¥åªåœ¨ä¸èƒ½å¤±è´¥çš„<strong>publisher</strong>ä¸Šå·¥ä½œ:</p>
<pre><code class="language-swift">extension Publisher where Failure == Never {
  public func eraseToEffect() -&gt; Effect&lt;Output&gt; {

  }
}
</code></pre>
<p>è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è‡ªå·±æ“¦é™¤åˆ°<strong>AnyPublisher</strong>ï¼Œç„¶åå°†å…¶åŒ…è£…åœ¨<strong>effect</strong>ç±»å‹ä¸­:</p>
<pre><code class="language-swift">extension Publisher where Failure == Never {
  public func eraseToEffect() -&gt; Effect&lt;Output&gt; {
    return Effect(publisher: self.eraseToAnyPublisher())
  }
}
</code></pre>
<p>è¿™å°±æ˜¯å®ƒçš„å…¨éƒ¨å†…å®¹ï¼Œä½†æ˜¯åœ¨æ©¡çš®ç±»å‹ä¸­åšè¿™ä¹ˆå¤šåŒ…è£…ä¼¼ä¹å¾ˆå¥‡æ€ªã€‚æˆ‘ä»¬è¿™æ ·åšä¸æ˜¯æ²¡æœ‰ç†ç”±çš„ï¼Œå®ƒå¾ˆå¿«å°±ä¼šå¾ˆæ–¹ä¾¿ï¼Œä½†ç°åœ¨å°±ç›¸ä¿¡æˆ‘ä»¬çš„è¯å§ã€‚</p>
<p>å›åˆ°æˆ‘ä»¬çš„<strong>pullback</strong>æ“ä½œï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†Mapå‘å¸ƒè€…åˆ é™¤ä¸ºEffectå‘å¸ƒè€…</p>
<pre><code class="language-swift">localEffect.map { localAction -&gt; GlobalAction in
  var globalAction = globalAction
  globalAction[keyPath: action] = localAction
  return globalAction
}
.eraseToEffect()
</code></pre>
<p>è¿™æœ€ç»ˆä½¿ç¼–è¯‘å™¨é«˜å…´ã€‚</p>
<p>ä¸å¹¸çš„æ˜¯ï¼Œå½“æ¶‰åŠåˆ°å¤„ç†<strong>Combine</strong>æ—¶ï¼Œè¿™ç§<strong>eraseToEffect dance</strong>å°†æ˜¯å¸¸è§çš„åšæ³•ã€‚<br>
å› ä¸ºæˆ‘ä»¬çš„<strong>reducer</strong>æ˜¯ç”¨<strong>Effect</strong>æ¥å®šä¹‰çš„ï¼Œè€Œå½“ä½ è½¬æ¢å®ƒçš„æ—¶å€™ï¼Œä½ å¾—åˆ°çš„ä¸æ˜¯ä¸€ä¸ª<strong>Effect</strong>ï¼Œæ‰€ä»¥åœ¨è¿”å›æ•ˆæœä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¤šæ¬¡è°ƒç”¨<strong>eraseToEffect</strong>ã€‚è¿™å¾ˆçƒ¦äººï¼Œä½†å¾ˆæœ‰å¿…è¦ã€‚</p>
<p>ä¸è¿‡ï¼Œ<strong>publishers</strong>æ‹¥æœ‰<strong>map</strong>æ“ä½œç¬¦æ˜¯ä»¶å¾ˆé…·çš„äº‹ã€‚æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ˆè®ºåœ°å›¾æ˜¯åœ¨Point-Freeçš„ç¬¬13é›†ï¼Œä¼¼ä¹æ˜¯å¾ˆä¹…ä»¥å‰çš„äº‹äº†! ä½†åœ¨é‚£ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†<strong>map</strong>æ“ä½œæ˜¯ä¸€ä¸ªéå¸¸æ™®éçš„ä¸œè¥¿ï¼Œå½“æ¶‰åŠåˆ°å®šä¹‰å®ƒæ—¶ï¼Œæ²¡æœ‰å¾ˆå¤šé€‰æ‹©ã€‚ä¸ºäº†æ”¯æŒä»–ä»¬ï¼Œæˆ‘ä»¬æåˆ°äº†Swiftæ ‡å‡†åº“æœ‰ä¸¤ä¸ªæ˜ å°„:ä¸€ä¸ªå®šä¹‰åœ¨æ•°ç»„ä¸Šï¼Œå¦ä¸€ä¸ªå®šä¹‰åœ¨å¯é€‰é¡¹ä¸Šã€‚ä»é‚£æ—¶èµ·ï¼Œå¼•å…¥äº†<strong>Result</strong>ç±»å‹ï¼Œå¹¶ä¸”å®ƒè¿˜å…·æœ‰<strong>map</strong>æ“ä½œç¬¦ã€‚ç°åœ¨æˆ‘ä»¬ç”šè‡³åœ¨<strong>Combine</strong>æ¡†æ¶ä¸­æœ‰äº†ä¸€ä¸ª<strong>map</strong>æ“ä½œç¬¦ã€‚è¿™æ„å‘³ç€ä»…åœ¨è‹¹æœçš„ç”Ÿæ€ç³»ç»Ÿä¸­å°±æœ‰4ç§ä¸åŒçš„åœ°å›¾æ“ä½œ!</p>
<h2 id="finishing-the-architecture-refactor">Finishing the architecture refactor</h2>
<p>è¿™ä¸ªæ–‡ä»¶ä¸­çš„ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨æˆ‘ä»¬çš„æ—¥å¿—é«˜é˜¶<strong>reducer</strong>ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬è¯•å›¾è¿”å›ä¸€ä¸ªåŒ…è£…äº†ä¸€äº›æ‰“å°è¯­å¥çš„æ•ˆæœã€‚</p>
<pre><code class="language-swift">return [Effect { _ in // ğŸ›‘
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
}] + effects
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜() -&gt; ()â€™ to expected argument type â€™AnyPublisher&lt;, Never&gt;â€™</p>
</blockquote>
<p>æˆ‘ä»¬åœ¨<strong>Effect</strong>ä¸Šä¸å†æœ‰åŸºäºå›è°ƒé—­åŒ…çš„åˆå§‹åŒ–å¼ï¼Œä½†æˆ‘ä»¬ä»¥å‰åœ¨<strong>Combine</strong>ä¸–ç•Œä¸­é‡åˆ°è¿‡ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›è¿”å›ä¸€ä¸ª<strong>publisher</strong>ï¼Œå®ƒå°è£…ä¼ å…¥çš„å·¥ä½œçš„æ‰§è¡Œï¼Œä½†æˆ‘ä»¬å¸Œæœ›ç¡®ä¿åœ¨è®¢é˜…<strong>publisher</strong>ä¹‹å‰ä¸è¿è¡Œè¯¥å·¥ä½œã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ï¼Œä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯å°†å®ƒåŒ…è£…åœ¨ä¸€ä¸ª<strong>Deferred publisher</strong>ä¸­:</p>
<pre><code class="language-swift">return [Deferred { _ in // ğŸ›‘
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
}] + effects
</code></pre>
<blockquote>
<p>ğŸ›‘ Contextual closure type â€˜() -&gt; _â€™ expects 0 arguments, but 1 was used in closure body</p>
</blockquote>
<p>ç°åœ¨<strong>Deferred</strong>è¦æ±‚æˆ‘ä»¬è¿”å›ä¸€ä¸ªå‘å¸ƒè€…ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬ä¸æƒ³åšä»»ä½•äº‹æƒ…ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªâ€œ<strong>fire-and-forget</strong>â€æ•ˆåº”ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªåä¸º<strong>Empty</strong>çš„ç‰¹æ®Šå‘å¸ƒè€…ï¼Œå®ƒä»ä¸å‘å‡ºä»»ä½•å€¼ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ç«‹å³å®Œæˆå®ƒ:</p>
<pre><code class="language-swift">return [Deferred { _ in
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
  return Empty(completeImmediately: true)
}] + effects
</code></pre>
<p>è¿™ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºSwiftéœ€è¦ä¸€äº›ç±»å‹æ¨æ–­æ–¹é¢çš„å¸®åŠ©:</p>
<pre><code class="language-swift">return [Deferred { () -&gt; Empty&lt;Action, Never&gt; in
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
  return Empty(completeImmediately: true)
}] + effects
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ›´å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚</p>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜Deferred&lt;Empty&lt;Action, Never&gt;&gt;â€™ to expected element type â€˜Effectâ€™</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å®ƒæ“¦é™¤åˆ°<strong>Effect</strong>ç±»å‹:</p>
<pre><code class="language-swift">return [Deferred { () -&gt; Empty&lt;Action, Never&gt; in
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
  return Empty(completeImmediately: true)
}.eraseToEffect()] + effects
</code></pre>
<p>ç¼–è¯‘å™¨å¾ˆé«˜å…´ï¼Œä½†æˆ‘ä»¬éœ€è¦åšçš„å·¥ä½œæœ‰ç‚¹ç²—ç³™ã€‚è®©æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªåŠ©æ‰‹ï¼Œå®ƒä»¥ä¸€ç§æ›´å¥½çš„æ–¹å¼å®ŒæˆåŒæ ·çš„å·¥ä½œã€‚ æˆ‘ä»¬å°†å®ƒåˆ›å»ºä¸º<strong>effect</strong>ä¸Šçš„é™æ€å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ª<strong>void-to-void</strong>é—­åŒ…å¹¶è¿”å›ä¸€ä¸ª<strong>effect</strong>:</p>
<pre><code class="language-swift">extension Effect {
  public static func fireAndForget(work: @escaping () -&gt; Void) -&gt; Effect {
  }
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æ•æ‰æˆ‘ä»¬åœ¨å¸®åŠ©è€…èº«ä¸Šåšçš„å·¥ä½œã€‚</p>
<pre><code class="language-swift">extension Effect {
  public static func fireAndForget(work: @escaping () -&gt; Void) -&gt; Effect {
    return Deferred { () -&gt; Empty&lt;Output, Never&gt; in
      work()
      return Empty(completeImmediately: true)
    }
    .eraseToEffect()
  }
}
</code></pre>
<p>ç°åœ¨è¿™æ˜¯å®Œç¾çš„æ‰“å°æ•ˆæœ:</p>
<pre><code class="language-swift">return [.fireAndForget {
  print(&quot;Action: \(action)&quot;)
  print(&quot;Value:&quot;)
  dump(newValue)
  print(&quot;---&quot;)
}] + effects
</code></pre>
<p>è¿™å°±æ˜¯æˆ‘ä»¬å¼•å…¥è‡ªå®šä¹‰<strong>Effect publisher</strong>ä¸€è‡´æ€§çš„ä¸»è¦åŸå› ï¼Œè€Œä¸æ˜¯ä»…ä»…ä¾èµ–<strong>AnyPublisher</strong>ã€‚è¿™å°†ç»™æˆ‘ä»¬æœºä¼šï¼Œè®©<strong>transforming publishers</strong> åœ¨è°ƒç”¨ä¸Šå˜å¾—æ›´å¥½ã€‚</p>
<p>å¯ç»„åˆæ¶æ„æ¨¡å—è¿˜æ²¡æœ‰ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰è¿™ä¸ªä¸Šæ¬¡æå–å‡ºæ¥çš„<strong>effects</strong>æ–‡ä»¶ã€‚ å®ƒåŒ…å«ä¸€äº›æ–¹ä¾¿çš„åŸºæœ¬<strong>effects</strong>ï¼Œç”¨äºç½‘ç»œè¯·æ±‚ã€JSONè§£ç å’Œå¼ºåˆ¶åœ¨ç‰¹å®šé˜Ÿåˆ—ä¸Šä¼ é€’å€¼ã€‚</p>
<p>æ‰€æœ‰è¿™äº›æ•ˆæœéƒ½å¾ˆæ£’ï¼Œä½†æ˜¯<strong>Combine</strong>æ¡†æ¶å®é™…ä¸Šæä¾›äº†å®Œæˆæ‰€æœ‰è¿™äº›ä»»åŠ¡çš„APIã€‚æˆ‘ä»¬ç”šè‡³ç”¨<strong>Combine</strong>æ¡†æ¶çš„åç§°æ¥å‘½åæ–¹æ³•ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å®é™…ä¸Šä¸éœ€è¦ä¿®å¤è¿™äº›ç¼–è¯‘é”™è¯¯ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°æ³¨é‡Šæ‰æ‰€æœ‰ä¸œè¥¿ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¾é <strong>Combine</strong>æ¥å®ç°è¿™äº›æ•ˆæœï¼Œè€Œä¸æ˜¯è‡ªå·±é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚</p>
<p>ç°åœ¨å¯ç»„åˆæ¶æ„æ¨¡å—æ­£åœ¨ç¼–è¯‘ã€‚</p>
<h2 id="refactoring-synchronous-effects">Refactoring synchronous effects</h2>
<p>ç°åœ¨ç»ˆäºæ„å»ºäº†<strong>ComposableArchitecture</strong>æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹é‡æ„åº”ç”¨ç¨‹åºï¼Œä»¥ä½¿ç”¨è¿™ç§æ–°çš„å‰¯ä½œç”¨ã€‚æˆ‘ä»¬æœ‰å‡ ä¸ªæ¨¡å—éœ€è¦æ„å»ºï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚</p>
<p>è®©æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåœ°åº”å¯¹ä»–ä»¬ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»æœ€ç®€å•çš„<strong>PrimeModal</strong>å¼€å§‹ã€‚å¦‚æœæˆ‘ä»¬åˆ‡æ¢åˆ°é‚£ä¸ªç›®æ ‡å¹¶è¿›è¡Œæ„å»ºï¼Œæˆ‘ä»¬ä¼šæƒŠå¥‡åœ°å‘ç°ä¸€åˆ‡éƒ½è¿˜åœ¨æ„å»ºã€‚ è¿™æ˜¯å› ä¸º<strong>primeModalReducer</strong>ä¸ä¼šäº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œå› æ­¤å®ƒå¹¶ä¸å…³å¿ƒæˆ‘ä»¬æ˜¯å¦æ›´æ”¹äº†<strong>effect</strong>ç±»å‹çš„å®šä¹‰ã€‚</p>
<p>ä¸‹ä¸€ä¸ªæœ€ç®€å•çš„æ¨¡å—æ˜¯<strong>FavoritePrimes</strong>æ¨¡å—ï¼Œå®ƒæ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬æ„é€ äº†ä¸€äº›ä¿å­˜å’ŒåŠ è½½æœ€çˆ±è´¨æ•°çš„<strong>effects</strong>ã€‚</p>
<p><strong>saveEffect</strong>æ˜¯ä¸€ä¸ª<strong>fire-and-forget</strong>æ•ˆæœï¼Œå®ƒç›®å‰ä½¿ç”¨çš„æ˜¯æ—§çš„å›è°ƒé£æ ¼çš„<strong>effect</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å®ƒæ›¿æ¢ä¸ºæ–°çš„<strong>fireAndForget</strong>åŠ©æ‰‹æ¥ç¼–è¯‘è¿™ä¸ªéƒ¨åˆ†:</p>
<pre><code class="language-swift">private func saveEffect(favoritePrimes: [Int]) -&gt; Effect&lt;FavoritePrimesAction&gt; {
  return .fireAndForget {
    ...
  }
}
</code></pre>
<p><strong>loadEffect</strong>æ˜¯ä¸€ä¸ªåŒæ­¥æ•ˆæœï¼Œéœ€è¦å°†ç»“æœåé¦ˆç»™ç³»ç»Ÿï¼Œå¹¶ä¸”å®ƒç›®å‰ä¹Ÿåœ¨ä½¿ç”¨æ—§çš„å›è°ƒé£æ ¼çš„æ•ˆæœã€‚ç±»ä¼¼äºåœ¨<strong>Effect</strong>ä¸Šåˆ›å»º<strong>fireAndForget helper</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒæ­¥æ•ˆæœ<strong>helper</strong>ã€‚</p>
<p>å®ƒåªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ‰§è¡Œä¸€äº›ç”ŸæˆåŠ¨ä½œçš„å·¥ä½œï¼Œæˆ‘ä»¬æƒ³è¿”å›ä¸€ä¸ªåŒ…è£…è¯¥å·¥ä½œçš„<strong>effect</strong>ã€‚</p>
<pre><code class="language-swift">extension Effect {
  public static func sync(work: @escaping () -&gt; Output) -&gt; Effect {
  }
}
</code></pre>
<p>åŒæ ·ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å·¥ä½œåŒ…è£…åœ¨<strong>Deferred</strong>ä¸­ï¼Œä»¥ä¾¿åœ¨è®¢é˜…å®Œæˆä¹‹å‰ä¸æ‰§è¡Œå·¥ä½œ:</p>
<pre><code class="language-swift">extension Effect {
  public static func sync(work: @escaping () -&gt; Output) -&gt; Effect {
    return Deferred {
    }
  }
}
</code></pre>
<p>ç„¶ååœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æƒ³è¿”å›ä¸€ä¸ªä¿å­˜ä½œå“ç»“æœçš„<strong>publisher</strong>ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<strong>Combine</strong>è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†å¦ä¸€ä¸ªå…·ä½“çš„<strong>publisher</strong>ï¼Œå®ƒçš„åç§°æ˜¯<strong>Just</strong>:</p>
<pre><code class="language-swift">extension Effect {
  public static func sync(work: @escaping () -&gt; Output) -&gt; Effect {
    return Deferred {
      Just(work())
    }
  }
}
</code></pre>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬æ€»æ˜¯éœ€è¦å°†å®ƒæ“¦é™¤åˆ°<strong>Effect</strong>ç±»å‹:</p>
<pre><code class="language-swift">extension Effect {
  public static func sync(work: @escaping () -&gt; Output?) -&gt; Effect {
    return Deferred {
      Just(work())
    }
    .eraseToEffect()
  }
}
</code></pre>
<p>è¿™æœ€ç»ˆè®©æˆ‘ä»¬è¿›å…¥äº†ç¼–è¯‘é¡ºåºã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å®šä¹‰æˆ‘ä»¬çš„<strong>loadEffect</strong>:</p>
<pre><code class="language-swift">private let loadEffect = Effect&lt;FavoritePrimesAction&gt;.sync {
  ...
    else { return }
  return .loadedFavoritePrimes(favoritePrimes)
}
</code></pre>
<p>è¿™ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œå› ä¸ºæ•ˆæœ&lt;<strong>FavoritePrimesAction&gt;.sync</strong>é—­åŒ…å¿…é¡»è¿”å›ä¸€ä¸ªå®é™…çš„<strong>FavoritePrimesAction</strong>ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªå¯é€‰çš„ã€‚æˆ‘ä»¬åœ¨<strong>guard</strong>ä¸­è¿”å›<strong>nil</strong>æ˜¯å› ä¸ºæŸäº›ä¸œè¥¿å¤±è´¥äº†ï¼Œæˆ‘ä»¬åªæ˜¯ä¸æƒ³åœ¨é‚£ç§æƒ…å†µä¸‹äº§ç”Ÿ<strong>effect</strong>ã€‚æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶äº‹æ˜¯å°†å…¶æ›´æ”¹ä¸º<strong>Effect&lt;FavoritePrimesAction?&gt;</strong>ã€‚</p>
<pre><code class="language-swift">private let loadEffect = Effect&lt;FavoritePrimesAction?&gt;.sync {
  ...
    else { return nil }
  return .loadedFavoritePrimes(favoritePrimes)
}
</code></pre>
<p>ä½†æ˜¯æˆ‘ä»¬çš„<strong>reducer</strong>è¿˜ä¸èƒ½ç›´æ¥ä½¿ç”¨<strong>loadEffect</strong>ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸è¿”å›éå¯é€‰åŠ¨ä½œçš„<strong>effects</strong>ä¸€èµ·å·¥ä½œã€‚ä¸ºäº†æ‘†è„±<strong>nil</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>compactMap</strong>:</p>
<pre><code class="language-swift">return [
  loadEffect
    .compactMap { $0 }
}
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ“¦é™¤ã€‚</p>
<pre><code class="language-swift">.compactMap { $0 }
.eraseToEffect()
</code></pre>
<p>è¿™ä¸ª<strong>compactMap</strong>æ“ä½œç¬¦åœ¨<strong>publishers</strong>ä¸Šçš„å·¥ä½œå°±åƒå®ƒåœ¨æ•°ç»„ä¸Šçš„å·¥ä½œä¸€æ ·ï¼Œå®ƒåªæ˜¯ç®€å•åœ°è¿‡æ»¤æ‰<strong>nil</strong>ï¼Œåªç•™ä¸‹è¯šå®çš„å€¼ã€‚</p>
<p>å°±åƒ<strong>favorite</strong>ç´ æ•°æ¨¡å—æ­£åœ¨æ„å»ºçš„é‚£æ ·ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬çš„æ•´ä¸ªåº”ç”¨è¿˜æ²¡æœ‰æ„å»ºï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬åœ¨æ¨¡å—åŒ–è¿™ä¸ªåº”ç”¨çš„åŠªåŠ›ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª<strong>playground</strong>ï¼Œå…è®¸æˆ‘ä»¬åœ¨æ„å»ºå…¶ä»–ä¸œè¥¿ä¹‹å‰ï¼Œå®Œå…¨ç‹¬ç«‹åœ°è¿è¡Œè¿™ä¸ªå±å¹•ã€‚æˆ‘ä»¬è·³è¿‡å»è½¬ä¸€åœˆå§ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ é™¤æœ€å–œæ¬¢çš„primeå¹¶ä¿å­˜æ›´æ”¹â€¦</p>
<blockquote>
<p>Fatal error: Unexpectedly found nil while implicitly unwrapping an Optional value: file PrimeTime/ComposableArchitecture/ComposableArchitecture.swift, line 80</p>
</blockquote>
<p>å“å“Ÿ!çœ‹æ¥æˆ‘ä»¬çš„å¯ç»„åˆæ¶æ„æ¨¡å—å´©æºƒäº†ã€‚æˆ‘ä»¬ä¸€å®šå¿½ç•¥äº†ä»€ä¹ˆã€‚å¦‚æœæˆ‘ä»¬åˆ°ç¬¬53è¡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æˆ‘ä»¬åœ¨è¿™ä¸€è¡Œå´©æºƒäº†:</p>
<pre><code class="language-swift">self?.effectCancellables.remove(effectCancellable)
</code></pre>
<p>è¿™åªä¼šåœ¨<strong>effectCancellable</strong>ä¸º<strong>nil</strong>æ—¶å´©æºƒï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯éšå¼è§£åŒ…è£…å¯é€‰é€‰é¡¹ï¼Œè¿™æ€»æ˜¯æ„å‘³ç€æ— è®ºæˆ‘ä»¬å¤šä¹ˆå°å¿ƒï¼Œéƒ½æœ‰å´©æºƒçš„å¯èƒ½æ€§ã€‚</p>
<p>è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å‡è®¾<strong>sink</strong>å°†åœ¨è°ƒç”¨è¿™äº›é—­åŒ…ä¹‹å‰è¿”å›ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿè·å¾—<strong>cancellable</strong>ã€‚äº‹å®è¯æ˜ï¼Œå¯¹äºç«‹å³å®Œæˆçš„<strong>publishers</strong>æ¥è¯´ï¼Œåœ¨<strong>sink</strong>è¿”å›ä¹‹å‰ï¼Œé—­åŒ…å°±ä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å´©æºƒçš„åŸå› ã€‚ æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶äº‹æ˜¯å°†<strong>effectCancellable</strong>è®¾ç½®ä¸ºå¯é€‰çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®‰å…¨åœ°å¤„ç†å®ƒ:</p>
<pre><code class="language-swift">var effectCancellable: AnyCancellable?
effectCancellable = effect.sink(
  receiveCompletion: { [weak self] _ in
    guard let effectCancellable = effectCancellable else { return }
    self?.effectCancellables.remove(effectCancellable)
  },
  receiveValue: self.send
)
if let effectCancellable = effectCancellable {
  effectCancellables.insert(effectCancellable)
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥<strong>effectCancellable</strong>æ˜¯å¦å­˜åœ¨ï¼Œç„¶åå°†å…¶ä»é›†åˆä¸­ç§»é™¤ï¼Œå†å°†å…¶æ’å…¥é›†åˆä¸­ã€‚ç„¶è€Œï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚å¦‚æœ<strong>publisher</strong>ç«‹å³å®Œæˆï¼Œå®ƒå°†è¢«æ’å…¥åˆ°é›†åˆä¸­ï¼Œä½†æˆ‘ä»¬æ°¸è¿œæ²¡æœ‰æœºä¼šåˆ é™¤å®ƒï¼Œå› ä¸º<strong>receiveCompletion</strong>åœ¨æˆ‘ä»¬æ’å…¥ä¹‹å‰å°±å·²ç»æ‰§è¡Œäº†ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿç†è§£ï¼Œå½“æˆ‘ä»¬åˆ°è¾¾æ’å…¥è¡Œæ—¶ï¼Œ<strong>receiveCompletion</strong>é—­åŒ…æ˜¯å¦å·²ç»è¢«è°ƒç”¨ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è·³è¿‡å®ƒã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¦ä¸€ä¸ªå¯å˜å˜é‡æ¥è·Ÿè¸ªè¯¥çŠ¶æ€:</p>
<pre><code class="language-swift">var effectCancellable: AnyCancellable?
var didComplete = false
effectCancellable = effect.sink(
  receiveCompletion: { [weak self] _ in
    didComplete = true
    guard let effectCancellable = effectCancellable else { return }
    self?.effectCancellables.remove(effectCancellable)
  },
  receiveValue: self.send
)
if !didComplete, let effectCancellable = effectCancellable {
  effectCancellables.insert(effectCancellable)
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åªä¼šåœ¨<strong>publisher</strong>æ²¡æœ‰ç«‹å³å®Œæˆçš„æƒ…å†µä¸‹å°†å¯å–æ¶ˆçš„å†…å®¹æ’å…¥åˆ°é›†åˆä¸­ã€‚å¦‚æœæˆ‘ä»¬è·³å›åˆ°æˆ‘ä»¬çš„<strong>playground</strong>ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ç°åœ¨ä¸€åˆ‡éƒ½æ¢å¤æ­£å¸¸äº†ã€‚</p>
<h2 id="refactoring-asynchronous-effects">Refactoring asynchronous effects</h2>
<p>å¥½çš„ï¼Œä¸¤ä¸ª<strong>favorite</strong>ç´ æ•°æ¨¡å—çš„æ•ˆæœç°åœ¨å®Œå…¨ç”±<strong>combine</strong>æä¾›ã€‚</p>
<p>æˆ‘ä»¬ç”šè‡³å¾—åˆ°äº†å‡ ä¸ªåŠ©æ‰‹ï¼ŒåŒ…æ‹¬<strong>fireAndForgetå’Œsync</strong>ã€‚</p>
<p>çœ‹åˆ°æˆ‘ä»¬çš„æ¨¡å—åŒ–åŠªåŠ›å¾—åˆ°äº†å›æŠ¥ä¹Ÿå¾ˆä¸é”™:æˆ‘ä»¬ä¸å¿…ä¸ºäº†å•ç‹¬è¿è¡Œè¿™ä¸ªå±å¹•è€Œæ„å»ºæ•´ä¸ªåº”ç”¨ç¨‹åºã€‚è¿™å°±æ˜¯æ¨¡å—åŒ–çš„åŠ›é‡!æˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°è¿›è¡Œå¹¿æ³›çš„å¢é‡é‡æ„ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­ä¸ºæ¯ä¸ªå±å¹•æä¾›åé¦ˆã€‚</p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå±å¹•:<strong>Counter</strong>æ¨¡å—ï¼Œå®ƒå…·æœ‰å¤æ‚çš„å¼‚æ­¥æ•ˆæœï¼Œå¯ä»¥å‘å‡ºAPIè¯·æ±‚ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¦å°†å…¶å‡çº§åˆ°<strong>Combine</strong>éœ€è¦æ”¹å˜ä»€ä¹ˆã€‚</p>
<p>æˆ‘ä»¬å°†çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨<strong>wolframAlpha</strong>å‡½æ•°ä¸­ï¼Œå®ƒç›®å‰æ­£åœ¨ä½¿ç”¨æˆ‘ä»¬ä¸Šæ¬¡æ„å»ºçš„ä¸€äº›æ•ˆæœåŠ©æ‰‹ï¼Œæ¯”å¦‚è¿™ä¸ª<strong>dataTaskå’Œdecode</strong>åŠ©æ‰‹:</p>
<pre><code class="language-swift">return dataTask(with: components.url(relativeTo: nil)!)
  .decode(as: WolframAlphaResult.self)
</code></pre>
<p>å¹¸è¿çš„æ˜¯ï¼Œ<strong>Combine</strong>ä¸ºæˆ‘ä»¬æä¾›äº†æ‰€æœ‰è¿™äº›å¸®åŠ©ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œä½¿ç”¨å®ƒä»¬ä¹Ÿéœ€è¦æ›´å¤šçš„å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>Foundation</strong>åœ¨<strong>URLSession</strong>ä¸Šçš„æ–°<strong>dataTaskPublisher</strong>æ–¹æ³•æ¥è·å–ä¸€ä¸ªè¡¨ç¤ºç½‘ç»œè¯·æ±‚çš„<strong>publisher</strong> :</p>
<pre><code class="language-swift">URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
</code></pre>
<p>è®©æˆ‘ä»¬æŠŠå®ƒèµ‹å€¼ç»™ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥äº†è§£å®ƒçš„ç±»å‹æ˜¯ä»€ä¹ˆæ ·çš„:</p>
<pre><code class="language-swift">let tmp = URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
</code></pre>
<p>å…¶ç±»å‹ä¸º<strong>URLSession.DataTaskPublisher</strong>ï¼Œå®ƒæ˜¯<strong>Foundation</strong>ä¸­å®šä¹‰çš„å…·ä½“<strong>publisher</strong>ã€‚å¦‚æœæˆ‘ä»¬æ£€æŸ¥å®ƒçš„<strong>Outputå’ŒFailure</strong>ï¼Œæˆ‘ä»¬å°†å‘ç°ä»¥ä¸‹ç±»å‹åˆ«åã€‚</p>
<pre><code class="language-swift">typealias Output = (data: Data, response: URLResponse)
// â€¦
typealias Failure = URLError
</code></pre>
<p>è®°ä½ï¼Œæœ€ç»ˆæˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª<strong>Effect</strong>ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ç”¨<strong>eraseToAnyPublisher</strong>æ–¹æ³•æ“¦é™¤è¿™ä¸ªï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªæ›´å¥½çš„å®é™…ç±»å‹è§†å›¾:</p>
<pre><code class="language-swift">let tmp = URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
  .eraseToAnyPublisher()
// AnyPublisher&lt;URLSession.DataTaskPublisher.Output, URLSession.DataTaskPublisher.Failure&gt;
</code></pre>
<p>æˆ‘ä»¬å¸Œæœ›å°†è¿™äº›æ•°æ®è§£ç åˆ°æˆ‘ä»¬çš„<strong>WolframAlphaResult</strong>æ¨¡å‹ä¸­ï¼Œå¹¸è¿çš„æ˜¯ï¼Œ<strong>Combine</strong>æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£ç åŠ©æ‰‹:</p>
<pre><code class="language-swift">let tmp = URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
  .decode(type: WolframAlphaResult.self, decoder: JSONDecoder())
  .eraseToAnyPublisher()
</code></pre>
<p>ç„¶è€Œï¼Œè¿™å°†æ— æ³•ç¼–è¯‘ï¼Œå› ä¸º.<strong>decode</strong>æ–¹æ³•åªåœ¨è¾“å‡ºä¸æˆ‘ä»¬è¯•å›¾è§£ç çš„å†…å®¹åŒ¹é…çš„<strong>publishers</strong>ä¸Šå®šä¹‰ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯<strong>Data</strong>ã€‚ å› æ­¤ï¼Œåœ¨è°ƒç”¨<strong>decode</strong>ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ˜ å°„åˆ°<strong>publisher</strong>ï¼Œä»å…ƒç»„ä¸­æå–æ•°æ®:</p>
<pre><code class="language-swift">let tmp = URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
  .map { data, _ in data }
  .decode(type: WolframAlphaResult.self, decoder: JSONDecoder())
  .eraseToAnyPublisher()
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„<strong>publisher</strong>ç±»å‹æ˜¯:</p>
<pre><code class="language-swift">// AnyPublisher&lt;WolframAlphaResult, Publishers.Decode&lt;Upstream, Output, Coder&gt;.Failure&gt;

</code></pre>
<p>å¿«åˆ°äº†ã€‚è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬çš„<strong>publisher</strong>å¯ä»¥å‡ºé”™ï¼Œä½†æˆ‘ä»¬çš„<strong>effect</strong>å¿…é¡»è¿”å›é”™è¯¯ç±»å‹ä¸º<strong>Never</strong>çš„<strong>publisher</strong>ï¼Œè¿™æ„å‘³ç€å®ƒæ°¸è¿œä¸ä¼šå‡ºé”™ã€‚å°†ä¸€ä¸ªå¯èƒ½å‡ºé”™çš„<strong>publisher</strong>è½¬æ¢æˆæ°¸è¿œä¸ä¼šå‡ºé”™çš„<strong>publisher</strong>æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨<strong>replaceError</strong>æ–¹æ³•ï¼Œå®ƒå…è®¸ä½ ç®€å•åœ°ç”¨è¾“å‡ºå€¼æ›¿æ¢ä»»ä½•å‘ç”Ÿçš„é”™è¯¯:</p>
<pre><code class="language-swift">.replaceError(with: &lt;#T##WolframAlphaResult#&gt;)
</code></pre>
<p>è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨è¯šå®çš„<strong>WolframAlphaResult</strong>æ›¿æ¢é”™è¯¯ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰è¿™æ ·çš„å€¼ã€‚æˆ‘ä»¬å®æ„¿ä½¿ç”¨<strong>nil</strong>æ¥è¡¨ç¤ºæˆ‘ä»¬ä¸èƒ½æ„é€ ä¸€ä¸ª<strong>WolframAlphaResult</strong>ï¼Œä½†æ˜¯ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬çš„å‘å¸ƒè€…éœ€è¦æœ‰ä¸€ä¸ªå¯é€‰çš„<strong>WolframAlphaResult</strong>çš„è¾“å‡ºã€‚</p>
<p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯è§£ç ä¸€ä¸ªå¯é€‰çš„ç»“æœï¼Œå¹¶å°†é”™è¯¯æ›¿æ¢ä¸º<strong>nil</strong>:</p>
<pre><code class="language-swift">.decode(type: WolframAlphaResult?.self, decoder: JSONDecoder())
.replaceError(with: nil)
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬çš„è½¬æ¢é“¾ç»™äº†æˆ‘ä»¬ä¸€ä¸ªç±»å‹çš„<strong>publisher</strong>:</p>
<pre><code class="language-swift">AnyPublisher&lt;WolframAlphaResult?, Publishers.ReplaceError&lt;Upstream&gt;.Failure&gt;
</code></pre>
<p>è¿™ä¸ªé”™è¯¯å¾ˆéš¾è¯»å–ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æŒ‰ç…§å®ƒçš„å®šä¹‰æ¥æ‰§è¡Œï¼Œå®ƒå°±æ˜¯<strong>Never</strong>ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦å®ƒæ¥æ“¦é™¤ä¸€ä¸ª<strong>Effect</strong>å¹¶è¿”å›å®ƒçš„åœ°æ–¹ã€‚</p>
<pre><code class="language-swift">return URLSession.shared
  .dataTaskPublisher(for: components.url(relativeTo: nil)!)
  .map { data, _ in data }
  .decode(type: WolframAlphaResult.self, decoder: JSONDecoder())
  .map(Optional.some)
  .replaceError(with: nil)
  .eraseToEffect()
</code></pre>
<p>ç°åœ¨è¿™ç§<strong>effect</strong>æ­£åœ¨æ„å»ºã€‚è™½ç„¶å¾ˆç´§å¼ ï¼Œä½†è‡³å°‘<strong>Combine</strong>æ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†å®Œæˆå·¥ä½œçš„æ‰€æœ‰å·¥å…·ã€‚</p>
<p>ä¸‹ä¸€ä¸ªé”™è¯¯æ˜¯åœ¨<strong>nthPrime</strong>ä¸­ï¼Œå®ƒè°ƒç”¨äº†<strong>wolframAlpha</strong>æ•ˆæœï¼Œä½†éšåæ˜ å°„åˆ°å®ƒã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ï¼Œæ˜ å°„åˆ°ä¸€ä¸ª<strong>publisher</strong>ä¼šæ”¹å˜å®ƒçš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åˆ é™¤è¿™ä¸ªæ”¹å˜:</p>
<pre><code class="language-swift">.eraseToEffect()
</code></pre>
<p>ç°åœ¨è¿™ä¸ªå‡½æ•°é«˜å…´äº†ã€‚å‰©ä¸‹çš„å”¯ä¸€ç¼–è¯‘é”™è¯¯æ˜¯åœ¨è®¡æ•°å™¨å‡æ•°å™¨ä¸­ä½¿ç”¨è¿™ç§<strong>effect</strong>çš„åœ°æ–¹ã€‚å› ä¸ºæˆ‘ä»¬æ­£åœ¨<strong>map</strong>è¿™ä¸ª<strong>publisher</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ¬¡ä½¿ç”¨äº†<strong>eraseToEffect</strong>:</p>
<pre><code class="language-swift">nthPrime(state.count)
  .map(CounterAction.nthPrimeResponse)
  .receive(on: .main)
  .eraseToEffect()
</code></pre>
<p>ç„¶è€Œï¼Œäº‹æƒ…ä¼¼ä¹ä»ç„¶æ²¡æœ‰è¿›å±•ã€‚é”™è¯¯ä¿¡æ¯ä¸æ˜¯å¾ˆå¥½ï¼Œä½†é—®é¢˜åœ¨è¿™é‡Œ:</p>
<pre><code class="language-swift">.receive(on: .main)
</code></pre>
<p><strong>receive(on:)<strong>æ–¹æ³•æ¥å—</strong>Scheduler</strong>:</p>
<pre><code class="language-swift">.receive(on: &lt;#T##Scheduler#&gt;)
</code></pre>
<p>è¿™æ˜¯ä¸€ç§åè®®ï¼Œä¸æ˜¯å…·ä½“ç±»å‹ã€‚<strong>DispatchQueueså’ŒRunLoops</strong>éƒ½ç¬¦åˆè¿™ä¸ªåè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ›´æ˜ç¡®åœ°ä½¿ç”¨å®ƒçš„ç±»å‹:</p>
<pre><code class="language-swift">.receive(on: DispatchQueue.main)
</code></pre>
<p>ç°åœ¨è¿™ä¸ªæ¨¡å—ç»ˆäºå¼€å§‹æ„å»ºäº†ã€‚æ›´å¥½çš„æ˜¯ï¼Œæ•´ä¸ªåº”ç”¨ç›®æ ‡æ­£åœ¨æ„å»ºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å†æ¬¡è¿è¡Œåº”ç”¨ã€‚å¦‚æœæˆ‘ä»¬è¯•ä¸€è¯•ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸€åˆ‡ä»ç„¶ä¸€æ ·çš„å·¥ä½œï¼Œä½†ç°åœ¨å®ƒè¿è¡Œçš„<strong>Combine</strong>è€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰<strong>effect</strong>ç±»å‹ã€‚æˆ‘ä¸çŸ¥é“ä½ æ˜¯æ€ä¹ˆæƒ³çš„ï¼Œä½†æ˜¯å½“æˆ‘çŸ¥é“<strong>Combine</strong>æ­£åœ¨é©±åŠ¨å®ƒçš„æ—¶å€™ï¼Œè¿™ä¸ªåº”ç”¨æ„Ÿè§‰æ›´å¥½äº†ğŸ˜„ã€‚</p>
<h2 id="whats-the-point">Whatâ€™s the point?</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†è¿‡å»å‡ å‘¨æ„å»ºçš„è¿™ä¸ªç©å…·åº”ç”¨ç¨‹åºçš„<strong>Combine</strong>æ¡†æ¶é‡æ„ã€‚ä¸€æ—¦æˆ‘ä»¬äº†è§£äº†<strong>Combine</strong>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™å°±éå¸¸ç®€å•äº†ã€‚</p>
<p>åœ¨point - freeä¸Šï¼Œæˆ‘ä»¬å–œæ¬¢åœ¨æ¯ä¸€é›†çš„ç»“å°¾éƒ½é—®â€œè¿™æœ‰ä»€ä¹ˆæ„ä¹‰?!â€ï¼Œç°åœ¨æ˜¯æˆ‘ä»¬æŠŠäº‹æƒ…å¼„æ¸…æ¥šå¹¶è®¨è®ºä¸ºä»€ä¹ˆè¿™äº›æƒ³æ³•å¾ˆé‡è¦çš„æ—¶å€™äº†ã€‚ç„¶è€Œï¼Œè¿™ä¸€é›†ä»ä¸€å¼€å§‹å°±ç›¸å½“å®ç”¨ã€‚æˆ‘ä»¬æ³¨æ„åˆ°<strong>Effect</strong>ç±»å‹çœ‹èµ·æ¥ä¸è®¸å¤šå“åº”å¼ç¼–ç¨‹åº“éå¸¸ç›¸ä¼¼ï¼Œæ¯”å¦‚<strong>ReactiveSwiftã€RxSwift</strong>å’Œæœ€è¿‘æ¥è‡ªè‹¹æœçš„<strong>Combine</strong>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æƒ³ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ä¾é å…¶ä¸­ä¸€ä¸ªæ¡†æ¶è€Œä¸æ˜¯æ»šåŠ¨æˆ‘ä»¬è‡ªå·±çš„ç±»å‹ï¼Œç¡®å®æˆ‘ä»¬å¯ä»¥ã€‚<strong>Effect</strong>ç±»å‹æœ€é‡è¦çš„ç‰¹æ€§æ˜¯å®ƒå¯ä»¥è¡¨ç¤ºå¼‚æ­¥å·¥ä½œï¼Œå¹¶ä¸”å®ƒæ˜¯å¯è½¬æ¢çš„ã€‚å¥½å§ï¼Œæ‰€æœ‰è¿™äº›å“åº”åº“ä¹Ÿæ°æ°æä¾›äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ä¸å¦¨åˆ©ç”¨ä¸€ä¸‹ã€‚</p>
<p>ä½†ä¹Ÿè®¸è¿™ä¸€é›†çš„â€œå…³é”®ç‚¹â€æ˜¯ï¼Œé€šè¿‡ä½¿ç”¨éå¸¸ç®€å•çš„ã€é›†ä¸­çš„ç±»å‹æ¥å®Œæˆä¸€ä»¶äº‹æƒ…ï¼Œå¹¶ä»¥å¯è½¬æ¢çš„æ–¹å¼è¿›è¡Œï¼Œæ‚¨ä»¥åå°±å¯ä»¥åœ¨æœªæ¥æ¥å—è®¸å¤šä¼˜ç§€çš„é‡æ„ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†æˆ‘ä»¬çš„<strong>effects</strong>ç±»å‹å®Œå…¨è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œä¸€åˆ‡éƒ½ç»§ç»­å·¥ä½œï¼Œè¿™æ˜¯éå¸¸ä»¤äººæƒŠè®¶çš„ã€‚äº‹å®ä¸Šï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½æŠ½è±¡å‡º<strong>effects</strong>çš„å½¢çŠ¶ï¼Œè¿™æ ·åº“çš„ç”¨æˆ·å°±å¯ä»¥å¸¦æ¥ä»–ä»¬è‡ªå·±çš„<strong>effects</strong>ç±»å‹?ä¹Ÿè®¸ä»–ä»¬æƒ³ä½¿ç”¨<strong>ReactiveSwiftæˆ–RxSwiftè€Œä¸æ˜¯Combine</strong>ï¼Œä¹Ÿè®¸ä»–ä»¬åªæƒ³æ»šåŠ¨è‡ªå·±çš„ç®€å•ç±»å‹ã€‚</p>
<p>ä¸å¹¸çš„æ˜¯ï¼ŒSwiftçš„ç±»å‹ç³»ç»Ÿä¸å¤Ÿå¼ºå¤§ï¼Œæ— æ³•è¡¨è¾¾è¿™ç§æƒ³æ³•ï¼Œä½†è‡³å°‘æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ç§æŠ½è±¡çš„å½¢çŠ¶ï¼Œå¹¶è¯•å›¾å°†å…¶ä½œä¸ºæˆ‘ä»¬å¦‚ä½•æ„å»ºåº“çš„çµæ„Ÿã€‚</p>
<p>è¿™ä¸€é›†å°±åˆ°è¿™é‡Œã€‚åœ¨æ„å»ºå¯ç»„åˆæ¶æ„çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç¨å¾®ç»•äº†ä¸€ä¸‹ï¼Œä»¥ä¾¿è§£å†³ä¸ŠèŠ‚è¯¾æåˆ°çš„<strong>Effect</strong>ç±»å‹çš„å¥‡æ€ªä¹‹å¤„ã€‚ä½†ä¸‹å‘¨æˆ‘ä»¬å°†ç»§ç»­ä¸Šæ¬¡çš„è¯é¢˜:<strong>testing</strong>!æˆ‘ä»¬æƒ³è¦å±•ç¤ºè¿™ä¸ªæ¶æ„çš„å¯æµ‹è¯•æ€§ï¼Œå³ä½¿æ¶‰åŠåˆ°æ•ˆæœã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-80the-combine-framework-and-effects-part-1/">
                  <h3 class="post-title">
                    PointFree Episode 80:The Combine Framework and Effects: Part 1
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
