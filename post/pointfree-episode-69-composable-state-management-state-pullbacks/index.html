<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 69: Composable State Management: State Pullbacks | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1645875724842">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="

PointFree Episode 69: Composable State Management: State Pullbacks

Introduction
Combining reducers
Focusing a reducer..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1645875724842" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 69: Composable State Management: State Pullbacks</h2>
            <div class="post-date">2021-11-20</div>
            
            <div class="post-content" v-pre>
              <!-- TOC -->
<ul>
<li><a href="#pointfree-episode-69-composable-state-management-state-pullbacks">PointFree Episode 69: Composable State Management: State Pullbacks</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#combining-reducers">Combining reducers</a></li>
<li><a href="#focusing-a-reducers-state">Focusing a reducer's state</a></li>
<li><a href="#pulling-back-reducers-along-state">Pulling back reducers along state</a></li>
<li><a href="#key-path-pullbacks">Key path pullbacks</a></li>
<li><a href="#pulling-back-more-reducers">Pulling back more reducers</a></li>
<li><a href="#till-next-time">Till next time</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<!-- # PointFree Episode 69: Composable State Management: State Pullbacks -->
<h2 id="introduction">Introduction</h2>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†ä¸€ä¸ªéå¸¸åŸºæœ¬çš„æ¶æ„ç‰ˆæœ¬ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ª<strong>store</strong>ç±»ï¼Œå®ƒæ˜¯çŠ¶æ€ç±»å‹çš„æ³›å‹ï¼Œè¡¨ç¤ºåº”ç”¨ç¨‹åºçš„å®Œæ•´çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ¨ä½œç±»å‹çš„æ³›å‹ï¼Œè¯¥åŠ¨ä½œç±»å‹è¡¨ç¤ºåº”ç”¨ç¨‹åºä¸­å¯èƒ½å‘ç”Ÿçš„æ‰€æœ‰ç”¨æˆ·åŠ¨ä½œã€‚</p>
<ul>
<li>
<p><strong>store</strong>ç±»åŒ…è£…äº†ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„å€¼ç±»å‹ï¼Œè¿™å…è®¸æˆ‘ä»¬ä¸€æ¬¡æ€§åœ°æŒ‚é’©åˆ°è§‚å¯Ÿè€…ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨çŠ¶æ€å³å°†å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥<strong>SwiftUI</strong>ã€‚</p>
</li>
<li>
<p><strong>store</strong>ç±»è¿˜ä¿ç•™äº†ä¸€ä¸ª<strong>reducer</strong>ï¼Œå®ƒæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å¤§è„‘ã€‚ å®ƒæè¿°äº†å¦‚ä½•è·å–åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€å’Œæ¥è‡ªç”¨æˆ·çš„ä¼ å…¥æ“ä½œï¼Œå¹¶ç”Ÿæˆåº”ç”¨ç¨‹åºçš„å…¨æ–°çŠ¶æ€ï¼Œç„¶åå°†å…¶å‘ˆç°å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚</p>
</li>
</ul>
<p>è¿™ä¸ªå°å°çš„å·¥ä½œå·²ç»è§£å†³äº†æˆ‘ä»¬åœ¨æœ¬é›†å¼€å§‹æ—¶æåˆ°çš„5ä¸ªé—®é¢˜ä¸­çš„2ä¸ªã€‚</p>
<p>ä½†æ˜¯ï¼Œå°½ç®¡è¿™ä¸€åˆ‡éƒ½å¾ˆé…·ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥èµ°å¾—æ›´è¿œã€‚è®©æˆ‘ä»¬æ¥è§£å†³åœ¨<strong>appReducer</strong>ä¸­å¼€å§‹å‘å±•çš„é—®é¢˜ã€‚ç°åœ¨å®ƒçœ‹èµ·æ¥ç›¸å½“åºå¤§:ä¸€ä¸ªå·¨å¤§çš„<strong>reducer</strong>å¤„ç†3ä¸ªä¸åŒå±å¹•çš„çªå˜ã€‚è¿™ä¼¼ä¹ä¸æ˜¯ç‰¹åˆ«å…·æœ‰å¯æ‰©å±•æ€§ã€‚å¦‚æœæˆ‘ä»¬æœ‰24ä¸ªå±å¹•æˆ‘ä»¬çœŸçš„éœ€è¦ä¸€ä¸ªå¼€å…³è¯­å¥æ¥åˆ‡æ¢24ä¸ªä¸åŒå±å¹•çš„æ¯ä¸ªåŠ¨ä½œå—?è¿™æ˜¯è¡Œä¸é€šçš„ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ç ”ç©¶å°†<strong>reducer</strong>åˆæˆæˆæ›´å¤§çš„<strong>reducer</strong>çš„æ–¹æ³•ã€‚å¦‚ä½•å°†ä¸€ä¸ªå¤§çš„<strong>reducer</strong>åˆ†è§£æˆè®¸å¤šå°çš„åªåšä¸€ä»¶ç‰¹å®šäº‹æƒ…çš„<strong>reducer</strong>ç„¶åå°†å®ƒä»¬ç²˜åœ¨ä¸€èµ·å½¢æˆæˆ‘ä»¬çš„ä¸»<strong>appReducer</strong>?è®©æˆ‘ä»¬å¼€å§‹ç ”ç©¶è¿™ä¸ªã€‚</p>
<h2 id="combining-reducers">Combining reducers</h2>
<p>è¿™æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº<strong>reducer</strong>:</p>
<pre><code class="language-swift">func appReducer(value: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    state.count -= 1

  case .counter(.incrTapped):
    state.count += 1

  case .primeModal(.saveFavoritePrimeTapped):
    state.favoritePrimes.append(state.count)
    state.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(state.count)))

  case .primeModal(.removeFavoritePrimeTapped):
    state.favoritePrimes.removeAll(where: { $0 == state.count })
    state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.count)))

  case let .favoritePrimes(.deleteFavoritePrimes(indexSet)):
    for index in indexSet {
      let prime = state.favoritePrimes[index]
      state.favoritePrimes.remove(at: index)
      state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(prime)))
    }
  }
}
</code></pre>
<p>å®ƒè´Ÿè´£é€šè¿‡æ‰§è¡Œé€‚å½“çš„çŠ¶æ€æ›´æ”¹ï¼Œå°†æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€ä¸ä»»ä½•ç”¨æˆ·æ“ä½œç»“åˆèµ·æ¥ã€‚å®ƒå¤„ç†ä¸‰ä¸ªä¸åŒçš„å±å¹•å’Œäº”ä¸ªä¸åŒçš„ç”¨æˆ·æ“ä½œã€‚ è¿™ä¸ªå‡½æ•°è¶Šæ¥è¶Šé•¿äº†! éšç€å±å¹•è¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªåŠŸèƒ½å°†å˜å¾—è¶Šæ¥è¶Šåºå¤§ã€‚</p>
<p>åœ¨å‡½æ•°ä¸­è¡¨è¾¾æ¶æ„åŸºæœ¬å•å…ƒçš„ç¾ä¸½ä¹‹å¤„åœ¨äºï¼Œå®ƒå±•ç¤ºäº†æˆ‘ä»¬å¯ä»¥ä»¥æœ‰è¶£çš„æ–¹å¼ç»„åˆå®ƒä»¬çš„å¯èƒ½æ€§ã€‚æ¯•ç«Ÿï¼Œå‡½æ•°æ˜¯å¯ä»¥æ— é™ç»„åˆçš„ã€‚æˆ‘ä»¬å‘ç°<strong>reducer</strong>å‡½æ•°çš„ç‰¹å¾æœ‰å¾ˆå¤šä¸åŒç±»å‹çš„ç»„æˆï¼Œå®ƒä»¬æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼ŒæŠŠ<strong>appReducer</strong>åˆ†è§£æˆä¸€å †æ›´å°çš„å¯ä»¥ç»„åˆåœ¨ä¸€èµ·çš„<strong>reducer</strong>ã€‚</p>
<p>è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„ç»„åˆå¼€å§‹ã€‚å¦‚æœæœ‰ä¸¤ä¸ª<strong>reducers</strong>åœ¨ç›¸åŒçš„çŠ¶æ€å’Œç›¸åŒçš„åŠ¨ä½œä¸‹è¿è¡Œï¼Œä½ èƒ½åšä»€ä¹ˆ? æœ‰æ²¡æœ‰åŠæ³•æŠŠå®ƒä»¬ç»„åˆæˆä¸€ä¸ª<strong>reducers</strong>ï¼Œè®©ä¸¤ä¸ª<strong>reducers</strong>åŒæ—¶å·¥ä½œ? è¿™æ˜¯å®Œå…¨å¯èƒ½çš„ï¼Œè€Œä¸”å®é™…ä¸Šå¾ˆå®¹æ˜“å®ç°:</p>
<pre><code class="language-swift">func combine&lt;Value, Action&gt;(
  _ first: @escaping (inout Value, Action) -&gt; Void,
  _ second: @escaping (inout Value, Action) -&gt; Void
) -&gt; (inout Value, Action) -&gt; Void {

  return { value, action in
    first(&amp;value, action)
    second(&amp;value, action)
  }
}
</code></pre>
<p>è¿™ç®€å•åœ°è¯´ï¼Œè¦ç»„åˆä¸¤ä¸ª<strong>reducers</strong>ï¼Œæ‚¨å¯ä»¥å…ˆåœ¨<strong>state</strong>ä¸Šè¿è¡Œç¬¬ä¸€ä¸ªï¼Œç„¶åè¿è¡Œç¬¬äºŒä¸ªã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒ? å¥½å§ï¼Œè®©æˆ‘ä»¬å¤©çœŸåœ°æŠŠå¤§çš„<strong>reducer</strong>åˆ†è§£æˆå‡ ä¸ªå°çš„<strong>reducers</strong>ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™é‡Œç¡®å®æœ‰3ä¸ª<strong>reducers</strong>åœ¨èµ·ä½œç”¨:ä¸€ä¸ªç”¨äºè®¡æ•°ï¼Œä¸€ä¸ªç”¨äºæ¨¡æ€ï¼Œä¸€ä¸ªç”¨äºæœ€å–œæ¬¢çš„è´¨æ•°å±ã€‚</p>
<p>è®©æˆ‘ä»¬ä¸ºæ¯ä¸ªå±å¹•åˆ›å»ºä¸€ä¸ª<strong>reducer</strong>ã€‚æ¯ä¸€ä¸ªéƒ½å°†å¯¹ä»–ä»¬æ‰€å…³å¿ƒçš„åŠ¨ä½œå­é›†è¿›è¡Œæ“ä½œ:</p>
<pre><code class="language-swift">func counterReducer(value: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    state.count -= 1

  case .counter(.incrTapped):
    state.count += 1

  default:
    break
  }
}

func primeModalReducer(state: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case .primeModal(.addFavoritePrime):
    state.favoritePrimes.append(state.count)
    state.activityFeed.append(.init(timestamp: Date(), type: .addedFavoritePrime(state.count)))

  case .primeModal(.removeFavoritePrime):
    state.favoritePrimes.removeAll(where: { $0 == state.count })
    state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.count)))

  default:
    break
  }
}

func favoritePrimesReducer(state: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case let .favoritePrimes(.removeFavoritePrimes(indexSet)):
    for index in indexSet {
      state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.favoritePrimes[index])))
      state.favoritePrimes.remove(at: index)
    }

  default:
    break
  }
}
</code></pre>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å°†å®ƒä»¬ç²˜åˆåˆ°ä¸»<strong>reducer</strong>ä¸­ï¼Œä»¥ä¾¿ä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºè¿è¡Œé€»è¾‘ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>combine</strong>å‡½æ•°é‡æ–°åˆ›å»ºä¸€ä¸ªå’Œä¹‹å‰å®Œå…¨ä¸€æ ·çš„åº”ç”¨ç¨‹åº<strong>reducer</strong>:</p>
<pre><code class="language-swift">let appReducer = combine(combine(counterReducer, primeModalReducer), favoritePrimesReducer)
</code></pre>
<p>å› ä¸º<strong>combine</strong>ä¸€æ¬¡åªèƒ½ä½¿ç”¨ä¸¤ä¸ª<strong>reducer</strong>ï¼Œæ‰€ä»¥ä½¿ç”¨åµŒå¥—æœ‰ç‚¹å°´å°¬ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨å¾ˆå¤šå±å¹•ä¸Šç»“åˆå¾ˆå¤šå¾ˆå¤šçš„<strong>reducers</strong>ï¼Œæ‰€ä»¥è¿™ä¸ä¼šæœ‰å¾ˆå¥½çš„ä¼¸ç¼©æ€§ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨å¯å˜å˜é‡æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå…è®¸<strong>combine</strong>å‡½æ•°ä¸ä»»æ„æ•°é‡çš„<strong>reducer</strong>ä¸€èµ·å·¥ä½œ:</p>
<pre><code class="language-swift">func combine&lt;Value, Action&gt;(
  _ reducers: (inout Value, Action) -&gt; Void...
) -&gt; (inout Value, Action) -&gt; Void {

  return { value, action in
    for reducer in reducers {
      reducer(&amp;value, action)
    }
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç¼–å†™<strong>app reducer</strong>:</p>
<pre><code class="language-swift">let appReducer = combine(
  counterReducer,
  primeModalReducer,
  favoritePrimesReducer
)
</code></pre>
<p>è¿™å°†æˆ‘ä»¬æ‰€æœ‰çš„å°<strong>reducers</strong>ç»„åˆæˆä¸€ä¸ªå¤§<strong>reducer</strong>ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»ç„¶åƒä»¥å‰ä¸€æ ·å·¥ä½œã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬è°ˆåˆ°<strong>reducers</strong>æ—¶çš„ç¬¬ä¸€ç§ç»„åˆã€‚å®ƒæ˜¯æœ€ç®€å•çš„ï¼Œä½†å®ƒå·²ç»å…è®¸æˆ‘ä»¬å°†å¤§çš„<strong>appReducer</strong>(å¤§çº¦30è¡Œä»£ç )åˆ†è§£æˆ3ä¸ªç‹¬ç«‹çš„<strong>reducer</strong>ï¼Œæ¯ä¸€ä¸ªå¤§çº¦æœ‰10è¡Œä»£ç ã€‚</p>
<h2 id="focusing-a-reducers-state">Focusing a reducer's state</h2>
<p>ç°åœ¨ï¼Œå°½ç®¡æˆ‘ä»¬å·²ç»æŠŠæˆ‘ä»¬çš„å¤§<strong>appReducer</strong>åˆ†è§£æˆä¸€äº›æ›´å°çš„éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†éƒ½æœ‰è‡ªå·±çš„ä¸€äº›é—®é¢˜ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä¸€äº›æç¤ºï¼Œå®ƒä»¬è¿˜æœ‰æ›´å¤šçš„ç»„æˆå½¢å¼æœ‰å¾…å‘ç°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè€ƒè™‘è®¡æ•°å™¨<strong>reducer</strong>:</p>
<pre><code class="language-swift">func counterReducer(state: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    state.count -= 1

  case .counter(.incrTapped):
    state.count += 1

  default:
    break
  }
}
</code></pre>
<p>è¿™ä¸ª<strong>reducer</strong>æƒ³è¦å®Œæˆä¸€äº›éå¸¸ç®€å•çš„äº‹æƒ…ï¼Œåªæ˜¯å¢åŠ å’Œå‡å°‘ä¸€ä¸ªæ•´æ•°ï¼Œä½†å®ƒæ¥å—çš„æ˜¯å®Œæ•´çš„åº”ç”¨çŠ¶æ€ï¼ŒåŒ…æ‹¬å–œçˆ±çš„è´¨æ•°ï¼Œæ´»åŠ¨feedå’Œæ›´å¤šã€‚æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯è®©<strong>reducer</strong>å¯¹è¿™æ ·ä¸€ä¸ªç®€å•çš„æ•´æ•°èµ·ä½œç”¨:</p>
<pre><code class="language-swift">//func counterReducer(state: inout AppState, action: AppAction) -&gt; Void {
func counterReducer(state: inout Int, action: AppAction) -&gt; Void {
  switch action {
  case .counter(.decrTapped):
    // state.count -= 1
    state -= 1

  case .counter(.incrTapped):
    // state.count += 1
    state += 1

  default:
    break
  }
}
</code></pre>
<p>å°½ç®¡é€»è¾‘æ˜¯ç›¸åŒçš„ï¼Œä»£ç è¡Œæ•°ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯è¿™ä¸ª<strong>reducer</strong>åœ¨æœ¬è´¨ä¸Šæ¯”å‰ä¸€ä¸ª<strong>reducer</strong>æ›´ç®€å•ï¼Œå› ä¸ºå®ƒæ“ä½œçš„çŠ¶æ€é›†æ›´å°ã€‚ ä¸ç†Ÿæ‚‰è¿™æ®µä»£ç çš„äººå¯ä»¥æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„ç­¾åï¼Œå¹¶çŸ¥é“è¿™ä¸ª<strong>reducer</strong>åªå¤„ç†ä¸€ä¸ªç®€å•çš„æ•´æ•°ï¼Œè€Œä¸æ˜¯æ•´ä¸ª<strong>AppState</strong>æ¨¡å‹ã€‚</p>
<p>ç„¶è€Œï¼Œæ”¹å˜è¿™ä¸ªç­¾åå´ç ´åäº†ä¸€äº›ä¸œè¥¿:</p>
<pre><code class="language-swift">let appReducer = combine(
  counterReducer,
  primeModalReducer,
  favoritePrimesReducer
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Cannot convert value of type â€˜(inout Int, AppAction) -&gt; ()â€™ to expected argument</p>
</blockquote>
<p>æˆ‘ä»¬ä¸èƒ½å†æŠŠæ‰€æœ‰è¿™äº›<strong>reducers</strong>ç»“åˆåœ¨ä¸€èµ·ï¼Œå› ä¸ºå®ƒä»¬è¯´çš„ä¸æ˜¯åŒä¸€ä¸ªçŠ¶æ€ã€‚<strong>counterReducer</strong>åªå¸Œæœ›åœ¨æ•´æ•°ä¸Šå·¥ä½œï¼Œè€Œå…¶ä»–ä¸¤ä¸ª<strong>reducer</strong>åœ¨å®Œæ•´çš„åº”ç”¨ç¨‹åºçŠ¶æ€ä¸‹å·¥ä½œã€‚å¯¹æ­¤è¯¥æ€ä¹ˆåŠ?</p>
<p>è¿™å°±æŠŠæˆ‘ä»¬å¸¦åˆ°å…³äº<strong>reducer</strong>çš„ä¸‹ä¸€ä¸ªç»„æˆå½¢å¼:<strong>pullback</strong>!</p>
<p>æˆ‘ä»¬ä¹‹å‰åœ¨Point-Freeé‡åˆ°è¿‡ä¸¤æ¬¡<strong>pullback</strong>ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ç§å¥‡æ€ªçš„ç»„åˆå½¢å¼ï¼Œè¿™ç§å½¢å¼å‡ºç°åœ¨ç ”ç©¶ä¸€ä¸ªåä¸ºâ€œContravarianceâ€çš„ä¸»é¢˜æ—¶ã€‚è¿™æ˜¯ä¸€ç§ä¸å‡½æ•°ç®­å¤´æ–¹å‘ç›¸åçš„ç»„åˆå½¢å¼ã€‚ä¸€ä¸ªä¾‹å­æ˜¯è°“è¯ï¼Œå®ƒæ˜¯ä»æŸç§ç±»å‹åˆ°å¸ƒå°”ç±»å‹çš„å‡½æ•°ï¼Œæ¯”å¦‚(<strong>A) -&gt; Bool</strong>ã€‚ æˆ‘ä»¬çŸ¥é“å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä»<strong>Aåˆ°B</strong>çš„å‡½æ•°é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå˜æˆä¸€ä¸ªä»<strong>B</strong>ä¸Šçš„è°“è¯åˆ°<strong>A</strong>ä¸Šçš„è°“è¯çš„å‡½æ•°ã€‚æ³¨æ„ï¼Œæ–¹å‘é¢ å€’äº†:æˆ‘ä»¬ä»<strong>Aåˆ°B</strong>ï¼Œæœ€åä»Bçš„è°“è¯åˆ°Açš„è°“è¯ã€‚ è¿™ä¸æ•°ç»„å½¢æˆäº†é²œæ˜çš„å¯¹æ¯”ï¼Œåœ¨æ•°ç»„ä¸­ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªä»Aåˆ°Bçš„å‡½æ•°ä½ å¯ä»¥æŠŠå®ƒå˜æˆä¸€ä¸ªä»Aæ•°ç»„åˆ°Bæ•°ç»„çš„å‡½æ•°ã€‚æ³¨æ„ï¼Œå‡½æ•°ç®­å¤´æ–¹å‘è¢«ä¿ç•™äº†ã€‚</p>
<p>æˆ‘ä»¬ç§°æ­¤æ“ä½œä¸º<strong>pullback</strong>æ“ä½œï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºå°†å°å‹ç‰¹å®šæ•°æ®ä¸Šçš„è°“è¯è½¬æ¢ä¸ºå¤§å‹é€šç”¨æ•°æ®ä¸Šçš„è°“è¯ã€‚ä¾‹å¦‚ï¼Œç»™å®šä¸€ä¸ªæ•´æ•°ä¸Šçš„è°“è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ•å°„åˆ°ç”¨æˆ·çš„idå­—æ®µï¼Œå°†å…¶æ‹‰å›ç”¨æˆ·æ¨¡å‹ä¸Šçš„è°“è¯ã€‚</p>
<p>æ‰€æœ‰è¿™äº›å‘ç°éƒ½å¾ˆé…·ä¹Ÿå¾ˆæœ‰åŠ›é‡ï¼Œä½†éšåå‘ç”Ÿäº†ä¸€äº›ä»¤äººæƒŠè®¶çš„äº‹æƒ…ã€‚åœ¨é€†æ–¹å·®äº‹ä»¶å‘ç”Ÿ6ä¸ªå¤šæœˆåï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå®Œå…¨ä¸ç›¸å…³çš„é¢†åŸŸå†æ¬¡é­é‡å›è°ƒ:å¿«ç…§æµ‹è¯•(<strong>snapshot testing</strong>)!æˆ‘ä»¬å±•ç¤ºäº†æˆ‘ä»¬è®¾è®¡çš„å¿«ç…§åº“å…·æœ‰å›è°ƒçš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä»Aåˆ°Bçš„å‡½æ•°æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå˜æˆä¸€ä¸ªä»Bçš„å¿«ç…§ç­–ç•¥åˆ°Açš„å¿«ç…§ç­–ç•¥çš„å‡½æ•°ã€‚å†æ¬¡æ³¨æ„ï¼Œæ–¹å‘é¢ å€’äº†ã€‚è¿™ä¸ªæ“ä½œä½¿æˆ‘ä»¬èƒ½å¤Ÿä»ç‰¹å®šçš„å¿«ç…§ç­–ç•¥æ´¾ç”Ÿå‡ºæ›´é€šç”¨çš„å¿«ç…§ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>UIImage</strong>sä¸Šé‡‡å–å¿«ç…§ç­–ç•¥ï¼Œå¹¶å°†å…¶æ‹‰å›<strong>CALayer</strong>ä¸Šï¼Œé€šè¿‡å°†<strong>CALayer</strong>æ¸²æŸ“æˆ<strong>UIImage</strong>ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å°†<strong>CALayer</strong>sä¸Šçš„å¿«ç…§ç­–ç•¥æ‹‰å›<strong>UIView</strong>åªéœ€è¦æ‹‰å‡ºè§†å›¾ä¸­çš„å±‚ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å°†<strong>UIView</strong>ä¸Šçš„å¿«ç…§ç­–ç•¥æ‹‰å›åˆ°<strong>UIViewControllers</strong>åªéœ€è¦åœ¨æ§åˆ¶å™¨ä¸­å–å‡ºè§†å›¾ã€‚ åªéœ€è¦å¾ˆå°‘çš„å·¥ä½œï¼Œæˆ‘ä»¬å°±èƒ½ä»è¿™ä¸ªç®€å•çš„å›æ‹‰æ“ä½œä¸­å¾—åˆ°3ä¸ªæ–°çš„å¿«ç…§ç­–ç•¥ã€‚</p>
<p>ç°åœ¨å¸Œæœ›æˆ‘æè¿°è¿™ä¸ªæ“ä½œçš„æ–¹å¼èƒ½è®©ä½ ä»¬æœ‰æ‰€æ„Ÿè§¦ï¼Œå› ä¸ºè¿™å¬èµ·æ¥åƒæ˜¯ä¸€ä¸ªå›æ‹‰æ“ä½œå¯¹æˆ‘ä»¬çš„<strong>reducers</strong>éå¸¸æœ‰ç”¨ã€‚å¯¹äºè°“è¯å’Œå¿«ç…§ç­–ç•¥æ¥è¯´ï¼Œå›è°ƒå¯¹äºå°†å¤„ç†ä¸€å°æ®µæ•°æ®çš„å†…å®¹è½¬æ¢ä¸ºå¤„ç†å¤§æ•°æ®çš„å†…å®¹éƒ½å¾ˆæœ‰ç”¨ï¼Œåªè¦æˆ‘ä»¬æœ‰ä»å¤§æ•°æ®æŠ•å°„åˆ°å°æ•°æ®çš„æ–¹æ³•ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦ç”¨<strong>reducers</strong>åšçš„:æˆ‘ä»¬æƒ³è¦åœ¨ä¸€å°å—<strong>substate</strong>ä¸Šä½¿ç”¨<strong>reducers</strong>ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºåœ¨å…¨å±€çŠ¶æ€ä¸‹å·¥ä½œçš„<strong>reducers</strong>ï¼Œè€Œ<strong>substate</strong>åµŒå…¥å…¶ä¸­ã€‚</p>
<h2 id="pulling-back-reducers-along-state">Pulling back reducers along state</h2>
<p>è®©æˆ‘ä»¬æ¢è®¨ä¸€ä¸‹å¦‚ä½•å®šä¹‰<strong>reducer</strong>çš„å›è°ƒã€‚åœ¨å®ƒçš„æ ¸å¿ƒï¼Œæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å°†æœ¬åœ°çŠ¶æ€çš„<strong>reducer</strong>è½¬æ¢ä¸ºå…¨å±€çŠ¶æ€çš„<strong>reducer</strong> ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªç­¾åå¼€å§‹ï¼Œå³ä½¿å®ƒç›®å‰æ˜¯ä¸å®Œæ•´çš„:</p>
<pre><code class="language-swift">func pullback&lt;LocalValue, GlobalValue, Action&gt;(
  _ reducer: @escaping (inout LocalValue, Action) -&gt; Void
) -&gt; (inout GlobalValue, Action) -&gt; Void {

}
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬æƒ³è¦å®Œæˆçš„æ ¸å¿ƒã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ç°åœ¨è¿˜ä¸èƒ½å®ç°è¿™ä¸ªå‡½æ•°å› ä¸º<strong>LocalValueå’ŒGlobalValue</strong>æ³›å‹ç›®å‰è¿˜æ²¡æœ‰è¿æ¥ã€‚åœ¨æ¢¦æƒ³å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•å°†å®ƒä»¬è”ç³»èµ·æ¥ã€‚</p>
<p>åœ¨æˆ‘ä»¬å…³äºé€†å˜æ€§å’Œå¿«ç…§æµ‹è¯•çš„ç« èŠ‚ä¸­ï¼Œåªç”¨ä¸€ä¸ªç®€å•çš„å‡½æ•°å°±è¶³å¤Ÿå°†è¿™ä¸¤ä¸ªæ³›å‹è”ç³»èµ·æ¥äº†:</p>
<pre><code class="language-swift">func pullback&lt;LocalValue, GlobalValue, Action&gt;(
  _ reducer: @escaping (inout LocalValue, Action) -&gt; Void,
  _ f: @escaping (GlobalValue) -&gt; LocalValue
) -&gt; (inout GlobalValue, Action) -&gt; Void {

}
</code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ‚¨æä¾›äº†ä¸€ç§ä»å…¨å±€å€¼åˆ°å±€éƒ¨å€¼çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å°†å±€éƒ¨å€¼çš„<strong>reducer</strong>è½¬æ¢ä¸ºå…¨å±€å€¼çš„<strong>reducer</strong>ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™è¿˜ä¸è¶³ä»¥åº”å¯¹æ­¤æ¬¡å›è°ƒã€‚è¦çŸ¥é“ä¸ºä»€ä¹ˆï¼Œè®©æˆ‘ä»¬å°è¯•å®ç°:</p>
<pre><code class="language-swift">func pullback&lt;LocalValue, GlobalValue, Action&gt;(
  _ reducer: @escaping (inout LocalValue, Action) -&gt; Void,
  _ f: @escaping (GlobalValue) -&gt; LocalValue
) -&gt; (inout GlobalValue, Action) -&gt; Void {

  return  { globalValue, action in
    var localValue = f(globalValue)
    reducer(&amp;localValue, action)
  }
}
</code></pre>
<p>å°½ç®¡è¿™æ ·å®ç°äº†å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼¼ä¹ä¹Ÿå¾ˆé«˜å…´ï¼Œä½†å®ƒä¸å¯èƒ½æ˜¯æ­£ç¡®çš„ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ­£åœ¨åˆ›å»ºå±€éƒ¨å€¼çš„å±€éƒ¨å¯å˜å‰¯æœ¬ï¼Œç„¶åä½¿ç”¨<strong>reducer</strong>è¿›è¡Œçªå˜ï¼Œä½†éšåæˆ‘ä»¬ä¸ä¼šå¯¹è¯¥å±€éƒ¨å€¼çš„å‰¯æœ¬è¿›è¡Œä»»ä½•æ“ä½œã€‚è¿™æ„å‘³ç€å…¨å±€å€¼æ ¹æœ¬ä¸ä¼šæ”¹å˜ï¼Œå› æ­¤<strong>reducer</strong>çš„æ¯ä¸€æ¬¡è¿è¡Œéƒ½ä¸ä¼šæ”¹å˜ä»»ä½•ä¸œè¥¿ã€‚</p>
<p>ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ»¡è¶³ç¼–è¯‘å™¨çš„è¦æ±‚:</p>
<pre><code class="language-swift">pullback(counterReducer) { $0.count },
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æ‰“ç ´äº†è®¡æ•°å™¨å±å¹•:æ‰€æœ‰çš„è®¡æ•°å™¨åŠ¨ä½œéƒ½æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚</p>
<p>æˆ‘ä»¬ç¼ºå°‘çš„éƒ¨åˆ†æ˜¯è·å–æ–°å±€éƒ¨å€¼å¹¶å°†å…¶æ’å…¥åˆ°å…¨å±€å€¼çš„èƒ½åŠ›ã€‚ é™¤äº†æˆ‘ä»¬çš„å‡½æ•°å¯ä»¥ä»å…¨å±€å€¼ä¸­è·å–å±€éƒ¨å€¼ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå‡½æ•°å¯ä»¥åœ¨å…¨å±€å€¼ä¸­è®¾ç½®å±€éƒ¨å€¼ã€‚</p>
<p>Something like:</p>
<pre><code class="language-swift">func pullback&lt;LocalValue, GlobalValue, Action&gt;(
  _ reducer: @escaping (inout LocalValue, Action) -&gt; Void,
  get: @escaping (GlobalValue) -&gt; LocalValue,
  set: @escaping (inout GlobalValue, LocalValue) -&gt; Void
) -&gt; (inout GlobalValue, Action) -&gt; Void {

  return  { globalValue, action in
    var localValue = get(globalValue)
    reducer(&amp;localValue, action)
    set(&amp;globalValue, localValue)
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»‹ç»æˆ‘ä»¬çš„è®¡æ•°å™¨<strong>reducer</strong>æ‹‰å›çš„setterç»„ä»¶:</p>
<pre><code class="language-swift">pullback(counterReducer, get: { $0.count }, set: { $0.count = $1 }),
</code></pre>
<p>ä¸€åˆ‡éƒ½åƒä»¥å‰ä¸€æ ·å·¥ä½œ!<br>
å¹¸è¿çš„æ˜¯ï¼ŒSwiftæœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå°†è¿™å¯¹<strong>getterå’Œsetter</strong>æ†ç»‘åˆ°ä¸€ä¸ªæ¦‚å¿µä¸­ï¼Œè¿™ä¸ªæ¦‚å¿µæœ‰ä¸€äº›éå¸¸å¥½çš„äººæœºå·¥ç¨‹å­¦å’Œç¼–è¯‘å™¨æ”¯æŒ:å®ƒå«åšå…³é”®è·¯å¾„(<strong>key path</strong>)!æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå¯å†™çš„é”®è·¯å¾„æ¥æ›¿æ¢è¿™ä¸¤ä¸ª<strong>getå’Œset</strong>å‚æ•°:</p>
<pre><code class="language-swift">func pullback&lt;LocalValue, GlobalValue, Action&gt;(
  _ reducer: @escaping (inout LocalValue, Action) -&gt; Void,
  value: WritableKeyPath&lt;GlobalValue, LocalValue&gt;
) -&gt; (inout GlobalValue, Action) -&gt; Void {
  return { globalValue, action in
    reducer(&amp;globalValue[keyPath: value], action)
  }
}
</code></pre>
<p>å®ç°å˜å¾—ç›¸å½“çŸ­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›æ‹‰ç®€åŒ–ä¸º:</p>
<pre><code class="language-swift">pullback(counterReducer, value: \.count)
</code></pre>
<h2 id="key-path-pullbacks">Key path pullbacks</h2>
<p>ç°åœ¨è®©æˆ‘ä»¬èŠ±ä¸€åˆ†é’Ÿæ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æ‰€åšçš„ã€‚æŠŠè¿™ç§æ“ä½œç§°ä¸ºâ€œ<strong>pullback</strong>â€æ˜¯å¦å…¬å¹³?ä¹‹å‰æˆ‘ä»¬çš„å›è°ƒæ˜¯æ²¿ç€åŠŸèƒ½çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ²¿ç€ä¸€ä¸ªä»å¤§æ•°æ®åˆ°å°æ•°æ®çš„å‡½æ•°æ‹‰å›ä¸€ä¸ªè°“è¯ï¼Œæˆ–è€…æ²¿ç€ä¸€ä¸ªä»å¤§æ•°æ®ç»“æ„åˆ°å°æ•°æ®ç»“æ„çš„å‡½æ•°æ‹‰å›ä¸€ä¸ªå¿«ç…§ç­–ç•¥ã€‚è¿™é‡Œæˆ‘ä»¬ç”šè‡³æ²¡æœ‰ä½¿ç”¨å‡½æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨é”®è·¯å¾„ã€‚è¿™æ ·åšå¯ä»¥å—?</p>
<p>å½“ç„¶ï¼Œå®ƒç¡®å®æ˜¯ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥çš„ä¸€é›†é‡Œè®¨è®ºå®ƒï¼Œä½†æˆ‘ä»¬ä»Šå¤©è¢«è¿«ç›´é¢å®ƒã€‚å›æ‹‰æ“ä½œçš„å®šä¹‰ç‰¹å¾ä¸ä¸€å®šæ˜¯å®ƒä¸“é—¨ä½¿ç”¨å‡½æ•°æ¥æ‰§è¡Œå›æ‹‰æ“ä½œã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›ä»¥Aå¼€å§‹ï¼Œä»¥Bç»“æŸçš„è¿‡ç¨‹ã€‚ç°åœ¨ï¼Œå‡½æ•°å½“ç„¶ç¬¦åˆè¦æ±‚ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯æˆ‘ä»¬ç”¨æ¥å°†Aè½¬æ¢ä¸ºBçš„å®é™…è¿‡ç¨‹ï¼Œä½†æ˜¯è¿˜æœ‰å…¶ä»–ç±»å‹çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ï¼Œå…³é”®è·¯å¾„å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<p>è¿™ä¸ª<strong>pullback</strong>ä»ç„¶æ»¡è¶³æˆ‘ä»¬é‡åˆ°çš„å…¶ä»–<strong>pullback</strong>çš„æ‰€æœ‰ç›¸åŒçš„å±æ€§ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä»¥å‰çœ‹åˆ°è¿‡å¦‚æœä½ ç”¨æ’ç­‰å‡½æ•°åšå›æ‹‰ä½ åªå¾—åˆ°ä½ å¼€å§‹çš„ä¸œè¥¿ã€‚å°±åƒæ²¿ç€æ’ç­‰å‡½æ•°å¯¹å­—ç¬¦ä¸²ä½¿ç”¨å¿«ç…§ç­–ç•¥åªä¼šå¾—åˆ°å¯¹å­—ç¬¦ä¸²ä½¿ç”¨ç›¸åŒçš„å¿«ç…§ç­–ç•¥ã€‚è¿™ä¹Ÿé€‚ç”¨äºæˆ‘ä»¬çš„æ–°<strong>reducer</strong>å›è°ƒã€‚</p>
<p>å¦‚æœä½ æ²¿ç€æ ‡è¯†é”®è·¯å¾„æ‹‰å›ä¸€ä¸ª<strong>reducer</strong>ï¼Œä½ ä¼šå¾—åˆ°ç›¸åŒçš„<strong>reducer</strong>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·åš:</p>
<pre><code class="language-swift">let _appReducer = combine(
  counterReducer,
  primeModalReducer,
  favoritePrimesReducer
)
let appReducer = pullback(_appReducer, value: \.self)
</code></pre>
<p>è¿™é‡Œ.selfæ˜¯é€šè¿‡æ ‡è¯†ä»AppStateåˆ°AppStateçš„å…³é”®è·¯å¾„ã€‚</p>
<p>è¿™ä½¿æˆ‘ä»¬å¯ä»¥å°†å›è°ƒçš„æ¦‚å¿µä¸€èˆ¬åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯å‡½æ•°ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹ä½¿ç”¨å…³é”®è·¯å¾„è¿›è¡Œå›è°ƒçš„æƒ³æ³•æ„Ÿåˆ°èˆ’æœã€‚</p>
<h2 id="pulling-back-more-reducers">Pulling back more reducers</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†ï¼Œè®©æˆ‘ä»¬ç”¨è¿™ä¸ªæŠ€å·§æ¥å¤„ç†å…¶ä»–çš„<strong>reducer</strong>sã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»æœ€å—æ¬¢è¿çš„<strong>reducer</strong>å¼€å§‹:</p>
<pre><code class="language-swift">func favoritePrimesReducer(value: inout AppState, action: AppAction) -&gt; Void {
  switch action {
  case let .favoritePrimes(.removeFavoritePrimes(indexSet)):
    for index in indexSet {
      state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.favoritePrimes[index])))
      state.favoritePrimes.remove(at: index)
    }

  default:
    break
  }
}
</code></pre>
<p>è¿™ä¸ªå‡é€Ÿå™¨ä¹Ÿåœ¨å®Œæ•´çš„<strong>AppState</strong>æ¨¡å‹ä¸Šè¿è¡Œï¼Œå°½ç®¡å®ƒçœ‹èµ·æ¥åªéœ€è¦è®¿é—®æ”¶è—åŒ…çš„è´¨æ•°æ•°ç»„å’Œæ´»åŠ¨æè¦ã€‚å®ƒæ ¹æœ¬ä¸å…³å¿ƒå½“å‰çš„è®¡æ•°å€¼æˆ–ç™»å½•çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå®ƒåº”è¯¥æœ‰è®¿é—®æƒé™å‘¢?</p>
<p>è®©æˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸­é—´ç»“æ„æ¨¡å‹æ¥é‡æ„å®ƒï¼Œå®ƒåªä¿å­˜æˆ‘ä»¬å…³å¿ƒçš„æ•°æ®:</p>
<pre><code class="language-swift">struct FavoritePrimesState {
  var favoritePrimes: [Int]
  var activityFeed: [AppState.Activity]
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æ›´æ–°<strong>reducer</strong>æ¥ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“ã€‚</p>
<pre><code class="language-swift">func favoritePrimesReducer(value: inout FavoritePrimesState, action: AppAction) -&gt; Void {
  switch action {
  case let .favoritePrimes(.removeFavoritePrimes(indexSet)):
    for index in indexSet {
      state.activityFeed.append(.init(timestamp: Date(), type: .removedFavoritePrime(state.favoritePrimes[index])))
      state.favoritePrimes.remove(at: index)
    }

  default:
    break
  }
}
</code></pre>
<p><strong>reducer</strong>çš„å†…éƒ¨ç”šè‡³ä¸éœ€è¦ä»»ä½•æ”¹å˜ã€‚ç°åœ¨å½“äººä»¬æ¥åˆ°è¿™ä¸ª<strong>reducer</strong>æ—¶ï¼Œä»–ä»¬ä¼šæ„Ÿåˆ°æ›´èˆ’æœï¼Œå› ä¸ºä»–ä»¬å°†èƒ½å¤Ÿå®Œæ•´åœ°ç†è§£å®ƒï¼Œ å› ä¸ºä»–ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåªèƒ½æ”¹å˜åº”ç”¨ç¨‹åºä¸­éå¸¸å°çš„ä¸€ç»„çŠ¶æ€ï¼Œåªæœ‰æœ€å–œæ¬¢çš„primeå’Œæ´»åŠ¨feedã€‚</p>
<p>ç°åœ¨<strong>reducer</strong>çœ‹èµ·æ¥ä¸é”™ï¼Œä½†æˆ‘ä»¬å†æ¬¡ç ´åäº†åº”ç”¨<strong>reducer</strong>:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(counterReducer, value: \.count),
  primeModalReducer,
  favoritePrimesReducer
)
</code></pre>
<blockquote>
<p>ğŸ›‘ Type of expression is ambiguous without more context</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦é€šè¿‡æ‹‰å›<strong>favoritePrimesReducer</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™ä¸ªå°†ä¸å‰ä¸€ä¸ªç•¥æœ‰ä¸åŒï¼Œå› ä¸º<strong>favoritePrimesReducer</strong>çš„çŠ¶æ€åªæ˜¯æ¥è‡ª<strong>AppState</strong>ä¸Šçš„ä¸€ä¸ªå­—æ®µï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªå­—æ®µã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼ŒSwiftä¼šä¸ºè®¡ç®—å±æ€§åˆ›å»ºå…³é”®è·¯å¾„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨AppStateä¸Šå¼•å…¥ä¸€ä¸ªè®¡ç®—å±æ€§ï¼Œæ‰‹åŠ¨å®Œæˆè¿™é¡¹å·¥ä½œ:</p>
<pre><code class="language-swift">extension AppState {
  var favoritePrimesState: FavoritePrimesState {
    get {
      return FavoritePrimesState(
        favoritePrimes: self.favoritePrimes,
        activityFeed: self.activityFeed
      )
    }
    set {
      self.activityFeed = newValue.activityFeed
      self.favoritePrimes = newValue.favoritePrimes
    }
  }
}
</code></pre>
<p>æœ‰äº†è¿™ä¸ªè‡ªå®šä¹‰çš„<strong>get-set</strong> computedå±æ€§ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å¯å†™é”®è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æ‹‰å›<strong>reducer</strong>ï¼Œè¿™æ ·å®ƒå°±èƒ½ä¸å…¶ä»–<strong>reducer</strong>é…åˆ:</p>
<pre><code class="language-swift">let appReducer = combine(
  pullback(counterReducer, value: \.count),
  primeModalReducer,
  pullback(favoritePrimesReducer, value: \.favoritePrimesState)
)
</code></pre>
<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç°åœ¨å¯ä»¥åƒä»¥å‰ä¸€æ ·ç¼–è¯‘å’Œè¿è¡Œï¼Œä½†ç°åœ¨æˆ‘ä»¬åˆæœ‰äº†å¦ä¸€ä¸ª<strong>reducer</strong>ï¼Œå®ƒé«˜åº¦å…³æ³¨å®ƒæ‰€å…³å¿ƒçš„çŠ¶æ€ã€‚</p>
<p>è¿˜æœ‰ç¬¬ä¸‰ä¸ª<strong>reducer</strong> <strong>primeModalReducer</strong>ï¼Œä½†å®ƒå®é™…ä¸Šéœ€è¦ç›¸å½“å¤šçš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚å®ƒéœ€è¦å½“å‰è®¡æ•°å™¨ã€æœ€å–œæ¬¢çš„è´¨æ•°å’Œæ´»åŠ¨æè¦ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½æ²¡æœ‰å¿…è¦å…³æ³¨è¿™ä¸ª<strong>reducer</strong> ï¼Œå› ä¸ºå®ƒéœ€è¦è¿™ä¹ˆå¤šçš„çŠ¶æ€ï¼Œå®ƒå¯ä»¥ä¿æŒåŸæ ·ã€‚</p>
<h2 id="till-next-time">Till next time</h2>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»éå¸¸æ¥è¿‘å®Œæˆå¦ä¸€ä¸ªæˆ‘ä»¬åœ¨è¿™ä¸€ç³»åˆ—å‰§é›†å¼€å§‹æ—¶å°±å¼€å§‹ç€æ‰‹è§£å†³çš„æ¶æ„é—®é¢˜ã€‚æˆ‘ä»¬è¯´è¿‡ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿç”¨ç®€å•çš„ã€å¯ç»„åˆçš„å•å…ƒæ„å»ºå¤§å‹å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨æˆ‘ä»¬çš„<strong>reducer</strong>å’Œå®ƒä»¬è¿è¡Œçš„çŠ¶æ€æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™<strong>reducer</strong>ï¼Œä½¿å®ƒä»¬åªåœ¨å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€ä½çŠ¶æ€ä¸‹è¿è¡Œï¼Œç„¶åå°†å®ƒä»¬æ‹‰å›<strong>reducer</strong>ï¼Œä½¿å…¶é€‚åˆäºæ›´å¤§çš„<strong>reducer</strong>ï¼Œå¹¶åœ¨å®Œæ•´çš„åº”ç”¨ç¨‹åºçŠ¶æ€ä¸‹è¿è¡Œã€‚</p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³å¸Œæœ›è¿™äº›ç®€å•çš„ã€å¯ç»„åˆçš„å•å…ƒèƒ½å¤Ÿè¢«éš”ç¦»ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†å®ƒä»¬æ”¾åœ¨è‡ªå·±çš„æ¨¡å—ä¸­ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥è½»æ¾åœ°ä¸å…¶ä»–æ¨¡å—å’Œåº”ç”¨ç¨‹åºå…±äº«ã€‚</p>
<p>è¿™çœŸæ˜¯å¤ªä»¤äººå…´å¥‹äº†! ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å°½ç®¡æˆ‘ä»¬çš„<strong>reducer</strong>è¿è¡Œäºæ›´å°çš„æ•°æ®å—ï¼Œä½†å®ƒä»¬ä»ç„¶å¯¹åµŒå…¥å…¶ä¸­çš„æ›´å¤§çš„<strong>reducer</strong>äº†è§£å¾—å¤ªå¤šï¼Œç‰¹åˆ«æ˜¯å®ƒä»¬å¯ä»¥ç›‘å¬æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ“ä½œã€‚</p>
<p>å¬èµ·æ¥å¥½åƒæˆ‘ä»¬éœ€è¦åœ¨ä¸‹æ¬¡çš„è¡ŒåŠ¨ä¸­é‡å¤åŒæ ·çš„æ•…äº‹ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-68composable-state-management-reducers/">
                  <h3 class="post-title">
                    PointFree Episode 68:Composable State Management: Reducers
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
