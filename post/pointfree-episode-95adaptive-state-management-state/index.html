<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PointFree Episode 95:Adaptive State Management: State | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1645876346136">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="



View models and view stores




View store performance




Counter view performance




View store memory management..." />
    <meta name="keywords" content="PointFree" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1645876346136" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">PointFree Episode 95:Adaptive State Management: State</h2>
            <div class="post-date">2021-12-18</div>
            
            <div class="post-content" v-pre>
              <!-- vscode-markdown-toc -->
<ul>
<li>
<ol>
<li><a href="#Viewmodelsandviewstores">View models and view stores</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="#Viewstoreperformance">View store performance</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#Counterviewperformance">Counter view performance</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="#Viewstorememorymanagement">View store memory management</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="#Adaptingviewstores">Adapting view stores</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="#conclution">conclution</a></li>
</ol>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<!-- # PointFree Episode 95:Adaptive State Management: State -->
<h2 id="1-a-nameviewmodelsandviewstoresaview-models-and-view-stores">1. <a name='Viewmodelsandviewstores'></a>View models and view stores</h2>
<p>è®©æˆ‘ä»¬ä»<strong>Store</strong>ä¸­åˆ é™¤ä¸<strong>ObservableObject</strong>çš„ä¸€è‡´æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœæ­¢é€šçŸ¥è§†å›¾çš„çŠ¶æ€å˜åŒ–ã€‚æˆ‘ä»¬è¿˜å°†åˆ é™¤è¯¥å€¼çš„å…¬å…±è®¿é—®æƒé™ï¼Œå› ä¸ºè§†å›¾ä¸åº”è¯¥ä½¿ç”¨å®ƒæ¥å‘ˆç°å…¶UI:</p>
<pre><code class="language-swift">public final class Store&lt;Value, Action&gt; /* : ObservableObject */ {
  â€¦
  @Publisher private var value: Value
</code></pre>
<p>æˆ‘ä»¬å°†å±æ€§ä¿æŒä¸º@<strong>Published</strong>ï¼Œå› ä¸ºæˆ‘ä»¬ç¡®å®å¸Œæœ›å°†å¯¹å€¼æ‰€åšçš„ä»»ä½•æ›´æ”¹é‡æ”¾åˆ°æ‰€æœ‰æ´¾ç”Ÿå­<strong>store</strong>ä¸­ï¼Œè€Œæ‹¥æœ‰ä¸€ä¸ªå€¼çš„å‘å¸ƒè€…ä½¿å¾—è¿™ä¸€ç‚¹éå¸¸å®¹æ˜“å®ç°ã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°è¿™ä¸ªæ¬¡è¦å¯¹è±¡ï¼Œå®ƒå®é™…ä¸Šè´Ÿè´£é€šçŸ¥çŠ¶æ€å˜åŒ–çš„è§†å›¾ã€‚æˆ‘ä»¬åº”è¯¥ç»™å®ƒèµ·ä»€ä¹ˆåå­—å‘¢?æˆ‘ä»¬å°†ä»iOSç¤¾åŒºé•¿æœŸä½¿ç”¨çš„æœ¯è¯­ä¸­è·å¾—ä¸€äº›çµæ„Ÿï¼Œç”šè‡³è‹¹æœå…¬å¸æœ€è¿‘ä¹Ÿå¼€å§‹åœ¨WWDCä¼šè®®çš„SwiftUIä¸Šä½¿ç”¨è¿™ä¸ªæœ¯è¯­ã€‚æœ¯è¯­â€œ<strong>view model</strong>â€é•¿æœŸä»¥æ¥è¢«ç”¨ä½œç²¾ç¡®æè¿°è§†å›¾çš„é¢†åŸŸçš„ä¸€ç§æ–¹æ³•ã€‚å®ƒåœ¨ä¸šåŠ¡é€»è¾‘å’Œè§†å›¾ä¹‹é—´æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æŠ½è±¡ã€‚ä¸šåŠ¡é€»è¾‘å¯èƒ½æœ‰ä¸€äº›ä¸ç›´æ¥æ˜ å°„åˆ°UIçš„æ¦‚å¿µï¼Œæ¯”å¦‚æ­£åœ¨è¿è¡Œçš„APIè¯·æ±‚çš„åŠ è½½çŠ¶æ€ï¼Œè€Œè§†å›¾æœ‰ä¸€äº›éå¸¸å…·ä½“çš„ä¸œè¥¿ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¦‚æŒ‰é’®çš„å¯ç”¨æˆ–ç¦ç”¨çŠ¶æ€ã€‚</p>
<p>å› æ­¤ï¼Œä½¿ç”¨â€œ<strong>view model</strong>â€ä½œä¸ºçµæ„Ÿï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬å¼•å…¥æ¶æ„çš„æ–°æ¦‚å¿µç§°ä¸ºâ€œ<strong>view store</strong>â€:</p>
<pre><code class="language-swift">ViewStore {
}
</code></pre>
<p>æˆ‘ä»¬åº”è¯¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥ä½¿ç”¨è§†å›¾çš„<strong>store</strong>ã€‚åœ¨<strong>stores</strong>ä¿å­˜æˆ‘ä»¬åº”ç”¨ç¨‹åºæ‰€æœ‰æ··ä¹±çš„ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œå› æ­¤å¯èƒ½åŒ…å«æ¯”æˆ‘ä»¬çš„è§†å›¾æ‰€å…³å¿ƒçš„æ›´å¤šçš„ä¿¡æ¯ï¼Œè€Œ<strong>ViewStore</strong>å°†åªä¿å­˜è¿™ä¸ªè§†å›¾æ‰€å…³å¿ƒçš„é¢†åŸŸã€‚å¦‚æœå®ƒä¸éœ€è¦è¿™äº›ä¿¡æ¯ï¼Œå®ƒç”šè‡³ä¸éœ€è¦æŒæœ‰å…¶å­è§†å›¾çš„åŸŸã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªå¯¹è±¡ä¸SwiftUIäº¤äº’ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥è§¦å‘è§†å›¾çš„é‡æ¸²æŸ“ï¼Œå› æ­¤å®ƒéœ€è¦æ˜¯ä¸€ä¸ªç±»:</p>
<pre><code class="language-swift">class ViewStore {
}
</code></pre>
<p>å®ƒè¿˜éœ€è¦æ˜¯ä¸€ä¸ª<strong>ObservableObject</strong>ï¼Œä»¥ä¾¿SwiftUIèƒ½å¤Ÿæ¥æ”¶åˆ°åˆ°å®ƒçš„é€šçŸ¥:</p>
<pre><code class="language-swift">public final class ViewStore: ObservableObject {
}
</code></pre>
<p>è¦æˆä¸ºä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œå®ƒéœ€è¦æŒæœ‰ä¸€ä¸ªå‘å¸ƒè€…ï¼Œè¯¥å‘å¸ƒè€…åœ¨<strong>store</strong>ä¸­çš„å€¼å³å°†å‘ç”Ÿå˜åŒ–æ—¶å‘å‡ºã€‚ SwiftUIæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥åŒæ—¶åœ¨ç±»ä¸­å£°æ˜å­˜å‚¨çš„å€¼ï¼Œå¹¶åœ¨å€¼å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨pingé‚£ä¸ªå‘è¡Œè€…:</p>
<pre><code class="language-swift">final class ViewStore&lt;Value&gt;: ObservableObject {
  @Published public fileprivate(set) var value: Value
}
</code></pre>
<p>ç”±äºç±»åœ¨Swiftä¸­çš„å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»æä¾›ä¸€ä¸ªåˆå§‹åŒ–å™¨:</p>
<pre><code class="language-swift">public final class ViewStore&lt;Value&gt;: ObservableObject {
  @Published public private(set) var value: Value

  init(initialValue: Value) {
    self.value = initialValue
  }
}
</code></pre>
<p>è¿™æ˜¯<strong>ViewStore</strong>çš„åŸºç¡€ã€‚å®ƒåªæ˜¯ç®€å•åœ°å°†ä¸€äº›å€¼åŒ…è£…åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œå¹¶å°†å…¶å…¬å¼€ä¸ºä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ã€‚</p>
<p>ä½¿å®ƒæˆä¸ºæˆ‘ä»¬æ¶æ„ä¸­æœ‰ç”¨çš„æ¦‚å¿µçš„çœŸæ­£å·¥ä½œæ˜¯å®ç°ä»å¸¸è§„<strong>Stores</strong>åˆ›å»º<strong>ViewStores</strong>çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œç»™å®šä¸€ä¸ªç†è§£å€¼å’Œæ“ä½œçš„ç‰¹å®šé¢†åŸŸçš„<strong>store</strong>ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»å®ƒæ´¾ç”Ÿä¸€ä¸ª<strong>ViewStore</strong>ï¼Œä»¥é˜²æ­¢é€šçŸ¥åŸŸå¤–çš„çŠ¶æ€å˜åŒ–ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªè®¡ç®—å±æ€§ä»ä¸€ä¸ª<em>store</em>æ´¾ç”Ÿä¸€ä¸ª<em>view store</em>:</p>
<pre><code class="language-swift">extension Store {
  var view: ViewStore&lt;Value&gt; {
    ???
  }
}
</code></pre>
<p>åœ¨è¯•å›¾å¼„æ¸…æ¥šå¦‚ä½•å®ç°è¿™ä¸ªå±æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥æåˆ°æˆ‘ä»¬åœ¨<strong>Store</strong>ä¸Šå·²ç»æœ‰äº†ä¸€ä¸ªè§†å›¾æ–¹æ³•ï¼Œå®ƒæ˜¯æˆ‘ä»¬ç”¨æ¥ä»çˆ¶è§†å›¾ä¼ é€’åˆ°å­è§†å›¾çš„ç„¦ç‚¹<strong>Store</strong>çš„æ–¹æ³•ã€‚æˆ‘ä»¬åœ¨è€ƒè™‘<strong>ViewStore</strong>çš„æ¦‚å¿µä¹‹å‰å°±ç»™è¿™ä¸ªæ–¹æ³•å‘½åäº†ï¼Œæ‰€ä»¥å›è¿‡å¤´æ¥çœ‹ï¼ŒåŒæ—¶æ‹¥æœ‰è¿™ä¸¤ä¸ªåç§°ä¼¼ä¹æœ‰ç‚¹ä»¤äººå›°æƒ‘ã€‚</p>
<p>è®©æˆ‘ä»¬é‡å‘½ååŸå§‹çš„<strong>view</strong>æ–¹æ³•ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¸º<strong>ViewStore</strong>è½¬æ¢é‡Šæ”¾è¯¥åç§°ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æŠŠå®ƒé‡å‘½åä¸ºä»€ä¹ˆå‘¢?<br>
æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå«åš<strong>focus</strong>ï¼Œä½†è¿™å’Œè§†å›¾å¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç¬¼ç»Ÿåœ°ç§°ä¹‹ä¸ºâ€œ<strong>transform</strong>â€ï¼Œä½†è¿™å¹¶ä¸èƒ½è¯´æ˜æˆ‘ä»¬æ˜¯åœ¨æŠŠå…¨å±€<strong>Store</strong>è½¬å˜ä¸ºæœ¬åœ°<strong>Store</strong>ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å–œæ¬¢å°†å…¶å‘½åä¸º<strong>scope</strong>ï¼Œå› ä¸ºå®ƒä¸ä¼šä¸viewç›¸æ··æ·†ï¼Œå®ƒæœ‰åŠ©äºæˆ‘ä»¬ç†è§£åº”ç”¨äºæˆ‘ä»¬çš„<strong>Store</strong>çš„æŸç§é™åˆ¶è¿‡ç¨‹:</p>
<pre><code class="language-swift">public func scope&lt;LocalValue, LocalAction&gt;(
  value toLocalValue: @escaping (Value) -&gt; LocalValue,
  action toGlobalAction: @escaping (LocalAction) -&gt; Action
) -&gt; Store&lt;LocalValue, LocalAction&gt; {
  â€¦
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™ç§èšç„¦æ“ä½œæƒ³è±¡æˆä¸æ˜¯â€œæŸ¥çœ‹â€å•†åº—ï¼Œè€Œæ˜¯å°†å•†åº—â€œé™å®šèŒƒå›´â€åˆ°å­åŸŸã€‚</p>
<p>æˆ‘ä»¬æ¥æ±‚ä¸€ä¸‹<strong>view</strong>æ–¹æ³•çš„ç­¾å:</p>
<pre><code class="language-swift">extension Store {
  var view: ViewStore&lt;Value&gt; {
    ???
  }
}
</code></pre>
<p>æ„é€ <strong>ViewStore</strong>çš„æ–¹æ³•æ˜¯é€šè¿‡å®ƒçš„åˆå§‹åŒ–å™¨ï¼Œå®ƒæ¥å—ä¸€ä¸ªåˆå§‹å€¼:</p>
<pre><code class="language-swift">extension Store {
  var view: ViewStore&lt;Value&gt; {
    ViewStore(initialValue: self.value)
  }
}
</code></pre>
<p>è¿™æ ·å°±å¯ä»¥ç¼–è¯‘ï¼Œä½†è¿™å½“ç„¶æ˜¯ä¸å¯¹çš„ã€‚å› ä¸ºç°åœ¨<strong>ViewStore</strong>å°†æ°¸è¿œä¸ä¼šæ›´æ–°å®ƒçš„å€¼ï¼Œå› æ­¤å®ƒæ°¸è¿œä¸ä¼šé€šçŸ¥ä¸€ä¸ªSwiftUIè§†å›¾å®ƒéœ€è¦é‡æ–°æ¸²æŸ“ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦åšä¸€äº›ç±»ä¼¼äºæˆ‘ä»¬åœ¨<strong>scope</strong>æ–¹æ³•ä¸­æ‰€åšçš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯è®¢é˜…<strong>store</strong>çš„å€¼ä¸­çš„æ‰€æœ‰æ›´æ”¹ï¼Œå¹¶å°†å®ƒä»¬é‡æ”¾åˆ°<strong>ViewStore</strong>ä¸­ã€‚</p>
<pre><code class="language-swift">extension Store {
  var view: ViewStore&lt;Value&gt; {
    let viewStore = ViewStore(initialValue: self.value)

    self.$value.sink(receiveValue: { value in
      viewStore.value = value
    })

    return viewStore
  }
}
</code></pre>
<p>ç°åœ¨æ­£åœ¨ç¼–è¯‘ï¼Œä½†æ˜¯æˆ‘ä»¬æ”¶åˆ°äº†å…³äºsinkæœªä½¿ç”¨è¿”å›å€¼çš„è­¦å‘Šã€‚ æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ªå¯å–æ¶ˆçš„å€¼ï¼Œè¯¥å€¼å…è®¸æˆ‘ä»¬åœ¨éœ€è¦æ—¶åœæ­¢ä»å‘å¸ƒè€…æ¥æ”¶å€¼ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨<strong>ViewStore</strong>ä¸­å­˜å‚¨ä¸€ä¸ªå¯å–æ¶ˆå¯¹è±¡:</p>
<pre><code class="language-swift">public final class ViewStore&lt;Value&gt;: ObservableObject {
  â€¦
  fileprivate var cancellable: Cancellable?
</code></pre>
<p>å¹¶åœ¨è°ƒç”¨sinkæ—¶èµ‹å€¼:</p>
<pre><code class="language-swift">viewStore.cancellable = self.$value.sink(receiveValue: { value in
  viewStore.value = value
})
</code></pre>
<p>ç„¶åæˆ‘ä»¬ä¿è¯ï¼Œå½“<strong>ViewStore</strong>è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬å°†åœæ­¢ä»è¿™ä¸ªå‘å¸ƒè€…æ¥æ”¶å€¼ã€‚</p>
<hr>
<h2 id="2-a-nameviewstoreperformanceaview-store-performance">2. <a name='Viewstoreperformance'></a>View store performance</h2>
<p>æˆ‘ä»¬ç¦»è¿™ä¸ªæ–¹æ³•çš„æœ‰ç”¨å®ç°è¶Šæ¥è¶Šè¿‘äº†ï¼Œä½†æ˜¯æœ‰äº›åœ°æ–¹ä»ç„¶ä¸å¤ªå¯¹ã€‚æˆ‘ä»¬ä»ç„¶æ²¡æœ‰åšä»»ä½•å·¥ä½œæ¥ç¡®ä¿<strong>ViewStore</strong>ä¸ä¼šå‘å…¶è§†å›¾è¿‡é‡é‡Šæ”¾å€¼ã€‚å°±ç›®å‰çš„æƒ…å†µè€Œè¨€ï¼Œæ¯æ¬¡å…¨å±€<strong>store</strong>æ”¹å˜æ—¶ï¼Œå®ƒæ‰€æœ‰å…³è”çš„<strong>view store</strong>ä¹Ÿä¼šæ”¹å˜ï¼Œä»è€Œè§¦å‘è§†å›¾é‡æ–°è®¡ç®—ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Combineæä¾›çš„ä¸€äº›æœºåˆ¶æ¥ç¡®ä¿<strong>view store</strong>ä¸ä¼šäº§ç”Ÿä»»ä½•é‡å¤å€¼ã€‚æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨<strong>removeduplicate</strong>æ–¹æ³•:</p>
<pre><code class="language-swift">viewStore.cancellable = self.$value
  .removeDuplicates()
  .sink(receiveValue: { value in
    viewStore.value = value
})
</code></pre>
<p>ä½†è¿™è¡Œä¸é€šï¼Œå› ä¸ºæˆ‘ä»¬çš„å€¼ä¸ä¸€å®šç›¸ç­‰ã€‚è®©æˆ‘ä»¬çº¦æŸè¿™ä¸ªæ‰©å±•ï¼Œä½¿å®ƒè¿™æ ·:</p>
<pre><code class="language-swift">extension Store where Value: Equatable {
  var view: ViewStore&lt;Value&gt; {
    â€¦
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æœ‰äº†è¿™ä¸ªå±æ€§çš„å®é™…å®ç°ã€‚è¿™å…è®¸æˆ‘ä»¬ä»ä»»ä½•<strong>store</strong>ä¸­æ´¾ç”Ÿä¸€ä¸ª<strong>ViewStore</strong>ï¼Œåªè¦æˆ‘ä»¬çš„çŠ¶æ€æ˜¯ç›¸ç­‰çš„ã€‚</p>
<p>é€šå¸¸ï¼Œå½“ä¸€ä¸ªAPIè¦æ±‚æŸç§ç±»å‹æ˜¯å¯è¡¡å¹³çš„ï¼Œå½“æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸€ä¸ªå¯è¡¡å¹³çš„ç±»å‹æ—¶ï¼Œä¼šæä¾›ä¸€ç§ä¸ä¹‹å¯†åˆ‡ç›¸å…³ä½†å¯æ›¿ä»£çš„APIå½¢å¼ã€‚ä¾‹å¦‚ï¼Œ<strong>removeDuplicates</strong>æ–¹æ³•æœ‰ä¸€ä¸ªé‡è½½ï¼Œä½ å¯ä»¥æ˜¾å¼åœ°æä¾›å½“å‰¯æœ¬è¢«ç§»é™¤æ—¶çš„æ¡ä»¶:</p>
<pre><code class="language-swift">.removeDuplicates(by: &lt;#T##(Equatable, Equatable) -&gt; Bool#&gt;)
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¸Œæœ›è¿™æ ·åšï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ—¶ä¼šä½¿ç”¨å…ƒç»„æ¥è¡¨ç¤ºç‰¹æ€§çš„çŠ¶æ€ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå…ƒç»„æ˜¯ä¸èƒ½ç›¸ç­‰çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªé‡è½½è§†å›¾ï¼Œå…è®¸æˆ‘ä»¬è¿™æ ·åš:</p>
<pre><code class="language-swift">extension Store {
  public func view(
    removeDuplicates predicate: @escaping (Value, Value) -&gt; Bool
  ) -&gt; ViewStore&lt;Value&gt; {
    let viewStore = ViewStore(initialValue: self.value)
    viewStore.cancellable = self.$value
      .removeDuplicates(by: predicate)
      .sink { newValue in viewStore.value = newValue }
    return viewStore
  }
}
</code></pre>
<p>ç”šè‡³å…¶ä»–çš„å®ç°ä¹Ÿå¯ä»¥å†™æˆè¿™ä¸ªå½¢å¼:</p>
<pre><code class="language-swift">extension Store where Value: Equatable {
  public var view: ViewStore&lt;Value&gt; {
    self.view(removeDuplicates: ==)
  }
}
</code></pre>
<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆè§£å†³ä¸€ä¸ªå†…å­˜æ³„æ¼é—®é¢˜ã€‚ç°åœ¨å¯å–æ¶ˆå¯¹è±¡åœ¨è¿™ä¸ªé—­åŒ…ä¸­æŒæœ‰<strong>viewStore</strong>ï¼Œä½†<strong>viewStore</strong>æœ¬èº«ä¹ŸæŒæœ‰å¯å–æ¶ˆå¯¹è±¡ä½œä¸ºå±æ€§ã€‚è¿™å’Œæˆ‘ä»¬åœ¨ç¡®å®šå­˜å‚¨èŒƒå›´æ—¶é‡åˆ°çš„é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œä¿®å¤æ–¹æ³•æ˜¯åœ¨é—­åŒ…ä¸­å¼±ä¿å­˜<strong>viewStore</strong>:</p>
<pre><code class="language-swift">.sink { [weak viewStore] newValue in viewStore?.value = newValue }
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬å¯¹<strong>stores view</strong>çš„å®ç°ã€‚</p>
<p>ä½¿ç”¨<strong>ViewStores</strong></p>
<p>å½“æˆ‘ä»¬è¯•å›¾ä»<strong>store</strong>ä¸­è®¿é—®å€¼æ—¶ï¼Œè¿™ä¼šå¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ã€‚æˆ‘ä»¬å¸Œæœ›é€šè¿‡ç”¨ä¸€ä¸ªé€‚å½“æ„é€ çš„<strong>ViewStore</strong>æ¥æ›¿æ¢æ‰€æœ‰è¿™äº›<strong>store</strong>çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†é¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—å’Œè§†å›¾çš„æ¸²æŸ“ã€‚</p>
<p>è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„ç‰¹æ€§å¼€å§‹ï¼Œç„¶åå¾€å›ç ”ç©¶ã€‚æˆ‘ä»¬æƒ³æä¸€ä¸‹æˆ‘ä»¬åœ¨å…³äºå¯ç»„åˆæ¶æ„çš„ç« èŠ‚ä¸­å¤šæ¬¡æåˆ°çš„ä¸€äº›äº‹æƒ…ï¼Œå³ç”±äºæˆ‘ä»¬åœ¨æ¨¡å—åŒ–åº”ç”¨ç¨‹åºæ–¹é¢çš„åŠªåŠ›ï¼Œæˆ‘ä»¬æœ‰æœºä¼šå¢é‡åœ°ä¿®å¤è¿™äº›ç¼–è¯‘å™¨é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥åªä¸“æ³¨äºä¸€ä¸ªæ¨¡å—å¹¶ç‹¬ç«‹åœ°æ„å»ºå®ƒï¼Œè€Œä¸æ˜¯è¯•å›¾ä¸€æ¬¡æ€§ä¿®å¤æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ›´å®¹æ˜“å¯¹æˆ‘ä»¬çš„æ¶æ„å’Œåº“è¿›è¡Œè¿™äº›ç±»å‹çš„æ”¹å˜ã€‚è¿™åªèƒ½å½’åŠŸäºæˆ‘ä»¬çš„æ¨¡å—åŒ–èƒ½åŠ›ï¼Œè€Œå¯ç»„åˆä½“ç³»ç»“æ„ä½¿æ¨¡å—åŒ–å˜å¾—éå¸¸å®¹æ˜“ã€‚</p>
<p>åœ¨<strong>FavoritePrimes</strong>åŒ…ä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹é”™è¯¯:</p>
<pre><code class="language-swift">ğŸ›‘ Property type â€˜Store&lt;[Int], FavoritePrimesAction&gt;â€™ does not match that of the â€˜wrappedValueâ€™ property of its wrapper type â€˜ObservedObjectâ€™
</code></pre>
<p>è¿™æ˜¯å› ä¸º<strong>stores</strong>ä¸å†æ˜¯å¯è§‚å¯Ÿçš„ã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>view store</strong>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è§†å›¾ä¸­å£°æ˜ä¸€ä¸ªæ–°å­—æ®µ:</p>
<pre><code class="language-swift">public struct FavoritePrimesView: View {
  let store: Store&lt;FavoritePrimesState, FavoritePrimesAction&gt;
  @ObservedObject var viewStore: ViewStore&lt;FavoritePrimesState&gt;
</code></pre>
<p>ç°åœ¨ï¼Œ<strong>store and view store</strong>ä½¿ç”¨ç›¸åŒçš„çŠ¶æ€ï¼Œä½†è¿™åªæ˜¯è¿™ä¸ªè§†å›¾çš„å·§åˆã€‚å®ƒä¸éœ€è¦è¿™æ ·ï¼Œé€šå¸¸ä¹Ÿä¸åº”è¯¥è¿™æ ·ã€‚</p>
<p>åœ¨è§†å›¾çš„ä¸»ä½“ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦é€šè¿‡<strong>view store</strong>æ¥è®¿é—®å½“å‰å€¼ï¼Œè€Œä¸æ˜¯ä»<strong>store</strong>ä¸­è®¿é—®å½“å‰å€¼:</p>
<pre><code class="language-swift">ForEach(self.viewStore.value.favoritePrimes, id: \.self) { prime in
  Text(&quot;\(prime)&quot;)
}
â€¦
.alert(item: .constant(self.viewStore.value.alertNthPrime)) {
</code></pre>
<p>è¿™ä¸ªæ–‡ä»¶ä¸­çš„æœ€åä¸€ä¸ªé”™è¯¯ä¸æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»º<strong>view store</strong>æœ‰å…³:</p>
<pre><code class="language-swift">ğŸ›‘ Return from initializer without initializing all stored properties
</code></pre>
<p>è¦åˆ›å»º<strong>view store</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥çœ‹<strong>store</strong>æ¥æ´¾ç”Ÿå®ƒçš„<strong>view store</strong>:</p>
<pre><code class="language-swift">public init(store: Store&lt;FavoritePrimesState, FavoritePrimesAction&gt;) {
  print(&quot;FavoritePrimesView.init&quot;)
  self.store = store
  self.viewStore = store.view
}
</code></pre>
<p>è¿™ä¸èƒ½å·¥ä½œï¼Œå› ä¸º<strong>FavoritePrimesState</strong>æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œè€Œåœ¨Swiftä¸­å…ƒç»„æ˜¯ä¸ç›¸ç­‰çš„ã€‚ä¹Ÿè®¸æœ‰ä¸€å¤©è¿™ä¸ªé—®é¢˜ä¼šå¾—åˆ°è§£å†³ï¼Œä½†åœ¨é‚£ä¹‹å‰ä¼šæœ‰ä¸€ä¸ªç‰¹åˆ«çš„è§£å†³æ–¹æ¡ˆã€‚ Swiftæ ‡å‡†åº“ä¸ºä¸€äº›å¤§å°çš„å…ƒç»„å®šä¹‰äº†ä¸€ä¸ª==æ“ä½œç¬¦çš„é‡è½½ï¼Œæˆ‘ç›¸ä¿¡æœ€å¤šæœ‰6ä¸ªç»„ä»¶ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é‡è½½<strong>view</strong>å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ˜¾å¼çš„ç­‰å¼å‡½æ•°:</p>
<pre><code class="language-swift">self.viewStore = self.store.view(removeDuplicates: ==)
</code></pre>
<p>è¿™å°†ä½¿å†…å®¹è¿›è¡Œç¼–è¯‘ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ”¾å¿ƒï¼Œè¿™ä¸ªè§†å›¾åªæœ‰åœ¨å…¶å±€éƒ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—è‡ªå·±ï¼Œç‰¹åˆ«æ˜¯æ”¶è—çš„è´¨æ•°å’Œalertã€‚å¯¹å…¨å±€åº”ç”¨ç¨‹åºçŠ¶æ€çš„ä»»ä½•å…¶ä»–æ›´æ”¹éƒ½ä¸ä¼šå¯¹è¯¥è§†å›¾äº§ç”Ÿå½±å“ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹<strong>PrimeModal</strong>ã€‚å®ƒæœ‰ä¸€ä¸ªç±»ä¼¼çš„é”™è¯¯ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°:</p>
<pre><code class="language-swift">ğŸ›‘ Property type â€˜Store&lt;PrimeModalState, PrimeModalAction&gt;â€™ (aka â€˜Store&lt;(count: Int, favoritePrimes: Array), PrimeModalAction&gt;â€™) does not match that of the â€˜wrappedValueâ€™ property of its wrapper type â€˜ObservedObjectâ€™
</code></pre>
<p>è¿™æ˜¯å› ä¸º<strong>Store</strong>ä¸å†æ˜¯å¯è§‚å¯Ÿçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ª<strong>ViewStore</strong>:</p>
<pre><code class="language-swift">public struct IsPrimeModalView: View {
  let store: Store&lt;PrimeModalState, PrimeModalAction&gt;
  @ObservedObject var viewStore: ViewStore&lt;PrimeModalState&gt;
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆå§‹åŒ–å™¨ä¸­åˆ†é…<strong>viewStore</strong>å±æ€§:</p>
<pre><code class="language-swift">public init(store: Store&lt;PrimeModalState, PrimeModalAction&gt;) {
  print(&quot;IsPrimeModalView.init&quot;)
  self.store = store
  self.viewStore = self.store.view(removeDuplicates: ==)
}
</code></pre>
<p>ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<strong>viewStore</strong>æ¥ä»£æ›¿ä»<strong>store</strong>ä¸­è®¿é—®çŠ¶æ€:</p>
<pre><code class="language-swift">public var body: some View {
  print(&quot;IsPrimeModalView.body&quot;)
  return VStack {
    if isPrime(self.viewStore.count) {
      Text(&quot;\(self.viewStore.value.count) is prime ğŸ‰&quot;)
      if self.viewStore.favoritePrimes.contains(self.viewStore.count) {
        Button(&quot;Remove from favorite primes&quot;) {
          self.store.send(.removeFavoritePrimeTapped)
        }
      } else {
        Button(&quot;Save to favorite primes&quot;) {
          self.store.send(.saveFavoritePrimeTapped)
        }
      }
    } else {
      Text(&quot;\(self.viewStore.value.count) is not prime :(&quot;)
    }
  }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„<strong>PrimeModal</strong>è½¯ä»¶åŒ…æ­£åœ¨æ„å»ºä¸­ã€‚</p>
<p>åˆ‡æ¢åˆ°<strong>Counter</strong>ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ‰€æœ‰ç›¸åŒçš„ç¼–è¯‘å™¨é”™è¯¯ã€‚æˆ‘ä»¬éœ€è¦å»æ‰ <strong>observable store</strong> ï¼Œè€Œä½¿ç”¨<strong>viewStore</strong>ã€‚</p>
<pre><code class="language-swift">public struct CounterView: View {
  let store: Store&lt;CounterViewState, CounterViewAction&gt;
  @ObservedObject var viewStore: ViewStore&lt;CounterViewState&gt;
</code></pre>
<p>æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªè§†å›¾æ„å»ºè§†å›¾å­˜å‚¨:</p>
<pre><code class="language-swift">public init(store: Store&lt;CounterViewState, CounterViewAction&gt;) {
  print(&quot;CounterView.init&quot;)
  self.store = store
  self.viewStore = self.store.view
}
</code></pre>
<p>è¿™ä¸€æ¬¡æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨<strong>removeDuplicates</strong>ï¼Œå› ä¸ºCounterViewStateéµå¾ªEquatableã€‚</p>
<p>æœ€åæœ‰6ä¸ªåœ°æ–¹æˆ‘ä»¬éœ€è¦é€šè¿‡<strong>viewStore</strong>è€Œä¸æ˜¯<strong>store</strong>è®¿é—®è§†å›¾çš„çŠ¶æ€ã€‚</p>
<hr>
<h2 id="3-a-namecounterviewperformanceacounter-view-performance">3. <a name='Counterviewperformance'></a>Counter view performance</h2>
<p>ä½†æˆ‘ä»¬å¯ä»¥æ”¹è¿›è¿™ä¸€ç‚¹ã€‚ç°åœ¨æˆ‘ä»¬çš„è§†å›¾ä¸éœ€è¦è®¿é—®æ•´ä¸ª<strong>CounterViewState</strong>ï¼Œå®ƒåªä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªå­é›†ã€‚ä¸ºäº†ç²¾ç®€è¿™ä¸ªè§†å›¾çš„çŠ¶æ€åˆ°å®ƒæœ€åŸºæœ¬çš„è¦ç´ ï¼Œä¹Ÿå°±æ˜¯è§†å›¾éœ€è¦å®Œæˆå®ƒçš„å·¥ä½œçš„æœ€ä½é™åº¦ï¼Œè®©æˆ‘ä»¬åœ¨è§†å›¾å­˜å‚¨ä¸­æ”¾å…¥ä¸€ä¸ªç©ºç±»å‹ï¼Œç„¶åæ…¢æ…¢åœ°æ·»åŠ å›å®ƒéœ€è¦çš„å±æ€§:</p>
<pre><code class="language-swift">public struct CounterView: View {
  struct State: Equatable {
  }
  â€¦
  @ObservedObject var viewStore: ViewStore&lt;State&gt;
</code></pre>
<p>æ¯å½“æˆ‘ä»¬è¯•å›¾è®¿é—®<strong>store</strong>ä¸­çš„æŸäº›çŠ¶æ€æ—¶ï¼Œè¿™ä¼šç«‹å³ç»™æˆ‘ä»¬ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦è®¿é—®<strong>isNthPrimeButtonDisabled</strong>å¸ƒå°”å€¼ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒæ·»åŠ åˆ°<strong>store</strong>çš„å€¼ç±»å‹ä¸­:</p>
<pre><code class="language-swift">struct State: Equatable {
  let isNthPrimeButtonDisabled: Bool
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹åˆ°å®ƒéœ€è¦<strong>isPrimeModalShown</strong>å¸ƒå°”å€¼:</p>
<pre><code class="language-swift">struct State: Equatable {
  let isNthPrimeButtonDisabled: Bool
  let isPrimeModalShown: Bool
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬éœ€è¦è®¿é—®<strong>alertNthPrime</strong>:</p>
<pre><code class="language-swift">struct State: Equatable {
  let alertNthPrime: PrimeAlert?
  let isNthPrimeButtonDisabled: Bool
  let isPrimeModalShown: Bool
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬éœ€è¦<strong>count</strong>:</p>
<pre><code class="language-swift">struct State: Equatable {
  let alertNthPrime: PrimeAlert?
  let count: Int
  let isNthPrimeButtonDisabled: Bool
  let isPrimeModalShown: Bool
}
</code></pre>
<p>è¿™å°±ä¿®å¤äº†è§†å›¾ä¸»ä½“ä¸­çš„ç¼–è¯‘å™¨é”™è¯¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦è®¿é—®å››ä¸ªå­—æ®µ:<strong>alertNthPrimeã€countã€isNthPrimeButtonDisabledå’ŒisPrimeModalShown</strong>ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦è®¿é—®<strong>favoritePrimes</strong>æ•°ç»„ï¼Œè¯¥æ•°ç»„ä½äº<strong>CounterViewState</strong>ç±»å‹ä¸­ã€‚è¿™æ„å‘³ç€å¯¹åº”ç”¨ç¨‹åºçŠ¶æ€çš„è¯¥å­—æ®µæ‰€åšçš„ä»»ä½•æ›´æ”¹éƒ½ä¸ä¼šè§¦å‘è§†å›¾é‡æ–°è®¡ç®—è‡ªèº«ã€‚</p>
<p>ä¸ºäº†è·å¾—å®Œæ•´çš„è§†å›¾ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ª <strong>view store</strong>æ¥æ”¯æŒè¿™ä¸ªè§†å›¾ï¼Œæˆ‘ä»¬é¦–å…ˆå°†<strong>store</strong>é™å®šä¸ºå®ƒæ‰€å…³å¿ƒçš„çŠ¶æ€çš„åŸºæœ¬è¦ç´ ï¼Œç„¶åå°†å®ƒè½¬æ¢ä¸ºä¸€ä¸ª<strong>view store</strong>:</p>
<pre><code class="language-swift">self.viewStore = self.store
  .scope(
    value: { counterViewState in
      State(
        alertNthPrime: counterViewState.alertNthPrime,
        count: counterViewState.count,
        isNthPrimeButtonDisabled: counterViewState.isNthPrimeButtonDisabled,
        isPrimeModalShown: counterViewState.isPrimeModalShown
      )
  },
    action: { $0 }
)
  .view
</code></pre>
<p>ä½ å¯èƒ½ä¸å–œæ¬¢åœ¨åˆå§‹åŒ–å™¨ä¸­åŒ…å«æ‰€æœ‰è¿™äº›é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åšçš„ä¸€ä»¶ç®€å•çš„äº‹æƒ…æ˜¯åœ¨æ–‡ä»¶åº•éƒ¨åˆ›å»ºä¸€ä¸ªæ–¹ä¾¿çš„åˆå§‹åŒ–å™¨:</p>
<pre><code class="language-swift">extension CounterView.State {
  init(counterViewState: CounterViewState) {
    self.alertNthPrime = counterViewState.alertNthPrime
    self.count = counterViewState.count
    self.isNthPrimeButtonDisabled = counterViewState.isNthPrimeButtonDisabled
    self.isPrimeModalShown = counterViewState.isPrimeModalShown
  }
}
</code></pre>
<p>å“ˆï¼Œä½†è¿™æš´éœ²äº†å‘½åçš„ä¸€ç‚¹å°´å°¬ã€‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª<strong>CounterViewStateå’Œä¸€ä¸ªCounterView.State</strong>ã€‚çŠ¶æ€:åç§°ç›¸åŒä½†çŠ¶æ€ä¸åŒã€‚åµŒå¥—åœ¨<strong>CounterView</strong>å†…éƒ¨çš„æ–°<strong>State</strong>ç»“æ„æè¿°äº†<strong>CounterView</strong>éœ€è¦è§‚å¯Ÿçš„æ‰€æœ‰çŠ¶æ€ï¼Œè€Œ<strong>CounterViewState</strong>åŒ…å«è¿è¡Œæ•´ä¸ªè®¡æ•°å™¨ç‰¹æ€§æ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸»æ¨¡æ€çš„çŠ¶æ€ã€‚</p>
<p>ä¹Ÿè®¸<strong>CounterViewState</strong>ä¸€å¼€å§‹å°±ä¸æ˜¯æ­£ç¡®çš„åå­—ã€‚æˆ‘ä»¬å®šä¹‰å®ƒæ¥æè¿°<strong>CounterStateå’ŒPrimeModalState</strong>çš„è”åˆï¼Œè¿™æ˜¯è¿è¡Œè®¡æ•°å™¨ç‰¹æ€§æ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€ã€‚æ‰€ä»¥ä¹Ÿè®¸<strong>CounterFeatureState</strong>æ›´åˆé€‚:</p>
<pre><code class="language-swift">public struct CounterFeatureState: Equatable {
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æ›´æ–°<strong>CounterView.State</strong>åˆå§‹åŒ–å‚æ•°:</p>
<pre><code class="language-swift">extension CounterView.State {
  init(counterFeatureState: CounterViewState) {
    self.alertNthPrime = counterFeatureState.alertNthPrime
    self.count = counterFeatureState.count
    self.isNthPrimeButtonDisabled = counterFeatureState.isNthPrimeButtonDisabled
    self.isPrimeModalShown = counterFeatureState.isPrimeModalShown
</code></pre>
<p>æœ‰äº†é‡å‘½åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥:</p>
<pre><code class="language-swift">self.viewStore = self.store
  .scope(value: State.init(counterFeatureState:), action: { $0 })
  .view
</code></pre>
<p>å½“æˆ‘ä»¬é‡å‘½åä¸œè¥¿æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡å‘½å<strong>CounterViewAction</strong>:</p>
<pre><code class="language-swift">public enum CounterFeatureAction: Equatable {
</code></pre>
<hr>
<h2 id="4-a-nameviewstorememorymanagementaview-store-memory-management">4. <a name='Viewstorememorymanagement'></a>View store memory management</h2>
<p>ç°åœ¨è®¡æ•°å™¨æ¨¡å—åˆå¼€å§‹æ„å»ºäº†ï¼Œä½†æˆ‘ä»¬æ„å¤–åœ°å¼•å…¥äº†ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬åœ¨<strong>reducer</strong>ä¸­æ·»åŠ ä¸€äº›æ—¥å¿—è®°å½•ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ“ä½œç¡®å®è¢«å‘é€åˆ°<strong>store</strong>å’Œæ›´æ–°çŠ¶æ€ï¼Œä½†æ›´æ”¹ä¸ä¼šåæ˜ åœ¨UIä¸­ã€‚</p>
<p>æ§åˆ¶UIæ¸²æŸ“çš„ä¸œè¥¿æ˜¯<strong>view store</strong>ï¼Œå› ä¸ºå®ƒæ˜¯å¯è§‚å¯Ÿçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬åˆšåˆšæ”¹å˜äº†<strong>view store</strong>çš„æ„é€ æ‰€ä»¥å®ƒé¦–å…ˆä½œç”¨åŸŸstoreï¼Œç„¶åviews:</p>
<pre><code class="language-swift">self.viewStore = self.store
  .scope(value: State.init(counterFeatureState:), action: { $0 })
  .view
</code></pre>
<p>åœ¨è¿™ä¸ªè½¬æ¢é“¾ä¸­ï¼Œå½“è°ƒç”¨.<strong>scope</strong>æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä¸­é—´å­˜å‚¨ã€‚ç»“æœæ˜¯ä¸­é—´å­˜å‚¨ä¸­æ²¡æœ‰ä»»ä½•ä¸œè¥¿ï¼Œå› æ­¤å®ƒä¼šç«‹å³è¢«é‡Šæ”¾ï¼Œå› æ­¤è§†å›¾å­˜å‚¨ä¸ä¼šè¢«é€šçŸ¥ä»»ä½•å˜åŒ–ã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬è‡ªå·±ç›¸ä¿¡è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æŸ¥çœ‹<strong>scope</strong>å®ç°ä¸­çš„è¿™ä¸€è¡Œï¼Œ<strong>scoped stores</strong>è‚¯å®šä¼šä¿ç•™å®ƒä»¬çš„<strong>parent stores</strong>:</p>
<pre><code class="language-swift">let localStore = Store&lt;LocalValue, LocalAction&gt;(
  initialValue: toLocalValue(self.value),
  reducer: { localValue, localAction, _ in
    self.send(toGlobalAction(localAction))
    localValue = toLocalValue(self.value)
    return []
},
  environment: self.environment
)
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡åœ¨r<strong>educer</strong>é—­åŒ…ä¸­å¼•ç”¨<strong>self</strong>æ¥ç¡®ä¿æ´¾ç”Ÿçš„æœ¬åœ°<strong>scoped store</strong>ä¿æŒåœ¨çˆ¶å‡½æ•°ä¸Šã€‚è¿™æ˜¯ä¸€ä»¶å¥½äº‹ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨åŒä¸€ä¸ª<strong>store</strong>ä¸Šå¤šæ¬¡è°ƒç”¨.<strong>scope</strong>è½¬æ¢ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç›¸äº’å…³è”çš„è¿é”<strong>stores</strong>ã€‚</p>
<p>ç„¶è€Œï¼ŒåŒæ ·çš„æƒ…å†µä¸ä¼šå‘ç”Ÿåœ¨æ´¾ç”Ÿè§†å›¾å­˜å‚¨æ—¶:</p>
<pre><code class="language-swift">public func view(
  removeDuplicates predicate: @escaping (Value, Value) -&gt; Bool
) -&gt; ViewStore&lt;Value&gt; {
  let viewStore = ViewStore(initialValue: self.value)

  viewStore.cancellable = self.$value
    .removeDuplicates(by: predicate)
    .sink { newValue in
      viewStore.value = newValue
  }

  return viewStore
}
</code></pre>
<p>æˆ‘ä»¬éœ€è¦æ´¾ç”Ÿ<strong>view store</strong>æ¥ä¿å­˜å®ƒçš„æ´¾ç”Ÿ<strong>view store</strong>ã€‚æˆ‘ä»¬å¾ˆå¿«å°±ä¼šæœ‰æ­£ç¡®çš„æ–¹æ³•æ¥è¡¨è¾¾<strong>storeå’Œview store</strong>ä¹‹é—´çš„å…³ç³»ï¼Œä½†ç°åœ¨ï¼Œä¸ºäº†è®©äº‹æƒ…æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›ç®€å•çš„äº‹æƒ…ï¼Œé€šè¿‡åœ¨<strong>sink</strong>é—­åŒ…ä¸­å¼•ç”¨<strong>self</strong>:</p>
<pre><code class="language-swift">viewStore.cancellable = self.$value
  .removeDuplicates(by: predicate)
  .sink { newValue in
    viewStore.value = newValue
    self
}
</code></pre>
<p>åªå‰©ä¸‹ä¸€ä»¶äº‹éœ€è¦è§£å†³ã€‚åœ¨ä¸»è¦çš„<strong>PrimeTime</strong>åº”ç”¨ç›®æ ‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª<strong>store</strong>ä½œä¸ºå¯è§‚å¯Ÿå¯¹è±¡ï¼Œè¿™ä¸å†æ˜¯æ­£ç¡®çš„åšæ³•ã€‚</p>
<pre><code class="language-swift">struct ContentView: View {
  let store: Store&lt;AppState, AppAction&gt;
</code></pre>
<p>åœ¨æ‰€æœ‰å…¶ä»–è§†å›¾ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªå¯è§‚å¯Ÿ<strong>view store</strong>ã€‚ä½†æ˜¯<strong>view store</strong>åº”è¯¥ä¿æŒä»€ä¹ˆçŠ¶æ€å‘¢?</p>
<pre><code class="language-swift">struct ContentView: View {
  let store: Store&lt;AppState, AppAction&gt;
  @ObservedObject var viewStore: ViewStore&lt;???&gt;
</code></pre>
<p>å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªè§†å›¾çš„<strong>body</strong>ï¼Œå®ƒå®é™…ä¸Šä¸éœ€è¦ä»»ä½•<strong>state</strong>æ¥åšå®ƒçš„å·¥ä½œã€‚å®ƒåªæ˜¯ä¸€ä¸ªé™æ€è§†å›¾å±‚æ¬¡ç»“æ„ã€‚<br>
æ„å‘³ç€æˆ‘ä»¬ç”šè‡³æ ¹æœ¬ä¸éœ€è¦<strong>view store</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤å®ƒï¼Œè®©è§†å›¾æ˜¯é™æ€çš„:</p>
<pre><code class="language-swift">struct ContentView: View {
  let store: Store&lt;AppState, AppAction&gt;
//  @ObservedObject var viewStore: ViewStore&lt;???&gt;
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æ£€æŸ¥æ—¥å¿—ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åªæœ‰å½“è§†å›¾çŠ¶æ€ç›´æ¥æ”¹å˜æ—¶ï¼Œæ‰ä¼šè°ƒç”¨è§†å›¾çš„bodyå±æ€§ã€‚æ·»åŠ æœ€å–œæ¬¢çš„å…ƒç´ ä¸ä¼šå¯¼è‡´counterè§†å›¾é‡æ–°å‘ˆç°ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå¯¼è‡´æ ¹å†…å®¹è§†å›¾é‡æ–°å‘ˆç°ã€‚äº‹å®ä¸Šï¼Œåœ¨æ ¹å†…å®¹è§†å›¾ç¬¬ä¸€æ¬¡å‘ˆç°ä¹‹åï¼Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ä¼šå¯¼è‡´å®ƒé‡æ–°å‘ˆç°ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»è§£å†³äº†æˆ‘ä»¬æ‰“ç®—è§£å†³çš„é—®é¢˜ã€‚é€šè¿‡ä¸ºæˆ‘ä»¬çš„æ¯ä¸ªè§†å›¾æ„å»ºä¸€ä¸ª<strong>view store</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å®ƒä»¬åªè§‚å¯Ÿåˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçŠ¶æ€å˜åŒ–çš„åŸºæœ¬è¦ç´ ï¼Œä»è€Œæœ€å°åŒ–å‘ç”Ÿçš„è§†å›¾é‡æ–°è®¡ç®—å’Œé‡æ–°å‘ˆç°çš„æ•°é‡ã€‚</p>
<hr>
<h2 id="5-a-nameadaptingviewstoresaadapting-view-stores">5. <a name='Adaptingviewstores'></a>Adapting view stores</h2>
<p>å› ä¸ºæˆ‘ä»¬å·²ç»è§£å†³äº†æ€§èƒ½é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°±æ­¤æ­‡ä¸€æ­‡ï¼Œä½†æˆ‘ä»¬æƒ³è¦æ·±å…¥ç ”ç©¶ã€‚<strong>view stores</strong>çš„ä¸œè¥¿æ¯”ä½ çœ‹åˆ°çš„è¦å¤šã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ç§æé«˜æ€§èƒ½æˆ–é˜²æ­¢æ„å¤–é‡æ–°å‘ˆç°è§†å›¾çš„æ–¹æ³•ã€‚å®ƒèƒ½åšçš„è¿œä¸æ­¢è¿™äº›ã€‚</p>
<p>é¦–å…ˆï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œç¾çš„ä½ç½®æ¥ç§»åŠ¨æˆ‘ä»¬è§†å›¾ä¸­çš„ä¸€äº›é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œåœ¨PrimeModalæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç æ¥å†³å®šæˆ‘ä»¬æƒ³ä¸ºæœ€å–œæ¬¢çš„ç´ æ•°æ˜¾ç¤ºä¿å­˜æŒ‰é’®è¿˜æ˜¯åˆ é™¤æŒ‰é’®:</p>
<pre><code class="language-swift">if self.viewStore.value.favoritePrimes.contains(self.viewStore.value.count) {
</code></pre>
<p>è¿™ä¸ªé€»è¾‘ç°åœ¨è¿˜ä¸ç®—å¤ªåï¼Œä½†å¦‚æœæˆ‘ä»¬èƒ½ç›´æ¥è¯´:</p>
<pre><code class="language-swift">if self.viewStore.value.isFavorite {
</code></pre>
<p><strong>view stores</strong>çš„æ¦‚å¿µä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œç¾çš„åœ°æ–¹ï¼Œå°†é€»è¾‘ä»æˆ‘ä»¬çš„è§†å›¾ç§»åˆ°ä¸€ä¸ªæ›´å­¤ç«‹ã€æ›´å®¹æ˜“ç†è§£çš„åœ°æ–¹ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯æ”¹å˜<strong>view stores</strong>æ‰€æŒæœ‰çš„çŠ¶æ€ä½¿ä¹‹å®Œå…¨ç¬¦åˆè§†å›¾çš„éœ€è¦ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒæƒ³çŸ¥é“å½“å‰çš„è®¡æ•°æ˜¯å¤šå°‘ï¼Œä»¥åŠå®ƒæ˜¯å¦æ˜¯æœ€å—æ¬¢è¿çš„:</p>
<pre><code class="language-swift">public struct IsPrimeModalView: View {
  struct State: Equatable {
    let count: Int
    let isFavorite: Bool
  }
  â€¦
  @ObservedObject var viewStore: ViewStore&lt;State&gt;
</code></pre>
<p>ç°åœ¨è§†å›¾çš„ä¸»ä½“æ˜¯å¿«ä¹çš„ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æ„é€ è¿™ä¸ª<strong>view store</strong>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå°†å®ƒä½œç”¨åŸŸé™åˆ¶åˆ°viewstate:</p>
<pre><code class="language-swift">self.viewStore = self.store
  .scope(
    value: State(
      count: $0.count,
      isFavorite: $0.favoritePrimes.contains($0.count)
 },
    action: { $0 }
)
  .view
</code></pre>
<p>ä¸»æ¨¡æ€æ¨¡å—æ­£åœ¨æ„å»ºï¼Œä½†åœ¨è§†å›¾åˆå§‹åŒ–å™¨ä¸­æœ‰å¾ˆå¤šé€»è¾‘è¦ç®¡ç†ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒç§»åˆ°æœ¬åœ°Stateç»“æ„ä½“çš„æ„é€ å™¨ä¸­ã€‚</p>
<pre><code class="language-swift">extension IsPrimeModalView.State {
  init(primeModalState state: PrimeModalState) {
    self.count = state.count
    self.isFavorite = state.favoritePrimes.contains(state.count)
  }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æ›´ç®€å•åœ°ä½¿ç”¨å®ƒæ¥ç•Œå®šæˆ‘ä»¬çš„<strong>store</strong>ï¼Œç„¶å.<strong>view</strong></p>
<pre><code class="language-swift">self.viewStore = self.store
  .scope(value: State.init(primeModalState:), action: { $0 })
  .view
</code></pre>
<p>è¿™å¾ˆå¥½ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé€»è¾‘ç§»å‡ºè§†å›¾ï¼Œç§»åŠ¨åˆ°ä¸€ä¸ªç‚¹ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬åªæ˜¯åšä¸€ä¸ªç®€å•çš„è½¬æ¢ä»ä¸€ä¸ªç‰ˆæœ¬çš„çŠ¶æ€åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬çš„çŠ¶æ€ã€‚æ›´å¥½çš„æ˜¯ï¼Œè¿™è®©æˆ‘ä»¬æœ‰æ›´å¤šçš„æœºä¼šè·³è¿‡ä¸å¿…è¦çš„å±å¹•é‡æ–°æ¸²æŸ“ã€‚ç›®å‰ï¼Œè¯¥è§†å›¾åªä¼šåœ¨æ”¶è—çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°è®¡ç®—è‡ªå·±ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å¯èƒ½ä¼šå¯¹æˆ‘ä»¬çš„æ”¶è—æ•°ç»„è¿›è¡Œå¤§é‡æ›´æ”¹ï¼Œä½†è¿™äº›æ›´æ”¹éƒ½ä¸ä¼šè§¦å‘é‡æ–°è®¡ç®—ï¼Œé™¤éå®ƒç¢°å·§æ”¹å˜äº†æˆ‘ä»¬æ­£åœ¨æŸ¥çœ‹çš„å½“å‰è®¡æ•°ã€‚</p>
<p>è¿˜æœ‰æ›´å¤šå…³äºæˆ‘ä»¬å¦‚ä½•è¿›è¡Œè¿™äº›ç±»å‹çš„<strong>view store</strong>è½¬æ¢çš„ä¾‹å­ã€‚ä¾‹å¦‚ï¼Œåœ¨è®¡æ•°å™¨ä¸­ï¼Œæˆ‘ä»¬æœ‰å½“å‰çŠ¶æ€ç»“æ„ä½“:</p>
<pre><code class="language-swift">public struct CounterFeatureState: Equatable {
  public var alertNthPrime: PrimeAlert?
  public var count: Int
  public var favoritePrimes: [Int]
  public var isNthPrimeButtonDisabled: Bool
  public var isPrimeModalShown: Bool
}
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬çš„å®Œç¾çŠ¶æ€,ä½†æœ‰äº›å¯èƒ½ä¼šè§‰å¾—æœ‰ç‚¹å¥‡æ€ª,æˆ‘ä»¬æœ‰ä¸€ä¸ªæ··åˆç‰©çš„çŠ¶æ€ï¼Œå®ƒæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæŠ½è±¡è¡¨ç¤º(å°¤å…¶æ˜¯<strong>count</strong>å’Œ<strong>favoritePrimes</strong>å­—æ®µ),å’Œä¸€äº›å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ›´å…·æè¿°æ€§çš„<strong>state</strong>(åƒalertNthPrime,isNthPrimeButtonDisabledå’ŒisPrimeModalShown)ã€‚</p>
<p>å¦‚æœéœ€è¦çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>view store</strong>çš„æ¦‚å¿µæ¥æ›´å¥½åœ°åˆ†ç¦»è¿™ä¸¤ç§çŠ¶æ€ã€‚è®©æˆ‘ä»¬å¯¹<strong>isNthPrimeButtonDisabled</strong>çŠ¶æ€åšè¿™ä¸ªï¼Œè¿™æ ·ä½ å°±èƒ½çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚ç°åœ¨ï¼Œè¿™ä¸ªå­—æ®µçš„å‘½åéå¸¸æ¸…æ¥šåœ°ä¸å®ƒåœ¨UIä¸­è¡¨ç¤ºçš„å†…å®¹ä¸€è‡´ï¼Œè¿™çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºè¿™æ„å‘³ç€è§†å›¾ä»£ç ä»¥æœ€ç®€å•çš„æ–¹å¼ä½¿ç”¨å®ƒ:</p>
<pre><code class="language-swift">.disabled(self.viewStore.isNthPrimeButtonDisabled)
</code></pre>
<p>è¯¥å­—æ®µçš„å€¼å–å†³äºå¯¹â€œç¬¬nä¸ªç´ æ•°â€çš„APIè¯·æ±‚æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚å½“æˆ‘ä»¬è¯•å›¾åŠ è½½è¯¥ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬ç¦ç”¨è¯¥æŒ‰é’®ï¼Œä¸€æ—¦æˆ‘ä»¬å¾—åˆ°å“åº”ï¼Œæˆ‘ä»¬å°±é‡æ–°å¯ç”¨å®ƒã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœåœ¨è¯·æ±‚è¿è¡ŒæœŸé—´æœ‰æ›´å¤šçš„ä¸œè¥¿éœ€è¦ç¦ç”¨å‘¢? ä¹Ÿè®¸æˆ‘ä»¬ç”šè‡³è¦ç¦ç”¨è‡ªå¢å’Œè‡ªå‡æŒ‰é’®ã€‚ä¹Ÿè®¸æˆ‘ä»¬è¿˜æƒ³åœ¨è¯·æ±‚é£è¡Œæ—¶æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºç¬¦ã€‚è¿™äº›éƒ½æ˜¯æœ‰æ•ˆçš„äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æ›´å¤šçš„çŠ¶æ€æ¥è¡¨ç¤ºå®ƒä»¬:</p>
<pre><code class="language-swift">public struct CounterFeatureState: Equatable {
  public var alertNthPrime: PrimeAlert?
  public var count: Int
  public var favoritePrimes: [Int]
  public var isNthPrimeButtonDisabled: Bool
  public var isPrimeModalShown: Bool

  public var isIncrementButtonDisabled: Bool
  public var isDecrementButtonDisabled: Bool
  public var isLoadingIndicatorHidden: Bool
}
</code></pre>
<p>æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥æè¿°çŠ¶æ€çš„åŸºæœ¬å•ä½ï¼Œæ‰€æœ‰è¿™äº›çŠ¶æ€éƒ½å¯ä»¥ä»ä¸­å¾—åˆ°ã€‚ ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„äº‹æƒ…æ˜¯ç½‘ç»œè¯·æ±‚æ­£åœ¨è¿è¡Œï¼Œä»é‚£é‡Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºæ‰€æœ‰å…¶ä»–çš„ä¸œè¥¿ã€‚æ‰€ä»¥è®©æˆ‘ä»¬å»æ‰è¿™äº›ç‰¹å®šäºuiçš„å­—æ®µï¼Œç”¨uiæ— å…³å­—æ®µæ›¿æ¢å®ƒ:</p>
<pre><code class="language-swift">public struct CounterFeatureState: Equatable {
  public var alertNthPrime: PrimeAlert?
  public var count: Int
  public var favoritePrimes: [Int]
  public var isNthPrimeRequestInFlight: Bool
  public var isPrimeModalShown: Bool
  â€¦
  public init(
    alertNthPrime: PrimeAlert? = nil,
    count: Int = 0,
    favoritePrimes: [Int] = [],
    isNthPrimeRequestInFlight: Bool = false,
    isPrimeModalShown: Bool = false
  ) {
    self.alertNthPrime = alertNthPrime
    self.count = count
    self.favoritePrimes = favoritePrimes
    self.isNthPrimeRequestInFlight = isNthPrimeRequestInFlight
    self.isPrimeModalShown = isPrimeModalShown
  }
</code></pre>
<p>è¿™ä¼šç ´åä¸€äº›ä¸œè¥¿ã€‚æˆ‘ä»¬é¦–å…ˆçœ‹åˆ°çš„æ˜¯<strong>CounterFeatureState</strong>ä¸Šçš„<strong>counter</strong>å±æ€§ï¼Œå®ƒè´Ÿè´£åˆ‡æ‰è®¡æ•°å™¨ç‰¹æ€§æ‰€å…³å¿ƒçš„å”¯ä¸€å±æ€§(ä¸ä¸»è¦æ¨¡æ€ç‰¹æ€§ç›¸å)ã€‚è¿™ä¸ªåŠŸèƒ½çš„<strong>reducer</strong>ä¹Ÿåº”è¯¥åœæ­¢æ‹…å¿ƒæŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨æ›´é«˜çº§çš„æ¦‚å¿µï¼Œå³ç½‘ç»œè¯·æ±‚æ˜¯å¦åœ¨ç©ºä¸­:</p>
<pre><code class="language-swift">public typealias CounterState = (
  alertNthPrime: PrimeAlert?,
  count: Int,
  isNthPrimeRequestInFlight: Bool,
  isPrimeModalShown: Bool
)
â€¦
var counter: CounterState {
  get { (self.alertNthPrime, self.count, self.isNthPrimeRequestInFlight, self.isPrimeModalShown) }
  set { (self.alertNthPrime, self.count, self.isNthPrimeRequestInFlight, self.isPrimeModalShown) = newValue }
}
</code></pre>
<p>ç„¶å<strong>reducer</strong>éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°å±æ€§:</p>
<pre><code class="language-swift">case .nthPrimeButtonTapped:
  state.isNthPrimeRequestInFlight = true
  â€¦

case let .nthPrimeResponse(prime):
  â€¦
  state.isNthPrimeRequestInFlight = false
  â€¦
</code></pre>
<p>æœ€åæˆ‘ä»¬è¦ä¿®å¤è§†å›¾ï¼Œè¿™å°±æ˜¯æœ‰è¶£çš„åœ°æ–¹ã€‚<strong>view store</strong>å½“å‰å‡†ç¡®åœ°è¡¨è¾¾äº†æˆ‘ä»¬çš„è§†å›¾æƒ³è¦çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆéœ€è¦æ”¹å˜çš„:</p>
<pre><code class="language-swift">struct State: Equatable {
  let alertNthPrime: PrimeAlert?
  let count: Int
  let isNthPrimeButtonDisabled: Bool
  let isPrimeModalShown: Bool
}

@ObservedObject var viewStore: ViewStore&lt;State&gt;
</code></pre>
<p>æˆ‘ä»¬åªéœ€è¦æ›´æ–°è½¬æ¢ä¸º<strong>view store</strong>çŠ¶æ€çš„åˆå§‹åŒ–å™¨:</p>
<pre><code class="language-swift">extension CounterView.State {
  init(counterFeatureState state: CounterFeatureState) {
    self.alertNthPrime = state.alertNthPrime
    self.count = state.count
    self.isNthPrimeButtonDisabled = state.isNthPrimeRequestInFlight
    self.isPrimeModalShown = state.isPrimeModalShown
  }
}
</code></pre>
<p>ç°åœ¨è¿™ä¸ªæ¨¡å—æ­£åœ¨ç¼–è¯‘ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ°ä½¿è¯¥ç‰¹æ€§çš„çŠ¶æ€å¯¹UIæ›´åŠ ä¸å¯çŸ¥ï¼ŒåŒæ—¶ä»ç„¶å…è®¸è§†å›¾ä½¿ç”¨ç‰¹å®šäºåŸŸçš„çŠ¶æ€æè¿°ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæ›´å¤šçš„å¸ƒå°”å€¼æ¥æ§åˆ¶é€’å¢å’Œé€’å‡æŒ‰é’®çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€:</p>
<pre><code class="language-swift">struct State: Equatable {
  let alertNthPrime: PrimeAlert?
  let count: Int
  let isNthPrimeButtonDisabled: Bool
  let isPrimeModalShown: Bool
  let isIncrementButtonDisabled: Bool
  let isDecrementButtonDisabled: Bool
}
â€¦
extension CounterView.State {
  init(counterFeatureState state: CounterFeatureState) {
    self.alertNthPrime = state.alertNthPrime
    self.count = state.count
    self.isNthPrimeButtonDisabled = state.isNthPrimeRequestInFlight
    self.isPrimeModalShown = state.isPrimeModalShown
    self.isIncrementButtonDisabled = state.isNthPrimeRequestInFlight
    self.isDecrementButtonDisabled = state.isNthPrimeRequestInFlight
  }
}
â€¦
Button(&quot;-&quot;) { self.store.send(.counter(.decrTapped)) }
  .disabled(self.viewStore.value.isDecrementButtonDisabled)
Text(&quot;\(self.viewStore.value.count)&quot;)
Button(&quot;+&quot;) { self.store.send(.counter(.incrTapped)) }
  .disabled(self.viewStore.value.isIncrementButtonDisabled)
</code></pre>
<p>æœ€é…·çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ–°ç‰¹æ€§å’ŒåŠŸèƒ½æ·»åŠ åˆ°æˆ‘ä»¬çš„è§†å›¾ä¸­ï¼Œè€Œä¸éœ€è¦å¯¹æˆ‘ä»¬çš„<strong>reducer</strong>æˆ–åº”ç”¨ç¨‹åºçŠ¶æ€è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚è¿™ä¸ªé€»è¾‘çº¯ç²¹æ˜¯è§†å›¾å…³å¿ƒçš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæ˜¯åº”ç”¨ç¨‹åºçŠ¶æ€åˆ°è§†å›¾çŠ¶æ€çš„çº¯è½¬æ¢ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»çœ‹åˆ°<strong>ViewStore</strong>æŠ½è±¡æ¯”ä»…ä»…ä½œä¸ºä¸€ä¸ªæ€§èƒ½å·¥å…·æ›´æœ‰è¶£ã€‚è¿™æ˜¯æˆ‘ä»¬å¡‘é€ è§†å›¾æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œä»¥ä¾¿ä½¿æˆ‘ä»¬çš„è§†å›¾ä¸»ä½“å°½å¯èƒ½åœ°ç®€å•å’Œæ— é€»è¾‘ã€‚</p>
<hr>
<h2 id="6-a-nameconclutionaconclution">6. <a name='conclution'></a>conclution</h2>
<p>ç›®å‰æˆ‘ä»¬çš„<strong>ViewStore</strong>æœ‰ç‚¹ä¸å¹³è¡¡ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨<strong>ViewStore</strong>æ—¶åªå…³æ³¨åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚è¿™æ˜¯å¯ä»¥ç†è§£çš„ï¼Œå› ä¸º<strong>ViewStore</strong>çš„æ•´ä¸ªåŠ¨æœºæ˜¯ä¸ºäº†æé«˜æ€§èƒ½è€Œæœ€å°åŒ–æˆ‘ä»¬çš„è§†å›¾æ‰€çŸ¥é“çš„çŠ¶æ€ï¼Œä½†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜æœ‰å¦å¤–ä¸€é¢:<strong>actions</strong>!</p>
<p>é€šè¿‡æ‰©å±•<strong>ViewStore</strong>çš„æ¦‚å¿µæ¥è€ƒè™‘è§†å›¾æ‰€å…³å¿ƒçš„æ“ä½œï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè¿›ä¸€æ­¥å‡¿å¼€è§†å›¾æ‰€è®¿é—®çš„åŸŸã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/i-r9uoo_2N/" class="tag">
                    PointFree
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/pointfree-episode-94-adaptive-state-management-performance/">
                  <h3 class="post-title">
                    PointFree Episode 94: Adaptive State Management: Performance
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
