<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Managing self and cancellable references when using Combine | Kayouyou&#39;s Den</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kayouyou.github.io/favicon.ico?v=1647167519050">
<link rel="stylesheet" href="https://kayouyou.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="åœ¨å¤„ç†å¼‚æ­¥æ“ä½œæ—¶ï¼Œå†…å­˜ç®¡ç†é€šå¸¸ç‰¹åˆ«æ£˜æ‰‹ï¼Œå› ä¸ºå®ƒä»¬å¾€å¾€è¦æ±‚æˆ‘ä»¬å°†æŸäº›è¶…å‡ºå®ƒä»¬å®šä¹‰çš„èŒƒå›´çš„å¯¹è±¡ä¿ç•™åœ¨å†…å­˜ä¸­ï¼ŒåŒæ—¶ä»ç„¶ç¡®ä¿è¿™äº›å¯¹è±¡æœ€ç»ˆä»¥å¯é¢„æµ‹çš„æ–¹å¼è¢«é‡Šæ”¾ã€‚
å°½ç®¡Appleçš„Combineæ¡†æ¶å¯ä»¥ä½¿ç®¡ç†è¿™ç§é•¿æœŸå¼•ç”¨å˜å¾—ç¨å¾®ç®€å•ä¸€äº›â€”â€”å› ä¸ºå®ƒé¼“åŠ±æˆ‘..." />
    <meta name="keywords" content="memory management,combine" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kayouyou.github.io">
        <img src="https://kayouyou.github.io/images/avatar.png?v=1647167519050" class="site-logo">
        <h1 class="site-title">Kayouyou&#39;s Den</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      The wise build bridges, while the foolish build barriers.
    </div>
    <div class="site-footer">
      è±«ICPå¤‡2021012281å·-1  | <a class="rss" href="https://kayouyou.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Managing self and cancellable references when using Combine</h2>
            <div class="post-date">2021-02-05</div>
            
              <div class="feature-container" style="background-image: url('https://images.unsplash.com/photo-1520970014086-2208d157c9e2?ixid=MnwxMjA3fDB8MHxzZWFyY2h8MXx8c3VtbWFyeXxlbnwwfHwwfHw%3D&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=900&amp;q=60')">
              </div>
            
            <div class="post-content" v-pre>
              <p>åœ¨å¤„ç†å¼‚æ­¥æ“ä½œæ—¶ï¼Œå†…å­˜ç®¡ç†é€šå¸¸ç‰¹åˆ«æ£˜æ‰‹ï¼Œå› ä¸ºå®ƒä»¬å¾€å¾€è¦æ±‚æˆ‘ä»¬å°†æŸäº›è¶…å‡ºå®ƒä»¬å®šä¹‰çš„èŒƒå›´çš„å¯¹è±¡ä¿ç•™åœ¨å†…å­˜ä¸­ï¼ŒåŒæ—¶ä»ç„¶ç¡®ä¿è¿™äº›å¯¹è±¡æœ€ç»ˆä»¥å¯é¢„æµ‹çš„æ–¹å¼è¢«é‡Šæ”¾ã€‚</p>
<p>å°½ç®¡Appleçš„Combineæ¡†æ¶å¯ä»¥ä½¿ç®¡ç†è¿™ç§é•¿æœŸå¼•ç”¨å˜å¾—ç¨å¾®ç®€å•ä¸€äº›â€”â€”å› ä¸ºå®ƒé¼“åŠ±æˆ‘ä»¬å°†å¼‚æ­¥ä»£ç å»ºæ¨¡ä¸ºç®¡é“ï¼Œ é™¤äº†ä¸€ç³»åˆ—åµŒå¥—çš„é—­åŒ…ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šæ½œåœ¨çš„å†…å­˜ç®¡ç†é™·é˜±éœ€è¦æˆ‘ä»¬ä¸æ–­æ³¨æ„ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é¿å…è¿™äº›é™·é˜±ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°selfå¼•ç”¨å’Œå¯å–æ¶ˆå¼•ç”¨æ—¶ã€‚</p>
<h2 id="a-cancellable-manages-the-lifetime-of-a-subscription">A cancellable manages the lifetime of a subscription</h2>
<p>Combineçš„å¯å–æ¶ˆåè®®(which we typically interact with through its type-erased AnyCancellable wrapper)è®©æˆ‘ä»¬æ§åˆ¶ç»™å®šè®¢é˜…åº”è¯¥ä¿æŒæ´»åŠ¨å’Œæ´»åŠ¨çš„æ—¶é—´ã€‚é¡¾åæ€ä¹‰ï¼Œä¸€æ—¦å¯å–æ¶ˆçš„èµ„æºè¢«é‡Šæ”¾(æˆ–æ‰‹åŠ¨å–æ¶ˆ)ï¼Œå®ƒæ‰€ç»‘å®šçš„è®¢é˜…å°†è‡ªåŠ¨å¤±æ•ˆ-è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‡ ä¹æ‰€æœ‰çš„Combineçš„è®¢é˜…api(å¦‚sink)åœ¨è°ƒç”¨æ—¶è¿”å›ä¸€ä¸ªAnyCancellableã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„æ—¶é’Ÿç±»å‹æŒæœ‰å¯¹AnyCancellableå®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹æ˜¯å®ƒä»è®¡æ—¶å™¨å‘å¸ƒè€…ä¸Šè°ƒç”¨sinkå¾—åˆ°çš„ï¼Œåªè¦å®ƒçš„æ—¶é’Ÿå®ä¾‹è¿˜åœ¨å†…å­˜ä¸­ï¼Œè®¢é˜…å°±ä¼šä¸€ç›´å¤„äºæ¿€æ´»çŠ¶æ€â€”â€”é™¤éé€šè¿‡å°†å…¶å±æ€§è®¾ç½®ä¸ºnilæ¥æ‰‹åŠ¨åˆ é™¤å¯å–æ¶ˆå¯¹è±¡:</p>
<pre><code class="language-swift">class Clock: ObservableObject {
    @Published private(set) var time = Date().timeIntervalSince1970
    private var cancellable: AnyCancellable?

    func start() {
        cancellable = Timer.publish(
            every: 1,
            on: .main,
            in: .default
        )
        .autoconnect()
        .sink { date in
            self.time = date.timeIntervalSince1970
        }
    }

    func stop() {
        cancellable = nil
    }
}

</code></pre>
<p>ç„¶è€Œï¼Œå°½ç®¡ä¸Šé¢çš„å®ç°å®Œç¾åœ°ç®¡ç†äº†å®ƒçš„AnyCancellableå®ä¾‹å’Œå®ƒæ‰€ä»£è¡¨çš„è®¡æ—¶å™¨è®¢é˜…ï¼Œå®ƒåœ¨å†…å­˜ç®¡ç†æ–¹é¢ç¡®å®æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ã€‚å› ä¸ºæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„sinké—­åŒ…ä¸­æ•è·selfï¼Œè€Œä¸”æˆ‘ä»¬çš„cancellable(å®ƒæ˜¯ç”±selfæ‹¥æœ‰çš„)å°†ä¿æŒè®¢é˜…æ´»ç€ï¼Œåªè¦å®ƒè¿˜åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥ä¸€ä¸ªå¾ªç¯å¼•ç”¨ç»“æŸâ€”â€”æˆ–è€…æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªå†…å­˜æ³„æ¼ã€‚</p>
<h2 id="avoiding-self-related-memory-leaks">Avoiding self-related memory leaks</h2>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€åˆæƒ³æ³•å¯èƒ½æ˜¯ä½¿ç”¨Combineçš„èµ‹å€¼æ“ä½œç¬¦(along with a quick Data-to-TimeInterval transformation using map)ï¼Œä»è€Œèƒ½å¤Ÿå°†ç®¡é“çš„ç»“æœç›´æ¥èµ‹å€¼ç»™æ—¶é’Ÿçš„æ—¶é—´å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">class Clock: ObservableObject {
    ...

    func start() {
        cancellable = Timer.publish(
            every: 1,
            on: .main,
            in: .default
        )
        .autoconnect()
        .map(\.timeIntervalSince1970)
        .assign(to: \.time, on: self)
    }

    ...
}
</code></pre>
<p>ç„¶è€Œï¼Œä¸Šè¿°æ–¹æ³•ä»ç„¶ä¼šå¯¼è‡´selfè¢«ä¿ç•™ï¼Œå› ä¸ºassignæ“ä½œç¬¦ä¼šä¿ç•™å¯¹ä¼ é€’ç»™å®ƒçš„æ¯ä¸ªå¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚ç›¸åï¼Œåœ¨æˆ‘ä»¬å½“å‰çš„è®¾ç½®ä¸­ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ±‚åŠ©äºä¸€ä¸ªè€å¼çš„â€œweak selfâ€æ¥æ•è·ä¸€ä¸ªå¯¹æˆ‘ä»¬çš„å°é—­æ—¶é’Ÿå®ä¾‹çš„å¼±å¼•ç”¨ï¼Œè¿™å°†æ‰“ç ´æˆ‘ä»¬çš„å¾ªç¯å¼•ç”¨:</p>
<pre><code class="language-swift">class Clock: ObservableObject {
    ...

    func start() {
        cancellable = Timer.publish(
            every: 1,
            on: .main,
            in: .default
        )
        .autoconnect()
        .map(\.timeIntervalSince1970)
        .sink { [weak self] time in
            self?.time = time
        }
    }

    ...
}
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„å†…å®¹ï¼Œä¸€æ—¦ä¸å†è¢«ä»»ä½•å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œæ¯ä¸ªæ—¶é’Ÿå®ä¾‹å°±å¯ä»¥è¢«é‡æ–°åˆ†é…ï¼Œè¿™åè¿‡æ¥åˆä¼šå¯¼è‡´AnyCancellableä¹Ÿè¢«é‡æ–°åˆ†é…ï¼Œè€Œæˆ‘ä»¬çš„Combineç®¡é“ä¹Ÿå°†è¢«é€‚å½“åœ°è§£æ•£ã€‚å¤ªæ£’äº†!</p>
<h2 id="assigning-output-values-directly-to-a-published-property">Assigning output values directly to a Published property</h2>
<p>å¦ä¸€ä¸ªå€¼å¾—è®°ä½çš„é€‰é¡¹æ˜¯(åœ¨iOS 14å’ŒmacOS Big Surä¸­)æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è¿æ¥ä¸€ä¸ªCombineç®¡é“åˆ°ä¸€ä¸ªpublishedå±æ€§ã€‚ç„¶è€Œï¼Œå°½ç®¡åœ¨è®¸å¤šä¸åŒçš„æƒ…å†µä¸‹è¿™æ ·åšæ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¹¶æ²¡æœ‰ç»™æˆ‘ä»¬ä»»ä½•å¯å–æ¶ˆçš„è¿”å›â€”â€”è¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æœ‰ä»»ä½•æ–¹æ³•æ¥å–æ¶ˆè¿™æ ·çš„è®¢é˜…ã€‚</p>
<p>å¯¹äºæˆ‘ä»¬çš„æ—¶é’Ÿç±»å‹ï¼Œæˆ‘ä»¬å¯èƒ½ä»ç„¶èƒ½å¤Ÿä½¿ç”¨è¿™ç§æ–¹æ³•â€”â€”å¦‚æœæˆ‘ä»¬å¯ä»¥åˆ é™¤æˆ‘ä»¬çš„startå’Œstopæ–¹æ³•ï¼Œè€Œåœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨å¯åŠ¨æ¯ä¸ªæ—¶é’Ÿï¼Œå¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šä»¥é‡å¤è®¢é˜…ç»“æŸã€‚ å¦‚æœè¿™äº›æ˜¯æˆ‘ä»¬æ„¿æ„æ¥å—çš„æŠ˜è¡·æ–¹æ¡ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å®ç°æ”¹ä¸º:</p>
<pre><code class="language-swift">class Clock: ObservableObject {
    @Published private(set) var time = Date().timeIntervalSince1970

    init() {
        Timer.publish(
            every: 1,
            on: .main,
            in: .default
        )
        .autoconnect()
        .map(\.timeIntervalSince1970)
        .assign(to: &amp;$time)
    }
}
</code></pre>
<p>å½“è°ƒç”¨ä¸Šè¿°ç±»å‹çš„assignæ—¶ï¼Œæˆ‘ä»¬å°†ä¼ é€’ä¸€ä¸ªå¯¹å·²å‘å¸ƒå±æ€§çš„æŠ•å½±å€¼çš„ç›´æ¥å¼•ç”¨ï¼Œå¹¶ä»¥ä¸€ä¸ª&amp;ç¬¦å·ä½œä¸ºå‰ç¼€ï¼Œä»¥ä½¿è¯¥å€¼æˆä¸ºå¯å˜çš„(å› ä¸ºassignä½¿ç”¨inoutå…³é”®å­—)ã€‚ è¦äº†è§£æœ‰å…³è¯¥æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹å…³äºå€¼å’Œå¼•ç”¨ç±»å‹çš„åŸºç¡€æ–‡ç« ã€‚</p>
<p>ä¸Šè¿°æ–¹æ³•çš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼ŒCombineç°åœ¨å°†æ ¹æ®æˆ‘ä»¬çš„æ—¶é—´å±æ€§çš„ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†æˆ‘ä»¬çš„è®¢é˜…â€”â€”è¿™æ„å‘³ç€æˆ‘ä»¬ä»ç„¶é¿å…äº†ä»»ä½•å¼•ç”¨å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿæ˜¾è‘—å‡å°‘äº†æˆ‘ä»¬å¿…é¡»è‡ªå·±ç¼–å†™çš„ç°¿è®°ä»£ç çš„æ•°é‡ã€‚å› æ­¤ï¼Œå¯¹äºåªé…ç½®ä¸€æ¬¡å¹¶ç›´æ¥ç»‘å®šåˆ°Publishedå±æ€§çš„ç®¡é“ï¼Œä½¿ç”¨ä¸Šé¢çš„assignæ“ä½œç¬¦é‡è½½é€šå¸¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<h2 id="weak-property-assignments">Weak property assignments</h2>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ç¤ºä¾‹ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ModelLoaderï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»ç»™å®šçš„URLåŠ è½½å’Œè§£ç å¯è§£ç çš„æ¨¡å‹ã€‚é€šè¿‡ä½¿ç”¨å•ä¸ªcancellableå±æ€§ï¼Œæˆ‘ä»¬çš„åŠ è½½å™¨å¯ä»¥åœ¨è§¦å‘æ–°çš„æ•°æ®åŠ è½½ç®¡é“æ—¶è‡ªåŠ¨å–æ¶ˆä»»ä½•ä»¥å‰çš„æ•°æ®åŠ è½½ç®¡é“ - å½“å±æ€§çš„å€¼è¢«æ›¿æ¢æ—¶ï¼Œä»»ä½•å…ˆå‰åˆ†é…çš„AnyCancellableå®ä¾‹å°†è¢«é‡æ–°åˆ†é…ã€‚</p>
<p>ä¸‹é¢æ˜¯ModelLoaderç±»å‹å½“å‰çš„æ ·å­:</p>
<pre><code class="language-swift">class ModelLoader&lt;Model: Decodable&gt;: ObservableObject {
    enum State {
        case idle
        case loading
        case loaded(Model)
        case failed(Error)
    }

    @Published private(set) var state = State.idle

    private let url: URL
    private let session: URLSession
    private let decoder: JSONDecoder
    private var cancellable: AnyCancellable?
    ...
    func load() {
        state = .loading
        cancellable = session
            .dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: Model.self, decoder: decoder)
            .map(State.loaded)
            .catch { error in
                Just(.failed(error))
            }
            .receive(on: DispatchQueue.main)
            .sink { [weak self] state in
                self?.state = state
            }
    }
}
</code></pre>
<p>è™½ç„¶è‡ªåŠ¨å–æ¶ˆæ—§è¯·æ±‚é˜»æ­¢äº†æˆ‘ä»¬ç®€å•åœ°å°†æ•°æ®åŠ è½½ç®¡é“çš„è¾“å‡ºè¿æ¥åˆ°æˆ‘ä»¬çš„Publishedå±æ€§ï¼Œå¦‚æœæˆ‘ä»¬æƒ³é¿å…æ¯æ¬¡ä½¿ç”¨ä¸Šè¿°æ¨¡å¼(å³åŠ è½½ä¸€ä¸ªå€¼å¹¶å°†å…¶èµ‹å€¼ç»™ä¸€ä¸ªå±æ€§)æ—¶éƒ½å¿…é¡»æ‰‹åŠ¨æ•è·å¯¹selfçš„å¼±å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä»¥ä¸‹å‘å¸ƒè€…æ‰©å±•â€”â€”å®ƒå¢åŠ äº†æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„æ ‡å‡†èµ‹å€¼æ“ä½œç¬¦çš„å¼±æ•è·ç‰ˆæœ¬:</p>
<pre><code class="language-swift">extension Publisher where Failure == Never {
    func weakAssign&lt;T: AnyObject&gt;(
        to keyPath: ReferenceWritableKeyPath&lt;T, Output&gt;,
        on object: T
    ) -&gt; AnyCancellable {
        sink { [weak object] value in
            object?[keyPath: keyPath] = value
        }
    }
}
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„å†…å®¹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°è°ƒç”¨weakAssignï¼Œå½“æˆ‘ä»¬æƒ³è¦å°†ç»™å®šå‘å¸ƒè€…çš„è¾“å‡ºèµ‹å€¼ç»™ä½¿ç”¨å¼±å¼•ç”¨æ•è·çš„å¯¹è±¡çš„å±æ€§æ—¶ï¼Œå°±åƒè¿™æ ·:</p>
<pre><code class="language-swift">class ModelLoader&lt;Model: Decodable&gt;: ObservableObject {
    ...

    func load() {
        state = .loading

        cancellable = session
            .dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: Model.self, decoder: decoder)
            .map(State.loaded)
            .catch { error in
                Just(.failed(error))
            }
            .receive(on: DispatchQueue.main)
            .weakAssign(to: \.state, on: self)
    }
}
</code></pre>
<p>æ–°çš„weakAssignæ–¹æ³•çº¯ç²¹æ˜¯è¯­æ³•ç³–å—?æ˜¯çš„ã€‚ä½†å®ƒæ¯”æˆ‘ä»¬ä»¥å‰ç”¨çš„æ›´å¥½å—?è¿˜æ˜¯çš„ğŸ™‚</p>
<h2 id="capturing-stored-objects-rather-than-self">Capturing stored objects, rather than self</h2>
<p>ä½¿ç”¨Combineæ—¶ç»å¸¸é‡åˆ°çš„å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªæ“ä½œç¬¦ä¸­çš„ç‰¹å®šå±æ€§ï¼Œä¾‹å¦‚ä¸ºäº†æ‰§è¡ŒåµŒå¥—å¼‚æ­¥è°ƒç”¨ã€‚</p>
<p>ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå‡è®¾æˆ‘ä»¬æƒ³é€šè¿‡ä½¿ç”¨æ•°æ®åº“æ¥è‡ªåŠ¨å­˜å‚¨æ‰€åŠ è½½çš„æ¯ä¸ªæ¨¡å‹æ¥æ‰©å±•ModelLoaderâ€”ä¸€ä¸ªä½¿ç”¨é€šç”¨Storedç±»å‹åŒ…è£…é‚£äº›æ¨¡å‹å®ä¾‹çš„æ“ä½œ(ä¾‹å¦‚ä¸ºäº†æ·»åŠ æœ¬åœ°å…ƒæ•°æ®ï¼Œä¾‹å¦‚IDæˆ–æ¨¡å‹ç‰ˆæœ¬)ã€‚ ä¸ºäº†èƒ½å¤Ÿåœ¨flatMapè¿™æ ·çš„æ“ä½œç¬¦ä¸­è®¿é—®è¯¥æ•°æ®åº“å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡æ•è·selfçš„å¼±å¼•ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-swift">class ModelLoader&lt;Model: Decodable&gt;: ObservableObject {
    enum State {
        case idle
        case loading
        case loaded(Stored&lt;Model&gt;)
        case failed(Error)
    }

    ...
    private let database: Database
    ...

    func load() {
        state = .loading

        cancellable = session
            .dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: Model.self, decoder: decoder)
            .flatMap {
                [weak self] model -&gt; AnyPublisher&lt;Stored&lt;Model&gt;, Error&gt; in
    
                guard let database = self?.database else {
                    return Empty(completeImmediately: true)
                        .eraseToAnyPublisher()
                }
    
                return database.store(model)
            }
            .map(State.loaded)
            .catch { error in
                Just(.failed(error))
            }
            .receive(on: DispatchQueue.main)
            .weakAssign(to: \.state, on: self)
    }
}
</code></pre>
<p>æ‰€ä»¥ä½¿ç”¨ä¸Šé¢çš„flatMapæ“ä½œç¬¦ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„æ•°æ®åº“ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œå¹¶è¿”å›å¦ä¸€ä¸ªè¡¨ç¤ºå½“å‰ä¿å­˜æ“ä½œçš„å‘å¸ƒè€…ã€‚</p>
<p>ç„¶è€Œï¼Œæ­£å¦‚ä¸Šé¢çš„ç¤ºä¾‹æ‰€ç¤ºï¼Œä»mapæˆ–flatMapç­‰æ“ä½œç¬¦å†…çš„å±•å¼€ä¿æŠ¤è¯­å¥è¿”å›ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼æœ‰æ—¶ä¼šå¾ˆæ£˜æ‰‹ã€‚ ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨äº†Emptyï¼Œå®ƒå¯ä»¥å·¥ä½œï¼Œä½†å®ƒç¡®å®ç»™æˆ‘ä»¬åŸæœ¬ç›¸å½“ä¼˜é›…çš„ç®¡é“å¢åŠ äº†å¤§é‡é¢å¤–çš„å†—ä½™ã€‚</p>
<p>å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è§£å†³(è‡³å°‘åœ¨è¿™ç§æƒ…å†µä¸‹)ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯ç›´æ¥æ•è·æ•°æ®åº“å±æ€§ï¼Œè€Œä¸æ˜¯æ•è·selfã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¸å¿…å¤„ç†ä»»ä½•å¯é€‰çš„ï¼Œç°åœ¨å¯ä»¥ç®€å•åœ°åœ¨flatMapé—­åŒ…ä¸­è°ƒç”¨æ•°æ®åº“çš„storeæ–¹æ³•â€”â€”åƒè¿™æ ·:</p>
<pre><code class="language-swift">class ModelLoader&lt;Model: Decodable&gt;: ObservableObject {
    ...

    func load() {
        state = .loading

        cancellable = session
            .dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: Model.self, decoder: decoder)
            .flatMap { [database] model in
                database.store(model)
            }
            .map(State.loaded)
            .catch { error in
                Just(.failed(error))
            }
            .receive(on: DispatchQueue.main)
            .weakAssign(to: \.state, on: self)
    }
}
</code></pre>
<p>ä½œä¸ºé¢å¤–çš„å¥½å¤„ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†æˆ‘ä»¬æƒ³è¦ç›´æ¥è°ƒç”¨çš„æ•°æ®åº“æ–¹æ³•ä¼ é€’åˆ°æœ¬ä¾‹ä¸­çš„flatMapä¸­ -å› ä¸ºå®ƒçš„ç­¾åå®Œå…¨åŒ¹é…flatMapåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æœŸæœ›çš„é—­åŒ…(å¹¶ä¸”ç”±äºSwiftæ”¯æŒç¬¬ä¸€ç±»å‡½æ•°çš„äº‹å®):</p>
<pre><code class="language-swift">class ModelLoader&lt;Model: Decodable&gt;: ObservableObject {
    ...

    func load() {
        state = .loading

        cancellable = session
            .dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: Model.self, decoder: decoder)
            .flatMap(database.store)
            .map(State.loaded)
            .catch { error in
                Just(.failed(error))
            }
            .receive(on: DispatchQueue.main)
            .weakAssign(to: \.state, on: self)
    }
}

</code></pre>
<p>å› æ­¤ï¼Œåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½é¿å…åœ¨ç»„åˆæ“ä½œç¬¦ä¸­æ•è·selfï¼Œè€Œè°ƒç”¨å…¶ä»–å¯ä»¥å­˜å‚¨å¹¶ä½œä¸ºå±æ€§ç›´æ¥ä¼ é€’ç»™å„ç§æ“ä½œç¬¦çš„å¯¹è±¡ã€‚</p>
<h2 id="conclusion">Conclusion</h2>
<p>è™½ç„¶Combineæä¾›äº†è®¸å¤šapiå’Œç‰¹æ€§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å®¹æ˜“åœ°ç¼–å†™å’Œç»´æŠ¤å¼‚æ­¥ä»£ç ï¼Œä½†åœ¨ç®¡ç†å¼•ç”¨åŠå…¶åº•å±‚å†…å­˜æ—¶ï¼Œä»ç„¶éœ€è¦æˆ‘ä»¬å°å¿ƒè°¨æ…ã€‚åœ¨é”™è¯¯çš„ä½ç½®æ•è·å¯¹selfçš„å¼ºå¼•ç”¨é€šå¸¸ä»ç„¶ä¼šå¯¼è‡´ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼Œå¦‚æœä¸€ä¸ªå¯å–æ¶ˆçš„å¯¹è±¡æ²¡æœ‰è¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œé‚£ä¹ˆè®¢é˜…æ´»åŠ¨çš„æ—¶é—´å¯èƒ½ä¼šæ¯”é¢„æœŸçš„æ›´é•¿ã€‚</p>
<p><a href="https://www.swiftbysundell.com/articles/combine-self-cancellable-memory-management/">åŸæ–‡é“¾æ¥</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kayouyou.github.io/tag/_oT-GALgc/" class="tag">
                    memory management
                  </a>
                
                  <a href="https://kayouyou.github.io/tag/pWBp0_XTT/" class="tag">
                    combine
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kayouyou.github.io/post/how-to-sync-the-width-or-height-of-two-swiftui-views/">
                  <h3 class="post-title">
                    How to sync the width or height of two SwiftUI views?
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
